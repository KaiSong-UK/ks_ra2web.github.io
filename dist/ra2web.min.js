var O9p,__classPrivateFieldSet=this&&this.__classPrivateFieldSet||function(e,t,i,r,s){if("m"===r)throw new TypeError("Private method is not writable");if("a"===r&&!s)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!s:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===r?s.call(e,i):s?s.value=i:t.set(e,i),i},__classPrivateFieldGet=this&&this.__classPrivateFieldGet||function(e,t,i,r){if("a"===i&&!r)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!r:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===i?r:"a"===i?r.call(e):r?r.value:t.get(e)},joystickInTouch=!1,joystickContainer=document.getElementById("joystick-container"),messageElement=document.getElementById("joystick-message"),k6p=/iPhone/i,e9e=/iPod/i,t9e=/iPad/i,n9e=/\biOS-universal(?:.+)Mac\b/i,a9e=/Silk/i,l9e=/Windows Phone/i,q9r=/\bWindows(?:.+)ARM\b/i,u9e=/BlackBerry/i,c9e=/BB10/i,m9w=/Opera Mini/i,h9e=/\b(CriOS|Chrome)(?:.+)Mobile/i,r9e=/\bAndroid(?:.+)Mobile\b/i,i9e=/Android/i,o9e=/(?:SD4930UR|\bSilk(?:.+)Mobile\b)/i,p9e=/Mobile(?:.+)Firefox\b/i,y9n=function(e){return void 0!==e&&"MacIntel"===e.platform&&"number"==typeof e.maxTouchPoints&&e.maxTouchPoints>1&&"undefined"==typeof MSStream};function preventExternalTouch(e){e.touches.length>1&&(e.preventDefault(),e.stopPropagation())}function preventDefaultForMultiTouch(e){e.touches.length>1&&e.preventDefault()}function G9A(e){var t={userAgent:"",platform:"",maxTouchPoints:0};e||"undefined"==typeof navigator?"string"==typeof e?t.userAgent=e:e&&e.userAgent&&(t={userAgent:e.userAgent,platform:e.platform,maxTouchPoints:e.maxTouchPoints||0}):t={userAgent:navigator.userAgent,platform:navigator.platform,maxTouchPoints:navigator.maxTouchPoints||0};var i=t.userAgent,r=i.split("[FBAN");void 0!==r[1]&&(i=r[0]),void 0!==(r=i.split("Twitter"))[1]&&(i=r[0]);var s=function(e){return function(t){return t.test(e)}}(i),n={apple:{phone:s(k6p)&&!s(l9e),ipod:s(e9e),tablet:!s(k6p)&&(s(t9e)||y9n(t))&&!s(l9e),universal:s(n9e),device:(s(k6p)||s(e9e)||s(t9e)||s(n9e)||y9n(t))&&!s(l9e)},amazon:{phone:s(o9e),tablet:!s(o9e)&&s(a9e),device:s(o9e)||s(a9e)},android:{phone:!s(l9e)&&s(o9e)||!s(l9e)&&s(r9e),tablet:!s(l9e)&&!s(o9e)&&!s(r9e)&&(s(a9e)||s(i9e)),device:!s(l9e)&&(s(o9e)||s(a9e)||s(r9e)||s(i9e))||s(/\bokhttp\b/i)},windows:{phone:s(l9e),tablet:s(q9r),device:s(l9e)||s(q9r)},other:{blackberry:s(u9e),blackberry10:s(c9e),opera:s(m9w),firefox:s(p9e),chrome:s(h9e),device:s(u9e)||s(c9e)||s(m9w)||s(p9e)||s(h9e)},any:!1,phone:!1,tablet:!1};return n.any=n.apple.device||n.android.device||n.windows.device||n.other.device,n.phone=n.apple.phone||n.android.phone||n.windows.phone,n.tablet=n.apple.tablet||n.android.tablet||n.windows.tablet,n}joystickContainer.addEventListener("touchstart",preventExternalTouch,!1),joystickContainer.addEventListener("touchmove",preventExternalTouch,!1),joystickContainer.addEventListener("touchend",preventExternalTouch,!1),System.register("data/IniSection",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("IniSection",class e{constructor(e){this.entries=new Map,this.name=e}clone(){let t=new e(this.name);return this.entries.forEach(((e,i)=>{t.set(i,e)})),t}set(e,t){this.entries.set(e,t)}get(e){return this.entries.get(e)}has(e){return this.entries.has(e)}getString(e,t=""){return this.get(e)||t}getNumber(e,t=0){var i=this.get(e);if(!i)return t;var r=this.parseNumber(i);return void 0===r?(console.warn(`Invalid value for key ${e}. "${i}" is not a valid number or percentage string.`),t):r}parseNumber(e){let t;if(t=e.match(/%$/)?Number(e.replace("%",""))/100:Number(e),!isNaN(t))return t}getFixed(e,t=0){return this.toFixedPointPrecision(this.getNumber(e,t))}toFixedPointPrecision(e){return(65536*e|0)/65536}getBool(e,t=!1){let i=this.getString(e).trim();return i=i&&i.toLowerCase(),!(!i||-1===["yes","1","true","on"].indexOf(i))||(!i||-1===["no","0","false","off"].indexOf(i))&&t}getArray(e,t=/\,\s*/,i=[]){let r=this.getString(e).trim();return r=r.replace(/\,$/,"").replace(/\,+/g,","),r?r.split(t):i}getNumberArray(e,t=/\,\s*/,i=[]){let r=this.getString(e).trim();if(!r)return i;let s=[];for(var n of r.split(t)){if(!n)return i;var a=this.parseNumber(n);if(void 0===a)return console.warn(`Invalid value for key ${e}. "${n}" is not a valid number or percentage string.`),i;s.push(a)}return s}getFixedArray(e,t=/\,\s*/,i=[]){return this.getNumberArray(e,t,i).map((e=>this.toFixedPointPrecision(e)))}getEnum(e,t,i,r=!1){let s,n=this.getString(e).trim();if(!n)return i;if(r){var a=Object.getOwnPropertyNames(t).find((e=>e.toLowerCase()===n.toLowerCase()));a&&(s=t[a])}else t.hasOwnProperty(n)&&(s=t[n]);return void 0===s?(console.warn(`Invalid value for key "${e}". "${n}" is not an accepted enum value.`),i):s}getEnumNumeric(e,t,i){var r=this.getString(e).trim();if(!r)return i;let s;return Number.isInteger(parseInt(r,10))&&t.hasOwnProperty(r)&&(s=parseInt(r,10)),void 0===s?(console.warn(`Invalid value for key "${e}". "${r}" is not an accepted enum value.`),i):s}getEnumArray(e,t,i=/\,\s*/,r=[],s=!1){let n=this.getString(e).trim();if(!n)return r;let a=[];for(let l of n.split(i)){if(!l)return r;let i=!1;if(s){var o=Object.getOwnPropertyNames(t).find((e=>e.toLowerCase()===l.toLowerCase()));o&&(a.push(t[o]),i=!0)}else t.hasOwnProperty(l)&&(a.push(t[l]),i=!0);if(!i)return console.warn(`Invalid value "${l}" for key "${e}".`),r}return a}getHighestNumericIndex(){let e,t=0;return this.entries.forEach(((i,r)=>{e=parseInt(r,10),e>t&&(t=e)})),t}getConcatenatedValues(){let e="";for(var t of this.entries.values())e+=t;return e}toString(){let e=[];for(var[t,i]of(e.push(`[${this.name}]`),this.entries))e.push(t+"="+i);return e.push(""),e.join("\r\n")}})}}})),System.register("data/IniParser",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("IniParser",class{parse(e){let t,i={},r=i,s=/^\[([^\]]*)\]\s*$|^([^=]+)(=(.*))?$/i;return e.split(/[\r\n]+/g).forEach(((e,n,a)=>{if(e&&!e.match(/^\s*[;#]/)){var o=(e=e.replace(/]\s*(\/\/|;|#).*$/,"]")).match(s);if(o){if(void 0!==o[1])return t=this.unsafe(o[1]),void(r=i[t]=i[t]||{});let e=this.unsafe(o[2]);o=o[3]?this.unsafe(o[4]||""):"",2<e.length&&"[]"===e.slice(-2)&&(e=e.substring(0,e.length-2),r[e]?Array.isArray(r[e])||(r[e]=[r[e]]):r[e]=[]),Array.isArray(r[e])?r[e].push(o):r[e]=o}}})),Object.keys(i).filter(((e,t,r)=>{if(!i[e]||"object"!=typeof i[e]||Array.isArray(i[e]))return!1;let s=this.dotSplit(e),n=i,a=s.pop();var o=a.replace(/\\\./g,".");return s.forEach((function(e,t,i){n[e]&&"object"==typeof n[e]||(n[e]={}),n=n[e]})),(n!==i||o!==a)&&(n[o]=i[e],!0)})).forEach((function(e,t,r){delete i[e]})),i}dotSplit(e){return e.replace(/\1/g,"LITERAL\\1LITERAL").replace(/\\\./g,"").split(/\./).map((e=>e.replace(/\1/g,"\\.").replace(/\2LITERAL\\1LITERAL\2/g,"")))}isQuoted(e){return'"'===e.charAt(0)&&'"'===e.slice(-1)||"'"===e.charAt(0)&&"'"===e.slice(-1)}unsafe(e){if(e=(e||"").trim(),this.isQuoted(e))return e.substr(1,e.length-2);{let i=!1,r="";for(let s=0,n=e.length;s<n;s++){var t=e.charAt(s);if(i)-1!=="\\;#".indexOf(t)?r+=t:r+="\\"+t,i=!1;else{if(-1!==";#".indexOf(t))break;"\\"===t?i=!0:r+=t}}return i&&(r+="\\"),r=r.trim(),r}}})}}})),System.register("data/DataStream",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("DataStream",i=class e{constructor(t,i,r=e.LITTLE_ENDIAN){this.endianness=r,this.position=0,this._dynamicSize=!0,this._byteLength=0,this._byteOffset=i||0,t instanceof ArrayBuffer?this.buffer=t:"object"==typeof t?(this.dataView=t,i&&(this._byteOffset+=i)):this.buffer=new ArrayBuffer(t||0)}get dynamicSize(){return this._dynamicSize}set dynamicSize(e){e||this._trimAlloc(),this._dynamicSize=e}get byteLength(){return this._byteLength-this._byteOffset}get buffer(){return this._trimAlloc(),this._buffer}set buffer(e){this._buffer=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get byteOffset(){return this._byteOffset}set byteOffset(e){this._byteOffset=e,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._buffer.byteLength}get dataView(){return this._dataView}set dataView(e){this._byteOffset=e.byteOffset,this._buffer=e.buffer,this._dataView=new DataView(this._buffer,this._byteOffset),this._byteLength=this._byteOffset+e.byteLength}bigEndian(){return this.endianness=e.BIG_ENDIAN,this}_realloc(e){if(this._dynamicSize){var t=this._byteOffset+this.position+e;let s=this._buffer.byteLength;if(t<=s)t>this._byteLength&&(this._byteLength=t);else{for(s<1&&(s=1);t>s;)s*=2;var i=new ArrayBuffer(s),r=new Uint8Array(this._buffer);new Uint8Array(i,0,r.length).set(r),this.buffer=i,this._byteLength=t}}}_trimAlloc(){if(this._byteLength!==this._buffer.byteLength){var e=new ArrayBuffer(this._byteLength);const i=new Uint8Array(e);var t=new Uint8Array(this._buffer,0,i.length);i.set(t),this.buffer=e}}seek(e){var t=Math.max(0,Math.min(this.byteLength,e));this.position=isNaN(t)||!isFinite(t)?0:t}isEof(){return this.position>=this.byteLength}mapInt32Array(t,i){this._realloc(4*t);var r=new Int32Array(this._buffer,this.byteOffset+this.position,t);return e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=4*t,r}mapInt16Array(t,i){this._realloc(2*t);var r=new Int16Array(this._buffer,this.byteOffset+this.position,t);return e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=2*t,r}mapInt8Array(e){this._realloc(e);var t=new Int8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=e,t}mapUint32Array(t,i){this._realloc(4*t);var r=new Uint32Array(this._buffer,this.byteOffset+this.position,t);return e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=4*t,r}mapUint16Array(t,i){this._realloc(2*t);var r=new Uint16Array(this._buffer,this.byteOffset+this.position,t);return e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=2*t,r}mapUint8Array(e){this._realloc(e);var t=new Uint8Array(this._buffer,this.byteOffset+this.position,e);return this.position+=e,t}mapFloat64Array(t,i){this._realloc(8*t);var r=new Float64Array(this._buffer,this.byteOffset+this.position,t);return e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=8*t,r}mapFloat32Array(t,i){this._realloc(4*t);var r=new Float32Array(this._buffer,this.byteOffset+this.position,t);return e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=4*t,r}readInt32Array(t,i){t=void 0===t?this.byteLength-this.position/4:t;var r=new Int32Array(t);return e.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=r.byteLength,r}readInt16Array(t,i){t=void 0===t?this.byteLength-this.position/2:t;var r=new Int16Array(t);return e.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=r.byteLength,r}readInt8Array(t){t=void 0===t?this.byteLength-this.position:t;var i=new Int8Array(t);return e.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),this.position+=i.byteLength,i}readUint32Array(t,i){t=void 0===t?this.byteLength-this.position/4:t;var r=new Uint32Array(t);return e.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=r.byteLength,r}readUint16Array(t,i){t=void 0===t?this.byteLength-this.position/2:t;var r=new Uint16Array(t);return e.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=r.byteLength,r}readUint8Array(t){t=void 0===t?this.byteLength-this.position:t;var i=new Uint8Array(t);return e.memcpy(i.buffer,0,this.buffer,this.byteOffset+this.position,t*i.BYTES_PER_ELEMENT),this.position+=i.byteLength,i}readFloat64Array(t,i){t=void 0===t?this.byteLength-this.position/8:t;var r=new Float64Array(t);return e.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=r.byteLength,r}readFloat32Array(t,i){t=void 0===t?this.byteLength-this.position/4:t;var r=new Float32Array(t);return e.memcpy(r.buffer,0,this.buffer,this.byteOffset+this.position,t*r.BYTES_PER_ELEMENT),e.arrayToNative(r,void 0===i?this.endianness:i),this.position+=r.byteLength,r}writeInt32Array(t,i){if(this._realloc(4*t.length),t instanceof Int32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt32Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeInt32(t[e],i);return this}writeInt16Array(t,i){if(this._realloc(2*t.length),t instanceof Int16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt16Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeInt16(t[e],i);return this}writeInt8Array(t){if(this._realloc(t.length),t instanceof Int8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapInt8Array(t.length);else for(let e=0;e<t.length;e++)this.writeInt8(t[e]);return this}writeUint32Array(t,i){if(this._realloc(4*t.length),t instanceof Uint32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint32Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeUint32(t[e],i);return this}writeUint16Array(t,i){if(this._realloc(2*t.length),t instanceof Uint16Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint16Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeUint16(t[e],i);return this}writeUint8Array(t){if(this._realloc(t.length),t instanceof Uint8Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapUint8Array(t.length);else for(let e=0;e<t.length;e++)this.writeUint8(t[e]);return this}writeFloat64Array(t,i){if(this._realloc(8*t.length),t instanceof Float64Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat64Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeFloat64(t[e],i);return this}writeFloat32Array(t,i){if(this._realloc(4*t.length),t instanceof Float32Array&&(this.byteOffset+this.position)%t.BYTES_PER_ELEMENT==0)e.memcpy(this._buffer,this.byteOffset+this.position,t.buffer,t.byteOffset,t.byteLength),this.mapFloat32Array(t.length,i);else for(let e=0;e<t.length;e++)this.writeFloat32(t[e],i);return this}readInt32(e){var t=this._dataView.getInt32(this.position,void 0===e?this.endianness:e);return this.position+=4,t}readInt16(e){var t=this._dataView.getInt16(this.position,void 0===e?this.endianness:e);return this.position+=2,t}readInt8(){var e=this._dataView.getInt8(this.position);return this.position+=1,e}readUint32(e){var t=this._dataView.getUint32(this.position,void 0===e?this.endianness:e);return this.position+=4,t}readUint16(e){var t=this._dataView.getUint16(this.position,void 0===e?this.endianness:e);return this.position+=2,t}readUint8(){var e=this._dataView.getUint8(this.position);return this.position+=1,e}readFloat32(e){var t=this._dataView.getFloat32(this.position,void 0===e?this.endianness:e);return this.position+=4,t}readFloat64(e){var t=this._dataView.getFloat64(this.position,void 0===e?this.endianness:e);return this.position+=8,t}writeInt32(e,t){return this._realloc(4),this._dataView.setInt32(this.position,e,void 0===t?this.endianness:t),this.position+=4,this}writeInt16(e,t){return this._realloc(2),this._dataView.setInt16(this.position,e,void 0===t?this.endianness:t),this.position+=2,this}writeInt8(e){return this._realloc(1),this._dataView.setInt8(this.position,e),this.position+=1,this}writeUint32(e,t){return this._realloc(4),this._dataView.setUint32(this.position,e,void 0===t?this.endianness:t),this.position+=4,this}writeUint16(e,t){return this._realloc(2),this._dataView.setUint16(this.position,e,void 0===t?this.endianness:t),this.position+=2,this}writeUint8(e){return this._realloc(1),this._dataView.setUint8(this.position,e),this.position+=1,this}writeFloat32(e,t){return this._realloc(4),this._dataView.setFloat32(this.position,e,void 0===t?this.endianness:t),this.position+=4,this}writeFloat64(e,t){return this._realloc(8),this._dataView.setFloat64(this.position,e,void 0===t?this.endianness:t),this.position+=8,this}static memcpy(e,t,i,r,s){const n=new Uint8Array(e,t,s);var a=new Uint8Array(i,r,s);n.set(a)}static arrayToNative(e,t){return t===this.endianness?e:this.flipArrayEndianness(e)}static nativeToEndian(e,t){return this.endianness===t?e:this.flipArrayEndianness(e)}static flipArrayEndianness(e){const t=new Uint8Array(e.buffer,e.byteOffset,e.byteLength);for(let r=0;r<e.byteLength;r+=e.BYTES_PER_ELEMENT)for(let s=r+e.BYTES_PER_ELEMENT-1,n=r;s>n;s--,n++){var i=t[n];t[n]=t[s],t[s]=i}return e}static createStringFromArray(e){const t=[];for(let i=0;i<e.length;i+=32768)t.push(String.fromCharCode.apply(void 0,e.subarray(i,i+32768)));return t.join("")}readUCS2String(t,i){return e.createStringFromArray(this.readUint16Array(t,i))}writeUCS2String(e,t,i){void 0===i&&(i=e.length);let r=0;for(;r<e.length&&r<i;r++)this.writeUint16(e.charCodeAt(r),t);for(;r<i;r++)this.writeUint16(0);return this}readString(t,i){return void 0===i||"ASCII"===i?e.createStringFromArray(this.mapUint8Array(void 0===t?this.byteLength-this.position:t)):new TextDecoder(i).decode(this.mapUint8Array(t))}writeString(e,t,i){if(void 0===t||"ASCII"===t)if(void 0!==i){let t;var r=Math.min(e.length,i);for(t=0;t<r;t++)this.writeUint8(e.charCodeAt(t));for(;t<i;t++)this.writeUint8(0)}else for(let t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));else this.writeUint8Array((new TextEncoder).encode(e.substring(0,i)));return this}writeUtf8WithLen(e){var t=(new TextEncoder).encode(e);return this.writeUint16(t.length).writeUint8Array(t)}readUtf8WithLen(){var e=this.readUint16();return(new TextDecoder).decode(this.mapUint8Array(e))}readCString(t){var i=this.byteLength-this.position,r=new Uint8Array(this._buffer,this._byteOffset+this.position);let s=i;void 0!==t&&(s=Math.min(t,i));let n=0;for(;n<s&&0!==r[n];n++);var a=e.createStringFromArray(this.mapUint8Array(n));return void 0!==t?this.position+=s-n:n!==i&&(this.position+=1),a}writeCString(e,t){if(void 0!==t){let r;var i=Math.min(e.length,t);for(r=0;r<i;r++)this.writeUint8(e.charCodeAt(r));for(;r<t;r++)this.writeUint8(0)}else{for(let t=0;t<e.length;t++)this.writeUint8(e.charCodeAt(t));this.writeUint8(0)}return this}toUint8Array(){return new Uint8Array(this.buffer,this.byteOffset,this.byteLength)}}),i.BIG_ENDIAN=!1,i.LITTLE_ENDIAN=!0,i.endianness=0<new Int8Array(new Int16Array([1]).buffer)[0]}}})),System.register("data/vfs/IOError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{constructor(){super(...arguments),this.name="IOError"}},e("IOError",i)}}})),System.register("data/vfs/VirtualFile",["data/DataStream","data/vfs/IOError"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("VirtualFile",class{constructor(e,t){this.stream=e,this.filename=t}static async fromRealFile(e){try{const t=new i.DataStream(await e.arrayBuffer());return t._trimAlloc=()=>{},new this(t,e.name)}catch(t){if(t instanceof DOMException)throw new r.IOError(`File "${e.name}" could not be read (${t.name})`,{cause:t});throw t}}static fromBytes(e,t){let r=new i.DataStream(e);return r._trimAlloc=()=>{},new this(r,t)}static factory(e,t,r=0,s=e.byteLength){var n=new DataView(e.buffer,e.byteOffset+r,s);const a=new i.DataStream(n);return a._trimAlloc=()=>{},new this(a,t)}readAsString(e){return this.stream.seek(0),this.stream.readString(this.stream.byteLength,e)}getBytes(){return new Uint8Array(this.stream.buffer,this.stream.byteOffset,this.stream.byteLength)}getSize(){return this.stream.byteLength}asFile(e){return new File([this.getBytes()],this.filename,{type:e})}})}}})),System.register("data/IniFile",["data/IniSection","data/IniParser","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("IniFile",class e{constructor(e){this.sections=new Map,e instanceof s.VirtualFile?this.fromVirtualFile(e):"object"==typeof e?this.fromJson(e):"string"==typeof e&&this.fromString(e)}fromVirtualFile(e){return this.fromString(e.readAsString())}fromString(e){return this.fromJson((new r.IniParser).parse(e)),this}fromJson(e){let t,r,s,n;var a;for(t in e)if(e.hasOwnProperty(t)){for(n in r=e[t],s=new i.IniSection(t),r)r.hasOwnProperty(n)&&(a=r[n],s.set(n,a));this.sections.set(t,s)}}toString(){let e=[];for(var t of this.sections.values())e.push(t.toString());return e.join("\r\n")}clone(){let t=new e;return this.sections.forEach(((e,i)=>{t.sections.set(i,e.clone())})),t}getOrCreateSection(e){let t=this.sections.get(e);return t||(t=new i.IniSection(e),this.sections.set(e,t)),t}getSection(e){return this.sections.get(e)}getOrderedSections(){return[...this.sections.values()]}isValueArray(e){return-1!==["BuildingTypes","AircraftTypes","InfantryTypes","OverlayTypes","TerrainTypes","SmudgeTypes","VehicleTypes","Animations","VoxelAnims","SuperWeaponTypes","Countries","Warheads","Tiberiums"].indexOf(e)}mergeWith(e){return e.sections.forEach(((e,t)=>{let i=this.getOrCreateSection(t);if(this.isValueArray(t)){let t=i.getHighestNumericIndex()+1;e.entries.forEach(((e,r)=>{i.set((t++).toString(),e)}))}else e.entries.forEach(((e,t)=>{i.set(t,e)}))})),this}})}}})),System.register("data/encoding/Format3",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Format3",class{static decode(e,t,i){let r=new Uint8Array(t*i),s=0,n=0;for(let a=0;a<i;a++){let i=(e[s+1]<<8|e[s])-2;s+=2;let a=0;for(;0<i--;){let o=e[s++];if(0!==o)a++,r[n++]=o;else for(i--,o=e[s++],a+o>t&&(o=t-a&255),a+=o;0!=o--;)r[n++]=0}}return r}})}}})),System.register("data/ShpImage",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ShpImage",class e{constructor(e){this.height=1,this.width=1,this.x=0,this.y=0,this.imageData=e??new Uint8Array(0)}clip(t,i){let r=new e;r.width=Math.min(this.width,t),r.height=Math.min(this.height,i);let s=new Uint8Array(t*i),n=0;for(let e=0;e<this.height&&!(e>=i);e++)for(let i=0;i<this.width;i++)i>=t||(s[n++]=this.imageData[e*this.width+i]);return r.imageData=s,r.x=this.x,r.y=this.y,r}})}}})),System.register("data/ShpFile",["data/encoding/Format3","data/ShpImage","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("ShpFile",class e{constructor(e){this.height=0,this.width=0,this.numImages=0,this.images=[],e instanceof s.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){this.filename=e.filename;let t=e.stream;if(0===t.readInt16()){this.width=t.readInt16(),this.height=t.readInt16(),this.numImages=t.readInt16();let e=[];for(let i=0;i<this.numImages;++i)e.push(this.readFrameHeader(t));this.images=[];for(let h=0;h<this.numImages;++h){var{compressionType:i,imageDataStartOffset:s,x:n,y:a,width:o,height:l}=e[h];let u=h<this.numImages-1?e[h+1].imageDataStartOffset:t.byteLength;u<s&&(u=t.byteLength);var c=u-s;t.seek(s),c=this.readImageData(t,o,l,i,c);let d=new r.ShpImage(c);d.x=n,d.y=a,d.width=o,d.height=l,this.images.push(d)}}}readFrameHeader(e){var t=e.readInt16(),i=e.readInt16(),r=e.readInt16(),s=e.readInt16(),n=e.readUint8();return e.readUint8(),e.readUint8(),e.readUint8(),e.readInt32(),e.readInt32(),{x:t,y:i,width:r,height:s,compressionType:n,imageDataStartOffset:e.readInt32()}}readImageData(e,t,r,s,n){var a=t*r;if(s<=1){var o=new Uint8Array(e.buffer,e.byteOffset+e.position,a);return e.position+=a,o}if(2===s){let t=0,i=new Uint8Array(a);for(let s=0;s<r;++s){var l=e.readUint16()-2;i.set(new Uint8Array(e.buffer,e.byteOffset+e.position,l),t),e.position+=l,t+=l}return i}return 3!==s?new Uint8Array:(a=new Uint8Array(e.buffer,e.byteOffset+e.position,n),e.position+=n,i.Format3.decode(a,t,r))}getImage(e){if(e<0||this.images.length<=e)throw new RangeError(`Image index out of bounds (file=${this.filename}, index=${e}, length=${this.images.length})`);return this.images[e]}addImage(e){this.images.push(e),this.numImages++}clip(t,i){let r=new e;return r.filename=this.filename,r.width=Math.min(this.width,t),r.height=Math.min(this.height,i),r.images=this.images.map((e=>e.clip(r.width,r.height))),r.numImages=this.numImages,r}})}}})),System.register("data/vxl/SpanOffsets",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/vxl/Voxel",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/vxl/Span",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/vxl/normals",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=THREE.Vector3,e("normals1",[new i(.54946297,-183e-6,-.835518),new i(.00014400001,.54940403,-.83555698),new i(-.54940403,-68000001e-12,-.83555698),new i(106e-6,-.54946297,-.835518),new i(.94900799,.00031599999,-.31525001),new i(-186e-6,.94899702,-.31528401),new i(-.94899702,.00031800001,-.31528401),new i(-447e-6,-.94900799,-.31525001),new i(.95084399,-279e-6,.30967101),new i(202e-6,.95084798,.30965701),new i(-.95084798,-70000002e-12,.30965701),new i(147e-6,-.95084399,.30967101),new i(.55237001,-11e-6,.83359897),new i(19999999e-12,.55238003,.833592),new i(-.55238003,57000001e-12,.83359301),new i(-66000001e-12,-.55237001,.83359897)]),e("normals2",[new i(.67121398,.19849201,-.714194),new i(.26964301,.58439398,-.76536),new i(-.040546,.096988,-.99445897),new i(-.57242799,-.091913998,-.81478697),new i(-.17140099,-.57270998,-.80163902),new i(.36255699,-.30299899,-.88133103),new i(.81034702,-.34897199,-.470698),new i(.103962,.93867201,-.328767),new i(-.324047,.58766901,-.74137598),new i(-.80086499,.34046099,-.49264699),new i(-.66549802,-.59014702,-.45698899),new i(.314767,-.803002,-.506073),new i(.97262901,.151076,-.17655),new i(.680291,.68423599,-.26272699),new i(-.52007902,.82777703,-.210483),new i(-.96164399,-.179001,-.207847),new i(-.262714,-.937451,-.22840101),new i(.219707,-.97130102,.091124997),new i(.92380798,-.229975,.30608699),new i(-.082488999,.97065997,.225866),new i(-.59179801,.69678998,.40528899),new i(-.92529601,.36660099,.097111002),new i(-.705051,-.68777502,.172828),new i(.7324,-.68036699,-.026304999),new i(.85516202,.37458199,.358311),new i(.47300601,.83648002,.276705),new i(-.097617,.65411198,.750072),new i(-.90412402,-.153725,.39865801),new i(-.211916,-.85808998,.46773201),new i(.50022697,-.67440802,.543091),new i(.584539,-.110249,.80384099),new i(.43737301,.45464399,.77588898),new i(-.042440999,.083318003,.995619),new i(-.59625101,.22013199,.77202803),new i(-.506455,-.39697701,.76544899),new i(.070569001,-.47847399,.87526202)]),e("normals3",[new i(.45651099,-.073968001,-.88663799),new i(.50769401,.38511699,-.77067),new i(.095431998,.22666401,-.96928602),new i(-.35876599,.54318798,-.75910097),new i(-.361276,.13299499,-.92292601),new i(-.48311701,-.32406601,-.813375),new i(-.018073,-.197559,-.980124),new i(.3211,-.501477,-.80337799),new i(.79949099,.069615997,-.59662998),new i(.390971,.77130598,-.50222403),new i(.080782004,.61448997,-.784778),new i(-.73275,.41143101,-.54203498),new i(-.73525399,.0091019999,-.67773098),new i(-.80249399,-.39490801,-.44727099),new i(-.13413,-.58915502,-.79680902),new i(.71955299,-.37622699,-.58369303),new i(.96687502,.173593,-.187132),new i(.760831,.51910597,-.38944301),new i(-.114642,.87551898,-.46938601),new i(-.53236699,.76885903,-.354177),new i(-.96226698,.024977,-.27095801),new i(-.46738699,-.721986,-.51018202),new i(.058449998,-.85235399,-.51968902),new i(.49823299,-.74374002,-.44566301),new i(.93915099,-.27024499,-.212044),new i(.58393198,.80944198,-.061857),new i(.183797,.97322798,-.138007),new i(-.88435501,.45221901,-.115822),new i(-.943178,-.33206701,.012138),new i(-.69844002,-.70656699,-.113772),new i(-.228411,-.95470601,-.190694),new i(.73156399,-.675861,-.089588001),new i(.96925098,.046804,.24158201),new i(.85564703,.50347698,.119916),new i(-.25115299,.96794701,-80999998e-12),new i(-.64779502,.75674897,.087711997),new i(-.96916401,.14519399,.1991),new i(-.41479301,-.88896698,.194126),new i(.25077501,-.961178,-.115109),new i(.47862899,-.84259301,.246883),new i(.89004397,-.39614201,.225595),new i(.52405101,.76235998,.37970701),new i(.11962,.94548202,.30291),new i(-.76085001,.49007499,.42536199),new i(-.86978501,-.20215,.450122),new i(-.70946699,-.60242403,.36570701),new i(.019308999,-.95887101,.28318599),new i(.626113,-.564677,.53770101),new i(.769943,-.126663,.62541503),new i(.76419097,.35070199,.54131401),new i(-.001878,.74136698,.67109799),new i(-.37088001,.81836802,.43900099),new i(-.71390897,.12865201,.68831801),new i(-.295165,-.73866397,.60601401),new i(.186195,-.73836899,.648184),new i(.387523,-.35878301,.84917599),new i(.481022,.124846,.86777401),new i(.391808,.54505599,.741216),new i(-.0035359999,.36559799,.93076599),new i(-.42049801,.484961,.76680797),new i(-.35490301,.019470001,.93470001),new i(-.54783702,-.35920799,.75554299),new i(-.106662,-.445115,.88909799),new i(.086796001,-.059307002,.99445897)]),e("normals4",[new i(.52657801,-.35962099,-.77031702),new i(.150482,.43598399,.88728398),new i(.414195,.73825502,-.53237402),new i(.075152002,.91624898,-.393498),new i(-.316149,.93073601,-.18379299),new i(-.77381903,.62333399,-.11251),new i(-.90084201,.42853701,-.069568001),new i(-.99894202,-.010971,.044665001),new i(-.979761,-.15767001,-.123324),new i(-.91127402,-.362371,-.19562),new i(-.62406898,-.72094101,-.301301),new i(-.310173,-.80934501,-.498752),new i(.146613,-.81581903,-.55941403),new i(-.71651602,-.69435602,-.066887997),new i(.50397199,-.114202,-.85613698),new i(.45549101,.87262702,-.176211),new i(-.00501,-.114373,-.99342501),new i(-.104675,-.327701,-.93896502),new i(.56041199,.75258899,-.34575599),new i(-.060575999,.82162797,-.566796),new i(-.30234101,.79700702,-.522847),new i(-.671543,.67074001,-.314863),new i(-.77840102,-.12835699,.61450499),new i(-.92404997,.278382,-.261985),new i(-.69977301,-.55049098,-.45527801),new i(-.56824797,-.51718903,-.64000797),new i(.054097999,-.93286401,-.356143),new i(.75838202,.57289302,-.31088799),new i(.0036200001,.30502599,-.95233703),new i(-.060849998,-.98688602,-.14951099),new i(.63523,.045478001,-.77098298),new i(.52170497,.241309,-.81828701),new i(.26940399,.63542497,-.72364098),new i(.045676,.67275399,-.738455),new i(-.180511,.67465699,-.71571898),new i(-.397131,.63664001,-.66104198),new i(-.55200398,.47251499,-.687038),new i(-.77217001,.08309,-.62996),new i(-.669819,-.119533,-.73284),new i(-.54045498,-.31844401,-.77878201),new i(-.38613501,-.522789,-.75999397),new i(-.261466,-.68856698,-.676395),new i(-.019412,-.69610298,-.71767998),new i(.30356899,-.48184401,-.82199299),new i(.68193901,-.19512901,-.70490003),new i(-.24488901,-.116562,-.96251899),new i(.80075902,-.022979001,-.59854603),new i(-.37027499,.095583998,-.92399102),new i(-.33067101,-.32657799,-.88543999),new i(-.16322,-.52757901,-.83367902),new i(.12639,-.313146,-.941257),new i(.34954801,-.27222601,-.89649802),new i(.23991799,-.085825004,-.96699202),new i(.390845,.081537001,-.91683799),new i(.25526699,.26869699,-.92878503),new i(.146245,.48043799,-.86474901),new i(-.32601601,.47845599,-.81534898),new i(-.46968201,-.112519,-.87563598),new i(.81844002,-.25852001,-.51315099),new i(-.474318,.292238,-.83043301),new i(.778943,.39584199,-.48637101),new i(.62409401,.39377299,-.67487001),new i(.74088597,.203834,-.63995302),new i(.48021701,.565768,-.67029703),new i(.38093001,.42453501,-.82137799),new i(-.093422003,.50112402,-.86031801),new i(-.236485,.29619801,-.92538702),new i(-.131531,.093959004,-.98684901),new i(-.82356203,.29577699,-.48400599),new i(.61106598,-.624304,-.486664),new i(.069495998,-.52033001,-.85113299),new i(.226522,-.66487902,-.711775),new i(.47130799,-.56890398,-.67395699),new i(.38842499,-.74262398,-.54556),new i(.78367501,-.48072901,-.39338499),new i(.962394,.135676,-.235349),new i(.876607,.172034,-.449406),new i(.63340503,.58979303,-.50094098),new i(.182276,.80065799,-.57072097),new i(.177003,.76413399,.62029701),new i(-.544016,.675515,-.49772099),new i(-.67929697,.28646699,-.67564201),new i(-.59039098,.091369003,-.801929),new i(-.82436001,-.13312399,-.55018902),new i(-.71579403,-.33454201,-.61296099),new i(.17428599,-.89248401,.416049),new i(-.082528003,-.83712298,-.54075301),new i(.28333101,-.88087398,-.37918901),new i(.675134,-.42662701,-.60181701),new i(.84372002,-.512335,-.160156),new i(.97730398,-.098555997,-.18752),new i(.846295,.522672,-.102947),new i(.67714101,.72132498,-.145501),new i(.32096499,.87089199,-.37219399),new i(-.178978,.911533,-.37023601),new i(-.44716901,.82670099,-.341474),new i(-.70320302,.496328,-.50908101),new i(-.97718102,.063562997,-.202674),new i(-.87817001,-.412938,.241455),new i(-.83583099,-.35855001,-.415728),new i(-.499174,-.69343299,-.51959199),new i(-.188789,-.92375302,-.33322501),new i(.19225401,-.96936101,-.152896),new i(.51594001,-.783907,-.34539199),new i(.90592498,-.30095199,-.29787099),new i(.99111199,-.127746,.037106998),new i(.99513501,.098424003,-.0043830001),new i(.76012301,.64627701,.067367002),new i(.205221,.95958,-.192591),new i(-.042750001,.97951299,-.19679099),new i(-.43801701,.89892697,.0084920004),new i(-.82199401,.48078501,-.30523899),new i(-.89991701,.081710003,-.42833701),new i(-.92661202,-.144618,-.347096),new i(-.79365999,-.55779201,-.24283899),new i(-.43134999,-.84777898,-.30855799),new i(-.0054919999,-.96499997,.26219299),new i(.58790499,-.80402601,-.088940002),new i(.69949299,-.66768599,-.254765),new i(.88930303,.359795,-.282291),new i(.780972,.197037,.59267199),new i(.52012098,.50669599,.68755698),new i(.40389499,.69396102,.59605998),new i(-.154983,.89923602,.40909001),new i(-.65733802,.53716803,.528543),new i(-.74619502,.33409101,.575827),new i(-.62495202,-.049144,.77911502),new i(.31814101,-.254715,.913185),new i(-.555897,.405294,.725752),new i(-.79443401,.099405997,.59916002),new i(-.64036101,-.68946302,.33849499),new i(-.12671299,-.73409498,.66711998),new i(.105457,-.78081697,.61579502),new i(.40799299,-.48091599,.77605498),new i(.69513601,-.54512,.468647),new i(.97319102,-.0064889998,.229908),new i(.94689399,.317509,-.050799001),new i(.56358302,.82561201,.027183),new i(.325773,.94542301,.0069490001),new i(-.171821,.98509699,-.0078149997),new i(-.67044097,.73993897,.054768998),new i(-.822981,.55496198,.121322),new i(-.96619302,.117857,.229307),new i(-.95376903,-.29470399,.058945),new i(-.86438698,-.50272799,-.010015),new i(-.53060901,-.84200603,-.097365998),new i(-.162618,-.98407501,.071772002),new i(.081446998,-.99601102,.036439002),new i(.74598402,-.66596299,.00076199998),new i(.94205701,-.32926899,-.064106002),new i(.93970197,-.28108999,.194803),new i(.77121401,.55067003,.319363),new i(.641348,.73069,.23402099),new i(.080682002,.99669099,.0098789996),new i(-.046725001,.97664303,.20972501),new i(-.53107601,.82100099,.209562),new i(-.69581503,.65599,.29243499),new i(-.97612202,.216709,-.014913),new i(-.96166098,-.14412899,.23331399),new i(-.772084,-.61364698,.165299),new i(-.44960001,-.83605999,.314426),new i(-.39269999,-.91461599,.096247002),new i(.390589,-.91947001,.044890001),new i(.58252901,-.79919797,.148127),new i(.866431,-.48981199,.096864),new i(.90458697,.111498,.41145),new i(.95353699,.23232999,.191806),new i(.497311,.77080297,.398177),new i(.194066,.95631999,.218611),new i(.422876,.882276,.206797),new i(-.373797,.84956598,.37217399),new i(-.53449702,.71402299,.4522),new i(-.881827,.23716,.40759799),new i(-.904948,-.014069,.42528901),new i(-.751827,-.51281703,.41445801),new i(-.50101501,-.69791698,.51175803),new i(-.23519,-.92592299,.295555),new i(.228983,-.95393997,.193819),new i(.734025,-.63489801,.241062),new i(.91375297,-.063253,-.40131599),new i(.90573502,-.161487,.391875),new i(.85892999,.342446,.38074899),new i(.62448603,.60758102,.49077699),new i(.28926399,.85747898,.42550799),new i(.069968,.90216899,.42567101),new i(-.28617999,.94069999,.182165),new i(-.57401299,.80511898,-.14930899),new i(.111258,.099717997,-.98877603),new i(-.30539301,-.94422799,-.12316),new i(-.60116601,-.78957599,.123163),new i(-.290645,-.81213999,.50591898),new i(-.064920001,-.87716299,.47578499),new i(.408301,-.862216,.29978901),new i(.56609702,-.72556603,.39126399),new i(.83936399,-.427387,.33586901),new i(.81889999,-.041305002,.57244802),new i(.71978402,.41499701,.55649698),new i(.88174403,.45027,.140659),new i(.40182301,-.89822,-.17815199),new i(-.054019999,.79134399,.60898),new i(-.29377401,.76399398,.57446498),new i(-.450798,.61034697,.65135098),new i(-.63822103,.186694,.74687302),new i(-.87287003,-.25712699,.41470799),new i(-.58725703,-.52170998,.618828),new i(-.35365799,-.64197397,.680291),new i(.041648999,-.61127299,.79032302),new i(.348342,-.77918297,.52108699),new i(.499167,-.62244099,.602826),new i(.79001898,-.30383101,.53250003),new i(.66011798,.060733002,.74870199),new i(.60492098,.29416099,.73996001),new i(.38569701,.37934601,.84103203),new i(.239693,.207876,.94833201),new i(.012623,.25853199,.96591997),new i(-.100557,.457147,.88368797),new i(.046967,.62858802,.77631903),new i(-.43039101,-.44540501,.785097),new i(-.43429101,-.196228,.87913901),new i(-.25663701,-.336867,.90590203),new i(-.131372,-.15891001,.97851402),new i(.102379,-.208767,.972592),new i(.195687,-.450129,.87125802),new i(.62731898,-.42314801,.65377098),new i(.68743902,-.171583,.70568198),new i(.27592,-.021255,.96094602),new i(.45936701,.15746599,.87417799),new i(.285395,.583184,.76055598),new i(-.81217402,.46030301,.35846099),new i(-.189068,.64122301,.743698),new i(-.338875,.47648001,.811252),new i(-.92099398,.347186,.176727),new i(.040638998,.024465,.99887401),new i(-.73913199,-.35374701,.57318997),new i(-.60351199,-.28661501,.74405998),new i(-.188676,-.547059,.81555402),new i(-.026045,-.39782,.91709399),new i(.26789701,-.649041,.71202302),new i(.518246,-.28489101,.80638599),new i(.493451,-.066532999,.86722499),new i(-.328188,.140251,.93414301),new i(.328188,.140251,.93414301),new i(-.328188,.140251,.93414301),new i(-.328188,.140251,.93414301),new i(-.328188,.140251,.93414301)])}}})),System.register("data/vxl/VoxelField",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("VoxelField",class{constructor(e,t,i){this.sizeX=e,this.sizeY=t,this.sizeZ=i,this.arr=new Array(e*t*i)}add(e){this.arr[e.x+e.y*this.sizeX+e.z*this.sizeX*this.sizeY]=e}get(e,t,i){if(!(e>=this.sizeX||t>=this.sizeY||i>=this.sizeZ))return this.arr[e+t*this.sizeX+i*this.sizeX*this.sizeY]}})}}})),System.register("data/vxl/Section",["data/vxl/normals","data/vxl/VoxelField"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Section",class{get spanX(){return this.maxBounds.x-this.minBounds.x}get spanY(){return this.maxBounds.y-this.minBounds.y}get spanZ(){return this.maxBounds.z-this.minBounds.z}get scaleX(){return this.spanX/this.sizeX}get scaleY(){return this.spanY/this.sizeY}get scaleZ(){return this.spanZ/this.sizeZ}get scale(){return new THREE.Vector3(this.scaleX,this.scaleY,this.scaleZ)}getAllVoxels(){let e=[],t=new r.VoxelField(this.sizeX+1,this.sizeY+1,this.sizeZ+1);for(let r=0,n=this.spans.length;r<n;r++){var i=this.spans[r].voxels;for(let r=0,n=i.length;r<n;r++){var s=i[r];e.push(s),t.add(s)}}return{voxels:e,voxelField:t}}getNormals(){switch(this.normalsMode){case 1:return i.normals1;case 2:return i.normals2;case 3:return i.normals3;case 4:return i.normals4;default:throw new Error("Invalid normalsmode "+this.normalsMode)}}scaleHvaMatrix(e){return(e=e.clone()).elements[12]*=this.hvaMultiplier,e.elements[13]*=this.hvaMultiplier,e.elements[14]*=this.hvaMultiplier,e}toPlain(){return{name:this.name,normalsMode:this.normalsMode,minBounds:this.minBounds.toArray(),maxBounds:this.maxBounds.toArray(),sizeX:this.sizeX,sizeY:this.sizeY,sizeZ:this.sizeZ,hvaMultiplier:this.hvaMultiplier,transfMatrix:this.transfMatrix.toArray(),spans:this.spans}}fromPlain(e){return this.name=e.name,this.normalsMode=e.normalsMode,this.minBounds=(new THREE.Vector3).fromArray(e.minBounds),this.maxBounds=(new THREE.Vector3).fromArray(e.maxBounds),this.sizeX=e.sizeX,this.sizeY=e.sizeY,this.sizeZ=e.sizeZ,this.hvaMultiplier=e.hvaMultiplier,this.transfMatrix=(new THREE.Matrix4).fromArray(e.transfMatrix),this.spans=e.spans,this}})}}})),System.register("data/vxl/VxlHeader",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("VxlHeader",i=class{read(e){this.fileName=e.readCString(16),this.paletteCount=e.readUint32(),this.headerCount=e.readUint32(),this.tailerCount=e.readUint32(),this.bodySize=e.readUint32(),this.paletteRemapStart=e.readUint8(),this.paletteRemapEnd=e.readUint8(),e.seek(e.position+768)}}),i.size=32}}})),System.register("data/VxlFile",["data/vfs/VirtualFile","data/vxl/Section","data/vxl/VxlHeader"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("VxlFile",class{constructor(e){this.voxelCount=0,e instanceof i.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){this.filename=e.filename;let t=e.stream;if(this.sections=[],!(t.byteLength<s.VxlHeader.size)){let e=new s.VxlHeader;if(e.read(t),e.headerCount&&e.tailerCount&&e.tailerCount===e.headerCount){for(let i=0;i<e.headerCount;++i){const e=new r.Section;this.readSectionHeader(e,t),this.sections.find((t=>t.name===e.name))&&console.warn(`Duplicate section name "${e.name}" found in VXL "${this.filename}".`),this.sections.push(e)}var i=t.position;t.seek(t.position+e.bodySize);let s=[];for(let i=0;i<e.tailerCount;++i)s[i]=this.readSectionTailer(this.sections[i],t);let n=0;for(let r=0;r<e.headerCount;++r)t.seek(i),n+=this.readSectionBodySpans(this.sections[r],s[r],t);this.voxelCount=n}}}readSectionHeader(e,t){e.name=t.readCString(16),t.readUint32(),t.readUint32(),t.readUint32()}readSectionTailer(e,t){var i=t.readUint32(),r=t.readUint32(),s=t.readUint32();return e.hvaMultiplier=t.readFloat32(),e.transfMatrix=this.readTransfMatrix(t),e.minBounds=new THREE.Vector3(t.readFloat32(),t.readFloat32(),t.readFloat32()),e.maxBounds=new THREE.Vector3(t.readFloat32(),t.readFloat32(),t.readFloat32()),e.sizeX=t.readUint8(),e.sizeY=t.readUint8(),e.sizeZ=t.readUint8(),e.normalsMode=t.readUint8(),{startingSpanOffset:i,endingSpanOffset:r,dataSpanOffset:s}}readTransfMatrix(e){let t=[];for(let i=0;i<3;++i)t.push(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());return t.push(0,0,0,1),(new THREE.Matrix4).fromArray(t).transpose()}readSectionBodySpans(e,t,i){i.seek(i.position+t.startingSpanOffset);var{sizeX:r,sizeY:s,sizeZ:n}=e;let a=new Array(s);for(let e=0;e<s;++e){a[e]=new Array(r);for(let t=0;t<r;++t)a[e][t]=i.readInt32()}let o=new Array(s);for(let e=0;e<s;++e){o[e]=new Array(r);for(let t=0;t<r;++t)o[e][t]=i.readInt32()}let l=e.spans=[],c=0;for(let e=0;e<s;++e)for(let t=0;t<r;++t){var h={x:t,y:e,voxels:this.readSpanVoxels(a[e][t],o[e][t],t,e,n,i)};l.push(h),c+=h.voxels.length}return c}readSpanVoxels(e,t,i,r,s,n){if(-1===e||-1===t)return[];let a=[];for(let e=0;e<s;){e+=n.readUint8();var o=n.readUint8();for(let t=0;t<o;++t){var l={x:i,y:r,z:e++,colorIndex:n.readUint8(),normalIndex:n.readUint8()};a.push(l)}n.readUint8()}return a}fromPlain(e){return this.sections=e.sections.map((e=>(new r.Section).fromPlain(e))),this.voxelCount=e.voxelCount,this}toPlain(){return{sections:this.sections.map((e=>e.toPlain())),voxelCount:this.voxelCount}}getSection(e){return this.sections[e]}})}}})),System.register("data/TmpImage",[],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.ExtraData=1]="ExtraData",t[t.ZData=2]="ZData",t[t.DamagedData=4]="DamagedData",r=e=>e<0?e+256:e,e("TmpImage",class{constructor(e,t,i){this.fromStream(e,t,i)}fromStream(e,t,r){this.x=e.readInt32(),this.y=e.readInt32(),e.readInt32(),e.readInt32();var s=e.readInt32();this.extraX=e.readInt32(),this.extraY=e.readInt32(),this.extraWidth=e.readInt32(),this.extraHeight=e.readInt32();var n=e.readUint32();this.height=e.readUint8(),this.terrainType=e.readUint8(),this.rampType=e.readUint8(),this.radarLeft=this.readRadarRgb(e.readInt8(),e.readInt8(),e.readInt8()),this.radarRight=this.readRadarRgb(e.readInt8(),e.readInt8(),e.readInt8()),e.seek(e.position+3),this.tileData=new Uint8Array(e.buffer,e.byteOffset+e.position,t*r/2),e.position+=t*r/2,this.hasZData=(n&i.ZData)===i.ZData,this.hasZData&&(e.position+=t*r/2),this.hasExtraData=(n&i.ExtraData)===i.ExtraData,this.hasExtraData&&(n=Math.abs(this.extraWidth*this.extraHeight),this.extraData=new Uint8Array(e.buffer,e.byteOffset+e.position,n),e.position+=n),this.hasZData&&this.hasExtraData&&0<s&&s<e.byteLength&&(e.position+=Math.abs(this.extraWidth*this.extraHeight))}readRadarRgb(e,t,i){return new THREE.Color(r(e)/255,r(t)/255,r(i)/255)}})}}})),System.register("data/TmpFile",["data/TmpImage","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("TmpFile",class{constructor(e){this.images=[],e instanceof r.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){let t=e.stream;this.width=t.readInt32(),this.height=t.readInt32(),this.blockWidth=t.readInt32(),this.blockHeight=t.readInt32();var r=this.width*this.height,s=new Uint8Array(t.buffer,t.byteOffset+t.position,4*r);this.images=[];for(let e=0;e<r;e++){var n=s[4*e+3]<<24|s[4*e+2]<<16|s[4*e+1]<<8|s[4*e];t.seek(n),n=new i.TmpImage(t,this.blockWidth,this.blockHeight),this.images.push(n)}}})}}})),System.register("util/Base64",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Base64",class{static encode(e){return void 0!==globalThis.btoa?globalThis.btoa(e):Buffer.from(e,"binary").toString("base64")}static decode(e){return void 0!==globalThis.atob?globalThis.atob(e):Buffer.from(e,"base64").toString("binary")}static isBase64(e){return!!e.match(/^([A-Za-z0-9+/]{4})*([A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{2}==)?$/)}})}}})),System.register("util/string",["util/Base64"],(function(e,t){"use strict";var i;function r(e){var t=e.length;let i=new Uint8Array(t);for(let r=0;r<t;r++)i[r]=e.charCodeAt(r);return i}function s(e){return e.reduce(((e,t)=>e+String.fromCharCode(t)),"")}return t&&t.id,e("pad",(function(e,t="0000"){var i=""+e;return t.substring(0,t.length-i.length)+i})),e("equalsIgnoreCase",(function(e,t){return e.toLowerCase()===t.toLowerCase()})),e("binaryStringToUint8Array",r),e("base64StringToUint8Array",(function(e){return r(i.Base64.decode(e))})),e("uint8ArrayToBase64String",(function(e){return i.Base64.encode(s(e))})),e("uint8ArrayToBinaryString",s),e("utf16ToBinaryString",(function(e){var t=e.length;let i="";for(let s=0;s<t;s++){var r=e.charCodeAt(s);i+=String.fromCharCode(r>>8),i+=String.fromCharCode(255&r)}return i})),e("binaryStringToUtf16",(function(e){var t=e.length;let i="";for(let s=0;s<t;s+=2){var r=(e.charCodeAt(s)<<8)+e.charCodeAt(s+1);i+=String.fromCharCode(r)}return i})),e("bufferToHexString",(function(e){const t=[],i=new DataView(e);for(let e=0;e<i.byteLength;e+=4){var r=((r="00000000")+i.getUint32(e).toString(16)).slice(-r.length);t.push(r)}return t.join("")})),{setters:[function(e){i=e}],execute:function(){}}})),System.register("util/Color",["util/string"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Color",class e{constructor(e,t,i){this.r=e,this.g=t,this.b=i}static fromRgb(t,i,r){return new e(t,i,r)}static fromHsv(t,i,r){let s=0,n=0,a=0;if(t=t/255*360%360,r/=255,0==(i/=255))s=r,n=r,a=r;else{var o=t/60,l=Math.floor(o),c=r*(1-i),h=r*(1-i*(o=o-l)),u=r*(1-i*(1-o));switch(l){case 0:s=r,n=u,a=c;break;case 1:s=h,n=r,a=c;break;case 2:s=c,n=r,a=u;break;case 3:s=c,n=h,a=r;break;case 4:s=u,n=c,a=r;break;case 5:s=r,n=c,a=h}}return e.fromRgb(Math.floor(255*s),Math.floor(255*n),Math.floor(255*a))}asHex(){return(this.r<<16)+(this.g<<8)+this.b}asHexString(){return"#"+i.pad(this.asHex().toString(16),"000000")}clone(){return new e(this.r,this.g,this.b)}})}}})),System.register("util/math",[],(function(e,t){"use strict";return t&&t.id,e("getRandomInt",(function(e,t){return Math.round(Math.random()*(t-e))+e})),e("clamp",(function(e,t,i){return Math.min(i,Math.max(e,t))})),e("isBetween",(function(e,t,i){return t<=e&&e<=i})),e("lerp",(function(e,t,i){return(1-i)*e+i*t})),e("truncToDecimals",(function(e,t){if(!e)return e;var i=10**t;return 0<=e?Math.floor(e*i)/i:Math.ceil(e*i)/i})),e("roundToDecimals",(function(e,t){if(!e)return e;var i=10**t;return Math.round(e*i)/i})),e("floorTo",(function(e,t){return Math.floor(e/t)*t})),e("fnv32a",(function(e){let t=2166136261;for(let i=0,r=e.length;i<r;++i)t^=e[i],t+=(t<<1)+(t<<4)+(t<<7)+(t<<8)+(t<<24);return t>>>0})),{setters:[],execute:function(){}}})),System.register("data/Palette",["util/Color","util/math","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("Palette",n=class e{constructor(e){e instanceof s.VirtualFile?this.fromVirtualFile(e):"object"==typeof e&&this.fromJson(e)}fromVirtualFile(e){var t=e.stream.readUint8Array(768);this.fromJson(t)}fromJson(e){this.colors=[];for(let t=0;t<e.length/3;++t)this.colors.push(i.Color.fromRgb(4*e[3*t],4*e[3*t+1],4*e[3*t+2]));this._hash=this.computeHash(this.colors)}getColor(e){return this.colors[e]}getColorAsHex(e){return this.getColor(e).asHex()}setColors(e){this.colors=e,this._hash=this.computeHash(this.colors)}get size(){return this.colors.length}get hash(){return this._hash}computeHash(e){let t=new Uint8Array(3*this.size),i=0;for(var s of e)t[i]=s.r,t[i+1]=s.g,t[i+2]=s.b,i+=3;return r.fnv32a(t)}clone(){let t=new e;return t.colors=this.colors.map((e=>e.clone())),t._hash=this._hash,t}remap(t){var i=[63,59,55,52,48,44,41,37,33,30,26,22,19,15,11,8];for(let r=e.REMAP_START_IDX;r<e.REMAP_START_IDX+i.length;r++)this.colors[r].r=Math.floor(t.r/255*i[r-e.REMAP_START_IDX]*4),this.colors[r].g=Math.floor(t.g/255*i[r-e.REMAP_START_IDX]*4),this.colors[r].b=Math.floor(t.b/255*i[r-e.REMAP_START_IDX]*4);return this._hash=this.computeHash(this.colors),this}}),n.REMAP_START_IDX=16}}})),System.register("game/theater/TileSet",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("TileSet",class{constructor(e,t,i){this.fileName=e,this.setName=t,this.tilesInSet=i,this.entries=[]}})}}})),System.register("game/theater/TileSetAnim",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("TileSetAnim",class{constructor(e,t,i,r){this.name=e,this.subTile=t,this.offsetX=i,this.offsetY=r}})}}})),System.register("game/theater/TileSetEntry",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("TileSetEntry",class{constructor(e,t){this.owner=e,this.index=t,this.files=[]}addFile(e){this.files.push(e)}setAnimation(e){this.animation=e}getAnimation(){return this.animation}getTmpFile(e,t,i=!1){if(this.files.length){var r=this.files[t(0,this.files.length-1)];return r.images[Math.min(e,r.images.length-1)].hasDamagedData?this.files[Math.min(i?1:0,this.files.length-1)]:r}}})}}})),System.register("engine/ResourceCollection",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/theater/TileSets",["util/string","game/theater/TileSetEntry","game/theater/TileSet","game/theater/TileSetAnim"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){var t;(t=a=a||{})[t.TopLeft=0]="TopLeft",t[t.BottomRight=1]="BottomRight",t[t.TopRight=2]="TopRight",t[t.BottomLeft=3]="BottomLeft",t[t.MiddleTlBr=4]="MiddleTlBr",t[t.MiddleTrBl=5]="MiddleTrBl",e("HighBridgeHeadType",a),o=new Map([[a.TopLeft,["BridgeTopLeft1","BridgeTopLeft2"]],[a.BottomRight,["BridgeBottomRight1","BridgeBottomRight2"]],[a.TopRight,["BridgeTopRight1","BridgeTopRight2"]],[a.BottomLeft,["BridgeBottomLeft1","BridgeBottomLeft2"]],[a.MiddleTlBr,["BridgeMiddle1"]],[a.MiddleTrBl,["BridgeMiddle2"]]]),e("TileSets",class{constructor(e){this.theaterIni=e,this.tileSets=[],this.orderedEntries=[],this.highBridgeSetNums=[this.getGeneralValue("BridgeSet"),this.getGeneralValue("WoodBridgeSet")],this.cliffSetNums=[this.getGeneralValue("CliffSet"),this.getGeneralValue("WaterCliffs"),this.getGeneralValue("DestroyableCliffs")]}getTile(e){return this.orderedEntries[e]}getTileImage(e,t,i){let r=this.getTile(e);if(!r)throw new Error(`TileNum ${e} not found`);var s=r.getTmpFile(t,i);if(!s||t>=s.images.length)throw new Error(`SubTile ${t} not found`);return s.images[t]}getSetNum(e){var t=this.orderedEntries[e];if(!t)throw new Error("Invalid tileNum "+e);return this.tileSets.indexOf(t.owner)}getTileNumFromSet(e,t=0){let i=0;return this.tileSets.some(((r,s)=>s===e?(i+=t,!0):(i+=r.entries.length,!1))),i}getGeneralValue(e){let t=this.theaterIni.getSection("General");if(!t)throw new Error("Missing [General] section in theather ini");return t.getNumber(e)}loadTileData(e,t){this.tileSets.length=0,this.orderedEntries.length=0,this.initTileSets(e,t),this.initAnimations()}readMaxTileNum(){let e=0,t=0;for(;;){var r="TileSet"+i.pad(e,"0000");let s=this.theaterIni.getSection(r);if(!s)break;e++,t+=s.getNumber("TilesInSet")}return t}initTileSets(e,t){let n,a=0;for(var o;o="TileSet"+i.pad(a,"0000"),n=this.theaterIni.getSection(o),n;){a++;let o=new s.TileSet(n.getString("FileName"),n.getString("SetName"),n.getNumber("TilesInSet"));this.tileSets.push(o);for(let s=1;s<=o.tilesInSet;s++){let n=new r.TileSetEntry(o,s-1);var l="a".charCodeAt(0);for(let r=l-1;r<="z".charCodeAt(0);r++)if(!(r>=l&&"Bridges"===o.setName)){let a=o.fileName+i.pad(s,"00");r>=l&&(a+=String.fromCharCode(r)),a+=t;var c=e.get(a);if(!c)break;n.addFile(c)}o.entries.push(n),this.orderedEntries.push(n)}}}initAnimations(){var e=this.theaterIni.getOrderedSections();for(let a=this.tileSets.length;a<e.length;++a){let o=e[a],l=this.tileSets.find((e=>e.setName===o.name));if(l)for(let e=1;e<=l.tilesInSet;++e){var t="Tile"+i.pad(e,"00"),r=t+"Anim",s=o.getString(r);s?(t=new n.TileSetAnim(s,o.getNumber(t+"AttachesTo"),o.getNumber(t+"XOffset"),o.getNumber(t+"YOffset")),l.entries[e-1].setAnimation(t)):console.warn(`Missing anim "${r}" for tileset `+l.setName)}}}isLAT(e){return e===this.getGeneralValue("RoughTile")||e===this.getGeneralValue("SandTile")||e===this.getGeneralValue("GreenTile")||e===this.getGeneralValue("PaveTile")}isCLAT(e){return e===this.getGeneralValue("ClearToRoughLat")||e===this.getGeneralValue("ClearToSandLat")||e===this.getGeneralValue("ClearToGreenLat")||e===this.getGeneralValue("ClearToPaveLat")}getLAT(e){return e===this.getGeneralValue("ClearToRoughLat")?this.getGeneralValue("RoughTile"):e===this.getGeneralValue("ClearToSandLat")?this.getGeneralValue("SandTile"):e===this.getGeneralValue("ClearToGreenLat")?this.getGeneralValue("GreenTile"):e===this.getGeneralValue("ClearToPaveLat")?this.getGeneralValue("PaveTile"):-1}getCLATSet(e){return e===this.getGeneralValue("RoughTile")?this.getGeneralValue("ClearToRoughLat"):e===this.getGeneralValue("SandTile")?this.getGeneralValue("ClearToSandLat"):e===this.getGeneralValue("GreenTile")?this.getGeneralValue("ClearToGreenLat"):e===this.getGeneralValue("PaveTile")?this.getGeneralValue("ClearToPaveLat"):-1}canConnectTiles(e,t){if(e===t)return!1;var i=this.getGeneralValue("GreenTile"),r=this.getGeneralValue("PaveTile"),s=this.getGeneralValue("MiscPaveTile"),n=this.getGeneralValue("ShorePieces"),a=this.getGeneralValue("WaterBridge"),o=this.getGeneralValue("PavedRoads"),l=this.getGeneralValue("Medians");return!(e===i&&t===n||t===i&&e===n||e===i&&t===a||t===i&&e===a||e===r&&t===o||t===r&&e===o||e===r&&t===s||t===r&&e===s||e===r&&t===l||t===r&&e===l)}getHighBridgeHeadType(e){for(var[t,i]of o)for(var r of i)if(this.getGeneralValue(r)===e+1)return t}getOppositeHighBridgeHeadType(e){switch(e){case a.TopLeft:return a.BottomRight;case a.TopRight:return a.BottomLeft;case a.BottomLeft:return a.TopRight;case a.BottomRight:return a.TopLeft;case a.MiddleTlBr:case a.MiddleTrBl:throw new Error("Middle bridge heads can't have opposites");default:throw new Error("Unhandled headType "+e)}}isCliffTile(e){return this.cliffSetNums.includes(this.getSetNum(e))}isHighBridgeBoundaryTile(e){if(this.highBridgeSetNums.includes(this.getSetNum(e))){var t=this.getTile(e);return void 0!==(t=this.getHighBridgeHeadType(t.index))&&![a.MiddleTlBr,a.MiddleTrBl].includes(t)}return!1}isHighBridgeMiddleTile(e){if(this.highBridgeSetNums.includes(this.getSetNum(e))){var t=this.getTile(e);return void 0!==(t=this.getHighBridgeHeadType(t.index))&&[a.MiddleTlBr,a.MiddleTrBl].includes(t)}return!1}})}}})),System.register("engine/type/PaletteType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Iso=1]="Iso",t[t.Unit=2]="Unit",t[t.Overlay=3]="Overlay",t[t.Anim=4]="Anim",t[t.Custom=5]="Custom",t[t.Default=6]="Default",e("PaletteType",i)}}})),System.register("engine/TheaterType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Temperate=1]="Temperate",t[t.Urban=2]="Urban",t[t.Snow=4]="Snow",t[t.Lunar=8]="Lunar",t[t.Desert=16]="Desert",t[t.NewUrban=32]="NewUrban",t[t.All=63]="All",e("TheaterType",i)}}})),System.register("engine/Theater",["game/theater/TileSets","engine/type/PaletteType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Theater",class{constructor(e,t,i,r,s,n,a,o,l){this.type=e,this.settings=t,this.palettes=i,this.isoPalette=r,this.ovlPalette=s,this.unitPalette=n,this.animPalette=a,this.libPalette=o,this.tileSets=l}static factory(e,t,r,s,n){var a=n.get(r.IsoPaletteName);if(!a)throw new Error(`Missing palette "${r.IsoPaletteName}"`);var o=n.get(r.OverlayPaletteName);if(!o)throw new Error(`Missing palette "${r.OverlayPaletteName}"`);var l=n.get(r.UnitPaletteName);if(!l)throw new Error(`Missing palette "${r.UnitPaletteName}"`);var c=n.get("anim.pal");if(!c)throw new Error("Missing anim palette");var h=n.get(r.LibPaletteName);if(!h)throw new Error("Missing lib palette "+r.LibPaletteName);let u=new i.TileSets(t);return u.loadTileData(s,r.Extension),new this(e,r,n,a,o,l,c,h,u)}getPalette(e,t){switch(e){case r.PaletteType.Anim:return this.animPalette;case r.PaletteType.Overlay:return this.ovlPalette;case r.PaletteType.Unit:return this.unitPalette;case r.PaletteType.Custom:if("lib"===t)return this.libPalette;var i=this.palettes.get(t+".pal");if(!i)throw new Error(`Custom palette "${t}" not found`);return i;default:return r.PaletteType.Iso,this.isoPalette}}})}}})),System.register("version",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("version","0.57.2")}}})),System.register("data/IdxEntry",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("IdxEntry",class{})}}})),System.register("data/IdxFile",["data/IdxEntry"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("IdxFile",class{constructor(e){this.entries=new Map,this.parse(e)}parse(e){var t=e.readCString(4);if("GABA"!==t)throw new Error(`Unable to load Idx file, did not find magic id, found ${t} instead`);if(2!==(t=e.readInt32()))throw new Error(`Unable to load Idx file, did not find magic number 2, found ${t} instead`);var r=e.readInt32();for(let t=0;t<r;t++){const t=new i.IdxEntry;let r=e.readString(16);var s=r.indexOf("\0");0!==s&&(r=r.substr(0,s)),t.filename=r+".wav",t.offset=e.readUint32(),t.length=e.readUint32(),t.sampleRate=e.readUint32(),t.flags=e.readUint32(),t.chunkSize=e.readUint32(),this.entries.set(t.filename,t)}}})}}})),System.register("data/vfs/Archive",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/AudioBagFile",["data/DataStream","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("AudioBagFile",class{constructor(){this.fileData=new Map}fromVirtualFile(e,t){var i,r;for([i,r]of t.entries){var s=this.buildWavData(e.stream,r);this.fileData.set(i,s)}return this}getFileList(){return[...this.fileData.keys()]}containsFile(e){return this.fileData.has(e)}openFile(e){if(!this.containsFile(e))throw new Error(`File "${e}" not found`);return new r.VirtualFile(this.fileData.get(e),e)}buildWavData(e,t){let r=new i.DataStream;var s,n,a,o,l=0<(1&t.flags)?2:1;let c=0;0<(2&t.flags)?(r.writeString("RIFF"),r.writeUint32(t.length+36),r.writeString("WAVE"),r.writeString("fmt "),r.writeInt32(16),r.writeInt16(1),r.writeInt16(l),r.writeUint32(t.sampleRate),r.writeUint32(2*l*t.sampleRate),r.writeInt16(2*l),r.writeInt16(16),r.writeString("data"),r.writeUint32(t.length)):0<(8&t.flags)&&(s=11100*l*(t.sampleRate/22050|0),n=t.chunkSize,a=1017*(o=Math.max(2,Math.ceil(t.length/n))),c=(o*=n)-t.length,r.writeString("RIFF"),r.writeUint32(52+o),r.writeString("WAVE"),r.writeString("fmt "),r.writeUint32(20),r.writeInt16(17),r.writeInt16(l),r.writeUint32(t.sampleRate),r.writeInt32(s),r.writeInt16(n),r.writeInt16(4),r.writeInt16(2),r.writeInt16(1017),r.writeString("fact"),r.writeUint32(4),r.writeInt32(a),r.writeString("data"),r.writeUint32(o)),e.seek(t.offset),r.writeUint8Array(e.readUint8Array(t.length));for(let e=0;e<c;e++)r.writeUint8(0);return r.seek(0),r._trimAlloc=()=>{},r}})}}})),System.register("data/encoding/Blowfish",[],(function(e,t){"use strict";function i(e){return((e=(e<<16>>>0|e>>>16)>>>0)<<8>>>0&4278255360|e>>>8&16711935)>>>0}return t&&t.id,{setters:[],execute:function(){e("Blowfish",class{constructor(e){this.m_p=new Uint32Array([608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731]),this.m_s=[new Uint32Array([3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946]),new Uint32Array([1266315497,3048417604,3681880366,3289982499,290971e4,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055]),new Uint32Array([3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504]),new Uint32Array([976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409e3,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462])];for(let n=0,a=0;n<18;++n){var t=e[a++%e.length],i=e[a++%e.length],r=e[a++%e.length],s=e[a++%e.length];this.m_p[n]^=t<<24|i<<16|r<<8|s}let n=0,a=0;for(let e=0;e<18;)[n,a]=this._encrypt(n,a),this.m_p[e++]=n,this.m_p[e++]=a;for(let e=0;e<4;++e)for(let t=0;t<256;)[n,a]=this._encrypt(n,a),this.m_s[e][t++]=n,this.m_s[e][t++]=a}encrypt(e){return this.runCipher(e,this._encrypt.bind(this))}decrypt(e){return this.runCipher(e,this._decrypt.bind(this))}runCipher(e,t){let r=new Uint32Array(e.length),s=e.length/2|0,n=0;for(;0<s--;){var a=i(e[n]),o=i(e[n+1]);[a,o]=t(a,o),r[n++]=i(a),r[n++]=i(o)}return r}_encrypt(e,t){let i=e,r=t;i^=this.m_p[0];let s=!1;for(let e=1;e<=16;e++,s=!s)s?i=this.round(i,r,e):r=this.round(r,i,e);return r^=this.m_p[17],[r,i]}_decrypt(e,t){let i=e,r=t;i^=this.m_p[17];let s=!1;for(let e=16;1<=e;e--,s=!s)s?i=this.round(i,r,e):r=this.round(r,i,e);return r^=this.m_p[0],[r,i]}s(e,t){return this.m_s[t][e>>(3-t<<3)&255]}bf_f(e){return(this.s(e,0)+this.s(e,1)>>>0^this.s(e,2))+this.s(e,3)>>>0}round(e,t,i){return e^this.bf_f(t)^this.m_p[i]}})}}})),System.register("data/encoding/BlowfishKey",[],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[],execute:function(){i="AihRvNoIbTn85FZRYNZRcT+i6KpU+maCsEqr3Q5q+LDB5tH7Tz2qQ38V",r=new Int8Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),s=class{constructor(){this.key1=new Uint32Array(64),this.key2=new Uint32Array(64)}},e("BlowfishKey",class{constructor(){this.pubkey=new s,this.glob1=new Uint32Array(64),this.glob2=new Uint32Array(130),this.glob1_hi=new Uint32Array(4),this.glob1_hi_inv=new Uint32Array(4)}init_bignum(e,t,i){for(let t=0;t<i;t++)e[t]=0;e[0]=t}move_key_to_big(e,t,i,r){let s;s=0!=(128&t[0])?255:0;const n=new Uint8Array(e.buffer,e.byteOffset);let a=4*r;for(;a>i;a--)n[a-1]=s;for(;0<a;a--)n[a-1]=t[i-a]}key_to_bignum(e,t,i){let r,s,n=0;if(2===t[n]){if(n++,0!=(128&t[n])){for(r=0,s=0;s<(127&t[n]);s++)r=(r<<8>>>0|t[n+s+1])>>>0;n+=1+(127&t[n])}else r=t[n],n++;r<=4*i&&this.move_key_to_big(e,t.subarray(n),r,i)}}len_bignum(e,t){let i=t-1;for(;0<=i&&0===e[i];)i--;return i+1}bitlen_bignum(e,t){var i;let r,s;if(0===(i=this.len_bignum(e,t)))return 0;for(r=32*i,s=2147483648;0==(s&e[i-1]);)s>>>=1,r--;return r}init_pubkey(){let e,t=0;var s;const n=new Uint8Array(256);for(this.init_bignum(this.pubkey.key2,65537,64),e=0;t<56;)s=(((r[i.charCodeAt(t++)]>>>0<<6>>>0|255&r[i.charCodeAt(t++)])>>>0<<6>>>0|255&r[i.charCodeAt(t++)])>>>0<<6>>>0|255&r[i.charCodeAt(t++)])>>>0,n[e++]=s>>16&255,n[e++]=s>>8&255,n[e++]=255&s;this.key_to_bignum(this.pubkey.key1,n,64),this.pubkey.len=this.bitlen_bignum(this.pubkey.key1,64)-1}len_predata(){var e=(this.pubkey.len-1)/8|0;return(1+(55/e|0))*(1+e)>>>0}cmp_bignum(e,t,i){for(;0<i;){if(e[--i]<t[i])return-1;if(e[i]>t[i])return 1}return 0}mov_bignum(e,t,i){for(let r=0;r<i;r++)e[r]=t[r]}shr_bignum(e,t,i){let r;var s=t/32|0;if(0<s){for(r=0;r<i-s;r++)e[r]=e[r+s];for(;r<i;r++)e[r]=0;t%=32}if(0!==t){for(r=0;r<i-1;r++)e[r]=(e[r]>>>t|e[r+1]<<32-t>>>0)>>>0;e[r]=e[r]>>>t}}shl_bignum(e,t,i){let r;var s=t/32|0;if(0<s){for(r=i-1;r>s;r--)e[r]=e[r-s];for(;0<r;r--)e[r]=0;t%=32}if(0!==t){for(r=i-1;0<r;r--)e[r]=(e[r]<<t>>>0|e[r-1]>>>32-t)>>>0;e[0]=e[0]<<t>>>0}}sub_bignum(e,t,i,r,s){var n,a;s+=s;var o=new Uint16Array(t.buffer,t.byteOffset),l=new Uint16Array(i.buffer,i.byteOffset);const c=new Uint16Array(e.buffer,e.byteOffset);let h=0;for(;-1!=--s;)n=o[h],a=l[h],c[h]=n-a-r&65535,r=0!=(n-a-r&65536)?1:0,h++;return r}sub_bignum_word(e,t,i,r,s){var n,a;let o=0;for(;-1!=--s;)n=t[o],a=i[o],e[o]=n-a-r&65535,r=0!=(n-a-r&65536)?1:0,o++;return r}inv_bignum(e,t,i){const r=new Uint32Array(64);var s;let n,a,o=0;for(this.init_bignum(r,0,i),this.init_bignum(e,0,i),a=this.bitlen_bignum(t,i),n=1<<a%32>>>0,o=((a+32)/32|0)-1,r[(s=4*((a-1)/32|0)>>>0)/4|0]=r[s/4|0]|1<<(a-1&31)>>>0;0<a;)a--,this.shl_bignum(r,1,i),-1!==this.cmp_bignum(r,t,i)&&(this.sub_bignum(r,r,t,0,i),e[o]=e[o]|n>>>0),n>>>=1,0===n&&(o--,n=2147483648);this.init_bignum(r,0,i)}inc_bignum(e,t){let i=0;for(;0==++e[i]&&0<--t;)i++}init_two_dw(e,t){this.mov_bignum(this.glob1,e,t),this.glob1_bitlen=this.bitlen_bignum(this.glob1,t),this.glob1_len_x2=(this.glob1_bitlen+15)/16|0,this.mov_bignum(this.glob1_hi,this.glob1.subarray(this.len_bignum(this.glob1,t)-2),2),this.glob1_hi_bitlen=this.bitlen_bignum(this.glob1_hi,2)-32>>>0,this.shr_bignum(this.glob1_hi,this.glob1_hi_bitlen,2),this.inv_bignum(this.glob1_hi_inv,this.glob1_hi,2),this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen=(this.glob1_hi_bitlen+15)%16+1>>>0,this.inc_bignum(this.glob1_hi_inv,2),32<this.bitlen_bignum(this.glob1_hi_inv,2)&&(this.shr_bignum(this.glob1_hi_inv,1,2),this.glob1_hi_bitlen--),this.glob1_hi_inv_lo=65535&this.glob1_hi_inv[0],this.glob1_hi_inv_hi=this.glob1_hi_inv[0]>>>16&65535}mul_bignum_word(e,t,i,r){let s,n;var a=new Uint16Array(t.buffer,t.byteOffset);let o=n=0;for(s=0;s<r;s++)n=i*a[o]+e[o]+n,e[o]=65535&n,o++,n>>>=16;e[o]+=65535&n}mul_bignum(e,t,i,r){let s;var n=new Uint16Array(i.buffer,i.byteOffset);let a=new Uint16Array(e.buffer,e.byteOffset);this.init_bignum(e,0,2*r);let o=0;for(s=0;s<2*r;s++)this.mul_bignum_word(a.subarray(o),t,n[o],2*r),o++}not_bignum(e,t){let i;for(i=0;i<t;i++)e[i]=~e[i]>>>0}neg_bignum(e,t){this.not_bignum(e,t),this.inc_bignum(e,t)}get_mulword(e,t){let i=((((65535&(65535^e[t-1]))*this.glob1_hi_inv_lo+65536>>>1)+((65535^e[t-2])*this.glob1_hi_inv_hi+this.glob1_hi_inv_hi>>>1)+1>>>16)+((65535&(65535^e[t-1]))*this.glob1_hi_inv_hi>>>1)+((65535^e[t])*this.glob1_hi_inv_lo>>>1)+1>>>14)+this.glob1_hi_inv_hi*(65535^e[t])*2>>>this.glob1_hi_bitlen>>>0;return 65535<i&&(i=65535),65535&i}dec_bignum(e,t){let i=0;for(;--e[i]>>>0==4294967295&&0<--t;)i++}calc_a_bignum(e,t,i,r){var s;let n;var a=this.glob1,o=this.glob2;if(this.mul_bignum(this.glob2,t,i,r),this.glob2[2*r]=0,(s=2*this.len_bignum(this.glob2,2*r+1))>=this.glob1_len_x2){this.inc_bignum(this.glob2,2*r+1),this.neg_bignum(this.glob2,2*r+1),n=1+s-this.glob1_len_x2;let e=new Uint16Array(o.buffer),t=n,i=1+s;for(;0!==n;n--){i--;var l=this.get_mulword(e,i);t--;var c=e.subarray(t);0<l&&(this.mul_bignum_word(c,this.glob1,l,2*r),0==(32768&e[i])&&0!==this.sub_bignum_word(c,c,new Uint16Array(a.buffer),0,2*r)&&e[i]--)}this.neg_bignum(this.glob2,r),this.dec_bignum(this.glob2,r)}this.mov_bignum(e,this.glob2,r)}clear_tmp_vars(e){this.init_bignum(this.glob1,0,e),this.init_bignum(this.glob2,0,e),this.init_bignum(this.glob1_hi_inv,0,4),this.init_bignum(this.glob1_hi,0,4),this.glob1_bitlen=0,this.glob1_hi_bitlen=0,this.glob1_len_x2=0,this.glob1_hi_inv_lo=0,this.glob1_hi_inv_hi=0}calc_a_key(e,t,i,r,s){var n,a=new Uint32Array(64);let o,l,c=0;for(this.init_bignum(e,1,s),n=this.len_bignum(r,s),this.init_two_dw(r,n),o=this.bitlen_bignum(i,n)<<24>>24,l=1<<(o-1)%32>>>1,c+=(((o+31)/32|0)>>>0)-1,o--,this.mov_bignum(e,t,n);-1!=--o;)0===l&&(l=2147483648,c--),this.calc_a_bignum(a,e,e,n),0!=(i[c]&l)?this.calc_a_bignum(e,a,t,n):this.mov_bignum(e,a,n),l>>>=1;this.init_bignum(a,0,n),this.clear_tmp_vars(s)}memcpy(e,t,i){let r=0;for(;0!=i--;)e[r]=t[r],r++}process_predata(e,t,i){var r=new Uint32Array(64),s=new Uint32Array(64);let n=0,a=0;for(var o=(this.pubkey.len-1)/8|0;1+o<=t;)this.init_bignum(r,0,64),this.memcpy(new Uint8Array(r.buffer),e.subarray(n),1+o),this.calc_a_key(s,r,this.pubkey.key2,this.pubkey.key1,64),this.memcpy(i.subarray(a),new Uint8Array(s.buffer),o),t-=1+o,n+=1+o,a+=o}decryptKey(e){this.init_pubkey();let t=new Uint8Array(256);return this.process_predata(e,this.len_predata(),t),t.subarray(0,56)}})}}})),System.register("data/Crc32",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("Crc32",i=class e{constructor(e=4294967295){this.polynomal=e,this.crc=e}static calculateCrc(e,t=4294967295){let i=t;for(let t=0,r=e.length;t<r;t++)i=(i>>>8^this.lookUp[255&i^e[t]])>>>0;return i=(i^t)>>>0,i}append(t){for(let i=0,r=t.length;i<r;i++)this.crc=(this.crc>>>8^e.lookUp[255&this.crc^t[i]])>>>0}get(){return(this.crc^this.polynomal)>>>0}}),i.lookUp=new Uint32Array([0,1996959894,3993919788,2567524794,124634137,1886057615,3915621685,2657392035,249268274,2044508324,3772115230,2547177864,162941995,2125561021,3887607047,2428444049,498536548,1789927666,4089016648,2227061214,450548861,1843258603,4107580753,2211677639,325883990,1684777152,4251122042,2321926636,335633487,1661365465,4195302755,2366115317,997073096,1281953886,3579855332,2724688242,1006888145,1258607687,3524101629,2768942443,901097722,1119000684,3686517206,2898065728,853044451,1172266101,3705015759,2882616665,651767980,1373503546,3369554304,3218104598,565507253,1454621731,3485111705,3099436303,671266974,1594198024,3322730930,2970347812,795835527,1483230225,3244367275,3060149565,1994146192,31158534,2563907772,4023717930,1907459465,112637215,2680153253,3904427059,2013776290,251722036,2517215374,3775830040,2137656763,141376813,2439277719,3865271297,1802195444,476864866,2238001368,4066508878,1812370925,453092731,2181625025,4111451223,1706088902,314042704,2344532202,4240017532,1658658271,366619977,2362670323,4224994405,1303535960,984961486,2747007092,3569037538,1256170817,1037604311,2765210733,3554079995,1131014506,879679996,2909243462,3663771856,1141124467,855842277,2852801631,3708648649,1342533948,654459306,3188396048,3373015174,1466479909,544179635,3110523913,3462522015,1591671054,702138776,2966460450,3352799412,1504918807,783551873,3082640443,3233442989,3988292384,2596254646,62317068,1957810842,3939845945,2647816111,81470997,1943803523,3814918930,2489596804,225274430,2053790376,3826175755,2466906013,167816743,2097651377,4027552580,2265490386,503444072,1762050814,4150417245,2154129355,426522225,1852507879,4275313526,2312317920,282753626,1742555852,4189708143,2394877945,397917763,1622183637,3604390888,2714866558,953729732,1340076626,3518719985,2797360999,1068828381,1219638859,3624741850,2936675148,906185462,1090812512,3747672003,2825379669,829329135,1181335161,3412177804,3160834842,628085408,1382605366,3423369109,3138078467,570562233,1426400815,3317316542,2998733608,733239954,1555261956,3268935591,3050360625,752459403,1541320221,2607071920,3965973030,1969922972,40735498,2617837225,3943577151,1913087877,83908371,2512341634,3803740692,2075208622,213261112,2463272603,3855990285,2094854071,198958881,2262029012,4057260610,1759359992,534414190,2176718541,4139329115,1873836001,414664567,2282248934,4279200368,1711684554,285281116,2405801727,4167216745,1634467795,376229701,2685067896,3608007406,1308918612,956543938,2808555105,3495958263,1231636301,1047427035,2932959818,3654703836,1088359270,936918e3,2847714899,3736837829,1202900863,817233897,3183342108,3401237130,1404277552,615818150,3134207493,3453421203,1423857449,601450431,3009837614,3294710456,1567103746,711928724,3020668471,3272380065,1510334235,755167117])}}})),System.register("data/MixEntry",["util/string","data/Crc32"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("MixEntry",s=class{constructor(e,t,i){this.hash=e,this.offset=t,this.length=i}static hashFilename(e){var t=(e=e.toUpperCase()).length,s=t>>2;if(0!=(3&t)){e+=String.fromCharCode(t-(s<<2));let i=3-(3&t);for(;0!=i--;)e+=e[s<<2]}return r.Crc32.calculateCrc(i.binaryStringToUint8Array(e))}}),s.size=12}}})),System.register("data/MixFile",["data/DataStream","data/encoding/Blowfish","data/encoding/BlowfishKey","data/MixEntry","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.Checksum=65536]="Checksum",t[t.Encrypted=131072]="Encrypted",e("MixFile",class{constructor(e){this.stream=e,this.headerStart=84,this.index=new Map,this.parseHeader()}parseHeader(){var e=this.stream.readUint32();if(0==(e&~(o.Checksum|o.Encrypted))){if(0!=(e&o.Encrypted))return void(this.dataStart=this.parseRaHeader())}else this.stream.seek(0);this.dataStart=this.parseTdHeader(this.stream)}parseRaHeader(){const e=this.stream;var t=e.readUint8Array(80),a=(new s.BlowfishKey).decryptKey(t),o=e.readUint32Array(2);const l=new r.Blowfish(a);let c=new i.DataStream(l.decrypt(o));return t=c.readUint16(),c.readUint32(),e.position=this.headerStart,t=(3+(a=6+t*n.MixEntry.size))/4|0,o=e.readUint32Array(t+t%2),c=new i.DataStream(l.decrypt(o)),a=this.headerStart+a+(1+(~a>>>0)&7),this.parseTdHeader(c),a}parseTdHeader(e){var t=e.readUint16();e.readUint32();for(let r=0;r<t;r++){var i=new n.MixEntry(e.readUint32(),e.readUint32(),e.readUint32());this.index.set(i.hash,i)}return e.position}containsFile(e){return this.index.has(n.MixEntry.hashFilename(e))}openFile(e){var t=this.index.get(n.MixEntry.hashFilename(e));if(!t)throw new Error(`File "${e}" not found`);return a.VirtualFile.factory(this.stream,e,this.dataStart+t.offset,t.length)}})}}})),System.register("util/Logger",["js-logger"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("AppLogger",i)}}})),System.register("data/vfs/FileNotFoundError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{constructor(){super(...arguments),this.name="FileNotFoundError"}},e("FileNotFoundError",i)}}})),System.register("data/vfs/MemArchive",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MemArchive",class{constructor(){this.entries=new Map}addFile(e){this.entries.set(e.filename,e)}containsFile(e){return this.entries.has(e)}openFile(e){if(!this.containsFile(e))throw new Error(`File "${e}" not found`);return this.entries.get(e)}})}}})),System.register("data/vfs/StorageQuotaError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{constructor(e){super("Storage quota exceeded",e),this.name="StorageQuotaError"}},e("StorageQuotaError",i)}}})),System.register("data/vfs/NameNotAllowedError",["data/vfs/IOError"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.IOError{constructor(){super(...arguments),this.name="NameNotAllowedError"}},e("NameNotAllowedError",r)}}})),System.register("data/vfs/RealFileSystemDir",["data/vfs/StorageQuotaError","util/string","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/NameNotAllowedError","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("RealFileSystemDir",class e{constructor(e,t=!1){this.handle=e,this.caseSensitive=t}get name(){return this.handle.name}async*getEntries(){try{for await(var e of this.handle.keys())yield e}catch(e){if("NotFoundError"===e.name)throw new s.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:e});if(e instanceof DOMException)throw new n.IOError(`Directory "${this.handle.name}" could not be read (${e.name})`,{cause:e});throw e}}async listEntries(){let e=[];for await(var t of this.getEntries())e.push(t);return e}async*getFileHandles(){try{for await(const e of this.handle.values())"file"===e.kind&&(yield e)}catch(e){if("NotFoundError"===e.name)throw new s.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:e});if(e instanceof DOMException)throw new n.IOError(`Directory "${this.handle.name}" could not be read (${e.name})`,{cause:e});throw e}}async*getRawFiles(){for await(const e of this.getFileHandles())yield await e.getFile()}async containsEntry(e){return void 0!==await this.resolveEntryName(e)}async resolveEntryName(e){if(this.caseSensitive)return(await this.handle.getFileHandle(e).catch((()=>this.handle.getDirectoryHandle(e))).catch((()=>{})))?.name;for await(const t of this.getEntries())if(r.equalsIgnoreCase(t,e))return t}async fixEntryCase(e){if(!this.caseSensitive)for await(var t of this.getEntries())if(r.equalsIgnoreCase(t,e)){e=t;break}return e}async getRawFile(e,t=!1,i){let r;try{var o=t?e:await this.fixEntryCase(e);r=await this.handle.getFileHandle(o)}catch(t){if("NotFoundError"===t.name)throw new s.FileNotFoundError(`File "${e}" not found in directory "${this.handle.name}"`,{cause:t});if(t instanceof TypeError&&t.message.includes("not allowed"))throw new a.NameNotAllowedError(`File name "${e}" is not allowed`,{cause:t});if(t instanceof DOMException)throw new n.IOError(`File "${e}" could not be read (${t.name})`,{cause:t});throw t}return o=await r.getFile(),i?new File([o],o.name,{type:i}):o}async openFile(e,t=!1){var i=await this.getRawFile(e,t);return o.VirtualFile.fromRealFile(i)}async writeFile(e,t){var r=t??(e instanceof File?e.name:e.filename);try{var o=await this.fixEntryCase(r);await this.deleteFile(o,!0);let i=await this.handle.getFileHandle(o,{create:!0}),s=await i.createWritable();try{await s.write(e instanceof File?e:new Uint8Array(e.stream.buffer,e.stream.byteOffset,e.stream.byteLength)),await s.close()}catch(t){throw await s.abort(),t}}catch(t){if("QuotaExceededError"===t.name)throw new i.StorageQuotaError({cause:t});if("NotFoundError"===t.name)throw new s.FileNotFoundError(`Directory "${this.handle.name}" not found`,{cause:t});if(t instanceof TypeError&&t.message.includes("not allowed"))throw new a.NameNotAllowedError(`File name "${r}" is not allowed`,{cause:t});if(t instanceof DOMException)throw new n.IOError(`File "${r}" could not be written (${t.name})`,{cause:t});throw t}}async deleteFile(e,t=!1){var r=t?e:await this.resolveEntryName(e);if(r)try{await this.handle.removeEntry(r)}catch(e){if(t&&"NotFoundError"===e.name)return;if("QuotaExceededError"===e.name)throw new i.StorageQuotaError({cause:e});if(e instanceof TypeError&&e.message.includes("not allowed"))throw new a.NameNotAllowedError(`File name "${r}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new n.IOError(`File "${r}" could not be deleted (${e.name})`,{cause:e});throw e}}async getDirectory(t,i=this.caseSensitive){var r=i?t:await this.fixEntryCase(t);let o;try{o=await this.handle.getDirectoryHandle(r)}catch(i){if("NotFoundError"===i.name)throw new s.FileNotFoundError(`Directory "${t}" not found or parent directory "${this.handle.name}" is gone`,{cause:i});if(i instanceof TypeError&&i.message.includes("not allowed"))throw new a.NameNotAllowedError(`Directory name "${t}" is not allowed`,{cause:i});if(i instanceof DOMException)throw new n.IOError(`Directory "${t}" could not be read (${i.name})`,{cause:i});throw i}return new e(o,i)}async getOrCreateDirectory(t,r=this.caseSensitive){var o=r?t:await this.fixEntryCase(t);try{return new e(await this.handle.getDirectoryHandle(o,{create:!0}),r)}catch(r){if("QuotaExceededError"===r.name)throw new i.StorageQuotaError({cause:r});if("NotFoundError"===r.name)throw new s.FileNotFoundError(`Directory "${this.handle.name}" not found"`,{cause:r});if(r instanceof TypeError&&r.message.includes("not allowed"))throw new a.NameNotAllowedError(`Directory name "${t}" is not allowed`,{cause:r});if(r instanceof DOMException)throw new n.IOError(`Directory "${t}" could not be created (${r.name})`,{cause:r});throw r}}async deleteDirectory(e,t=!1){var r=await this.resolveEntryName(e);if(r)try{await this.handle.removeEntry(r,{recursive:t})}catch(e){if("QuotaExceededError"===e.name)throw new i.StorageQuotaError({cause:e});if("InvalidModificationError"===e.name)throw new n.IOError("Can't delete non-empty directory when recursive = false");if(e instanceof TypeError&&e.message.includes("not allowed"))throw new a.NameNotAllowedError(`Directory name "${r}" is not allowed`,{cause:e});if(e instanceof DOMException)throw new n.IOError(`Directory "${r}" could not be deleted (${e.name})`,{cause:e});throw e}}})}}})),System.register("data/vfs/RealFileSystem",["data/vfs/FileNotFoundError","data/vfs/RealFileSystemDir"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("RealFileSystem",class{constructor(){this.directories=[]}addRootDirectoryHandle(e){this.rootDirectory=this.addDirectoryHandle(e),this.rootDirectoryHandle=e}getRootDirectoryHandle(){return this.rootDirectoryHandle}addDirectoryHandle(e){var t=new r.RealFileSystemDir(e);return this.directories.push(t),t}addDirectory(e){this.directories.push(e)}async getDirectory(e){var t=await this.findDirectory(e);if(!t)throw new Error(`Directory "${e}" not found in real file system`);return t}async findDirectory(e){for(const t of this.directories)if(await t.containsEntry(e))return await t.getDirectory(e)}getRootDirectory(){return this.rootDirectory}async containsEntry(e){for(const t of this.directories)if(await t.containsEntry(e))return!0;return!1}async openFile(e,t=!1){for(const r of this.directories)try{return await r.openFile(e,t)}catch(e){if(!(e instanceof i.FileNotFoundError))throw e}throw new i.FileNotFoundError(`File "${e}" not found in real file system`)}async getRawFile(e){for(const t of this.directories)if(await t.containsEntry(e))return await t.getRawFile(e);throw new Error(`File "${e}" not found in real file system`)}async*getEntries(){for(var e of this.directories)for await(var t of e.getEntries())yield t}})}}})),System.register("data/vfs/VirtualFileSystem",["data/AudioBagFile","data/IdxFile","data/MixFile","engine/Engine","util/string","data/vfs/FileNotFoundError","data/vfs/MemArchive"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("VirtualFileSystem",class{constructor(e,t){this.rfs=e,this.logger=t,this.allArchives=new Map,this.archivesByPriority=[]}fileExists(e){for(const t of this.archivesByPriority)if(t.containsFile(e))return!0;return!1}openFile(e){for(const t of this.archivesByPriority)if(t.containsFile(e))return t.openFile(e);throw new o.FileNotFoundError(`File "${e}" not found in VFS`)}addArchive(e,t){this.allArchives.has(t)||(this.allArchives.set(t,e),this.archivesByPriority.push(e)),this.logger.info(`Added archive "${t}" to VFS`)}hasArchive(e){return this.allArchives.has(e)}removeArchive(e){var t=this.allArchives.get(e);t&&(this.allArchives.delete(e),this.archivesByPriority.splice(this.archivesByPriority.indexOf(t),1),this.logger.info(`Removed archive "${e}" from VFS`))}listArchives(){return[...this.allArchives.keys()]}async addMixFile(e){await this.addArchiveByFilename(e,(e=>new s.MixFile(e.stream)))}async addBagFile(e){const t=await this.openFileWithRfs(e.replace(".bag",".idx"));await this.addArchiveByFilename(e,(e=>{var s=new r.IdxFile(t.stream);return(new i.AudioBagFile).fromVirtualFile(e,s)}))}async addArchiveByFilename(e,t){var i;this.allArchives.has(e)||(i=await this.openFileWithRfs(e))&&this.addArchive(t(i),e)}async openFileWithRfs(e){let t;try{t=await this.rfs.openFile(e)}catch(e){if(!(e instanceof o.FileNotFoundError))throw e}if(!t){if(!this.fileExists(e))throw new o.FileNotFoundError(`File "${e}" not found`);t=this.openFile(e)}return t}async loadImplicitMixFiles(e){this.logger.info("Initializing implicit mix files..."),e===n.EngineType.YurisRevenge&&await this.addMixFile("langmd.mix"),await this.addMixFile("language.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("ra2md.mix"),await this.addMixFile("ra2.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("cachemd.mix"),await this.addMixFile("cache.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("loadmd.mix"),await this.addMixFile("load.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("localmd.mix"),await this.addMixFile("local.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("ntrlmd.mix"),await this.addMixFile("neutral.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("audiomd.mix"),await this.addMixFile("audio.mix"),await this.addBagFile("audio.bag"),await this.addMixFile("conquer.mix"),e===n.EngineType.YurisRevenge&&(await this.addMixFile("conqmd.mix"),await this.addMixFile("genermd.mix")),await this.addMixFile("generic.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("isogenmd.mix"),await this.addMixFile("isogen.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("cameomd.mix"),await this.addMixFile("cameo.mix"),e===n.EngineType.YurisRevenge&&await this.addMixFile("multimd.mix"),await this.addMixFile("multi.mix")}async loadExtraMixFiles(e){let t=new Set;for await(var i of this.rfs.getEntries())t.add(i.toLowerCase());for(var r of["ecache","expand","elocal"])for(let i=99;0<=i;i--){let s=[""+r+a.pad(i,"00")+".mix"];for(var o of(e===n.EngineType.YurisRevenge&&s.push(`${r}md${a.pad(i,"00")}.mix`),s))t.has(o)&&await this.addMixFile(o)}let l=[".mmx"];e===n.EngineType.YurisRevenge&&l.push(".yro");for(const e of l)for(const i of t)i.endsWith(e)&&this.addArchive(new s.MixFile((await this.rfs.openFile(i)).stream),i)}async loadStandaloneFiles(e){let t=["ini","csf"],i=new Set(e?.exclude),r=[];for await(var s of this.rfs.getEntries()){let e=s.toLowerCase();t.some((t=>e.endsWith("."+t)))&&!i.has(e)&&r.push(await this.rfs.openFile(s,!0))}if(r.length){let e=new l.MemArchive;for(var n of r)e.addFile(n);this.addArchive(e,"mem.archive")}}})}}})),System.register("engine/LazyResourceCollection",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("LazyResourceCollection",class{constructor(e){this.resourceFactory=e,this.resources=new Map}setVfs(e){this.vfs=e}set(e,t){this.resources.set(e,t)}has(e){return!!this.resources.has(e)||(this.vfs?.fileExists(e)??!1)}get(e){let t;return t=this.resources.get(e),!t&&this.vfs?.fileExists(e)&&(t=this.resourceFactory(this.vfs.openFile(e)),this.resources.set(e,t)),t}clear(e){e?this.resources.delete(e):this.resources.clear()}})}}})),System.register("data/WavFile",["wavefile","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("WavFile",class{constructor(e){e instanceof Uint8Array?this.fromRawData(e):e instanceof r.VirtualFile&&this.fromVirtualFile(e)}fromRawData(e){return this.rawData=e,this}fromVirtualFile(e){var t=e.stream;return this.rawData=new Uint8Array(t.buffer,t.byteOffset,t.byteLength),this}getRawData(){return this.rawData}getData(){if(!this.decodedData){if(!this.rawData)throw new Error("No data loaded");this.decodedData=this.decodeData(this.rawData),this.rawData=void 0}return this.decodedData}setData(e){this.rawData=void 0,this.decodedData=e}decodeData(e){let t=new i.WaveFile(e);return"4"===t.bitDepth&&t.fromIMAADPCM(),t.toBuffer()}isRawImaAdpcm(){return this.rawData&&"4"===new i.WaveFile(this.rawData).bitDepth}})}}})),System.register("engine/AsyncResourceCollection",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/LazyAsyncResourceCollection",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("LazyAsyncResourceCollection",class{constructor(e,t=!0){this.resourceFactory=e,this.cache=t,this.resources=new Map}setDir(e){this.rfsDir=e}set(e,t){this.resources.set(e,t)}async has(e){return!!this.resources.has(e)||(await(this.rfsDir?.containsEntry(e))??!1)}async get(e){let t;return t=this.resources.get(e),!t&&await(this.rfsDir?.containsEntry(e))&&(t=await this.resourceFactory(await this.rfsDir.getRawFile(e)),this.cache&&this.resources.set(e,t)),t}clear(){this.resources.clear()}})}}})),System.register("data/Mp3File",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Mp3File",class{constructor(e){this.file=e}asFile(){return new File([this.file],this.file.name,{type:"audio/mp3"})}})}}})),System.register("engine/mixDatabase",[],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[],execute:function(){e("mixDatabase",i=(new Map).set("cameo.mix",["adogicon.shp","adoguico.shp","aengicon.shp","aenguico.shp","agapgen.shp","agisicon.shp","ahrvicon.shp","ahrvuico.shp","aparicon.shp","apchicon.shp","apcicon.shp","artyicon.shp","asaticon.shp","ayaricon.shp","batricon.shp","beagicon.shp","bggyicon.shp","bolticon.shp","brrkicon.shp","carricon.shp","ccomicon.shp","ccomuico.shp","chemicon.shp","chroicon.shp","clckicon.shp","clegicon.shp","cleguico.shp","clonicon.shp","cnsticon.shp","crryicon.shp","csphicon.shp","darken.shp","desoicon.shp","desouico.shp","desticon.shp","detnicon.shp","dlphicon.shp","dlphuico.shp","dogicon.shp","doguico.shp","dredicon.shp","dronicon.shp","e1icon.shp","e1uico.shp","e2icon.shp","e2uico.shp","e4icon.shp","empicon.shp","engnicon.shp","facticon.shp","falcicon.shp","fixicon.shp","flakicon.shp","flkticon.shp","flktuico.shp","forticon.shp","fsdicon.shp","fspicon.shp","fstdicon.shp","fvicon.shp","fvuico.shp","gapicon.shp","gat2icon.shp","gateicon.shp","gbayicon.shp","gcanicon.shp","giicon.shp","giuico.shp","gorep.shp","gtnkicon.shp","gtnkuico.shp","gwepicon.shp","handicon.shp","harvicon.shp","harvuico.shp","heliicon.shp","hindicon.shp","hmecicon.shp","hovricon.shp","htkicon.shp","htkuico.shp","htnkicon.shp","htnkuico.shp","ioncicon.shp","ircricon.shp","ironicon.shp","ivanicon.shp","ivanuico.shp","ivncicon.shp","ivncuico.shp","jjeticon.shp","jjetuico.shp","landicon.shp","lasricon.shp","liteicon.shp","lpsticon.shp","mcvicon.shp","mcvuico.shp","metricon.shp","mltiicon.shp","mmchicon.shp","msslicon.shp","mtnkicon.shp","mtnkuico.shp","mutcicon.shp","nga2icon.shp","ngaticon.shp","nhpdicon.shp","npsiicon.shp","npwricon.shp","nradicon.shp","nrcticon.shp","nreficon.shp","ntchicon.shp","nukeicon.shp","nwalicon.shp","nwepicon.shp","obliicon.shp","obmbicon.shp","orcaicon.shp","otrnicon.shp","paraicon.shp","pillicon.shp","plticon.shp","plugicon.shp","podsicon.shp","powricon.shp","prisicon.shp","proicon.shp","psicicon.shp","psicuico.shp","psisicon.shp","psiticon.shp","psituico.shp","rad1icon.shp","rad2icon.shp","rad3icon.shp","radricon.shp","rboticon.shp","reficon.shp","rfixicon.shp","rtnkicon.shp","rtnkuico.shp","samicon.shp","sapcicon.shp","sapicon.shp","sbagicon.shp","sealicon.shp","sealuico.shp","seekicon.shp","shadicon.shp","shaduico.shp","shkicon.shp","shkuico.shp","smchicon.shp","smcvicon.shp","smcvuico.shp","snipicon.shp","snipuico.shp","soniicon.shp","spoticon.shp","spyicon.shp","spyuico.shp","sqdicon.shp","sreficon.shp","srefuico.shp","stnkicon.shp","subicon.shp","subticon.shp","tanyicon.shp","tanyuico.shp","techicon.shp","tempicon.shp","teslaicon.shp","tickicon.shp","tnkdicon.shp","tnkduico.shp","towricon.shp","trkaicon.shp","trsticon.shp","trstuico.shp","tslaicon.shp","ttnkicon.shp","ttnkuico.shp","turbicon.shp","twr1icon.shp","twr2icon.shp","twr3icon.shp","v3icon.shp","v3uico.shp","wallicon.shp","weapicon.shp","weaticon.shp","weedicon.shp","wethicon.shp","xxicon.shp","yardicon.shp","yuriicon.shp","yuriuico.shp","yurpicon.shp","yurpuico.shp","zepicon.shp","zepuico.shp"]).set("theme.mix",["200meter.wav","blowitup.wav","burn.wav","destroy.wav","eaglehun.wav","fortific.wav","grinder.wav","hm2.wav","indeep.wav","industro.wav","jank.wav","motorize.wav","power.wav","ra2-opt.wav","ra2-sco.wav","tension.wav"])),r=["addon.shp","bkgdlg.shp","bkgdmd.shp","bkgdsm.shp","bttnbkgd.shp","button00.shp","button01.shp","button02.shp","button03.shp","button04.shp","button05.shp","button06.shp","button07.shp","button08.shp","button09.shp","button10.shp","button11.shp","credits.shp","diplobtn.shp","gclock2.shp","key.ini","lendcap.shp","lspacer.shp","optbtn.shp","pbeacon.shp","power.shp","powerp.shp","pwrlvl.shp","radar.shp","radar01.shp","radar02.shp","r-dn.shp","rdrbeacn.shp","rendcap.shp","repair.shp","r-up.shp","sell.shp","side1.shp","side2.shp","side2b.shp","side3.shp","sidebar.pal","sidebttn.shp","tab00.shp","tab01.shp","tab02.shp","tab03.shp","tabs.shp","top.shp","uibkgd.pal","wayp.shp"],i.set("sidec01.mix",r).set("sidec02.mix",r),r=["reportbug.shp"],i.set("sidec01cd.mix",r).set("sidec02cd.mix",r)}}})),System.register("engine/gameRes/GameResSource",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Archive=0]="Archive",t[t.Cdn=1]="Cdn",t[t.Local=2]="Local",e("GameResSource",i)}}})),System.register("game/rules/MpDialogSettings",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MpDialogSettings",class{readIni(e){return this.minMoney=e.getNumber("MinMoney"),this.money=e.getNumber("Money"),this.maxMoney=e.getNumber("MaxMoney"),this.moneyIncrement=e.getNumber("MoneyIncrement"),this.minUnitCount=e.getNumber("MinUnitCount"),this.unitCount=e.getNumber("UnitCount"),this.maxUnitCount=e.getNumber("MaxUnitCount"),this.crates=e.getBool("Crates"),this.gameSpeed=e.getNumber("GameSpeed"),this.mcvRedeploys=e.getBool("MCVRedeploys"),this.shortGame=e.getBool("ShortGame"),this.superWeapons=e.getBool("SuperWeapons"),this.techLevel=e.getNumber("TechLevel"),this.alliesAllowed=e.getBool("AlliesAllowed",!0),this.allyChangeAllowed=e.getBool("AllyChangeAllowed",!0),this.mustAlly=e.getBool("MustAlly"),this}})}}})),System.register("game/ini/GameModeType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Battle=0]="Battle",t[t.ManBattle=1]="ManBattle",t[t.FreeForAll=2]="FreeForAll",t[t.Unholy=3]="Unholy",t[t.Cooperative=4]="Cooperative",e("GameModeType",i)}}})),System.register("game/ini/GameModes",["game/rules/MpDialogSettings","game/ini/GameModeType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("GameModes",class{constructor(e,t){this.modeIniLoader=t,this.entries=new Map,this.loadIni(e)}loadIni(e){e.getOrderedSections().forEach((e=>{let t=r.GameModeType[e.name]??r.GameModeType.Battle;[...e.entries.keys()].forEach((r=>{let s=e.getArray(r);if(s.length<5)throw new Error(`Invalid format for mp mode entry "${r}".`);var n=Number(r),a=s[2].toLowerCase();a={id:n,type:t,label:s[0],description:s[1],rulesOverride:a,mapFilter:s[3],randomMapsAllowed:s[4],aiAllowed:n<3,mpDialogSettings:(new i.MpDialogSettings).readIni(this.modeIniLoader(a).getOrCreateSection("MultiplayerDialogSettings"))};this.entries.set(n,a)}))}))}getById(e){if(!this.entries.has(e))throw new Error("No game mode found with id "+e);return this.entries.get(e)}hasId(e){return this.entries.has(e)}getAll(){return[...this.entries.values()]}})}}})),System.register("data/CsfFile",[],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[],execute:function(){var t;i=new Uint32Array(new Uint8Array(Array.prototype.map.call("STRW",(e=>e.charCodeAt(0))).reverse()).buffer)[0],r=e=>e.map((e=>~e>>>0)),s=e=>{let t="";for(let i=0;i<e.length;i+=2)t+=String.fromCharCode(e[i+1]<<8|e[i]);return t},(t=n=n||{})[t.EnglishUS=0]="EnglishUS",t[t.EnglishUK=1]="EnglishUK",t[t.German=2]="German",t[t.French=3]="French",t[t.Spanish=4]="Spanish",t[t.Italian=5]="Italian",t[t.Japanese=6]="Japanese",t[t.Jabberwockie=7]="Jabberwockie",t[t.Korean=8]="Korean",t[t.Chinese=9]="Chinese",t[t.Unknown=9]="Unknown",e("CsfLanguage",n),e("csfLanguageCodeMap",a=(new Map).set(n.EnglishUS,"en-US").set(n.EnglishUK,"en-GB").set(n.German,"de-DE").set(n.French,"fr-FR").set(n.Spanish,"es-ES").set(n.Italian,"it-IT").set(n.Japanese,"ja-JP").set(n.Korean,"ko-KR").set(n.Chinese,"zh-CN")),e("CsfFile",class{constructor(e){this.language=n.Unknown,this.data={},e&&this.fromVirtualFile(e)}fromVirtualFile(e){let t=e.stream;t.readInt32(),t.readInt32();var n=t.readInt32();t.readInt32(),t.readInt32(),this.language=t.readInt32();for(let e=0;e<n;e++){t.readInt32();var a,o=t.readInt32(),l=t.readString(t.readInt32());0!=(1&o)?(a=t.readInt32()===i,o=r(t.readUint8Array(2*t.readInt32())),o=s(o),a&&t.readString(t.readInt32()),this.data[l]=o):this.data[l]=""}}getIsoLangCode(){return a.get(this.language)}})}}})),System.register("data/Strings",["sprintf-js","data/CsfFile"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Strings",class{constructor(e){this.data={},e instanceof r.CsfFile?this.fromCsf(e):"object"==typeof e&&this.fromJson(e)}fromCsf(e){this.fromJson(e.data)}fromJson(e){for(var t of Object.keys(e))this.setValue(t,this.sanitizeValue(e[t]))}sanitizeValue(e){return e.replace(/%hs/g,"%s")}setValue(e,t){this.data[e.toLowerCase()]=t}has(e){return!!this.data[e.toLowerCase()]}get(e,...t){let r=this.data[e.toLowerCase()];return r?"string"!=typeof r?(console.warn(`Invalid string value for name "${e}"`),e):(t.length&&(r=i.sprintf(r,...t)),r):e.match(/^NOSTR:/i)?e.replace(/^NOSTR:/i,""):(console.warn(`String with name "${e}" not found"`),e)}})}}})),System.register("engine/MapManifest",["data/IniFile"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MapManifest",class{fromIni(e,t){return this.fileName=e.getString("File")||e.name.toLowerCase()+".map",this.uiName=e.getString("Description"),this.maxSlots=e.getNumber("MaxPlayers"),this.official=!0,this.gameModes=t.filter((t=>e.getArray("GameMode").includes(t.mapFilter))),this}getFullMapTitle(e){return this.addTitleSlotsSuffix(e.get(this.uiName),this.maxSlots)}addTitleSlotsSuffix(e,t){return e.match(/(\(|（)\s*\d(-\d)?\s*(\)|）)\s*$/)||(e+=` (2${2<t?"-"+t:""})`),e}fromMapFile(e,t){var r=e.readAsString();let s=e.filename;const n=new i.IniFile(this.extractIniSection("Basic",r)).getSection("Basic");if(!n)throw new Error(`Map "${s}" is missing the [Basic] section`);this.fileName=s,this.uiName="NOSTR:"+(n.getString("Name")||s.replace(/\.[^.]+$/,""));let a=n.getNumber("MaxPlayer");if(!a){const e=(r=this.extractIniSection("Header",r))?new i.IniFile(r).getSection("Header"):void 0;a=e?.getNumber("NumberStartingPoints")||2}this.maxSlots=a,this.official=n.getBool("Official");let o=n.getArray("GameMode",void 0,["standard"]);return this.gameModes=t.filter((e=>o.includes(e.mapFilter))),this}extractIniSection(e,t){var i=t.indexOf(`[${e}]`);if(-1!==i){let e=i+1;for(;e<t.length&&("["!==t[e]||"\n"!==t[e-1]);e++);return t.slice(i,e)}}})}}})),System.register("engine/MapList",["engine/MapManifest"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MapList",class e{constructor(e){this.gameModes=e,this.manifests=[]}addFromIni(e){let t=e.getSection("MultiMaps");if(!t)throw new Error("Invalid map list. Missing [MultiMaps] section.");return this.manifests=this.manifests.concat([...t.entries.values()].map((t=>{var r=e.getSection(t);if(!r)throw new Error(`Invalid map list. Missing [${t}] section.`);return(new i.MapManifest).fromIni(r,this.gameModes.getAll())}))),this.dedupeEntries(),this}add(e){this.manifests.push(e)}addFromMapFile(e){this.add((new i.MapManifest).fromMapFile(e,this.gameModes.getAll()))}getAll(){return this.manifests}getByName(e){return this.manifests.find((t=>t.fileName.toLowerCase()===e.toLowerCase()))}sortByName(){this.manifests.sort(((e,t)=>e.fileName.localeCompare(t.fileName)))}clone(){let t=new e(this.gameModes);return t.manifests=[...this.manifests],t}mergeWith(e){return this.manifests.push(...e.manifests),this.dedupeEntries(),this}dedupeEntries(){this.manifests=[...new Map(this.manifests.map((e=>[e.fileName.toLowerCase(),e]))).values()]}})}}})),System.register("data/hva/Section",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Section",class{getMatrix(e){return this.matrices[e]}})}}})),System.register("data/HvaFile",["data/hva/Section","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("HvaFile",class{constructor(e){e instanceof r.VirtualFile&&this.fromVirtualFile(e)}fromVirtualFile(e){this.filename=e.filename;let t=e.stream;this.sections=[],t.readCString(16);var r=t.readInt32(),s=t.readInt32();for(let e=0;e<s;++e){let e=new i.Section;e.name=t.readCString(16),e.matrices=new Array(r),this.sections.push(e)}for(let e=0;e<r;++e)for(let i=0;i<s;++i)this.sections[i].matrices[e]=this.readMatrix(t)}readMatrix(e){let t=[];for(let i=0;i<3;++i)t.push(e.readFloat32(),e.readFloat32(),e.readFloat32(),e.readFloat32());return t.push(0,0,0,1),(new THREE.Matrix4).fromArray(t).transpose()}})}}})),System.register("engine/Engine",["data/IniFile","data/ShpFile","data/VxlFile","data/TmpFile","data/Palette","engine/Theater","engine/TheaterType","version","data/vfs/VirtualFileSystem","data/vfs/RealFileSystem","engine/LazyResourceCollection","data/WavFile","engine/LazyAsyncResourceCollection","data/Mp3File","engine/mixDatabase","engine/gameRes/GameResSource","data/Crc32","game/ini/GameModes","util/string","engine/MapList","data/HvaFile"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){var t;(t=C=C||{})[t.AutoDetect=0]="AutoDetect",t[t.TiberianSun=1]="TiberianSun",t[t.Firestorm=2]="Firestorm",t[t.RedAlert2=3]="RedAlert2",t[t.YurisRevenge=4]="YurisRevenge",e("EngineType",C),e("Engine",E=class e{static getVersion(){return c.version.split(".").slice(0,2).join(".")}static getModHash(){if(!this.modHash)throw new Error("Rules must be loaded first");return this.modHash}static getActiveMod(){return this.activeMod}static setActiveMod(e){this.activeMod=e}static initGameResSource(e){this.gameResSource=e}static async initRfs(e){let t=this.rfs=new u.RealFileSystem;return t.addRootDirectoryHandle(e),t}static async initVfs(t,i){return this.vfs=new h.VirtualFileSystem(t,i),e.iniFiles.setVfs(this.vfs),e.palettes.setVfs(this.vfs),e.images.setVfs(this.vfs),e.voxels.setVfs(this.vfs),e.voxelAnims.setVfs(this.vfs),e.tileData.setVfs(this.vfs),e.sounds.setVfs(this.vfs),e.themes.setDir(await(this.rfs?.findDirectory(e.rfsSettings.musicDir))),e.taunts.setDir(await(this.rfs?.findDirectory(e.rfsSettings.tauntsDir))),this.vfs}static supportsTheater(e){var t=this.getActiveEngine();return this.theaterSettings.get(t)?.some((t=>t.Type===e))||!1}static getTheaterSettings(e,t){if(!this.theaterSettings.has(e))throw new Error('Unknown engineType "'+e);var i=this.theaterSettings.get(e).find((e=>e.Type===t));if(!i)throw new Error(`Unsupported theater "${l.TheaterType[t]}"`);return i}static async loadTheater(t){if(!e.rules||!e.art)throw new Error("Rules and art should be loaded first");if(void 0===e.gameResSource)throw new Error("No gameResSource is set");var i=e.getActiveEngine();let r;var s,n=e.getTheaterSettings(i,t);if(e.gameResSource!==y.GameResSource.Cdn)for(var a of n.Mixes)await e.vfs.addMixFile(a);return e.theaters.has(t)?r=e.theaters.get(t):(s=e.getTheaterIni(i,t),i=e.getTileData(),r=o.Theater.factory(t,s,n,i,e.palettes),e.theaters.set(t,r)),e.activeTheater=r,r}static unloadTheater(t){if(e.vfs){var i,r=e.getActiveEngine();for(i of e.getTheaterSettings(r,t).Mixes)e.vfs.removeArchive(i)}}static unloadSideMixData(){for(var t of["sidec01.mix","sidec01cd.mix"]){var i,r=f.mixDatabase.get(t);if(!r)return void console.warn(`Mix "${t}" not found in mix database`);for(i of r)("pal"===i.split(".").pop()?e.palettes:e.images).clear(i)}}static getTheaterIni(t,i){var r=e.getTheaterSettings(t,i).TheaterIni;return e.getIni(r)}static loadRules(){var t=this.getFileNameVariant("rules.ini"),i=this.getFileNameVariant("art.ini"),r=this.getFileNameVariant("ai.ini");let s=this.iniFiles.get(t),n=this.iniFiles.get(i);var a=this.iniFiles.get(r);if(!s)throw new Error(`Rules "${t}" not found`);if(!n)throw new Error(`Art "${i}" not found`);if(!a)throw new Error(`AI "${r}" not found`);if(i=this.iniFiles.get(e.customRulesFileName),r=this.iniFiles.get(e.customArtFileName),!i)throw new Error(`Rules "${e.customRulesFileName}" not found`);if(!r)throw new Error(`Art "${e.customArtFileName}" not found`);e.art=n.clone().mergeWith(r),e.rules=s.clone().mergeWith(i),e.ai=a,e.modHash=e.computeModHash()}static computeModHash(){if(!this.vfs)throw new Error("VFS not initialized");let e=[this.customRulesFileName,this.customArtFileName,this.customMpModesFileName,this.getFileNameVariant("rules.ini"),this.getFileNameVariant("art.ini"),this.getFileNameVariant("ai.ini")];var t,i,r,s=this.theaterSettings.get(this.getActiveEngine());if(!s)throw new Error('Unsupported engineType "'+this.getActiveEngine());for(t of s)e.push(this.getFileNameVariant(t.TheaterIni));let n=this.getMpModes();for(i of n.getAll())e.push(i.rulesOverride);let a=new T.Crc32;for(r of e){if(!this.vfs.fileExists(r))throw new Error(`File ${r} not found`);var o=this.vfs.openFile(r).stream;a.append(new Uint8Array(o.buffer,o.byteOffset,o.byteLength))}return a.append(b.binaryStringToUint8Array(this.getVersion())),a.get()}static getRules(){if(!e.rules)throw new Error("Rules must be loaded first");return e.rules}static getArt(){if(!e.art)throw new Error("Art must be loaded first");return e.art}static getAi(){if(!e.ai)throw new Error("AI must be loaded first");return e.ai}static getFileNameVariant(e){var t=this.getActiveEngine();let i;if(t===C.YurisRevenge)i="md";else{if(t!==C.RedAlert2)throw new Error("Unsupported engine type "+C[t]);i=""}return i?e.replace(/\.([^.]+)$/,i+".$1"):e}static getMpModes(){return new v.GameModes(this.getIni(this.customMpModesFileName),(e=>this.getIni(e)))}static getUiIni(){var e=this.getFileNameVariant("ui.ini");return this.getIni(e)}static getIni(e){if(!this.iniFiles.has(e))throw new Error(`INI file ${e} not found.`);return this.iniFiles.get(e)}static async loadMapList(){if(!this.vfs)throw new Error("File system not initialized");var e,t,r,s=this.getMpModes();let n=new S.MapList(s);for(e of(n.addFromIni(this.getIni(this.getFileNameVariant("missions.pkt"))),this.vfs.listArchives())){var a=e.toLowerCase().replace(/\.[^.]+$/,"")+".pkt";this.vfs.fileExists(a)&&n.addFromIni(new i.IniFile(this.vfs.openFile(a)))}let o=new S.MapList(s);if(this.rfs)for await(var l of this.rfs.getEntries()){let s=l.toLowerCase();try{s.endsWith(".pkt")?(t=new i.IniFile(await this.rfs.openFile(l,!0)),n.addFromIni(t)):this.supportedMapTypes.some((e=>s.endsWith("."+e)))&&(r=await this.rfs.openFile(l,!0),o.addFromMapFile(r))}catch(e){console.warn(`Couldn't read file "${l}"`,e)}}return o.sortByName(),n.mergeWith(o),this.mapList=n,n}static getTileData(){return e.tileData}static getImages(){return e.images}static getVoxels(){return e.voxels}static getVoxelAnims(){return e.voxelAnims}static getPalettes(){return e.palettes}static getSounds(){return e.sounds}static getThemes(){return e.themes}static getTaunts(){return e.taunts}static getActiveEngine(){return C.RedAlert2}static getLastTheaterType(){return e.activeTheater?.type}static getCacheDir(){try{return this.getOrCreateDir(this.rfsSettings.cacheDir,!0)}catch(e){return void console.error("Couldn't get cache directory",[e])}}static async getReplayDir(){var t=this.getActiveMod();if(t){let i=await this.getModDir(),r=await(i?.getDirectory(t));return r?.getOrCreateDirectory(e.rfsSettings.replayDir)}return this.getOrCreateDir(this.rfsSettings.replayDir)}static getModDir(){return this.getOrCreateDir(e.rfsSettings.modDir)}static getMapDir(){return this.getOrCreateDir(e.rfsSettings.mapDir)}static async getOrCreateDir(e,t=!1){let i=this.rfs?.getRootDirectory();if(i)return await i.getOrCreateDirectory(e,t)}static getMapList(){return this.mapList}static destroy(){this.activeTheater=void 0,this.activeMod=void 0,this.modHash=void 0,this.mapList=void 0,this.rfs=void 0,this.vfs=void 0,this.art=void 0,this.iniFiles.clear(),this.images.clear(),this.palettes.clear(),this.rules=void 0,this.ai=void 0,this.theaters.clear(),this.tileData.clear(),this.voxels.clear(),this.voxelAnims.clear()}}),E.UI_ANIM_SPEED=2,E.rfsSettings={menuVideoFileName:"ra2ts_l.webm",splashImgFileName:"glsl.png",mapDir:"maps",modDir:"mods",musicDir:"music",tauntsDir:"Taunts",cacheDir:"cache",replayDir:"replays"},E.supportedMapTypes=["mpr","map"],E.images=new d.LazyResourceCollection((e=>new r.ShpFile(e))),E.voxels=new d.LazyResourceCollection((e=>new s.VxlFile(e))),E.voxelAnims=new d.LazyResourceCollection((e=>new w.HvaFile(e))),E.sounds=new d.LazyResourceCollection((e=>new g.WavFile(e))),E.themes=new p.LazyAsyncResourceCollection((e=>new m.Mp3File(e)),!1),E.taunts=new p.LazyAsyncResourceCollection((async e=>new g.WavFile(new Uint8Array(await e.arrayBuffer())))),E.iniFiles=new d.LazyResourceCollection((e=>new i.IniFile(e))),E.tileData=new d.LazyResourceCollection((e=>new n.TmpFile(e))),E.palettes=new d.LazyResourceCollection((e=>new a.Palette(e))),E.theaters=new Map,E.theaterSettings=(new Map).set(C.RedAlert2,[{Type:l.TheaterType.Temperate,TheaterIni:"temperat.ini",Mixes:["isotemp.mix","temperat.mix","tem.mix"],Extension:".tem",NewTheaterChar:"T",IsoPaletteName:"isotem.pal",UnitPaletteName:"unittem.pal",OverlayPaletteName:"temperat.pal",LibPaletteName:"libtem.pal"},{Type:l.TheaterType.Snow,TheaterIni:"snow.ini",Mixes:["isosnow.mix","snow.mix","sno.mix"],Extension:".sno",NewTheaterChar:"A",IsoPaletteName:"isosno.pal",UnitPaletteName:"unitsno.pal",OverlayPaletteName:"snow.pal",LibPaletteName:"libsno.pal"},{Type:l.TheaterType.Urban,TheaterIni:"urban.ini",Mixes:["isourb.mix","urb.mix","urban.mix"],Extension:".urb",NewTheaterChar:"U",IsoPaletteName:"isourb.pal",UnitPaletteName:"uniturb.pal",OverlayPaletteName:"urban.pal",LibPaletteName:"liburb.pal"}]).set(C.YurisRevenge,[{Type:l.TheaterType.Temperate,TheaterIni:"temperatmd.ini",Mixes:["isotemp.mix","isotemmd.mix","temperat.mix","tem.mix"],Extension:".tem",NewTheaterChar:"T",IsoPaletteName:"isotem.pal",UnitPaletteName:"unittem.pal",OverlayPaletteName:"temperat.pal",LibPaletteName:"libtem.pal"},{Type:l.TheaterType.Snow,TheaterIni:"snowmd.ini",Mixes:["isosnomd.mix","snowmd.mix","isosnow.mix","snow.mix","sno.mix"],Extension:".sno",NewTheaterChar:"A",IsoPaletteName:"isosno.pal",UnitPaletteName:"unitsno.pal",OverlayPaletteName:"snow.pal",LibPaletteName:"libsno.pal"},{Type:l.TheaterType.Urban,TheaterIni:"urbanmd.ini",Mixes:["isourbmd.mix","isourb.mix","urb.mix","urban.mix"],Extension:".urb",NewTheaterChar:"U",IsoPaletteName:"isourb.pal",UnitPaletteName:"uniturb.pal",OverlayPaletteName:"urban.pal",LibPaletteName:"liburb.pal"},{Type:l.TheaterType.NewUrban,TheaterIni:"urbannmd.ini",Mixes:["isoubnmd.mix","isoubn.mix","ubn.mix","urbann.mix"],Extension:".ubn",NewTheaterChar:"N",IsoPaletteName:"isoubn.pal",UnitPaletteName:"unitubn.pal",OverlayPaletteName:"urbann.pal",LibPaletteName:"libubn.pal"},{Type:l.TheaterType.Desert,TheaterIni:"desertmd.ini",Mixes:["isodesmd.mix","desert.mix","des.mix","isodes.mix"],Extension:".des",NewTheaterChar:"D",IsoPaletteName:"isodes.pal",UnitPaletteName:"unitdes.pal",OverlayPaletteName:"desert.pal",LibPaletteName:"libdes.pal"},{Type:l.TheaterType.Lunar,TheaterIni:"lunarmd.ini",Mixes:["isolunmd.mix","isolun.mix","lun.mix","lunar.mix"],Extension:".lun",NewTheaterChar:"L",IsoPaletteName:"isolun.pal",UnitPaletteName:"unitlun.pal",OverlayPaletteName:"lunar.pal",LibPaletteName:"liblun.pal"}]),E.customRulesFileName="rulescd.ini",E.customArtFileName="artcd.ini",E.customMpModesFileName="mpmodescd.ini"}}})),System.register("util/geometry",["util/math"],(function(e,t){"use strict";var i;return t&&t.id,e("pointEquals",(function(e,t){return e&&t&&e.x===t.x&&e.y===t.y||!e&&!t})),e("rectIntersect",(function(e,t){return e.x<=t.x+t.width&&t.x<=e.x+e.width&&e.y<=t.y+t.height&&t.y<=e.y+e.height})),e("rectEquals",(function(e,t){return e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height})),e("circleIntersect",(function(e,t){var r=e.center,s=t.center;return i.isBetween((r.x-s.x)*(r.x-s.x)+(r.y-s.y)*(r.y-s.y),(e.radius-t.radius)*(e.radius-t.radius),(e.radius+t.radius)*(e.radius+t.radius))})),e("circleContainsPoint",(function(e,t){var i=e.center;return(i.x-t.x)*(i.x-t.x)+(i.y-t.y)*(i.y-t.y)<=e.radius*e.radius})),e("rectContainsPoint",(function(e,t){return new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width,e.y+e.height)).containsPoint(new THREE.Vector2(t.x,t.y))})),e("rectContainsRect",(function(e,t){let i=new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width,e.y+e.height));var r=new THREE.Box2(new THREE.Vector2(t.x,t.y),new THREE.Vector2(t.x+t.width,t.y+t.height));return i.containsBox(r)})),e("rectClampPoint",(function(e,t){return new THREE.Box2(new THREE.Vector2(e.x,e.y),new THREE.Vector2(e.x+e.width,e.y+e.height)).clampPoint(new THREE.Vector2(t.x,t.y),new THREE.Vector2)})),e("octileDistance",(function(e,t){var i=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return i+r+(Math.SQRT2-2)*Math.min(i,r)})),{setters:[function(e){i=e}],execute:function(){}}})),System.register("gui/component/SplashScreen",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SplashScreen",class{constructor(e,t){this.width=e,this.height=t,this.rendered=!1}render(e){if(!this.rendered){let i=this.el=document.createElement("div");i.style.backgroundColor="black",i.style.color="white",i.style.padding="10px",i.style.boxSizing="border-box",i.style.backgroundRepeat="no-repeat",i.style.backgroundPosition="50% 50%",i.style.textShadow="1px 1px black",this.updateSize();var t=this.loadingEl=document.createElement("div");i.appendChild(t);let r=this.copyrightEl=document.createElement("div");r.style.position="absolute",r.style.bottom="10px",r.style.right="10px",r.style.textAlign="right",i.appendChild(r);let s=this.disclaimerEl=document.createElement("div");s.style.position="absolute",s.style.bottom="10px",s.style.left="10px",i.appendChild(s),e.appendChild(i),this.rendered=!0}}setBackgroundImage(e){this.el.style.backgroundImage=`url(${e})`}setLoadingText(e){this.loadingEl.innerHTML=e}setCopyrightText(e){this.copyrightEl.innerHTML=e.replace(/\n/g,"<br />")}setDisclaimerText(e){this.disclaimerEl.innerHTML=e.replace(/\n/g,"<br />")}setSize(e,t){this.width=e,this.height=t,this.updateSize()}updateSize(){this.el&&(this.el.style.width=this.width+"px",this.el.style.height=this.height+"px")}destroy(){this.rendered&&(this.el.remove(),this.rendered=!1)}})}}})),System.register("util/event",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("EventDispatcher",class{constructor(){this.listeners=new Set}subscribe(e){this.listeners.add(e)}subscribeOnce(e){let t=(i,r)=>{e(i,r),this.unsubscribe(t),t=void 0};this.subscribe(t)}unsubscribe(e){this.listeners.delete(e)}dispatch(e,t){this.listeners.forEach((i=>i(t,e)))}asEvent(){return this}})}}})),System.register("util/time",[],(function(e,t){"use strict";return t&&t.id,e("sleep",(async function(e){return new Promise((t=>{setTimeout((()=>t()),e)}))})),{setters:[],execute:function(){}}})),System.register("network/IrcConnection",["util/event","util/string","util/time"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("IrcConnection",n=class e{constructor(e,t){this.options=e,this.logger=t,this.timeout=5,this._onMessage=new i.EventDispatcher,this._onError=new i.EventDispatcher,this._onClose=new i.EventDispatcher,this.messageBuffer=""}get onMessage(){return this._onMessage.asEvent()}get onError(){return this._onError.asEvent()}get onClose(){return this._onClose.asEvent()}async connect(t){return new Promise(((i,r)=>{this.socket=new WebSocket(t),"binary"===this.options.mode&&(this.socket.binaryType="blob");let s=i=>{this.socket.removeEventListener("error",s),r(new e.ConnectError(`Connection to "${t}" failed`))};this.socket.addEventListener("open",(()=>{this.socket.removeEventListener("error",s),this.handleOpen(),i()})),this.socket.addEventListener("error",s),this.socket.addEventListener("error",(e=>this.handleError(e))),this.socket.addEventListener("close",(e=>this.handleClose(e))),this.socket.addEventListener("message",(e=>{globalThis.Blob&&e.data instanceof Blob?this.parseData(e.data).then((e=>{this.handleMessage(e)})).catch((e=>{console.error("Failed to decode socket message.",e)})):this.handleMessage(e.data)}))}))}handleOpen(){this.logger.info("Connection open to "+this.socket.url)}handleError(e){this.logger.error("Connection error",e),this._onError.dispatch(this,e)}handleClose(e){this.logger.info(`Connection closed (${this.socket.url})`,e),this._onClose.dispatch(this,e)}handleMessage(e){if("string"!=typeof e){if(e[0]===this.options.binaryRplPrefix)return void this._onMessage.dispatch(this,e.slice(1));e=r.uint8ArrayToBinaryString(e)}this.logger.debug("Got message:",e),e=this.messageBuffer+e,this.messageBuffer="";let t=e.split(/\r?\n/);var i=t.pop();i.length&&(this.messageBuffer=i),t.filter((e=>!!e)).forEach((e=>this._onMessage.dispatch(this,e)))}parseData(e){return new Promise(((t,i)=>{let r=new FileReader;r.onload=()=>t(new Uint8Array(r.result)),r.onerror=()=>i(),r.readAsArrayBuffer(e)}))}async sendCommand(e,t){if(t.replyStartCode&&!t.replyEndCode)throw new Error("Invalid argument. Expected a reply end code, but got only a start code.");let i=[];return await this.sendRawCommand(e,((e,s,n)=>{if("string"!=typeof e){if(e[0]===this.options.binaryRplPrefix)return!1;e=r.uint8ArrayToBinaryString(e)}return t.replyRawText?(n(e.split(/\r?\n/).map((e=>({raw:e,time:s})))),!0):e.split(/\r?\n/).filter((e=>!!e)).some((e=>(e=>{if(t.replyMatch)return!!t.replyMatch.exec(e)&&(n([{raw:e,time:s}]),!0);if(!t.replyEndCode&&!t.replyCodes)return n([{raw:e,time:s}]),!0;var r,[,r,...a]=e.split(" "),a={raw:e,code:r=parseInt(r,10),params:a,time:s};if(t.replyEndCode)return t.replyCodes&&-1!==t.replyCodes.indexOf(r)?(n([a]),!0):((r===t.replyStartCode||t.replyBodyCodes&&-1!==t.replyBodyCodes.indexOf(r)||r===t.replyEndCode)&&i.push(a),r===t.replyEndCode&&(n(i),!0));if(void 0===t.replyCodes)throw new Error("List of replyCodes must be specified when not using start/end codes");return-1!==t.replyCodes.indexOf(r)&&(n([a]),!0)})(e)))}),t.timeout)}async sendBinCommand(e,t){const i=this.options.binaryRplPrefix;if(!i)throw new Error("Must configure binary message reply prefix to send binary commands");const r=this.options.binaryReqPrefix;if(!r)throw new Error("Must configure binary message request prefix to send binary commands");if(e[0]!==r)throw new Error("Binary command must start with the magic prefix 0x"+r.toString(16));return await this.sendRawCommand(e,((e,r,s)=>{if("string"==typeof e||e[0]!==i)return!1;var n=e[1];return-1!==t.replyCodes.indexOf(n)&&(s({code:n,data:e.slice(2),time:r}),!0)}),t.timeout)}sendRawCommand(t,i,r){return new Promise(((n,a)=>{let o,l=!1,c=e=>{clearTimeout(o),n(e)},h=e=>{this.socket.removeEventListener("message",g),this.socket.removeEventListener("close",u),clearTimeout(o),o=void 0,a(e)},u=async()=>{for(;l;)await s.sleep(10);d||h(new e.SocketError("Connection was closed prematurely"))},d=!1,g=e=>{if(!d){let t=Date.now();globalThis.Blob&&e.data instanceof Blob?(l=!0,this.parseData(e.data).then((e=>{l=!1,d||i(e,t,c)&&(d=!0,this.socket.removeEventListener("message",g),this.socket.removeEventListener("close",u))})).catch((e=>{l=!1,console.error("Failed to decode socket message.",e)}))):i(e.data,t,c)&&(d=!0,this.socket.removeEventListener("message",g),this.socket.removeEventListener("close",u))}};if(this.socket&&this.socket.readyState===WebSocket.OPEN){o=setTimeout((()=>{var i="string"==typeof t?t:"0x"+t[1].toString(16);h(new e.NoReplyError("Timeout reached for command "+i))}),1e3*(r??this.timeout)),this.socket.addEventListener("message",g),this.socket.addEventListener("close",u);try{this.sendMessage(t)}catch(e){h(e)}}else h(new e.SocketError("Send command failed. Socket is not open."+(this.socket?` (readyState = ${this.socket.readyState})`:"")))}))}sendMessage(t){if(!this.socket||this.socket.readyState!==WebSocket.OPEN)throw new e.SocketError("Socket is not open"+(this.socket?` (readyState = ${this.socket.readyState})`:""));let i;this.logger.debug("Sent message:",t),"string"==typeof t&&(t+="\r\n"),i="binary"===this.options.mode&&"string"==typeof t?r.binaryStringToUint8Array(t):t,this.socket.send(i)}async ping(e){var t=Date.now();return(await this.sendCommand("ping :"+t,{replyMatch:new RegExp("^:[^ ]+ PONG [^ :]+ :"+t,"i"),timeout:e}))[0].time-t}close(){this.socket&&this.socket.close()}isOpen(){return this.socket&&this.socket.readyState===WebSocket.OPEN}}),n.MAX_CHANNELNAME_LEN=30,function(e){class t extends Error{constructor(e){super(e)}}e.NoReplyError=t;class i extends Error{constructor(e){super(e)}}e.SocketError=i;class r extends Error{constructor(e){super(e)}}e.ConnectError=r}(n=n||{}),e("IrcConnection",n)}}})),System.register("network/Apgar",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Apgar",class{static encode(e){let t="";for(let s=0;s<8;s++){var i=e.charCodeAt(s),r=0<s?e.charCodeAt(e.length-s):0;t+="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789./"[63&(0<(1&i)?i<<1&r:i^r)]}return t}})}}})),System.register("network/WolError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;i=class extends Error{constructor(e,t){super(e),this.code=t}},e("WolError",i),(t=(t=i=i||{}).Code||(t.Code={}))[t.OutdatedClient=0]="OutdatedClient",t[t.BadLogin=1]="BadLogin",t[t.BadGamePass=2]="BadGamePass",t[t.GameHasClosed=3]="GameHasClosed",t[t.ChannelFull=4]="ChannelFull",t[t.BannedFromChannel=5]="BannedFromChannel",e("WolError",i)}}})),System.register("util/typeGuard",[],(function(e,t){"use strict";return t&&t.id,e("isNotNullOrUndefined",(function(e){return null!=e})),{setters:[],execute:function(){}}})),System.register("network/gameopt/FileNameEncoder",["util/Base64","util/string"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("FileNameEncoder",class{encode(e){return e.match(/^[a-z0-9-_]+\.[a-z]{3}$/i)?e:i.Base64.encode(r.utf16ToBinaryString(e))}decode(e){return e.match(/\.[a-z]{3}$/i)?e:r.binaryStringToUtf16(i.Base64.decode(e))}})}}})),System.register("network/chat/ChatMessage",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Channel=0]="Channel",t[t.Page=1]="Page",t[t.Whisper=2]="Whisper",e("ChatRecipientType",i)}}})),System.register("network/WolConnection",["util/event","network/IrcConnection","network/Apgar","network/WolError","util/string","util/Base64","util/typeGuard","network/gameopt/FileNameEncoder","network/chat/ChatMessage"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){var t;332,u=353,d=366,321,322,326,323,g=401,p=403,475,478,471,474,(t=m=m||{})[t.NoMap=0]="NoMap",t[t.HasMap=1]="HasMap",t[t.MapTransfer=2]="MapTransfer",e("WolHasMapStatus",m),e("WolConnection",f=class e{constructor(e,t){this.con=e,this.logger=t,this.wolv2Compat=!1,this.wolv2Ascii=!1,this.currentChannels=new Set,this._onChatMessage=new i.EventDispatcher,this._onJoinChannel=new i.EventDispatcher,this._onLeaveChannel=new i.EventDispatcher,this._onGameStart=new i.EventDispatcher,this._onGameOpt=new i.EventDispatcher,this._onGameMode=new i.EventDispatcher,this.handleMessage=e=>{if("string"==typeof e){let t=e.split(" ");"ping"===t[0].toLowerCase()?this.con.sendMessage("PONG"+(t[1]?" "+t[1]:"")):"privmsg"===t[1].toLowerCase()?this.handlePrivMsg(e):"page"===t[1].toLowerCase()||"notice"===t[1].toLowerCase()?this.handlePageOrNotice(e):"join"===t[1].toLowerCase()?this.handleJoin(e):"joingame"===t[1].toLowerCase()?this.handleJoingame(e):"part"===t[1].toLowerCase()?this.handlePart(e):"kick"===t[1].toLowerCase()?this.handleKick(e):"gameopt"===t[1].toLowerCase()?this.handleGameOpt(e):"mode"===t[1].toLowerCase()?this.handleMode(e):"startg"===t[1].toLowerCase()?this.handleStartGame(e):Number.isNaN(Number(t[1]))||this.handlePrivMsgError(e)}},this.handleClose=()=>{this.currentUser=void 0,this.currentGameChannel=void 0,this.currentChannels.clear()}}get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onChatMessage(){return this._onChatMessage}get onJoinChannel(){return this._onJoinChannel}get onLeaveChannel(){return this._onLeaveChannel}get onGameStart(){return this._onGameStart}get onGameOpt(){return this._onGameOpt}get onGameMode(){return this._onGameMode}static factory(e){return new this(new r.IrcConnection({mode:"binary"},e),e)}static escapeChannelName(e){return e.split("").map((e=>{switch(e){case" ":return"_";case"%":return"%%";case"$":return"$$";case"_":return"$_";case"\b":return"$b";case"\n":return"$n";case"\r":return"$r";case":":return"$=";case",":return"$-";default:return e}})).join("")}static unescapeChannelName(e){var t=e.split("");let i="",r=0;for(;r<t.length;){var s,n=t[r++];let e;e="%"===n||"$"===n?"b"===(s=t[r++])?"\b":"n"===s?"\n":"r"===s?"\r":"="===s?":":"-"===s?",":s:"_"===n?" ":n,i+=e}return i}getCurrentUser(){return this.currentUser}getCurrentChannels(){return[...this.currentChannels]}isInChannel(e){return this.currentChannels.has(e)}getServerName(){return this.serverName}getWolV2Ascii(){return this.wolv2Ascii}setWolV2Ascii(e){this.wolv2Ascii=e}async connect(e,t,i){return this.wolv2Compat=t,this.wolv2Ascii=i,this.con.onMessage.subscribe(this.handleMessage),this.con.onClose.subscribeOnce(this.handleClose),await this.con.connect(e)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close()}isOpen(){return this.con.isOpen()}ping(e){return this.con.ping(e)}cvers(e){return this.con.sendMessage("cvers 0 "+e)}async login(e,t){let i=await this.con.sendCommand(["pass supersecret","nick "+e,"apgar "+s.Apgar.encode(t),"user UserName HostName irc.westwood.com :RealName"].join("\r\n"),{replyCodes:[378],replyStartCode:375,replyBodyCodes:[372],replyEndCode:376});if(1!==i.length||378!==i[0].code)return this.currentUser=e,this.serverName=i[0].raw.match(/^:([^\s]+)/)?.[1]||"",i.slice(0,-1).map((e=>e.raw.replace(/^.*:- /,"")));var r=i[0].params?i[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new n.WolError("Login error: "+r,n.WolError.Code.BadLogin)}async joinChannel(t,i){var r="join "+e.escapeChannelName(t)+(void 0!==i?" "+i:"");let s=await this.con.sendCommand(r,{replyStartCode:332,replyBodyCodes:[u],replyEndCode:d});return this.currentChannels.add(t),this.currentGameChannel=void 0,this.lastChannelOpts={name:t,pass:i},this.logger.info(`Joined channel "${t}"`),this.parseNames(s.slice(1,-1)).sort(((e,t)=>Number(t.operator)-Number(e.operator)))}async listUsers(t){let i=await this.con.sendCommand("NAMES "+e.escapeChannelName(t),{replyBodyCodes:[u],replyEndCode:d});return this.parseNames(i.slice(0,-1)).sort(((e,t)=>Number(t.operator)-Number(e.operator)))}async rejoinLastChannel(){this.lastChannelOpts&&await this.joinChannel(this.lastChannelOpts.name,this.lastChannelOpts.pass)}sendChatMessage(e,t){if(!this.currentUser)throw new Error("Must login before sending messages");t.type!==h.ChatRecipientType.Channel&&t.type!==h.ChatRecipientType.Whisper||this.privmsg([t.name],e)}privmsg(t,i){if(!this.currentUser)throw new Error("Must login before sending messages");var r,s,n=t.map((t=>t.startsWith("#")?e.escapeChannelName(t):t)).join(",");let l=i;for(s of(this.wolv2Ascii||(i.startsWith("/")?(r=i.match(/^\/(msg|m|whisper|w) ([^ ]+) (.+)/i))?l=`/w ${r[2]} `+o.Base64.encode(a.utf16ToBinaryString(r[3])):(r=i.match(/^\/r(?:eply)? (.+)/i))&&(l="/reply "+o.Base64.encode(a.utf16ToBinaryString(r[1]))):l=o.Base64.encode(a.utf16ToBinaryString(i))),this.con.sendMessage(`privmsg ${n} :`+l),t)){var c=s.startsWith("#");this._onChatMessage.dispatch(this,{from:this.currentUser,to:{type:c?h.ChatRecipientType.Channel:h.ChatRecipientType.Whisper,name:s},text:i})}}kick(t,i,r){this.con.sendMessage(`kick ${e.escapeChannelName(i)} ${t.join(",")} :`+r)}async listGames(t,i){if(!this.currentUser)throw new Error("Must login before sending messages");return(await this.con.sendCommand(`list ${t} `+t,{replyStartCode:321,replyBodyCodes:[322,326],replyEndCode:323})).slice(1,-1).map((t=>{if(!t.params||t.params.length<9)throw new Error(`Unexpected reply for list command "${t.raw}". Insufficient params.`);let r=e.unescapeChannelName(t.params[1]);var s=t.params[2],n=Number(t.params[4]),l=t.params[5],h=t.params[6],u=t.params[7];let[d,g]=t.params[8]?.split("::")??[];var p=g?.split(",")??[];if(!(n!==i||p.length<=1)){var m=p[0],f=Number(p[1]),y=m[2],T=p[2],v=p[3],b=p[4];n=(new c.FileNameEncoder).decode(p[5]),m=p[6]?a.binaryStringToUtf16(o.Base64.decode(p[6])):"",p=p[7]?a.binaryStringToUtf16(o.Base64.decode(p[7])):void 0;return{hostName:r.match(/^#?([^']+)'s game$/)?.[1],hostPing:this.wolv2Compat?void 0:Number(u),name:r,description:m,modHash:f,modName:p,tournament:Boolean(Number(l)),humanPlayers:Number(s),aiPlayers:Number(T),maxPlayers:Number(y),observers:Number(v),observable:Boolean(Number(b)),mapName:n,passLocked:384===Number(d),resLocked:Boolean(Number(h))}}})).filter(l.isNotNullOrUndefined)}leaveChannel(t){this.currentChannels.has(t)&&this.con.sendMessage("PART "+e.escapeChannelName(t))}leaveAllChannels(){for(var e of this.getCurrentChannels())this.leaveChannel(e)}async createGame(t,i,s,n,a){var o="#"+this.getCurrentUser()+"'s game",l=e.escapeChannelName(o).slice(0,r.IrcConnection.MAX_CHANNELNAME_LEN-1);o=e.unescapeChannelName(l);return await this.con.sendCommand(`joingame ${l} ${t} ${i} ${s} 0 0 ${n?1:0} 0`+(a?" "+a:""),{replyStartCode:332,replyBodyCodes:[u],replyEndCode:d}),this.currentChannels.add(o),this.currentGameChannel=o,this.lastChannelOpts={name:o,pass:a},this.logger.info(`Joined channel "${o}"`),o}async joinGame(t,i){var r=e.escapeChannelName(t);let s=await this.con.sendCommand(`joingame ${r} 1 `+(i||""),{replyCodes:[475,478,471,474],replyStartCode:332,replyBodyCodes:[u],replyEndCode:d});if(1<s.length){this.currentChannels.add(t),this.currentGameChannel=t,this.lastChannelOpts={name:t,pass:i},this.logger.info(`Joined channel "${t}"`);let e=this.parseNames(s.slice(1,-1));if(r=e.find((e=>e.operator))?.name,void 0===r)throw new Error("Unexpected reply for joingame command. Can't find host player name");return r}switch(s[0].code){case 475:throw new n.WolError("Wrong password",n.WolError.Code.BadGamePass);case 478:throw new n.WolError("Game has closed",n.WolError.Code.GameHasClosed);case 471:throw new n.WolError("Channel is full",n.WolError.Code.ChannelFull);case 474:throw new n.WolError("Banned from channel",n.WolError.Code.BannedFromChannel);default:throw new Error("Unknown error")}}startGame(t){if(!this.currentGameChannel)throw new Error("No game channel active");var i=t.join(",");this.con.sendMessage(`startg ${e.escapeChannelName(this.currentGameChannel)} `+i)}parseNames(t){let i=[];return t.forEach((t=>{var r=t.raw.replace(new RegExp("^.*(=|\\*) [^ ]+ :"),"").split(" ").map((e=>e.split(","))).map((([t,,i])=>{var r=t.startsWith(e.CHAN_OP_PREFIX),s=this.wolv2Compat?void 0:Number(i);return{name:r?t.slice(e.CHAN_OP_PREFIX.length):t,operator:r,ping:s}}));i=i.concat(r)})),i}sendPlayerReady(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"A"+(e?1:0))}sendPlayerHasMap(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"K"+e)}sendGameStartRequest(){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"G")}sendGameSlotsInfo(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"L"+e)}sendPingData(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"P"+e)}sendObserverSlot(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,"O"+e)}sendGameOpts(e){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(this.currentGameChannel,e)}sendPlayerOpts(e,t,i,r,s){if(!this.currentGameChannel)throw new Error("No game channel active");return this.gameOpt(e,`R${t},${i},${r},${s},0,0,0`)}sendModeChannelMax(t,i){this.con.sendMessage(`MODE ${e.escapeChannelName(t)} +l `+i)}sendGameTopic(t,i,r,s,n,l,h,u,d){if(!this.currentGameChannel)throw new Error("No game channel active");var g=(new c.FileNameEncoder).encode(l),p=o.Base64.encode(a.utf16ToBinaryString(u.slice(0,e.MAX_ROOM_DESC_LEN-1))),m=void 0!==d?o.Base64.encode(a.utf16ToBinaryString(d.slice(0,e.MAX_ROOM_DESC_LEN-1))):"";this.con.sendMessage(`topic ${e.escapeChannelName(this.currentGameChannel)} :g${t}${i}N39,`+h+`,${r},${s},${n?1:0},`+g+`,${p},`+m)}gameOpt(t,i){if(!this.currentUser)throw new Error("Must login first");if(!this.currentGameChannel)throw new Error("No game channel active");var r=t.startsWith("#")?e.escapeChannelName(t):t;this.con.sendMessage(`gameopt ${r} :`+i),this._onGameOpt.dispatch(this,{user:this.currentUser,opt:i})}handleJoin(t){var i=t.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOIN :([^ ]+) ([^ ]+)/i);if(!i)throw new Error(`Unexpected JOIN message format "${t}"`);let[,r,s,n]=i;i=s.trim().split(","),this._onJoinChannel.dispatch(this,{type:"join",user:{name:r,ping:this.wolv2Compat?void 0:Number(i[1]),operator:this.wolv2Compat?void 0:Boolean(Number(i[2]))},channel:e.unescapeChannelName(n)})}handleJoingame(t){var i=t.match(/^:([A-Za-z0-9-_]+)![^ ]+ JOINGAME ([^:]+):([^ ]+)/i);if(!i)throw new Error(`Unexpected JOINGAME message format "${t}"`);let[,r,s,n]=i;i=s.trim().split(" "),n=e.unescapeChannelName(n),this._onJoinChannel.dispatch(this,{type:"join",user:{name:r,operator:!1,ping:this.wolv2Compat?void 0:Number(i[5])},channel:n})}handleStartGame(e){var t;if(!(t=e.match(/^:[A-Za-z0-9-_]+![^ ]+ STARTG [^:]+:[^:]+:(\d+) (\d+)/i)))throw new Error(`Unexpected STARTG message format "${e}"`);var[,i,t]=t;this._onGameStart.dispatch(this,{gameId:Number(i),timestamp:Number(t)})}handlePrivMsg(t){var i=t.match(/^:([A-Za-z0-9-_]+)\![^ ]+ PRIVMSG ([^ ]+) :(.*)/i);if(!i)throw new Error(`Unexpected PRIVMSG message format "${t}"`);let r,[,s,n,l]=i;!this.wolv2Ascii&&s!==this.getServerName()&&o.Base64.isBase64(l)&&(l=a.binaryStringToUtf16(o.Base64.decode(l))),n.startsWith("#")?r={from:s,to:{type:h.ChatRecipientType.Channel,name:e.unescapeChannelName(n)},text:l}:n===this.currentUser&&(r={from:s,to:{type:h.ChatRecipientType.Whisper,name:n},text:l}),r&&this._onChatMessage.dispatch(this,r)}handlePrivMsgError(e){var t;if(t=e.match(/^:([A-Za-z0-9-_]+) (\d+) ([^ ]+) (?:([^ ]*) )?:(.*)/i)){var[,i,r,s,,t]=t;if([g,p].includes(Number(r))){let e;s===this.currentUser&&(e={from:i,to:{type:h.ChatRecipientType.Page,name:s},text:t}),e&&this._onChatMessage.dispatch(this,e)}}}handlePageOrNotice(e){var t=e.match(/^:([A-Za-z0-9-_]+)(?:![^ ]+)? (?:PAGE|NOTICE) ([^ ]+) :(.*)/i);if(!t)throw new Error(`Unexpected PAGE message format "${e}"`);let[,i,r,s]=t;!this.wolv2Ascii&&i!==this.getServerName()&&o.Base64.isBase64(s)&&(s=a.binaryStringToUtf16(o.Base64.decode(s))),t={text:s,from:i,to:{type:h.ChatRecipientType.Page,name:r}},this._onChatMessage.dispatch(this,t)}handlePart(t){if(!(r=t.match(/^:([A-Za-z0-9-_]+)![^ ]+ PART ([^ ]+)/i)))throw new Error(`Unexpected PART message format "${t}"`);var[,i,r]=r,r=e.unescapeChannelName(r);i===this.currentUser&&(r===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(r),this.logger.info(`Left channel "${r}"`)),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:i},channel:r})}handleKick(t){var i;if(!(i=t.match(/^:([A-Za-z0-9-_]+)![^ ]+ KICK ([^ ]+) ([A-Za-z0-9-_]+)/i)))throw new Error(`Unexpected KICK message format "${t}"`);var[,,r,i]=i,r=e.unescapeChannelName(r);i===this.currentUser&&(r===this.currentGameChannel&&(this.currentGameChannel=void 0),this.currentChannels.delete(r),this.logger.info(`Left channel "${r}"`)),this._onLeaveChannel.dispatch(this,{type:"leave",user:{name:i},channel:r})}handleGameOpt(e){var t;if(!(t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ GAMEOPT ([^ ]+) :(.*)/i)))throw new Error(`Unexpected GAMEOPT message format"${e}"`);var[,i,,t]=t;this._onGameOpt.dispatch(this,{user:i,opt:t})}handleMode(e){var t=e.match(/^:([A-Za-z0-9-_]+)![^ ]+ MODE ([^ ]+) \+l (\d+)/i);t?([,,,t]=t,this._onGameMode.dispatch(this,Number(t))):this.logger.warn("Got unknown MODE line: "+e)}}),f.MAX_ROOM_DESC_LEN=64,f.CHAN_OP_PREFIX="@"}}})),System.register("network/gamestate/PlayerActionPayload",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gameopt/MapNameLegacyEncoder",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MapNameLegacyEncoder",class{encode(e){let t=[],i=0;return e.split("").forEach(((e,r)=>{var s,n=127&(s=e.charCodeAt(0)<<2*r-7*i),a=s>>7&127;(s=s>>14&127)&&i++,t.push(n,a),s&&t.push(s)})),t.push(0,0),2<=e.length&&t.push(0),t=t.map((e=>128^e)),t.map((e=>String.fromCharCode(e))).join("")}decode(e){let t=e.split("").map((e=>e.charCodeAt(0)));for(t=t.map((e=>128^e));0===t[t.length-1];)t.pop();let i=[],r=0,s=0;for(;t.length;){var n=i.length,a=t.shift(),o=t.shift();let e=0,l=!1;(-1!==[1,2,3].indexOf(t[0])||n>r+3)&&(e=t.shift(),r=n,l=!0),n=(e<<14|o<<7|a)>>2*n-7*s,i.push(127&n),l&&s++}return i.map((e=>String.fromCharCode(e))).join("")}})}}})),System.register("network/gameopt/PingInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameopts/GameOpts",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;e("isHumanPlayerInfo",(e=>"name"in e)),(t=i=i||{})[t.Brutal=0]="Brutal",t[t.Medium=1]="Medium",t[t.Easy=2]="Easy",e("AiDifficulty",i)}}})),System.register("network/gameopt/SlotInfo",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Closed=0]="Closed",t[t.Open=1]="Open",t[t.OpenObserver=2]="OpenObserver",t[t.Player=3]="Player",t[t.Ai=4]="Ai",e("SlotType",i)}}})),System.register("network/gameopt/Parser",["data/DataStream","network/gameopt/MapNameLegacyEncoder","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/FileNameEncoder","util/Base64","util/string"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("Parser",class{parseOptions(e){let t={},[i,s,,n]=e.split(":"),c=i.split(",");c.shift(),c.shift(),t.gameSpeed=6-Number(c.shift()),t.credits=Number(c.shift()),t.unitCount=Number(c.shift()),t.shortGame=Boolean(Number(c.shift())),t.superWeapons=Boolean(Number(c.shift())),t.buildOffAlly=Boolean(Number(c.shift())),t.mcvRepacks=Boolean(Number(c.shift())),t.cratesAppear=Boolean(Number(c.shift())),t.gameMode=Number(c.shift()),t.hostTeams=Boolean(Number(c.shift()));var h=c.shift();if(t.mapTitle=o.Base64.isBase64(h)?l.binaryStringToUtf16(o.Base64.decode(h)):(new r.MapNameLegacyEncoder).decode(h),t.maxSlots=Number(c.shift()),t.mapOfficial=Boolean(Number(c.shift())),t.mapSizeBytes=Number(c.shift()),t.mapName=(new a.FileNameEncoder).decode(c.shift()),t.mapDigest=c.shift(),t.humanPlayers=this.parsePlayerOpts(s),t.aiPlayers=[],n){var u=n.slice(0,-1).split(",");if(u.length%5!=0)throw new Error("Couldn't parse gameopt: unexpected ai data length "+u.length);for(let e=0,i=Math.floor(u.length/5);e<i;++e){var d={difficulty:Number(u[5*e]),countryId:Number(u[5*e+1]),colorId:Number(u[5*e+2]),startPos:Number(u[5*e+3]),teamId:Number(u[5*e+4])};t.aiPlayers.push(-1!==d.countryId?d:void 0)}}return t}parsePlayerOpts(e){var t=e.split(",");if(t.length%8!=0)throw new Error("Couldn't parse gameopt: unexpected players data length "+t.length);let i=[];for(let e=0,s=Math.floor(t.length/8);e<s;++e){var r={name:t[8*e],countryId:Number(t[8*e+1]),colorId:Number(t[8*e+2]),startPos:Number(t[8*e+3]),teamId:Number(t[8*e+4])};i.push(r)}return i}parsePingData(e){var t=e.split(",").slice(1);if(t.length%2)throw new Error("Couldn't parse gameopt: unexpected ping data length "+t.length);let i=[];for(let e=0,r=Math.floor(t.length/2);e<r;++e)i.push({playerName:t[2*e],ping:Number(t[2*e+1])});return i}parseSlotData(e){var t;let i=[];for(t of e.slice(1,-1).split(",")){let e={};if("@Closed@"===t)e.type=s.SlotType.Closed;else if("@Open@"===t)e.type=s.SlotType.Open;else if("@OpenObserver@"===t)e.type=s.SlotType.OpenObserver;else if(-1!==["@EasyAI@","@MediumAI@","@HardAI@"].indexOf(t)){let i;if(e.type=s.SlotType.Ai,"@EasyAI@"===t)i=n.AiDifficulty.Easy;else if("@MediumAI@"===t)i=n.AiDifficulty.Medium;else{if("@HardAI@"!==t)throw new Error("Couldn't parse gameopt: unknown slot type "+t);i=n.AiDifficulty.Brutal}e.difficulty=i}else e.type=s.SlotType.Player,e.name=t;i.push(e)}return i}parsePlayerActions(e){let t=new i.DataStream(e);var r=t.readUint8();let s=[];for(let e=0;e<r;++e){var n=t.readUint8(),a=0<(a=t.readUint16())?t.readUint8Array(a):new Uint8Array;s.push({id:n,params:a})}return s}parseAllPlayerActions(e){var t=e.readUint8();let i=new Map;for(let n=0;n<t;++n){var r=e.readUint8(),s=0<(s=e.readUint16())?e.readUint8Array(s):new Uint8Array;s=this.parsePlayerActions(s);i.set(r,s)}return i}parseMapData(e){return l.uint8ArrayToBinaryString(e)}})}}})),System.register("Config",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Config",class{load(e){let t=e.getSection("General");if(!t)throw new Error("Missing [General] section in application config");this.generalData=t,this.viewport={width:t.getNumber("viewport.width"),height:t.getNumber("viewport.height")};let i=e.getSection("Sentry");i&&(this.sentry={dsn:i.getString("dsn"),env:i.getString("env"),defaultIntegrations:i.getBool("defaultIntegrations"),lazyLoad:i.getBool("lazyLoad",!0)})}get defaultLanguage(){return this.generalData.getString("defaultLanguage","en-US")}get serversUrl(){return this.generalData.getString("serversUrl","servers.ini")}get gameresBaseUrl(){return this.generalData.getString("gameresBaseUrl")||void 0}get gameResArchiveUrl(){return this.generalData.getString("gameResArchiveUrl")}get mapsBaseUrl(){return this.generalData.getString("mapsBaseUrl")}get modsBaseUrl(){return this.generalData.getString("modsBaseUrl")}get devMode(){return this.generalData.getBool("dev")}get discordUrl(){var e=this.generalData.getString("discordUrl");if(e.length)return e}get patchNotesUrl(){var e=this.generalData.getString("patchNotesUrl");if(e.length)return e}get ladderRulesUrl(){var e=this.generalData.getString("ladderRulesUrl");if(e.length)return e}get modSdkUrl(){var e=this.generalData.getString("modSdkUrl");if(e.length)return e}get donateUrl(){var e=this.generalData.getString("donateUrl");if(e.length)return e}get breakingNewsUrl(){var e=this.generalData.getString("breakingNewsUrl");if(e.length)return e}get quickMatchEnabled(){return this.generalData.getBool("quickMatchEnabled")}get unrankedQueueEnabled(){return this.generalData.getBool("unrankedQueueEnabled")}get botsEnabled(){return this.generalData.getBool("botsEnabled")}get wolv2Compat(){return this.generalData.getBool("wolv2Compat")}get oldClientsBaseUrl(){var e=this.generalData.getString("oldClientsBaseUrl");if(e.length)return e}get debugGameState(){return this.generalData.getBool("debugGameState")}})}}})),System.register("util/Routing",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Routing",class{constructor(){this.routes={}}addRoute(e,t){this.routes[e]={controller:t}}init(){window.addEventListener("hashchange",(()=>this.router())),this.router()}async router(){let e=location.hash.slice(1)||"/";if(e.match(/^\//)){var[,t,...i]=e.split("/");this.routes["*"]&&await this.routes["*"].controller(i);let r=this.routes["/"+t];r.controller&&await r.controller(i)}}})}}})),System.register("engine/type/ObjectType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Aircraft=1]="Aircraft",t[t.Building=2]="Building",t[t.Infantry=3]="Infantry",t[t.Overlay=4]="Overlay",t[t.Smudge=5]="Smudge",t[t.Terrain=6]="Terrain",t[t.Vehicle=7]="Vehicle",t[t.Animation=8]="Animation",t[t.Projectile=9]="Projectile",t[t.VoxelAnim=10]="VoxelAnim",t[t.Debris=11]="Debris",e("ObjectType",i)}}})),System.register("game/rules/ObjectRules",["engine/type/ObjectType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectRules",r=class{constructor(e,t,i=-1){this.type=e,this.ini=t,this.index=i,this.parse()}static iniSpeedToLeptonsPerTick(e,t){return Math.min(256,256*e/t)}static iniRotToDegsPerTick(e){return e/256*360}parse(){this.alphaImage=this.ini.getString("AlphaImage")||void 0,this.alternateArcticArt=this.ini.getBool("AlternateArcticArt"),this.crushable=this.ini.getBool("Crushable",this.type===i.ObjectType.Infantry),this.crushSound=this.ini.getString("CrushSound")||void 0,this.dontScore=this.ini.getBool("DontScore"),this.insignificant=this.ini.getBool("Insignificant"),this.legalTarget=this.ini.getBool("LegalTarget",!0),this.noShadow=this.ini.getBool("NoShadow"),this.uiName=this.ini.getString("UIName")}get name(){return this.ini.name}get imageName(){let e=this.ini.getString("Image");return e&&"null"!==e||(e=this.name),e}}),r.IMAGE_NONE="none"}}})),System.register("game/math/GameMath",["util/math"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("GameMath",r=class{static reverseSinTableLookup(e,t,i,r){for(;t<=i;){var s=Math.floor((t+i)/2),n=this.SIN_TABLE[s];if(n===e)return s;(r?e<n:n<e)?t=s+1:i=s-1}return Math.abs(e-this.SIN_TABLE[t])<Math.abs(e-this.SIN_TABLE[i])?t:i}static pow(e,t){if(!Number.isFinite(e)||!Number.isFinite(t)||Number.isSafeInteger(e)&&Number.isSafeInteger(t))return e**t;if(!Number.isSafeInteger(t))throw new Error("Exponent must be a safe integer");return Math.floor(e*this.EXP_10_PRECISION)**t/this.EXP_10_PRECISION**t}static sqrt(e){if(0===e)return 0;var t;let i=e/3;for(;t=i,i=(e/i+i)/2,5e-15<Math.abs(t-i););return i}static sin(e){if(!Number.isFinite(e))return NaN;if(!e)return e;var t=e/(2*Math.PI)-Math.floor(e/(2*Math.PI));t=Math.floor(t*this.SIN_TABLE.length);return this.SIN_TABLE[t]}static cos(e){return this.sin(e+Math.PI/2)}static asin(e){if(!i.isBetween(e,-1,1))return NaN;if(!e)return 0;let t;var r=this.SIN_TABLE.length;return t=0<e?2*Math.PI*this.reverseSinTableLookup(e,0,r/4,!1)/r:Math.PI-2*Math.PI*this.reverseSinTableLookup(e,r/2,.75*r,!0)/r,t}static acos(e){return Math.PI/2-this.asin(e)}static atan2(e,t){if(Number.isNaN(t)||Number.isNaN(e))return NaN;let i;return i=Number.isFinite(e)||Number.isFinite(t)?Number.isFinite(t)&&0!==e?Number.isFinite(e)&&0!==t?this.atan2FiniteNonZero(e,t):this.signIncZero(e)*Math.PI*.5:this.signIncZero(e)*(this.signIncZero(t)<0?Math.PI:0):Math.sign(e)*Math.PI*(0<Math.sign(t)?.25:.75),i}static atan2FiniteNonZero(e,t){var i=Math.abs(t),r=Math.abs(e),s=Math.min(i,r)/Math.max(i,r),n=s*s;let a=((-.0464964749*n+.15931422)*n-.327622764)*n*s+s;return i<r&&(a=Math.PI/2-a),t<0&&(a=Math.PI-a),e<0&&(a=-a),a}static signIncZero(e){return e===-1/0||1/e<0?-1:1}}),r.PRECISION=6,r.EXP_10_PRECISION=10**r.PRECISION,r.SIN_TABLE=[0,.004848117819001859,.009696121685978396,.014543897651582654,.01939133177182437,.024238310110748135,.0290847187431114,.03393044375706223,.03877537125681671,.043619387365336,.04846237822700296,.05330423001029823,.05814482891047582,.06298406115223795,.06782181299240934,.0726579707226106,.07749242067193093,.08232504920959989,.08715574274765817,.09198438774362744,.09681087070317909,.10163507818280187,.10645689679246824,.11127621319829964,.11609291412523022,.12090688635966935,.12571801675216268,.13052619222005157,.13533129975013108,.14013322640130627,.14493185930724672,.1497270856790396,.15451879280784048,.15930686806752256,.16409119891732396,.1688716729044928,.17364817766693033,.17842060093583212,.18318883053832663,.18795275440011186,.19271226054808968,.19746723711299752,.20221757233203794,.20696315455150538,.2117038722294107,.21643961393810288,.22117026836688775,.2258957243246448,.23061587074244014,.2353305966761376,.24003979130900588,.2447433439543238,.24944114405798126,.25413308120107847,.25881904510252074,.26349892562161076,.2681726127606373,.272839996667461,.27750096763809573,.28215541611928774,.2868032327110902,.29144430816943495,.2960785334086999,.3007057995042731,.3053259976951131,.30993901938630514,.31454475615161365,.31914309973603083,.323733942058321,.328317175213561,.33289269147567657,.3374603832999741,.3420201433256687,.34657186437840753,.3511154394727888,.3556507618148765,.3601777248047104,.36469622203881186,.3692061473126844,.3737073946233105,.3781998581716425,.3826834323650898,.3871580118200006,.3916234913641391,.3960797660391568,.4005267311030606,.4049642820326736,.4093923145260926,.4138107245051391,.4182194081178064,.42261826174069944,.4270071819814715,.4313860656812534,.4357548099170794,.4401133120043048,.44446146949902104,.4487991802004621,.4531263421534082,.4574428536505808,.4617486132350339,.46604351970253877,.4703274721039625,.4746003697476404,.4788621122017435,.4831125992966384,.48735173112724234,.49157940805537054,.49579553071207916,.49999999999999994,.5041927170956704,.5083735834518556,.5125425007998652,.5166993711518628,.5208440968031697,.5249765803345602,.5290967246145525,.5332044328016912,.5372996083468239,.5413821549953696,.5454519767895825,.549508978070806,.5535530634817223,.5575841379685927,.5616021067834929,.5656068754865385,.5695983499481065,.573576436351046,.5775410411928851,.5814920712880266,.5854294337699405,.5893530360933448,.593262786036382,.5971585917027862,.6010403615240428,.6049080042615417,.6087614290087207,.6126005451932028,.6164252625789254,.62023549126826,.6240311417041269,.6278121246720986,.6315783513024975,.6353297330724851,.6390661818081416,.6427876096865393,.6464939292378065,.6501850533471834,.6538608952570697,.6575213685690636,.6611663872459932,.6647958656139378,.6684097183642425,.6720078605555224,.6755902076156601,.6791566753437932,.6827071799122926,.6862416378687335,.6897599661378576,.6932620820235242,.696747903210655,.7002173477671685,.7036703341459059,.7071067811865475,.710526608117521,.713929734557899,.7173160805192894,.7206855664077146,.7240381130254825,.7273736415730487,.7306920736508674,.7339933312612352,.7372773368101241,.7405440131090046,.7437932833766612,.747025071240996,.7502393007408245,.7534358963276606,.7566147828674927,.7597758856425494,.7629191303530553,.766044443118978,.7691517504817651,.7722409794060692,.7753120572814658,.7783649119241599,.7813994715786823,.7844156649195757,.7874134210530723,.7903926695187593,.7933533402912352,.7962953637817558,.7992186708398696,.8021231927550437,.8050088612582783,.8078756085237111,.8107233671702122,.8135520702629676,.8163616513150519,.8191520442889918,.821923183598318,.8246750041091067,.8274074411415104,.8301204304712788,.8328139083312671,.8354878114129364,.8381420768678404,.8407766423091032,.8433914458128856,.845986425919841,.848561521636559,.8511166724369997,.8536518182639162,.8561668995302665,.8586618571206132,.8611366323925137,.8635911671778986,.8660254037844386,.8684392849969005,.870832754078492,.8732057547721958,.8755582313020908,.8778901283746645,.8802013911801111,.8824919653936212,.8847617971766577,.8870108331782216,.8892390205361062,.8914463068781385,.8936326403234122,.8957979694835052,.8979422434636881,.9000654118641211,.9021674247810376,.9042482328079179,.9063077870366499,.9083460390586793,.9103629409661466,.9123584453530141,.9143325053161794,.9162850744565779,.918216106880274,.9201255571995389,.9220133805339185,.9238795325112867,.9257239692688903,.9275466474543786,.9293475242268224,.9311265572577219,.9328837047320004,.9346189253489884,.9363321783233931,.9380234233862578,.9396926207859083,.9413397312888874,.942964716180876,.9445675372676047,.9461481568757504,.947706537853822,.9492426435730339,.9507564379281666,.9522478853384153,.9537169507482269,.955163599628123,.9565877979755122,.9579895123154889,.9593687097016201,.9607253577167205,.9620594244736131,.9633708786158803,.9646596893185995,.9659258262890683,.9671692597675166,.9683899605278059,.969587899878116,.97076304966162,.9719153822571454,.9730448705798238,.9741514880817275,.9752352087524931,.9762960071199334,.9773338582506355,.9783487377505475,.9793406217655515,.980309486982024,.9812553106273847,.9821780704706308,.98307774482286,.9839543125377807,.984807753012208,.9856380461865492,.9864451725452739,.987229113117374,.987989849476809,.9887273637429388,.9894416385809445,.9901326572022359,.9908004033648453,.9914448613738104,.9920660160815423,.9926638528881819,.993238357741943,.9937895171394426,.9943173181260184,.9948217482960331,.9953027957931658,.9957604493106914,.9961946980917455,.9966055319295779,.996992941167792,.9973569167005722,.9976974499728977,.9980145329807433,.9983081582712682,.9985783189429907,.9988250086459504,.9990482215818578,.99924795250423,.9994241967185149,.9995769500822006,.9997062090049132,.9998119704485015,.9998942319271075,.9999529915072262,.9999882478077495,1,.9999882478077495,.9999529915072262,.9998942319271075,.9998119704485015,.9997062090049132,.9995769500822006,.9994241967185149,.99924795250423,.9990482215818578,.9988250086459504,.9985783189429907,.9983081582712682,.9980145329807433,.9976974499728977,.9973569167005722,.996992941167792,.9966055319295779,.9961946980917455,.9957604493106914,.9953027957931658,.9948217482960331,.9943173181260184,.9937895171394426,.993238357741943,.9926638528881819,.9920660160815423,.9914448613738105,.9908004033648453,.9901326572022359,.9894416385809446,.9887273637429388,.987989849476809,.987229113117374,.9864451725452739,.9856380461865492,.984807753012208,.9839543125377807,.98307774482286,.9821780704706307,.9812553106273847,.9803094869820241,.9793406217655516,.9783487377505476,.9773338582506356,.9762960071199334,.9752352087524931,.9741514880817276,.9730448705798238,.9719153822571455,.9707630496616201,.969587899878116,.9683899605278059,.9671692597675166,.9659258262890683,.9646596893185995,.9633708786158803,.9620594244736133,.9607253577167205,.9593687097016202,.9579895123154889,.9565877979755123,.9551635996281231,.9537169507482269,.9522478853384153,.9507564379281666,.949242643573034,.9477065378538221,.9461481568757505,.9445675372676048,.942964716180876,.9413397312888873,.9396926207859084,.9380234233862579,.9363321783233931,.9346189253489885,.9328837047320006,.9311265572577219,.9293475242268225,.9275466474543786,.9257239692688904,.9238795325112867,.9220133805339185,.920125557199539,.918216106880274,.916285074456578,.9143325053161794,.9123584453530141,.9103629409661467,.9083460390586793,.90630778703665,.904248232807918,.9021674247810377,.9000654118641213,.8979422434636883,.8957979694835051,.8936326403234123,.8914463068781386,.8892390205361062,.8870108331782218,.8847617971766579,.8824919653936212,.8802013911801111,.8778901283746644,.8755582313020909,.8732057547721958,.8708327540784921,.8684392849969006,.8660254037844387,.8635911671778987,.8611366323925138,.858661857120613,.8561668995302665,.8536518182639163,.8511166724369997,.8485615216365591,.8459864259198412,.8433914458128856,.8407766423091031,.8381420768678404,.8354878114129364,.8328139083312672,.8301204304712789,.8274074411415107,.8246750041091069,.8219231835983182,.819152044288992,.8163616513150518,.8135520702629675,.8107233671702123,.8078756085237112,.8050088612582784,.802123192755044,.7992186708398695,.7962953637817556,.7933533402912352,.7903926695187593,.7874134210530723,.7844156649195758,.7813994715786824,.7783649119241601,.775312057281466,.7722409794060693,.769151750481765,.766044443118978,.7629191303530551,.7597758856425494,.756614782867493,.7534358963276608,.7502393007408243,.7470250712409959,.7437932833766611,.7405440131090045,.7372773368101241,.7339933312612353,.7306920736508675,.7273736415730488,.7240381130254827,.7206855664077148,.7173160805192896,.713929734557899,.710526608117521,.7071067811865476,.703670334145906,.7002173477671687,.6967479032106549,.6932620820235241,.6897599661378576,.6862416378687336,.6827071799122926,.6791566753437933,.6755902076156604,.6720078605555225,.6684097183642426,.6647958656139381,.6611663872459935,.6575213685690636,.6538608952570697,.6501850533471835,.6464939292378067,.6427876096865395,.6390661818081418,.635329733072485,.6315783513024975,.6278121246720986,.6240311417041269,.6202354912682602,.6164252625789255,.612600545193203,.6087614290087209,.6049080042615419,.6010403615240432,.5971585917027862,.593262786036382,.5893530360933449,.5854294337699406,.5814920712880268,.5775410411928852,.5735764363510459,.5695983499481064,.5656068754865385,.5616021067834929,.5575841379685929,.5535530634817224,.5495089780708062,.5454519767895827,.5413821549953699,.5372996083468241,.5332044328016912,.5290967246145525,.5249765803345602,.5208440968031698,.516699371151863,.5125425007998654,.5083735834518555,.5041927170956703,.49999999999999994,.49579553071207916,.49157940805537065,.48735173112724245,.48311259929663863,.4788621122017437,.47460036974764064,.47032747210396275,.46604351970253877,.4617486132350339,.45744285365058085,.4531263421534083,.44879918020046233,.4444614694990212,.4401133120043047,.43575480991707927,.43138606568125343,.4270071819814714,.4226182617406995,.4182194081178065,.4138107245051393,.40939231452609276,.4049642820326738,.40052673110306086,.3960797660391572,.39162349136413904,.38715801182000065,.3826834323650899,.37819985817164264,.3737073946233107,.3692061473126843,.36469622203881175,.3601777248047104,.3556507618148765,.35111543947278884,.34657186437840765,.3420201433256689,.3374603832999743,.33289269147567685,.32831717521356135,.3237339420583214,.31914309973603083,.3145447561516137,.30993901938630525,.30532599769511326,.30070579950427334,.29607853340870016,.2914443081694349,.2868032327110902,.28215541611928774,.2775009676380958,.2728399966674611,.26817261276063753,.263498925621611,.258819045102521,.2541330812010788,.24944114405798165,.24474334395432376,.24003979130900596,.2353305966761377,.23061587074244033,.225895724324645,.22117026836688802,.21643961393810274,.21170387222941067,.20696315455150538,.20221757233203796,.19746723711299763,.19271226054808982,.18795275440011205,.18318883053832688,.17842060093583242,.17364817766693072,.16887167290449276,.16409119891732402,.15930686806752267,.15451879280784062,.1497270856790398,.14493185930724697,.14013322640130613,.135331299750131,.13052619222005157,.12571801675216274,.12090688635966945,.11609291412523036,.11127621319829985,.1064568967924685,.10163507818280217,.09681087070317945,.09198438774362741,.0871557427476582,.08232504920959997,.07749242067193107,.07265797072261079,.0678218129924096,.06298406115223781,.05814482891047573,.0533042300102982,.04846237822700297,.04361938736533607,.038775371256816835,.03393044375706242,.029084718743111644,.02423831011074843,.01939133177182472,.014543897651583058,.009696121685978408,.004848117819001927,12246467991473532e-32,-.004848117819001238,-.009696121685978163,-.01454389765158237,-.019391331771824474,-.02423831011074774,-.029084718743111398,-.03393044375706173,-.03877537125681659,-.04361938736533583,-.048462378227003174,-.05330423001029795,-.05814482891047593,-.06298406115223758,-.06782181299240934,-.07265797072261056,-.07749242067193128,-.08232504920959974,-.08715574274765794,-.09198438774362716,-.09681087070317876,-.10163507818280193,-.10645689679246781,-.1112762131982996,-.11609291412523012,-.12090688635966965,-.1257180167521625,-.13052619222005177,-.13533129975013078,-.14013322640130632,-.14493185930724675,-.14972708567904,-.1545187928078404,-.15930686806752198,-.16409119891732377,-.16887167290449254,-.17364817766693047,-.17842060093583176,-.18318883053832663,-.1879527544001114,-.1927122605480896,-.19746723711299738,-.20221757233203816,-.20696315455150513,-.21170387222941087,-.21643961393810252,-.2211702683668878,-.22589572432464475,-.23061587074244053,-.23533059667613745,-.2400397913090053,-.2447433439543235,-.24944114405798098,-.2541330812010786,-.25881904510252035,-.2634989256216107,-.26817261276063686,-.2728399966674609,-.27750096763809556,-.2821554161192879,-.28680323271108993,-.29144430816943506,-.29607853340869994,-.30070579950427306,-.30532599769511304,-.3099390193863046,-.3145447561516135,-.3191430997360306,-.3237339420583211,-.3283171752135607,-.33289269147567657,-.3374603832999737,-.34202014332566866,-.3465718643784074,-.35111543947278906,-.35565076181487626,-.36017772480471055,-.3646962220388115,-.3692061473126845,-.3737073946233105,-.3781998581716428,-.38268343236508967,-.38715801182000004,-.3916234913641388,-.39607976603915657,-.40052673110306064,-.4049642820326732,-.40939231452609254,-.41381072450513867,-.4182194081178062,-.4226182617406993,-.4270071819814716,-.4313860656812532,-.43575480991707943,-.4401133120043045,-.444461469499021,-.4487991802004621,-.4531263421534085,-.4574428536505806,-.46174861323503374,-.46604351970253854,-.47032747210396214,-.4746003697476404,-.47886211220174313,-.4831125992966384,-.4873517311272422,-.4915794080553708,-.49579553071207894,-.5000000000000001,-.50419271709567,-.5083735834518556,-.5125425007998652,-.5166993711518633,-.5208440968031696,-.5249765803345596,-.5290967246145523,-.533204432801691,-.5372996083468239,-.5413821549953693,-.5454519767895825,-.5495089780708056,-.5535530634817222,-.5575841379685926,-.5616021067834931,-.5656068754865384,-.5695983499481065,-.5735764363510458,-.577541041192885,-.5814920712880266,-.5854294337699408,-.5893530360933448,-.5932627860363815,-.597158591702786,-.6010403615240426,-.6049080042615417,-.6087614290087203,-.6126005451932028,-.6164252625789249,-.6202354912682599,-.6240311417041268,-.6278121246720987,-.6315783513024973,-.6353297330724852,-.6390661818081416,-.6427876096865393,-.6464939292378065,-.6501850533471829,-.6538608952570695,-.6575213685690635,-.6611663872459933,-.6647958656139376,-.6684097183642425,-.6720078605555221,-.6755902076156601,-.6791566753437931,-.6827071799122927,-.6862416378687334,-.6897599661378577,-.693262082023524,-.696747903210655,-.7002173477671685,-.7036703341459061,-.7071067811865475,-.7105266081175206,-.7139297345578989,-.7173160805192892,-.7206855664077146,-.7240381130254823,-.7273736415730487,-.7306920736508671,-.7339933312612352,-.737277336810124,-.7405440131090048,-.743793283376661,-.747025071240996,-.7502393007408242,-.7534358963276607,-.7566147828674927,-.7597758856425493,-.7629191303530554,-.7660444431189779,-.7691517504817651,-.7722409794060688,-.7753120572814659,-.7783649119241597,-.7813994715786822,-.7844156649195754,-.7874134210530722,-.7903926695187589,-.7933533402912349,-.7962953637817558,-.79921867083987,-.8021231927550437,-.8050088612582785,-.8078756085237111,-.8107233671702119,-.8135520702629674,-.8163616513150515,-.8191520442889916,-.8219231835983181,-.8246750041091064,-.8274074411415104,-.830120430471279,-.8328139083312671,-.8354878114129365,-.8381420768678401,-.8407766423091032,-.8433914458128855,-.8459864259198411,-.8485615216365587,-.8511166724369996,-.8536518182639165,-.8561668995302664,-.8586618571206132,-.8611366323925135,-.8635911671778986,-.8660254037844385,-.8684392849969005,-.8708327540784918,-.8732057547721956,-.8755582313020905,-.8778901283746643,-.8802013911801112,-.8824919653936215,-.8847617971766578,-.8870108331782218,-.889239020536106,-.8914463068781383,-.8936326403234122,-.8957979694835049,-.897942243463688,-.9000654118641208,-.9021674247810375,-.9042482328079179,-.90630778703665,-.9083460390586792,-.9103629409661468,-.912358445353014,-.9143325053161795,-.9162850744565778,-.918216106880274,-.9201255571995388,-.9220133805339183,-.9238795325112865,-.9257239692688903,-.9275466474543786,-.9293475242268223,-.9311265572577219,-.9328837047320003,-.9346189253489884,-.9363321783233929,-.9380234233862578,-.9396926207859082,-.9413397312888873,-.9429647161808761,-.9445675372676049,-.9461481568757504,-.9477065378538222,-.9492426435730339,-.9507564379281666,-.9522478853384153,-.9537169507482267,-.9551635996281229,-.956587797975512,-.9579895123154888,-.9593687097016201,-.9607253577167205,-.9620594244736131,-.9633708786158804,-.9646596893185994,-.9659258262890683,-.9671692597675166,-.9683899605278059,-.9695878998781159,-.97076304966162,-.9719153822571452,-.9730448705798238,-.9741514880817276,-.975235208752493,-.9762960071199334,-.9773338582506355,-.9783487377505475,-.9793406217655514,-.980309486982024,-.9812553106273846,-.9821780704706307,-.98307774482286,-.9839543125377805,-.984807753012208,-.9856380461865493,-.9864451725452739,-.9872291131173742,-.9879898494768089,-.9887273637429387,-.9894416385809445,-.9901326572022358,-.9908004033648452,-.9914448613738104,-.9920660160815423,-.9926638528881818,-.993238357741943,-.9937895171394426,-.9943173181260184,-.994821748296033,-.9953027957931658,-.9957604493106913,-.9961946980917455,-.9966055319295779,-.996992941167792,-.9973569167005722,-.9976974499728977,-.9980145329807433,-.9983081582712682,-.9985783189429907,-.9988250086459504,-.9990482215818578,-.99924795250423,-.9994241967185149,-.9995769500822006,-.9997062090049132,-.9998119704485015,-.9998942319271076,-.9999529915072262,-.9999882478077495,-1,-.9999882478077495,-.9999529915072262,-.9998942319271076,-.9998119704485015,-.9997062090049132,-.9995769500822006,-.9994241967185149,-.99924795250423,-.9990482215818578,-.9988250086459504,-.9985783189429907,-.9983081582712682,-.9980145329807433,-.9976974499728977,-.9973569167005724,-.996992941167792,-.9966055319295779,-.9961946980917455,-.9957604493106914,-.9953027957931658,-.9948217482960331,-.9943173181260185,-.9937895171394426,-.993238357741943,-.9926638528881819,-.9920660160815424,-.9914448613738105,-.9908004033648453,-.9901326572022358,-.9894416385809446,-.9887273637429387,-.987989849476809,-.9872291131173742,-.986445172545274,-.9856380461865493,-.9848077530122081,-.9839543125377807,-.9830777448228601,-.9821780704706308,-.9812553106273846,-.9803094869820241,-.9793406217655515,-.9783487377505476,-.9773338582506355,-.9762960071199335,-.9752352087524931,-.9741514880817276,-.9730448705798239,-.9719153822571454,-.9707630496616201,-.969587899878116,-.968389960527806,-.9671692597675167,-.9659258262890684,-.9646596893185995,-.9633708786158806,-.9620594244736133,-.9607253577167206,-.9593687097016202,-.9579895123154889,-.9565877979755121,-.955163599628123,-.9537169507482268,-.9522478853384154,-.9507564379281668,-.949242643573034,-.9477065378538223,-.9461481568757506,-.944567537267605,-.9429647161808762,-.9413397312888874,-.9396926207859083,-.9380234233862579,-.936332178323393,-.9346189253489885,-.9328837047320004,-.9311265572577221,-.9293475242268224,-.9275466474543788,-.9257239692688904,-.9238795325112866,-.9220133805339186,-.9201255571995389,-.9182161068802742,-.9162850744565779,-.9143325053161796,-.9123584453530141,-.9103629409661469,-.9083460390586794,-.9063077870366503,-.9042482328079181,-.9021674247810376,-.9000654118641209,-.8979422434636882,-.895797969483505,-.8936326403234123,-.8914463068781384,-.8892390205361063,-.887010833178222,-.8847617971766579,-.8824919653936216,-.8802013911801113,-.8778901283746645,-.8755582313020907,-.8732057547721959,-.870832754078492,-.8684392849969007,-.8660254037844386,-.8635911671778989,-.8611366323925137,-.8586618571206134,-.8561668995302666,-.8536518182639167,-.8511166724369998,-.848561521636559,-.8459864259198413,-.8433914458128857,-.8407766423091034,-.8381420768678404,-.8354878114129367,-.8328139083312672,-.8301204304712791,-.8274074411415107,-.8246750041091067,-.8219231835983183,-.8191520442889918,-.8163616513150517,-.8135520702629676,-.8107233671702121,-.8078756085237113,-.8050088612582788,-.802123192755044,-.7992186708398701,-.796295363781756,-.7933533402912352,-.7903926695187591,-.7874134210530724,-.7844156649195756,-.7813994715786825,-.7783649119241599,-.7753120572814661,-.7722409794060691,-.7691517504817653,-.7660444431189781,-.7629191303530556,-.7597758856425495,-.7566147828674927,-.753435896327661,-.7502393007408246,-.7470250712409963,-.7437932833766612,-.740544013109005,-.7372773368101242,-.7339933312612357,-.7306920736508676,-.7273736415730492,-.7240381130254828,-.7206855664077145,-.7173160805192891,-.7139297345578991,-.7105266081175208,-.7071067811865477,-.7036703341459063,-.7002173477671687,-.6967479032106556,-.6932620820235246,-.6897599661378577,-.6862416378687334,-.6827071799122926,-.679156675343793,-.6755902076156605,-.6720078605555223,-.6684097183642427,-.6647958656139378,-.6611663872459935,-.6575213685690637,-.6538608952570701,-.6501850533471836,-.6464939292378064,-.6427876096865396,-.6390661818081416,-.6353297330724854,-.6315783513024976,-.627812124672099,-.624031141704127,-.6202354912682606,-.6164252625789255,-.6126005451932034,-.6087614290087209,-.6049080042615417,-.6010403615240425,-.5971585917027863,-.5932627860363818,-.589353036093345,-.585429433769941,-.5814920712880269,-.5775410411928856,-.5735764363510465,-.5695983499481065,-.5656068754865391,-.561602106783493,-.5575841379685926,-.5535530634817225,-.5495089780708059,-.5454519767895828,-.5413821549953696,-.5372996083468242,-.5332044328016913,-.5290967246145529,-.5249765803345603,-.5208440968031696,-.5166993711518632,-.5125425007998651,-.5083735834518559,-.5041927170956704,-.5000000000000004,-.49579553071207927,-.49157940805537115,-.48735173112724256,-.48311259929663913,-.4788621122017438,-.47460036974764036,-.4703274721039621,-.4660435197025389,-.46174861323503363,-.45744285365058096,-.4531263421534088,-.44879918020046244,-.4444614694990217,-.4401133120043052,-.43575480991708015,-.4313860656812539,-.42700718198147153,-.4226182617406992,-.4182194081178066,-.413810724505139,-.40939231452609287,-.40496428203267354,-.400526731103061,-.3960797660391569,-.39162349136413954,-.38715801182000076,-.3826834323650904,-.37819985817164276,-.3737073946233104,-.3692061473126848,-.36469622203881186,-.3601777248047109,-.3556507618148766,-.3511154394727894,-.34657186437840776,-.34202014332566943,-.3374603832999744,-.3328926914756765,-.32831717521356063,-.32373394205832107,-.31914309973603056,-.3145447561516138,-.3099390193863049,-.30532599769511337,-.30070579950427384,-.2960785334087003,-.29144430816943584,-.2868032327110907,-.28215541611928785,-.2775009676380955,-.2728399966674612,-.2681726127606372,-.2634989256216111,-.2588190451025207,-.2541330812010789,-.24944114405798135,-.24474334395432432,-.24003979130900607,-.23533059667613823,-.23061587074244044,-.2258957243246447,-.22117026836688813,-.21643961393810288,-.21170387222941123,-.2069631545515055,-.20221757233203852,-.19746723711299774,-.19271226054809037,-.1879527544001122,-.18318883053832655,-.17842060093583256,-.1736481776669304,-.16887167290449245,-.16409119891732413,-.15930686806752234,-.15451879280784075,-.14972708567904036,-.1449318593072471,-.14013322640130713,-.13533129975013158,-.13052619222005168,-.1257180167521624,-.12090688635966958,-.11609291412523004,-.11127621319829996,-.10645689679246818,-.10163507818280229,-.09681087070317913,-.09198438774362797,-.08715574274765832,-.08232504920960054,-.0774924206719312,-.07265797072261047,-.06782181299240972,-.06298406115223794,-.0581448289104763,-.05330423001029832,-.04846237822700354,-.043619387365336194,-.038775371256817404,-.03393044375706254,-.02908471874311221,-.02423831011074855,-.019391331771824397,-.014543897651582293,-.009696121685978531,-.004848117819001606]}}})),System.register("game/math/Vector2",["game/math/GameMath"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.Vector2{length(){return i.GameMath.sqrt(this.x*this.x+this.y*this.y)}angle(){let e=i.GameMath.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e}distanceTo(e){return i.GameMath.sqrt(this.distanceToSquared(e))}rotateAround(e,t){var r=i.GameMath.cos(t),s=i.GameMath.sin(t),n=this.x-e.x,a=this.y-e.y;return this.x=n*r-a*s+e.x,this.y=n*s+a*r+e.y,this}},e("Vector2",r)}}})),System.register("game/math/Cylindrical",["game/math/GameMath"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.Cylindrical{setFromVector3(e){return this.radius=i.GameMath.sqrt(e.x*e.x+e.z*e.z),this.theta=i.GameMath.atan2(e.x,e.z),this.y=e.y,this}},e("Cylindrical",r)}}})),System.register("game/math/Quaternion",["game/math/GameMath"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.Quaternion{setFromEuler(e,t){if(!e||!e.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var r=e.x,s=e.y,n=e.z,a=e.order,o=i.GameMath.cos(r/2),l=i.GameMath.cos(s/2),c=i.GameMath.cos(n/2);r=i.GameMath.sin(r/2),s=i.GameMath.sin(s/2),n=i.GameMath.sin(n/2);return"XYZ"===a?(this._x=r*l*c+o*s*n,this._y=o*s*c-r*l*n,this._z=o*l*n+r*s*c,this._w=o*l*c-r*s*n):"YXZ"===a?(this._x=r*l*c+o*s*n,this._y=o*s*c-r*l*n,this._z=o*l*n-r*s*c,this._w=o*l*c+r*s*n):"ZXY"===a?(this._x=r*l*c-o*s*n,this._y=o*s*c+r*l*n,this._z=o*l*n+r*s*c,this._w=o*l*c-r*s*n):"ZYX"===a?(this._x=r*l*c-o*s*n,this._y=o*s*c+r*l*n,this._z=o*l*n-r*s*c,this._w=o*l*c+r*s*n):"YZX"===a?(this._x=r*l*c+o*s*n,this._y=o*s*c+r*l*n,this._z=o*l*n-r*s*c,this._w=o*l*c-r*s*n):"XZY"===a&&(this._x=r*l*c-o*s*n,this._y=o*s*c-r*l*n,this._z=o*l*n+r*s*c,this._w=o*l*c+r*s*n),!1!==t&&this.onChangeCallback(),this}setFromAxisAngle(e,t){var r=t/2,s=i.GameMath.sin(r);return this._x=e.x*s,this._y=e.y*s,this._z=e.z*s,this._w=i.GameMath.cos(r),this.onChangeCallback(),this}setFromRotationMatrix(e){let t,r=e.elements,s=r[0],n=r[4],a=r[8],o=r[1],l=r[5],c=r[9],h=r[2],u=r[6],d=r[10],g=s+l+d;return 0<g?(t=.5/i.GameMath.sqrt(g+1),this._w=.25/t,this._x=(u-c)*t,this._y=(a-h)*t,this._z=(o-n)*t):l<s&&d<s?(t=2*i.GameMath.sqrt(1+s-l-d),this._w=(u-c)/t,this._x=.25*t,this._y=(n+o)/t,this._z=(a+h)/t):d<l?(t=2*i.GameMath.sqrt(1+l-s-d),this._w=(a-h)/t,this._x=(n+o)/t,this._y=.25*t,this._z=(c+u)/t):(t=2*i.GameMath.sqrt(1+d-s-l),this._w=(o-n)/t,this._x=(a+h)/t,this._y=(c+u)/t,this._z=.25*t),this.onChangeCallback(),this}length(){return i.GameMath.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);var r=this._x,s=this._y,n=this._z,a=this._w;let o=a*e._w+r*e._x+s*e._y+n*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),1<=o)return this._w=a,this._x=r,this._y=s,this._z=n,this;if((h=1-o*o)<=Number.EPSILON){var l=1-t;return this._w=l*a+t*this._w,this._x=l*r+t*this._x,this._y=l*s+t*this._y,this._z=l*n+t*this._z,this.normalize()}var c=i.GameMath.sqrt(h),h=(l=i.GameMath.atan2(c,o),i.GameMath.sin((1-t)*l)/c);c=i.GameMath.sin(t*l)/c;return this._w=a*h+this._w*c,this._x=r*h+this._x*c,this._y=s*h+this._y*c,this._z=n*h+this._z*c,this.onChangeCallback(),this}},e("Quaternion",r)}}})),System.register("game/math/Matrix4",["game/math/GameMath","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends THREE.Matrix4{extractRotation(e){let t=this.elements;var i=e.elements,r=1/n.setFromMatrixColumn(e,0).length(),s=1/n.setFromMatrixColumn(e,1).length(),a=1/n.setFromMatrixColumn(e,2).length();return t[0]=i[0]*r,t[1]=i[1]*r,t[2]=i[2]*r,t[3]=0,t[4]=i[4]*s,t[5]=i[5]*s,t[6]=i[6]*s,t[7]=0,t[8]=i[8]*a,t[9]=i[9]*a,t[10]=i[10]*a,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){e&&e.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");let t=this.elements;var r,s,n,a,o,l,c,h,u,d,g,p,m=e.x,f=e.y,y=e.z,T=i.GameMath.cos(m),v=i.GameMath.sin(m),b=i.GameMath.cos(f);m=i.GameMath.sin(f),f=i.GameMath.cos(y),y=i.GameMath.sin(y);return"XYZ"===e.order?(s=T*f,a=T*y,n=v*f,r=v*y,t[0]=b*f,t[4]=-b*y,t[8]=m,t[1]=a+n*m,t[5]=s-r*m,t[9]=-v*b,t[2]=r-s*m,t[6]=n+a*m,t[10]=T*b):"YXZ"===e.order?(r=b*f,s=b*y,n=m*f,a=m*y,t[0]=r+a*v,t[4]=n*v-s,t[8]=T*m,t[1]=T*y,t[5]=T*f,t[9]=-v,t[2]=s*v-n,t[6]=a+r*v,t[10]=T*b):"ZXY"===e.order?(h=b*f,o=b*y,l=m*f,c=m*y,t[0]=h-c*v,t[4]=-T*y,t[8]=l+o*v,t[1]=o+l*v,t[5]=T*f,t[9]=c-h*v,t[2]=-T*m,t[6]=v,t[10]=T*b):"ZYX"===e.order?(o=T*f,l=T*y,c=v*f,h=v*y,t[0]=b*f,t[4]=c*m-l,t[8]=o*m+h,t[1]=b*y,t[5]=h*m+o,t[9]=l*m-c,t[2]=-m,t[6]=v*b,t[10]=T*b):"YZX"===e.order?(g=T*b,u=T*m,d=v*b,p=v*m,t[0]=b*f,t[4]=p-g*y,t[8]=d*y+u,t[1]=y,t[5]=T*f,t[9]=-v*f,t[2]=-m*f,t[6]=u*y+d,t[10]=g-p*y):"XZY"===e.order&&(u=T*b,d=T*m,g=v*b,p=v*m,t[0]=b*f,t[4]=-y,t[8]=m*f,t[1]=u*y+p,t[5]=T*f,t[9]=d*y-g,t[2]=g*y-d,t[6]=v*f,t[10]=p*y+u),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}lookAt(e,t,i){a.set(0,0,0),o.set(0,0,0),l.set(0,0,0);const r=this.elements;return l.subVectors(e,t),0===l.lengthSq()&&(l.z=1),l.normalize(),a.crossVectors(i,l),0===a.lengthSq()&&(1===Math.abs(i.z)?l.x+=1e-4:l.z+=1e-4,l.normalize(),a.crossVectors(i,l)),a.normalize(),o.crossVectors(l,a),r[0]=a.x,r[4]=o.x,r[8]=l.x,r[1]=a.y,r[5]=o.y,r[9]=l.y,r[2]=a.z,r[6]=o.z,r[10]=l.z,this}getMaxScaleOnAxis(){var e=(r=this.elements)[0]*r[0]+r[1]*r[1]+r[2]*r[2],t=r[4]*r[4]+r[5]*r[5]+r[6]*r[6],r=r[8]*r[8]+r[9]*r[9]+r[10]*r[10];return i.GameMath.sqrt(Math.max(e,t,r))}makeRotationX(e){var t=i.GameMath.cos(e),r=i.GameMath.sin(e);return this.set(1,0,0,0,0,t,-r,0,0,r,t,0,0,0,0,1),this}makeRotationY(e){var t=i.GameMath.cos(e),r=i.GameMath.sin(e);return this.set(t,0,r,0,0,1,0,0,-r,0,t,0,0,0,0,1),this}makeRotationZ(e){var t=i.GameMath.cos(e),r=i.GameMath.sin(e);return this.set(t,-r,0,0,r,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){var r=i.GameMath.cos(t),s=i.GameMath.sin(t),n=1-r,a=e.x,o=e.y,l=e.z,c=n*a,h=n*o;return this.set(c*a+r,c*o-s*l,c*l+s*o,0,c*o+s*l,h*o+r,h*l-s*a,0,c*l-s*o,h*l+s*a,n*l*l+r,0,0,0,0,1),this}decompose(e,t,i){var r=this.elements;let s=n.set(r[0],r[1],r[2]).length();var a=n.set(r[4],r[5],r[6]).length(),o=n.set(r[8],r[9],r[10]).length();this.determinant()<0&&(s=-s),e.x=r[12],e.y=r[13],e.z=r[14],c.copy(this);var l=1/s,h=1/a;r=1/o;return c.elements[0]*=l,c.elements[1]*=l,c.elements[2]*=l,c.elements[4]*=h,c.elements[5]*=h,c.elements[6]*=h,c.elements[8]*=r,c.elements[9]*=r,c.elements[10]*=r,t.setFromRotationMatrix(c),i.x=s,i.y=a,i.z=o,this}},e("Matrix4",s),n=new r.Vector3,a=new r.Vector3,o=new r.Vector3,l=new r.Vector3,c=new s}}})),System.register("game/math/Euler",["util/math","game/math/GameMath","game/math/Quaternion","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends THREE.Euler{constructor(){super(...arguments),this.isEuler=!0}setFromRotationMatrix(e,t,s){var n=(g=e.elements)[0],a=g[4],o=g[8],l=g[1],c=g[5],h=g[9],u=g[2],d=g[6],g=g[10];return"XYZ"===(t=t||this._order)?(this._y=r.GameMath.asin(i.clamp(o,-1,1)),Math.abs(o)<.99999?(this._x=r.GameMath.atan2(-h,g),this._z=r.GameMath.atan2(-a,n)):(this._x=r.GameMath.atan2(d,c),this._z=0)):"YXZ"===t?(this._x=r.GameMath.asin(-i.clamp(h,-1,1)),Math.abs(h)<.99999?(this._y=r.GameMath.atan2(o,g),this._z=r.GameMath.atan2(l,c)):(this._y=r.GameMath.atan2(-u,n),this._z=0)):"ZXY"===t?(this._x=r.GameMath.asin(i.clamp(d,-1,1)),Math.abs(d)<.99999?(this._y=r.GameMath.atan2(-u,g),this._z=r.GameMath.atan2(-a,c)):(this._y=0,this._z=r.GameMath.atan2(l,n))):"ZYX"===t?(this._y=r.GameMath.asin(-i.clamp(u,-1,1)),Math.abs(u)<.99999?(this._x=r.GameMath.atan2(d,g),this._z=r.GameMath.atan2(l,n)):(this._x=0,this._z=r.GameMath.atan2(-a,c))):"YZX"===t?(this._z=r.GameMath.asin(i.clamp(l,-1,1)),Math.abs(l)<.99999?(this._x=r.GameMath.atan2(-h,c),this._y=r.GameMath.atan2(-u,n)):(this._x=0,this._y=r.GameMath.atan2(o,g))):"XZY"===t?(this._z=r.GameMath.asin(-i.clamp(a,-1,1)),Math.abs(a)<.99999?(this._x=r.GameMath.atan2(d,c),this._y=r.GameMath.atan2(o,n)):(this._x=r.GameMath.atan2(-h,g),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==s&&this.onChangeCallback(),this}reorder(e){return o.setFromEuler(this),this.setFromQuaternion(o,e)}toVector3(e){return e?e.set(this._x,this._y,this._z):new n.Vector3(this._x,this._y,this._z)}},e("Euler",a),o=new s.Quaternion}}})),System.register("game/math/Spherical",["util/math","game/math/GameMath"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends THREE.Spherical{setFromVector3(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=r.GameMath.atan2(e.x,e.z),this.phi=r.GameMath.acos(i.clamp(e.y/this.radius,-1,1))),this}},e("Spherical",s)}}})),System.register("game/math/Vector3",["util/math","game/math/GameMath","game/math/Quaternion"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends THREE.Vector3{applyEuler(e){return e&&e.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(a.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(a.setFromAxisAngle(e,t))}length(){return r.GameMath.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}projectOnPlane(e){return o.copy(this).projectOnVector(e),this.sub(o)}reflect(e){return this.sub(o.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){var t=this.dot(e)/r.GameMath.sqrt(this.lengthSq()*e.lengthSq());return r.GameMath.acos(i.clamp(t,-1,1))}distanceTo(e){return r.GameMath.sqrt(this.distanceToSquared(e))}setFromSpherical(e){var t=r.GameMath.sin(e.phi)*e.radius;return this.x=t*r.GameMath.sin(e.theta),this.y=r.GameMath.cos(e.phi)*e.radius,this.z=t*r.GameMath.cos(e.theta),this}setFromCylindrical(e){return this.x=e.radius*r.GameMath.sin(e.theta),this.y=e.y,this.z=e.radius*r.GameMath.cos(e.theta),this}},e("Vector3",n),a=new s.Quaternion,o=new n}}})),System.register("game/Coords",["game/math/GameMath","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("Coords",n=class e{static tileToWorld(t,i){return{x:t*e.LEPTONS_PER_TILE,y:i*e.LEPTONS_PER_TILE}}static vecWorldToGround(e){return new r.Vector2(e.x,e.z)}static vecGroundToWorld(e){return new s.Vector3(e.x,0,e.y)}static tileHeightToWorld(t){return t*(e.LEPTONS_PER_TILE/2)*e.zScale}static worldToTileHeight(t){return t/(e.LEPTONS_PER_TILE/2*e.zScale)}static tile3dToWorld(t,i,r){var n=e.tileToWorld(t,i),a=e.tileHeightToWorld(r);return new s.Vector3(n.x,a,n.y)}static screenDistanceToWorld(t,i){return{x:Math.floor((t+2*i)/2*e.ISO_WORLD_SCALE),y:Math.floor((2*i-t)/2*e.ISO_WORLD_SCALE)}}static getWorldTileSize(){return e.LEPTONS_PER_TILE}}),n.ISO_TILE_SIZE=30,n.LEPTONS_PER_TILE=256,n.ISO_WORLD_SCALE=n.LEPTONS_PER_TILE/n.ISO_TILE_SIZE,n.ISO_CAMERA_ALPHA=Math.PI/6,n.ISO_CAMERA_BETA=Math.PI/4,n.COS_ISO_CAMERA_BETA=i.GameMath.cos(n.ISO_CAMERA_BETA),n.zScale=n.COS_ISO_CAMERA_BETA/i.GameMath.cos(n.ISO_CAMERA_ALPHA)}}})),System.register("game/art/SequenceType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Ready=0]="Ready",t[t.Guard=1]="Guard",t[t.Prone=2]="Prone",t[t.Walk=3]="Walk",t[t.FireUp=4]="FireUp",t[t.Down=5]="Down",t[t.Crawl=6]="Crawl",t[t.Up=7]="Up",t[t.FireProne=8]="FireProne",t[t.Idle1=9]="Idle1",t[t.Idle2=10]="Idle2",t[t.Die1=11]="Die1",t[t.Die2=12]="Die2",t[t.Hover=13]="Hover",t[t.Fly=14]="Fly",t[t.FireFly=15]="FireFly",t[t.Tumble=16]="Tumble",t[t.AirDeathStart=17]="AirDeathStart",t[t.AirDeathFalling=18]="AirDeathFalling",t[t.AirDeathFinish=19]="AirDeathFinish",t[t.Tread=20]="Tread",t[t.Swim=21]="Swim",t[t.WetAttack=22]="WetAttack",t[t.WetIdle1=23]="WetIdle1",t[t.WetIdle2=24]="WetIdle2",t[t.WetDie1=25]="WetDie1",t[t.WetDie2=26]="WetDie2",t[t.Deploy=27]="Deploy",t[t.Deployed=28]="Deployed",t[t.DeployedFire=29]="DeployedFire",t[t.DeployedIdle=30]="DeployedIdle",t[t.Undeploy=31]="Undeploy",t[t.Paradrop=32]="Paradrop",t[t.Cheer=33]="Cheer",t[t.Panic=34]="Panic",e("SequenceType",i)}}})),System.register("game/art/SequenceReader",["game/art/SequenceType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=new Map([["E",5],["S",3],["W",1],["N",7]]),e("SequenceReader",class{readIni(e){let t=new Map;for(var[s,n]of e.entries)void 0!==(s=i.SequenceType[s])&&(n=n.split(","),n={type:s,startFrame:Number(n[0]),frameCount:Number(n[1]),facingMult:Number(n[2]),onlyFacing:n[3]?r.get(n[3]):void 0},t.set(s,n));return t}})}}})),System.register("engine/type/LightingType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Global=1]="Global",t[t.Level=2]="Level",t[t.Ambient=3]="Ambient",t[t.Full=4]="Full",t[t.Default=5]="Default",e("LightingType",i)}}})),System.register("engine/type/TerrainType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Default=0]="Default",t[t.Tunnel=5]="Tunnel",t[t.Railroad=6]="Railroad",t[t.Rock1=7]="Rock1",t[t.Rock2=8]="Rock2",t[t.Water=9]="Water",t[t.Shore=10]="Shore",t[t.Pavement=11]="Pavement",t[t.Dirt=12]="Dirt",t[t.Clear=13]="Clear",t[t.Rough=14]="Rough",t[t.Cliff=15]="Cliff",e("TerrainType",i)}}})),System.register("game/type/LandType",["engine/type/TerrainType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,e("getLandType",(function(e){if(!s.has(e))throw new Error("Unknown terrain type "+e);return s.get(e)})),{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Clear=0]="Clear",t[t.Road=1]="Road",t[t.Rock=2]="Rock",t[t.Beach=3]="Beach",t[t.Rough=4]="Rough",t[t.Railroad=5]="Railroad",t[t.Weeds=6]="Weeds",t[t.Water=7]="Water",t[t.Wall=8]="Wall",t[t.Tiberium=9]="Tiberium",t[t.Cliff=10]="Cliff",e("LandType",r),s=new Map([[i.TerrainType.Default,r.Clear],[i.TerrainType.Clear,r.Clear],[i.TerrainType.Tunnel,r.Cliff],[i.TerrainType.Railroad,r.Railroad],[i.TerrainType.Rock1,r.Rock],[i.TerrainType.Rock2,r.Rock],[i.TerrainType.Water,r.Water],[i.TerrainType.Shore,r.Beach],[i.TerrainType.Pavement,r.Road],[i.TerrainType.Dirt,r.Road],[i.TerrainType.Rough,r.Rough],[i.TerrainType.Cliff,r.Cliff]])}}})),System.register("game/type/ArmorType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Flak=1]="Flak",t[t.Plate=2]="Plate",t[t.Light=3]="Light",t[t.Medium=4]="Medium",t[t.Heavy=5]="Heavy",t[t.Wood=6]="Wood",t[t.Steel=7]="Steel",t[t.Concrete=8]="Concrete",t[t.Special_1=9]="Special_1",t[t.Special_2=10]="Special_2",e("ArmorType",i)}}})),System.register("game/rules/OverlayRules",["game/type/LandType","game/rules/ObjectRules","game/type/ArmorType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends r.ObjectRules{parse(){super.parse(),this.armor=this.ini.getEnum("Armor",s.ArmorType,s.ArmorType.None,!0),this.crate=this.ini.getBool("Crate");var e=this.ini.getBool("IsARock");this.isARock=e,this.isRubble=this.ini.getBool("IsRubble"),this.isVeinholeMonster=this.ini.getBool("IsVeinholeMonster"),this.isVeins=this.ini.getBool("IsVeins"),this.land=this.ini.getEnum("Land",i.LandType,i.LandType.Clear),this.noUseTileLandType=!!this.ini.getString("NoUseTileLandType"),this.strength=this.ini.getNumber("Strength"),this.tiberium=this.ini.getBool("Tiberium");var t=this.ini.getBool("Wall");this.wall=t,this.radarInvisible=this.ini.getBool("RadarInvisible",!t&&!e)}},e("OverlayRules",n)}}})),System.register("game/SideType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.GDI=0]="GDI",t[t.Nod=1]="Nod",t[t.Civilian=2]="Civilian",t[t.Mutant=3]="Mutant",e("SideType",i)}}})),System.register("game/rules/CountryRules",["game/SideType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=(new Map).set("GDI",i.SideType.GDI).set("Nod",i.SideType.Nod).set("Civilian",i.SideType.Civilian).set("Mutant",i.SideType.Mutant),s=new Map([["Americans","STT:PlayerSideAmerica"],["Alliance","STT:PlayerSideKorea"],["French","STT:PlayerSideFrance"],["Germans","STT:PlayerSideGermany"],["British","STT:PlayerSideBritain"],["Africans","STT:PlayerSideLibya"],["Arabs","STT:PlayerSideIraq"],["Confederation","STT:PlayerSideCuba"],["Russians","STT:PlayerSideRussia"]]),e("CountryRules",class{constructor(e){this.id=e}readIni(e){this.name=e.name,this.uiName=e.getString("UIName"),this.uiTooltip=e.get("UITooltip")||s.get(this.name);var t=e.getString("Side");if(!t)throw new Error(`Missing Side for country "${this.name}"`);var i=r.get(t);if(void 0===i)throw new Error(`Unknown side "${t}" for country "${this.name}"`);this.side=i,this.multiplay=e.getBool("Multiplay"),this.multiplayPassive=e.getBool("MultiplayPassive"),this.veteranAircraft=e.getArray("VeteranAircraft"),this.veteranInfantry=e.getArray("VeteranInfantry"),this.veteranUnits=e.getArray("VeteranUnits")}})}}})),System.register("game/rules/WeaponRules",["game/rules/ObjectRules"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WeaponRules",class{constructor(e){this.rules=e,this.parse()}parse(){this.ambientDamage=this.rules.getNumber("AmbientDamage"),this.anim=this.rules.getArray("Anim"),this.areaFire=this.rules.getBool("AreaFire"),this.burst=this.rules.getNumber("Burst",1),this.cellRangefinding=this.rules.getBool("CellRangefinding"),this.damage=this.rules.getNumber("Damage"),this.decloakToFire=this.rules.getBool("DecloakToFire",!0),this.fireOnce=this.rules.getBool("FireOnce"),this.isAlternateColor=this.rules.getBool("IsAlternateColor"),this.isElectricBolt=this.rules.getBool("IsElectricBolt"),this.isHouseColor=this.rules.getBool("IsHouseColor"),this.isLaser=this.rules.getBool("IsLaser"),this.isRadBeam=this.rules.getBool("IsRadBeam"),this.isSonic=this.rules.getBool("IsSonic"),this.laserDuration=this.rules.getNumber("LaserDuration"),this.limboLaunch=this.rules.getBool("LimboLaunch"),this.minimumRange=this.rules.getNumber("MinimumRange"),this.name=this.rules.name,this.neverUse=this.rules.getBool("NeverUse"),this.omniFire=this.rules.getBool("OmniFire"),this.projectile=this.rules.getString("Projectile"),this.radLevel=this.rules.getNumber("RadLevel"),this.range=this.rules.getNumber("Range"),-2===this.range&&(this.range=Number.POSITIVE_INFINITY),this.report=this.rules.getArray("Report"),this.revealOnFire=this.rules.getBool("RevealOnFire",!0),this.rof=this.rules.getNumber("ROF"),this.sabotageCursor=this.rules.getBool("SabotageCursor"),this.spawner=this.rules.getBool("Spawner");var e=this.rules.getNumber("Speed");this.iniSpeed=e,this.speed=i.ObjectRules.iniSpeedToLeptonsPerTick(e,100),this.suicide=this.rules.getBool("Suicide"),this.useSparkParticles=this.rules.getBool("UseSparkParticles"),this.warhead=this.rules.getString("Warhead")}})}}})),System.register("game/rules/AudioVisualRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("AudioVisualRules",class{readIni(e){this.ini=e,this.ambientChangeRate=e.getNumber("AmbientChangeRate"),this.ambientChangeStep=e.getNumber("AmbientChangeStep"),this.behind=e.getString("Behind"),this.bridgeExplosions=e.getArray("BridgeExplosions"),this.chronoBeamColor=e.getNumberArray("ChronoBeamColor"),this.chronoBlast=e.getString("ChronoBlast"),this.chronoBlastDest=e.getString("ChronoBlastDest"),this.chronoPlacement=e.getString("ChronoPlacement"),this.chronoSparkle1=e.getString("ChronoSparkle1"),this.conditionRed=e.getNumber("ConditionRed"),this.conditionYellow=e.getNumber("ConditionYellow"),this.creditTicks=e.getArray("CreditTicks"),this.extraAircraftLight=e.getNumber("ExtraAircraftLight"),this.extraInfantryLight=e.getNumber("ExtraInfantryLight"),this.extraUnitLight=e.getNumber("ExtraUnitLight");let t=e.getString("DamageFireTypes");t=t||"FIRE01,FIRE02,FIRE03",this.fireNames=t.split(/\.|,/).filter((e=>""!==e)),this.flyerHelper=e.getString("FlyerHelper"),this.gravity=e.getNumber("Gravity"),this.idleActionFrequency=60*e.getNumber("IdleActionFrequency"),this.impactLandSound=e.getString("ImpactLandSound")||void 0,this.impactWaterSound=e.getString("ImpactWaterSound")||void 0,this.infantryExplode=e.getString("InfantryExplode"),this.flamingInfantry=e.getString("FlamingInfantry"),this.infantryHeadPop=e.getString("InfantryHeadPop"),this.infantryNuked=e.getString("InfantryNuked"),this.ironCurtainInvokeAnim=e.getString("IronCurtainInvokeAnim"),this.messageDuration=e.getNumber("MessageDuration",10),this.metallicDebris=e.getArray("MetallicDebris"),this.nukeTakeOff=e.getString("NukeTakeOff"),this.deadBodies=e.getArray("DeadBodies"),this.wake=e.getString("Wake"),this.parachute=e.getString("Parachute"),this.moveFlash=e.getString("MoveFlash"),this.warpOut=e.getString("WarpOut"),this.warpAway=e.getString("WarpAway"),this.weaponNullifyAnim=e.getString("WeaponNullifyAnim"),this.weatherConClouds=e.getArray("WeatherConClouds"),this.weatherConBoltExplosion=e.getString("WeatherConBoltExplosion"),this.weatherConBolts=e.getArray("WeatherConBolts")}})}}})),System.register("game/rules/general/RadarRules",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.GenericCombat=0]="GenericCombat",t[t.GenericNonCombat=1]="GenericNonCombat",t[t.DropZone=2]="DropZone",t[t.BaseUnderAttack=3]="BaseUnderAttack",t[t.HarvesterUnderAttack=4]="HarvesterUnderAttack",t[t.EnemyObjectSensed=5]="EnemyObjectSensed",e("RadarEventType",i),e("RadarRules",class{readIni(e){return this.eventSuppressionDistances=e.getNumberArray("RadarEventSuppressionDistances"),this.eventVisibilityDurations=e.getNumberArray("RadarEventVisibilityDurations"),this.eventDurations=e.getNumberArray("RadarEventDurations"),this.flashFrameTime=e.getNumber("FlashFrameTime"),this.combatFlashTime=e.getNumber("RadarCombatFlashTime"),this.eventMinRadius=e.getNumber("RadarEventMinRadius"),this.eventSpeed=e.getNumber("RadarEventSpeed"),this.eventRotationSpeed=e.getNumber("RadarEventRotationSpeed"),this.eventColorSpeed=e.getNumber("RadarEventColorSpeed"),this}getEventSuppresionDistance(e){if(e>this.eventSuppressionDistances.length-1)throw new RangeError("No event suppression distance is defined for type "+i[e]);return this.eventSuppressionDistances[e]}getEventVisibilityDuration(e){if(e>this.eventVisibilityDurations.length-1)throw new RangeError("No event visibility duration is defined for type "+i[e]);return this.eventVisibilityDurations[e]}getEventDuration(e){if(e>this.eventDurations.length-1)throw new RangeError("No event duration is defined for type "+i[e]);return this.eventDurations[e]}})}}})),System.register("game/rules/general/RepairRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RepairRules",class{readIni(e){return this.reloadRate=e.getNumber("ReloadRate"),this.repairPercent=e.getNumber("RepairPercent"),this.repairRate=e.getNumber("RepairRate"),this.repairStep=e.getNumber("RepairStep"),this.uRepairRate=e.getNumber("URepairRate"),this.iRepairRate=e.getNumber("IRepairRate"),this.iRepairStep=e.getNumber("IRepairStep"),this}})}}})),System.register("game/rules/general/VeteranRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("VeteranRules",class{readIni(e){return this.veteranRatio=e.getNumber("VeteranRatio",3),this.veteranCombat=e.getNumber("VeteranCombat",1),this.veteranSpeed=e.getNumber("VeteranSpeed",1),this.veteranSight=Math.max(1,e.getNumber("VeteranSight",1)),this.veteranArmor=e.getNumber("VeteranArmor",1),this.veteranROF=e.getNumber("VeteranROF",1),this.veteranCap=e.getNumber("VeteranCap",2),this.initialVeteran=e.getBool("InitialVeteran"),this}})}}})),System.register("game/rules/general/CrewRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CrewRules",class{readIni(e){return this.alliedCrew=e.getString("AlliedCrew"),this.alliedSurvivorDivisor=e.getNumber("AlliedSurvivorDivisor"),this.crewEscape=e.getNumber("CrewEscape"),this.sovietCrew=e.getString("SovietCrew"),this.sovietSurvivorDivisor=e.getNumber("SovietSurvivorDivisor"),this.survivorRate=e.getNumber("SurvivorRate"),this}})}}})),System.register("game/rules/general/PrismRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("PrismRules",class{readIni(e){return this.type=e.getString("PrismType"),this.supportHeight=e.getNumber("PrismSupportHeight"),this.supportMax=e.getNumber("PrismSupportMax"),this.supportModifier=e.getNumber("PrismSupportModifier",1),this}})}}})),System.register("game/rules/general/ThreatRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ThreatRules",class{readIni(e){return this.myEffectivenessCoefficientDefault=e.getNumber("MyEffectivenessCoefficientDefault"),this.targetEffectivenessCoefficientDefault=e.getNumber("TargetEffectivenessCoefficientDefault"),this.targetSpecialThreatCoefficientDefault=e.getNumber("TargetSpecialThreatCoefficientDefault"),this.targetStrengthCoefficientDefault=e.getNumber("TargetStrengthCoefficientDefault"),this.targetDistanceCoefficientDefault=e.getNumber("TargetDistanceCoefficientDefault"),this}})}}})),System.register("game/rules/general/ParadropRules",["game/SideType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ParadropRules",class{readIni(e){if(this.allyParaDrop=this.readParadropSquad(e.getArray("AllyParaDropInf"),e.getNumberArray("AllyParaDropNum"),"Ally"),this.amerParaDrop=this.readParadropSquad(e.getArray("AmerParaDropInf"),e.getNumberArray("AmerParaDropNum"),"Amer"),this.sovParaDrop=this.readParadropSquad(e.getArray("SovParaDropInf"),e.getNumberArray("SovParaDropNum"),"Sov"),this.paradropPlane=e.getString("ParadropPlane"),!this.paradropPlane)throw new Error("Missing rules [General]->ParadropPlane");return this.paradropRadius=e.getNumber("ParadropRadius"),this}readParadropSquad(e,t,i){if(e.length!==t.length)throw new RangeError(`${i}ParaDropInf/Num size mismatch (${e.length}, ${t.length})`);let r=[];for(let i=0;i<e.length;++i)0<t[i]&&r.push({inf:e[i],num:t[i]});return r}getParadropSquads(e){switch(e){case i.SideType.GDI:return this.allyParaDrop;case i.SideType.Nod:return this.sovParaDrop;default:throw new Error(`Unhandled side type "${e}"`)}}})}}})),System.register("game/rules/general/LightningStormRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("LightningStormRules",class{readIni(e){return this.deferment=e.getNumber("LightningDeferment"),this.damage=e.getNumber("LightningDamage"),this.duration=e.getNumber("LightningStormDuration"),this.warhead=e.getString("LightningWarhead"),this.hitDelay=e.getNumber("LightningHitDelay"),this.scatterDelay=e.getNumber("LightningScatterDelay"),this.cellSpread=e.getNumber("LightningCellSpread"),this.separation=e.getNumber("LightningSeparation"),this}})}}})),System.register("game/rules/general/MissileRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MissileRules",class{})}}})),System.register("game/rules/general/V3RocketRules",["game/rules/general/MissileRules"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.MissileRules{readIni(e){return this.pauseFrames=e.getNumber("V3RocketPauseFrames"),this.tiltFrames=e.getNumber("V3RocketTiltFrames"),this.pitchInitial=e.getNumber("V3RocketPitchInitial"),this.pitchFinal=e.getNumber("V3RocketPitchFinal"),this.turnRate=e.getNumber("V3RocketTurnRate"),this.acceleration=e.getNumber("V3RocketAcceleration"),this.altitude=e.getNumber("V3RocketAltitude"),this.damage=e.getNumber("V3RocketDamage"),this.eliteDamage=e.getNumber("V3RocketEliteDamage"),this.bodyLength=e.getNumber("V3RocketBodyLength"),this.lazyCurve=e.getBool("V3RocketLazyCurve"),this.type=e.getString("V3RocketType"),this}},e("V3RocketRules",r)}}})),System.register("game/rules/general/DMislRules",["game/rules/general/MissileRules"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.MissileRules{readIni(e){return this.pauseFrames=e.getNumber("DMislPauseFrames"),this.tiltFrames=e.getNumber("DMislTiltFrames"),this.pitchInitial=e.getNumber("DMislPitchInitial"),this.pitchFinal=e.getNumber("DMislPitchFinal"),this.turnRate=e.getNumber("DMislTurnRate"),this.acceleration=e.getNumber("DMislAcceleration"),this.altitude=e.getNumber("DMislAltitude"),this.damage=e.getNumber("DMislDamage"),this.eliteDamage=e.getNumber("DMislEliteDamage"),this.bodyLength=e.getNumber("DMislBodyLength"),this.lazyCurve=e.getBool("DMislLazyCurve"),this.type=e.getString("DMislType"),this}},e("DMislRules",r)}}})),System.register("game/rules/general/HoverRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("HoverRules",class{readIni(e){return this.height=e.getNumber("HoverHeight"),this.dampen=e.getNumber("HoverDampen"),this.bob=e.getNumber("HoverBob"),this.boost=e.getNumber("HoverBoost"),this.acceleration=e.getNumber("HoverAcceleration"),this.brake=e.getNumber("HoverBrake"),this}})}}})),System.register("game/rules/GeneralRules",["game/rules/general/RadarRules","game/rules/general/RepairRules","game/rules/general/VeteranRules","game/rules/general/CrewRules","game/rules/general/PrismRules","game/rules/general/ThreatRules","game/rules/general/ParadropRules","game/rules/general/LightningStormRules","game/rules/general/V3RocketRules","game/rules/general/DMislRules","game/rules/general/HoverRules","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){var t;(t=p=p||{})[t.Power=0]="Power",t[t.Factory=1]="Factory",t[t.Barracks=2]="Barracks",t[t.Radar=3]="Radar",t[t.Tech=4]="Tech",t[t.Proc=5]="Proc",e("PrereqCategory",p),m=(new Map).set(p.Power,"PrerequisitePower").set(p.Factory,"PrerequisiteFactory").set(p.Barracks,"PrerequisiteBarracks").set(p.Radar,"PrerequisiteRadar").set(p.Tech,"PrerequisiteTech").set(p.Proc,"PrerequisiteProc"),e("GeneralRules",class{constructor(){this.prereqCategories=new Map}readIni(e){this.aircraftFogReveal=e.getNumber("AircraftFogReveal"),this.alliedDisguise=e.getString("AlliedDisguise"),this.baseUnit=e.getArray("BaseUnit"),this.bridgeVoxelMax=e.getNumber("BridgeVoxelMax"),this.buildSpeed=e.getFixed("BuildSpeed"),this.buildupTime=e.getNumber("BuildupTime"),this.chronoDelay=e.getNumber("ChronoDelay"),this.chronoDistanceFactor=e.getNumber("ChronoDistanceFactor",32),this.chronoHarvTooFarDistance=e.getNumber("ChronoHarvTooFarDistance"),this.chronoMinimumDelay=e.getNumber("ChronoMinimumDelay"),this.chronoRangeMinimum=e.getNumber("ChronoRangeMinimum"),this.chronoTrigger=e.getBool("ChronoTrigger",!0),this.cliffBackImpassability=e.getNumber("CliffBackImpassability",2),this.cloakDelay=e.getNumber("CloakDelay"),this.closeEnough=e.getNumber("CloseEnough"),this.crew=(new n.CrewRules).readIni(e),this.defaultMirageDisguises=e.getArray("DefaultMirageDisguises"),this.dMisl=(new u.DMislRules).readIni(e),this.dropPodWeapon=e.getString("DropPodWeapon"),this.engineer=e.getString("Engineer"),this.flightLevel=e.getNumber("FlightLevel"),this.guardAreaTargetingDelay=e.getNumber("GuardAreaTargetingDelay"),this.harvesterTooFarDistance=e.getNumber("HarvesterTooFarDistance"),this.harvesterUnit=e.getArray("HarvesterUnit"),this.hover=(new d.HoverRules).readIni(e),this.infantryBlinkDisguiseTime=e.getNumber("InfantryBlinkDisguiseTime"),this.lightningStorm=(new c.LightningStormRules).readIni(e),this.lowPowerPenaltyModifier=e.getNumber("LowPowerPenaltyModifier",1),this.minLowPowerProductionSpeed=e.getFixed("MinLowPowerProductionSpeed",.5),this.maxLowPowerProductionSpeed=e.getFixed("MaxLowPowerProductionSpeed",1),this.maximumCheerRate=e.getNumber("MaximumCheerRate"),this.maximumQueuedObjects=e.getNumber("MaximumQueuedObjects"),this.maxWaypointPathLength=e.getNumber("MaxWaypointPathLength"),this.multipleFactory=e.getFixed("MultipleFactory",1),this.normalTargetingDelay=e.getNumber("NormalTargetingDelay"),this.padAircraft=e.getArray("PadAircraft"),this.parachuteMaxFallRate=e.getNumber("ParachuteMaxFallRate"),this.paradrop=(new l.ParadropRules).readIni(e),this.prism=(new a.PrismRules).readIni(e),this.purifierBonus=e.getNumber("PurifierBonus"),this.radar=(new i.RadarRules).readIni(e),this.refundPercent=g.clamp(e.getNumber("RefundPercent"),0,1),this.repair=(new r.RepairRules).readIni(e),this.revealTriggerRadius=Math.min(10,e.getNumber("RevealTriggerRadius")),this.shipSinkingWeight=e.getNumber("ShipSinkingWeight"),this.sovietDisguise=e.getString("SovietDisguise"),this.spyMoneyStealPercent=e.getNumber("SpyMoneyStealPercent"),this.spyPowerBlackout=e.getNumber("SpyPowerBlackout"),this.technician=e.getString("Technician"),this.threat=(new o.ThreatRules).readIni(e),this.treeStrength=e.getNumber("TreeStrength"),this.v3Rocket=(new h.V3RocketRules).readIni(e),this.veteran=(new s.VeteranRules).readIni(e),this.wallBuildSpeedCoefficient=e.getFixed("WallBuildSpeedCoefficient"),this.readPrereqCategories(e)}readPrereqCategories(e){for(var[t,i]of m){if(!e.has(i))throw new Error(`Missing prerequisite category ${i} in [General] section`);this.prereqCategories.set(t,e.getArray(i))}}getMissileRules(e){switch(e){case this.v3Rocket.type:return this.v3Rocket;case this.dMisl.type:return this.dMisl;default:throw new Error(`Unsupported missile type "${e}"`)}}})}}})),System.register("game/type/SpeedType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Foot=0]="Foot",t[t.Track=1]="Track",t[t.Wheel=2]="Wheel",t[t.Hover=3]="Hover",t[t.Float=4]="Float",t[t.FloatBeach=5]="FloatBeach",t[t.Amphibious=6]="Amphibious",t[t.Winged=7]="Winged",e("SpeedType",i)}}})),System.register("game/rules/LandRules",["game/type/SpeedType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("LandRules",class{constructor(){this.speedModifiers=new Map}readIni(e){return this.buildable=e.getBool("Buildable",!1),[...e.entries.keys()].forEach((t=>{void 0!==i.SpeedType[t]&&this.speedModifiers.set(i.SpeedType[t],e.getNumber(t))})),this}getSpeedModifier(e){if(e===i.SpeedType.Foot&&0===this.speedModifiers.get(i.SpeedType.Track))return 0;let t=this.speedModifiers.get(e);return void 0===t&&(t=1),e!==i.SpeedType.Track&&e!==i.SpeedType.Wheel&&0<t&&(t=1),t}})}}})),System.register("game/gameobject/infantry/InfDeathType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Gunfire=1]="Gunfire",t[t.Explode=2]="Explode",t[t.ExplodeAlt=3]="ExplodeAlt",t[t.Fire=4]="Fire",t[t.Electro=5]="Electro",t[t.HeadExplode=6]="HeadExplode",t[t.Nuke=7]="Nuke",e("InfDeathType",i)}}})),System.register("game/rules/WarheadRules",["game/gameobject/infantry/InfDeathType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WarheadRules",class{constructor(e){this.rules=e,this.verses=new Map,this.parse()}get name(){return this.rules.name}parse(){this.animList=this.rules.getArray("AnimList"),this.bombDisarm=this.rules.getBool("BombDisarm"),this.bullets=this.rules.getBool("Bullets"),this.cellSpread=this.rules.getNumber("CellSpread"),this.conventional=this.rules.getBool("Conventional"),this.culling=this.rules.getBool("Culling"),this.electricAssault=this.rules.getBool("ElectricAssault"),this.emEffect=this.rules.getBool("EMEffect"),this.infDeath=this.rules.getEnumNumeric("InfDeath",i.InfDeathType,i.InfDeathType.None),this.ivanBomb=this.rules.getBool("IvanBomb"),this.makesDisguise=this.rules.getBool("MakesDisguise"),this.mindControl=this.rules.getBool("MindControl"),this.nukeMaker=this.rules.getBool("NukeMaker"),this.paralyzes=this.rules.getNumber("Paralyzes"),this.parasite=this.rules.getBool("Parasite"),this.percentAtMax=this.rules.getNumber("PercentAtMax",1),this.proneDamage=this.rules.getNumber("ProneDamage",1),this.psychicDamage=this.rules.getBool("PsychicDamage"),this.radiation=this.rules.getBool("Radiation"),this.rocker=this.rules.getBool("Rocker"),this.sonic=this.rules.getBool("Sonic"),this.temporal=this.rules.getBool("Temporal"),this.rules.getFixedArray("Verses").forEach(((e,t)=>this.verses.set(t,e))),this.wallAbsoluteDestroyer=this.rules.getBool("WallAbsoluteDestroyer"),this.wall=this.rules.getBool("Wall"),this.wood=this.rules.getBool("Wood")}})}}})),System.register("game/rules/ProjectileRules",["game/rules/ObjectRules"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.ObjectRules{parse(){super.parse();var e=this.ini.getNumber("ROT",0);let t=this.ini.getNumber("Acceleration");1!==e||t||(t=Number.POSITIVE_INFINITY),t=t||3,this.acceleration=t,this.arcing=this.ini.getBool("Arcing"),this.courseLockDuration=this.ini.getNumber("CourseLockDuration"),this.detonationAltitude=this.ini.getNumber("DetonationAltitude"),this.firersPalette=this.ini.getBool("FirersPalette"),this.flakScatter=this.ini.getBool("FlakScatter"),this.inaccurate=this.ini.getBool("Inaccurate"),this.inviso=this.ini.getBool("Inviso"),this.isAntiAir=this.ini.getBool("AA"),this.isAntiGround=this.ini.getBool("AG",!0),this.level=this.ini.getBool("Level"),this.rot=i.ObjectRules.iniRotToDegsPerTick(e),this.iniRot=e,this.shadow=this.ini.getBool("Shadow",!0),this.shrapnelWeapon=this.ini.getString("ShrapnelWeapon")||void 0,this.shrapnelCount=this.ini.getNumber("ShrapnelCount"),this.subjectToCliffs=this.ini.getBool("SubjectToCliffs"),this.subjectToElevation=this.ini.getBool("SubjectToElevation"),this.subjectToWalls=this.ini.getBool("SubjectToWalls"),this.vertical=this.ini.getBool("Vertical")}},e("ProjectileRules",r)}}})),System.register("data/mapObjects",["engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MapObject",r=class{constructor(e){this.type=e}isStructure(){return this.type===i.ObjectType.Building}isVehicle(){return this.type===i.ObjectType.Vehicle}isInfantry(){return this.type===i.ObjectType.Infantry}isAircraft(){return this.type===i.ObjectType.Aircraft}isTerrain(){return this.type===i.ObjectType.Terrain}isSmudge(){return this.type===i.ObjectType.Smudge}isOverlay(){return this.type===i.ObjectType.Overlay}isNamed(){return"name"in this}isTechno(){return"health"in this}}),n=class extends r{},s=class extends n{},e("Structure",class extends s{constructor(){super(i.ObjectType.Building)}}),e("Vehicle",class extends s{constructor(){super(i.ObjectType.Vehicle)}}),e("Infantry",class extends s{constructor(){super(i.ObjectType.Infantry)}}),e("Aircraft",s=class extends s{constructor(){super(i.ObjectType.Aircraft)}}),e("Terrain",s=class extends n{constructor(){super(i.ObjectType.Terrain)}}),e("Smudge",n=class extends n{constructor(){super(i.ObjectType.Smudge)}}),e("Overlay",n=class extends r{constructor(){super(i.ObjectType.Overlay)}})}}})),System.register("game/rules/TerrainRules",["game/rules/ObjectRules","engine/TheaterType"],(function(e,t){"use strict";var i,r,s,n;function a(e,t){switch(e){case 0:case 1:return!0;case 2:return 0!=(t&s.Right);case 3:return 0!=(t&s.Left);case 4:return 0!=(t&s.Bottom);default:throw new Error('Invalid subCell "'+e)}}return t&&t.id,e("testOccupationBit",a),{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.All=7]="All",t[t.Right=1]="Right",t[t.Left=2]="Left",t[t.Bottom=4]="Bottom",e("OccupationBits",s),n=class extends i.ObjectRules{parse(){super.parse(),this.animationRate=this.ini.getNumber("AnimationRate"),this.animationProbability=this.ini.getNumber("AnimationProbability"),this.gate=this.ini.getBool("Gate"),this.immune=this.ini.getBool("Immune"),this.isAnimated=this.ini.getBool("IsAnimated"),this.snowOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("SnowOccupationBits",s.All)),this.spawnsTiberium=this.ini.getBool("SpawnsTiberium"),this.strength=this.ini.getNumber("Strength"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.temperateOccupationBits=this.normalizeOccupationBits(this.ini.getNumber("TemperateOccupationBits",s.All))}normalizeOccupationBits(e){return(e+8*Math.abs(Math.floor(e/8)))%8}getOccupationBits(e){return e!==r.TheaterType.Snow?this.temperateOccupationBits:this.snowOccupationBits}getOccupiedSubCells(e){var t,i=this.getOccupationBits(e),r=[0,1,2,3,4];if(i===s.All)return r;let n=[];for(t of r)a(t,i)&&n.push(t);return n}},e("TerrainRules",n)}}})),System.register("game/rules/SmudgeRules",["game/rules/ObjectRules"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.ObjectRules{parse(){super.parse(),this.burn=this.ini.getBool("Burn"),this.crater=this.ini.getBool("Crater"),this.width=this.ini.getNumber("Width",1),this.height=this.ini.getNumber("Height",1)}},e("SmudgeRules",r)}}})),System.register("game/rules/DebrisRules",["util/math","game/rules/ObjectRules"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.ObjectRules{parse(){super.parse(),this.damage=this.ini.getNumber("Damage"),this.damageRadius=this.ini.getNumber("DamageRadius"),this.duration=this.ini.getNumber("Duration"),this.elasticity=i.clamp(this.ini.getNumber("Elasticity",.75),0,1),this.expireAnim=this.ini.getString("ExpireAnim")||void 0,this.minAngularVelocity=this.ini.getNumber("MinAngularVelocity"),this.maxAngularVelocity=this.ini.getNumber("MaxAngularVelocity"),this.maxXYVel=this.ini.getNumber("MaxXYVel"),this.minZVel=this.ini.getNumber("MinZVel"),this.maxZVel=this.ini.getNumber("MaxZVel"),this.shareTurretData=this.ini.getBool("ShareTurretData"),this.shareBodyData=this.ini.getBool("ShareBodyData"),this.shareBarrelData=this.ini.getBool("ShareBarrelData"),this.shareSource=this.ini.get("ShareSource")||void 0,this.trailerAnim=this.ini.getString("TrailerAnim")||void 0,this.trailerSeparation=this.ini.getNumber("TrailerSeperation"),this.warhead=this.ini.getString("Warhead")||void 0}},e("DebrisRules",s)}}})),System.register("game/rules/ObjectRulesFactory",["engine/type/ObjectType","game/rules/ObjectRules","game/rules/TechnoRules","game/rules/OverlayRules","game/rules/TerrainRules","game/rules/SmudgeRules","game/rules/DebrisRules"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("ObjectRulesFactory",class{create(e,t,c){switch(e){case i.ObjectType.Aircraft:case i.ObjectType.Building:case i.ObjectType.Infantry:case i.ObjectType.Vehicle:return new s.TechnoRules(e,t,c);case i.ObjectType.Overlay:return new n.OverlayRules(e,t,c);case i.ObjectType.Terrain:return new a.TerrainRules(e,t,c);case i.ObjectType.Smudge:return new o.SmudgeRules(e,t,c);case i.ObjectType.VoxelAnim:return new l.DebrisRules(e,t,c);default:return new r.ObjectRules(e,t,c)}}})}}})),System.register("game/rules/CombatDamageRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CombatDamageRules",class{readIni(e){this.ballisticScatter=e.getNumber("BallisticScatter"),this.bridgeStrength=e.getNumber("BridgeStrength"),this.c4Delay=e.getNumber("C4Delay"),this.c4Warhead=e.getString("C4Warhead"),this.deathWeapon=e.getString("DeathWeapon"),this.dMislEliteWarhead=e.getString("DMislEliteWarhead"),this.dMislWarhead=e.getString("DMislWarhead"),this.flameDamage=e.getString("FlameDamage"),this.ironCurtainDuration=e.getNumber("IronCurtainDuration"),this.ivanDamage=e.getNumber("IvanDamage"),this.ivanIconFlickerRate=e.getNumber("IvanIconFlickerRate"),this.ivanTimedDelay=e.getNumber("IvanTimedDelay"),this.ivanWarhead=e.getString("IvanWarhead"),this.splashList=e.getArray("SplashList"),this.v3EliteWarhead=e.getString("V3EliteWarhead"),this.v3Warhead=e.getString("V3Warhead")}})}}})),System.register("game/rules/TiberiumRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("TiberiumRules",class{readIni(e){return this.value=e.getNumber("Value"),this}})}}})),System.register("engine/type/TiberiumType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Riparius=0]="Riparius",t[t.Cruentus=1]="Cruentus",t[t.Vinifera=2]="Vinifera",t[t.Aboreus=3]="Aboreus",t[t.Ore=0]="Ore",t[t.Gems=1]="Gems",e("TiberiumType",i)}}})),System.register("game/rules/AiRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("AiRules",class{readIni(e){this.buildPower=e.getArray("BuildPower"),this.buildRefinery=e.getArray("BuildRefinery"),this.buildTech=e.getArray("BuildTech"),this.tiberiumFarScan=e.getNumber("TiberiumFarScan",50),this.tiberiumNearScan=e.getNumber("TiberiumNearScan",5)}})}}})),System.register("game/rules/ElevationModelRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ElevationModelRules",class{readIni(e){return this.increment=e.getNumber("ElevationIncrement"),this.incrementBonus=e.getNumber("ElevationIncrementBonus",1),this.bonusCap=e.getNumber("ElevationBonusCap"),this}getBonus(e,t){return e<=t?0:Math.min(this.bonusCap,Math.floor((e-t)/this.increment))*this.incrementBonus}})}}})),System.register("game/rules/RadiationRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RadiationRules",class{readIni(e){this.radDurationMultiple=e.getNumber("RadDurationMultiple"),this.radApplicationDelay=e.getNumber("RadApplicationDelay"),this.radLevelMax=e.getNumber("RadLevelMax"),this.radLevelDelay=e.getNumber("RadLevelDelay"),this.radLightDelay=e.getNumber("RadLightDelay"),this.radLevelFactor=e.getNumber("RadLevelFactor"),this.radLightFactor=e.getNumber("RadLightFactor"),this.radTintFactor=e.getNumber("RadTintFactor"),this.radColor=e.getNumberArray("RadColor"),this.radSiteWarhead=e.getString("RadSiteWarhead")}})}}})),System.register("game/type/SuperWeaponType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.MultiMissile=0]="MultiMissile",t[t.IronCurtain=1]="IronCurtain",t[t.LightningStorm=2]="LightningStorm",t[t.ChronoSphere=3]="ChronoSphere",t[t.ChronoWarp=4]="ChronoWarp",t[t.ParaDrop=5]="ParaDrop",t[t.AmerParaDrop=6]="AmerParaDrop",e("SuperWeaponType",i)}}})),System.register("game/rules/SuperWeaponRules",["game/type/SuperWeaponType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SuperWeaponRules",class{constructor(e){this.index=e}readIni(e){return this.disableableFromShell=e.getBool("DisableableFromShell"),this.isPowered=e.getBool("IsPowered",!0),this.name=e.name,this.preClick=e.getBool("PreClick"),this.preDependent=e.getEnum("PreDependent",i.SuperWeaponType,void 0),this.postClick=e.getBool("PostClick"),this.rechargeTime=e.getNumber("RechargeTime",5),this.showTimer=e.getBool("ShowTimer"),this.sidebarImage=e.getString("SidebarImage").toLowerCase(),this.type=e.getEnum("Type",i.SuperWeaponType,void 0),this.uiName=e.getString("UIName"),this.weaponType=e.getString("WeaponType")||void 0,this}})}}})),System.register("game/rules/CrateRules",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CrateRules",class{readIni(e){this.crateMaximum=e.getNumber("CrateMaximum"),this.crateMinimum=e.getNumber("CrateMinimum"),this.crateRadius=e.getNumber("CrateRadius"),this.crateRegen=e.getNumber("CrateRegen");let t=e.getString("UnitCrateType");return this.unitCrateType="none"!==t.toLowerCase()?t:void 0,this.healCrateSound=e.getString("HealCrateSound"),this.crateImg=e.getString("CrateImg"),this.waterCrateImg=e.getString("WaterCrateImg"),this.freeMCV=e.getBool("FreeMCV"),this}})}}})),System.register("game/order/OrderType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Move=0]="Move",t[t.ForceMove=1]="ForceMove",t[t.Attack=2]="Attack",t[t.ForceAttack=3]="ForceAttack",t[t.AttackMove=4]="AttackMove",t[t.Guard=5]="Guard",t[t.GuardArea=6]="GuardArea",t[t.Capture=7]="Capture",t[t.Occupy=8]="Occupy",t[t.Deploy=9]="Deploy",t[t.DeploySelected=10]="DeploySelected",t[t.Stop=11]="Stop",t[t.Cheer=12]="Cheer",t[t.Dock=13]="Dock",t[t.Gather=14]="Gather",t[t.Repair=15]="Repair",t[t.Scatter=16]="Scatter",t[t.EnterTransport=17]="EnterTransport",t[t.PlaceBomb=18]="PlaceBomb",e("OrderType",i)}}})),System.register("gui/PointerType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Default=0]="Default",t[t.Mini=1]="Mini",t[t.Scroll=2]="Scroll",t[t.NoScroll=10]="NoScroll",t[t.Select=18]="Select",t[t.Move=31]="Move",t[t.NoMove=41]="NoMove",t[t.MoveMini=42]="MoveMini",t[t.NoActionMini=52]="NoActionMini",t[t.AttackRange=53]="AttackRange",t[t.AttackNoRange=58]="AttackNoRange",t[t.AttackMini=63]="AttackMini",t[t.Guard=68]="Guard",t[t.GuardMini=73]="GuardMini",t[t.Unknown1=78]="Unknown1",t[t.Unknown2=88]="Unknown2",t[t.Occupy=89]="Occupy",t[t.NoOccupy=99]="NoOccupy",t[t.OccupyMini=100]="OccupyMini",t[t.Deploy=110]="Deploy",t[t.NoDeploy=119]="NoDeploy",t[t.Unknown3=120]="Unknown3",t[t.Sell=129]="Sell",t[t.SellMini=139]="SellMini",t[t.NoSell=149]="NoSell",t[t.RepairMove=150]="RepairMove",t[t.SideRepair=170]="SideRepair",t[t.NoRepair=190]="NoRepair",t[t.Unknown4=191]="Unknown4",t[t.Unknown5=199]="Unknown5",t[t.Dynamite=204]="Dynamite",t[t.Unknown6=209]="Unknown6",t[t.Unknown7=214]="Unknown7",t[t.Unknown8=219]="Unknown8",t[t.Unknown9=224]="Unknown9",t[t.Unknown10=229]="Unknown10",t[t.Unknown11=234]="Unknown11",t[t.Unknwon12=239]="Unknwon12",t[t.Unknown13=249]="Unknown13",t[t.Para=259]="Para",t[t.Unknown14=269]="Unknown14",t[t.Storm=279]="Storm",t[t.Unknown15=299]="Unknown15",t[t.C4=309]="C4",t[t.Nuke=319]="Nuke",t[t.Unknown16=329]="Unknown16",t[t.Power=339]="Power",t[t.Unknown17=345]="Unknown17",t[t.Iron=346]="Iron",t[t.Unknown18=351]="Unknown18",t[t.Unknown19=356]="Unknown19",t[t.Chrono=357]="Chrono",t[t.DefuseBomb=369]="DefuseBomb",t[t.NoAction=384]="NoAction",t[t.Pan=385]="Pan",t[t.Unknown21=394]="Unknown21",t[t.AttackMove=404]="AttackMove",t[t.Unknown23=413]="Unknown23",t[t.Unknown24=422]="Unknown24",t[t.Unknown25=431]="Unknown25",t[t.Unknown26=432]="Unknown26",t[t.Unknown27=433]="Unknown27",t[t.Unknown28=434]="Unknown28",t[t.Beacon=435]="Beacon",e("PointerType",i)}}})),System.register("game/gameobject/task/system/TaskStatus",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Finished=2]="Finished",t[t.Cancelling=3]="Cancelling",t[t.Cancelled=4]="Cancelled",e("TaskStatus",i)}}})),System.register("data/map/tag/TagRepeatType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.OnceAny=0]="OnceAny",t[t.OnceAll=1]="OnceAll",t[t.Repeat=2]="Repeat",e("TagRepeatType",i)}}})),System.register("data/map/tag/Tag",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Tag",class{})}}})),System.register("game/map/Tile",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/map/TileCollection",["game/type/LandType","engine/type/TerrainType","util/typeGuard"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){var t;(t=n=n||{})[t.Top=0]="Top",t[t.TopLeft=1]="TopLeft",t[t.TopRight=2]="TopRight",t[t.Left=3]="Left",t[t.Right=4]="Right",t[t.BottomLeft=5]="BottomLeft",t[t.Bottom=6]="Bottom",t[t.BottomRight=7]="BottomRight",e("TileDirection",n),e("TileCollection",class{constructor(e,t,s,n){this.tileSets=t,this.generalRules=s;let a=this.rSize={width:0,height:0},o=this.dSize={width:0,height:0};for(let t=0,i=e.length;t<i;++t)a.width=Math.max(a.width,e[t].rx),a.height=Math.max(a.height,e[t].ry),o.width=Math.max(o.width,e[t].dx),o.height=Math.max(o.height,e[t].dy);a.width++,a.height++,o.width++,o.height++;let l=this.tilesByRxy=new Array(a.width*a.height);l.fill(void 0);let c=this.tilesByDxy=new Array(o.width*o.height);c.fill(void 0);let h=this.tiles=new Array(e.length),u=[],d=this.bridgeSetTiles=[],g=new Set(Object.values(r.TerrainType));this.minTileHeight=Number.POSITIVE_INFINITY;for(let s=this.maxTileHeight=0,S=e.length;s<S;++s){var p=e[s],m=t.getTileImage(p.tileNum,p.subTile,n),f=m.terrainType;if(!g.has(f))throw new Error(`Tile (${p.rx}, ${p.ry}) has unknown terrain type "${f}"`);var y={...p,terrainType:f,landType:i.getLandType(f),onBridgeLandType:void 0,rampType:m.rampType,id:p.rx+"_"+p.ry,occluded:!1},T=y.rx,v=y.ry,b=y.dx;f=y.dy;h[s]=y,l[T+v*a.width]=y,c[b+f*o.width]=y,this.minTileHeight=Math.min(this.minTileHeight,y.z),this.maxTileHeight=Math.max(this.maxTileHeight,y.z),4!==m.height||y.terrainType!==r.TerrainType.Cliff&&!t.isCliffTile(y.tileNum)||u.push(y),t.isHighBridgeBoundaryTile(p.tileNum)&&d.push(y)}this.computeLandBehindCliffTiles(u),this.cutoffTileHeight=this.computeCutoffTileHeight()}computeLandBehindCliffTiles(e){if(!(this.generalRules.cliffBackImpassability<2)){let t=[[-2,-2],[-1,-1],[-1,1],[1,-1],[0,1],[1,0]];e.forEach((e=>{for(var[s,n]of t){let t=this.getByMapCoords(e.rx+s,e.ry+n);t&&t.z<e.z&&t.terrainType!==r.TerrainType.Cliff&&t.terrainType!==r.TerrainType.Rough&&0===t.rampType&&(t.landType=i.LandType.Rock)}}))}}getTileRadarColor(e){return this.tileSets.getTileImage(e.tileNum,e.subTile,(()=>0)).radarLeft.clone().multiplyScalar(.5)}getAll(){return[...this.tiles]}forEach(e){for(let t=0,i=this.tiles.length;t<i;++t)e(this.tiles[t],t)}reduce(e,t){let i=t;return this.forEach((t=>{i=e(i,t)})),i}getMinTileHeight(){return this.minTileHeight}getMaxTileHeight(){return this.maxTileHeight}getCutoffTileHeight(){return this.cutoffTileHeight}computeCutoffTileHeight(){var e=this.dSize.width-1;let t=this.dSize.height-1,i=0,r=!0;for(;r&&0<t;){for(let n=1;n<e-3;n++){var s=this.getByDisplayCoords(n,t);s&&(r=!1,s.z>i&&(i=s.z))}r&&t--}return i}getAllBridgeSetTiles(){return this.bridgeSetTiles}getAllNeighbourTiles(e){var t=e.rx,i=e.ry;return[this.getByMapCoords(t+1,i+1),this.getByMapCoords(t-1,i-1),this.getByMapCoords(t-1,i+1),this.getByMapCoords(t+1,i-1),this.getByMapCoords(t,i+1),this.getByMapCoords(t+1,i),this.getByMapCoords(t-1,i),this.getByMapCoords(t,i-1)].filter(s.isNotNullOrUndefined)}getNeighbourTile(e,t){var i=e.rx,r=e.ry;switch(t){case n.Bottom:return this.getByMapCoords(i+1,r+1);case n.Top:return this.getByMapCoords(i-1,r-1);case n.Left:return this.getByMapCoords(i-1,r+1);case n.Right:return this.getByMapCoords(i+1,r-1);case n.BottomLeft:return this.getByMapCoords(i,r+1);case n.BottomRight:return this.getByMapCoords(i+1,r);case n.TopLeft:return this.getByMapCoords(i-1,r);case n.TopRight:return this.getByMapCoords(i,r-1);default:throw new Error("Invalid direction")}}getByDisplayCoords(e,t){if(!(e>=this.dSize.width||t>=this.dSize.height))return this.tilesByDxy[e+t*this.dSize.width]}getByMapCoords(e,t){if(!(e>=this.rSize.width||t>=this.rSize.height))return this.tilesByRxy[e+t*this.rSize.width]}getMapSize(){return this.rSize}getDisplaySize(){return this.dSize}getInRectangle(e,t){let i=[];for(let n=0;n<t.width;n++)for(let a=0;a<t.height;a++){var r=e.rx+n,s=e.ry+a;(s=this.getByMapCoords(r,s))&&i.push(s)}return i}getPlaceholderTile(e,t){var s;return{rx:e,ry:t,dx:e-t+(s=(s=this.tiles[0]).dx-s.rx+s.ry+1)-1,dy:e+t-s-1,z:0,id:e+"_"+t,landType:i.LandType.Rock,terrainType:r.TerrainType.Rock1,rampType:0,subTile:0,tileNum:0,occluded:!1,onBridgeLandType:void 0}}})}}})),System.register("game/gameobject/unit/ZoneType",["game/type/LandType"],(function(e,t){"use strict";var i,r;return t&&t.id,e("getZoneType",(function(e){return[i.LandType.Water,i.LandType.Beach].includes(e)?r.Water:r.Ground})),{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Ground=0]="Ground",t[t.Air=1]="Air",t[t.Water=2]="Water",e("ZoneType",r)}}})),System.register("game/map/TileOccupation",["game/type/LandType","util/event","game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){var t;(t=n=n||{})[t.All=0]="All",t[t.Ground=1]="Ground",t[t.Air=2]="Air",e("LayerType",n),e("TileOccupation",class{constructor(e){this.tiles=e,this.tileOccupation=[],this.emptyTiles=new Set,this._onChange=new r.EventDispatcher;let t=this.tileOccupation;for(var i of e.getAll())t[i.rx]=t[i.rx]||[],t[i.rx][i.ry]=new Set,this.emptyTiles.add(i)}get onChange(){return this._onChange.asEvent()}occupyTileRange(e,t){let i=this.calculateTilesForGameObject(e,t);i.forEach((e=>this.occupyTile(e,t))),this._onChange.dispatch(this,{tiles:i,object:t,type:"added"})}unoccupyTileRange(e,t){let i=this.calculateTilesForGameObject(e,t);i.forEach((e=>this.unoccupyTile(e,t))),this._onChange.dispatch(this,{tiles:i,object:t,type:"removed"})}occupySingleTile(e,t){this.occupyTile(e,t),this._onChange.dispatch(this,{tiles:[e],object:t,type:"added"})}unoccupySingleTile(e,t){this.unoccupyTile(e,t),this._onChange.dispatch(this,{tiles:[e],object:t,type:"removed"})}calculateTilesForGameObject(e,t){return this.tiles.getInRectangle(e,t.getFoundation())}occupyTile(e,t){let i=this.tileOccupation[e.rx]?.[e.ry];i&&(i.add(t),this.emptyTiles.delete(e),e.landType=this.computeTileLandType(e),e.onBridgeLandType=this.computeOnBridgeLandType(e))}unoccupyTile(e,t){let i=this.tileOccupation[e.rx]?.[e.ry];i&&(i.delete(t),i.size||this.emptyTiles.add(e),e.landType=this.computeTileLandType(e),e.onBridgeLandType=this.computeOnBridgeLandType(e))}isTileOccupiedBy(e,t){return!!this.tileOccupation[e.rx]?.[e.ry]?.has(t)}computeTileLandType(e){if(e.landType===i.LandType.Rock)return i.LandType.Rock;var t,r=i.getLandType(e.terrainType);for(t of this.tileOccupation[e.rx]?.[e.ry]??[]){if((t.isOverlay()||t.isBuilding())&&t.rules.wall)return i.LandType.Wall;if(t.isOverlay()&&t.isTiberium())return i.LandType.Tiberium;if(t.isOverlay()&&t.rules.land!==i.LandType.Clear&&!t.isBridge()&&!t.isBridgePlaceholder())return t.rules.land}return r}computeOnBridgeLandType(e){for(var t of this.tileOccupation[e.rx]?.[e.ry]??[])if(t.isOverlay()&&t.isBridge())return t.isHighBridge()?i.LandType.Road:t.rules.land}getTileZone(e,t=!1){return s.getZoneType(t?e.landType:e.onBridgeLandType??e.landType)}getBridgeOnTile(e){for(var t of this.tileOccupation[e.rx]?.[e.ry]??[])if(t.isOverlay()&&t.isBridge())return t}getObjectsOnTile(e){return[...this.tileOccupation[e.rx]?.[e.ry]??[]]}getGroundObjectsOnTile(e){let t=[];for(var i of this.tileOccupation[e.rx]?.[e.ry]??[])i.isTechno()&&!i.isBuilding()&&i.zone===s.ZoneType.Air||t.push(i);return t}getAirObjectsOnTile(e){let t=[];for(var i of this.tileOccupation[e.rx]?.[e.ry]??[])i.isUnit()&&i.zone===s.ZoneType.Air&&t.push(i);return t}getObjectsOnTileByLayer(e,t){if(t===n.Ground)return this.getGroundObjectsOnTile(e);if(t===n.Air)return this.getAirObjectsOnTile(e);if(t===n.All)return this.getObjectsOnTile(e);throw new Error(`Unhandled layer type "${t}"`)}getEmptyTiles(){return[...this.emptyTiles]}})}}})),System.register("game/map/BridgeOverlayTypes",["util/math"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.NotBridge=0]="NotBridge",t[t.Concrete=1]="Concrete",t[t.Wood=2]="Wood",e("OverlayBridgeType",r),e("BridgeOverlayTypes",s=class{static getOverlayBridgeType(e){return i.isBetween(e,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)||i.isBetween(e,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)?r.Concrete:i.isBetween(e,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||i.isBetween(e,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)?r.Wood:r.NotBridge}static isBridge(e){return this.isHighBridge(e)||this.isLowBridge(e)}static isBridgePlaceholder(e){return this.bridgePlaceholderIds.includes(e)}static isHighBridge(e){return i.isBetween(e,this.minHighBridgeWoodId,this.maxHighBridgeWoodId)||i.isBetween(e,this.minHighBridgeConcreteId,this.maxHighBridgeConcreteId)}static isLowBridge(e){return i.isBetween(e,this.minLowBridgeWoodId,this.maxLowBridgeWoodId)||i.isBetween(e,this.minLowBridgeConcreteId,this.maxLowBridgeConcreteId)}static isXBridge(e){return e===this.minHighBridgeWoodId||e===this.minHighBridgeConcreteId||i.isBetween(e,this.minLowBridgeWoodId,this.minLowBridgeWoodId+8)||i.isBetween(e,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+21)||i.isBetween(e,this.minLowBridgeConcreteId,this.minLowBridgeConcreteId+8)||i.isBetween(e,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+21)}static isLowBridgeHead(e){return i.isBetween(e,this.minLowBridgeWoodId+18,this.minLowBridgeWoodId+25)||i.isBetween(e,this.minLowBridgeConcreteId+18,this.minLowBridgeConcreteId+25)}static isLowBridgeHeadStart(e){return i.isBetween(e,this.minLowBridgeWoodId+20,this.minLowBridgeWoodId+23)||i.isBetween(e,this.minLowBridgeConcreteId+20,this.minLowBridgeConcreteId+23)}static calculateLowBridgeOverlayId(e,t){let i;if(e===r.Concrete)i=this.minLowBridgeConcreteId;else{if(e!==r.Wood)throw new Error("Not implemented");i=this.minLowBridgeWoodId}return i+(t?0:9)}static calculateHighBridgeOverlayId(e,t){let i;if(e===r.Concrete)i=this.minHighBridgeConcreteId;else{if(e!==r.Wood)throw new Error("Not implemented");i=this.minHighBridgeWoodId}return i+(t?0:1)}}),s.minLowBridgeWoodId=74,s.maxLowBridgeWoodId=99,s.minLowBridgeConcreteId=205,s.maxLowBridgeConcreteId=230,s.minHighBridgeConcreteId=24,s.maxHighBridgeConcreteId=25,s.minHighBridgeWoodId=237,s.maxHighBridgeWoodId=238,s.bridgePlaceholderIds=[100,101,231,232]}}})),System.register("engine/type/OverlayTibType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NotSpecial=0]="NotSpecial",t[t.Riparius=1]="Riparius",t[t.Cruentus=2]="Cruentus",t[t.Vinifera=4]="Vinifera",t[t.Aboreus=8]="Aboreus",t[t.Ore=1]="Ore",t[t.Gems=2]="Gems",t[t.All=15]="All",e("OverlayTibType",i)}}})),System.register("game/map/OreOverlayTypes",["engine/type/OverlayTibType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("OreOverlayTypes",r=class{static getOverlayTibType(e){return this.isRiparius(e)?i.OverlayTibType.Riparius:this.isCruentus(e)?i.OverlayTibType.Cruentus:this.isVinifera(e)?i.OverlayTibType.Vinifera:this.isAboreus(e)?i.OverlayTibType.Aboreus:i.OverlayTibType.NotSpecial}static isRiparius(e){return e>=this.minIdRiparius&&e<=this.maxIdRiparius}static isCruentus(e){return e>=this.minIdCruentus&&e<=this.maxIdCruentus}static isVinifera(e){return e>=this.minIdVinifera&&e<=this.maxIdVinifera}static isAboreus(e){return e>=this.minIdAboreus&&e<=this.maxIdAboreus}}),r.minIdRiparius=102,r.maxIdRiparius=127,r.minIdCruentus=27,r.maxIdCruentus=38,r.minIdVinifera=127,r.maxIdVinifera=146,r.minIdAboreus=147,r.maxIdAboreus=166}}})),System.register("game/gameobject/infantry/StanceType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Guard=1]="Guard",t[t.Prone=2]="Prone",t[t.Deployed=3]="Deployed",t[t.Paradrop=4]="Paradrop",t[t.Cheer=5]="Cheer",e("StanceType",i)}}})),System.register("game/gameobject/locomotor/Locomotor",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameobject/trait/interface/NotifyUnspawn",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onUnspawn=Symbol(),e("NotifyUnspawn",i)}}})),System.register("game/gameobject/trait/interface/NotifyOwnerChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyOwnerChange",i)}}})),System.register("game/Hashable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameobject/trait/interface/NotifyTick",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onTick=Symbol(),e("NotifyTick",i)}}})),System.register("game/type/MovementZone",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Amphibious=0]="Amphibious",t[t.AmphibiousCrusher=1]="AmphibiousCrusher",t[t.AmphibiousDestroyer=2]="AmphibiousDestroyer",t[t.Crusher=3]="Crusher",t[t.CrusherAll=4]="CrusherAll",t[t.Destroyer=5]="Destroyer",t[t.Fly=6]="Fly",t[t.Infantry=7]="Infantry",t[t.InfantryDestroyer=8]="InfantryDestroyer",t[t.Normal=9]="Normal",t[t.Subterranean=10]="Subterranean",t[t.Water=11]="Water",e("MovementZone",i)}}})),System.register("game/AttackerInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameobject/common/DeathType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Normal=1]="Normal",t[t.Demolish=2]="Demolish",t[t.Crush=3]="Crush",t[t.Temporal=4]="Temporal",t[t.Sink=5]="Sink",e("DeathType",i)}}})),System.register("game/gameobject/task/system/CallbackTask",["game/gameobject/task/system/Task"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.Task{constructor(e){super(),this.cb=e}onTick(e){return this.cb(e),!0}},e("CallbackTask",r)}}})),System.register("data/encoding/Format80",["data/DataStream"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Format80",class{static decode(e,t){var i=new Uint8Array(t);return this.decodeInto(e,i),i}static decodeInto(e,t){let r=new i.DataStream(new DataView(e.buffer,e.byteOffset,e.byteLength)),s=0;for(;;){var n=r.readUint8();if(0==(128&n)){var a=r.readUint8(),o=3+((112&n)>>4);this.replicatePrevious(t,s,s-(((15&n)<<8)+a),o),s+=o}else if(0==(64&n)){if(0==(o=63&n))return s;t.set(r.readUint8Array(o),s),s+=o}else if(62==(n&=63))for(var l=r.readInt16(),c=r.readUint8(),h=s+l;s<h;s++)t[s]=c;else if(63==n){l=r.readInt16();let e=r.readInt16();if(e>=s)throw new Error(`srcIndex >= destIndex  ${e}  `+s);for(var u=s+l;s<u;s++)t[s]=t[e++]}else{n=3+n;let e=r.readInt16();if(e>=s)throw new Error(`srcIndex >= destIndex  ${e}  `+s);for(var d=s+n;s<d;s++)t[s]=t[e++]}}}static replicatePrevious(e,t,i,r){if(t<i)throw new Error(`srcIndex > destIndex  ${i}  `+t);if(t-i==1)for(let i=0;i<r;i++)e[t+i]=e[t-1];else for(let s=0;s<r;s++)e[t+s]=e[i+s]}})}}})),System.register("data/encoding/MiniLzo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MiniLzo",class{static decompress(e,t){var i={inputBuffer:e,outputBuffer:null},r=lzo1x.decompress(i,{outputSize:t});if(0!==r)throw new Error("MiniLzo decode failed with code "+r);return i.outputBuffer}})}}})),System.register("data/encoding/Format5",["data/encoding/Format80","data/encoding/MiniLzo"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Format5",class{static decode(e,t,i=5){var r=new Uint8Array(t);return this.decodeInto(e,r,i),r}static decodeInto(e,t,s=5){var n=t.length;let a=0,o=0;for(;o<n;){var l=e[a+1]<<8|e[a];a+=2;var c=e[a+1]<<8|e[a];if(a+=2,!l||!c)break;let n;n=80===s?i.Format80.decode(e.subarray(a,a+l),c):r.MiniLzo.decompress(e.subarray(a,a+l),c);for(let e=0;e<c;++e)t[o+e]=n[e];a+=l,o+=c}}})}}})),System.register("data/Bitmap",[],(function(e,t){"use strict";var i,r,s;function n(e){switch(e){case i.Indexed:return 1;case i.Rgb:return 3;case i.Rgba:return 4;default:throw new Error("Unsupported pixel format "+e)}}return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Rgb=1]="Rgb",t[t.Rgba=2]="Rgba",t[t.Indexed=3]="Indexed",e("PixelFormat",i),e("Bitmap",r=class{constructor(e,t,r,s=i.Rgba){var a=n(s);this.data=r||new Uint8Array(a*e*t),this.pixelFormat=s,this.width=e,this.height=t}drawIndexedImage(e,t,i){var r=n(this.pixelFormat);const s=this.data;var a=this.width,o=r*a,l=r*a*this.height;let c=0+o*i+r*t,h=0;for(let t=0;t<e.height;t++){for(let t=0;t<e.width;t++){var u=e.data[h];0!==u&&0<=c&&c<l&&(s[c]=u,3<=r&&(s[c+1]=0,s[c+2]=0),4===r&&(s[c+3]=255)),c+=r,h++}c+=o-e.width*r}}}),s=class extends r{constructor(e,t,r){super(e,t,r,i.Indexed)}},e("IndexedBitmap",s),s=class extends r{constructor(e,t,r){super(e,t,r,i.Rgb)}},e("RgbBitmap",s),s=class extends r{constructor(e,t,r){super(e,t,r,i.Rgba)}drawRgbaImage(e,t,i){const r=this.data;var s=this.width,n=4*s,a=4*s*this.height;let o=0+n*i+4*t,l=0;for(let t=0;t<e.height;t++){for(let t=0;t<e.width;t++)0<=o&&o<a&&(r[o]=e.data[l],r[o+1]=e.data[l+1],r[o+2]=e.data[l+2],r[o+3]=e.data[l+3]),o+=4,l+=4;o+=n-4*e.width}}},e("RgbaBitmap",s)}}})),System.register("data/map/trigger/TriggerEventType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NoEvent=0]="NoEvent",t[t.EnteredBy=1]="EnteredBy",t[t.SpiedBy=2]="SpiedBy",t[t.AttackedByAny=6]="AttackedByAny",t[t.DestroyedByAny=7]="DestroyedByAny",t[t.AnyEvent=8]="AnyEvent",t[t.DestroyedAllUnits=9]="DestroyedAllUnits",t[t.DestroyedAllBuildings=10]="DestroyedAllBuildings",t[t.DestroyedAll=11]="DestroyedAll",t[t.CreditsExceed=12]="CreditsExceed",t[t.ElapsedTime=13]="ElapsedTime",t[t.MissionTimerExpired=14]="MissionTimerExpired",t[t.DestroyedBuildings=15]="DestroyedBuildings",t[t.DestroyedUnits=16]="DestroyedUnits",t[t.NoFactoriesLeft=17]="NoFactoriesLeft",t[t.BuildBuilding=19]="BuildBuilding",t[t.BuildUnit=20]="BuildUnit",t[t.BuildInfantry=21]="BuildInfantry",t[t.BuildAircraft=22]="BuildAircraft",t[t.CrossesHorizontalLine=25]="CrossesHorizontalLine",t[t.CrossesVerticalLine=26]="CrossesVerticalLine",t[t.GlobalIsSet=27]="GlobalIsSet",t[t.GlobalIsCleared=28]="GlobalIsCleared",t[t.DestroyedOrCaptured=29]="DestroyedOrCaptured",t[t.LowPower=30]="LowPower",t[t.DestroyedBridge=31]="DestroyedBridge",t[t.BuildingExists=32]="BuildingExists",t[t.ComesNearWaypoint=34]="ComesNearWaypoint",t[t.LocalIsSet=36]="LocalIsSet",t[t.LocalIsCleared=37]="LocalIsCleared",t[t.FirstDamagedCombat=38]="FirstDamagedCombat",t[t.HalfHealthCombat=39]="HalfHealthCombat",t[t.QuarterHealthCombat=40]="QuarterHealthCombat",t[t.FirstDamagedAny=41]="FirstDamagedAny",t[t.HalfHealthAny=42]="HalfHealthAny",t[t.QuarterHealthAny=43]="QuarterHealthAny",t[t.AttackedByHouse=44]="AttackedByHouse",t[t.AmbientLightBelow=45]="AmbientLightBelow",t[t.AmbientLightAbove=46]="AmbientLightAbove",t[t.ElapsedScenarioTime=47]="ElapsedScenarioTime",t[t.DestroyedOrCapturedOrInfiltrated=48]="DestroyedOrCapturedOrInfiltrated",t[t.PickupCrate=49]="PickupCrate",t[t.PickupCrateAny=50]="PickupCrateAny",t[t.RandomDelay=51]="RandomDelay",t[t.CreditsBelow=52]="CreditsBelow",t[t.SpyEnteringAsHouse=53]="SpyEnteringAsHouse",t[t.SpyEnteringAsInfantry=54]="SpyEnteringAsInfantry",t[t.DestroyedAllUnitsNaval=55]="DestroyedAllUnitsNaval",t[t.DestroyedAllUnitsLand=56]="DestroyedAllUnitsLand",t[t.BuildingNotExists=57]="BuildingNotExists",e("TriggerEventType",i)}}})),System.register("data/map/trigger/TriggerEvent",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/map/trigger/TriggerActionType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NoAction=0]="NoAction",t[t.FireSale=9]="FireSale",t[t.TextTrigger=11]="TextTrigger",t[t.DestroyTrigger=12]="DestroyTrigger",t[t.ChangeHouse=14]="ChangeHouse",t[t.RevealMap=16]="RevealMap",t[t.RevealAroundWaypoint=17]="RevealAroundWaypoint",t[t.PlaySoundFx=19]="PlaySoundFx",t[t.PlaySpeech=21]="PlaySpeech",t[t.ForceTrigger=22]="ForceTrigger",t[t.TimerStart=23]="TimerStart",t[t.TimerStop=24]="TimerStop",t[t.TimerExtend=25]="TimerExtend",t[t.TimerShorten=26]="TimerShorten",t[t.TimerSet=27]="TimerSet",t[t.GlobalSet=28]="GlobalSet",t[t.GlobalClear=29]="GlobalClear",t[t.DestroyObject=32]="DestroyObject",t[t.AddOneTimeSuperWeapon=33]="AddOneTimeSuperWeapon",t[t.AddRepeatingSuperWeapon=34]="AddRepeatingSuperWeapon",t[t.AllChangeHouse=36]="AllChangeHouse",t[t.ResizePlayerView=40]="ResizePlayerView",t[t.PlayAnimAt=41]="PlayAnimAt",t[t.DetonateWarhead=42]="DetonateWarhead",t[t.ReshroudMap=51]="ReshroudMap",t[t.EnableTrigger=53]="EnableTrigger",t[t.DisableTrigger=54]="DisableTrigger",t[t.CreateRadarEvent=55]="CreateRadarEvent",t[t.LocalSet=56]="LocalSet",t[t.LocalClear=57]="LocalClear",t[t.SellBuilding=60]="SellBuilding",t[t.TurnOffBuilding=61]="TurnOffBuilding",t[t.TurnOnBuilding=62]="TurnOnBuilding",t[t.ApplyOneHundredDamage=63]="ApplyOneHundredDamage",t[t.ForceEnd=69]="ForceEnd",t[t.DestroyTag=70]="DestroyTag",t[t.SetAmbientStep=71]="SetAmbientStep",t[t.SetAmbientRate=72]="SetAmbientRate",t[t.SetAmbientLight=73]="SetAmbientLight",t[t.NukeStrike=95]="NukeStrike",t[t.PlaySoundFxAt=99]="PlaySoundFxAt",t[t.UnrevealAroundWaypoint=101]="UnrevealAroundWaypoint",t[t.LightningStrike=102]="LightningStrike",t[t.TimerText=103]="TimerText",t[t.CreateCrate=108]="CreateCrate",t[t.IronCurtainAt=109]="IronCurtainAt",t[t.EvictOccupiers=111]="EvictOccupiers",t[t.Cheer=113]="Cheer",t[t.StopSoundsAt=116]="StopSoundsAt",e("TriggerActionType",i)}}})),System.register("data/map/trigger/TriggerAction",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/map/trigger/Trigger",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/map/tag/TagsReader",["data/map/tag/TagRepeatType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TagsReader",class{read(e){let t=[];for(var[r,s]of e.entries){var n=s.split(",");n.length<3?console.warn(`Invalid tag ${r}=${s}. Skipping.`):(s=Number(n[0]),void 0!==i.TagRepeatType[s]?(n={id:r,repeatType:s,name:n[1],triggerId:n[2]},t.push(n)):console.warn(`Invalid repeat value ${s} for tag id ${r}. Skipping.`))}return t}})}}})),System.register("data/map/trigger/TriggerReader",["data/map/trigger/TriggerEventType","data/map/trigger/TriggerActionType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("TriggerReader",class{read(e,t,i,r){let s=this.readTriggers(e),{events:n,unknownEventTypes:a}=this.readEvents(t),{actions:o,unknownActionTypes:l}=this.readActions(i),c=[...r.values()],h=new Set(s);for(let e of s.values()){var u=n.get(e.id);u&&e.events.push(...u),(u=o.get(e.id))&&e.actions.push(...u),!e.attachedTriggerId||(u=s.find((t=>t.id===e.attachedTriggerId)))&&(e.attachedTrigger=u,h.delete(u))}for(let e of h){var d=c.find((t=>t.triggerId===e.id));if(d){let t=e;for(;t;)t.tag=d,t=t.attachedTrigger}else{let t=e;for(;t;){console.warn(`Trigger ${t.id} has no associated tag or valid root trigger. Skipping.`);var g=s.indexOf(t);-1!==g&&s.splice(g,1),t=t.attachedTrigger}}}return{triggers:s,unknownEventTypes:a,unknownActionTypes:l}}readTriggers(e){let t=[];for(var[i,r]of e.entries){var s=r.split(",");s.length<8?console.warn(`Invalid trigger ${i}=${r}. Skipping.`):(s={id:i,houseName:s[0],attachedTriggerId:"<none>"!==s[1]?s[1]:void 0,attachedTrigger:void 0,name:s[2],disabled:Boolean(Number(s[3])),difficulties:{easy:Boolean(Number(s[4])),medium:Boolean(Number(s[5])),hard:Boolean(Number(s[6]))},events:[],actions:[],tag:void 0},t.push(s))}return t}readEvents(e){let t=new Map,r=new Set;for(var[s,n]of e.entries){let e=n.split(",");if(e.length<4)console.warn(`Invalid event ${s}=${n}. Skipping.`);else{var a=Number(e.shift());let n=[];for(let t=0;t<a;t++){var o=Number(e.shift()),l=Number(e.shift());let a=e.splice(0,2===l?2:1);void 0!==i.TriggerEventType[o]?(l={triggerId:s,eventIndex:t,type:o,params:[l,...a.map((e=>e||"0"))]},n.push(l)):(r.add(o),console.warn(`Unknown event type ${o} for trigger id ${s}. Skipping.`))}t.set(s,n)}}return{events:t,unknownEventTypes:r}}readActions(e){let t=new Map,i=new Set;for(var[s,n]of e.entries){let e=n.split(",");if(e.length<9)console.warn(`Invalid action ${s}=${n}. Skipping.`);else{var a=Number(e.shift());if(e.length<8*a)console.warn(`Invalid action ${s}=${n}. Skipping.`);else{let n=[];for(let t=0;t<a;t++){var o=Number(e.shift()),l=e.splice(0,7);void 0!==r.TriggerActionType[o]?(l={triggerId:s,index:t,type:o,params:[Number(l[0]||"0"),l[1]||"0",l[2]||"0",l[3]||"0",l[4]||"0",l[5]||"0",l[6]?this.readAZActionParam(l[6]):0]},n.push(l)):(i.add(o),console.warn(`Unknown action type ${o} for trigger id "${s}". Skipping.`))}t.set(s,n)}}}return{actions:t,unknownActionTypes:i}}readAZActionParam(e){var t="Z".charCodeAt(0),i="A".charCodeAt(0);t=t-i+1;return 1<e.length?e.charCodeAt(1)-i+(e.charCodeAt(0)-i+1)*t:e.charCodeAt(0)-i}})}}})),System.register("data/map/MapLighting",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MapLighting",class{constructor(){this.level=0,this.ambient=1,this.red=1,this.green=1,this.blue=1,this.ground=0,this.forceTint=!1}read(e,t=""){return this.level=e.getNumber(t+"Level",.032),this.ambient=e.getNumber(t+"Ambient",1),this.red=e.getNumber(t+"Red",1),this.green=e.getNumber(t+"Green",1),this.blue=e.getNumber(t+"Blue",1),this.ground=e.getNumber(t+"Ground",0),this}copy(e){return this.level=e.level,this.ambient=e.ambient,this.red=e.red,this.green=e.green,this.blue=e.blue,this.ground=e.ground,this.forceTint=e.forceTint,this}})}}})),System.register("data/map/tag/CellTag",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("data/map/tag/CellTagsReader",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CellTagsReader",class{read(e,t){let i=[];for(var[r,s]of e.entries)r={tagId:s,coords:this.readCoords(Number(r),t)},i.push(r);return i}readCoords(e,t){var i=t<4?128:1e3;return{x:e%i,y:Math.floor(e/i)}}})}}})),System.register("data/map/Variable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Variable",class e{constructor(e,t){this.name=e,this.value=t}clone(){return new e(this.name,this.value)}})}}})),System.register("data/map/SpecialFlags",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SpecialFlags",class{read(e){return this.initialVeteran=e.getBool("InitialVeteran"),this}})}}})),System.register("data/MapFile",["data/mapObjects","data/IniFile","engine/TheaterType","util/string","data/encoding/Format5","data/Bitmap","data/map/tag/TagsReader","data/map/trigger/TriggerReader","data/DataStream","data/map/MapLighting","data/map/tag/CellTagsReader","data/map/Variable","data/map/SpecialFlags"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class extends r.IniFile{fromString(e){super.fromString(e);let t=this.getSection("Map");if(!t)throw new Error("[Map] section not found");var i=t.getNumberArray("Size");if(this.fullSize={x:i[0],y:i[1],width:i[2],height:i[3]},i=t.getNumberArray("LocalSize"),this.localSize={x:i[0],y:i[1],width:i[2],height:i[3]},this.theaterType=t.getEnum("Theater",s.TheaterType,s.TheaterType.None,!0),this.theaterType===s.TheaterType.None)throw new Error(`Unsupported theater type "${t.getString("Theater")}"`);let r=this.getSection("Basic");return i=this.iniFormat=r?.getNumber("NewINIFormat")??0,this.readTiles(),r?.getBool("MultiplayerOnly")&&this.readWaypoints(this.getOrCreateSection("Waypoints")),this.readStructures(this.getOrCreateSection("Structures")),this.readVehicles(),this.readInfantries(),this.readAircrafts(),this.readTerrains(this.getOrCreateSection("Terrain")),this.readOverlays(),this.readSmudges(),this.readLighting(),this.readTagsAndTriggers(),this.readCellTags(i),this.readVariableNames(),this.startingLocations=this.readStartingLocations(this.waypoints),this.specialFlags=(new p.SpecialFlags).read(this.getOrCreateSection("SpecialFlags")),this}readStartingLocations(e){let t=[];var i;for(i of e.filter((e=>e.number<8)).sort(((e,t)=>e.number<t.number?-1:1)))t.push({x:i.rx,y:i.ry});return t}readLighting(){var e=this.getOrCreateSection("Lighting");this.lighting=(new u.MapLighting).read(e),this.ionLighting=(new u.MapLighting).read(e,"Ion"),this.ionLighting.forceTint=!0}readTagsAndTriggers(){this.tags=(new l.TagsReader).read(this.getOrCreateSection("Tags"));var e=this.getOrCreateSection("Triggers"),t=this.getOrCreateSection("Events"),i=this.getOrCreateSection("Actions"),{triggers:e,unknownEventTypes:t,unknownActionTypes:i}=(new c.TriggerReader).read(e,t,i,this.tags);this.triggers=e,this.unknownEventTypes=t,this.unknownActionTypes=i}readCellTags(e){this.cellTags=(new d.CellTagsReader).read(this.getOrCreateSection("CellTags"),e)}readVariableNames(){var e,t,i=this.getOrCreateSection("VariableNames");let r=new Map;for([e,t]of i.entries){var s,n,a=Number(e);Number.isNaN(a)?console.warn(`Map [VariableNames] contains non-numeric index "${e}". Skipping.`):([s,n]=t.split(","),n=new g.Variable(s,Boolean(Number(n))),r.set(a,n))}this.variables=r}readTiles(){let e=this.getSection("IsoMapPack5");if(!e)throw new Error("[IsoMapPack5] section not found");var t=n.base64StringToUint8Array(e.getConcatenatedValues()),i=(2*this.fullSize.width-1)*this.fullSize.height,r=new Uint8Array(11*i+4);a.Format5.decodeInto(t,r);let s=new h.DataStream(r.buffer),o=2*this.fullSize.width-1;r=this.fullSize.height;var l,c,u,d,g=(e,t)=>t*o+e;this.tiles=new Array(o*r);for(let e=this.maxTileNum=0;e<i;e++){var p=s.readUint16(),m=s.readUint16(),f=Math.max(0,s.readInt16());this.maxTileNum=Math.max(this.maxTileNum,f),s.readInt16();var y=s.readUint8(),T=s.readUint8();s.readUint8();var v=p-m+this.fullSize.width-1,b=p+m-this.fullSize.width-1;0<=v&&v<2*this.fullSize.width&&0<=b&&b<2*this.fullSize.height&&(y={dx:v,dy:b,rx:p,ry:m,z:T,tileNum:f,subTile:y},this.tiles[g(v,Math.floor(b/2))]=y)}for(let e=0;e<this.fullSize.height;e++)for(let t=0;t<=2*this.fullSize.width-2;t++)null==this.tiles[g(t,e)]&&(d=(c=2*e+t%2)-(u=((l=t)+c)/2+1)+this.fullSize.width+1,this.tiles[g(t,e)]={dx:l,dy:c,rx:u,ry:d,z:0,tileNum:0,subTile:0})}readWaypoints(e){for(var[t,i]of(this.waypoints=[],e.entries)){var r;let e;isNaN(r=parseInt(t,10))||isNaN(e=parseInt(i,10))||(i=e-1e3*(t=Math.floor(e/1e3)),this.waypoints.push({number:r,rx:i,ry:t}))}}readStructures(e){for(var[,t]of(this.structures=[],e.entries))if(!((t=t.split(",")).length<=15)){let e=new i.Structure;e.owner=t[0],e.name=t[1],e.health=Number(t[2]),e.rx=Number(t[3]),e.ry=Number(t[4]),e.tag=this.readTagId(t[6]),e.poweredOn=Boolean(Number(t[9])),this.structures.push(e)}}readTagId(e){return"none"!==e.toLowerCase()?e:void 0}readVehicles(){this.vehicles=[];let e=this.getSection("Units");if(e)for(var t of e.entries.values()){var r=t.split(",");if(r.length<=11)console.warn(`Invalid Vehicle entry: "${t}"`);else{let e=new i.Vehicle;e.owner=r[0],e.name=r[1],e.health=Number(r[2]),e.rx=Number(r[3]),e.ry=Number(r[4]),e.direction=Number(r[5]),e.tag=this.readTagId(r[7]),e.veterancy=Number(r[8]),e.onBridge="1"===r[10],this.vehicles.push(e)}}}readInfantries(){this.infantries=[];let e=this.getSection("Infantry");if(e)for(var t of e.entries.values()){var r=t.split(",");let e=new i.Infantry;r.length<=8?console.warn(`Invalid Infantry entry: "${t}"`):(e.owner=r[0],e.name=r[1],e.health=Number(r[2]),e.rx=Number(r[3]),e.ry=Number(r[4]),e.subCell=Number(r[5]),e.direction=Number(r[7]),e.tag=this.readTagId(r[8]),e.veterancy=Number(r[9]),e.onBridge="1"===r[11],this.infantries.push(e))}}readAircrafts(){this.aircrafts=[];let e=this.getSection("Aircraft");if(e)for(var t of e.entries.values()){t=t.split(",");let e=new i.Aircraft;e.owner=t[0],e.name=t[1],e.health=Number(t[2]),e.rx=Number(t[3]),e.ry=Number(t[4]),e.direction=Number(t[5]),e.tag=this.readTagId(t[7]),e.veterancy=Number(t[8]),e.onBridge="1"===t[t.length-4],this.aircrafts.push(e)}}readTerrains(e){for(var[t,r]of(this.terrains=[],e.entries))if(t=Number(t),!isNaN(t)){let e=new i.Terrain;e.name=r,e.rx=t%1e3,e.ry=Math.floor(t/1e3),this.terrains.push(e)}}readOverlays(){this.overlays=[],this.maxOverlayId=0;let e=this.getSection("OverlayPack");if(e){var t=n.base64StringToUint8Array(e.getConcatenatedValues()),r=new Uint8Array(1<<18);a.Format5.decodeInto(t,r,80);let u=this.getSection("OverlayDataPack");if(u){t=n.base64StringToUint8Array(u.getConcatenatedValues());var s=new Uint8Array(1<<18);a.Format5.decodeInto(t,s,80);for(let e=0;e<this.fullSize.height;e++)for(let t=2*this.fullSize.width-2;0<=t;t--){var o,l,c=((o=t)+(l=2*e+t%2))/2+1,h=l-c+this.fullSize.width+1;if(255!==(l=r[o=c+512*h])){o=s[o];let e=new i.Overlay;e.id=l,e.value=o,e.rx=c,e.ry=h,this.overlays.push(e),this.maxOverlayId=Math.max(this.maxOverlayId,l)}}}else console.warn("[OverlayDataPack] section not found. Skipping.")}else console.warn("[Overlay] section not found. Skipping.")}readSmudges(){this.smudges=[];let e=this.getSection("Smudge");if(e)for(var t of e.entries.values())if((t=t.split(",")).length<=2)console.warn(`Invalid Smudge entry: "${t}"`);else{let e=new i.Smudge;e.name=t[0],e.rx=Number(t[1]),e.ry=Number(t[2]),this.smudges.push(e)}}decodePreviewImage(){let e=this.getSection("Preview"),t=this.getSection("PreviewPack");if(e&&t){var[,,i,r]=e.getArray("Size").map((e=>Number(e))),s=n.base64StringToUint8Array(t.getConcatenatedValues()),r=new o.RgbBitmap(i,r);return a.Format5.decodeInto(s,r.data),r}}},e("MapFile",m)}}})),System.register("game/map/MapBounds",["util/geometry","game/Coords","util/event"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("MapBounds",class{constructor(){this.mapCutoffHeight=0,this.mapBuildableSize={x:0,y:0,width:0,height:0},this.localSize={x:0,y:0,width:0,height:0},this.fullSize={width:0,height:0},this.clampedFullSize={x:0,y:0,width:0,height:0},this.rawLocalSize={x:0,y:0,width:0,height:0},this._onLocalResize=new s.EventDispatcher}get onLocalResize(){return this._onLocalResize.asEvent()}fromMapFile(e,t){this.fullSize={width:2*e.fullSize.width,height:2*e.fullSize.height},this.clampedFullSize={x:1,y:2,width:2*(e.fullSize.width-1)-1/r.Coords.ISO_TILE_SIZE,height:2*(e.fullSize.height-1)+1-1/r.Coords.ISO_TILE_SIZE},this.mapCutoffHeight=Math.max(9,t.getCutoffTileHeight());var i={x:i=Math.max(2,e.localSize.x),y:e.localSize.y,width:Math.min(e.fullSize.width-2-i,e.localSize.width),height:e.localSize.height};return this.updateRawLocalSize(i),this}updateRawLocalSize(e){this.rawLocalSize.width&&this.rawLocalSize.height&&!i.rectContainsRect(e,this.rawLocalSize)?console.warn("New map limits must be outside old limits. Skipping."):i.rectEquals(e,this.rawLocalSize)||(this.localSize=this.computeLocalSize(e,this.fullSize.height/2,this.mapCutoffHeight),this.rawLocalSize={...e},this.mapBuildableSize={x:this.localSize.x,y:this.localSize.y+4,width:this.localSize.width-2,height:this.localSize.height-8},this._onLocalResize.dispatch(this))}computeLocalSize(e,t,i){return{x:2*e.x,y:2*e.y-4,height:Math.min(2*(e.height+5)-1,2*t-2*(e.y-3)-i),width:2*e.width}}getLocalSize(){return this.localSize}getRawLocalSize(){return this.rawLocalSize}getFullSize(){return this.fullSize}getClampedFullSize(){return this.clampedFullSize}isWithinBounds(e){return i.rectContainsPoint(this.mapBuildableSize,{x:e.dx,y:e.dy-e.z})}clampWithinBounds(e){let{x:t,y:r}=i.rectClampPoint(this.mapBuildableSize,{x:e.dx,y:e.dy-e.z});return r+=t%2-r%2,r>this.mapBuildableSize.y+this.mapBuildableSize.height&&(r-=2),{dx:t,dy:r}}isWithinHardBounds(e){var t=e.x/r.Coords.LEPTONS_PER_TILE,s=t-(n=(e.z??e.y)/r.Coords.LEPTONS_PER_TILE)+this.fullSize.width/2-1,n=t+n-this.fullSize.width/2-1;return i.rectContainsPoint(this.clampedFullSize,{x:++s,y:++n})}})}}})),System.register("game/map/tileFinder/DirectionalTileFinder",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("DirectionalTileFinder",class{constructor(e,t,i,r,s,n,a,o=(()=>!0)){this.tiles=e,this.mapBounds=t,this.startTile=i,this.maxDistance=s,this.dirX=n,this.dirY=a,this.predicate=o,this.finished=!1,this.distance=r}getNextTile(){if(!this.finished){let t;do{let i={x:this.startTile.rx,y:this.startTile.ry};i.x+=this.distance*Math.sign(this.dirX),i.y+=this.distance*Math.sign(this.dirY);var e=this.tiles.getByMapCoords(i.x,i.y);if(e&&this.mapBounds.isWithinBounds(e)&&this.predicate(e)&&(t=e),this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,t}while(this.distance++,!t);return t}}})}}})),System.register("game/map/tileFinder/RadialTileFinder",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RadialTileFinder",class{constructor(e,t,i,r,s,n,a,o=!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.foundation=r,this.maxDistance=n,this.predicate=a,this.checkBounds=o,this.distance=s,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var e=(e,t)=>{var i=this.tiles.getByMapCoords(e,t);if(i&&(!this.checkBounds||this.mapBounds.isWithinBounds(i))&&this.predicate(i))return i};do{var t=this.startTile.rx-this.distance,i=this.startTile.ry-this.distance,r=this.startTile.rx+this.foundation.width-1+this.distance,s=this.startTile.ry+this.foundation.height-1+this.distance;let n,a,o;if(0<this.distance){for(n=r;n>=t;n--)o=e(n,s),o&&(yield o);for(a=s-1;a>=i;a--)o=e(r,a),o&&(yield o);for(n=t;n<r;n++)o=e(n,i),o&&(yield o);for(a=1+i;a<s;a++)o=e(t,a),o&&(yield o)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}})),System.register("game/map/Bridges",["game/map/TileCollection","game/map/BridgeOverlayTypes","game/map/tileFinder/DirectionalTileFinder","game/map/tileFinder/RadialTileFinder","game/theater/TileSets","engine/type/TerrainType","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){var t;(t=c=c||{})[t.None=0]="None",t[t.Start=1]="Start",t[t.End=2]="End",e("BridgeHeadType",c),e("Bridges",class{constructor(e,t,i,r,s){this.tileSets=e,this.tiles=t,this.tileOccupation=i,this.mapBounds=r,this.rules=s,this.pieces=new Set,this.piecesByTile=new Map,this.handleTileOccupationUpdate=({object:e,type:t})=>{if(e.isOverlay()&&e.isBridge()){var i=e.tile;let n=this.piecesByTile.get(i);if("added"===t){if(n)throw new Error(`A bridge piece already exists at tile (${i.rx},${i.ry})`);var r=this.findBridgeAdjacentTiles(e);n={obj:e,prev:void 0,next:void 0,headType:this.computeHead(e,r.prev,r.next)},this.piecesByTile.set(i,n),this.pieces.add(n),this.connectPiece(n,r.prev,r.next),this.updateOverlayData(n),n.prev&&this.updateOverlayData(n.prev),n.next&&this.updateOverlayData(n.next)}else{if(!n)throw new Error(`Bridge piece was alredy removed at tile (${i.rx},${i.ry})`);var s=n.prev;r=n.next;this.disconnectPiece(n),this.piecesByTile.delete(i),this.pieces.delete(n),s&&this.updateOverlayData(s),r&&this.updateOverlayData(r)}}},i.onChange.subscribe(this.handleTileOccupationUpdate)}getPieceAtTile(e){return this.piecesByTile.get(e)}handlePieceHealthChange(e){this.updateOverlayData(e),e.prev&&this.updateOverlayData(e.prev),e.next&&this.updateOverlayData(e.next)}findDominoPieces(e){let t=[],i=!1,r=e.next;if(e.headType===c.None||r)for(;r;){if(t.push(r),r.headType!==c.None){i=!0;break}r=r.next}else i=!0;if(i){i=!1,t.length=0;let r=e.prev;if(e.headType===c.None||r)for(;r;){if(t.push(r),r.headType!==c.None){i=!0;break}r=r.prev}else i=!0;if(i)return[]}return t}findBridgeAdjacentTiles(e){var t=e.isXBridge(),i=new l.Vector2(Number(t),Number(!t));let r=new l.Vector2(e.tile.rx,e.tile.ry);return t=r.clone().sub(i),t=this.tiles.getByMapCoords(t.x,t.y),i=r.clone().add(i),{prev:t,next:this.tiles.getByMapCoords(i.x,i.y)}}connectPiece(e,t,i){t&&(e.prev=this.getPieceAtTile(t),e.prev&&(e.prev.next=e)),i&&(e.next=this.getPieceAtTile(i),e.next&&(e.next.prev=e))}disconnectPiece(e){e.next&&(e.next.prev=void 0,e.next=void 0),e.prev&&(e.prev.next=void 0,e.prev=void 0)}computeHead(e,t,i){var s=e.tile;return e.isHighBridge()?(s=s.z+e.tileElevation,t?.z===s?c.Start:i?.z===s?c.End:c.None):r.BridgeOverlayTypes.isLowBridgeHead(e.overlayId)?r.BridgeOverlayTypes.isLowBridgeHeadStart(e.overlayId)?c.Start:c.End:c.None}updateOverlayData(e){let t=e.obj,i=e.prev,s=e.next,n=!1;var a=t.isXBridge(),o=r.BridgeOverlayTypes.getOverlayBridgeType(t.overlayId);if(r.BridgeOverlayTypes.isLowBridgeHead(t.overlayId)){let e=0;r.BridgeOverlayTypes.isLowBridgeHeadStart(t.overlayId)?(e=a?20:22,s||e++):(e=a?18:24,i||e++),t.overlayId=(o===r.OverlayBridgeType.Wood?r.BridgeOverlayTypes.minLowBridgeWoodId:r.BridgeOverlayTypes.minLowBridgeConcreteId)+e,t.value=e,n=!0}else{let d;var l,h,u=(t.healthTrait?.health??100)<=50;d=e.headType!==c.None?e.headType===c.Start?s?u?6:(s.obj.healthTrait?.health??100)<=50?5:0:a?8:7:i?u?6:(i.obj.healthTrait?.health??100)<=50?4:0:a?7:8:(a||(h=i,i=s,s=h),i||s?i?s?(l=(i.obj.healthTrait?.health??100)<=50,h=(s.obj.healthTrait?.health??100)<=50,u||l&&h?6:l?4:h?5:0):8:7:0),a||(d+=9),t.isHighBridge()?t.value=d:(t.overlayId=(o===r.OverlayBridgeType.Wood?r.BridgeOverlayTypes.minLowBridgeWoodId:r.BridgeOverlayTypes.minLowBridgeConcreteId)+d,t.value=d,n=!0)}n&&(t.name=this.rules.getOverlayName(t.overlayId))}findClosestBridgeSpec(e){let t=new n.RadialTileFinder(this.tiles,this.mapBounds,e,{width:1,height:1},1,3,(t=>{if(t.z!==e.z)return!1;let i=this.tileOccupation.getBridgeOnTile(t);return!(!i?.isLowBridge()||this.getPieceAtTile(i.tile)?.headType===c.None)||!!this.tileSets.isHighBridgeBoundaryTile(t.tileNum)}));var i=t.getNextTile();if(i){let e,t,n,f;var o=!this.tileOccupation.getBridgeOnTile(i);let y;if(o){var l=this.findHighBridgeBoundary(i);if(!l)return;e=l.tile,t=r.OverlayBridgeType.Concrete,this.tileSets.getSetNum(i.tileNum)===this.tileSets.getGeneralValue("WoodBridgeSet")&&(t=r.OverlayBridgeType.Wood),n=l.headType===a.HighBridgeHeadType.TopLeft||l.headType===a.HighBridgeHeadType.BottomRight,f=l.headType===a.HighBridgeHeadType.TopLeft||l.headType===a.HighBridgeHeadType.TopRight,y=l.headType}else{e=this.tileOccupation.getBridgeOnTile(i).tile;let s=this.getPieceAtTile(e);if(!s)throw new Error("Bridge head is not defined");var h=r.BridgeOverlayTypes.getOverlayBridgeType(s.obj.overlayId);if(h===r.OverlayBridgeType.NotBridge)throw new Error("Expected a bridge type");t=h,n=s.obj.isXBridge(),f=s.headType===c.Start}var u=Number(n)*(f?1:-1),d=Number(!n)*(f?1:-1);let T;if(o){if(i=new s.DirectionalTileFinder(this.tiles,this.mapBounds,e,1,100,u,d,(t=>t.z===e.z&&this.tileSets.isHighBridgeBoundaryTile(t.tileNum))).getNextTile(),h=this.tileSets.getSetNum(e.tileNum),!i||this.tileSets.getSetNum(i.tileNum)!==h)return;if(!(i=this.findHighBridgeBoundary(i)))return;if(y!==this.tileSets.getOppositeHighBridgeHeadType(i.headType))return;T=i.tile}else{let t,i=1;for(var g=e.rx,p=e.ry;!t;){var m=this.tiles.getByMapCoords(g+u*i,p+d*i);if(!m)return;let e=this.getPieceAtTile(m);if(e&&e.obj.isXBridge()!==n)return;e?.headType===(f?c.End:c.Start)&&(t=e),i++}T=t.obj.tile}return{start:f?e:T,end:f?T:e,type:t,isHigh:o}}}findHighBridgeBoundary(e){var t,i=this.tileSets.getTile(e.tileNum),r=this.tileSets.getHighBridgeHeadType(i.index);if(void 0!==r){let i=0,s=0;switch(r){case a.HighBridgeHeadType.TopLeft:i=1,s=0;break;case a.HighBridgeHeadType.BottomRight:i=-1,s=0;break;case a.HighBridgeHeadType.TopRight:i=0,s=1;break;case a.HighBridgeHeadType.BottomLeft:i=0,s=-1;break;case a.HighBridgeHeadType.MiddleTlBr:i=1,s=0;break;case a.HighBridgeHeadType.MiddleTrBl:i=0,s=1;break;default:throw new Error(`Unhandled head type "${r}"`)}let l=new n.RadialTileFinder(this.tiles,this.mapBounds,e,{width:1,height:1},0,5,(t=>t.terrainType===o.TerrainType.Pavement&&t.z>=e.z&&t.tileNum===e.tileNum)),c=[];for(;t=l.getNextTile();)c.push(t);if(c.sort(((e,t)=>100*(i?i*(t.rx-e.rx):s*(t.ry-e.ry))+(i?e.ry-t.ry:e.rx-t.rx))),c.length)return{tile:c[0],headType:r}}else console.warn(`Couldn't find a valid bridge type for index "${i.index}" @ ${e.rx},`+e.ry)}canBeRepaired(e){let t,r=this.createBridgePieceTileFinder(e,(t=>!(this.getPieceAtTile(t)||this.tileSets.isHighBridgeMiddleTile(t.tileNum)&&t.z===e.start.z))),s=!1;for(var n=e.start.rx!==e.end.rx?i.TileDirection.BottomLeft:i.TileDirection.BottomRight;t=r.getNextTile();){s=!0;let i=this.tiles.getNeighbourTile(t,n),r=this.tiles.getNeighbourTile(i,n);if(e.isHigh){if([t,i,r].find((e=>this.tileOccupation.getGroundObjectsOnTile(e).some((e=>e.isBuilding()&&!e.rules.invisibleInGame)))))return!1}else if([t,i,r].find((e=>this.tileOccupation.getGroundObjectsOnTile(e).some((e=>!(e.isUnit()||e.isSmudge()||e.isOverlay()&&e.isBridgePlaceholder()))))))return!1}return s}getPieceTiles(e){var t=e.obj.tile,r=e.obj.isXBridge()?i.TileDirection.BottomLeft:i.TileDirection.BottomRight,s=this.tiles.getNeighbourTile(t,r);return[t,s,this.tiles.getNeighbourTile(s,r)]}findMapHighBridgeHeadTiles(){var e,t=this.tiles.getAllBridgeSetTiles();let i=new Set;for(e of t){var r=this.findHighBridgeBoundary(e);r&&i.add(r.tile)}return i}findBridgeSpecsForHeadTiles(e){let t=new Map;for(var i of e)(i=this.findClosestBridgeSpec(i))&&t.set(i.start.id+":"+i.end.id,i);return[...t.values()]}findAllBridgeTiles(e){let t=[];var r,s=e.start.rx!==e.end.rx?i.TileDirection.BottomLeft:i.TileDirection.BottomRight;for(r of this.findNonBuildablePieceTiles(e)){var n=this.tiles.getNeighbourTile(r,s),a=this.tiles.getNeighbourTile(n,s);t.push(r,n,a)}return t}findBridgePieces(e){let t=this.createBridgePieceTileFinder(e,(e=>!!this.getPieceAtTile(e))),i=[];for(var r;r=t.getNextTile();)i.push(this.getPieceAtTile(r));return i}findDestroyedPieceTiles(e){let t=this.createBridgePieceTileFinder(e,(t=>!(this.getPieceAtTile(t)||this.tileSets.isHighBridgeMiddleTile(t.tileNum)&&t.z===e.start.z))),i=[];for(var r;r=t.getNextTile();)i.push(r);return i}findNonBuildablePieceTiles(e){let t=this.createBridgePieceTileFinder(e,(t=>!(this.tileSets.isHighBridgeMiddleTile(t.tileNum)&&t.z===e.start.z))),i=[];for(var r;r=t.getNextTile();)i.push(r);return i}createBridgePieceTileFinder(e,t){var i=e.start.rx!==e.end.rx;return new s.DirectionalTileFinder(this.tiles,this.mapBounds,e.start,1,(i?e.end.rx-e.start.rx:e.end.ry-e.start.ry)-1,Number(i),Number(!i),t)}dispose(){this.pieces.forEach((e=>{e.prev=void 0,e.next=void 0})),this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}})}}})),System.register("util/QuadTree",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=new THREE.Vector2,e("QuadTree",class e{constructor(e,t){this.box=e,this.config=t,this.parentMap=new Map,this.objects=[]}add(e,t=!0){var i=this.config.getKey(e);if(this.box.containsPoint(i)){if(!this.regions)return this.parentMap.get(e)?.remove(e),this.parentMap.set(e,this),this.objects.push({key:i,value:e}),t&&this.update(),!0;for(var r of this.regions)if(r.add(e,t))return!0}return!1}remove(e,t=!0){let i=this.parentMap.get(e);i&&(i===this?(this.parentMap.delete(e),this.objects.splice(this.objects.findIndex((t=>t.value===e)),1),t&&this.parent?.update()):i.remove(e,t))}updateObject(e){let t=this.parentMap.get(e);if(t){var i=this.config.getKey(e);if(t.box.containsPoint(i))t.objects.find((t=>t.value===e)).key=i;else{t.remove(e,!1);let i=t.parent;for(;i&&!i.add(e,!1);)i=i.parent}}}queryRange(e,t=[]){if(this.box.intersectsBox(e))if(this.regions)for(var i of this.regions)i.queryRange(e,t);else for(var r of this.objects)e.containsPoint(r.key)&&t.push(r.value);return t}update(){let e=0;if(this.regions){for(var t of this.regions)e+=t.update();e<=this.config.joinThreshold&&this.join()}else e=this.objects.length,e>=this.config.splitThreshold&&this.split()&&this.update();return e}split(){if(this.regions||this.config.maxDepth<=1)return!1;var t,i,r={getKey:this.config.getKey,joinThreshold:this.config.joinThreshold,splitThreshold:this.config.splitThreshold,maxDepth:this.config.maxDepth-1},s=this.generateRegions(),n=this.objects;for(t of(this.objects=[],this.regions=[],s)){let i=new e(t,r);i.parentMap=this.parentMap,this.regions.push(i),i.parent=this}for(i of n)this.parentMap.delete(i.value),this.add(i.value,!1);return!0}join(){if(!this.regions)return!1;for(var e of this.regions)for(var t of(e.join(),e.parent=void 0,e.objects))this.objects.push(t),this.parentMap.set(t.value,this);return!(this.regions=void 0)}generateRegions(){let e=[this.box.clone()];var t=this.box.getCenter(i);let r=e[0],s=r.clone();r.max.x=t.x,s.min.x=t.x,e.push(s);for(let i=0,n=e.length;i<n;i++)r=e[i],s=r.clone(),r.max.y=t.y,s.min.y=t.y,e.push(s);return e}})}}})),System.register("game/map/TileOcclusion",["game/math/Vector2"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TileOcclusion",class{constructor(e){this.tiles=e,this.tileOcclusion=[];let t=this.tileOcclusion;for(var i of e.getAll())t[i.rx]=t[i.rx]||[],t[i.rx][i.ry]=new Set}addOccluder(e){this.calculateTilesForGameObject(e).forEach((t=>this.occludeTile(t,e)))}removeOccluder(e){this.calculateTilesForGameObject(e).forEach((t=>this.unoccludeTile(t,e)))}calculateTilesForGameObject(e){var t=e.art.occupyHeight,r=Math.max(0,t-2);let s=[];var n=e.getFoundation();for(let e=1;e<=r;e++)for(let t=0;t<n.width;t++)s.push(new i.Vector2(t-e,-e));for(let e=1;e<=r;e++)for(let t=1;t<n.height;t++)s.push(new i.Vector2(-e,t-e));s.push(...e.art.addOccupy);for(let{x:t,y:i}of e.art.removeOccupy){var a=s.findIndex((e=>e.x===t&&e.y===i));-1!==a&&s.splice(a,1)}var o,l,c=e.tile;let h=[];for({x:o,y:l}of s){var u=this.tiles.getByMapCoords(c.rx+o,c.ry+l);u&&h.push(u)}return h}occludeTile(e,t){this.tileOcclusion[e.rx][e.ry].add(t),e.occluded=!0}unoccludeTile(e,t){let i=this.tileOcclusion[e.rx][e.ry];i.delete(t),e.occluded=0<i.size}isTileOccluded(e){return 0<this.tileOcclusion[e.rx][e.ry].size}})}}})),System.register("game/theater/AutoLat",["game/map/TileCollection"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("AutoLat",class{static calculate(e,t){let r=new Map;e.forEach((e=>{var i=t.getSetNum(e.tileNum);r.set(e,i),t.isCLAT(i)&&(i=t.getLAT(i),r.set(e,i),e.tileNum=t.getTileNumFromSet(i))})),e.forEach((s=>{var n=r.get(s);if(t.isLAT(n)){let h=0;var a=e.getNeighbourTile(s,i.TileDirection.TopRight),o=e.getNeighbourTile(s,i.TileDirection.BottomRight),l=e.getNeighbourTile(s,i.TileDirection.BottomLeft),c=e.getNeighbourTile(s,i.TileDirection.TopLeft);a&&t.canConnectTiles(n,r.get(a))&&(h+=1),o&&t.canConnectTiles(n,r.get(o))&&(h+=2),l&&t.canConnectTiles(n,r.get(l))&&(h+=4),c&&t.canConnectTiles(n,r.get(c))&&(h+=8),0<h&&(c=t.getCLATSet(n),s.tileNum=t.getTileNumFromSet(c,h))}else if(n===t.getGeneralValue("RampBase")&&!(s.rampType<1||4<s.terrainType)){let r=-1;var h=e.getNeighbourTile(s,i.TileDirection.TopRight),u=e.getNeighbourTile(s,i.TileDirection.BottomRight),d=e.getNeighbourTile(s,i.TileDirection.BottomLeft),g=e.getNeighbourTile(s,i.TileDirection.TopLeft);switch(s.rampType){case 1:g&&0===g.rampType&&r++,u&&0===u.rampType&&(r+=2);break;case 2:h&&0===h.rampType&&r++,d&&0===d.rampType&&(r+=2);break;case 3:u&&0===u.rampType&&r++,g&&0===g.rampType&&(r+=2);break;case 4:d&&0===d.rampType&&r++,h&&0===h.rampType&&(r+=2)}-1!==r&&(s.tileNum=t.getTileNumFromSet(t.getGeneralValue("RampSmooth"),3*(s.rampType-1)+r))}}))}})}}})),System.register("game/math/Box2",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends THREE.Box2{},e("Box2",i)}}})),System.register("game/GameMap",["game/map/TileCollection","game/map/TileOccupation","game/map/Terrain","game/map/MapBounds","game/map/Bridges","util/QuadTree","game/map/TileOcclusion","game/theater/AutoLat","engine/TheaterType","game/math/Vector2","game/math/Box2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("GameMap",class{constructor(e,t,g,p){this.mapFile=e,this.tiles=new i.TileCollection(this.mapFile.tiles,t,g.general,p),this.mapBounds=(new n.MapBounds).fromMapFile(this.mapFile,this.tiles),this.tileOccupation=new r.TileOccupation(this.tiles),this.tileOcclusion=new l.TileOcclusion(this.tiles),this.terrain=new s.Terrain(this.tiles,this.mapFile.theaterType,this.mapBounds,this.tileOccupation,g),this.bridges=new a.Bridges(t,this.tiles,this.tileOccupation,this.mapBounds,g);let m=this.mapFile.tags;for(let e of this.mapFile.cellTags){let t=this.tiles.getByMapCoords(e.coords.x,e.coords.y);t&&(t.tag=m.find((t=>t.id===e.tagId)))}var f=this.tiles.getMapSize(),y=Math.max(f.width,f.height)/5;this.technosByTile=new o.QuadTree(new d.Box2(new u.Vector2(0,0),new u.Vector2(f.width,f.height)),{getKey:e=>{var t=e.isBuilding()?e.centerTile:e.tile;return new u.Vector2(t.rx,t.ry)},maxDepth:this.computeQuadDepth(y),splitThreshold:10,joinThreshold:5}),this.mapFile.theaterType!==h.TheaterType.Snow&&c.AutoLat.calculate(this.tiles,t)}get startingLocations(){return this.mapFile.startingLocations}computeQuadDepth(e){if(e<=1)return 1;let t=0;for(;1<=e/2;)e/=2,t++;return t+(1<e?1:0)}getLighting(){return this.mapFile.lighting}getIonLighting(){return this.mapFile.ionLighting}getTheaterType(){return this.mapFile.theaterType}getTags(){return this.mapFile.tags}getTriggers(){return this.mapFile.triggers}getCellTags(){return this.mapFile.cellTags}getVariables(){return this.mapFile.variables}getWaypoint(e){return this.mapFile.waypoints.find((t=>t.number===e))}getTileAtWaypoint(e){var t=this.getWaypoint(e);if(t&&(t=this.tiles.getByMapCoords(t.rx,t.ry)))return t}isWithinBounds(e){return this.mapBounds.isWithinBounds(e)}clampWithinBounds(e){var t=this.mapBounds.clampWithinBounds(e);let i=this.tiles.getByDisplayCoords(t.dx,t.dy);if(i&&this.mapBounds.isWithinBounds(i)){let e=i;for(;e&&this.mapBounds.isWithinBounds(e);)i=e,e=this.tiles.getByDisplayCoords(e.dx,e.dy+2)}else{let e=0;for(;!i||!this.mapBounds.isWithinBounds(i);){if(30<e)throw new Error("Exceeded max elevation while trying to clamp tile to map bounds");i=this.tiles.getByDisplayCoords(t.dx,t.dy+e),e+=2}}return i}isWithinHardBounds(e){return this.mapBounds.isWithinHardBounds(e)}getInitialMapObjects(){return{terrains:this.mapFile.terrains,overlays:this.mapFile.overlays,smudges:this.mapFile.smudges,technos:[...this.mapFile.structures,...this.mapFile.infantries,...this.mapFile.vehicles,...this.mapFile.aircrafts]}}getObjectsOnTile(e){return this.tileOccupation.getObjectsOnTile(e)}getGroundObjectsOnTile(e){return this.tileOccupation.getGroundObjectsOnTile(e)}getTileZone(e,t=!1){return this.tileOccupation.getTileZone(e,t)}dispose(){this.terrain.dispose(),this.bridges.dispose()}})}}})),System.register("game/gameobject/unit/MovePositionHelper",["game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("MovePositionHelper",class{constructor(e){this.map=e}findPositions(e,t,n){let a=new Map,o=this.clusterObjects(e);if(!o.length)throw new Error("We should have found at least one cluster");let l=o.reduce(((e,t)=>t.objects.size>e.objects.size?t:e),o[0]);o.splice(o.indexOf(l),1);let c=[],h=this.findCenterTile([...l.objects]);l.objects.forEach((e=>{var i=this.map.tiles.getByMapCoords(t.rx+e.tile.rx-h.rx,t.ry+e.tile.ry-h.ry),o=i?.onBridgeLandType?this.map.tileOccupation.getBridgeOnTile(i):void 0;if(!i||!this.map.mapBounds.isWithinBounds(i)||a.has(i)&&!this.tileHasRoom(e,a.get(i))||e.rules.movementZone===r.MovementZone.Fly&&!e.rules.airportBound&&!this.map.terrain.getPassableSpeed(i,s.SpeedType.Amphibious,!!o)||e.rules.movementZone!==r.MovementZone.Fly&&!this.isEligibleTile(i,o,n,t))c.push(e);else{let t=a.get(i);void 0===t&&(t=[],a.set(i,t)),t.push(e)}})),o.forEach((e=>c.push(...e.objects)));let u,d=new i.RadialTileFinder(this.map.tiles,this.map.mapBounds,t,{width:1,height:1},1,5,(()=>!0));for(;c.length&&(u=d.getNextTile());){var g=c[0],p=this.map.tileOccupation.getBridgeOnTile(u);if((!a.has(u)||this.tileHasRoom(g,a.get(u)))&&(g.rules.movementZone!==r.MovementZone.Fly||g.rules.airportBound||this.map.terrain.getPassableSpeed(u,s.SpeedType.Amphibious,!!p))&&(g.rules.movementZone===r.MovementZone.Fly||this.isEligibleTile(u,p,n,t))){let e=a.get(u);void 0===e&&(e=[],a.set(u,e)),e.push(c.shift())}}let m=new Map;if(a.forEach(((e,t)=>{e.forEach((e=>m.set(e,t)))})),c.forEach((e=>m.set(e,t))),m.size!==e.length)throw new Error("We should have computed a number of positions equal to the number of input objects");return m}tileHasRoom(e,t){if(e.isInfantry()){if(t.find((e=>!e.isInfantry())))return!1;var i=e.rules.movementZone===r.MovementZone.Fly?1:3;return!(t.filter((e=>e.isInfantry())).length>=i)}return!t.length}isEligibleTile(e,t,i,r){return i?.isHighBridge()||t?.isHighBridge()?e.z+(t?.tileElevation??0)===r.z+(i?.tileElevation??0):!(!i&&!t)||Math.abs(e.z-r.z)<2}clusterObjects(e){let t=new Map;e.forEach((e=>{var i=e.tile.rx+"_"+e.tile.ry;t.set(i,[...t.get(i)||[],e])}));let i=[],r=new Set(e);for(;r.size;){let e=new Set,a=[];var s=[...r][0].tile;for(t.get(s.rx+"_"+s.ry).forEach((e=>{a.push(e)}));a.length;){var n=a.shift();e.add(n),r.delete(n);for(let e=-1;e<=1;e++)for(let i=-1;i<=1;i++)if(e||i){let s=t.get(n.tile.rx+e+"_"+(n.tile.ry+i));s&&s.length&&s.forEach((e=>{r.has(e)&&(r.delete(e),a.push(e))}))}}i.push({objects:e})}return i}findCenterTile(e){let t=0,i=0;e.forEach((e=>{t+=e.tile.rx,i+=e.tile.ry})),t=Math.round(t/e.length),i=Math.round(i/e.length);let r=this.map.tiles.getByMapCoords(t,i);if(!r&&(r=e.find((e=>Math.abs(e.tile.rx-t)<=1&&Math.abs(e.tile.ry-i)<=1))?.tile,!r))throw new Error("At least one adjacent object should have been found");return r}})}}})),System.register("game/map/tileFinder/RandomTileFinder",["game/math/GameMath"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("RandomTileFinder",class{constructor(e,t,r,s,n,a,o=!1,l=!0){this.tiles=e,this.mapBounds=t,this.startTile=r,this.maxDistance=s,this.rng=n,this.predicate=a,this.includeStartTile=o,this.checkBounds=l,this.pool=[],this.pool=new Array(i.GameMath.pow(2*this.maxDistance+1,2)).fill(0).map(((e,t)=>t)),this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){for(var e=(e,t)=>{var i=this.tiles.getByMapCoords(e,t);if(this.includeStartTile||i!==this.startTile)return i&&(!this.checkBounds||this.mapBounds.isWithinBounds(i))&&this.predicate(i)?i:void 0},t=2*this.maxDistance+1;this.pool.length;){var i=1<this.pool.length?this.rng.generateRandomInt(0,this.pool.length):0,r=(i=(r=this.pool.splice(i,1)[0])%t,Math.floor(r/t));(r=e(this.startTile.rx-this.maxDistance+i,this.startTile.ry-this.maxDistance+r))&&(yield r)}}})}}})),System.register("game/gameobject/unit/ScatterPositionHelper",["game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RandomTileFinder"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ScatterPositionHelper",class{constructor(e){this.game=e,this.movePositionHelper=new i.MovePositionHelper(e.map)}findPositions(e,t){let i=new Set,r=new Map;for(var s of e){var n=this.findFreeMovePosition(s,i,t);n&&(r.set(s,n),i.add(n.tile))}return r}findFreeMovePosition(e,t,{ignoredBlockers:i,excludedTiles:s,noSlopes:n}={}){let a,o,l=this.game.map,c=e.onBridge?l.tileOccupation.getBridgeOnTile(e.tile):void 0,h=new r.RandomTileFinder(l.tiles,l.mapBounds,e.tile,1,this.game,(t=>{if(s?.includes(t))return!1;var i=l.tileOccupation.getBridgeOnTile(t);return(i&&this.movePositionHelper.isEligibleTile(t,i,c,e.tile)||this.movePositionHelper.isEligibleTile(t,void 0,c,e.tile))&&(!n||0===t.rampType)}));for(;;){var u=h.getNextTile();if(!u)break;if(a=u,o=l.tileOccupation.getBridgeOnTile(u),o&&!this.movePositionHelper.isEligibleTile(u,o,c,e.tile)&&(o=void 0),!t.has(u)){let t=l.terrain.findObstacles({tile:u,onBridge:o},e);if(i&&i.length&&(t=t.filter((e=>!i.includes(e.obj)))),!t.length)break}}if(a)return{tile:a,onBridge:o}}})}}})),System.register("game/gameobject/task/ScatterTask",["game/gameobject/task/move/MoveTask","game/gameobject/task/system/Task","game/gameobject/unit/ScatterPositionHelper","game/type/MovementZone"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends r.Task{constructor(e,t,i){super(),this.game=e,this.target=t,this.options=i}onStart(e){if(!e.moveTrait.isDisabled()&&e.rules.movementZone!==n.MovementZone.Fly){let r,n;if(this.target)({tile:r,toBridge:n}=this.target);else{var t=new s.ScatterPositionHelper(this.game).findPositions([e],this.options).get(e);if(!t)return;r=t.tile,n=!!t.onBridge}this.children.push(new i.MoveTask(this.game,r,n,{closeEnoughTiles:0,ignoredBlockers:this.options?.ignoredBlockers}))}}onTick(e){return!0}},e("ScatterTask",a)}}})),System.register("game/trait/interface/NotifyAttack",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onAttack=Symbol(),e("NotifyAttack",i)}}})),System.register("game/gameobject/unit/CollisionType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Ground=1]="Ground",t[t.Wall=2]="Wall",t[t.Cliff=3]="Cliff",t[t.OnBridge=4]="OnBridge",t[t.UnderBridge=5]="UnderBridge",t[t.Shore=6]="Shore",e("CollisionType",i)}}})),System.register("game/Target",["game/Coords","game/type/LandType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Target",class{constructor(e,t,i){this.tileOccupation=i,this.isOre=!1,e?e.isOverlay()&&e.isBridge()?(this.bridge=e,this.tile=t):e.isOverlay()&&e.isTiberium()?(this.isOre=!0,this.tile=e.tile):(this.obj=e,this.tile=e.isBuilding()?e.centerTile:e.tile):(t.landType===r.LandType.Tiberium&&(this.isOre=!0),this.tile=t)}equals(e){return this.obj===e.obj&&this.tile===e.tile&&this.bridge===e.bridge&&this.isOre===e.isOre}getWorldCoords(){return this.obj?this.obj.position.worldPosition:i.Coords.tile3dToWorld(this.tile.rx+.5,this.tile.ry+.5,this.tile.z+(this.bridge?.tileElevation??0))}isBridge(){return!this.obj&&!!this.bridge}getBridge(){return this.bridge||(this.obj?.isUnit()&&this.obj.onBridge?this.tileOccupation.getBridgeOnTile(this.obj.tile):void 0)}})}}})),System.register("game/math/geometry",["util/math","game/math/GameMath","game/math/Matrix4","game/math/Quaternion","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;function p(e){return e*THREE.Math.RAD2DEG}function m(e){return e*THREE.Math.DEG2RAD}function f(e){return Math.round(p(e.angle()))}function y(e,t){var s=p(2*r.GameMath.acos(Math.abs(i.clamp(e.dot(t),-1,1))));return Math.round(s)}function T(e,t=new n.Quaternion){return t.setFromRotationMatrix(c.lookAt(e,h,u))}return t&&t.id,e("radToDeg",p),e("degToRad",m),e("rotateVec2",(function(e,t){var i=m(Math.floor(t));return e.rotateAround(l,i)})),e("angleDegFromVec2",f),e("angleDegBetweenVec2",(function(e,t){var i=f(e),r=f(t);return Math.min((i-r+360)%360,(r-i+360)%360)})),e("angleDegBetweenVec3",(function(e,t){return y(T(e,d),T(t,g))})),e("quaternionFromVec3",T),e("rotateVec3Towards",(function(e,t,i){var r=e.length(),s=T(t,d),n=T(e,g);!function(e,t,i){var r=y(e,t);0!==r&&(r=Math.min(1,i/r),e.slerp(t,r))}(n,s,i),e.set(0,0,1).applyQuaternion(n).setLength(r)})),{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=new a.Vector2,c=new s.Matrix4,h=new o.Vector3(0,0,0),u=new o.Vector3(0,1,0),d=new n.Quaternion,g=new n.Quaternion}}})),System.register("game/gameobject/unit/FacingUtil",["game/math/Vector2","game/math/geometry"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("FacingUtil",class e{static tick(e,t,i){if(e===t)return{facing:e,delta:0};var r=(e-t+360)%360,s=(t-e+360)%360;return Math.min(r,s)<i?{facing:t,delta:0}:{facing:(e+(r=(s<=r?1:-1)*i)+360)%360,delta:r}}static fromMapCoords(e){return(-r.angleDegFromVec2(e)-90+720)%360}static toMapCoords(t){return r.rotateVec2(new i.Vector2(1e3,0),e.toWorldDeg(t)).round().normalize()}static toWorldDeg(e){return-(e+90)}})}}})),System.register("game/event/EventType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Cheer=0]="Cheer",t[t.UnitDeployUndeploy=1]="UnitDeployUndeploy",t[t.WeaponFire=2]="WeaponFire",t[t.ObjectDestroy=3]="ObjectDestroy",t[t.ObjectSpawn=4]="ObjectSpawn",t[t.ObjectUnspawn=5]="ObjectUnspawn",t[t.ObjectMorph=6]="ObjectMorph",t[t.ObjectLiftOff=7]="ObjectLiftOff",t[t.ObjectLand=8]="ObjectLand",t[t.ObjectCrashing=9]="ObjectCrashing",t[t.ObjectDisguiseChange=10]="ObjectDisguiseChange",t[t.ObjectCloakChange=11]="ObjectCloakChange",t[t.ObjectAttacked=12]="ObjectAttacked",t[t.ShipSubmergeChange=13]="ShipSubmergeChange",t[t.BridgeRepair=14]="BridgeRepair",t[t.BuildStatusChange=15]="BuildStatusChange",t[t.BuildingPlace=16]="BuildingPlace",t[t.BuildingFailedPlace=17]="BuildingFailedPlace",t[t.BuildingSell=18]="BuildingSell",t[t.BuildingRepairFull=19]="BuildingRepairFull",t[t.BuildingCapture=20]="BuildingCapture",t[t.BuildingInfiltration=21]="BuildingInfiltration",t[t.BuildingGarrison=22]="BuildingGarrison",t[t.BuildingEvacuate=23]="BuildingEvacuate",t[t.BuildingRepairStart=24]="BuildingRepairStart",t[t.UnitRepairStart=25]="UnitRepairStart",t[t.UnitRepairFinish=26]="UnitRepairFinish",t[t.UnitRecycle=27]="UnitRecycle",t[t.InflictDamage=28]="InflictDamage",t[t.HealthChange=29]="HealthChange",t[t.WarheadDetonate=30]="WarheadDetonate",t[t.PlayerDefeated=31]="PlayerDefeated",t[t.PlayerResigned=32]="PlayerResigned",t[t.PlayerDropped=33]="PlayerDropped",t[t.DeployNotAllowed=34]="DeployNotAllowed",t[t.PowerChange=35]="PowerChange",t[t.PowerLow=36]="PowerLow",t[t.PowerRestore=37]="PowerRestore",t[t.RadarOnOff=38]="RadarOnOff",t[t.ObjectOwnerChange=39]="ObjectOwnerChange",t[t.RadarEvent=40]="RadarEvent",t[t.InsufficientFunds=41]="InsufficientFunds",t[t.RallyPointChange=42]="RallyPointChange",t[t.PrimaryFactoryChange=43]="PrimaryFactoryChange",t[t.FactoryProduceUnit=44]="FactoryProduceUnit",t[t.ObjectTeleport=45]="ObjectTeleport",t[t.AllianceChange=46]="AllianceChange",t[t.UnitPromote=47]="UnitPromote",t[t.EnterTransport=48]="EnterTransport",t[t.LeaveTransport=49]="LeaveTransport",t[t.EnterObject=50]="EnterObject",t[t.EnterTile=51]="EnterTile",t[t.SuperWeaponReady=52]="SuperWeaponReady",t[t.SuperWeaponActivate=53]="SuperWeaponActivate",t[t.LightningStormManifest=54]="LightningStormManifest",t[t.LightningStormCloud=55]="LightningStormCloud",t[t.CratePickup=56]="CratePickup",t[t.PingLocation=57]="PingLocation",t[t.StalemateDetect=58]="StalemateDetect",t[t.TriggerSoundFx=59]="TriggerSoundFx",t[t.TriggerStopSoundFx=60]="TriggerStopSoundFx",t[t.TriggerEva=61]="TriggerEva",t[t.TriggerAnim=62]="TriggerAnim",t[t.TriggerText=63]="TriggerText",t[t.TimerExpire=64]="TimerExpire",e("EventType",i)}}})),System.register("game/event/WarheadDetonateEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WarheadDetonateEvent",class{constructor(e,t,r,s){this.target=e,this.position=t,this.explodeAnim=r,this.isLightningStrike=s,this.type=i.EventType.WarheadDetonate}})}}})),System.register("game/WeaponType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Primary=0]="Primary",t[t.Secondary=1]="Secondary",t[t.DeathWeapon=2]="DeathWeapon",e("WeaponType",i)}}})),System.register("game/gameobject/trait/TiberiumTrait",["game/map/OreOverlayTypes","engine/type/OverlayTibType","engine/type/TiberiumType","game/type/LandType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("TiberiumTrait",a=class e{constructor(e){this.gameObject=e}static canBePlacedOn(e,t){return[n.LandType.Clear,n.LandType.Road,n.LandType.Rough].includes(e.landType)&&!t.getGroundObjectsOnTile(e).find((e=>!e.isSmudge()&&!e.isUnit()))}getTiberiumType(){var e=i.OreOverlayTypes.getOverlayTibType(this.gameObject.overlayId);switch(e){case r.OverlayTibType.Ore:return s.TiberiumType.Ore;case r.OverlayTibType.Gems:return s.TiberiumType.Gems;case r.OverlayTibType.Vinifera:return s.TiberiumType.Ore;default:throw new Error("Unsupported tiberium type "+e)}}collectBail(){var e=this.getBailCount();if(e<=0)throw new Error("Attempted to collect an ore bail, but there are none left");return this.gameObject.value--,1<e?this.getTiberiumType():void 0}spawnBails(t){this.gameObject.value=Math.min(e.maxBails,this.gameObject.value+t)}removeBails(e){this.gameObject.value=Math.max(-1,this.gameObject.value-e)}getBailCount(){return this.gameObject.value+1}dispose(){this.gameObject=void 0}}),a.maxBails=11}}})),System.register("game/gameobject/common/AnimTerrainEffect",["engine/type/ObjectType","game/map/TileCollection","game/type/LandType","game/gameobject/trait/TiberiumTrait"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("AnimTerrainEffect",class{destroyOre(e,t,r){if(t.landType===s.LandType.Tiberium&&(r.art.hasObject(e,i.ObjectType.Animation)?r.art.getAnimation(e):void 0)?.crater){let i=r.map.getObjectsOnTile(t).find((e=>e.isOverlay()&&e.isTiberium()));if(i){var a=Math.ceil(n.TiberiumTrait.maxBails/2);a=e.startsWith("S_CLSN")?a:r.generateRandomInt(1,a);let t=i.traits.get(n.TiberiumTrait);t.removeBails(a),t.getBailCount()||r.unspawnObject(i)}}}spawnSmudges(e,t,n){if(t.landType===s.LandType.Clear&&0===t.rampType&&n.map.mapBounds.isWithinBounds(t)&&!n.map.getObjectsOnTile(t).find((e=>!e.isUnit()))){var a=n.art.hasObject(e,i.ObjectType.Animation)?n.art.getAnimation(e):void 0;if(a?.crater){let e=a?.forceBigCraters?2:1,s=a?.scorch,o=[r.TileDirection.Bottom,r.TileDirection.BottomLeft,r.TileDirection.BottomRight].every((e=>n.map.tiles.getNeighbourTile(t,e)));a=[...n.rules.smudgeRules.values()].filter((t=>(t.crater&&t.width===e&&t.height===e||s&&t.burn)&&!((1<t.width||1<t.height)&&!o))),a.length&&(a=a[n.generateRandomInt(0,a.length-1)].name,a=n.createObject(i.ObjectType.Smudge,a),n.spawnObject(a,t))}}}})}}})),System.register("game/event/ObjectAttackedEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectAttackedEvent",class{constructor(e,t,r){this.target=e,this.attacker=t,this.incidental=r,this.type=i.EventType.ObjectAttacked}})}}})),System.register("game/Warhead",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask","game/gameobject/task/ScatterTask","game/map/BridgeOverlayTypes","game/trait/interface/NotifyAttack","game/type/ArmorType","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Coords","util/math","game/gameobject/unit/FacingUtil","engine/type/ObjectType","game/event/WarheadDetonateEvent","game/WeaponType","game/rules/WeaponRules","data/IniSection","game/rules/ProjectileRules","game/gameobject/common/AnimTerrainEffect","game/event/ObjectAttackedEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){e("Warhead",E=class{constructor(e){this.rules=e}canDamage(e,t,i){return!(!e.isSpawned||e.isDisposed||e.isDestroyed||e.isCrashing||e.isTechno()&&e.warpedOutTrait.isInvulnerable()&&!this.rules.temporal||e.isUnit()&&e.moveTrait.reservedPathNodes.find((e=>e.tile===t))||!e.healthTrait||e.isUnit()&&e.zone===s.ZoneType.Air&&i!==s.ZoneType.Air||!e.isUnit()&&i===s.ZoneType.Air||e.isBuilding()&&e.rules.invisibleInGame||(e.isTechno()||e.isTerrain())&&e.rules.immune&&!this.rules.temporal||e.isTechno()&&!e.rules.warpable&&this.rules.temporal||this.rules.radiation&&(!e.isUnit()||e.rules.immuneToRadiation)||this.rules.psychicDamage&&(!e.isUnit()||e.rules.immuneToPsionics)||e.isOverlay()&&o.BridgeOverlayTypes.isLowBridgeHead(e.overlayId))}computeDamage(e,t,i=!1){let n=e;if(0<e&&t.isTechno()&&t.invulnerableTrait.isActive())return 0;if(t.isAircraft()&&t.missileSpawnTrait&&t.zone!==s.ZoneType.Air)return 0;if(this.rules.radiation||this.rules.temporal||!t.isInfantry()||t.stance!==r.StanceType.Prone||(n*=this.rules.proneDamage),t.isTechno()||t.isOverlay()||t.isTerrain()){let e=t.isTerrain()?c.ArmorType.Wood:t.rules.armor;var a;t.isOverlay()&&t.isBridge()&&((a=o.BridgeOverlayTypes.getOverlayBridgeType(t.overlayId))===o.OverlayBridgeType.Wood?e=c.ArmorType.Wood:a===o.OverlayBridgeType.Concrete&&(e=c.ArmorType.Concrete)),i&&t.isOverlay()&&(t.isBridge()||t.rules.wall)||(n*=this.rules.verses.get(e)),0<n&&t.isTechno()&&t.veteranTrait&&(n/=t.veteranTrait.getVeteranArmorMultiplier()),0<n&&t.isUnit()&&(n/=t.crateBonuses.armor)}return(t.isOverlay()||t.isBuilding())&&t.rules.wall&&(this.rules.wallAbsoluteDestroyer?n=Number.POSITIVE_INFINITY:this.rules.wall||this.rules.wood&&t.rules.armor===c.ArmorType.Wood||(n=0)),t.isOverlay()&&t.isBridge()&&(this.rules.wall||(n=0)),n=0<n?Math.floor(n):Math.ceil(n),n}inflictDamage(e,t,r,n,a=!1){let o=t.healthTrait;return e===Number.POSITIVE_INFINITY&&(e=o.getHitPoints()),o.inflictDamage(e,r,n),n.traits.filter(l.NotifyAttack).forEach((e=>{e[l.NotifyAttack.onAttack](t,r?.obj,n)})),t.onAttack(n,r),n.events.dispatch(new C.ObjectAttackedEvent(t,r,a)),t.isTechno()&&!this.rules.temporal&&this.supressOrScatterTarget(t,n),!o.health&&(t.isInfantry()&&(t.infDeathType=this.rules.infDeath),this.rules.temporal&&(t.deathType=i.DeathType.Temporal),t.isUnit()&&t.crashableTrait&&t.zone===s.ZoneType.Air&&!this.rules.temporal?t.crashableTrait.crash(r):n.destroyObject(t,r,void 0,a),!0)}supressOrScatterTarget(e,t){e.rules.fraidycat||e.isVehicle()&&!e.owner.isCombatant()&&e.rules.insignificant?e.unitOrderTrait.hasTasks()||(e.isInfantry()&&(e.isPanicked=!0),e.unitOrderTrait.addTask(new a.ScatterTask(t)),e.isInfantry()&&e.unitOrderTrait.addTask(new n.CallbackTask((()=>e.isPanicked=!1)).setCancellable(!1))):e.isInfantry()&&e.suppressionTrait?.supress()}createDummyWeaponInfo(){return{minRange:0,range:0,speed:Number.POSITIVE_INFINITY,type:T.WeaponType.Primary,rules:new v.WeaponRules(new b.IniSection("Dummy")),projectileRules:new S.ProjectileRules(f.ObjectType.Projectile,new b.IniSection("Dummy")),warhead:this}}detonate(e,t,i,r,n,a,o,l,c,f,T,v,b,S=!1){var C,E,x,O=c?.weapon??this.createDummyWeaponInfo(),A=c?.obj,M=c?.player,R=b?b/g.Coords.LEPTONS_PER_TILE:this.rules.cellSpread,P=this.rules.percentAtMax;let I=new Set,k=new Map,B=new u.RangeHelper(e.map.tileOccupation),j=new d.RadialTileFinder(e.map.tiles,e.map.mapBounds,i,{width:1,height:1},0,Math.ceil(R),(()=>!0));for(;C=j.getNextTile();)for(E of e.map.getObjectsOnTile(C))if((!I.has(E)||E.isBuilding())&&(o!==h.CollisionType.UnderBridge||!E.isUnit()||!E.onBridge)&&!(A&&E.isTechno()&&E.rules.typeImmune&&E.owner===M&&E.name===A.name)&&this.canDamage(E,C,a)&&(!E.isOverlay()||!(!o&&.1<Math.abs(E.tileElevation-r)||o===h.CollisionType.OnBridge&&!E.isBridge()))){let t=E.isBuilding()?C===i?0:B.distance3(C,n)/g.Coords.LEPTONS_PER_TILE:E.isTerrain()||E.isOverlay()?B.distance3(C,i)/g.Coords.LEPTONS_PER_TILE:B.distance3(E,n)/g.Coords.LEPTONS_PER_TILE;if(t<.001&&(t=0),!(f&&E.isInfantry()&&M)||E.owner!==M&&!e.alliances.areAllied(E.owner,M)){if(!R)if(E.isTerrain()){if(C!==i||!this.rules.wall)continue}else if(!f&&(C!==i||!E.isBuilding()&&E!==(l.obj||l.getBridge())))continue;R&&t>R||(I.add(E),k.set(E,E.isBuilding()?(k.get(E)||[]).concat(t):[t]))}}let N,L=!1;for(x of I)if(!x.isDestroyed&&!x.isCrashing){var D,F=this.computeDamage(t,x,T);if(F)for(var _ of k.get(x)){let t=F;if(0<R&&Number.isFinite(t)&&(t=p.lerp(t,P*t,_/R)),Math.abs(t)<1&&(!R||.25<=t/F)&&(t=+Math.sign(t)),t=0<t?Math.floor(t):Math.ceil(t),t){let i=x.healthTrait;if(t<0){if(!A)throw new Error("Expected healer object to be set");if(i.healBy(-t,A,e),100===i.health)break}else{if(x===l.obj&&_<1&&(N=x),this.inflictDamage(t,x,c,e,!N))break;x.isVehicle()&&this.rules.rocker&&0<(D=p.clamp(F/300,0,1))&&(_=m.FacingUtil.fromMapCoords(x.position.getMapPosition().clone().sub(g.Coords.vecWorldToGround(n)))-x.direction,x.applyRocking(_,D))}}}else x.isTechno()&&x.invulnerableTrait.isActive()&&(L=!0)}if((O=O.rules.radLevel)&&R&&e.mapRadiationTrait.createRadSite(i,O,R+1),O=S?void 0:L?e.rules.audioVisual.weaponNullifyAnim:this.pickExplodeAnim(t,N,a,e,T),!L&&a===s.ZoneType.Ground){let t=new w.AnimTerrainEffect;O&&t.destroyOre(O,i,e),v&&t.spawnSmudges(v,i,e),O&&t.spawnSmudges(O,i,e)}e.events.dispatch(new y.WarheadDetonateEvent(this,n,O,T))}pickExplodeAnim(e,t,i,r,n){if(e){if(n)return r.rules.audioVisual.weatherConBoltExplosion;if(this.rules.conventional&&i===s.ZoneType.Water&&(!t||t.isBuilding()||t.isVehicle()&&t.submergibleTrait)){var a=r.rules.combatDamage.splashList;return a[p.clamp(Math.floor(e/50),0,a.length-1)]}let o;return(a=this.rules.animList.length)?(o=r.rules.combatDamage.c4Warhead===this.rules.name?a-1:this.rules.emEffect?r.generateRandomInt(0,a-1):p.clamp(Math.floor(e/25),0,a-1),this.rules.animList[o]):void 0}}}),E.SPECIAL_WARHEAD_NAME="Special",E.HE_WARHEAD_NAME="HE"}}})),System.register("game/WeaponInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameobject/unit/RangeHelper",["game/Coords","util/math","game/gameobject/unit/ZoneType","game/type/MovementZone","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=e=>void 0!==e.position,l=e=>void 0!==e.addScalar,e("RangeHelper",class{constructor(e){this.tileOccupation=e}isInWeaponRange(e,t,i,r,s){var a=s??e;if(i.rules.limboLaunch&&2<Math.abs((o(a)?a.position.tileElevation+a.tile.z:a.z)-(o(t)?t.position.tileElevation+t.tile.z:t.z)))return!1;var{minRange:l,range:c}=this.computeWeaponRangeVsTarget(a,t,i,r);return i.rules.cellRangefinding?this.isInTileRange(a,t,l,c):e.isUnit()&&e.rules.movementZone===n.MovementZone.Fly?this.isInRange2(a,t,l,c):this.isInRange3(a,t,l,c)}computeWeaponRangeVsTarget(e,t,i,r){let n=0;var a,l;return!o(t)||!t.isBuilding()||i.projectileRules.arcing||i.projectileRules.vertical||i.warhead.rules.ivanBomb||1<(l=t.getFoundation()).width&&1<l.height&&(n+=Math.ceil(Math.min(l.width,l.height)/2)),!i.projectileRules.subjectToElevation||i.projectileRules.arcing&&!o(t)||(a=o(e)?e.tile.z+e.tileElevation:e.z,(l=o(t)?t.tile.z+t.tileElevation:t.z)<a&&(n+=r.elevationModel.getBonus(a,l))),i.projectileRules.isAntiAir&&o(e)&&e.isTechno()&&o(t)&&t.isUnit()&&t.zone===s.ZoneType.Air&&(n+=e.rules.airRangeBonus),{minRange:i.minRange,range:i.range+n}}isInRange(e,t,i,r,s=!1){return s?this.isInTileRange(e,t,i,r):e.isUnit()&&e.rules.movementZone===n.MovementZone.Fly?this.isInRange2(e,t,i,r):this.isInRange3(e,t,i,r)}isInRange3(e,t,s,n){return r.isBetween(this.distance3(e,t)/i.Coords.LEPTONS_PER_TILE,s,n)}isInRange2(e,t,s,n){return r.isBetween(this.distance2(e,t)/i.Coords.LEPTONS_PER_TILE,s,n)}distance3(e,t){let r=o(e)?e.position.worldPosition:l(e)?e:i.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z);var s=o(t)?t.position.worldPosition:l(t)?t:i.Coords.tile3dToWorld(t.rx+.5,t.ry+.5,t.z);return r.distanceTo(s)}distance2(e,t){let r=o(e)?new a.Vector2(e.position.worldPosition.x,e.position.worldPosition.z):l(e)?new a.Vector2(e.x,e.z):new a.Vector2(e.rx+.5,e.ry+.5).multiplyScalar(i.Coords.LEPTONS_PER_TILE);var s=o(t)?new a.Vector2(t.position.worldPosition.x,t.position.worldPosition.z):l(t)?new a.Vector2(t.x,t.z):new a.Vector2(t.rx+.5,t.ry+.5).multiplyScalar(i.Coords.LEPTONS_PER_TILE);return r.distanceTo(s)}isInTileRange(e,t,i,s){return r.isBetween(this.tileDistance(e,t),i,s)}tileDistance(e,t){var i,r=o(e)?this.tileOccupation.calculateTilesForGameObject(e.tile,e):Array.isArray(e)?e:[e],s=o(t)?this.tileOccupation.calculateTilesForGameObject(t.tile,t):Array.isArray(t)?t:[t];let n=new a.Vector2,l=new a.Vector2,c=Number.POSITIVE_INFINITY;for(i of r)for(var h of s)n.set(i.rx,i.ry),l.set(h.rx,h.ry),(h=n.distanceTo(l))<=c&&(c=h);return c}})}}})),System.register("game/gameobject/task/TurnTask",["game/gameobject/task/system/Task","game/gameobject/unit/FacingUtil"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.Task{constructor(e){super(),this.direction=e,this.cancellable=!1}onTick(e){if(e.direction===this.direction)return!(e.spinVelocity=0);var t=e.rules.rot,{facing:i,delta:t}=r.FacingUtil.tick(e.direction,this.direction,t);return e.direction=i,e.spinVelocity=t,!1}},e("TurnTask",s)}}})),System.register("game/gameobject/task/system/WaitTicksTask",["game/gameobject/task/system/Task"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.Task{constructor(e){super(),this.ticks=e}onTick(){return!(!this.isCancelling()&&0<this.ticks--)}},e("WaitTicksTask",r)}}})),System.register("game/GameSpeed",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("GameSpeed",i=class e{static computeGameSpeed(t){let i;return i=6===t?60:5===t?45:60/(6-t),i/e.BASE_TICKS_PER_SECOND}}),i.BASE_TICKS_PER_SECOND=15}}})),System.register("game/gameobject/task/system/WaitMinutesTask",["game/gameobject/task/system/WaitTicksTask","game/GameSpeed"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.WaitTicksTask{constructor(e){super(Math.floor(r.GameSpeed.BASE_TICKS_PER_SECOND*e*60))}},e("WaitMinutesTask",s)}}})),System.register("game/type/LocomotorType",["game/type/SpeedType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Statue=0]="Statue",t[t.Aircraft=1]="Aircraft",t[t.Chrono=2]="Chrono",t[t.Hover=3]="Hover",t[t.Infantry=4]="Infantry",t[t.Jumpjet=5]="Jumpjet",t[t.Missile=6]="Missile",t[t.Ship=7]="Ship",t[t.Vehicle=8]="Vehicle",e("LocomotorType",r),e("locomotorTypesByClsId",new Map([["{4A582746-9839-11d1-B709-00A024DDAFD1}",r.Aircraft],["{4A582747-9839-11d1-B709-00A024DDAFD1}",r.Chrono],["{4A582742-9839-11d1-B709-00A024DDAFD1}",r.Hover],["{4A582744-9839-11d1-B709-00A024DDAFD1}",r.Infantry],["{92612C46-F71F-11d1-AC9F-006008055BB5}",r.Jumpjet],["{B7B49766-E576-11d3-9BD9-00104B972FE8}",r.Missile],["{2BEA74E1-7CCA-11d3-BE14-00104B62A16C}",r.Ship],["{4A582741-9839-11d1-B709-00A024DDAFD1}",r.Vehicle]])),e("defaultSpeedsByLocomotor",new Map([[r.Infantry,i.SpeedType.Foot],[r.Ship,i.SpeedType.Float],[r.Hover,i.SpeedType.Hover],[r.Jumpjet,i.SpeedType.Winged],[r.Aircraft,i.SpeedType.Winged],[r.Missile,i.SpeedType.Winged]]))}}})),System.register("game/gameobject/task/harvester/TeleportMoveToRefineryTask",["game/gameobject/task/move/MoveTask","game/type/LocomotorType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends i.MoveTask{constructor(e,t,i,r){super(e,i??t,!1,{closeEnoughTiles:i?void 0:0,strictCloseEnough:!i}),this.teleportTile=t,this.teleportCondition=r}onStart(e){if(super.onStart(e),!e.harvesterTrait||e.rules.locomotor!==r.LocomotorType.Chrono)throw new Error(`Vehicle ${e.name} is not a chrono miner`)}onTick(e){return!e.moveTrait.isDisabled()&&(!(this.isCancelling()||e.moveTrait.moveState!==s.MoveState.ReachedNextWaypoint||e.tile===this.teleportTile||!this.tryTeleportToRefinery(e))||!0===super.onTick(e)&&(this.isCancelling()||e.tile===this.teleportTile||this.tryTeleportToRefinery(e),!0))}tryTeleportToRefinery(e){return!(this.teleportCondition&&!1===this.teleportCondition(e,this.teleportTile)||this.game.map.terrain.findObstacles({tile:this.teleportTile,onBridge:void 0},e).length||(e.moveTrait.teleportUnitToTile(this.teleportTile,void 0,!0,!0,this.game),e.zone===n.ZoneType.Air&&(e.zone=n.ZoneType.Ground,e.position.tileElevation=0),0))}},e("TeleportMoveToRefineryTask",a)}}})),System.register("game/gameobject/task/harvester/GatherOreTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/HarvesterTrait","game/type/LandType","game/gameobject/task/move/MoveTask","game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/unit/RangeHelper","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=[[8,5,6],[3,0,2],[7,4,1]],f=class extends i.Task{constructor(e,t,i=!1){super(),this.game=e,this.initialTarget=t,this.explicitOrder=i,this.forceMoveTried=!1,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new u.RangeHelper(e.map.tileOccupation),this.scanNearRadius=e.rules.ai.tiberiumNearScan,this.scanFarRadius=e.rules.ai.tiberiumFarScan,this.strictTarget=i}onStart(e){if(!e.isVehicle()||!e.harvesterTrait)throw new Error(`Unit ${e.name} is not a harvester.`);e.harvesterTrait.status=s.HarvesterStatus.MovingToOreSite,e.harvesterTrait.lastGatherExplicit=this.explicitOrder}onEnd(e){e.harvesterTrait.status!==s.HarvesterStatus.LookingForOreSite&&(e.harvesterTrait.status=s.HarvesterStatus.Idle)}onTick(e){if(this.isCancelling())return!0;let t=e.harvesterTrait;if(t.status===s.HarvesterStatus.MovingToOreSite){if(this.target=this.initialTarget?.landType===n.LandType.Tiberium?this.initialTarget:this.findClosestReachableOreSite(e,t.lastOreSite??e.tile,!0),t.lastOreSite=this.target,!this.target){t.status=s.HarvesterStatus.LookingForOreSite;let i=this.getRefineryOnTile(e.tile);if(i&&1===e.unitOrderTrait.getTasks().length){let t=e.rules.movementZone===p.MovementZone.Fly;(h=new r.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,i.tile,i.getFoundation(),1,5,(i=>t||0<this.game.map.terrain.getPassableSpeed(i,e.rules.speedType,!1)&&Math.abs(i.z-e.tile.z)<2&&!this.game.map.terrain.findObstacles({tile:i,onBridge:void 0},e).length)).getNextTile())&&e.unitOrderTrait.addTasks(new a.MoveTask(this.game,h,!1),new d.CallbackTask((()=>{[g.MoveResult.Success,g.MoveResult.CloseEnough,g.MoveResult.Cancel].includes(e.moveTrait.lastMoveResult)||this.children.push(new c.WaitMinutesTask(1/60))})))}return!0}var i=this.game.rules.general.closeEnough,h=this.rangeHelper.tileDistance(e.tile,this.target)<=i;if(e.tile!==this.target&&(e.tile.landType!==n.LandType.Tiberium||!h||this.strictTarget)){if(e.tile!==this.target&&h&&e.tile.landType!==n.LandType.Tiberium)if(h=this.findClosestReachableOreSite(e,e.tile,!1,!0))this.target=h,t.lastOreSite=this.target;else{if(!this.forceMoveTried)return this.forceMoveTried=!0,this.children.push(new a.MoveTask(this.game,this.target,!1,{closeEnoughTiles:0,strictCloseEnough:!0})),!1;if(this.forceMoveTried=!1,!t.isEmpty())return this.returnOreIfPossible(e),!0;if(!(h=this.findClosestReachableOreSite(e,e.tile,!0,!0)))return t.status=s.HarvesterStatus.LookingForOreSite,!0;this.target=h,t.lastOreSite=this.target}return this.children.push(new a.MoveTask(this.game,this.target,!1,{closeEnoughTiles:i}),new d.CallbackTask((()=>{[g.MoveResult.Success,g.MoveResult.CloseEnough,g.MoveResult.Cancel].includes(e.moveTrait.lastMoveResult)||this.children.push(new c.WaitMinutesTask(5/60))}))),!1}this.target=e.tile,t.lastOreSite=this.target,t.status=s.HarvesterStatus.Harvesting,this.forceMoveTried=!1,this.strictTarget=!1}if(t.status!==s.HarvesterStatus.Harvesting)return!1;{if(t.isFull())return this.returnOreIfPossible(e),!0;let r=this.game.map.getObjectsOnTile(e.tile).find((e=>e.isOverlay()&&e.isTiberium()));if(!r)return this.findClosestReachableOreSite(e,t.lastOreSite??e.tile,!1)||t.isEmpty()?(t.status=s.HarvesterStatus.MovingToOreSite,this.onTick(e)):(this.returnOreIfPossible(e),!0);let n=r.traits.get(o.TiberiumTrait);if(i=n.collectBail(),n.getBailCount()||this.game.unspawnObject(r),void 0!==i)if(i===l.TiberiumType.Ore)t.ore++;else{if(i!==l.TiberiumType.Gems)throw new Error("Unsupported tiberium type "+i);t.gems++}return![...e.owner.buildings].some((e=>e.rules.refinery))&&!this.explicitOrder||(this.children.push(new c.WaitMinutesTask(1/60)),!1)}}findClosestReachableOreSite(e,t,i,s=!1){let a=e.rules.movementZone===p.MovementZone.Fly;var o,l=t=>t.landType===n.LandType.Tiberium&&(!s||a||!this.game.map.terrain.findObstacles({tile:t,onBridge:void 0},e).length);if(l(t))return t;let c=1;if(!i){let e=new r.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,t,{width:1,height:1},c,c,l),i=[];for(;o=e.getNextTile();)i.push(o);if(i.length){let e=i.map((e=>{var t=this.game.map.getObjectsOnTile(e).find((e=>e.isOverlay()&&e.isTiberium()));if(!t)throw new Error(`Ore should exist on tile ${e.rx},${e.ry} b/c of landType`);return{tile:e,ore:t}}));return e.sort(((e,i)=>1e3*(i.ore.value-e.ore.value)+(m[1+i.tile.ry-t.ry][1+i.tile.rx-t.rx]-m[1+e.tile.ry-t.ry][1+e.tile.rx-t.rx]))),e[0].tile}c=2}var h=i?this.scanFarRadius:this.scanNearRadius;return new r.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,t,{width:1,height:1},c,h,l).getNextTile()}getRefineryOnTile(e){return this.game.map.getObjectsOnTile(e).find((e=>e.isBuilding()&&e.rules.refinery))}returnOreIfPossible(e){1===e.unitOrderTrait.getTasks().length&&e.unitOrderTrait.addTask(new h.ReturnOreTask(this.game))}getTargetLinesConfig(e){return{pathNodes:this.initialTarget?[{tile:this.initialTarget,onBridge:void 0}]:[]}}},e("GatherOreTask",f)}}})),System.register("game/gameobject/task/harvester/ReturnOreTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","engine/type/TiberiumType","game/gameobject/trait/HarvesterTrait","game/gameobject/task/harvester/TeleportMoveToRefineryTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class extends i.Task{constructor(e,t,i=!1,s=!1){super(),this.game=e,this.forceTarget=t,this.resetLastOreSite=i,this.explicitOrder=s,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.rangeHelper=new r.RangeHelper(e.map.tileOccupation)}onStart(e){if(!e.isVehicle()||!e.harvesterTrait)throw new Error(`Unit ${e.name} is not a harvester.`);e.harvesterTrait.status=c.HarvesterStatus.MovingToRefinery,this.resetLastOreSite&&(e.harvesterTrait.lastOreSite=void 0)}onEnd(e){this.target?.isSpawned&&(this.target.dockTrait.undockUnit(e),this.target.dockTrait.unreserveDockForUnit(e)),e.harvesterTrait.status!==c.HarvesterStatus.LookingForRefinery&&(e.harvesterTrait.status=c.HarvesterStatus.Idle)}onTick(e){if(this.isCancelling())return!0;let t=e.harvesterTrait;if(t.status===c.HarvesterStatus.LookingForRefinery)return!0;if(t.status===c.HarvesterStatus.MovingToRefinery){if(!this.target||!this.isValidTargetRefinery(this.target,e)||e.tile!==this.findRefineryDockingTile(this.target)){var i=this.forceTarget??this.findClosestReachableRefinery(e);if(!i)return t.status=c.HarvesterStatus.LookingForRefinery,!0;this.target&&this.target!==i&&this.target.dockTrait.hasReservedDockForUnit(e)&&this.target.dockTrait.unreserveDockForUnit(e),this.target=i}let a=this.target.dockTrait.getFirstAvailableDockNumber(),l=!1;void 0===a&&(a=this.target.dockTrait.getFirstEmptyDockNumber(),void 0!==a&&(l=!this.target.dockTrait.hasReservedDockForUnit(e)));let u=this.findRefineryDockingTile(this.target);var r=this.rangeHelper.tileDistance(e,u);if(void 0===a||l||r>this.game.rules.general.harvesterTooFarDistance&&!this.explicitOrder){var s=this.findReachableQueueingTile(e);return!s||(e.tile!==s&&this.children.push(e.rules.teleporter?new h.TeleportMoveToRefineryTask(this.game,u,s,(()=>this.chronoMinerCanTeleport(e,u,this.target))):new n.MoveTask(this.game,s,!1),new d.CallbackTask((()=>{e.moveTrait.lastMoveResult===g.MoveResult.Fail?t.status=c.HarvesterStatus.LookingForRefinery:e.moveTrait.lastMoveResult===g.MoveResult.CloseEnough?this.children.push(new o.WaitMinutesTask(5/60)):e.moveTrait.lastMoveResult===g.MoveResult.Success&&this.children.push(new o.WaitMinutesTask(2/60))}))),!1)}if(this.target.dockTrait.hasReservedDockForUnit(e)||this.target.dockTrait.reserveDockAt(e,a),void 0===this.reservedDockNumber&&(this.reservedDockNumber=this.target.dockTrait.getReservedDockForUnit(e)),e.tile!==u)return this.children.push(e.rules.teleporter?new h.TeleportMoveToRefineryTask(this.game,u,void 0,(()=>this.chronoMinerCanTeleport(e,u,this.target))):new n.MoveTask(this.game,u,!1,{closeEnoughTiles:0,strictCloseEnough:!0}),new d.CallbackTask((()=>{e.moveTrait.lastMoveResult===g.MoveResult.Fail&&(t.status=c.HarvesterStatus.LookingForRefinery)}))),!1;t.status=c.HarvesterStatus.Docking}if(!this.isValidTargetRefinery(this.target,e))return t.status=c.HarvesterStatus.MovingToRefinery,this.forceTarget=void 0,this.onTick(e);if(t.status===c.HarvesterStatus.Docking){if(270!==e.direction)return this.children.push(new a.TurnTask(270)),!1;this.target.dockTrait.dockUnitAt(e,this.reservedDockNumber),this.reservedDockNumber=void 0,t.status=c.HarvesterStatus.PreparingToUnload}return t.status===c.HarvesterStatus.PreparingToUnload?(this.preventOpportunityFire=!0,this.children.push(new o.WaitMinutesTask(2/60)),t.status=c.HarvesterStatus.Unloading,!1):t.status===c.HarvesterStatus.Unloading&&(i=t.ore*this.game.rules.getTiberium(l.TiberiumType.Ore).value+t.gems*this.game.rules.getTiberium(l.TiberiumType.Gems).value,this.target.owner.credits+=i,r=[...this.target.owner.buildings].filter((e=>e.rules.orePurifier&&(!e.poweredTrait||!this.target.owner.powerTrait?.isLowPower()))).length,s=this.game.rules.general.purifierBonus,this.target.owner.credits+=r*Math.floor(i*s),t.ore=0,t.gems=0,1===e.unitOrderTrait.getTasks().length&&e.unitOrderTrait.addTask(new u.GatherOreTask(this.game)),!0)}isValidTargetRefinery(e,t){return e.isSpawned&&this.game.areFriendly(e,t)&&!e.warpedOutTrait.isActive()}findClosestReachableRefinery(e){let t=this.rangeHelper,i=[...e.owner.buildings].filter((e=>e.rules.refinery&&e.dockTrait&&!e.warpedOutTrait.isActive())).sort(((i,r)=>t.distance2(e,i)-t.distance2(e,r)));var r=i[0],s=i.find((e=>0<e.dockTrait.getAvailableDockCount()));return!s||r&&t.tileDistance(e,s.centerTile)-t.tileDistance(e,r.centerTile)>this.game.rules.general.harvesterTooFarDistance?r:s}findReachableQueueingTile(e){if(this.target.art.queueingCell){var t=new m.Vector2(this.target.tile.rx,this.target.tile.ry).add(this.target.art.queueingCell);if((t=this.game.map.tiles.getByMapCoords(t.x,t.y))&&this.isValidQueueingTile(t,e))return t}return new s.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,(t=>this.isValidQueueingTile(t,e))).getNextTile()}isValidQueueingTile(e,t){return t.zone===p.ZoneType.Air||0<this.game.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&Math.abs(e.z-this.target.tile.z)<2&&!e.onBridgeLandType}findRefineryDockingTile(e){var t={x:e.tile.rx+e.getFoundation().width-1,y:e.tile.ry+Math.floor(e.getFoundation().height/2)};return this.game.map.tiles.getByMapCoords(t.x,t.y)}chronoMinerCanTeleport(e,t,i){var r=this.rangeHelper.tileDistance(e,t);return!(!this.forceTarget&&r>this.game.rules.general.chronoHarvTooFarDistance||r<=1||!this.isValidTargetRefinery(i,e)||0===i.dockTrait.getAvailableDockCount()&&!i.dockTrait.hasReservedDockForUnit(e))}},e("ReturnOreTask",f)}}})),System.register("game/gameobject/trait/interface/NotifySpawn",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onSpawn=Symbol(),e("NotifySpawn",i)}}})),System.register("game/gameobject/trait/interface/NotifyTeleport",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onBeforeTeleport=Symbol(),e("NotifyTeleport",i)}}})),System.register("game/gameobject/trait/interface/NotifyOrder",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onPush=Symbol(),e("NotifyOrder",i)}}})),System.register("game/gameobject/trait/HarvesterTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/harvester/ReturnOreTask","game/gameobject/task/harvester/GatherOreTask","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder","game/order/OrderType","game/type/LandType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var t;(t=d=d||{})[t.Idle=0]="Idle",t[t.LookingForOreSite=1]="LookingForOreSite",t[t.MovingToOreSite=2]="MovingToOreSite",t[t.Harvesting=3]="Harvesting",t[t.LookingForRefinery=4]="LookingForRefinery",t[t.MovingToRefinery=5]="MovingToRefinery",t[t.Docking=6]="Docking",t[t.PreparingToUnload=7]="PreparingToUnload",t[t.Unloading=8]="Unloading",e("HarvesterStatus",d),g=class{constructor(e){this.storage=e,this.ore=0,this.gems=0,this.status=d.Idle,this.lastGatherExplicit=!1,this.autoGatherOnNextIdle=!1,this.ticksSinceLastRefineryCheck=0,this.ticksSinceLastOreCheck=0}[n.NotifySpawn.onSpawn](e,t){e.owner.isCombatant()&&t.afterTick((()=>{e.unitOrderTrait.addTask(new s.GatherOreTask(t))}))}[a.NotifyOwnerChange.onChange](e,t,i){!t.isCombatant()&&e.owner.isCombatant()&&i.afterTick((()=>{e.unitOrderTrait.addTask(new s.GatherOreTask(i))}))}[i.NotifyTick.onTick](e,t){this.status===d.LookingForRefinery?this.ticksSinceLastRefineryCheck++>5*o.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastRefineryCheck=0,e.unitOrderTrait.hasTasks()?this.ticksSinceLastRefineryCheck=-25*o.GameSpeed.BASE_TICKS_PER_SECOND:[...e.owner.buildings].some((e=>e.rules.refinery))||this.lastGatherExplicit?e.unitOrderTrait.addTask(new r.ReturnOreTask(t)):this.status=d.Idle):this.status===d.LookingForOreSite?this.ticksSinceLastOreCheck++>20*o.GameSpeed.BASE_TICKS_PER_SECOND&&(this.ticksSinceLastOreCheck=0,e.unitOrderTrait.hasTasks()||e.unitOrderTrait.addTask(new s.GatherOreTask(t))):this.status===d.Idle&&this.autoGatherOnNextIdle&&e.unitOrderTrait.isIdle()&&e.tile.landType===u.LandType.Tiberium&&(this.autoGatherOnNextIdle=!1,e.unitOrderTrait.addTask(new s.GatherOreTask(t,e.tile,!0)))}[l.NotifyTeleport.onBeforeTeleport](e,t,i,n){!n&&e.owner.isCombatant()&&(this.status=d.Idle,this.lastOreSite=void 0,i&&e.rules.teleporter&&t.afterTick((()=>{e.unitOrderTrait.addTask(new(this.isFull()?r.ReturnOreTask:s.GatherOreTask)(t))})))}[c.NotifyOrder.onPush](e,t){this.autoGatherOnNextIdle=[h.OrderType.AttackMove,h.OrderType.Move,h.OrderType.ForceMove,h.OrderType.Scatter].includes(t),[d.LookingForRefinery,d.LookingForOreSite].includes(this.status)&&(this.status=d.Idle)}isFull(){return this.ore+this.gems>=this.storage}isEmpty(){return!this.ore&&!this.gems}getHash(){return 100*this.ore+this.gems}debugGetState(){return{ore:this.ore,gems:this.gems}}},e("HarvesterTrait",g)}}})),System.register("game/gameobject/trait/interface/NotifyDestroy",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onDestroy=Symbol(),e("NotifyDestroy",i)}}})),System.register("game/event/LeaveTransportEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("LeaveTransportEvent",class{constructor(e){this.target=e,this.type=i.EventType.LeaveTransport}})}}})),System.register("game/gameobject/trait/TransportTrait",["util/math","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/task/ScatterTask","game/event/LeaveTransportEvent","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class{constructor(e){this.obj=e,this.units=[],this.loadQueue=[]}unitFitsInside(e){return e.rules.size<=this.obj.rules.sizeLimit&&e.rules.size<=this.getAvailableCapacity()}getAvailableCapacity(){return this.obj.rules.passengers-this.units.reduce(((e,t)=>e+t.rules.size),0)}addToLoadQueue(e){return this.loadQueue.push(e),this.loadQueue.length-1}unitIsFirstInLoadQueue(e){return this.loadQueue[0]===e}removeFromLoadQueue(e){var t=this.loadQueue.indexOf(e);-1!==t&&this.loadQueue.splice(t,1)}[a.NotifyTick.onTick](e,t){this.loadQueue=this.loadQueue.filter((e=>!e.isDestroyed&&!e.isCrashing))}[r.NotifyDestroy.onDestroy](e,t,i,r){var s=!!e.armedTrait?.deathWeapon,n=i?.weapon?.warhead.rules.parasite;if(r||s||e.zone===o.ZoneType.Air||n)for(var a of this.units)s&&a.armedTrait&&(a.armedTrait.deathWeapon=void 0),a.position.tileElevation=e.position.tileElevation,a.zone=e.zone,a.onBridge=e.onBridge,a.position.tile=e.tile,t.destroyObject(a,i,!0);else this.spawnSurvivors(t);this.units=[]}spawnSurvivors(e){var t=this.obj;if(this.units.length){for(var i of this.units)0<e.map.terrain.getPassableSpeed(t.tile,i.rules.speedType,t.onBridge)?(i.owner.addOwnedObject(i),i.position.tileElevation=t.onBridge?e.map.tileOccupation.getBridgeOnTile(t.tile).tileElevation:0,i.onBridge=t.onBridge,i.zone=e.map.getTileZone(t.tile,!t.onBridge),e.unlimboObject(i,t.tile),i.unitOrderTrait.addTask(new s.ScatterTask(e))):(i.position.tileElevation=t.position.tileElevation,i.zone=t.zone,i.onBridge=t.onBridge,i.position.tile=t.tile,e.destroyObject(i,{player:i.owner}));e.events.dispatch(new n.LeaveTransportEvent(t))}}getHash(){return i.fnv32a(this.units.map((e=>e.getHash())))}debugGetState(){return this.units.map((e=>e.debugGetState()))}dispose(){this.obj=void 0}},e("TransportTrait",l)}}})),System.register("game/gameobject/trait/TurretTrait",["game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.facing=0,this.desiredFacing=0}isRotating(){return this.facing!==this.desiredFacing}[r.NotifyTick.onTick](e){var t;this.desiredFacing!==this.facing&&(t=e.rules.rot,this.facing=i.FacingUtil.tick(this.facing,this.desiredFacing,t||Number.POSITIVE_INFINITY).facing)}},e("TurretTrait",s)}}})),System.register("game/art/FlhCoords",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("FlhCoords",class e{constructor(e){this.forward=0,this.lateral=0,this.vertical=0,e&&3===e.length&&this.fromArray(e)}fromArray(e){return this.forward=e[0],this.lateral=e[1],this.vertical=e[2],this}clone(){return new e([this.forward,this.lateral,this.vertical])}})}}})),System.register("game/event/WeaponFireEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WeaponFireEvent",class{constructor(e,t){this.weapon=e,this.gameObject=t,this.type=i.EventType.WeaponFire}})}}})),System.register("game/type/LandTargeting",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.LandOk=0]="LandOk",t[t.LandNotOk=1]="LandNotOk",t[t.LandSecondary=2]="LandSecondary",e("LandTargeting",i)}}})),System.register("game/type/NavalTargeting",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.UnderwaterNever=0]="UnderwaterNever",t[t.UnderwaterSecondary=1]="UnderwaterSecondary",t[t.UnderwaterOnly=2]="UnderwaterOnly",t[t.OrganicSecondary=3]="OrganicSecondary",t[t.SealSpecial=4]="SealSpecial",t[t.NavalAll=5]="NavalAll",t[t.NavalNone=6]="NavalNone",e("NavalTargeting",i)}}})),System.register("game/WeaponTargeting",["game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/type/LandTargeting","game/type/LandType","game/type/NavalTargeting","game/type/SpeedType","game/WeaponType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("WeaponTargeting",class{constructor(e,t,i,r,s,n){this.weaponType=e,this.projectileRules=t,this.weaponRules=i,this.warheadRules=r,this.gameObject=s,this.generalRules=n,this.targetChecks=[],this.initConditions()}initConditions(){this.projectileRules.isAntiGround||this.targetChecks.push((e=>!!e));const e=this.generalRules.prism.type;this.gameObject.name===e&&this.weaponType===l.WeaponType.Secondary?this.targetChecks.push(((t,i,r,s,n)=>!(!n||!t?.isBuilding()||t.name!==e||t.owner!==this.gameObject.owner))):this.warheadRules.electricAssault?this.targetChecks.push(((e,t,i,r,s)=>!(!r&&!s||!e?.isBuilding()||!e.overpoweredTrait||e.owner!==this.gameObject.owner))):this.weaponRules.damage<0?this.targetChecks.push(((e,t,i)=>!!(e!==this.gameObject&&e?.isUnit()&&i.areFriendly(e,this.gameObject)&&e.healthTrait.health<100&&this.gameObject.isAircraft()===e.isAircraft()))):(this.gameObject.rules.attackCursorOnFriendlies||this.warheadRules.bombDisarm?this.targetChecks.push(((e,t,i,r,s)=>!s&&!!(!this.warheadRules.bombDisarm||e?.isTechno()&&e.tntChargeTrait?.hasCharge()))):this.targetChecks.push(((e,t,i,r)=>!((!r||this.warheadRules.mindControl)&&e?.isTechno()&&i.areFriendly(e,this.gameObject)))),this.targetChecks.push(((e,t,i)=>!(e?.isTechno()&&e.cloakableTrait?.isCloaked()&&!i.alliances.haveSharedIntel(this.gameObject.owner,e.owner)))),this.weaponRules.limboLaunch&&this.targetChecks.push(((e,t,i,r,s)=>!(s&&e&&(e.isVehicle()||e.isAircraft())&&e.parasiteableTrait?.isInfested()))),this.gameObject.rules.ivan&&this.targetChecks.push((e=>!(!e?.isTechno()||!e.tntChargeTrait||e.tntChargeTrait.hasCharge()))),this.warheadRules.parasite&&this.targetChecks.push(((e,t,i,r)=>!!(!e&&r||e?.isInfantry()||(e?.isVehicle()||e?.isAircraft())&&e.parasiteableTrait))),this.warheadRules.mindControl&&this.targetChecks.push((e=>!(!e?.isTechno()||!e.mindControllableTrait))),this.warheadRules.temporal||this.targetChecks.push(((e,t,i,r,s)=>!(s&&e?.isTechno()&&e.warpedOutTrait.isInvulnerable())))),this.targetChecks.push(((e,t)=>this.canTargetZone(e,t)))}canTarget(e,t,i,r,s){return this.targetChecks.every((n=>n(e,t,i,r,s)))}canTargetZone(e,t){let s;if(e?.isUnit()){if(e?.isInfantry()&&e.stance===i.StanceType.Paradrop)return this.projectileRules.isAntiAir&&(this.projectileRules.isAntiGround||this.weaponType===l.WeaponType.Secondary);if(e.zone===r.ZoneType.Air)return this.projectileRules.isAntiAir;if(this.weaponType===l.WeaponType.Secondary&&this.projectileRules.isAntiAir)return!1;s=e.zone}else s=t.landType===n.LandType.Water?r.ZoneType.Water:r.ZoneType.Ground;return s===r.ZoneType.Water?this.canTargetNaval(this.gameObject.rules.navalTargeting,this.gameObject,e,this.weaponType):this.canTargetLand(this.gameObject.rules.landTargeting,this.weaponType)}canTargetLand(e,t){switch(e){case s.LandTargeting.LandOk:return!0;case s.LandTargeting.LandNotOk:return!1;case s.LandTargeting.LandSecondary:return t===l.WeaponType.Secondary;default:throw new Error(`Unhandled LandTargeting value "${e}"`)}}canTargetNaval(e,t,i,r){switch(e){case a.NavalTargeting.UnderwaterNever:return!i||!(i.isVehicle()&&i.submergibleTrait?.isSubmerged());case a.NavalTargeting.UnderwaterSecondary:return i&&i.isVehicle()&&i.submergibleTrait&&!t.rules.spawned?r===l.WeaponType.Secondary:r===l.WeaponType.Primary;case a.NavalTargeting.UnderwaterOnly:return!!(i&&i.isVehicle()&&i.submergibleTrait);case a.NavalTargeting.OrganicSecondary:return i?.isTechno()&&i.rules.organic?r===l.WeaponType.Secondary:r===l.WeaponType.Primary;case a.NavalTargeting.SealSpecial:return i?.isTechno()&&i.rules.naval&&!i.rules.organic&&(i.isBuilding()||i.rules.speedType===o.SpeedType.Float)?r===l.WeaponType.Secondary:r===l.WeaponType.Primary;case a.NavalTargeting.NavalAll:return!0;case a.NavalTargeting.NavalNone:return!1;default:throw new Error(`Unhandled NavalTargeting value "${e}"`)}}})}}})),System.register("game/Weapon",["game/Warhead","game/art/FlhCoords","game/event/WeaponFireEvent","game/math/geometry","game/rules/ObjectRules","game/Coords","engine/type/ObjectType","game/WeaponTargeting","game/WeaponType","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){50,5,2,1,e("Weapon",g=class e{constructor(e,t,i,r,s,n,a){this.type=e,this.gameObject=t,this.rules=i,this.warhead=r,this.projectileRules=s,this.flh=n,this.targeting=a,this.cooldownTicks=0,this.burstsLeft=0,this.burstIndex=0,this.useBurstDelay=!1,this.lateralMuzzleMult=1,this.distributedFireAngle=t.rules.distributedFire&&t.rules.radialFireSegments?-90:0}static factory(t,s,n,a,o){var l=a.getWeapon(t);let h=l.warhead;h===i.Warhead.SPECIAL_WARHEAD_NAME&&(h=e.findSpecialWarheadName(l,n,a));var u=new i.Warhead(a.getWarhead(h)),d=a.getProjectile(l.projectile),g=new c.WeaponTargeting(s,d,l,u.rules,n,a.general);return new this(s,n,l,u,d,o||new r.FlhCoords,g)}static findSpecialWarheadName(e,t,i){let r;if(!e.spawner)throw new Error(`Weapon "${e.name} can't use "Special" warhead without Spawner=yes`);if(t.rules.spawns===i.general.v3Rocket.type)r=i.combatDamage.v3Warhead;else if(t.rules.spawns===i.general.dMisl.type)r=i.combatDamage.dMislWarhead;else{if(!t.rules.spawns)throw new Error(`Can't use "Special" warhead on unit type "${t.name}" without "Spawns"`);var s=i.getObject(t.rules.spawns,l.ObjectType.Aircraft);if(!s.primary)throw new Error(`Spawned unit "${s.name}" doesn't have a primary weapon`);r=i.getWeapon(s.primary).warhead}return r}static computeSpeed(e,t){return t.arcing?.75*a.ObjectRules.iniSpeedToLeptonsPerTick(50,100):!t.rot||t.inviso||e.isLaser||e.isElectricBolt?Number.POSITIVE_INFINITY:e.speed}get name(){return this.rules.name}get minRange(){return this.rules.minimumRange}get range(){return this.gameObject.isBuilding()&&!this.gameObject.overpoweredTrait&&this.type===h.WeaponType.Secondary&&this.gameObject.primaryWeapon?Math.min(this.gameObject.primaryWeapon.rules.range,this.rules.range):this.rules.range}get speed(){return e.computeSpeed(this.rules,this.projectileRules)}get rof(){let e=this.rules.rof;return this.gameObject.isBuilding()&&this.gameObject.garrisonTrait?.isOccupied()&&(e/=this.gameObject.garrisonTrait.units.length),this.gameObject.veteranTrait&&(e*=this.gameObject.veteranTrait.getVeteranRofMultiplier()),Math.floor(e)}getCooldownTicks(){return this.cooldownTicks}expireCooldown(){this.cooldownTicks=0}resetCooldown(){this.cooldownTicks=this.rof}hasBurstsLeft(){return 0<this.burstsLeft}resetBursts(){this.burstsLeft=0,this.burstIndex=0,this.resetCooldown(),this.gameObject.ammoTrait&&0<this.gameObject.ammoTrait.ammo&&this.gameObject.ammoTrait.ammo--}tick(){0<this.cooldownTicks&&this.cooldownTicks--}getBurstsFired(){return this.burstIndex}fire(e,t,i=1){let r,a=this.gameObject,l=0;if(!a.airSpawnTrait||!this.rules.spawner||(r=a.airSpawnTrait.prepareLaunch(a,e,t),l=a.airSpawnTrait.availableSpawns,r)){this.burstsLeft?(this.burstsLeft--,this.burstIndex++,this.lateralMuzzleMult*=-1):(this.useBurstDelay=!1,this.burstIndex=0,r?this.burstsLeft=l:this.gameObject.isAircraft()?this.burstsLeft=this.projectileRules.iniRot<=1?4:this.gameObject.rules.fighter?0:1:(this.burstsLeft=this.rules.burst-1,this.useBurstDelay=!0),this.lateralMuzzleMult=1),0<this.burstsLeft&&(r&&0<l?this.cooldownTicks=this.rules.iniSpeed:this.gameObject.isAircraft()?this.cooldownTicks=this.rules.rof:this.cooldownTicks=this.useBurstDelay&&void 0!==this.gameObject.rules.burstDelay[this.burstIndex]?this.gameObject.rules.burstDelay[this.burstIndex]:t.generateRandomInt(3,5)),this.burstsLeft||this.resetBursts(),this.rules.limboLaunch&&(t.limboObject(this.gameObject,{selected:t.getUnitSelection().isSelected(this.gameObject),controlGroup:t.getUnitSelection().getOrCreateSelectionModel(this.gameObject).getControlGroupNumber()}),this.warhead.rules.parasite&&(e.obj?.isVehicle()||e.obj?.isAircraft())&&e.obj.parasiteableTrait&&(e.obj.parasiteableTrait.beingBoarded=!0));let p=r??t.createProjectile(this.projectileRules.name,this.gameObject,this,e,!1);p.isAircraft()||(p.baseDamageMultiplier=i*(this.gameObject.isUnit()?this.gameObject.crateBonuses.firepower:1));let m=this.flh.clone();m.lateral*=this.lateralMuzzleMult;var c=a.position.getMapPosition();if(t.map.isWithinHardBounds(c)){p.position.moveToLeptons(c),p.position.tileElevation=a.position.tileElevation;let i=new u.Vector2(m.lateral,m.forward);var h=this.getMuzzleFacing()+this.distributedFireAngle;i=n.rotateVec2(i,h),c=new u.Vector2(0,a.art.turretOffset),c=n.rotateVec2(c,a.direction),i.add(c),a.rules.radialFireSegments&&a.rules.distributedFire&&(c=Math.floor(180/a.rules.radialFireSegments),this.distributedFireAngle=(this.distributedFireAngle+c+90)%180-90),p.direction=h,a.isBuilding()&&a.rules.turretAnim&&(g=o.Coords.screenDistanceToWorld(a.rules.turretAnimX,a.rules.turretAnimY),h=a.getFoundationCenterOffset(),p.position.moveByLeptons(-h.x+g.x,-h.y+g.y));let r=new d.Vector3(i.x,m.vertical,-i.y);var g=r.clone().add(p.position.worldPosition);if(t.map.isWithinHardBounds(g)&&p.position.moveByLeptons3(r),p.tileElevation<0&&(p.position.tileElevation=0),p.isAircraft()?t.unlimboObject(p,p.position.tile):t.spawnObject(p,p.position.tile),this.rules.revealOnFire&&e.obj?.isTechno()){let i=t.mapShroudTrait.getPlayerShroud(e.obj.owner);i?.isShrouded(a.tile,a.tileElevation)&&i.revealTemporarily(a)}this.rules.decloakToFire&&this.gameObject.cloakableTrait?.uncloak(t),t.events.dispatch(new s.WeaponFireEvent(this,this.gameObject))}else r&&(r.owner.removeOwnedObject(r),r.dispose())}}getMuzzleFacing(){let e,t=this.gameObject;return e=t.isInfantry()||t.isAircraft()||!t.isBuilding()&&!t.isVehicle()||!t.turretTrait?t.direction:t.turretTrait.facing,e}}),g.NUKE_PAYLOAD_NAME="NukePayload"}}})),System.register("game/gameobject/trait/DeployerTrait",["game/gameobject/infantry/StanceType","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.None=0]="None",t[t.PreparingToFire=1]="PreparingToFire",t[t.FiringUp=2]="FiringUp",t[t.Firing=3]="Firing",n=class{constructor(e){this.gameObject=e,this.deployed=!1,this.deployFireDelay=0,this.deployFireState=s.None,this.fireUpDelay=0,this.deployFireCount=0}isDeployed(){return this.deployed}setDeployed(e){var t=this.deployed;if((this.deployed=e)!==t){let r=this.gameObject;r.isInfantry()&&(r.stance=e?i.StanceType.Deployed:i.StanceType.None),e?(this.deployFireState=s.PreparingToFire,t=this.gameObject.armedTrait?.getDeployFireWeapon(),this.deployWeapon=t?.rules.areaFire?t:void 0,this.deployFireDelay=15+((t===r.primaryWeapon?r.secondaryWeapon:r.primaryWeapon)?.getCooldownTicks()??0),this.deployFireCount=0,this.undeployDelay=this.gameObject.rules.undeployDelay||void 0):(this.deployFireState===s.FiringUp&&(r.isFiring=!1),this.deployFireState=s.None,this.deployWeapon=void 0)}}toggleDeployed(){this.setDeployed(!this.isDeployed())}[r.NotifyTick.onTick](e,t){if(void 0!==this.undeployDelay&&(0<this.undeployDelay&&this.undeployDelay--,this.undeployDelay<=0&&[s.None,s.PreparingToFire].includes(this.deployFireState)))return this.undeployDelay=void 0,void this.setDeployed(!1);if(this.deployWeapon&&this.deployFireState!==s.None){if(this.deployFireState===s.PreparingToFire){if(0<this.deployFireDelay--||0===e.ammo)return;if(0<this.computeDeployFireCooldown(this.deployWeapon,t))return;this.fireUpDelay=Math.max(1,e.art.fireUp),this.deployFireState=s.FiringUp}if(this.deployFireState===s.FiringUp){if(e.isFiring=!0,0<this.fireUpDelay--)return;this.deployFireState=s.Firing}var i;this.deployFireState===s.Firing&&(e.isFiring=!1,i=e.onBridge?t.map.tileOccupation.getBridgeOnTile(e.tile):void 0,this.deployWeapon.fire(t.createTarget(i,e.tile),t),this.deployFireCount++,(this.deployWeapon===e.primaryWeapon?e.secondaryWeapon:e.primaryWeapon)?.resetCooldown(),this.deployWeapon.rules.fireOnce?(this.deployFireState=s.None,this.deployWeapon=void 0):this.deployFireState=s.PreparingToFire)}}computeDeployFireCooldown(e,t){if(e.rules.radLevel&&e.rules.areaFire){var i=this.gameObject.tile,r=t.mapRadiationTrait.getRadSiteLevel(i);if(!r)return 0;i=t.rules.radiation;let s=Math.max(0,r*i.radDurationMultiple-i.radLevelDelay);return 1===this.deployFireCount&&(i=i.radDurationMultiple*e.rules.radLevel,s=Math.max(0,s-Math.floor(.25*i))),s}return e.getCooldownTicks()}getHash(){return this.deployed?1:0}debugGetState(){return{deployed:this.deployed}}dispose(){this.gameObject=void 0}},e("DeployerTrait",n)}}})),System.register("game/gameobject/trait/interface/NotifySell",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onSell=Symbol(),e("NotifySell",i)}}})),System.register("game/gameobject/unit/VeteranLevel",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Veteran=1]="Veteran",t[t.Elite=2]="Elite",e("VeteranLevel",i)}}})),System.register("game/gameobject/trait/CrewedTrait",["game/gameobject/trait/interface/NotifySell","game/gameobject/trait/interface/NotifyDestroy","game/SideType","engine/type/ObjectType","game/gameobject/task/ScatterTask","game/gameobject/Infantry","game/gameobject/unit/VeteranLevel"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class{[i.NotifySell.onSell](e,t){this.spawnSurvivors(e,t)}[r.NotifyDestroy.onDestroy](e,t,i,r){r||i?.obj===e&&i.weapon?.rules.suicide||e.isVehicle()&&e.moveTrait.isMoving()||e.crashableTrait||this.spawnSurvivors(e,t)}spawnSurvivors(e,t){var i=t.rules.general.crew,r=e.owner.country.side;let c,h;if(r===s.SideType.GDI)c=i.alliedSurvivorDivisor,h=i.alliedCrew;else{if(r!==s.SideType.Nod)return;c=i.sovietSurvivorDivisor,h=i.sovietCrew}let u=t.sellTrait.computeRefundValue(e)/c;u=0<u&&u<1?1:Math.floor(u),u=e.isVehicle()?Math.min(1,u):Math.min(5,u);let d=[];for(let e=0;e<u;e++)d.push(h);if(0<d.length){e.rules.constructionYard&&(d[d.length-1]=t.rules.general.engineer);var g,p=t.map.tiles.getInRectangle(e.tile,e.getFoundation()).filter((e=>t.map.isWithinBounds(e)));let i=[...p];for(g of d){var m=t.rules.getObject(g,n.ObjectType.Infantry);if(t.map.terrain.getPassableSpeed(e.tile,m.speedType,!e.isBuilding()&&e.onBridge,void 0,!0)){let r=t.createUnitForPlayer(m,e.owner),s=i.length?i.splice(t.generateRandomInt(0,i.length-1),1)[0]:void 0;s=s||p[t.generateRandomInt(0,p.length-1)],r.isInfantry()&&(r.position.subCell=o.Infantry.SUB_CELLS[0]),r.veteranTrait&&e.owner.canProduceVeteran(r.rules)&&r.veteranTrait.setVeteranLevel(l.VeteranLevel.Veteran),t.spawnObject(r,s),e.isBuilding()&&r.unitOrderTrait.addTask(new a.ScatterTask(t,void 0,{ignoredBlockers:e.isDestroyed?void 0:[e]}))}}}}},e("CrewedTrait",c)}}})),System.register("game/gameobject/trait/GunnerTrait",["game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{[r.NotifyTick.onTick](e){var t,r;!!e.transportTrait.units.length!==this.lastHadGunner&&(this.lastHadGunner=!!e.transportTrait.units.length,r=t=e.transportTrait.units[0]?.rules.ifvMode??0,(t=e.rules.turretIndexesByIfvMode.get(t)??0)<e.rules.turretCount&&(e.turretNo=t,e.armedTrait?.selectSpecialWeapon(r,e.veteranLevel===i.VeteranLevel.Elite)))}getUiNameForIfvMode(e,t){switch(e){case 0:return"tip:rocket";case 1:return"tip:repair";case 2:case 4:case 5:return"tip:machinegun";default:return t?"name:"+t.toLowerCase():void 0}}},e("GunnerTrait",s)}}})),System.register("game/gameobject/trait/interface/NotifyAttack",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onAttack=Symbol(),e("NotifyAttack",i)}}})),System.register("game/gameobject/trait/interface/NotifyHeal",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onHeal=Symbol(),e("NotifyHeal",i)}}})),System.register("util/bresenham",[],(function(e,t){"use strict";return t&&t.id,e("bresenham",(function(e,t,i,r,s){let n=[];s=s||((e,t)=>{n.push({x:e,y:t})});var a=i-e,o=r-t,l=Math.abs(a),c=Math.abs(o);let h=0;var u=0<a?1:-1,d=0<o?1:-1;if(c<l)for(let r=e,n=t;u<0?r>=i:r<=i;r+=u)s(r,n),h+=c,h<<1>=l&&(n+=d,h-=l);else for(let i=e,n=t;d<0?n>=r:n<=r;n+=d)s(i,n),h+=l,h<<1>=c&&(i+=u,h-=c);return n})),{setters:[],execute:function(){}}})),System.register("game/gameobject/unit/LosHelper",["util/bresenham","game/type/LandType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=e=>void 0!==e.position,e("LosHelper",class{constructor(e,t){this.tiles=e,this.tileOccupation=t}hasLineOfSight(e,t,n){var a=n.warhead.rules.wall||!n.projectileRules.subjectToWalls,o=n.projectileRules.subjectToCliffs,l=n.rules.spawner;let c=0,h=!1;if(!a||o||l){var u,d,g=s(e)?e.tile:e,p=s(t)?t.tile:t;for({x:u,y:d}of i.bresenham(g.rx,g.ry,p.rx,p.ry)){var m=this.tiles.getByMapCoords(u,d);if(!m)return!1;if(!a&&m.landType===r.LandType.Wall)return!1;if(o)if(m.landType===r.LandType.Cliff){if(m.z>g.z)return!1;h=!0}else{if(m.z>g.z&&h)return!1;h=!1}if(l&&c<2&&this.tileOccupation.getBridgeOnTile(m)?.isHighBridge())return!1;c++}}return!0}})}}})),System.register("game/gameobject/task/move/MoveInWeaponRangeTask",["game/gameobject/task/move/MoveTask","game/gameobject/GameObject","game/gameobject/unit/RangeHelper","game/Coords","game/gameobject/unit/LosHelper","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RandomTileFinder","game/type/LocomotorType","util/bresenham","game/gameobject/unit/FacingUtil","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("STRAFE_CLOSE_ENOUGH",2),f=class extends i.MoveTask{constructor(e,t,i,n){super(e,t instanceof r.GameObject?t.isBuilding()?t.centerTile:t.tile:t,i,{pathFinderIgnoredBlockers:t instanceof r.GameObject&&0<n.range?[t]:void 0}),this.target=t,this.weapon=n,this.recalcMinRange=!0,this.cancelRequested=!1,this.bomberInitialLock=!1,this.rangeHelper=new s.RangeHelper(e.map.tileOccupation),this.losHelper=new a.LosHelper(e.map.tiles,e.map.tileOccupation)}onStart(e){let t=this.target,i=this.game.map;if(t instanceof r.GameObject&&t.isBuilding()&&e.rules.movementZone!==l.MovementZone.Fly){let n=t.tile;var s=t instanceof r.GameObject?t.getFoundation():{width:1,height:1};s=new o.RadialTileFinder(i.tiles,i.mapBounds,n,s,1,5,(t=>0<i.terrain.getPassableSpeed(t,e.rules.speedType,!1)&&Math.abs(t.z-n.z)<2)).getNextTile();s&&this.rangeHelper.tileDistance(t,s)>Math.SQRT2&&this.updateTarget(s,!1)}this.bomberInitialLock=this.isCloseEnoughToDest(e,e.tile),super.onStart(e)}cancel(){this.bomberManeuverTile?this.cancelRequested=!0:super.cancel()}shouldAirStrafe(e){return e.rules.movementZone===l.MovementZone.Fly&&e.rules.locomotor===d.LocomotorType.Aircraft&&e.rules.fighter&&1<this.weapon.projectileRules.iniRot}isBombingRun(e){return e.rules.movementZone===l.MovementZone.Fly&&e.rules.locomotor===d.LocomotorType.Aircraft&&this.weapon.projectileRules.iniRot<=1}isAirStrafeCloseEnough(e){return this.rangeHelper.tileDistance(e,this.targetTile)<Math.min(this.weapon.range,2)}bomberCanReturn(e){return!this.bomberManeuverTile||this.rangeHelper.tileDistance(e,this.bomberManeuverTile)<=1}findStrafeDestination(e,t){return new u.RandomTileFinder(this.game.map.tiles,this.game.map.mapBounds,t,this.weapon.range,this.game,(i=>this.rangeHelper.isInWeaponRange(e,t,this.weapon,this.game.rules,i))).getNextTile()}hasReachedDestination(e){return super.hasReachedDestination(e)||this.canStopAtTile(e,e.tile,e.onBridge)}canStopAtTile(e,t,i){if(e.zone!==c.ZoneType.Air&&this.target instanceof r.GameObject&&this.game.map.tileOccupation.isTileOccupiedBy(t,this.target)&&(!this.target.isUnit()||this.target.tile===t&&this.target.moveTrait.moveState!==h.MoveState.Moving))return!1;if(e.zone!==c.ZoneType.Air){if(!super.canStopAtTile(e,t,i))return!1}else if(this.game.map.tileOccupation.getAirObjectsOnTile(t).filter((t=>t.isUnit()&&t.moveTrait.moveState!==h.MoveState.Moving&&t!==e)).length)return!1;return!(this.isBombingRun(e)&&!this.bomberCanReturn(t))&&(!!this.isCancelling()||this.isCloseEnoughToDest(e,t))}isCloseEnoughToDest(e,t){if(e.rules.balloonHover&&!e.rules.hoverAttack)return this.rangeHelper.isInTileRange(t,this.target,0,0);if(this.weapon.rules.cellRangefinding||!e.isInfantry())return this.rangeHelper.isInWeaponRange(e,this.target,this.weapon,this.game.rules,t)&&this.losHelper.hasLineOfSight(t,this.target,this.weapon);var i=e.zone===c.ZoneType.Air?e.position.computeSubCellOffset(e.position.desiredSubCell):e.position.getTileOffset(),{minRange:r,range:s}=this.rangeHelper.computeWeaponRangeVsTarget(t,this.target,this.weapon,this.game.rules);i=n.Coords.tile3dToWorld(t.rx+i.x/n.Coords.LEPTONS_PER_TILE,t.ry+i.y/n.Coords.LEPTONS_PER_TILE,t.z+e.position.tileElevation);return(e.isUnit()&&e.rules.movementZone===l.MovementZone.Fly?this.rangeHelper.isInRange2(i,this.target,r,s):this.rangeHelper.isInRange3(i,this.target,r,s))&&this.losHelper.hasLineOfSight(t,this.target,this.weapon)}findRelocationTile(e,t,i){if(i.rules.movementZone!==l.MovementZone.Fly)return super.findRelocationTile(e,t,i);var r=this.game.map;return new u.RandomTileFinder(r.tiles,r.mapBounds,e,1,this.game,(e=>this.isCancelling()||this.isCloseEnoughToDest(i,e))).getNextTile()}retarget(e,t){var i=e instanceof r.GameObject?e.isBuilding()?e.centerTile:e.tile:e;this.bomberManeuverTile?this.bomberQueuedTargetTile=i:(this.updateTarget(i,t),this.recalcMinRange=!0),this.target=e,this.options?.ignoredBlockers&&(this.options.ignoredBlockers=e instanceof r.GameObject?[e]:void 0),this.options??(this.options={}),this.options.pathFinderIgnoredBlockers=e instanceof r.GameObject?[e]:void 0}onTick(e){if(this.recalcMinRange){this.recalcMinRange=!1;var t=this.findMinRangeRelocationTile(e,this.targetTile);if(t!==this.targetTile){if(!t)return this.cancel(),!1;this.updateTarget(t,!!t.onBridgeLandType)}}if(this.shouldAirStrafe(e)&&!this.isCancelling()&&(this.updateTarget(this.target instanceof r.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target,!1),!this.isAirStrafeCloseEnough(e)||(i=this.findStrafeDestination(e,this.targetTile))&&this.updateTarget(i,!1)),this.isBombingRun(e)&&!this.isCancelling()&&(!e.ammo||this.weapon.getBurstsFired()||this.bomberInitialLock)&&!this.bomberManeuverTile){this.bomberInitialLock=!1;let t=e.position.getMapPosition();var i=this.target instanceof r.GameObject?this.target.isBuilding()?this.target.centerTile:this.target.tile:this.target;let s=new m.Vector2(i.rx+.5,i.ry+.5).clone().multiplyScalar(n.Coords.LEPTONS_PER_TILE).sub(t),a=s.length();if(a||(s.copy(p.FacingUtil.toMapCoords(e.direction)),a=Number.EPSILON),i=t.clone().add(s.setLength(a+7*n.Coords.LEPTONS_PER_TILE)).multiplyScalar(1/n.Coords.LEPTONS_PER_TILE).floor(),!(i=g.bresenham(i.x,i.y,e.tile.rx,e.tile.ry)).length)throw new Error("Bresenham returned no tiles");i=i[0],this.bomberManeuverTile=this.game.map.tiles.getByMapCoords(i.x,i.y)??this.game.map.tiles.getPlaceholderTile(i.x,i.y),this.options.allowOutOfBoundsTarget=!0,this.updateTarget(this.bomberManeuverTile,!1)}return this.bomberManeuverTile&&this.bomberCanReturn(e.tile)&&(this.bomberManeuverTile=void 0,this.bomberQueuedTargetTile&&(this.updateTarget(this.bomberQueuedTargetTile,!1),this.recalcMinRange=!0,this.bomberQueuedTargetTile=void 0)),this.cancelRequested&&(this.bomberManeuverTile||(this.cancelRequested=!1,this.cancel())),!!(this.isBombingRun(e)&&this.isCancelling()&&this.forceCancel(e))||super.onTick(e)}forceCancel(e){return!this.bomberManeuverTile&&super.forceCancel(e)}findMinRangeRelocationTile(e,t){var{minRange:i,range:r}=this.rangeHelper.computeWeaponRangeVsTarget(e,this.target,this.weapon,this.game.rules);return e.rules.locomotor===d.LocomotorType.Chrono?this.rangeHelper.isInRange(e,this.target,r-1,r,this.weapon.rules.cellRangefinding)?t:this.findTileInRange(e,t,r-1,2*r)??t:this.rangeHelper.isInRange(e,this.target,i,Number.POSITIVE_INFINITY,this.weapon.rules.cellRangefinding)?t:this.findTileInRange(e,t,2*i,r-i)}findTileInRange(e,t,i,r){let s=this.game.map;var n,a=new m.Vector2(e.tile.rx-t.rx,e.tile.ry-t.ry).setLength(i).floor().add(new m.Vector2(t.rx,t.ry));let l;for(n of g.bresenham(a.x,a.y,t.rx,t.ry))if(l=s.tiles.getByMapCoords(n.x,n.y),l)break;if(l){return new o.RadialTileFinder(s.tiles,s.mapBounds,l,{width:1,height:1},0,r,(t=>this.rangeHelper.isInWeaponRange(e,this.target,this.weapon,this.game.rules,t)&&this.losHelper.hasLineOfSight(t,this.target,this.weapon)&&0<s.terrain.getPassableSpeed(t,e.rules.speedType,!!t.onBridgeLandType)&&!s.terrain.findObstacles({tile:t,onBridge:!!t.onBridgeLandType},e).length)).getNextTile()}}},e("MoveInWeaponRangeTask",f)}}})),System.register("game/gameobject/task/system/TaskRunner",["game/gameobject/task/system/TaskStatus"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TaskRunner",class{tick(e,t){this.tickChildren(e,t)}startTask(e,t){if(e.status!==i.TaskStatus.NotStarted)throw new Error("Attempted to start a task with status "+e.status);e.status=i.TaskStatus.Running,e.onStart(t)}tickTask(e,t){let r=this.tickChildren(e.children,t);var s=e.children.find((e=>e.blocking));if(!r&&s)return!1;if(!t.isSpawned)return!1;if(e.status===i.TaskStatus.NotStarted)throw new Error("Attempted tick on a non-started task");if(e.isRunning()||e.isCancelling()){var n=e.isCancelling(),a=!!e.waitingForChildrenToFinish||e.onTick(t);return e.children.length&&!s&&a&&(r=e.children.every((e=>e.status===i.TaskStatus.Cancelled||e.status===i.TaskStatus.Finished)),e.waitingForChildrenToFinish=!r),(a=a&&r)&&(e.onEnd(t),e.status=n?i.TaskStatus.Cancelled:i.TaskStatus.Finished),a}return!0}tickChildren(e,t){let r=!0;if(e.length){let n,a=new Set;for(;t.isSpawned&&(n=e.find((e=>!a.has(e))));){let o;if(n.status===i.TaskStatus.NotStarted&&this.startTask(n,t),n.status===i.TaskStatus.Running||n.status===i.TaskStatus.Cancelling)o=!0===this.tickTask(n,t);else{if(n.status!==i.TaskStatus.Cancelled)throw new Error("Unhandled task status "+i.TaskStatus[n.status]);o=!0}if(o){var s=e.indexOf(n);-1!==s&&e.splice(s,1)}else{if(r=!1,n.blocking)break;a.add(n)}}}return r}})}}})),System.register("game/type/VhpScan",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Normal=1]="Normal",t[t.Strong=2]="Strong",e("VhpScan",i)}}})),System.register("game/event/ObjectDisguiseChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectDisguiseChangeEvent",class{constructor(e){this.target=e,this.type=i.EventType.ObjectDisguiseChange}})}}})),System.register("game/gameobject/trait/DisguiseTrait",["engine/type/ObjectType","game/event/ObjectDisguiseChangeEvent","game/SideType","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/MoveTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class{constructor(){this.isActive=!1,this.cooldownTicks=0}isDisguised(){return this.isActive}getDisguise(){return this.isActive?this.disguisedAs:void 0}hasTerrainDisguise(){return this.getDisguise()?.rules.type===i.ObjectType.Terrain}disguiseAs(e,t,i){this.disguisedAs={rules:e.rules,owner:e.owner},this.isActive=!0,i.events.dispatch(new r.ObjectDisguiseChangeEvent(t))}revealDisguise(e,t){this.cooldownTicks=t.rules.general.infantryBlinkDisguiseTime,this.isActive=!1,t.events.dispatch(new r.ObjectDisguiseChangeEvent(e))}[o.NotifySpawn.onSpawn](e,t){var r;!this.disguisedAs&&e.rules.permaDisguise&&e.isInfantry()&&e.owner.country&&(r=this.getDefaultInfantryDisguise(e.owner.country.side,t.rules.general))&&(r=t.rules.getObject(r,i.ObjectType.Infantry),this.disguisedAs={rules:r,owner:e.owner},this.isActive=!0)}getDefaultInfantryDisguise(e,t){switch(e){case s.SideType.GDI:return t.alliedDisguise;case s.SideType.Nod:return t.sovietDisguise;default:return}}[l.NotifyTick.onTick](e,t){e.rules.permaDisguise||(e.attackTrait?.attackState===n.AttackState.JustFired||e.moveTrait.moveState!==c.MoveState.Idle?this.revealDisguise(e,t):0<this.cooldownTicks?this.cooldownTicks--:!this.isActive&&e.rules.disguiseWhenStill&&(this.isActive=!0,this.disguisedAs={rules:this.selectRandomMirageDisguise(t),owner:void 0},t.events.dispatch(new r.ObjectDisguiseChangeEvent(e))))}[a.NotifyDamage.onDamage](e,t){this.revealDisguise(e,t)}selectRandomMirageDisguise(e){var t=e.rules.general.defaultMirageDisguises;if(!t.length)throw new Error("No default mirage disguises are defined");return t=t[e.generateRandomInt(0,t.length-1)],e.rules.getObject(t,i.ObjectType.Terrain)}},e("DisguiseTrait",h)}}})),System.register("game/gameobject/trait/AttackTrait",["util/typeGuard","game/type/ArmorType","game/gameobject/unit/ZoneType","game/gameobject/task/AttackTask","game/SideType","game/gameobject/trait/interface/NotifyTick","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyDamage","game/gameobject/task/system/TaskRunner","game/Target","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/Coords","game/gameobject/trait/interface/NotifyTeleport","game/type/VhpScan","game/gameobject/unit/LosHelper","game/math/Vector2","game/math/Box2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e}],execute:function(){var t;(t=w=w||{})[t.Idle=0]="Idle",t[t.CheckRange=1]="CheckRange",t[t.PrepareToFire=2]="PrepareToFire",t[t.FireUp=3]="FireUp",t[t.Firing=4]="Firing",t[t.JustFired=5]="JustFired",e("AttackState",w),C=class{constructor(e,t){this.disabled=!1,this.attackState=w.Idle,this.passiveScanCooldownTicks=0,this.taskRunner=new h.TaskRunner,this.distributedFireHistory=new Map,this.rangeHelper=new l.RangeHelper(t),this.losHelper=new v.LosHelper(e,t)}isIdle(){return this.attackState===w.Idle}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}isOnCooldown(e){let t=[e.primaryWeapon,e.secondaryWeapon],i=e.armedTrait?.getDeployFireWeapon();return i?.rules.areaFire&&!i.rules.fireOnce&&(t=t.filter((e=>e!==i))),t.some((e=>0<(e?.getCooldownTicks()??0)))}expirePassiveScanCooldown(){this.passiveScanCooldownTicks=0}cancelOpportunityFire(){this.opportunityFireTask?.cancel()}selectDefaultWeapon(e){let t;if((e.isInfantry()||e.isVehicle())&&e.rules.deployFire){let i=e.armedTrait?.getDeployFireWeapon();t=e.deployerTrait?.isDeployed()?i&&!i.rules.areaFire?i:void 0:[e.primaryWeapon,e.secondaryWeapon].find((e=>e!==i))}else t=e.isBuilding()&&e.garrisonTrait?e.garrisonTrait.isOccupied()?e.owner.country.side===a.SideType.GDI?e.primaryWeapon:e.secondaryWeapon??e.primaryWeapon:void 0:e.isBuilding()&&e.overpoweredTrait?e.overpoweredTrait.getWeapon():e.primaryWeapon;return t}selectWeaponVersus(e,t,i,r=!1,s=!1){var n=t.tile;const a=t instanceof u.Target?t.obj:t;var o=this.getAvailableWeapons(e,s,a?.isOverlay()||r&&!a);return this.selectWeaponFromList(e,a,n,o,i,r,s,!1)}selectWeaponFromList(e,t,i,r,n,a,o,l){if((!t?.isInfantry()&&!t?.isVehicle()||!t.disguiseTrait||this.canAttackThroughDisguise(e,t,t.disguiseTrait,n,a,o,l))&&(t?.isBuilding()&&t.overpoweredTrait&&t.owner===e.owner&&r.find((e=>e.warhead.rules.electricAssault))&&(r=r.filter((e=>e.warhead.rules.electricAssault))),!(o&&t?.isAircraft()&&t.missileSpawnTrait&&t.zone!==s.ZoneType.Air))){var c=t?.isTechno()?t.rules.armor:void 0;for(const e of r)if(e.targeting.canTarget(t,i,n,a,o)&&(void 0===c||this.checkArmor(e.warhead.rules,c,o)))return e}}getAvailableWeapons(e,t,i){let r;var s;return r=(e.isInfantry()||e.isVehicle())&&e.rules.deployFire&&e.armedTrait?(s=e.armedTrait.getDeployFireWeapon(),[e.deployerTrait?.isDeployed()?s.rules.areaFire?void 0:s:s===e.secondaryWeapon?e.primaryWeapon:e.secondaryWeapon]):e.isBuilding()&&e.garrisonTrait?e.garrisonTrait.isOccupied()?[e.owner.country.side===a.SideType.GDI?e.primaryWeapon:e.secondaryWeapon??e.primaryWeapon]:[]:e.isBuilding()&&e.overpoweredTrait?[e.overpoweredTrait.getWeapon()]:i||t?[e.primaryWeapon,!i&&t&&e.secondaryWeapon&&(e.secondaryWeapon.projectileRules.isAntiAir||e.secondaryWeapon.rules.spawner||e.secondaryWeapon.warhead.rules.electricAssault)?e.secondaryWeapon:void 0]:[e.primaryWeapon,e.secondaryWeapon],r.filter((e=>e&&!e.rules.neverUse))}canAttackThroughDisguise(e,t,i,r,s,n,a){if(!s&&i.hasTerrainDisguise()&&!r.areFriendly(e,t)&&!e.owner.sharedDetectDisguiseTrait?.has(t))return!1;if(n){if(a&&t.moveTrait.isIdle()&&!e.rules.detectDisguise&&!r.areFriendly(t,e))return!1;var o=i.getDisguise();if(o?.owner&&!e.rules.detectDisguise&&!e.owner.sharedDetectDisguiseTrait?.has(t)&&(o.owner===e.owner||r.alliances.areAllied(e.owner,o.owner)))return!1}return!0}checkArmor(e,t,i){var s=e.ivanBomb||e.bombDisarm||e.nukeMaker?1:e.verses.get(t);return void 0===s?(console.warn(`Unhandled ArmorType ${r.ArmorType[t]} in warhead ${e.name} verses`),!1):!(100*s<=(i?1:0))}createAttackTask(e,t,i,r,s){return new n.AttackTask(e,e.createTarget(t,i),r,s)}[o.NotifyTick.onTick](e,t){if(!this.isDisabled()){var i;if(this.opportunityFireTask&&(!e.unitOrderTrait.hasTasks()||e.isUnit()&&!e.unitOrderTrait.getTasks()[0].preventOpportunityFire||(e.unitOrderTrait.getTasks()[0]instanceof n.AttackTask?this.opportunityFireTask=void 0:this.opportunityFireTask.cancel()),this.opportunityFireTask&&(i=[this.opportunityFireTask],this.taskRunner.tick(i,e),i.length||(this.opportunityFireTask=void 0))),!this.opportunityFireTask&&this.retaliateTarget){var r=this.retaliateTarget;let i;this.retaliateTarget=void 0,!e.unitOrderTrait.hasTasks()&&t.isValidTarget(r)&&(i=this.selectWeaponVersus(e,r,t,!1))&&e.unitOrderTrait.addTask(this.createAttackTask(t,r,r.tile,i,{holdGround:e.rules.movementZone===m.MovementZone.Fly}))}if(!this.opportunityFireTask&&this.shouldPassiveAcquire(e))if(0<this.passiveScanCooldownTicks)this.passiveScanCooldownTicks--;else{this.passiveScanCooldownTicks=e.guardMode?t.rules.general.guardAreaTargetingDelay:t.rules.general.normalTargetingDelay;let i,n,l,c=this.selectDefaultWeapon(e);!(r=e.unitOrderTrait.hasTasks())&&e.guardMode&&c&&e.owner.isCombatant()&&(i=e.armedTrait?.computeGuardScanRange(c),n=e.guardArea?.tile,l=50);let h=!1;if(c){var a=this.scanForTarget(e,c,t,i,n);if(a.target){let{target:i,weapon:n}=a;var o=this.createAttackTask(t,i,i.tile,n,{holdGround:r||e.rules.movementZone===m.MovementZone.Fly&&!e.guardMode||e.rules.movementZone!==m.MovementZone.Fly&&i.isUnit()&&i.zone===s.ZoneType.Air||(e.isInfantry()||e.isVehicle())&&!!e.disguiseTrait||!e.owner.isCombatant(),disallowTurning:r,leashTiles:l,passive:!0});r?this.opportunityFireTask=o:e.unitOrderTrait.addTask(o),h=!0,r||!e.guardMode||e.guardArea||(e.guardArea={tile:e.tile,onBridge:!!e.isUnit()&&e.onBridge})}}h||r||!e.secondaryWeapon?.warhead.rules.electricAssault||(c=e.secondaryWeapon,(a=this.scanForTarget(e,c,t,void 0,void 0,!0)).target&&(({target:o,weapon:a}=a),a=this.createAttackTask(t,o,o.tile,a,{passive:!0}),e.unitOrderTrait.addTask(a),h=!0)),!h&&!r&&e.guardArea&&e.isUnit()&&e.moveTrait&&!e.moveTrait.isDisabled()&&e.guardArea.tile!==e.tile&&e.unitOrderTrait.addTasks(new d.MoveTask(t,e.guardArea.tile,e.guardArea.onBridge),new g.CallbackTask((()=>{[p.MoveResult.Success,p.MoveResult.CloseEnough].includes(e.moveTrait.lastMoveResult)||e.resetGuardModeToIdle(),e.guardArea=void 0})))}}}[c.NotifyDamage.onDamage](e,t,i,r){this.isDisabled()||!this.retaliateTarget&&!this.opportunityFireTask&&r&&r.obj&&r.weapon&&this.shouldRetaliate(e,t,i,r.obj,r.weapon.warhead)&&(this.retaliateTarget=r.obj)}[y.NotifyTeleport.onBeforeTeleport](e,t,i,r){r||(this.attackState=w.Idle,this.currentTarget=void 0,this.retaliateTarget=void 0,this.opportunityFireTask=void 0)}shouldPassiveAcquire(e){if(!e.owner.isCombatant()&&e.rules.needsEngineer||!e.rules.canPassiveAquire||!e.primaryWeapon)return!1;if(e.mindControllerTrait?.isAtCapacity())return!1;if(e.isUnit()&&e.rules.opportunityFire){if(e.unitOrderTrait.hasTasks()&&e.unitOrderTrait.getTasks()[0].preventOpportunityFire)return!1}else if(e.unitOrderTrait.hasTasks())return!1;return!0}shouldRetaliate(e,t,i,r,s){return!(i<1||t.areFriendly(e,r)||!e.rules.canRetaliate||!e.primaryWeapon||s.rules.temporal||r.rules.missileSpawn||e.unitOrderTrait.hasTasks()||!t.isValidTarget(r)||(r.isInfantry()||r.isVehicle())&&r.disguiseTrait&&!e.rules.detectDisguise||e.mindControllerTrait?.isAtCapacity()||!this.selectWeaponVersus(e,r,t,!1)||(e.isBuilding()||r.isBuilding()?this.rangeHelper.tileDistance(e,r):this.rangeHelper.distance2(e,r)/f.Coords.LEPTONS_PER_TILE)>e.sight)}scanForTarget(e,t,i,r,s,n=!1){let a={},o=Number.NEGATIVE_INFINITY;var l=this.getAvailableWeapons(e,!0,!1),c=r??(e.rules.guardRange||t.range)+1+3+i.rules.elevationModel.bonusCap+(t.projectileRules.isAntiAir?e.rules.airRangeBonus:0);for(const t of this.scanTechnosAround(e,c,i)){var h,u=this.selectWeaponFromList(e,t,t.tile,l,i,!1,!0,!0);u&&this.canPassiveAcquire(t,i)&&i.isValidTarget(t)&&(r?this.rangeHelper.isInRange(e,t,u.minRange,r,u.rules.cellRangefinding)&&(!s||this.rangeHelper.isInRange2(s,t,0,r)):this.rangeHelper.isInWeaponRange(e,t,u,i.rules))&&(n||this.losHelper.hasLineOfSight(e,t,u))&&(h=this.rangeHelper.distance3(e,t)/f.Coords.LEPTONS_PER_TILE,(h=this.computeThreat(t,e,u,h,i.rules.general.threat))>o&&(a={target:t,weapon:u},o=h))}return a.target&&e.rules.distributedFire&&this.updateDistributedFireHistory(a),a}scanTechnosAround(e,t,i){var r=e.getFoundation();const s=new b.Vector2(e.tile.rx,e.tile.ry),n=new b.Vector2(e.tile.rx+r.width-1,e.tile.ry+r.height-1);return s.addScalar(-t),n.addScalar(t),r=new S.Box2(s,n),i.map.technosByTile.queryRange(r)}canPassiveAcquire(e,t){return!e.owner.isNeutral&&!e.rules.civilian&&!e.rules.insignificant&&(1<e.rules.threatPosed||0<e.rules.specialThreatValue&&!e.isBuilding()||e.rules.harvester||e.name===t.rules.general.paradrop.paradropPlane)}computeThreat(e,t,r,s,n){let a=[e.primaryWeapon,e.secondaryWeapon].filter(i.isNotNullOrUndefined).map((e=>e.warhead.rules.verses.get(t.rules.armor)??0)).reduce(((e,t)=>Math.max(e,t)),0)*n.targetEffectivenessCoefficientDefault;return e.attackTrait?.currentTarget?.obj===t&&(a*=-1),a+=e.rules.specialThreatValue*n.targetSpecialThreatCoefficientDefault,a+=(r.warhead.rules.verses.get(e.rules.armor)??0)*n.myEffectivenessCoefficientDefault,a+=e.healthTrait.health/100*n.targetStrengthCoefficientDefault,a+=s*n.targetDistanceCoefficientDefault,t.rules.distributedFire&&(a-=1e6*(this.distributedFireHistory.get(e)??0)),t.rules.vhpScan===T.VhpScan.Strong&&e.healthTrait.getProjectedHitPoints()<=0&&(a-=1e6),a}updateDistributedFireHistory(e){if(50!==this.distributedFireHistory.get(e.target)){for(var[t,i]of this.distributedFireHistory)--i<=0?this.distributedFireHistory.delete(t):this.distributedFireHistory.set(t,i);this.distributedFireHistory.set(e.target,50)}}dispose(){this.distributedFireHistory.clear()}},e("AttackTrait",C)}}})),System.register("game/gameobject/task/AttackTask",["game/gameobject/task/system/Task","game/gameobject/unit/RangeHelper","game/gameobject/task/system/WaitMinutesTask","game/WeaponType","game/gameobject/task/move/MoveInWeaponRangeTask","game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/AttackTrait","game/gameobject/GameObject","game/gameobject/unit/LosHelper","game/gameobject/trait/MoveTrait","game/GameSpeed","game/Coords","engine/type/ObjectType","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/unit/ZoneType","game/type/MovementZone","game/gameobject/task/system/TaskStatus","game/gameobject/task/move/MoveTask","game/math/Vector3","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e}],execute:function(){3,x=4*11.25,O=class e extends i.Task{constructor(e,t,i,s={}){super(),this.game=e,this.target=t,this.weapon=i,this.options=s,this.moveExecuted=!1,this.moveAttempts=0,this.rangeCheckCooldown=0,this.lastInRangeTargetPosition=new C.Vector3,this.lastInRangeSelfPosition=new C.Vector3,this.initialIndirectTarget=!1,this.forceDropTarget=!1,this.rangeHelper=new r.RangeHelper(e.map.tileOccupation),this.losHelper=new d.LosHelper(e.map.tiles,e.map.tileOccupation),this.targetLinesConfig={pathNodes:[]},this.updateTargetLines(this.target,!0)}duplicate(){return new e(this.game,this.target,this.weapon,this.options)}getWeapon(){return this.weapon}setWeapon(e){this.weapon=e}setForceAttack(e){this.options.force=e}requestTargetUpdate(e){this.target.equals(e)||(this.needsTargetUpdate=e)}onTargetChange(e){let t=e.attackTrait,i=this.target;t.currentTarget=i,this.lastValidTargetPosition=i.obj?{tile:i.tile,onBridge:i.getBridge()}:void 0,this.initialTargetOwner=i.obj?.isTechno()?i.obj.owner:void 0,this.initialIndirectTarget=!i.obj&&this.game.map.tileOccupation.getObjectsOnTile(i.tile).some((e=>e.isOverlay()&&!e.isBridgePlaceholder()||e.isTerrain())),this.updateTargetLines(i,!0)}updateTargetLines(e,t){this.targetLinesConfig.target=e.obj,this.targetLinesConfig.pathNodes=e.obj?[]:[{tile:e.tile,onBridge:e.getBridge()}],this.targetLinesConfig.isAttack=t}onStart(e){if(!e.attackTrait)throw new Error(`Object ${e.name} has no attack trait`);if(0!==e.ammo){let r=this.game.map.tileOccupation;var t,i;e.attackTrait.attackState=h.AttackState.CheckRange,this.onTargetChange(e),this.initialSelfPosition={tile:e.tile,onBridge:e.isUnit()&&e.onBridge?r.getBridgeOnTile(e.tile):void 0},this.weapon.rules.limboLaunch&&e.isUnit()&&!this.target.obj&&(this.forceDropTarget=!0,({reachable:t,fallback:i}=this.findReachableMeleePosition(this.target.tile,!!this.target.getBridge(),{width:1,height:1},e)),!t&&i&&(this.lastValidTargetPosition=i,this.updateTargetLines(this.game.createTarget(i.onBridge,i.tile),!1))),this.weapon.rules.limboLaunch&&this.target.obj?.isTechno()&&e.isUnit()&&!this.rangeHelper.isInWeaponRange(e,this.target.obj,this.weapon,this.game.rules)&&(({reachable:t,fallback:i}=this.findReachableMeleePosition(this.target.obj.tile,this.target.obj.isUnit()&&this.target.obj.onBridge,this.target.obj.getFoundation(),e)),t||(1<(e.unitOrderTrait.waypointPath?.waypoints?.length??0)?this.cancel():(this.forceDropTarget=!0,i&&(this.lastValidTargetPosition=i,this.updateTargetLines(this.game.createTarget(i.onBridge,i.tile),!1))))),this.rangeHelper.isInWeaponRange(e,this.target.obj??this.target.tile,this.weapon,this.game.rules)&&e.isUnit()&&e.rules.movementZone===b.MovementZone.Fly&&e.zone!==v.ZoneType.Air&&(e.rules.hoverAttack||e.isAircraft())&&this.children.push(new w.MoveTask(this.game,e.tile,!1).setCancellable(!1))}else this.cancel()}findReachableMeleePosition(e,t,i,r){let s,n=this.game.map,a=n.tileOccupation,o=t?a.getBridgeOnTile(e):void 0,l=new T.MovePositionHelper(n),c=r.rules.movementZone===b.MovementZone.Fly,h=(t,i)=>c||0<n.terrain.getPassableSpeed(t,r.rules.speedType,!!i)&&l.isEligibleTile(t,i,o,e)&&!n.terrain.findObstacles({tile:t,onBridge:i},r).length,u=new y.RadialTileFinder(n.tiles,n.mapBounds,e,i,1,Math.ceil(this.weapon.rules.range),(t=>{let i=!1;var n;return h(t,void 0)&&(s=s??{tile:t,onBridge:void 0},i=!0),void 0!==t.onBridgeLandType&&(n=a.getBridgeOnTile(t),h(t,n)&&(s=s??{tile:t,onBridge:n},i=!0)),!!i&&this.rangeHelper.isInWeaponRange(r,e,this.weapon,this.game.rules,t)}));return{reachable:u.getNextTile(),fallback:s}}onEnd(e){e.isVehicle()&&e.turretTrait&&(e.turretTrait.desiredFacing=e.direction),e.attackTrait.attackState=h.AttackState.Idle,e.attackTrait.currentTarget=void 0;var t=this.game.rules.general.prism.type;e.isBuilding()&&e.name===t&&this.weapon.type!==n.WeaponType.Secondary&&this.countSupportBeamsAndFireDownTowers(e,t),this.weapon.rules.limboLaunch&&e.attackTrait.expirePassiveScanCooldown(),(e.isInfantry()||e.isVehicle())&&(e.isFiring=!1),this.weapon.hasBurstsLeft()&&this.weapon.resetBursts()}forceCancel(e){if(e.rules.movementZone!==b.MovementZone.Fly)return!1;if(!this.cancellable||this.children.some((e=>!e.cancellable)))return!1;if(this.status===S.TaskStatus.Running||this.status===S.TaskStatus.Cancelling){if(this.children.filter((e=>e instanceof w.MoveTask)).some((t=>!t.forceCancel(e))))return!1;this.onEnd(e),(e.isInfantry()||e.isVehicle())&&(e.isFiring=!1)}return this.status=S.TaskStatus.Cancelled,!0}onTick(e){let t=e.attackTrait;(e.isInfantry()||e.isVehicle())&&t.attackState!==h.AttackState.Firing&&(e.isFiring=!1);let i=this.target.obj,r=this.children.find((e=>e instanceof a.MoveInWeaponRangeTask));if(this.isCancelling()&&t.attackState!==h.AttackState.FireUp)return!e.airSpawnTrait?.isLaunchingMissiles()&&(r?.cancel(),!0);let d=!1;if(t.attackState===h.AttackState.FireUp){if(t.isDisabled())return!0;t.attackState=h.AttackState.Firing,d=!0}if(t.attackState===h.AttackState.Firing){if(this.initialIndirectTarget&&!this.game.map.getObjectsOnTile(this.target.tile).find((e=>e.isOverlay()&&!e.isBridgePlaceholder()||e.isTerrain())))return this.cancel(),this.onTick(e);if(d){var f=this.target.obj||this.target.tile;if(!this.game.isValidTarget(this.target.obj)||this.shouldDropTarget(this.target.obj)||!this.weapon.targeting.canTarget(this.target.obj,this.target.tile,this.game,!!this.options.force,!!this.options.passive)||!this.rangeHelper.isInWeaponRange(e,f,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(e,f,this.weapon))return t.attackState=h.AttackState.CheckRange,this.onTick(e)}if(this.weapon.rules.limboLaunch){if((i?.isVehicle()||i?.isAircraft())&&i.parasiteableTrait?.isInfested())return!0;if(e.rules.movementZone!==b.MovementZone.Fly&&i?.isUnit()&&i.zone===v.ZoneType.Air)return!0}if(this.target.tile.onBridgeLandType&&e.tile.onBridgeLandType&&e.isUnit()&&(this.game.map.tileOccupation.getBridgeOnTile(this.target.tile)?.isHighBridge()||this.game.map.tileOccupation.getBridgeOnTile(e.tile)?.isHighBridge())&&(i?i.isUnit()&&(i.zone===v.ZoneType.Air||i.onBridge):this.target.isBridge())!==(e.zone===v.ZoneType.Air||e.onBridge)&&this.game.map.bridges.findHighBridgeBoundary(e.tile)?.tile===this.game.map.bridges.findHighBridgeBoundary(this.target.tile)?.tile)return!0;let s=1;if(f=this.game.rules.general.prism.type,e.isBuilding()&&e.name===f&&this.weapon.type!==n.WeaponType.Secondary&&(s=1+(f=this.countSupportBeamsAndFireDownTowers(e,f))*this.game.rules.general.prism.supportModifier),this.weapon.rules.spawner&&(e.isVehicle()||e.isAircraft())&&e.parasiteableTrait?.isParalyzed())return!0;if(0===e.ammo)return e.isAircraft()&&(e.rules.fighter||e.rules.spawned)&&r?.cancel(),!0;let a=!1;if(this.weapon.rules.limboLaunch&&r){if(!r.forceCancel(e))return!1;e.moveTrait.lastTargetOffset=void 0,e.moveTrait.lastVelocity=void 0,a=!0}return this.weapon.fire(this.target,this.game,s),!!a||(!!this.weapon.rules.fireOnce||!(!this.options.passive||!e.rules.distributedFire)||(t.attackState=h.AttackState.JustFired,!1))}if(t.attackState===h.AttackState.JustFired)return t.attackState=h.AttackState.PrepareToFire,this.onTick(e);this.needsTargetUpdate&&(this.target=this.needsTargetUpdate,i=this.target.obj,this.needsTargetUpdate=void 0,this.onTargetChange(e),i||r?.retarget(this.target.tile,!!this.target.getBridge())),i?.isTechno()&&i.replacedBy&&(T=this.game.createTarget(i.replacedBy,i.replacedBy.tile),this.target=T,i=i.replacedBy,this.onTargetChange(e));let y=this.game.isValidTarget(i)&&!this.shouldDropTarget(i);if(y){let r=this.weapon.targeting.canTarget(i,this.target.tile,this.game,!!this.options.force,!!this.options.passive);if(!r||!e.armedTrait.isEquippedWithWeapon(this.weapon)){var T=t.selectWeaponVersus(e,this.target,this.game,this.options.force,this.options.passive);if(T){if(this.setWeapon(T),t.attackState!==h.AttackState.CheckRange)return t.attackState=h.AttackState.CheckRange,this.onTick(e);r=!0}else r=!1}y=r}if(y&&(S=this.lastTargetTpCheck,i?.isUnit()&&S&&i.moveTrait.lastTeleportTick>=S?(y=!1,this.rangeCheckCooldown=0):this.lastTargetTpCheck=this.game.currentTick),y&&i&&(this.lastValidTargetPosition={tile:i.tile,onBridge:this.target.getBridge()}),y||(this.targetLinesConfig.isAttack=!1),t.attackState===h.AttackState.CheckRange){if(0<this.rangeCheckCooldown)return this.rangeCheckCooldown--,!1;let n=this.target.obj?y?this.target.obj:this.lastValidTargetPosition.tile:this.target.tile;var S=this.target.obj?y?this.target.obj.isBuilding()?this.target.obj.centerTile:this.target.obj.tile:this.lastValidTargetPosition.tile:this.target.tile;if(!this.rangeHelper.isInWeaponRange(e,n,this.weapon,this.game.rules)||!this.losHelper.hasLineOfSight(e,n,this.weapon)||e.isUnit()&&e.rules.balloonHover&&!e.rules.hoverAttack&&!r&&e.tile!==S||e.isAircraft()&&this.weapon.projectileRules.iniRot<=1&&!r){if(e.isUnit()&&!this.options.holdGround&&this.game.map.isWithinBounds(S)){if(r){if(r.target!==this.target.obj||y)if(y&&this.target.obj&&this.rangeHelper.tileDistance(this.target.obj,this.lastSelfMoveTargetTile)>this.weapon.range)r.retarget(this.target.obj,!!this.target.getBridge()),this.lastSelfTileBeforeMove=e.tile,this.lastSelfMoveTargetTile=this.target.obj?.tile??this.target.tile;else{if(void 0!==this.options.leashTiles&&this.rangeHelper.tileDistance(this.initialSelfPosition.tile,e.tile)>this.options.leashTiles)return r.cancel(),!0;var w=n instanceof u.GameObject&&n.isUnit()?n.moveTrait.baseSpeed:0,O=Math.ceil((this.rangeHelper.tileDistance(e,n)-(this.weapon.range+1))/((e.moveTrait.baseSpeed+w)/m.Coords.LEPTONS_PER_TILE));0<O&&(this.rangeCheckCooldown=Math.min(p.GameSpeed.BASE_TICKS_PER_SECOND,O))}else{let e;e=void 0!==this.options.leashTiles?this.game.createTarget(this.initialSelfPosition.onBridge,this.initialSelfPosition.tile):this.game.createTarget(this.lastValidTargetPosition.onBridge,this.lastValidTargetPosition.tile),t.currentTarget=e,r.retarget(e.tile,e.isBridge()),this.updateTargetLines(e,!1)}return!1}return!(e.moveTrait&&!e.moveTrait.isDisabled())||(!!this.isCancelling()||(e.tile===this.lastSelfTileBeforeMove||this.moveExecuted&&e.moveTrait.lastMoveResult===g.MoveResult.Fail?this.moveAttempts++:this.moveAttempts=0,!!(this.weapon.rules.limboLaunch&&e.defaultToGuardArea&&i&&this.moveExecuted&&e.moveTrait.lastMoveResult===g.MoveResult.Fail&&this.rangeHelper.isInRange(e,i,0,e.armedTrait.computeGuardScanRange(this.weapon),!0))||(this.moveAttempts>3||(0<this.moveAttempts&&this.children.push(new s.WaitMinutesTask(1/60)),w=n,O=i&&!y?this.lastValidTargetPosition.onBridge:this.target.getBridge(),r=new a.MoveInWeaponRangeTask(this.game,w,!!O,this.weapon),r.blocking=!1,this.children.push(r),this.moveExecuted=!0,this.lastSelfTileBeforeMove=e.tile,this.lastSelfMoveTargetTile=w instanceof u.GameObject?w.tile:w,this.onTick(e)))))}return!0}if(this.moveExecuted=!1,this.moveAttempts=0,r&&(e.rules.balloonHover&&!e.rules.hoverAttack||e.rules.fighter||e.rules.spawned||e.rules.movementZone===b.MovementZone.Fly&&!this.rangeHelper.isInRange2(e,this.target.obj??this.target.tile,this.weapon.minRange,this.weapon.range-1)||r.cancel()),r&&(e.isInfantry()&&!e.rules.balloonHover||this.weapon.rules.spawner))return!1;if(r?.children.some((e=>!e.cancellable))&&this.weapon.rules.limboLaunch)return!1;if(r&&r.shouldAirStrafe(e)&&this.target.obj?.isUnit()&&this.target.obj.moveTrait.isMoving()&&1<this.weapon.range&&!this.rangeHelper.isInRange2(e,this.target.obj,this.weapon.minRange,this.weapon.range-1))return!1;t.attackState=h.AttackState.PrepareToFire}if(t.attackState!==h.AttackState.PrepareToFire)return!1;if(!y||t.isDisabled())return r?.cancel(),!0;if(O=this.target.getWorldCoords(),w=e.position.worldPosition,!(this.lastInRangeTargetPosition.length()&&this.lastInRangeTargetPosition.equals(O)&&this.lastInRangeSelfPosition.length()&&this.lastInRangeSelfPosition.equals(w)))return this.lastInRangeTargetPosition.copy(O),this.lastInRangeSelfPosition.copy(w),t.attackState=h.AttackState.CheckRange,this.onTick(e);if(!(this.weapon.rules.omniFire||e.rules.omniFire&&e.rules.fighter)){w=(new C.Vector3).copy(O).sub(w);var A=o.FacingUtil.fromMapCoords(new E.Vector2(w.x,w.z));w=this.weapon.projectileRules.rot?x:11.25;if((e.isVehicle()||e.isBuilding())&&e.turretTrait){if(e.turretTrait.desiredFacing=A,Math.abs(A-e.turretTrait.facing)>=w)return!1}else if(Math.abs(A-e.direction)>=w){if(e.isAircraft())return e.direction=o.FacingUtil.tick(e.direction,A,e.rules.rot).facing,!1;if(r)return!1;if(e.isVehicle())return!!this.options.disallowTurning||(this.children.push(new l.TurnTask(A)),!1);e.direction=A}}return this.losHelper.hasLineOfSight(e,this.target.obj||this.target.tile,this.weapon)?!t.isOnCooldown(e)&&((!this.weapon.warhead.rules.temporal||e.temporalTrait.getTarget()!==this.target.obj)&&(this.weapon.rules.suicide&&this.weapon.type!==n.WeaponType.DeathWeapon?(this.game.destroyObject(e,{player:e.owner,obj:e,weapon:this.weapon}),!0):(A=this.game.rules.general.prism.type,e.isBuilding()&&e.name===A&&this.weapon.type!==n.WeaponType.Secondary&&this.fireUpPrismSupportTowers(e,A),(e.isInfantry()||e.isVehicle())&&(e.isFiring=!0),e.art.fireUp?(this.children.push(new c.WaitTicksTask(e.art.fireUp).setCancellable(!1)),t.attackState=h.AttackState.FireUp,!1):(t.attackState=h.AttackState.Firing,this.onTick(e))))):(t.attackState=h.AttackState.CheckRange,this.onTick(e))}shouldDropTarget(e){return this.forceDropTarget||e?.isTechno()&&(this.weapon.rules.limboLaunch&&((e.isVehicle()||e.isAircraft())&&e.parasiteableTrait?.isInfested()||e.invulnerableTrait.isActive())||e.warpedOutTrait.isInvulnerable()&&!this.weapon.warhead.rules.temporal||this.initialTargetOwner!==e.owner)}fireUpPrismSupportTowers(e,t){var i;for(i of e.owner.getOwnedObjectsByType(f.ObjectType.Building).filter((e=>e.name===t&&e.secondaryWeapon&&!e.unitOrderTrait.hasTasks()&&e.attackTrait&&!e.attackTrait.isDisabled()&&!e.attackTrait.isOnCooldown(e))).filter((t=>this.rangeHelper.isInWeaponRange(t,e,t.secondaryWeapon,this.game.rules))).slice(0,this.game.rules.general.prism.supportMax))i.unitOrderTrait.addTask(i.attackTrait.createAttackTask(this.game,e,e.centerTile,i.secondaryWeapon,{passive:!0}))}countSupportBeamsAndFireDownTowers(e,t){var i,r=e.owner.getOwnedObjectsByType(f.ObjectType.Building).filter((i=>i.name===t&&i.attackTrait?.currentTarget?.obj===e));for(i of r)i.unitOrderTrait.getCurrentTask()?.cancel();return Math.min(this.game.rules.general.prism.supportMax,r.length)}getTargetLinesConfig(){return this.targetLinesConfig}},e("AttackTask",O)}}})),System.register("game/gameobject/trait/ParasiteableTrait",["game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","game/gameobject/Vehicle","game/gameobject/trait/interface/NotifyAttack","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyHeal","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/type/MovementZone","game/gameobject/task/system/WaitMinutesTask","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/AttackTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=()=>s.ROCKING_TICKS+2,y=class{constructor(e){this.gameObject=e,this.beingBoarded=!1}infest(e,t){this.beingBoarded=!1,this.parasite=e,this.parasiteWeapon=t,e.rules.organic?this.damageTickCooldown=f():this.damageTickCooldown=0,this.lastExternalDamageInflicted=void 0,this.lastExternalDamageTick=void 0,t.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!0)}isInfested(){return!(!this.parasite||this.parasite.isDestroyed)||this.beingBoarded}isParalyzed(){return!!this.parasiteWeapon?.warhead.rules.paralyzes}uninfest(){this.parasite&&(this.parasiteWeapon.warhead.rules.paralyzes&&this.gameObject.moveTrait.setDisabled(!1),this.parasite=void 0,this.parasiteWeapon=void 0)}getParasite(){return this.parasite}[h.NotifyTick.onTick](e,t){if(this.parasite)if(this.parasite.isDestroyed)this.uninfest();else if(0<this.damageTickCooldown)this.damageTickCooldown--;else{let i=this.parasiteWeapon;this.damageTickCooldown=this.parasite.rules.organic?f():i.getCooldownTicks();let s=i.rules.damage;this.parasite.veteranTrait&&(s*=this.parasite.veteranTrait.getVeteranDamageMultiplier());let n=i.warhead.computeDamage(s,e);this.canBeCulled(e,this.parasite,i,t)&&(n=e.healthTrait.getHitPoints()),i.warhead.inflictDamage(n,e,{player:this.parasite.owner,obj:this.parasite,weapon:i},t),e.isCrashing?(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(e,t)):!e.isDestroyed&&e.isVehicle()&&e.zone!==r.ZoneType.Air&&i.warhead.rules.rocker&&e.applyRocking(90*(.5<=t.generateRandom()?1:-1),1)}}canBeCulled(e,t,i,r){if(!i.warhead.rules.culling)return!1;var s=r.rules.audioVisual;s=t.veteranTrait?.isElite()?s.conditionYellow:s.conditionRed;return e.healthTrait.health<=100*s}[o.NotifyHeal.onHeal](e,t,r,s){var n;!this.parasite||this.parasite.isDestroyed||s===e||e.isAircraft()&&s?.rules.unitReload||(this.parasite.rules.organic?(n=this.parasite,this.evictOrDestroyParasite(e,t),this.stunParasite(n,t)):(this.parasite.deathType=i.DeathType.None,t.destroyObject(this.parasite,s?{player:s.owner,obj:s}:void 0),this.uninfest()))}[l.NotifyDamage.onDamage](e,t,i,r){r?.obj!==this.parasite&&(this.lastExternalDamageInflicted=i,this.lastExternalDamageTick=t.currentTick)}[n.NotifyAttack.onAttack](e,t,i){if(this.parasite&&!this.parasite.isDestroyed&&t?.weapon?.warhead.rules.sonic){var r,s=this.parasite;this.evictOrDestroyParasite(e,i),this.stunParasite(s,i);let n=t.weapon.warhead;n.canDamage(s,s.tile,s.zone)&&(r=n.computeDamage(t.weapon.rules.damage,s),n.inflictDamage(r,s,t,i));let a=t.obj?.unitOrderTrait.getCurrentTask();a instanceof m.AttackTask&&a.getWeapon().warhead.rules.sonic&&a.cancel()}}[a.NotifyDestroy.onDestroy](e,t,r,s){this.parasite&&!this.parasite.isDestroyed&&(s||!this.parasite.invulnerableTrait.isActive()&&this.shouldSupressParasite(t,this.parasite,r)?(this.parasite.deathType=i.DeathType.None,t.destroyObject(this.parasite,r,s),this.uninfest()):(this.parasiteWeapon.expireCooldown(),this.evictOrDestroyParasite(e,t)))}shouldSupressParasite(e,t,i){return i?.obj!==t||this.lastExternalDamageInflicted&&this.lastExternalDamageInflicted>t.rules.suppressionThreshold&&e.currentTick-this.lastExternalDamageTick<2*this.lastExternalDamageInflicted}[c.NotifyTeleport.onBeforeTeleport](e,t,i,r){var s;i&&r&&this.parasite&&!this.parasite.isDestroyed&&(this.parasiteWeapon.expireCooldown(),s=this.parasite,this.evictOrDestroyParasite(e,t,!0),s.isDestroyed||this.stunParasite(s,t))}stunParasite(e,t){e.unitOrderTrait.addTaskToFront(new d.WaitMinutesTask(10/60).setCancellable(!1)),e.isVehicle()&&e.submergibleTrait&&(e.submergibleTrait.emerge(e,t),e.cloakableTrait?.uncloak(t),e.submergibleTrait.setCooldown(10*g.GameSpeed.BASE_TICKS_PER_SECOND))}evictOrDestroyParasite(e,t,s=!1){if(this.parasite&&!this.parasite.isDestroyed){var n=e.zone===r.ZoneType.Air;if(n&&this.parasite.rules.movementZone!==u.MovementZone.Fly||!n&&!t.map.terrain.getPassableSpeed(e.tile,this.parasite.rules.speedType,e.onBridge)&&!t.map.getObjectsOnTile(e.tile).find((e=>e.isBuilding())))this.parasite.deathType=i.DeathType.None,t.destroyObject(this.parasite,{player:e.owner,obj:e});else{let r=e.tile,a=e.onBridge;if(!s&&!e.isDestroyed||this.parasite.rules.organic){if(!(n=new p.RadialTileFinder(t.map.tiles,t.map.mapBounds,r,{width:1,height:1},1,1,(e=>0<t.map.terrain.getPassableSpeed(e,this.parasite.rules.speedType,a)&&!t.map.terrain.findObstacles({tile:e,onBridge:a},this.parasite).length)).getNextTile()))return this.parasite.deathType=i.DeathType.None,t.destroyObject(this.parasite,{player:e.owner,obj:e}),void this.uninfest();r=n}this.parasite.onBridge=a,this.parasite.position.subCell=this.parasite.isInfantry()?e.position.subCell:0,this.parasite.zone=t.map.getTileZone(r,!a),this.parasite.position.tileElevation=a?t.map.tileOccupation.getBridgeOnTile(r).tileElevation:0,this.parasite.resetGuardModeToIdle(),t.unlimboObject(this.parasite,r,!0)}this.uninfest()}}destroyParasite(e,t){this.parasite&&(this.parasite.deathType=i.DeathType.None,t.destroyObject(this.parasite,e),this.uninfest())}dispose(){this.gameObject=void 0}},e("ParasiteableTrait",y)}}})),System.register("game/event/ObjectCrashingEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectCrashingEvent",class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectCrashing}})}}})),System.register("game/gameobject/unit/TargetUtil",["game/math/Vector3","game/math/geometry","game/math/GameMath"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("TargetUtil",class{static computeInterceptPoint(e,t,r,n){let a=e.clone().sub(r);var o,l=t*t-(o=n.length())*o,c=2*a.dot(n);return c*c-4*l*(o=-a.dot(a))<0?new i.Vector3:(l=(-c+s.GameMath.sqrt(c*c-4*l*o))/(2*l),n.clone().multiplyScalar(l).add(r))}static computeTurnCircle(e,t,i,s){var n=s/r.degToRad(Math.abs(i));let a=r.rotateVec2(t.clone(),90*-Math.sign(i));return{center:isFinite(n)?a.setLength(n).add(e):e.clone(),radius:n}}})}}})),System.register("game/event/ObjectLiftOffEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectLiftOffEvent",class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectLiftOff}})}}})),System.register("game/event/ObjectLandEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectLandEvent",class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectLand}})}}})),System.register("game/gameobject/locomotor/JumpjetLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("JumpjetLocomotor",class{constructor(e){this.game=e,this.allowOutOfBounds=!0,this.currentMoveDir=new u.Vector2,this.currentHorizSpeed=0}static tickStationary(e,t){if(e.zone===a.ZoneType.Air){var r=e.tile.onBridgeLandType?t.map.tileOccupation.getBridgeOnTile(e.tile):void 0,s=!e.rules.balloonHover&&(!e.unitOrderTrait.getCurrentTask()?.preventLanding||!e.rules.hoverAttack)&&(t.map.getGroundObjectsOnTile(e.tile).find((t=>t.isBuilding()&&t.dockTrait?.isDocked(e)))||t.map.getTileZone(e.tile)!==a.ZoneType.Water&&0<t.map.terrain.getPassableSpeed(e.tile,c.SpeedType.Foot,!!e.tile.onBridgeLandType)&&0===t.map.terrain.findObstacles({tile:e.tile,onBridge:r},e).length);let g;g=s?(n=e.tile.z+(r?.tileElevation??0),i.Coords.tileHeightToWorld(n)):(o=e.tile.z+t.map.getGroundObjectsOnTile(e.tile).filter((e=>!(e.isInfantry()&&e.stance===h.StanceType.Paradrop))).reduce(((e,t)=>Math.max(e,t.tileElevation+t.art.height)),0),i.Coords.tileHeightToWorld(o)+e.rules.jumpjetHeight);var n,o,u=e.position.worldPosition.y;g!==u?(n=e.rules.jumpjetClimb,o=Math.abs(g-u),n=Math.sign(g-u)*Math.min(n,o),o=e.tileElevation,e.position.moveByLeptons3(new d.Vector3(0,n,0)),e.moveTrait.handleElevationChange(o,t)):s&&(e.zone=a.ZoneType.Ground,e.onBridge=!!r,t.events.dispatch(new l.ObjectLandEvent(e)))}}static tickCrash(e,t,i){var r=2*e.rules.jumpjetCrash;return e.direction=(e.direction-6+360)%360,new d.Vector3(0,-r,0)}onNewWaypoint(e,t,i){this.currentMoveDir=r.FacingUtil.toMapCoords(e.direction),this.cancelDestLeptons=void 0}tick(e,t,l,c){if(e.zone!==a.ZoneType.Air&&(e.onBridge=!1,e.zone=a.ZoneType.Air,this.game.events.dispatch(new o.ObjectLiftOffEvent(e))),c){if(!this.cancelDestLeptons){let t=e.tile;this.game.map.isWithinBounds(t)||(t=this.game.map.clampWithinBounds(t)),this.cancelDestLeptons=this.computeCancelDest(t,l)}l=this.cancelDestLeptons}var u=e.position.getMapPosition();let g=l.clone().sub(u);var p=this.findTilesToCheckForBlockers(e.tile,u,this.currentMoveDir,g.length()).map((e=>e.z+this.game.map.getGroundObjectsOnTile(e).filter((e=>!(e.isDestroyed||e.isInfantry()&&e.stance===h.StanceType.Paradrop))).reduce(((e,t)=>Math.max(e,t.tileElevation+t.art.height)),0))).reduce(((e,t)=>Math.max(e,t)),0);let m=0;(void 0===this.lastClearZ||2<p-this.lastClearZ)&&(m=4);var f,y=i.Coords.tileHeightToWorld(p),T=i.Coords.tileHeightToWorld(p+m),v=e.position.worldPosition.y,b=r.FacingUtil.fromMapCoords(g),S=g.length()<e.rules.jumpjetSpeed;let w=0;y<=v&&!S&&(({facing:A,delta:f}=r.FacingUtil.tick(e.direction,b,e.rules.jumpjetTurnRate)),w=f,e.direction=A,this.currentMoveDir.copy(r.FacingUtil.toMapCoords(e.direction))),e.isVehicle()&&(e.spinVelocity=w);let C,E=!1,x=0,O=0;var A=e.rules.jumpjetClimb;let M;v<T?(x=Math.min(A,T-v),C=!1,this.currentHorizSpeed=0):(this.lastClearZ=p,C=!0,(p=y+e.rules.jumpjetHeight)!==v&&(y=Math.abs(p-v),x=Math.sign(p-v)*Math.min(A,y),C=y<=A),A=this.currentHorizSpeed,this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,e.rules.jumpjetSpeed),E=b===e.direction?(O=Math.min(A,g.length()),A>=g.length()):((u=A||w?s.TargetUtil.computeTurnCircle(u,this.currentMoveDir,Math.sign(w)*e.rules.jumpjetTurnRate,A):void 0)&&n.circleContainsPoint(u,l)?(O=0,this.currentHorizSpeed=0):O=A,!1)),M=S?(E=!0,g):this.currentMoveDir.clone().setLength(O);let R=new d.Vector3(M.x,x,M.y);return S=R.clone(),e.moveTrait.velocity.copy(S),{distance:R,done:E&&C}}findTilesToCheckForBlockers(e,t,r,s){var n=r.clone().setLength(Math.min(s,i.Coords.LEPTONS_PER_TILE)).add(t).multiplyScalar(1/i.Coords.LEPTONS_PER_TILE).floor(),a=this.game.map.tiles.getByMapCoords(n.x,n.y);if(!a||a===e)return[e];n=Math.sign(a.rx-e.rx),a=Math.sign(a.ry-e.ry);let o,l=[e];return n&&(o=this.game.map.tiles.getByMapCoords(e.rx+n,e.ry),o&&l.push(o)),a&&(o=this.game.map.tiles.getByMapCoords(e.rx,e.ry+a),o&&l.push(o)),n&&a&&(o=this.game.map.tiles.getByMapCoords(e.rx+n,e.ry+a),o&&l.push(o)),l}computeCancelDest(e,t){var r=t.clone().multiplyScalar(1/i.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(i.Coords.LEPTONS_PER_TILE);r=t.clone().sub(r);return new u.Vector2(e.rx,e.ry).multiplyScalar(i.Coords.LEPTONS_PER_TILE).add(r)}})}}})),System.register("game/gameobject/task/MoveToDockTask",["game/gameobject/task/system/Task","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/type/MovementZone","game/gameobject/trait/interface/NotifyTick","game/Coords","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var t;(t=d=d||{})[t.Idle=0]="Idle",t[t.MoveToQueueingTile=1]="MoveToQueueingTile",t[t.WaitForTurn=2]="WaitForTurn",t[t.MoveToDock=3]="MoveToDock",t[t.Docking=4]="Docking",t[t.Docked=5]="Docked",g=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.useChildTargetLines=!0,this.preventOpportunityFire=!1,this.dockingStatus=d.Idle}onStart(e){if(!this.target.dockTrait)throw new Error(`Target object "${this.target.name}" is not a valid dock`);var t;this.target.dockTrait.hasReservedDockForUnit(e)?this.dockingStatus=d.MoveToDock:void 0!==(t=this.target.dockTrait.getFirstAvailableDockNumber())?(this.target.dockTrait.reserveDockAt(e,t),this.dockingStatus=d.MoveToDock):this.target.helipadTrait?this.cancel():this.dockingStatus=d.MoveToQueueingTile}onEnd(e){this.dockingStatus!==d.Docked&&this.target.isSpawned&&(this.target.dockTrait.undockUnit(e),this.target.dockTrait.unreserveDockForUnit(e)),this.dockingStatus=d.Idle}onTick(e){if(this.isCancelling())return!0;if(!this.isValidTarget(this.target,e))return!0;if(this.dockingStatus===d.MoveToQueueingTile){var t=this.findReachableQueueingTile(e);if(!t)return!0;if(e.tile!==t)return this.children.push(new s.MoveTask(this.game,t,!1,{closeEnoughTiles:5}),new a.CallbackTask((()=>{e.moveTrait.lastMoveResult===o.MoveResult.Fail?this.cancel():e.moveTrait.lastMoveResult===o.MoveResult.CloseEnough&&(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)||(this.dockingStatus=d.WaitForTurn))}))),!1;this.dockingStatus=d.WaitForTurn}if(this.dockingStatus===d.WaitForTurn){if(void 0===(r=this.target.dockTrait.getFirstAvailableDockNumber()))return this.children.push(new n.WaitMinutesTask(1/60)),!1;this.target.dockTrait.reserveDockAt(e,r),this.dockingStatus=d.MoveToDock}if(this.dockingStatus===d.MoveToDock){var i=this.target.dockTrait.getReservedDockForUnit(e),r=this.target.dockTrait.getDockTile(i);i=h.Coords.vecWorldToGround(this.target.dockTrait.getDockOffset(i)).add(this.target.position.getMapPosition()).sub(new u.Vector2(r.rx,r.ry).multiplyScalar(h.Coords.LEPTONS_PER_TILE));if(e.tile!==r)return this.children.push(new s.MoveTask(this.game,r,!1,{targetOffset:e.isAircraft()?i:void 0,closeEnoughTiles:0,strictCloseEnough:!0}),new a.CallbackTask((()=>{e.moveTrait.lastMoveResult===o.MoveResult.Fail&&this.cancel()}))),this.game.afterTick((()=>e.unitOrderTrait[c.NotifyTick.onTick](e,this.game))),!1;this.dockingStatus=d.Docking}return this.dockingStatus===d.Docking&&(i=this.target.dockTrait.getReservedDockForUnit(e),this.target.dockTrait.unreserveDockForUnit(e),this.target.dockTrait.dockUnitAt(e,i),e.isAircraft()&&e.airportBoundTrait&&this.target.helipadTrait&&(e.airportBoundTrait.preferredAirport=this.target),this.dockingStatus=d.Docked,!0)}isValidTarget(e,t){return e.isSpawned&&this.game.areFriendly(e,t)}findReachableQueueingTile(e){var t=this.target.getFoundation();t=new u.Vector2(this.target.tile.rx+t.width,this.target.tile.ry+t.height);return(t=this.game.map.tiles.getByMapCoords(t.x,t.y))&&this.isValidQueueingTile(t,e)?t:new r.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,(t=>this.isValidQueueingTile(t,e))).getNextTile()}isValidQueueingTile(e,t){return(t.rules.movementZone===l.MovementZone.Fly||0<this.game.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&Math.abs(e.z-this.target.tile.z)<2&&!e.onBridgeLandType&&!this.game.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length)&&!this.game.map.tileOccupation.isTileOccupiedBy(e,this.target)}},e("MoveToDockTask",g)}}})),System.register("game/gameobject/locomotor/WingedLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/gameobject/unit/TargetUtil","util/geometry","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/event/ObjectLandEvent","game/type/SpeedType","game/gameobject/task/MoveToDockTask","game/gameobject/trait/interface/NotifyTick","game/math/Vector2","game/math/Vector3","util/math","game/math/GameMath"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){var t;(t=f=f||{})[t.None=0]="None",t[t.CircleStrafe=1]="CircleStrafe",t[t.HoverStrafe=2]="HoverStrafe",e("WingedLocomotor",class{constructor(e){this.game=e,this.allowOutOfBounds=!0,this.lastDestLeptons=new d.Vector2,this.currentMoveDir=new d.Vector2,this.currentHorizSpeed=0,this.maneuverType=f.None,this.deceleratingToTurn=!1}static tickStationary(e,t){if(e.zone===a.ZoneType.Air){var s=e.tile.onBridgeLandType?t.map.tileOccupation.getBridgeOnTile(e.tile):void 0;let m,f=e.rules.landable&&!e.unitOrderTrait.getCurrentTask()?.preventLanding,y=e.spawnLinkTrait?.getParent();if(f&&y?f=!((!y.isUnit()||!y.onBridge)&&s||y.tile!==e.tile):f&&!e.airportBoundTrait&&(f=t.map.getTileZone(e.tile)!==a.ZoneType.Water&&0<t.map.terrain.getPassableSpeed(e.tile,c.SpeedType.Foot,!!e.tile.onBridgeLandType)&&0===t.map.terrain.findObstacles({tile:e.tile,onBridge:s},e).length),f){let a=e.airportBoundTrait?.preferredAirport?.dockTrait;var n=a?.isDocked(e)||a?.hasReservedDockForUnit(e);if(!e.airportBoundTrait||n){var o=n?0:270;if(e.direction!==o)return void(e.direction=r.FacingUtil.tick(e.direction,o,e.rules.rot).facing)}if(e.airportBoundTrait){let i=e.airportBoundTrait.preferredAirport;if(!i?.dockTrait?.isDocked(e))return i?.dockTrait?.getAvailableDockCount()||(i=e.airportBoundTrait.findAvailableAirport(e),e.airportBoundTrait.preferredAirport=i,i&&(o=i.dockTrait.getFirstAvailableDockNumber(),i.dockTrait.reserveDockAt(e,o))),void(i?(e.unitOrderTrait.addTask(new h.MoveToDockTask(t,i)),e.unitOrderTrait[u.NotifyTick.onTick](e,t)):e.crashableTrait.crash(void 0))}let l;l=y?y.tile.z+y.tileElevation:e.tile.z+(s?.tileElevation??0),m=i.Coords.tileHeightToWorld(l)}else{var d=e.tile.z+(s?.tileElevation??0),p=e.rules.flightLevel??t.rules.general.flightLevel;m=i.Coords.tileHeightToWorld(d)+p}m!==(d=e.position.worldPosition.y)?(p=Math.abs(m-d),d=Math.sign(m-d)*Math.min(30,p),p=e.tileElevation,e.position.moveByLeptons3(new g.Vector3(0,d,0)),e.moveTrait.handleElevationChange(p,t)):f&&(e.zone=a.ZoneType.Ground,y?y.airSpawnTrait.storeAircraft(e,t):e.onBridge=!!s,t.events.dispatch(new l.ObjectLandEvent(e)))}}static tickCrash(e,t,r){r.rollDelta??(r.rollDelta=t.generateRandomInt(-15,15)),r.pitchDelta??(r.pitchDelta=t.generateRandomInt(0,15)),e.roll+=r.rollDelta,e.pitch+=r.pitchDelta;var s=i.Coords.vecWorldToGround(e.moveTrait.velocity);return new g.Vector3(s.x,-30,s.y)}onNewWaypoint(e,t,r){this.currentHorizSpeed=i.Coords.vecWorldToGround(e.moveTrait.velocity).length(),this.cancelDestLeptons=void 0}tick(e,t,l,c){if(c){if(!this.cancelDestLeptons){let t=e.tile;this.game.map.isWithinBounds(t)||(t=this.game.map.clampWithinBounds(t)),this.cancelDestLeptons=this.computeCancelDest(t,l)}l=this.cancelDestLeptons}var h=e.position.getMapPosition();let u=l.clone().sub(h);var d=u.length();this.lastDestLeptons.equals(l)||(this.lastDestLeptons.copy(l),c?this.maneuverType=f.HoverStrafe:e.zone===a.ZoneType.Air&&this.currentHorizSpeed<5?this.maneuverType=d>i.Coords.LEPTONS_PER_TILE?f.CircleStrafe:f.HoverStrafe:this.maneuverType=f.None,this.deceleratingToTurn=!1),e.zone!==a.ZoneType.Air&&(e.onBridge=!1,e.zone=a.ZoneType.Air,this.game.events.dispatch(new o.ObjectLiftOffEvent(e)));var y=e.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(e.tile):void 0,T=e.tile.z+(y?.tileElevation??0),v=e.rules.flightLevel??this.game.rules.general.flightLevel,b=i.Coords.tileHeightToWorld(T)+v,S=(y=e.position.worldPosition.y,r.FacingUtil.fromMapCoords(u));let w;switch(e.direction===S&&this.maneuverType===f.None&&d<=i.Coords.LEPTONS_PER_TILE?this.maneuverType=f.HoverStrafe:e.direction===S&&this.maneuverType===f.CircleStrafe&&(this.maneuverType=f.None),this.maneuverType){case f.HoverStrafe:if(e.attackTrait?.currentTarget){let t=i.Coords.vecWorldToGround(e.attackTrait.currentTarget.getWorldCoords());w=r.FacingUtil.fromMapCoords(t.sub(h))}else w=e.airportBoundTrait?.preferredAirport?.dockTrait?.hasReservedDockForUnit(e)?0:270;break;case f.CircleStrafe:case f.None:w=S;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}var{facing:C,delta:E}=r.FacingUtil.tick(e.direction,w,e.rules.rot);let x;switch(e.direction=C,e.roll=Math.sign(E)*e.rules.pitchAngle,this.maneuverType){case f.HoverStrafe:x=S;break;case f.CircleStrafe:x=(C-90*Math.sign(E)+360)%360;break;case f.None:x=C;break;default:throw new Error('Unknown maneuver type "'+this.maneuverType)}void 0===this.thrustFacing&&(this.thrustFacing=x);T=5<this.currentHorizSpeed?e.rules.rot:Number.POSITIVE_INFINITY;var{facing:v,delta:T}=r.FacingUtil.tick(this.thrustFacing,x,T);this.thrustFacing=v,this.currentMoveDir.copy(r.FacingUtil.toMapCoords(this.thrustFacing));let O=!1,A=0,M=0,R=!0;b!==y&&(I=Math.abs(b-y),A=Math.sign(b-y)*Math.min(30,I),R=I<=30);let P=e.rules.speed;d<=i.Coords.LEPTONS_PER_TILE&&this.maneuverType!==f.CircleStrafe&&(P=p.lerp(1,P/2,m.GameMath.sqrt(d/i.Coords.LEPTONS_PER_TILE))),this.deceleratingToTurn?this.currentHorizSpeed=Math.max(0,this.currentHorizSpeed-2):this.currentHorizSpeed=Math.min(this.currentHorizSpeed+2,P);var I=this.currentHorizSpeed;let k;this.deceleratingToTurn=!1,O=T?(T=I||T?s.TargetUtil.computeTurnCircle(h,this.currentMoveDir,Math.sign(T)*e.rules.rot,I):void 0,0!==I&&!n.circleContainsPoint(T,l)||(this.maneuverType===f.HoverStrafe||d>i.Coords.LEPTONS_PER_TILE?this.deceleratingToTurn=!0:this.maneuverType===f.None&&(this.maneuverType=f.HoverStrafe)),M=I,!1):(M=Math.min(I,d),d<=I),k=d<1?(O=!0,u):O?u:this.currentMoveDir.clone().setLength(M);let B=new g.Vector3(k.x,A,k.y);return d=B.clone(),e.moveTrait.velocity.copy(d),{distance:B,done:O&&R}}computeCancelDest(e,t){var r=t.clone().multiplyScalar(1/i.Coords.LEPTONS_PER_TILE).floor().multiplyScalar(i.Coords.LEPTONS_PER_TILE);r=t.clone().sub(r);return new d.Vector2(e.rx,e.ry).multiplyScalar(i.Coords.LEPTONS_PER_TILE).add(r)}})}}})),System.register("game/gameobject/trait/interface/NotifyCrash",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onCrash=Symbol(),e("NotifyCrash",i)}}})),System.register("game/gameobject/trait/CrashableTrait",["game/event/ObjectCrashingEvent","game/type/LocomotorType","game/gameobject/trait/interface/NotifyTick","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/WingedLocomotor","game/gameobject/trait/interface/NotifyCrash"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class{constructor(e){this.gameObject=e,this.crashingEvtSent=!1,this.crashState={}}[s.NotifyTick.onTick](e,t){if(e.isCrashing){if(this.crashingEvtSent||(this.crashingEvtSent=!0,e.traits.filter(o.NotifyCrash).forEach((i=>i[o.NotifyCrash.onCrash](e,t))),t.events.dispatch(new i.ObjectCrashingEvent(e))),e.rules.locomotor!==r.LocomotorType.Jumpjet&&e.rules.locomotor!==r.LocomotorType.Aircraft)throw new Error("Crashing logic not implemented for locomotor "+r.LocomotorType[e.rules.locomotor]);{let i;if(e.rules.locomotor===r.LocomotorType.Jumpjet)i=n.JumpjetLocomotor.tickCrash(e,t,this.crashState);else{if(e.rules.locomotor!==r.LocomotorType.Aircraft)throw new Error(`Unhandled locomotor type "${e.rules.locomotor}"`);if(!e.isAircraft())throw new Error(`Obj "${e.name}#${e.id} is not an aircraft`);i=a.WingedLocomotor.tickCrash(e,t,this.crashState)}let o=!1;var s,l,c=i.clone().add(e.position.worldPosition);t.map.isWithinHardBounds(c)?(l=e.tile,s=e.tileElevation,e.position.moveByLeptons3(i),e.tile!==l&&e.moveTrait.handleTileChange(l,void 0,!1,t),l=(c=e.tile.onBridgeLandType?t.map.tileOccupation.getBridgeOnTile(e.tile):void 0)?.tileElevation??0,e.position.tileElevation=Math.max(e.position.tileElevation,l),e.position.tileElevation===l&&(e.zone=t.map.getTileZone(e.tile),e.onBridge=!!c,o=!0),e.tileElevation!==s&&e.moveTrait.handleElevationChange(s,t)):o=!0,o&&t.destroyObject(e,this.attackerInfo)}}}crash(e){this.attackerInfo=e,this.gameObject.isCrashing=!0,this.gameObject.cachedTraits.tick.length=0,this.gameObject.cachedTraits.tick=[this]}dispose(){this.gameObject=void 0}},e("CrashableTrait",l)}}})),System.register("game/event/ShipSubmergeChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ShipSubmergeChangeEvent",class{constructor(e){this.target=e,this.type=i.EventType.ShipSubmergeChange}})}}})),System.register("game/gameobject/trait/SubmergibleTrait",["game/event/ShipSubmergeChangeEvent","game/GameSpeed","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class{constructor(){this.isActive=!1}isSubmerged(){return this.isActive}setCooldown(e){this.cooldownTicks=e}[a.NotifyTick.onTick](e,t){this.isActive||e.parasiteableTrait?.isInfested()||(e.attackTrait&&e.attackTrait.attackState!==s.AttackState.Idle&&!e.moveTrait.isMoving()?this.cooldownTicks=Math.max(this.cooldownTicks??0,5*r.GameSpeed.BASE_TICKS_PER_SECOND):this.cooldownTicks??(this.cooldownTicks=Math.floor(60*t.rules.general.cloakDelay*r.GameSpeed.BASE_TICKS_PER_SECOND)),0<this.cooldownTicks&&this.cooldownTicks--,this.cooldownTicks<=0&&(this.isActive=!0,t.events.dispatch(new i.ShipSubmergeChangeEvent(e))))}[n.NotifyDamage.onDamage](e,t){this.emerge(e,t)}emerge(e,t){this.isActive&&(this.isActive=!1,this.cooldownTicks=void 0,t.events.dispatch(new i.ShipSubmergeChangeEvent(e)))}},e("SubmergibleTrait",o)}}})),System.register("game/gameobject/trait/interface/NotifyTileChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onTileChange=Symbol(),e("NotifyTileChange",i)}}})),System.register("game/gameobject/trait/HoverBobTrait",["game/GameSpeed","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","game/Coords","game/gameobject/trait/interface/NotifyTileChange","game/math/GameMath"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class{constructor(){this.prevHoverBobLeptons=0,this.spawnTick=0}[s.NotifySpawn.onSpawn](e,t){this.setBaseElevation(e,t),this.spawnTick=t.currentTick}[a.NotifyTileChange.onTileChange](e,t,i,r){r&&(this.prevHoverBobLeptons=0,this.setBaseElevation(e,t))}setBaseElevation(e,t){e.position.tileElevation=(e.onBridge?t.map.tileOccupation.getBridgeOnTile(e.tile)?.tileElevation??0:0)+n.Coords.worldToTileHeight(t.rules.general.hover.height)}[r.NotifyTick.onTick](e,t){var i=this.computeHoverBobLeptons(t.currentTick,t.rules.general.hover),r=i-this.prevHoverBobLeptons;this.prevHoverBobLeptons=i,i=n.Coords.tileHeightToWorld(e.position.tileElevation),e.position.tileElevation=n.Coords.worldToTileHeight(i+r)}computeHoverBobLeptons(e,t){var r=(e-this.spawnTick)/i.GameSpeed.BASE_TICKS_PER_SECOND/(60*t.bob);return.1*t.height*o.GameMath.sin(2*r*Math.PI)}},e("HoverBobTrait",l)}}})),System.register("game/gameobject/unit/CrateBonuses",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CrateBonuses",class{constructor(){this.firepower=1,this.armor=1,this.speed=1}})}}})),System.register("game/gameobject/trait/TilterTrait",["game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTileChange"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.tilt={pitch:0,yaw:0}}[i.NotifySpawn.onSpawn](e){this.tilt=this.computeTilt(e.tile.rampType)}[r.NotifyTileChange.onTileChange](e){this.tilt=this.computeTilt(e.tile.rampType)}computeTilt(e){let t,i;return 0===e||17<=e?t=i=0:i=e<=4?(t=25,-90*e):(t=25,225-(e-1)%4*90),{pitch:t,yaw:i}}},e("TilterTrait",s)}}})),System.register("game/gameobject/Vehicle",["engine/type/ObjectType","game/gameobject/trait/HarvesterTrait","game/gameobject/trait/TransportTrait","game/gameobject/trait/MoveTrait","game/gameobject/trait/TurretTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/GunnerTrait","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/SubmergibleTrait","game/type/LocomotorType","game/gameobject/trait/HoverBobTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/TilterTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){e("ROCKING_TICKS",34),v=class extends c.Techno{constructor(e,t,r){super(i.ObjectType.Vehicle,e,t,r),this.direction=0,this.spinVelocity=0,this.crateBonuses=new y.CrateBonuses,this.turretNo=0,this.onBridge=!1,this.isSinker=!1,this.isFiring=!1,this.zone=t.naval?o.ZoneType.Water:o.ZoneType.Ground}get isMoving(){return this.moveTrait.isMoving()}static factory(e,t,i,o,c){let y=new this(e,t,i);return y.isSinker=!t.underwater&&(t.weight>=o.general.shipSinkingWeight||!t.naval),y.moveTrait=new n.MoveTrait(y,c),y.traits.add(y.moveTrait),t.crashable&&(y.crashableTrait=new g.CrashableTrait(y),y.traits.add(y.crashableTrait)),t.crewed&&(y.crewedTrait=new h.CrewedTrait,y.traits.add(y.crewedTrait)),t.harvester&&(y.harvesterTrait=new r.HarvesterTrait(t.storage),y.traits.add(y.harvesterTrait)),t.passengers&&(y.transportTrait=new s.TransportTrait(y),y.traits.add(y.transportTrait),t.gunner&&(y.gunnerTrait=new u.GunnerTrait,y.traits.add(y.gunnerTrait))),t.turret&&(y.turretTrait=new a.TurretTrait,y.traits.add(y.turretTrait)),t.consideredAircraft&&!t.landable||y.traits.add(new l.DockableTrait),t.parasiteable&&(y.parasiteableTrait=new d.ParasiteableTrait(y),y.traits.add(y.parasiteableTrait)),t.naval&&t.underwater&&(y.submergibleTrait=new p.SubmergibleTrait,y.traits.add(y.submergibleTrait)),t.locomotor===m.LocomotorType.Hover&&y.traits.add(new f.HoverBobTrait),[m.LocomotorType.Vehicle,m.LocomotorType.Chrono].includes(t.locomotor)&&i.isVoxel&&(y.tilterTrait=new T.TilterTrait,y.traits.add(y.tilterTrait)),y}isUnit(){return!0}isVehicle(){return!0}getUiName(){if(this.gunnerTrait){var e=this.armedTrait.getSpecialWeaponIndex(),t=this.gunnerTrait.getUiNameForIfvMode(e,this.transportTrait?.units[0]?.name);e="name:"+this.name;return t?`{${t}} {${e}}`:e}return super.getUiName()}update(e){this.rocking&&(this.rocking.ticksLeft--,this.rocking.ticksLeft||(this.rocking=void 0)),super.update(e)}applyRocking(e,t){this.rocking={ticksLeft:this.rocking?.ticksLeft??34,facing:e,factor:t}}},e("Vehicle",v)}}})),System.register("game/gameobject/Unit",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameobject/trait/DockableTrait",["game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTeleport"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{[i.NotifyUnspawn.onUnspawn](e){this.undock(e),this.reservedDock?.dockTrait.unreserveDockForUnit(e)}[r.NotifyOwnerChange.onChange](e){e.owner!==this.dock?.owner&&this.undock(e),e.owner!==this.reservedDock?.owner&&this.reservedDock?.dockTrait.unreserveDockForUnit(e)}[s.NotifyTeleport.onBeforeTeleport](e,t,i,r){r||this.undock(e)}undock(e){this.dock&&!this.dock.isDisposed&&this.dock.dockTrait.undockUnit(e)}dispose(){this.dock=void 0,this.reservedDock=void 0}},e("DockableTrait",n)}}})),System.register("game/gameobject/trait/AirportBoundTrait",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("AirportBoundTrait",class{constructor(e){this.airportNames=e}findAvailableAirport(e){return[...e.owner.buildings].find((e=>e.dockTrait&&this.airportNames.includes(e.name)&&0<e.dockTrait.getAvailableDockCount()))}})}}})),System.register("game/gameobject/trait/SpawnLinkTrait",["game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/unit/RangeHelper","game/gameobject/trait/AttackTrait","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class{setParent(e){this.parent=e}getParent(){return this.parent}[a.NotifyTick.onTick](e,t){if(this.parent&&e.attackTrait&&e.primaryWeapon){let o=this.parent.attackTrait?.currentTarget,l=e.unitOrderTrait.getCurrentTask(),c=new s.RangeHelper(t.map.tileOccupation);var a=this.parent.armedTrait?.getWeapons().find((e=>e.rules.spawner));e.ammo&&!(o&&e.attackTrait.currentTarget?o.equals(e.attackTrait.currentTarget):o===e.attackTrait.currentTarget||!o&&this.parent.isUnit()&&(this.parent.unitOrderTrait.getCurrentTask()instanceof r.MoveTask||this.parent.unitOrderTrait.getCurrentTask()instanceof i.AttackTask))&&(!o||a&&c.isInWeaponRange(this.parent,o.obj??o.tile,a,t.rules))?o&&e.primaryWeapon.targeting.canTarget(o.obj,o.tile,t,!0,!1)?!l||l instanceof r.MoveTask?(e.unitOrderTrait.cancelAllTasks(),e.unitOrderTrait.addTask(e.attackTrait.createAttackTask(t,o.obj,o.tile,e.primaryWeapon,{force:!0}))):e.attackTrait.attackState!==n.AttackState.Idle&&l.requestTargetUpdate(o):l?l instanceof r.MoveTask||l.cancel():this.tryMoveToParent(e,this.parent,t):this.tryMoveToParent(e,this.parent,t)}}tryMoveToParent(e,t,i){if(e.tile!==t.tile){let s=e.unitOrderTrait.getCurrentTask();s?s instanceof r.MoveTask&&s.updateTarget(t.tile,!!t.isUnit()&&t.onBridge):e.unitOrderTrait.addTask(new r.MoveTask(i,t.tile,!!t.isUnit()&&t.onBridge,{closeEnoughTiles:0,strictCloseEnough:!0}))}}},e("SpawnLinkTrait",o)}}})),System.register("game/gameobject/trait/MissileSpawnTrait",["game/gameobject/unit/CollisionType","game/gameobject/trait/interface/NotifyDestroy"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{setWarhead(e){return this.warhead=e,this}setDamage(e){return this.damage=e,this}setLauncher(e){return this.launcher=e,this}[r.NotifyDestroy.onDestroy](e,t){this.warhead&&this.damage&&this.launcher&&this.warhead.detonate(t,this.damage,e.tile,e.tileElevation,e.position.worldPosition,e.zone,i.CollisionType.None,t.createTarget(void 0,e.tile),{player:e.owner,obj:this.launcher,weapon:void 0},!1,!1,void 0)}dispose(){this.launcher=void 0}},e("MissileSpawnTrait",s)}}})),System.register("game/gameobject/task/system/TaskGroup",["game/gameobject/task/system/Task"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.Task{constructor(...e){super(),this.children.push(...e)}onTick(e){return!0}},e("TaskGroup",r)}}})),System.register("game/gameobject/trait/UnlandableTrait",["game/math/Vector2","util/bresenham","util/typeGuard","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class{constructor(){this.enabled=!0}setEnabled(e){this.enabled=e}[l.NotifyTick.onTick](e,t){var i;this.enabled&&(e.owner.isNeutral||e.name===t.rules.general.paradrop.paradropPlane)&&e.unitOrderTrait.isIdle()&&(i=this.chooseExitTile(e.tile,t),e.unitOrderTrait.addTask(new o.TaskGroup(new n.MoveTask(t,i,!1,{allowOutOfBoundsTarget:!0}),new a.CallbackTask((e=>t.unspawnObject(e)))).setCancellable(!1)))}chooseExitTile(e,t){var n=t.map.tiles.getMapSize(),a=.5<t.generateRandom()?new i.Vector2(Math.floor(n.width/2),0):new i.Vector2(0,Math.floor(n.height/2));n=new i.Vector2(e.rx,e.ry),a=r.bresenham(n.x,n.y,a.x,a.y).map((e=>t.map.tiles.getByMapCoords(e.x,e.y))).filter(s.isNotNullOrUndefined);if(!a.length)throw new Error("No valid exit tile found");return a[a.length-1]}},e("UnlandableTrait",c)}}})),System.register("game/gameobject/Aircraft",["engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/gameobject/unit/ZoneType","game/gameobject/trait/DockableTrait","game/gameobject/Techno","game/gameobject/trait/ParasiteableTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AirportBoundTrait","game/gameobject/trait/SpawnLinkTrait","game/gameobject/trait/MissileSpawnTrait","game/gameobject/unit/CrateBonuses","game/gameobject/trait/UnlandableTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=class extends a.Techno{constructor(e,t,r){super(i.ObjectType.Aircraft,e,t,r),this.pitch=0,this.yaw=0,this.roll=0,this.onBridge=!1,this.zone=s.ZoneType.Ground,this.crateBonuses=new d.CrateBonuses}get direction(){return this.yaw}set direction(e){this.yaw=e}get isMoving(){return this.moveTrait.isMoving()}static factory(e,t,i,s,a){let d=new this(e,t,i);return d.rules.airportBound&&d.rules.dock.length&&(d.airportBoundTrait=new c.AirportBoundTrait(d.rules.dock),d.traits.add(d.airportBoundTrait)),d.rules.missileSpawn||(d.crashableTrait=new l.CrashableTrait(d),d.traits.add(d.crashableTrait)),d.rules.spawned&&(d.rules.missileSpawn?(d.missileSpawnTrait=new u.MissileSpawnTrait,d.traits.add(d.missileSpawnTrait)):(d.spawnLinkTrait=new h.SpawnLinkTrait,d.traits.add(d.spawnLinkTrait))),d.moveTrait=new r.MoveTrait(d,a),d.traits.add(d.moveTrait),t.dock.length&&d.traits.add(new n.DockableTrait),t.landable&&e!==s.general.paradrop.paradropPlane||d.traits.add(new g.UnlandableTrait),t.parasiteable&&(d.parasiteableTrait=new o.ParasiteableTrait(d),d.traits.add(d.parasiteableTrait)),d}isUnit(){return!0}isAircraft(){return!0}},e("Aircraft",p)}}})),System.register("util/array",[],(function(e,t){"use strict";return t&&t.id,e("findReverse",(function(e,t){for(let i=e.length-1;0<=i;i--)if(t(e[i],i,e))return e[i]})),e("findIndexReverse",(function(e,t){for(let i=e.length-1;0<=i;i--)if(t(e[i],i,e))return i;return-1})),e("equals",(function(e,t){if(e.length!==t.length)return!1;for(let i=0,r=e.length;i<r;i++)if(e[i]!==t[i])return!1;return!0})),{setters:[],execute:function(){}}})),System.register("game/gameobject/task/move/MoveAsideTask",["game/gameobject/task/system/Task","game/gameobject/unit/MovePositionHelper","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/MoveTrait","game/gameobject/task/move/MoveTask","game/math/geometry","game/type/MovementZone","game/gameobject/infantry/StanceType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class e extends i.Task{constructor(e,t){super(),this.game=e,this.fromDirection=t,this.resolved=!1,this.chainPushIssued=!1}onEnd(e){e.moveTrait.collisionState=n.CollisionState.Resolved}onTick(t){if(this.timeoutTicks=void 0===this.timeoutTicks?0:this.timeoutTicks+1,40<this.timeoutTicks||this.resolved||this.isCancelling())return!0;let i,h,u=this.game.map,d=new r.MovePositionHelper(u),g=t.onBridge?u.tileOccupation.getBridgeOnTile(t.tile):void 0;for(let e=0;e<360;e+=45)if((0!==e||this.chainPushIssued)&&180!==e){var p=o.rotateVec2(this.fromDirection.clone(),e).round();if((p=u.tiles.getByMapCoords(t.tile.rx+Math.sign(p.x),t.tile.ry+Math.sign(p.y)))&&u.mapBounds.isWithinBounds(p)&&(h=!g||g.isHighBridge()?u.tileOccupation.getBridgeOnTile(p):void 0,t.rules.movementZone===l.MovementZone.Fly||!u.terrain.findObstacles({tile:p,onBridge:h},t).length&&d.isEligibleTile(p,h,g,t.tile))){i=p;break}}if(i)return this.resolved=!0,t.isInfantry()&&t.deployerTrait&&t.deployerTrait.isDeployed()&&t.deployerTrait.setDeployed(!1),!!t.moveTrait.isDisabled()||(this.children.push(new a.MoveTask(this.game,i,!!h,{closeEnoughTiles:0,strictCloseEnough:!0})),!1);{if(this.chainPushIssued)return this.children.push(new s.WaitTicksTask(5)),!1;let i=u.tiles.getByMapCoords(t.tile.rx+Math.sign(this.fromDirection.x),t.tile.ry+Math.sign(this.fromDirection.y));if(!i||!u.mapBounds.isWithinBounds(i))return!0;h=!g||g.isHighBridge()?u.tileOccupation.getBridgeOnTile(i):void 0;let r=u.tileOccupation.getGroundObjectsOnTile(i).filter((e=>e.isUnit()&&e.owner===t.owner&&e.tile===i&&e.onBridge===!!h&&!(e.isInfantry()&&e.stance===c.StanceType.Paradrop)&&!(e.isAircraft()&&e.missileSpawnTrait)));return r.find((e=>e.moveTrait.collisionState===n.CollisionState.Waiting||e.unitOrderTrait.hasTasks()))?(this.children.push(new s.WaitTicksTask(5)),t.moveTrait.collisionState=n.CollisionState.Waiting,t.moveTrait.moveState=n.MoveState.PlanMove,!1):(r.forEach((t=>{t.unitOrderTrait.addTask(new e(this.game,this.fromDirection))})),this.children.push(new s.WaitTicksTask(1)),t.moveTrait.collisionState=n.CollisionState.Waiting,t.moveTrait.moveState=n.MoveState.PlanMove,!(this.chainPushIssued=!0))}}},e("MoveAsideTask",h)}}})),System.register("game/gameobject/Terrain",["engine/type/ObjectType","game/gameobject/GameObject"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.GameObject{constructor(e,t,r){super(i.ObjectType.Terrain,e,t,r),this.radarInvisible=this.rules.radarInvisible}static factory(e,t,i){return new this(e,t,i)}},e("Terrain",s)}}})),System.register("game/gameobject/locomotor/ChronoLocomotor",["game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ChronoLocomotor",class{constructor(e){this.game=e,this.ignoresTerrain=!0,this.distanceToWaypoint=new i.Vector2}onNewWaypoint(e,t){}tick(e,t,i,s){if(s)return{distance:new r.Vector3,done:!0};this.distanceToWaypoint.copy(t).sub(e.position.getMapPosition());var n,a=this.game.rules.general;return a.chronoTrigger&&(a=(n=this.distanceToWaypoint.length())<a.chronoRangeMinimum?a.chronoMinimumDelay:n/a.chronoDistanceFactor,e.warpedOutTrait.setTimed(a,!1,this.game)),{distance:new r.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!0,isTeleport:!0}}})}}})),System.register("game/math/LineCurve",["game/math/Vector2"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.LineCurve{constructor(e,t){super(e||new i.Vector2,t||new i.Vector2)}getPoint(e,t){return super.getPoint(e,t||new i.Vector2)}},e("LineCurve",r)}}})),System.register("game/math/CurvePath",["game/math/LineCurve"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.CurvePath{closePath(){let e=this.curves[0].getPoint(0);var t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new i.LineCurve(t,e))}},e("CurvePath",r)}}})),System.register("game/math/QuadraticBezierCurve",["game/math/Vector2"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.QuadraticBezierCurve{constructor(e,t,r){super(e||new i.Vector2,t||new i.Vector2,r||new i.Vector2)}getPoint(e,t){return super.getPoint(e,t||new i.Vector2)}},e("QuadraticBezierCurve",r)}}})),System.register("game/gameobject/locomotor/DriveLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/task/TurnTask","game/Coords","game/math/geometry","game/math/Vector2","game/math/Vector3","game/math/CurvePath","game/math/LineCurve","game/math/QuadraticBezierCurve","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var t;(t=d=d||{})[t.None=0]="None",t[t.Start=1]="Start",t[t.Normal=2]="Normal",t[t.End=3]="End",t[t.Single=4]="Single",e("DriveLocomotor",class{constructor(e){this.game=e,this.hasMomentum=!1,this.moveOnCurve=!1,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=d.None}selectNextWaypoint(e,t){if(this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==d.End?d.Normal:d.Start,this.initialPosition=e.position.getMapPosition(),this.currentWaypointType!==d.Start?e.moveTrait.speedPenalty=0:this.currentSpeed=0,1<t.length){var r=t[t.length-1],o=t[t.length-2],u=new a.Vector2(r.tile.rx-e.tile.rx,r.tile.ry-e.tile.ry),g=Math.abs(n.angleDegFromVec2(u)-n.angleDegFromVec2(new a.Vector2(o.tile.rx-r.tile.rx,o.tile.ry-r.tile.ry)));if(!Math.abs(i.FacingUtil.fromMapCoords(u)-e.direction)&&0<g&&g<90&&this.hasMomentum){this.moveOnCurve=!0,this.currentWaypointType=2===t.length?this.currentWaypointType===d.Start?d.Single:d.End:d.Normal;let e=this.initialPosition;u=new a.Vector2(r.tile.rx+.5,r.tile.ry+.5).multiplyScalar(s.Coords.LEPTONS_PER_TILE);let i=new a.Vector2(o.tile.rx+.5,o.tile.ry+.5).multiplyScalar(s.Coords.LEPTONS_PER_TILE);return g=e.clone().lerp(u,.5),r=i.clone().lerp(u,.5),this.steerCurve=new l.CurvePath,this.steerCurve.add(new c.LineCurve(e,g)),this.steerCurve.add(new h.QuadraticBezierCurve(g,u,r)),this.steerCurve.add(new c.LineCurve(r,i)),this.lastPosition=e,o}}else this.currentWaypointType=this.currentWaypointType===d.Start?d.Single:d.End;return this.hasMomentum=!0,this.moveOnCurve=!1,t[t.length-1]}onNewWaypoint(e,t,s){let n=(new a.Vector2).copy(t).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=this.moveOnCurve?this.steerCurve.getLength():n.length();var o=i.FacingUtil.fromMapCoords(n);if(o!==e.direction&&(this.pointTurretToTarget(e,s),!this.moveOnCurve))return e.moveTrait.velocity.set(0,0,0),[new r.TurnTask(o)]}tick(e,t,r){this.pointTurretToTarget(e,r);let n=this.currentSpeed;n=e.rules.accelerates?(d=this.distanceTravelled/this.totalDistanceToTravel,this.currentSpeed=this.applyAcceleration(e,n,e.moveTrait.baseSpeed,d)):this.currentSpeed=e.moveTrait.baseSpeed,1<n&&(n=Math.floor(n));let l=this.game.map.terrain.getPassableSpeed(e.tile,e.rules.speedType,e.onBridge,void 0,!0);l?e.moveTrait.lastTileSpeed=l:l=e.moveTrait.lastTileSpeed,n*=l,1<n&&(n=Math.floor(n)),this.carryOverDistance&&(n=this.carryOverDistance);var c=e.position.getMapPosition();let h;if(this.moveOnCurve){var u=this.steerCurve.getLength(),d=Math.min(this.distanceTravelled+n,u);this.carryOverDistance=Math.max(0,this.distanceTravelled+n-u),this.distanceTravelled=d;let t=this.steerCurve.getPointAt(this.distanceTravelled/u),r=this.steerCurve.getTangentAt(this.distanceTravelled/u);d=r.clone().setLength(n),e.moveTrait.velocity.set(d.x,0,d.y);u=e.rules.rot;var{facing:d,delta:u}=i.FacingUtil.tick(e.direction,i.FacingUtil.fromMapCoords(r),u);e.direction=d,e.spinVelocity=u,u=this.lastPosition,this.lastPosition=t.clone(),h=t.sub(u)}else{let i=(new a.Vector2).copy(t).sub(c);c=Math.min(i.length(),n),h=i.clone().setLength(c);let r=h.clone();this.carryOverDistance&&r.add(s.Coords.vecWorldToGround(e.moveTrait.velocity)),e.moveTrait.velocity.set(r.x,0,r.y),this.distanceTravelled+=c,this.carryOverDistance=Math.max(0,n-i.length())}return{distance:new o.Vector3(h.x,0,h.y),done:!h.length()||!!this.carryOverDistance}}pointTurretToTarget(e,t){if(e.turretTrait){e.attackTrait?.currentTarget?.obj&&(t=e.attackTrait.currentTarget.obj.position.getMapPosition());var r=e.position.getMapPosition();let s=(new a.Vector2).copy(t).sub(r);s.length()&&(r=i.FacingUtil.fromMapCoords(s),e.turretTrait.desiredFacing=r)}}applyAcceleration(e,t,i,r){return this.currentWaypointType===d.Single?i/2:this.currentWaypointType!==d.End?Math.min(t+e.rules.accelerationFactor*i,i):(this.moveOnCurve&&this.currentWaypointType===d.End&&(r=r<=.5?0:2*(r-.5)),u.lerp(1,i,1-r))}})}}})),System.register("game/gameobject/locomotor/FootLocomotor",["game/gameobject/unit/FacingUtil","game/gameobject/infantry/StanceType","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("FootLocomotor",class{constructor(e){this.game=e,this.currentMoveDirection=new s.Vector2,this.distanceToWaypoint=new s.Vector2,this.endPauseFrames=0}onNewWaypoint(e,t){this.currentMoveDirection.copy(t).sub(e.position.getMapPosition());var r=i.FacingUtil.fromMapCoords(this.currentMoveDirection);r!==e.direction&&(e.direction=r),this.endPauseFrames=1}onWaypointUpdate(e,t){this.onNewWaypoint(e,t)}tick(e,t){let i=e.moveTrait.baseSpeed;i=Math.floor(i),e.stance===r.StanceType.Prone&&(i/=2),e.isPanicked&&(i*=2);let s=this.game.map.terrain.getPassableSpeed(e.tile,e.rules.speedType,e.onBridge,void 0,!0);s?this.lastTileSpeed=s:s=this.lastTileSpeed||1,i*=s,i=Math.floor(i),this.distanceToWaypoint.copy(t).sub(e.position.getMapPosition());var a=this.distanceToWaypoint.clone().setLength(i);e.moveTrait.velocity.set(a.x,0,a.y);var o=Math.min(this.distanceToWaypoint.length(),i);a=!o&&0<this.endPauseFrames--;return this.distanceToWaypoint.setLength(o),{distance:new n.Vector3(this.distanceToWaypoint.x,0,this.distanceToWaypoint.y),done:!this.distanceToWaypoint.length()&&!a}}})}}})),System.register("game/gameobject/locomotor/HoverLocomotor",["game/Coords","game/gameobject/unit/FacingUtil","game/GameSpeed","game/math/geometry","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){var t;(t=l=l||{})[t.None=0]="None",t[t.Start=1]="Start",t[t.Normal=2]="Normal",t[t.End=3]="End",t[t.Single=4]="Single",e("HoverLocomotor",class{constructor(e){this.hoverRules=e,this.currentSpeed=0,this.distanceTravelled=0,this.carryOverDistance=0,this.currentWaypointType=l.None,this.nextWaypointDir=new a.Vector2}selectNextWaypoint(e,t){var i,r;return this.currentWaypointType=this.currentWaypointType&&this.currentWaypointType!==l.End?l.Normal:l.Start,this.initialPosition=e.position.getMapPosition(),this.currentWaypointType===l.Start&&(this.currentSpeed=0),t.length<=1?(this.currentWaypointType=this.currentWaypointType===l.Start?l.Single:l.End,(r=t[t.length-1])&&this.nextWaypointDir.set(r.tile.rx-e.tile.rx,r.tile.ry-e.tile.ry)):(i=t[t.length-1],r=t[t.length-2],this.nextWaypointDir.set(r.tile.rx-i.tile.rx,r.tile.ry-i.tile.ry)),t[t.length-1]}onNewWaypoint(e,t,i){let r=(new a.Vector2).copy(t).sub(this.initialPosition);this.distanceTravelled=0,this.totalDistanceToTravel=r.length();var n=this.maxSpeed=e.moveTrait.baseSpeed,o=60*this.hoverRules.acceleration*s.GameSpeed.BASE_TICKS_PER_SECOND;this.acceleration=n/o,o=60*this.hoverRules.brake*s.GameSpeed.BASE_TICKS_PER_SECOND,this.deceleration=n/o}tick(e,t){var s=e.position.getMapPosition();let a=t.clone().sub(s);var c=a.length();s=this.maxSpeed;this.currentWaypointType===l.Single?this.currentSpeed=s/2:this.currentWaypointType===l.End?(h=this.computeBrakeDistance(this.currentSpeed,this.deceleration),this.totalDistanceToTravel-this.distanceTravelled<=h&&(this.currentSpeed=Math.max(0,this.currentSpeed-this.deceleration))):this.currentSpeed=Math.min(this.currentSpeed+this.acceleration,s);var h=r.FacingUtil.fromMapCoords(a);s=r.FacingUtil.fromMapCoords(this.nextWaypointDir);let u=h,d=e.rules.rot;this.currentWaypointType===l.Normal&&h!==s&&(h=(g=n.angleDegBetweenVec2(this.nextWaypointDir,r.FacingUtil.toMapCoords(e.direction)))/d,h=Math.max(this.currentSpeed*h,this.totalDistanceToTravel),this.totalDistanceToTravel-this.distanceTravelled<=h&&(u=s,d=g/((this.totalDistanceToTravel-this.distanceTravelled)/this.currentSpeed)));var g=r.FacingUtil.tick(e.direction,u,d).facing;e.direction=g;let p=this.currentSpeed;this.carryOverDistance&&(p=this.carryOverDistance),g=Math.min(p,c);let m=a.clone().setLength(g),f=m.clone();return this.carryOverDistance&&f.add(i.Coords.vecWorldToGround(e.moveTrait.velocity)),e.moveTrait.velocity.set(f.x,0,f.y),this.distanceTravelled+=g,this.carryOverDistance=Math.max(0,p-c),{distance:new o.Vector3(m.x,0,m.y),done:!m.length()||!!this.carryOverDistance}}computeBrakeDistance(e,t){var i=e/t;return Math.max(0,e*i-t*i*i/2)}})}}})),System.register("game/math/CubicBezierCurve3",["game/math/Vector3"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends THREE.CubicBezierCurve3{constructor(e,t,r,s){super(e||new i.Vector3,t||new i.Vector3,r||new i.Vector3,s||new i.Vector3)}getPoint(e,t){return super.getPoint(e,t||new i.Vector3)}},e("CubicBezierCurve3",r)}}})),System.register("game/gameobject/locomotor/MissileLocomotor",["game/Coords","game/gameobject/unit/ZoneType","game/event/ObjectLiftOffEvent","game/math/geometry","game/gameobject/unit/FacingUtil","game/math/Vector3","game/math/Vector2","game/math/CubicBezierCurve3","game/math/GameMath"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){var t;(t=u=u||{})[t.Boost=0]="Boost",t[t.Midcourse=1]="Midcourse",t[t.Terminal=2]="Terminal",e("MissileLocomotor",class{constructor(e,t){this.game=e,this.missileRules=t,this.flightPhase=u.Boost}selectNextWaypoint(e,t){var r=t[t.length-1],s=this.game.map.tileOccupation.getBridgeOnTile(r.tile);s=r.tile.z+(s?.tileElevation??0);return this.targetPosition=i.Coords.tile3dToWorld(r.tile.rx+.5,r.tile.ry+.5,s),this.cruiseAltitude=i.Coords.tileHeightToWorld(s)+this.missileRules.altitude,r}onNewWaypoint(e,t,i){}tick(e,t,d){let g,p=e.position.worldPosition.clone(),m=this.targetPosition.clone().sub(p);var f;e.zone!==r.ZoneType.Air&&(e.onBridge=!1,e.zone=r.ZoneType.Air,this.game.events.dispatch(new s.ObjectLiftOffEvent(e))),g=this.currentVelocity?(f=e.rules.speed,Math.min(this.currentVelocity.length()+this.missileRules.acceleration,f)):(C=this.missileRules.acceleration,this.missileRules.lazyCurve?this.currentVelocity=new o.Vector3(m.x,0,m.z):this.currentVelocity=i.Coords.vecGroundToWorld(a.FacingUtil.toMapCoords(e.direction)),n.rotateVec3Towards(this.currentVelocity,new o.Vector3(this.currentVelocity.x,1e8,this.currentVelocity.z),e.pitch),C),this.currentVelocity.setLength(g);let y=!1;switch(this.flightPhase){case u.Boost:if(!(e.position.worldPosition.y>=this.cruiseAltitude)){y=!1;break}this.flightPhase=u.Midcourse;case u.Midcourse:var T,v=new l.Vector2(m.x,m.z).length();if(!this.missileRules.lazyCurve){n.rotateVec3Towards(this.currentVelocity,new o.Vector3(this.currentVelocity.x,0,this.currentVelocity.z),e.rules.rot),this.currentVelocity.y<1&&(T=this.currentVelocity.length(),this.currentVelocity.y=0,this.currentVelocity.setLength(T)),n.rotateVec3Towards(this.currentVelocity,new o.Vector3(m.x,this.currentVelocity.y,m.z),e.rules.rot),e.direction=a.FacingUtil.fromMapCoords(i.Coords.vecWorldToGround(this.currentVelocity)),e.pitch=Math.sign(this.currentVelocity.y)*n.angleDegBetweenVec3(this.currentVelocity,new o.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),v/(p.y-this.targetPosition.y)<1&&(this.flightPhase=u.Terminal);break}this.flightPhase=u.Terminal;var b=p.clone().add(this.currentVelocity.clone().setLength(v/3/h.GameMath.cos(n.degToRad(e.pitch)))),S=this.targetPosition.clone().lerp(p,.15).setY(b.y);this.descentCurve=new c.CubicBezierCurve3(p,b,S,this.targetPosition);case u.Terminal:if(b=this.missileRules.bodyLength,this.missileRules.lazyCurve){var w=this.descentCurve.getLength();this.descentTravelled??(this.descentTravelled=0),this.descentTravelled+=Math.min(g,w-b-this.descentTravelled),S=this.descentTravelled/w;let t=this.descentCurve.getPointAt(S),i=this.descentCurve.getTangentAt(S);this.currentVelocity.copy(t.sub(p)),S=i.clone().setY(0),e.pitch=Math.sign(i.y-S.y)*n.angleDegBetweenVec3(S,i),y=1<=(this.descentTravelled+b)/w}else n.rotateVec3Towards(this.currentVelocity,m,e.rules.rot),e.direction=a.FacingUtil.fromMapCoords(i.Coords.vecWorldToGround(this.currentVelocity)),e.pitch=Math.sign(this.currentVelocity.y)*n.angleDegBetweenVec3(this.currentVelocity,new o.Vector3(this.currentVelocity.x,0,this.currentVelocity.z)),((w=m.length()-b)<g||w<1)&&(this.currentVelocity.copy(m.clone().addScalar(-b)),y=!0);break;default:throw new Error(`Unhandled flight phase "${this.flightPhase}"`)}var C=p.clone().add(this.currentVelocity);return this.game.map.isWithinHardBounds(C)?(e.moveTrait.velocity.copy(this.currentVelocity),{distance:this.currentVelocity,done:y}):(this.game.destroyObject(e),{done:!0,distance:new o.Vector3})}})}}})),System.register("game/gameobject/locomotor/LocomotorFactory",["game/type/LocomotorType","game/gameobject/locomotor/ChronoLocomotor","game/gameobject/locomotor/DriveLocomotor","game/gameobject/locomotor/FootLocomotor","game/gameobject/locomotor/HoverLocomotor","game/gameobject/locomotor/JumpjetLocomotor","game/gameobject/locomotor/MissileLocomotor","game/gameobject/locomotor/WingedLocomotor"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("LocomotorFactory",class{constructor(e){this.game=e}create(e){var t=e.rules.locomotor;switch(t){case i.LocomotorType.Infantry:return new n.FootLocomotor(this.game);case i.LocomotorType.Jumpjet:return new o.JumpjetLocomotor(this.game);case i.LocomotorType.Vehicle:case i.LocomotorType.Ship:return new s.DriveLocomotor(this.game);case i.LocomotorType.Chrono:return e.isVehicle()&&e.harvesterTrait&&e.rules.teleporter?new s.DriveLocomotor(this.game):new r.ChronoLocomotor(this.game);case i.LocomotorType.Aircraft:return new c.WingedLocomotor(this.game);case i.LocomotorType.Missile:return new l.MissileLocomotor(this.game,this.game.rules.general.getMissileRules(e.name));case i.LocomotorType.Hover:return new a.HoverLocomotor(this.game.rules.general.hover);default:throw new Error("Unhandled locomotor type "+t)}}})}}})),System.register("game/event/ObjectTeleportEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectTeleportEvent",class{constructor(e,t,r){this.target=e,this.isChronoshift=t,this.prevTile=r,this.type=i.EventType.ObjectTeleport}})}}})),System.register("game/type/PowerupType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Armor=0]="Armor",t[t.Firepower=1]="Firepower",t[t.HealBase=2]="HealBase",t[t.Money=3]="Money",t[t.Reveal=4]="Reveal",t[t.Speed=5]="Speed",t[t.Veteran=6]="Veteran",t[t.Unit=7]="Unit",t[t.Invulnerability=8]="Invulnerability",t[t.IonStorm=9]="IonStorm",t[t.Gas=10]="Gas",t[t.Tiberium=11]="Tiberium",t[t.Pod=12]="Pod",t[t.Cloak=13]="Cloak",t[t.Darkness=14]="Darkness",t[t.Explosion=15]="Explosion",t[t.ICBM=16]="ICBM",t[t.Napalm=17]="Napalm",t[t.Squad=18]="Squad",e("PowerupType",i)}}})),System.register("game/gameobject/unit/VeteranAbility",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.FASTER=0]="FASTER",t[t.STRONGER=1]="STRONGER",t[t.FIREPOWER=2]="FIREPOWER",t[t.SCATTER=3]="SCATTER",t[t.ROF=4]="ROF",t[t.SIGHT=5]="SIGHT",t[t.SELF_HEAL=6]="SELF_HEAL",t[t.CLOAK=7]="CLOAK",t[t.EXPLODES=8]="EXPLODES",t[t.RADAR_INVISIBLE=9]="RADAR_INVISIBLE",t[t.SENSORS=10]="SENSORS",t[t.FEARLESS=11]="FEARLESS",t[t.C4=12]="C4",t[t.GUARD_AREA=13]="GUARD_AREA",t[t.CRUSHER=14]="CRUSHER",e("VeteranAbility",i)}}})),System.register("game/gameobject/task/move/MoveTask",["game/gameobject/task/system/Task","game/gameobject/Infantry","game/type/MovementZone","util/array","game/type/SpeedType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/WaitTicksTask","game/gameobject/task/move/MoveAsideTask","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","util/Logger","game/Coords","game/gameobject/task/system/TaskStatus","game/gameobject/unit/ZoneType","game/gameobject/locomotor/LocomotorFactory","game/map/tileFinder/RandomTileFinder","game/event/ObjectTeleportEvent","game/gameobject/trait/interface/NotifyTeleport","game/type/PowerupType","game/gameobject/task/ScatterTask","game/gameobject/unit/VeteranAbility","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e}],execute:function(){1.5,200,40,5,x=class e extends i.Task{constructor(e,t,i,r){super(),this.game=e,this.targetTile=t,this.toBridge=i,this.options=r,this.preventOpportunityFire=!1,this.logger=g.AppLogger.get("move"),this.destinationLeptons=new E.Vector2,this.currentWaypointLeptons=new E.Vector2,this.needsPathUpdate=!1,this.targetChangeRequested=!1,this.allObstaclesAreBlockers=!1,this.blockedPathNodes=[],this.unreachableTargets=[],this.pushTried=!1,this.cancelProcessed=!1,this.cancelRepositionPending=!1,this.targetLinesConfig={pathNodes:[]}}duplicate(){return new e(this.game,this.targetTile,this.toBridge,this.options)}onStart(e){if(e.moveTrait.currentWaypoint)throw new Error("Nested move tasks are not supported");void 0===e.moveTrait.locomotor&&(e.moveTrait.locomotor=new y.LocomotorFactory(this.game).create(e)),e.moveTrait.lastTargetOffset?this.targetOffset=e.moveTrait.lastTargetOffset:this.targetOffset=this.computeTargetOffset(e),e.moveTrait.lastVelocity&&(e.moveTrait.velocity=e.moveTrait.lastVelocity),this.path||(this.computePath(e,e.moveTrait.locomotor),this.targetLinesConfig.isRecalc=!1),this.updateDestination(this.path,this.targetOffset),e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,e.moveTrait.lastMoveResult=void 0,e.moveTrait.lastTargetOffset=void 0,e.moveTrait.lastVelocity=void 0}computeTargetOffset(e){return this.options?.targetOffset??(e.isInfantry()?e.position.getTileOffset():e.position.computeSubCellOffset(0))}computePath(e,t){let i;i=this.options?.allowOutOfBoundsTarget||this.game.map.mapBounds.isWithinBounds(this.targetTile)?e.rules.movementZone===s.MovementZone.Fly?this.computeAirPath(e):t.ignoresTerrain?this.computeDirectJumpPath(e):(this.blockedPathNodes=this.blockedPathNodes.filter((e=>e.obj.isSpawned&&e.node.tile===e.obj.tile)),this.computeGroundPath(e)):[],e.rules.movementZone===s.MovementZone.Fly?(this.targetLinesConfig.pathNodes=i.map((({tile:e,onBridge:t})=>({tile:e,onBridge:t}))),i.length&&(this.targetLinesConfig.pathNodes[0].onBridge=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0)):this.targetLinesConfig.pathNodes=i,this.path=i}computeAirPath(e){return[{tile:this.targetTile,onBridge:void 0},{tile:e.tile,onBridge:void 0}]}computeDirectJumpPath(e){let t=this.game.map;var i=e.onBridge?t.tileOccupation.getBridgeOnTile(e.tile):void 0;let r=this.targetTile,s=this.toBridge?t.tileOccupation.getBridgeOnTile(this.targetTile):void 0,n=this.options?.ignoredBlockers;var a=new u.RadialTileFinder(t.tiles,t.mapBounds,r,{width:1,height:1},0,5,(i=>0<t.terrain.getPassableSpeed(i,e.rules.speedType,!!i.onBridgeLandType,n)&&!t.terrain.findObstacles({tile:i,onBridge:!!i.onBridgeLandType},e).find((e=>!n?.includes(e.obj))))).getNextTile();return a?(a!==r&&(r=a,s=t.tileOccupation.getBridgeOnTile(r)),[{tile:r,onBridge:s},{tile:e.tile,onBridge:i}]):[]}computeGroundPath(e){let t,i=e.tile,r=e.onBridge?this.game.map.tileOccupation.getBridgeOnTile(i):void 0;e.moveTrait.moveState===o.MoveState.Moving&&e.moveTrait.currentWaypoint&&(i=e.moveTrait.currentWaypoint.tile,r=e.moveTrait.currentWaypoint.onBridge);var s=this.toBridge?this.game.map.tileOccupation.getBridgeOnTile(this.targetTile):void 0,n=this.nodeIsBlockedForPathfinding({tile:this.targetTile,onBridge:s},e);if(Math.abs(i.rx-this.targetTile.rx)<=1&&Math.abs(i.ry-this.targetTile.ry)<=1&&new h.MovePositionHelper(this.game.map).isEligibleTile(i,r,s,this.targetTile)&&n)t=[];else{const n=this.game.map.getObjectsOnTile(i).find((e=>e.isBuilding()));if(n&&!this.game.map.terrain.getPassableSpeed(i,e.rules.speedType,!1)){this.options??(this.options={});var a=this.options?.ignoredBlockers?.includes(n);if(this.options.ignoredBlockers=[...new Set([...this.options?.ignoredBlockers??[],n])],!a&&n.dockTrait){let e=new Set(n.dockTrait?.getAllDockTiles());this.game.map.tileOccupation.calculateTilesForGameObject(n.tile,n).filter((t=>!e.has(t))).forEach((e=>this.blockedPathNodes.push({node:{tile:e,onBridge:void 0},obj:n})))}}a=this.game.map.getGroundObjectsOnTile(this.targetTile).find((t=>(t.isInfantry()||t.isVehicle())&&t.disguiseTrait?.hasTerrainDisguise()&&!(this.game.alliances.haveSharedIntel(e.owner,t.owner)||t.owner.sharedDetectDisguiseTrait?.has(e)))),a&&this.blockedPathNodes.push({node:{tile:this.targetTile,onBridge:s},obj:a}),t=this.game.map.terrain.computePath(e.rules.speedType,i,!!r,this.targetTile,this.toBridge,{maxExpandedNodes:this.allObstaclesAreBlockers?Math.min(300,this.options?.maxExpandedPathNodes??Number.POSITIVE_INFINITY):this.options?.maxExpandedPathNodes,bestEffort:!this.options?.strictCloseEnough,ignoredBlockers:[...new Set([...this.options?.ignoredBlockers??[],...this.options?.pathFinderIgnoredBlockers??[]])],excludeTiles:this.allObstaclesAreBlockers||this.blockedPathNodes.length?t=>this.nodeIsBlockedForPathfinding(t,e):void 0})}return t}nodeIsBlockedForPathfinding(e,t){return this.allObstaclesAreBlockers?!!this.game.map.terrain.findObstacles(e,t).find((e=>!this.options?.ignoredBlockers?.includes(e.obj))):!!this.blockedPathNodes.find((({node:t})=>t.tile===e.tile&&t.onBridge===e.onBridge))}updateDestination(e,t){var i=e.length?e[0].tile:this.targetTile;this.destinationLeptons.set(i.rx*p.Coords.LEPTONS_PER_TILE,i.ry*p.Coords.LEPTONS_PER_TILE).add(t)}canStopAtTile(e,t,i){if(e.zone===f.ZoneType.Air){if((!e.isAircraft()||!e.airportBoundTrait)&&!e.rules.spawned&&(!this.game.map.terrain.getPassableSpeed(t,a.SpeedType.Amphibious,i)||this.game.map.getObjectsOnTile(t).filter((i=>i.isBuilding()&&!i.isDestroyed&&!i.dockTrait?.hasReservedDockForUnit(e)&&!e.rules.dock.includes(i.name)||i.isUnit()&&i.tile===t&&i.moveTrait.moveState!==o.MoveState.Moving&&i!==e)).length))return!1}else if(e.isInfantry()){let r=this.game.map.getGroundObjectsOnTile(t).filter((r=>r.isInfantry()&&r.tile===t&&r.onBridge===i&&r.moveTrait.moveState!==o.MoveState.Moving&&r!==e));if(2<r.length||r.find((t=>t.position.subCell===e.position.subCell)))return!1}return!(e.zone!==f.ZoneType.Air&&e.rules.tooBigToFitUnderBridge&&!i&&t.onBridgeLandType&&this.game.map.tileOccupation.getBridgeOnTile(t)?.isHighBridge()||!this.isCancelling()&&this.options?.strictCloseEnough&&void 0!==this.options?.closeEnoughTiles&&!this.isCloseEnoughToDest(e,t,this.options.closeEnoughTiles))}isCloseEnoughToDest(e,t,i){if(void 0===i)return!0;return!(new d.RangeHelper(this.game.map.tileOccupation).tileDistance(this.targetTile,t)>i)}hasReachedDestination(e){return!this.path.length}updateTarget(e,t){this.targetTile=e,this.toBridge=t,this.needsPathUpdate=!0,this.targetChangeRequested=!0}onEnd(e){e.moveTrait.collisionState=o.CollisionState.Resolved,e.moveTrait.currentWaypoint=void 0,this.targetOffset.equals(this.computeTargetOffset(e))||(e.moveTrait.lastTargetOffset=this.targetOffset)}forceCancel(e){return!(!this.cancellable||this.children.some((e=>!e.cancellable))||!this.options?.allowOutOfBoundsTarget&&!this.game.map.isWithinBounds(e.tile)||(this.status!==m.TaskStatus.Running&&this.status!==m.TaskStatus.Cancelling||(e.moveTrait.unreservePathNodes(),e.moveTrait.lastMoveResult=o.MoveResult.Cancel,this.onEnd(e),e.moveTrait.lastTargetOffset=this.targetOffset,e.moveTrait.lastVelocity=e.moveTrait.velocity.clone()),this.status=m.TaskStatus.Cancelled,0))}onTick(e){if(e.moveTrait.isDisabled()&&e.moveTrait.moveState===o.MoveState.ReachedNextWaypoint)return!!this.isCancelling()&&(e.moveTrait.lastMoveResult=o.MoveResult.Cancel,!0);this.needsPathUpdate&&(e.moveTrait.moveState===o.MoveState.PlanMove&&(this.inPlanningForTicks=void 0,e.moveTrait.currentWaypoint=void 0,e.moveTrait.collisionState=o.CollisionState.Resolved,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,e.moveTrait.velocity.set(0,0,0)),this.computePath(e,e.moveTrait.locomotor),this.path.length||this.unreachableTargets.push({tile:this.targetTile,toBridge:this.toBridge}),this.updateDestination(this.path,this.targetOffset),this.targetLinesConfig.isRecalc=!this.targetChangeRequested,this.targetChangeRequested=!1,this.needsPathUpdate=!1,this.allObstaclesAreBlockers=!1);let t=this.game.map;if(e.moveTrait.moveState===o.MoveState.ReachedNextWaypoint){e.moveTrait.unreservePathNodes();var i=this.path.findIndex((t=>t===e.moveTrait.currentWaypoint));if(-1!==i?this.path.splice(i):this.path.pop(),e.moveTrait.currentWaypoint=void 0,this.isCancelling()?!this.cancelProcessed:this.hasReachedDestination(e)){var r=!this.isCancelling()&&!this.isCloseEnoughToDest(e,e.tile,this.options?.closeEnoughTiles);if(!r&&this.canStopAtTile(e,e.tile,e.onBridge))return e.moveTrait.lastMoveResult=this.isCancelling()?o.MoveResult.Cancel:o.MoveResult.Success,!0;{if(this.unreachableTargets.length>5)return e.moveTrait.lastMoveResult=o.MoveResult.Fail,this.log(e,"bail_max_unreachable_dest"),!0;let s=e.tile,n=e.onBridge?t.tileOccupation.getBridgeOnTile(s):void 0;return r&&(s=this.targetTile,n=this.toBridge?t.tileOccupation.getBridgeOnTile(s):void 0),(i=this.findRelocationTile(s,n,e))?(r=!n||n.isHighBridge()?t.tileOccupation.getBridgeOnTile(i):void 0,this.updateTarget(i,!!r),this.isCancelling()&&(this.cancelProcessed=!0,this.cancelRepositionPending=!0),!1):(e.moveTrait.lastMoveResult=r?o.MoveResult.Fail:o.MoveResult.CloseEnough,this.log(e,"bail_no_free_dest"),!0)}}if(this.cancelProcessed&&!this.path.length)return e.moveTrait.lastMoveResult=o.MoveResult.Cancel,!0;this.cancelProcessed=!1,e.moveTrait.moveState=o.MoveState.PlanMove;let s=e.moveTrait.locomotor;if(e.moveTrait.currentWaypoint=s.selectNextWaypoint?s.selectNextWaypoint(e,this.path):this.path[this.path.length-1],this.currentWaypointLeptons.set(e.moveTrait.currentWaypoint.tile.rx,e.moveTrait.currentWaypoint.tile.ry).multiplyScalar(p.Coords.LEPTONS_PER_TILE).add(this.targetOffset),r=s.onNewWaypoint(e,this.currentWaypointLeptons,this.destinationLeptons))return this.children.push(...r),!1}if(e.moveTrait.moveState===o.MoveState.PlanMove){if(this.isCancelling()&&!this.cancelRepositionPending)return e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e);if(this.inPlanningForTicks=void 0===this.inPlanningForTicks?0:this.inPlanningForTicks+1,this.inPlanningForTicks>200)return this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,e.moveTrait.velocity.set(0,0,0),this.log(e,"repath_plan_timeout"),!1;if(e.rules.movementZone!==s.MovementZone.Fly&&!e.moveTrait.locomotor.ignoresTerrain){let i=this.path.slice(this.path.indexOf(e.moveTrait.currentWaypoint)).reverse();var h,u,d,g=e.moveTrait.velocity.length();for(h of i){if(!t.terrain.getPassableSpeed(h.tile,e.rules.speedType,!!h.onBridge,this.options?.ignoredBlockers))return this.options?.stopOnBlocker&&t.terrain.findObstacles(h,e).some((e=>e.obj===this.options.stopOnBlocker))?(e.moveTrait.lastMoveResult=o.MoveResult.CloseEnough,!0):(this.needsPathUpdate=!0,e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e));if(!h.onBridge){var m=t.getGroundObjectsOnTile(h.tile).find((e=>e.isOverlay()&&e.rules.crate));if(m&&this.game.crateGeneratorTrait.peekInsideCrate(m)===S.PowerupType.Unit&&(this.game.crateGeneratorTrait.pickupCrate(e,m,this.game),m=this.game.map.getGroundObjectsOnTile(h.tile).find((e=>e.isUnit()&&!e.onBridge)),m))return this.needsPathUpdate=!0,this.blockedPathNodes.push({node:h,obj:m}),e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e)}for(u of t.terrain.findObstacles(h,e).filter((e=>!this.options?.ignoredBlockers?.includes(e.obj)))){if(u.static)return this.needsPathUpdate=!0,e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e);if(u.obj.rules.crushable){if(!(e.rules.speedType!==a.SpeedType.Track||!e.crusher||u.obj.isTechno()&&this.game.areFriendly(u.obj,e)))continue;if(!u.obj.isTechno())return this.needsPathUpdate=!0,e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e)}if(u.obj.isTerrain()){if(!e.isInfantry())throw new Error(`Obstacle ${u.obj.name} should be a blocker for non infantry`);var y=this.findFreeSubCell(e,h);return void 0!==y?this.relocateToSubCell(e,y):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:h,obj:u.obj}),e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint),this.onTick(e)}if(!u.obj.isTechno())throw new Error("Unexpected obstacle of type "+u.obj.type);const r=u.obj;var T=r.isUnit()?r.moveTrait.velocity.length():0;if(!r.isAircraft()||r.zone!==f.ZoneType.Ground||!this.options?.ignoredBlockers?.some((e=>e.isBuilding()&&e.dockTrait?.isDocked(r)))){if(1===i.length&&r.isUnit()&&T&&g&&g<=T&&e.direction===r.direction&&r.tile===h.tile&&r.moveTrait.currentWaypoint?.tile!==h.tile)break;if(r.isBuilding()||r.moveTrait.moveState===o.MoveState.Idle||r.moveTrait.collisionState!==o.CollisionState.Resolved){if(!g&&e.moveTrait.collisionState!==o.CollisionState.Resolved&&r.isUnit()&&r.moveTrait.collisionState!==o.CollisionState.Resolved)return this.inPlanningForTicks+1>200&&(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(e,"repath_waited_too_long_blocker "+r.id),e.moveTrait.velocity.set(0,0,0)),!1;{if(r.isInfantry()&&e.isInfantry()&&r.moveTrait.collisionState===o.CollisionState.Resolved){var x=this.findFreeSubCell(e,h);if(void 0!==x)return this.relocateToSubCell(e,x),this.onTick(e)}if(y=n.findIndexReverse(this.path.slice(0,this.path.indexOf(h)),(i=>!t.terrain.findObstacles(i,e).length)),-1===y){if(this.canStopAtTile(e,e.tile,e.onBridge)&&this.isCloseEnoughToDest(e,e.tile,this.options?.closeEnoughTiles))return e.moveTrait.lastMoveResult=o.MoveResult.CloseEnough,this.log(e,"bail_waypoints_blocked_close_enough"),!0;if(!(0===this.options?.closeEnoughTiles||Math.abs(e.tile.rx-this.targetTile.rx)<=1&&Math.abs(e.tile.ry-this.targetTile.ry)<=1))return this.needsPathUpdate=!0,this.blockedPathNodes.push(...this.path.slice(0,this.path.indexOf(h)+1).map((i=>({node:i,obj:t.terrain.findObstacles(i,e)[0].obj})))),e.moveTrait.velocity.set(0,0,0),this.log(e,"repath_waypoints_blocked_too_far"),!1}let s;if(s=-1!==y?(x=this.path[y],t.terrain.computePath(e.rules.speedType,e.tile,e.onBridge,x.tile,!!x.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:i=>!!t.terrain.findObstacles(i,e).length})):[],s.length||r.owner!==e.owner||1!==i.length)return s.length?(this.path.splice(y,this.path.length,...s),e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e)):((O=this.selectWeaponVsObstacle(e,r))?(this.children.push(e.attackTrait.createAttackTask(this.game,r,r.tile,O,{passive:!0,holdGround:!0})),e.moveTrait.velocity.set(0,0,0)):this.options?.forceWaitOnPathBlocked?(this.children.push(new l.WaitTicksTask(40)),this.inPlanningForTicks=0,e.moveTrait.velocity.set(0,0,0),e.moveTrait.collisionState=o.CollisionState.Waiting):(this.needsPathUpdate=!0,this.blockedPathNodes.push({node:h,obj:r}),r.isBuilding()&&(this.allObstaclesAreBlockers=!0),this.log(e,"repath_unavoidable_blocker "+r.id),e.moveTrait.velocity.set(0,0,0)),!1);if(O=r.unitOrderTrait.hasTasks(),this.pushTried||r.isBuilding()||r.moveTrait.collisionState===o.CollisionState.Waiting||O||r.isAircraft()&&r.missileSpawnTrait)return!this.options?.forceWaitOnPathBlocked&&(r.isBuilding()||O&&r.moveTrait.moveState===o.MoveState.Idle||this.inPlanningForTicks+40>200)?(this.needsPathUpdate=!0,this.allObstaclesAreBlockers=!0,this.log(e,"repath_blocker_busy_wait_timeout "+r.id),e.moveTrait.velocity.set(0,0,0)):(this.children.push(new l.WaitTicksTask(40)),this.options?.forceWaitOnPathBlocked?this.inPlanningForTicks=0:this.inPlanningForTicks+=40,e.moveTrait.velocity.set(0,0,0),e.moveTrait.collisionState=o.CollisionState.Waiting),!1;var O=new E.Vector2(r.tile.rx-e.tile.rx,r.tile.ry-e.tile.ry);return this.pushTried=!0,r.unitOrderTrait.addTask(new c.MoveAsideTask(this.game,O)),this.children.push(new l.WaitTicksTask(1)),e.moveTrait.velocity.set(0,0,0),e.moveTrait.collisionState=o.CollisionState.Waiting,this.log(e,"push "+r.id),!1}}if(!g)return this.inPlanningForTicks>40&&(e.moveTrait.collisionState=o.CollisionState.Waiting),!1;if(180===Math.abs(e.direction-r.direction))return e.moveTrait.velocity.set(0,0,0),e.moveTrait.collisionState=o.CollisionState.Waiting,!1;if(Math.abs(e.direction-r.direction)<=45&&1.5*T<g){if(5<=(T=this.path.indexOf(h))){let i=n.findIndexReverse(this.path.slice(0,T-5),(i=>!t.terrain.findObstacles(i,e).length));if(-1!==i&&(T=this.path[i],T=t.terrain.computePath(e.rules.speedType,e.tile,e.onBridge,T.tile,!!T.onBridge,{maxExpandedNodes:15,bestEffort:!1,excludeTiles:r=>!!t.terrain.findObstacles(r,e).length||this.path.findIndex((e=>e.tile===r.tile&&e.onBridge===r.onBridge))>i}),T.length))return this.path.splice(i,this.path.length,...T),e.moveTrait.currentWaypoint=void 0,e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e)}return e.moveTrait.collisionState=o.CollisionState.Waiting,e.moveTrait.velocity.set(0,0,0),!1}return e.moveTrait.velocity.set(0,0,0),e.moveTrait.collisionState=o.CollisionState.Waiting,!1}}}if(e.rules.speedType===a.SpeedType.Track&&g)if(0<(M=this.path.indexOf(e.moveTrait.currentWaypoint))){let i=this.path[M-1];for(d of t.getGroundObjectsOnTile(i.tile).filter((t=>t.isUnit()&&t.onBridge===!!i.onBridge&&t.rules.crushable&&t.veteranTrait?.hasVeteranAbility(C.VeteranAbility.SCATTER)&&!this.game.areFriendly(t,e))))d.unitOrderTrait.hasTasks()||d.unitOrderTrait.addTask(new w.ScatterTask(this.game))}e.moveTrait.reservedPathNodes.length||(e.moveTrait.reservedPathNodes.push(...i),i.forEach((i=>{t.tileOccupation.occupySingleTile(i.tile,e)})))}e.moveTrait.moveState=o.MoveState.Moving,this.inPlanningForTicks=void 0,this.unreachableTargets.length=0,this.pushTried=!1,e.moveTrait.collisionState===o.CollisionState.Waiting&&(e.moveTrait.collisionState=o.CollisionState.Resolved)}if(e.moveTrait.moveState===o.MoveState.Moving){let t=e.moveTrait.locomotor,{distance:i,done:s,isTeleport:a}=t.tick(e,this.currentWaypointLeptons,this.destinationLeptons,(this.isCancelling()||!this.path.length)&&!this.cancelRepositionPending);if(a&&e.traits.filter(b.NotifyTeleport).forEach((t=>{t[b.NotifyTeleport.onBeforeTeleport](e,this.game,!0,!0)})),i.length()&&(r=e.tile,M=t.allowOutOfBounds,i.y?(A=e.tileElevation,e.position.moveByLeptons3(i,M),e.moveTrait.handleElevationChange(A,this.game)):e.position.moveByLeptons(i.x,i.z,M),e.tile!==r)){var A=e.onBridge?this.game.map.tileOccupation.getBridgeOnTile(r):void 0,M=n.findReverse(this.path,(t=>t.tile===e.tile));A=M?M.onBridge:A||e.moveTrait.currentWaypoint.onBridge?this.game.map.tileOccupation.getBridgeOnTile(e.tile):void 0;if(e.moveTrait.handleTileChange(r,A,!1,this.game,a),a&&(e.moveTrait.lastTeleportTick=this.game.currentTick,this.game.events.dispatch(new v.ObjectTeleportEvent(e,!0,r))),e.isDestroyed)return!0}if(s)return e.moveTrait.moveState=o.MoveState.ReachedNextWaypoint,this.onTick(e)}return!1}selectWeaponVsObstacle(e,t){let i;if(!this.game.areFriendly(t,e)&&e.attackTrait&&!e.attackTrait.isDisabled()&&e.attackTrait.isIdle()&&(i=e.attackTrait.selectWeaponVersus(e,t,this.game,!1,!0))&&i.name!==e.armedTrait?.deathWeapon?.name&&(!i.rules.limboLaunch||!i.warhead.rules.parasite)&&!i.warhead.rules.mindControl)return i}findRelocationTile(e,t,i){let r,n=this.game.map;if(i.rules.movementZone===s.MovementZone.Fly){r=new T.RandomTileFinder(n.tiles,n.mapBounds,e,1,this.game,(e=>!0)).getNextTile()}else{let s=new h.MovePositionHelper(n),a=new u.RadialTileFinder(n.tiles,n.mapBounds,e,{width:1,height:1},0,5,(r=>{let a=!t||t.isHighBridge()?n.tileOccupation.getBridgeOnTile(r):void 0;return!this.unreachableTargets.find((e=>e.tile===r&&e.toBridge===!!a))&&(i.zone===f.ZoneType.Air||!n.terrain.findObstacles({tile:r,onBridge:a},i).length&&s.isEligibleTile(r,a,t,e))&&this.canStopAtTile(i,r,!!a)}));r=a.getNextTile()}return r}findFreeSubCell(e,t){let i=this.game.map.getGroundObjectsOnTile(t.tile);var s=i.filter((i=>i.isInfantry()&&i.onBridge===!!t.onBridge&&i!==e)).map((e=>e.position.desiredSubCell)),n=i.filter((e=>e.isTerrain())).map((e=>e.rules.getOccupiedSubCells(this.game.map.getTheaterType()))).flat();let a=[...s,...n];return r.Infantry.SUB_CELLS.find((e=>-1===a.indexOf(e)))}relocateToSubCell(e,t){e.position.desiredSubCell=t;var i=e.position.computeSubCellOffset(t);this.targetOffset=i,this.currentWaypointLeptons.set(e.moveTrait.currentWaypoint.tile.rx,e.moveTrait.currentWaypoint.tile.ry).multiplyScalar(p.Coords.LEPTONS_PER_TILE).add(this.targetOffset),this.updateDestination(this.path,this.targetOffset),e.moveTrait.locomotor.onWaypointUpdate?.(e,this.currentWaypointLeptons,this.destinationLeptons)}getTargetLinesConfig(e){var t;return this.path||((t=e.moveTrait).locomotor??(t.locomotor=new y.LocomotorFactory(this.game).create(e)),this.computePath(e,e.moveTrait.locomotor),this.targetLinesConfig.isRecalc=!1),this.targetLinesConfig}log(e,t){this.logger.debug(`<${e.id}>: `+t)}},e("MoveTask",x)}}})),System.register("game/trait/interface/NotifyTileChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onTileChange=Symbol(),e("NotifyTileChange",i)}}})),System.register("game/event/EnterTileEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("EnterTileEvent",class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.EnterTile}})}}})),System.register("game/trait/interface/NotifyElevationChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onElevationChange=Symbol(),e("NotifyElevationChange",i)}}})),System.register("game/gameobject/trait/MoveTrait",["game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/ZoneType","game/gameobject/infantry/InfDeathType","game/event/ObjectTeleportEvent","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyTeleport","game/type/LocomotorType","game/gameobject/locomotor/JumpjetLocomotor","game/type/SpeedType","game/gameobject/locomotor/WingedLocomotor","game/gameobject/infantry/StanceType","game/trait/interface/NotifyTileChange","game/gameobject/trait/interface/NotifyTileChange","game/event/EnterTileEvent","game/math/Vector3","game/trait/interface/NotifyElevationChange"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){var t;(t=b=b||{})[t.Idle=0]="Idle",t[t.ReachedNextWaypoint=1]="ReachedNextWaypoint",t[t.PlanMove=2]="PlanMove",t[t.Moving=3]="Moving",e("MoveState",b),(t=S=S||{})[t.Success=0]="Success",t[t.Cancel=1]="Cancel",t[t.CloseEnough=2]="CloseEnough",t[t.Fail=3]="Fail",e("MoveResult",S),(t=w=w||{})[t.Waiting=0]="Waiting",t[t.Resolved=1]="Resolved",e("CollisionState",w),C=e=>e instanceof i.MoveTask||e.children[0]&&C(e.children[0]),E=class{constructor(e,t){this.gameObject=e,this.tileOccupation=t,this.disabled=!1,this.speedPenalty=0,this.velocity=new T.Vector3,this.reservedPathNodes=[],this.moveState=b.Idle,this.collisionState=w.Resolved}get baseSpeed(){return this.gameObject.rules.speed*(this.gameObject.veteranTrait?.getVeteranSpeedMultiplier()??1)*this.gameObject.crateBonuses.speed*(this.gameObject.isVehicle()&&this.gameObject.healthTrait.health<=50&&this.gameObject.rules.locomotor!==h.LocomotorType.Hover?.75:1)*(1-this.speedPenalty)}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}isMoving(){return this.moveState===b.Moving}isIdle(){return this.moveState===b.Idle}isWaiting(){return this.collisionState===w.Waiting}[r.NotifyTick.onTick](e,t){var i;this.moveState!==b.Idle&&this.collisionState===w.Resolved&&((i=e.unitOrderTrait.getCurrentTask())&&C(i)||(this.velocity.set(0,0,0),this.moveState=b.Idle,this.locomotor=void 0,!i&&!e.attackTrait?.currentTarget&&e.isVehicle()&&e.turretTrait&&(e.turretTrait.desiredFacing=e.direction))),this.moveState===b.Idle&&(e.rules.locomotor===h.LocomotorType.Jumpjet?u.JumpjetLocomotor.tickStationary(e,t):e.isAircraft()&&e.rules.locomotor===h.LocomotorType.Aircraft&&g.WingedLocomotor.tickStationary(e,t))}[s.NotifyDestroy.onDestroy](e,t){this.unreservePathNodes()}teleportUnitToTile(e,t,i,r,s){let n=this.gameObject;var a=n.tile;n.traits.filter(c.NotifyTeleport).forEach((e=>{e[c.NotifyTeleport.onBeforeTeleport](n,s,i,r)})),n.position.tileElevation=n.tileElevation,n.position.tile=e,n.position.subCell=n.position.desiredSubCell,this.handleTileChange(a,t,!0,s,!0),r||(this.unreservePathNodes(),this.speedPenalty=0,this.velocity.set(0,0,0),this.moveState=b.Idle,this.collisionState=w.Resolved,this.locomotor=void 0,this.currentWaypoint=void 0,this.lastTargetOffset=void 0,this.lastVelocity=void 0,this.lastMoveResult=S.Cancel,n.isVehicle()&&(n.spinVelocity=0,n.turretTrait&&(n.turretTrait.desiredFacing=n.direction))),this.lastTeleportTick=s.currentTick,s.events.dispatch(new o.ObjectTeleportEvent(n,i,a))}handleTileChange(e,t,i,r,s=!1){const o=this.gameObject;if(r.map.tileOccupation.unoccupyTileRange(e,o),r.map.tileOccupation.occupyTileRange(o.tile,o),r.map.technosByTile.updateObject(o),o.zone!==n.ZoneType.Air){var c=o.onBridge?r.map.tileOccupation.getBridgeOnTile(e):void 0,h=o.onBridge?e.onBridgeLandType:e.landType,u=t?o.tile.onBridgeLandType:o.tile.landType;h!==u&&(0<r.rules.getLandRules(u).getSpeedModifier(o.rules.speedType)||o.rules.speedType===d.SpeedType.Amphibious||s)&&(o.zone=n.getZoneType(u)),t!==c&&(o.position.tileElevation+=-(c?.tileElevation??0)+(t?.tileElevation??0),o.onBridge=!!t);var g;c=o.moveTrait.reservedPathNodes.findIndex((e=>e.tile===o.tile&&!!e.onBridge===o.onBridge));if(-1!==c&&o.moveTrait.reservedPathNodes.splice(c,1),o.crusher)for(g of r.map.getGroundObjectsOnTile(o.tile).filter((e=>(!e.isUnit()||e.onBridge===o.onBridge)&&e.rules.crushable&&!(e.isInfantry()&&e.stance===p.StanceType.Paradrop)&&(!(e.isTechno()&&!i)||!r.areFriendly(e,o)))))g.isDestroyed||(g.isInfantry()&&(g.infDeathType=a.InfDeathType.None),o.isVehicle()&&g.isOverlay()&&g.rules.wall&&o.applyRocking(0,.5),g.deathType=l.DeathType.Crush,r.destroyObject(g,{player:o.owner,obj:o}));o.onBridge||(c=r.map.tileOccupation.getGroundObjectsOnTile(o.tile).find((e=>e.isOverlay()&&e.rules.crate)))&&r.crateGeneratorTrait.pickupCrate(o,c,r)}r.traits.filter(m.NotifyTileChange).forEach((t=>{t[m.NotifyTileChange.onTileChange](o,r,e,s)})),o.traits.filter(f.NotifyTileChange).forEach((t=>{t[f.NotifyTileChange.onTileChange](o,r,e,s)})),r.events.dispatch(new y.EnterTileEvent(o.tile,o))}handleElevationChange(e,t){t.traits.filter(v.NotifyElevationChange).forEach((i=>{i[v.NotifyElevationChange.onElevationChange](this.gameObject,t,e)}))}unreservePathNodes(){this.reservedPathNodes.forEach((e=>{e.tile!==this.gameObject.tile&&this.tileOccupation.unoccupySingleTile(e.tile,this.gameObject)})),this.reservedPathNodes.length=0}dispose(){this.gameObject=void 0}},e("MoveTrait",E)}}})),System.register("game/gameobject/trait/SuppressionTrait",["game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class{constructor(){this.suppressionTicks=0,this.enabled=!0}disable(){this.enabled=!1}isSuppressed(){return this.enabled&&0<this.suppressionTicks}supress(){this.enabled&&(this.suppressionTicks=30)}[i.NotifyTick.onTick](){0<this.suppressionTicks&&this.suppressionTicks--}},e("SuppressionTrait",r)}}})),System.register("game/gameobject/trait/IdleActionTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/task/ScatterTask","game/GameSpeed"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{constructor(){this.cooldownTicks=Number.POSITIVE_INFINITY,this._actionDueThisTick=!1}[i.NotifyTick.onTick](e,t){this._actionDueThisTick=!1;var i=!e.unitOrderTrait.hasTasks();i&&!this.idle?this.resetCooldown(t):i?0===this.cooldownTicks?(this.doIdleAction(e,t),this.resetCooldown(t)):this.cooldownTicks--:this.cooldownTicks=Number.POSITIVE_INFINITY,this.idle=i}doIdleAction(e,t){if(e.isInfantry()){if(e.rules.fraidycat&&.5<t.generateRandom())return void e.unitOrderTrait.addTask(new r.ScatterTask(t,void 0,{noSlopes:!0}));this._actionDueThisTick=!0}}actionDueThisTick(){return this._actionDueThisTick}resetCooldown(e){var t=e.rules.audioVisual.idleActionFrequency,i=e.generateRandom()*t*.5;i=Math.max(0,t-i);this.cooldownTicks=Math.floor(i*s.GameSpeed.BASE_TICKS_PER_SECOND)}},e("IdleActionTrait",n)}}})),System.register("game/gameobject/trait/AgentTrait",["game/rules/TechnoRules","util/math"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("AgentTrait",class{infiltrate(e,t,s){var n,a;t.rules.radar&&![...t.owner.buildings].some((e=>e.rules.spySat))&&s.mapShroudTrait.resetShroud(t.owner,s),0<t.rules.power&&(n=s.rules.general.spyPowerBlackout,t.owner.powerTrait?.setBlackoutFor(n,s)),t.superWeaponTrait&&t.superWeaponTrait.getSuperWeapon(t)?.resetTimer(),0<t.rules.storage&&(a=r.clamp(s.rules.general.spyMoneyStealPercent,0,1),a=Math.floor(t.owner.credits*a),t.owner.credits-=a,e.owner.credits+=a),!s.rules.ai.buildTech.includes(t.name)||void 0!==(a=t.rules.aiBasePlanningSide)&&e.owner.production.addStolenTech(a),[i.FactoryType.InfantryType,i.FactoryType.UnitType].includes(t.factoryTrait?.type)&&e.owner.production?.addVeteranType(t.factoryTrait.type)}})}}})),System.register("game/gameobject/Infantry",["engine/type/ObjectType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/gameobject/trait/MoveTrait","game/gameobject/trait/SuppressionTrait","game/gameobject/Techno","game/gameobject/trait/IdleActionTrait","game/gameobject/trait/CrashableTrait","game/gameobject/trait/AgentTrait","game/gameobject/unit/CrateBonuses"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class extends l.Techno{constructor(e,t,a){super(i.ObjectType.Infantry,e,t,a),this.direction=0,this.onBridge=!1,this.zone=r.ZoneType.Ground,this._stance=s.StanceType.None,this.isFiring=!1,this.isPanicked=!1,this.infDeathType=n.InfDeathType.Gunfire,this.crateBonuses=new d.CrateBonuses}get isMoving(){return this.moveTrait.isMoving()}static factory(e,t,i,r){let s=new this(e,t,i);return s.moveTrait=new a.MoveTrait(s,r),s.traits.add(s.moveTrait),s.rules.crashable&&(s.crashableTrait=new h.CrashableTrait(s),s.traits.add(s.crashableTrait)),s.rules.proneWhenAttacked&&(s.suppressionTrait=new o.SuppressionTrait,s.traits.add(s.suppressionTrait)),s.rules.agent&&(s.agentTrait=new u.AgentTrait,s.traits.add(s.agentTrait)),s.idleActionTrait=new c.IdleActionTrait,s.traits.add(s.idleActionTrait),s}get stance(){return this._stance===s.StanceType.None&&this.suppressionTrait?.isSuppressed()?s.StanceType.Prone:this._stance}set stance(e){this._stance=e,this.moveTrait.setDisabled([s.StanceType.Deployed,s.StanceType.Cheer].includes(e)),this.attackTrait?.setDisabled([s.StanceType.Paradrop,s.StanceType.Cheer].includes(e))}isUnit(){return!0}isInfantry(){return!0}},e("Infantry",g),g.SUB_CELLS=[2,4,3]}}})),System.register("game/event/BuildingEvacuateEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingEvacuateEvent",class{constructor(e,t){this.target=e,this.player=t,this.type=i.EventType.BuildingEvacuate}})}}})),System.register("game/gameobject/trait/GarrisonTrait",["game/gameobject/trait/interface/NotifyDestroy","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyDamage","util/math","game/event/BuildingEvacuateEvent","game/gameobject/task/ScatterTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class{constructor(e,t,i){this.building=e,this.evacThreshold=t,this.maxOccupants=i,this.units=[]}isOccupied(){return!!this.units.length}canBeOccupied(){return this.building.healthTrait.health>100*this.evacThreshold}[s.NotifyDamage.onDamage](e,t){e.healthTrait.health<=100*this.evacThreshold&&this.evacuate(t)}[i.NotifyDestroy.onDestroy](e,t,i,r){if(r){for(var s of this.units)t.destroyObject(s,i,!0);this.units=[]}else this.evacuate(t)}getHash(){return n.fnv32a(this.units.map((e=>e.getHash())))}debugGetState(){return{units:this.units.map((e=>e.debugGetState()))}}dispose(){this.building=void 0}evacuate(e,t=!1){let i=this.building,s=this.units;if(s.length){let d=new Map;for(var n of s)d.set(n.rules.speedType,(d.get(n.rules.speedType)||[]).concat(n));for(let[n,a]of d){var l,c=new r.RadialTileFinder(e.map.tiles,e.map.mapBounds,i.tile,i.art.foundation,1,1,(t=>0<e.map.terrain.getPassableSpeed(t,n,!1)&&Math.abs(t.z-i.tile.z)<2&&!e.map.terrain.findObstacles({tile:t,onBridge:void 0},a[0]).length)).getNextTile();for(l of a){var h=s.indexOf(l);c?(s.splice(h,1),e.unlimboObject(l,c),l.unitOrderTrait.addTask(new o.ScatterTask(e))):t||(e.destroyObject(l,{player:l.owner}),s.splice(h,1))}}var u=i.owner;s.length||i.isDestroyed||e.changeObjectOwner(i,e.getCivilianPlayer()),e.events.dispatch(new a.BuildingEvacuateEvent(i,u))}}},e("GarrisonTrait",l)}}})),System.register("game/event/BuildStatusChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildStatusChangeEvent",class{constructor(e,t){this.target=e,this.status=t,this.type=i.EventType.BuildStatusChange}})}}})),System.register("game/event/PowerLowEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PowerLowEvent",class{constructor(e){this.target=e,this.type=i.EventType.PowerLow}})}}})),System.register("game/event/PowerRestoreEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PowerRestoreEvent",class{constructor(e){this.target=e,this.type=i.EventType.PowerRestore}})}}})),System.register("game/event/PowerChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PowerChangeEvent",class{constructor(e,t,r){this.target=e,this.power=t,this.drain=r,this.type=i.EventType.PowerChange}})}}})),System.register("game/trait/interface/NotifyPower",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{}).onPowerLow=Symbol(),t.onPowerRestore=Symbol(),t.onPowerChange=Symbol(),e("NotifyPower",i)}}})),System.register("game/player/trait/PowerTrait",["game/event/PowerLowEvent","game/event/PowerRestoreEvent","game/event/PowerChangeEvent","game/trait/interface/NotifyPower","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.Low=0]="Low",t[t.Normal=1]="Normal",e("PowerLevel",o),e("PowerTrait",class{constructor(e){this.player=e,this.power=0,this.drain=0,this.level=o.Normal,this.blackoutFrames=0,this.powerByObject=new Map}isLowPower(){return this.level===o.Low}setBlackoutFor(e,t){var i=0<this.blackoutFrames;this.blackoutFrames=e,i||this.updateLevel(t)}updateBlackout(e){0<this.blackoutFrames&&(this.blackoutFrames--,this.blackoutFrames<=0&&this.updateLevel(e))}getBlackoutDuration(){return this.blackoutFrames}updateFrom(e,t,i){var r=e.rules.power;if(r){if(r<0)"add"!==t&&"remove"!==t||(this.drain+="add"===t?-r:r);else{let i=0;if("add"===t){var a=Math.ceil(r*e.healthTrait.health/100);this.powerByObject.set(e,a),i=a}else if("update"===t||"remove"===t){if(void 0===(a=this.powerByObject.get(e)))throw new Error("Cannot update power before add.");i="update"===t?(r=Math.ceil(r*e.healthTrait.health/100),this.powerByObject.set(e,r),r-a):(this.powerByObject.delete(e),-a)}this.power+=i}this.updateLevel(i),i.traits.filter(n.NotifyPower).forEach((e=>{e[n.NotifyPower.onPowerChange](this.player,i)})),i.events.dispatch(new s.PowerChangeEvent(this.player,this.power,this.drain))}}updateLevel(e){var t=this.level;this.level=this.power>=this.drain&&!this.blackoutFrames?o.Normal:o.Low,this.level!==t&&(t===o.Normal&&this.level===o.Low&&(e.traits.filter(n.NotifyPower).forEach((t=>{t[n.NotifyPower.onPowerLow](this.player,e)})),e.events.dispatch(new i.PowerLowEvent(this.player))),t===o.Low&&this.level===o.Normal&&(e.traits.filter(n.NotifyPower).forEach((t=>{t[n.NotifyPower.onPowerRestore](this.player,e)})),e.events.dispatch(new r.PowerRestoreEvent(this.player))))}getHash(){return a.fnv32a([this.power,this.drain])}debugGetState(){return{power:this.power,drain:this.drain}}dispose(){this.player=void 0,this.powerByObject.clear()}})}}})),System.register("game/gameobject/trait/PoweredTrait",["game/player/trait/PowerTrait"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PoweredTrait",class{constructor(e){this.obj=e,this.turnedOn=!0}setTurnedOn(e){this.turnedOn=e}isCharged(){return!!this.obj.isBuilding()&&!!this.obj.overpoweredTrait?.hasChargersToPowerOn()}isPoweredOn(e=!1){return!(!this.obj||!this.turnedOn||(e||!this.isCharged())&&(!this.obj.rules.power&&this.obj.rules.needsEngineer?this.obj.owner.isNeutral:!this.obj.owner.powerTrait||this.obj.owner.powerTrait?.level===i.PowerLevel.Low))}dispose(){this.obj=void 0}})}}})),System.register("game/player/production/ProductionQueue",["util/event"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Structures=0]="Structures",t[t.Armory=1]="Armory",t[t.Infantry=2]="Infantry",t[t.Vehicles=3]="Vehicles",t[t.Aircrafts=4]="Aircrafts",t[t.Ships=5]="Ships",e("QueueType",r),(t=s=s||{})[t.Idle=0]="Idle",t[t.Active=1]="Active",t[t.OnHold=2]="OnHold",t[t.Ready=3]="Ready",e("QueueStatus",s),e("ProductionQueue",class{constructor(e,t,r){this.type=e,this._maxSize=t,this.maxItemQuantity=r,this.items=[],this.size=0,this._status=s.Idle,this._onUpdate=new i.EventDispatcher}get onUpdate(){return this._onUpdate.asEvent()}get status(){return this._status}set status(e){var t=this._status;(this._status=e)!==t&&this._onUpdate.dispatch(this)}get maxSize(){return this._maxSize}set maxSize(e){var t=this.size;this.size=Math.min(e,this.size);let i=0,r=0;for(;i<=this.size&&r<this.items.length;){let e=this.items[r];i+=e.quantity,i>this.size&&(e.quantity-=i-this.size),0<e.quantity&&r++}this._maxSize=e,this.items[r]&&this.items.splice(r),t!==this.size&&(this.size||(this._status=s.Idle),this._onUpdate.dispatch(this))}get currentSize(){return this.size}find(e){return this.items.filter((t=>t.rules===e))}getFirst(){return this.items[0]}getAll(){return[...this.items]}push(e,t,i){t=Math.min(this.maxSize-this.size,t);var r=this.find(e).reduce(((e,t)=>e+t.quantity),0);t=Math.min(this.maxItemQuantity-r,t),this.items[this.items.length-1]?.rules===e?this.items[this.items.length-1].quantity+=t:this.items.push({rules:e,quantity:t,creditsEach:i,creditsSpent:0,creditsSpentLeftover:0,progress:0}),this.size+=t,t&&(this._status===s.Idle&&(this._status=s.Active),this._onUpdate.dispatch(this))}pop(e,t){this.remove(e,t,!1)}shift(e,t){this.remove(e,t,!0)}remove(e,t,i){let n=this.find(e);if(!n.length)throw new Error(`Can't remove non-existent item ${e.name} from queue `+r[this.type]);var a;if(n.reduce(((e,t)=>e+t.quantity),0)<t)throw new Error(`Attempted to remove a quantity larger than the one in queue (${e.name})`);let o=t;for(;0<o;){let e=i?n.shift():n.pop();e.quantity<=o?(a=this.getFirst()===e,this.items.splice(this.items.indexOf(e),1),a&&(this._status=s.Active),o-=e.quantity):(e.quantity-=o,o=0)}this.size-=t,t&&(this.size||(this._status=s.Idle),this._onUpdate.dispatch(this))}notifyUpdated(){this._onUpdate.dispatch(this)}})}}})),System.register("game/gameobject/task/move/AttackMoveTargetTask",["game/gameobject/task/AttackTask","game/gameobject/trait/MoveTrait"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class e extends i.AttackTask{constructor(e,t,i){if(super(e,t,i),this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.internalTargetUpdateRequested=!1,this.scanCooldownTicks=0,!t.obj?.isTechno())throw new Error("Target must be a techno object");this.initialTarget=t,this.initialWeapon=i,this.requestedTarget=t}duplicate(){return new e(this.game,this.initialTarget,this.initialWeapon)}requestTargetUpdate(e){this.internalTargetUpdateRequested?(this.requestedTarget=e,this.internalTargetUpdateRequested=!1):(this.requestedTarget===this.initialTarget?this.requestedTarget=e:this.attackPerformed=!0,this.initialTarget=e),super.requestTargetUpdate(e)}onTargetChange(e){super.onTargetChange(e);var t=e.attackTrait.currentTarget;t&&t.obj!==this.initialTarget.obj&&t.obj!==this.requestedTarget.obj&&(this.requestedTarget===this.initialTarget&&(this.requestedTarget=t),this.initialTarget=t)}onTick(e){if(e.moveTrait.moveState===r.MoveState.Moving&&(this.passedFirstWaypoint=!0),this.scanCooldownTicks=Math.max(0,this.scanCooldownTicks-1),e.attackTrait&&!e.attackTrait.isDisabled()&&!this.isCancelling()&&(this.requestedTarget===this.initialTarget||this.attackPerformed)){if(!(e.moveTrait.isIdle()||e.tile===this.lastScanTile&&this.scanCooldownTicks)){this.lastScanTile=e.tile,this.scanCooldownTicks=this.game.rules.general.normalTargetingDelay;let r=e.attackTrait.selectDefaultWeapon(e);if(r&&(this.passedFirstWaypoint||!r.getCooldownTicks())){var t=e.attackTrait.scanForTarget(e,r,this.game);if(t.target){let{target:e,weapon:r}=t;if(!r.getCooldownTicks()){this.options.holdGround=!0,this.options.passive=!0,this.setWeapon(r);var i=this.game.createTarget(e,e.tile);return this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(i),this.attackPerformed=!1}}}}if(this.attackPerformed){if(!e.isSpawned){if(!this.forceCancel(e))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.options.holdGround=!1,this.options.passive=!1,this.setWeapon(this.initialWeapon),this.internalTargetUpdateRequested=!0,this.requestTargetUpdate(this.initialTarget)}}return(i=super.onTick(e))&&this.requestedTarget!==this.initialTarget?(this.attackPerformed=!0,this.isCancelling()||e.attackTrait.isDisabled()):i}},e("AttackMoveTargetTask",s)}}})),System.register("game/gameobject/task/move/AttackMoveTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class e extends i.MoveTask{constructor(){super(...arguments),this.attackPerformed=!1,this.passedFirstWaypoint=!1}duplicate(){return new e(this.game,this.targetTile,this.toBridge,this.options)}onTick(e){if(e.moveTrait.moveState===r.MoveState.Moving&&(this.passedFirstWaypoint=!0),e.moveTrait.moveState===r.MoveState.ReachedNextWaypoint&&e.attackTrait&&!e.attackTrait.isDisabled()&&!this.isCancelling()){let i=e.attackTrait.selectDefaultWeapon(e);if(i&&(this.passedFirstWaypoint||i&&!i.getCooldownTicks())){var t=e.attackTrait.scanForTarget(e,i,this.game);if(t.target){let{target:i,weapon:s}=t;if(!s.getCooldownTicks())return t=e.attackTrait.createAttackTask(this.game,i,i.tile,s,{holdGround:!0,passive:!0}),this.children.push(t),this.useChildTargetLines=!0,this.attackPerformed=!0,e.moveTrait.velocity.set(0,0,0),e.moveTrait.currentWaypoint=void 0,e.moveTrait.collisionState=r.CollisionState.Waiting,!1}}if(this.attackPerformed){if(!e.isSpawned){if(!this.forceCancel(e))throw new Error("Force cancel failed");return!0}this.attackPerformed=!1,this.passedFirstWaypoint=!1,this.useChildTargetLines=!1,e.moveTrait.collisionState=r.CollisionState.Resolved,this.updateTarget(this.targetTile,this.toBridge)}}return super.onTick(e)}},e("AttackMoveTask",s)}}})),System.register("game/gameobject/task/move/ExitFactoryTask",["game/gameobject/task/move/MoveTask","game/gameobject/trait/MoveTrait","game/rules/TechnoRules","game/gameobject/task/ScatterTask","game/gameobject/task/AttackTask","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/AttackMoveTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends i.MoveTask{constructor(e,t,i,r){super(e,i,!1,{ignoredBlockers:[t],closeEnoughTiles:0,strictCloseEnough:!0,forceWaitOnPathBlocked:t.factoryTrait?.type!==s.FactoryType.InfantryType}),this.factory=t,this.rallyPoint=r,this.preventOpportunityFire=!0,this.rampBlockersPushed=!1,this.cancellable=!1}onStart(e){super.onStart(e),this.factory.factoryTrait?.type===s.FactoryType.UnitType&&(this.checkRampTiles=this.game.map.tileOccupation.calculateTilesForGameObject(this.factory.tile,this.factory).filter((t=>0<this.game.map.terrain.getPassableSpeed(t,e.rules.speedType,!1))))}canStopAtTile(e,t,i){return!this.game.map.tileOccupation.isTileOccupiedBy(t,this.factory)&&super.canStopAtTile(e,t,i)}onTick(e){if(this.checkRampTiles){for(var t of this.checkRampTiles){var s,c;for(s of this.game.map.tileOccupation.getGroundObjectsOnTile(t))if(s.isUnit()){if(this.rampBlockersPushed)return!1;let e=new n.ScatterTask(this.game,void 0,{excludedTiles:this.checkRampTiles});e.setCancellable(!1);let t=s.unitOrderTrait.getCurrentTask();t?t.constructor!==i.MoveTask&&t.constructor!==a.AttackTask&&t.constructor!==l.AttackMoveTask&&t.constructor!==o.AttackMoveTargetTask||(c=t.duplicate(),t.cancel(),s.unitOrderTrait.addTaskNext(c),s.unitOrderTrait.addTaskNext(e)):s.unitOrderTrait.addTask(e)}}if(!this.rampBlockersPushed)return!(this.rampBlockersPushed=!0);this.checkRampTiles=void 0}return e.moveTrait.moveState===r.MoveState.ReachedNextWaypoint&&this.options?.ignoredBlockers&&!this.game.map.terrain.isBlockerObject(this.factory,e.tile,!1,e.rules.speedType)&&(this.options.ignoredBlockers=void 0,this.preventOpportunityFire=!1,this.rallyPoint&&(this.updateTarget(this.rallyPoint.tile,!!this.rallyPoint.onBridge),this.cancellable=!0,this.options.closeEnoughTiles=this.game.rules.general.closeEnough,this.options.strictCloseEnough=!1,this.options.forceWaitOnPathBlocked=!1)),super.onTick(e)}},e("ExitFactoryTask",c)}}})),System.register("game/map/tileFinder/CardinalTileFinder",["game/math/Vector2"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("CardinalTileFinder",class{constructor(e,t,r,s,n,a=(()=>!0)){this.tiles=e,this.mapBounds=t,this.startTile=r,this.maxDistance=n,this.predicate=a,this.dirVec=new i.Vector2(10,0),this.finished=!1,this.diagonal=!0,this.distance=s}getNextTile(){if(!this.finished){let t;do{let r={x:this.startTile.rx,y:this.startTile.ry};r.x+=this.distance*Math.sign(this.dirVec.x),r.y+=this.distance*Math.sign(this.dirVec.y),this.dirVec.rotateAround(new i.Vector2,Math.PI/4*(this.diagonal?1:2)).round();var e=this.tiles.getByMapCoords(r.x,r.y);if(e&&this.mapBounds.isWithinBounds(e)&&this.predicate(e)&&(t=e),!this.dirVec.angle()){if(this.maxDistance&&this.distance>=this.maxDistance)return this.finished=!0,t;this.distance++}}while(!t);return t}}})}}})),System.register("game/gameobject/trait/DockTrait",["game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySell","game/gameobject/trait/DockableTrait","game/Coords","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn","util/typeGuard","game/gameobject/task/MoveToDockTask","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/trait/interface/NotifyUnspawn"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class{constructor(e,t,i,r){this.building=e,this.tiles=t,this.numberOfDocks=i,this.dockingOffsets=r,this.ticksWhenWarpedOut=!0,this.unitsByDockNumber=new Array(i).fill(void 0),this.reservedDocks=new Array(i).fill(void 0)}[l.NotifySpawn.onSpawn](){this.dockTiles=[];for(let t=0;t<this.numberOfDocks;t++){var e=this.findDockTile(t);if(!e)throw new Error(`Docking tile ${t} not found for object "${this.building.name}"`);this.dockTiles[t]=e}}[p.NotifyUnspawn.onUnspawn](){for(let e=0;e<this.numberOfDocks;e++)this.unreserveDockAt(e)}[o.NotifyTick.onTick](){for(let t=0;t<this.numberOfDocks;t++){var e=this.unitsByDockNumber[t];e&&e.tile!==this.getDockTile(t)&&this.undockUnit(e)}}[i.NotifyDestroy.onDestroy](e,t,i,r){var s=(e.rules.unitRepair||e.helipadTrait)&&!e.rules.naval&&!i?.weapon?.warhead.rules.temporal;if(s)for(var n of this.unitsByDockNumber)n&&!n.isDestroyed&&(s?t.destroyObject(n,i,r):this.undockUnit(n))}[s.NotifySell.onSell](e,t){if(e.helipadTrait&&this.hasDockedUnits()){var i,r,s;let n=[],a=0;for(i of[...e.owner.buildings].filter((t=>t.helipadTrait&&(t.dockTrait?.getAvailableDockCount()??!1)&&t!==e))){let e=i.dockTrait?.getAvailableDockCount()??0;for(;0<e&&a<this.unitsByDockNumber.length;)n.push(i),e--,a++;if(a===this.unitsByDockNumber.length)break}for(r of(a=0,this.unitsByDockNumber))r&&((s=n[a])?r.unitOrderTrait.addTask(new h.MoveToDockTask(t,s)):r.unitOrderTrait.addTask(new g.TaskGroup(new u.MoveTask(t,r.tile,!1),new d.CallbackTask((i=>{i.crashableTrait?i.crashableTrait.crash({player:e.owner}):t.destroyObject(i,{player:e.owner})}))).setCancellable(!1))),a++}else{var n,a=e.rules.unitRepair&&!e.rules.naval;for(n of this.unitsByDockNumber)n&&(a?t.sellTrait.sell(n):this.undockUnit(n))}}[r.NotifyOwnerChange.onChange](e,t,i){for(var r of this.unitsByDockNumber)r&&i.changeObjectOwner(r,e.owner)}getFirstAvailableDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var e=this.unitsByDockNumber.findIndex(((e,t)=>!e&&!this.reservedDocks[t]));if(-1!==e)return e}}getAvailableDockCount(){return this.building?.warpedOutTrait.isActive()?0:this.unitsByDockNumber.filter(((e,t)=>!e&&!this.reservedDocks[t])).length}getFirstEmptyDockNumber(){if(!this.building?.warpedOutTrait.isActive()){var e=this.unitsByDockNumber.findIndex((e=>!e));if(-1!==e)return e}}getDockOffset(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);return this.dockingOffsets[e]}getDockTile(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);return this.dockTiles[e]}getDockNumberByTile(e){var t=this.dockTiles.indexOf(e);if(-1!==t)return t}getAllDockTiles(){return[...this.dockTiles]}findDockTile(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);var t=this.building.position.getMapPosition(),i=this.getDockOffset(e);return this.tiles.getByMapCoords(Math.floor((t.x+i.x)/a.Coords.LEPTONS_PER_TILE),Math.floor((t.y+i.z)/a.Coords.LEPTONS_PER_TILE))}isValidUnitForDock(e){return(this.building.unitRepairTrait&&e.isVehicle()&&!this.building.helipadTrait&&(!e.rules.consideredAircraft||e.rules.landable)||e.rules.dock.includes(this.building.name)&&!(e.isAircraft()&&!this.building.helipadTrait))&&this.building.rules.naval===e.rules.naval}dockUnitAt(e,t){if(t>this.numberOfDocks-1)throw new RangeError(`Index ${t} exceeds available docks (${this.numberOfDocks})`);if(this.unitsByDockNumber[t])throw new Error("Another unit is already docked at dock #"+t);let i=e.traits.find(n.DockableTrait);if(!i)throw new Error(`Unit "${e.name}" cannot be docked to `+this.building.name);this.unitsByDockNumber[t]=e,i.dock=this.building}undockUnitAt(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);let t=this.unitsByDockNumber[e];t&&(this.unitsByDockNumber[e]=void 0,t.traits.get(n.DockableTrait).dock=void 0)}undockUnit(e){var t=this.unitsByDockNumber.indexOf(e);-1!==t&&this.undockUnitAt(t)}isDocked(e){return this.unitsByDockNumber.includes(e)}hasDockedUnits(){return!!this.unitsByDockNumber.find((e=>e))}getDockedUnits(){return this.unitsByDockNumber.filter(c.isNotNullOrUndefined)}reserveDockAt(e,t){if(t>this.numberOfDocks-1)throw new RangeError(`Index ${t} exceeds available docks (${this.numberOfDocks})`);if(this.reservedDocks[t])throw new Error(`Dock #${t} is already reserved by `+this.reservedDocks[t].name);(this.reservedDocks[t]=e).traits.get(n.DockableTrait).reservedDock?.dockTrait.unreserveDockForUnit(e),e.traits.get(n.DockableTrait).reservedDock=this.building}unreserveDockAt(e){if(e>this.numberOfDocks-1)throw new RangeError(`Index ${e} exceeds available docks (${this.numberOfDocks})`);let t=this.reservedDocks[e];t&&(this.reservedDocks[e]=void 0,t.traits.get(n.DockableTrait).reservedDock=void 0)}unreserveDockForUnit(e){var t=this.reservedDocks.indexOf(e);-1!==t&&this.unreserveDockAt(t)}hasReservedDockForUnit(e){return!!this.reservedDocks.includes(e)}hasReservedDockAt(e){return!!this.reservedDocks[e]}getReservedDockForUnit(e){var t=this.reservedDocks.indexOf(e);if(-1!==t)return t}dispose(){this.building=void 0}},e("DockTrait",m)}}})),System.register("game/event/FactoryProduceUnitEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("FactoryProduceUnitEvent",class{constructor(e){this.target=e,this.type=i.EventType.FactoryProduceUnit}})}}})),System.register("game/gameobject/trait/interface/NotifyWarpChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyWarpChange",i)}}})),System.register("game/trait/interface/NotifyProduceUnit",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onProduce=Symbol(),e("NotifyProduceUnit",i)}}})),System.register("game/gameobject/trait/FactoryTrait",["game/gameobject/trait/interface/NotifyTick","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/task/move/ExitFactoryTask","engine/type/TerrainType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/MoveTrait","game/map/tileFinder/CardinalTileFinder","game/gameobject/trait/DockTrait","game/event/FactoryProduceUnitEvent","game/gameobject/Infantry","game/map/TileOccupation","game/gameobject/task/move/MoveTask","game/map/tileFinder/RadialTileFinder","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyProduceUnit","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){var t;(t=b=b||{})[t.Idle=0]="Idle",t[t.Delivering=1]="Delivering",e("FactoryStatus",b),S=class{constructor(e,t=!1){this.type=e,this.isCloningVats=t,this.status=b.Idle}[o.NotifySpawn.onSpawn](e,t){this.resetRallyPoint(e,t)}resetRallyPoint(e,t){var i;[s.FactoryType.BuildingType,s.FactoryType.AircraftType].includes(this.type)||(i=this.computeDefaultRallyPoint(e,this.type,t.map),e.rallyTrait?.changeRallyPoint(i,e,t))}[f.NotifyWarpChange.onChange](e,t,i){if(e.owner.production){let t=[];for(var n of(t=this.type===s.FactoryType.BuildingType?[r.QueueType.Structures,r.QueueType.Armory]:[e.owner.production.getQueueTypeForFactory(this.type)],t))e.owner.production.getQueue(n).notifyUpdated()}}[i.NotifyTick.onTick](e,t){if(this.status===b.Delivering){if(!this.deliveringUnit||this.deliveringUnit.isDestroyed){if(this.buildingProductionTicks=this.buildingProductionTicks??1,0<this.buildingProductionTicks--)return;this.buildingProductionTicks=void 0}else if(t.map.tileOccupation.isTileOccupiedBy(this.deliveringUnit.tile,e)){if(!this.deliveringUnit.rules.consideredAircraft)return;if(this.deliveringUnit.position.tileElevation<e.art.height)return}return this.status=b.Idle,void(this.deliveringUnit=void 0)}if(e.owner.production&&!e.warpedOutTrait.isActive()){let n=e.owner.production.getPrimaryFactory(this.type);if((n?.warpedOutTrait.isActive()||n===e||n?.factoryTrait?.deliveringUnit&&n.factoryTrait.type===s.FactoryType.UnitType)&&this.type!==s.FactoryType.BuildingType){let n=e.owner.production.getQueueForFactory(this.type);if(n&&n.status===r.QueueStatus.Ready){let a=n.getFirst();if(this.type===s.FactoryType.AircraftType){let r=this.produceAircraftAt(e,a,t);var i;if(!r)for(i of[...e.owner.buildings].filter((e=>e.factoryTrait?.type===s.FactoryType.AircraftType&&e.helipadTrait))){if(r)break;r=this.produceAircraftAt(i,a,t)}if(!r)return}else if(this.produceGroundUnitAt(e,a,t),!this.isCloningVats&&this.type===s.FactoryType.InfantryType){let i=[...e.owner.buildings].find((e=>e.factoryTrait&&e.rules.cloning));i?.factoryTrait.status===b.Idle&&i?.factoryTrait.produceGroundUnitAt(i,a,t)}e.owner.addUnitsBuilt(a.rules.type,1),a.creditsSpent=0,a.progress=0,n.shift(a.rules,1),n.currentSize&&(n.status=r.QueueStatus.Active)}}}}produceGroundUnitAt(e,t,i){let r=i.createUnitForPlayer(t.rules,e.owner);t.rules.trainable&&e.owner.canProduceVeteran(r.rules)&&r.veteranTrait?.setVeteranLevel(y.VeteranLevel.Veteran),r.isInfantry()&&(r.position.subCell=d.Infantry.SUB_CELLS[0]);let a,o=this.computeInternalRallyPoint(e,this.type,e.rallyTrait.getRallyPoint(),i.map);var c;let h;if(this.type!==s.FactoryType.UnitType&&(o=e.rallyTrait.findRallyPointforUnit(r,o,i.map,!1,e.tile.z)),a=this.type===s.FactoryType.NavalUnitType?o:(c=this.computeExitCoords(e,this.type),i.map.tiles.getByMapCoords(Math.floor(c.rx),Math.floor(c.ry))),r.rules.consideredAircraft&&(o=a),e.rallyTrait.getRallyPoint()!==o&&(h=e.rallyTrait.findRallyNodeForUnit(r,i.map)),r.isInfantry()){let e=i.map.tileOccupation.getObjectsOnTileByLayer(h?.tile??o,r.rules.consideredAircraft?g.LayerType.Air:g.LayerType.Ground).filter((e=>e.isInfantry()&&e.moveTrait.moveState!==l.MoveState.Moving)).map((e=>e.position.subCell));r.position.subCell=d.Infantry.SUB_CELLS.find((t=>!e.includes(t)))??d.Infantry.SUB_CELLS[0]}r.direction=270,i.spawnObject(r,a),i.traits.filter(T.NotifyProduceUnit).forEach((e=>{e[T.NotifyProduceUnit.onProduce](r,i)})),i.events.dispatch(new u.FactoryProduceUnitEvent(r)),r.rules.consideredAircraft?(c=h??{tile:o,onBridge:void 0},r.unitOrderTrait.addTask(new p.MoveTask(i,c.tile,!!c.onBridge,{closeEnoughTiles:i.rules.general.closeEnough}))):r.unitOrderTrait.addTask(new n.ExitFactoryTask(i,e,o,h)),this.status=b.Delivering,this.deliveringUnit=r}produceAircraftAt(e,t,i){let r=e.traits.find(h.DockTrait);if(!r)return!1;var s=r.getFirstAvailableDockNumber();if(void 0===s)return!1;let n=i.createUnitForPlayer(t.rules,e.owner);t.rules.trainable&&e.owner.canProduceVeteran(n.rules)&&n.veteranTrait?.setVeteranLevel(y.VeteranLevel.Veteran);var a=r.getDockOffset(s);return n.position.moveToLeptons(e.position.getMapPosition()),n.position.moveByLeptons3(a),i.spawnObject(n,n.position.tile),r.dockUnitAt(n,s),n.isAircraft()&&n.airportBoundTrait&&(n.airportBoundTrait.preferredAirport=e),i.traits.filter(T.NotifyProduceUnit).forEach((e=>{e[T.NotifyProduceUnit.onProduce](n,i)})),i.events.dispatch(new u.FactoryProduceUnitEvent(n)),!0}computeExitCoords(e,t){if(t===s.FactoryType.InfantryType)return this.computeBarracksDefaultExitCoords(e);if(t===s.FactoryType.UnitType)return this.computeWarFactoryExitCoords(e);throw new Error("Unsupported factory type "+s.FactoryType[t])}computeInternalRallyPoint(e,t,i,r){let n,a;if(t===s.FactoryType.NavalUnitType)a=this.computeNavalInternalRallyPoint(e,i,r);else{if(t===s.FactoryType.InfantryType)n=this.computeBarracksInternalRallyCoords(e);else{if(t!==s.FactoryType.UnitType)throw new Error("Unsupported factory type "+s.FactoryType[t]);n=this.computeWarFactoryInternalRallyCoords(e)}a=r.tiles.getByMapCoords(n.rx,n.ry)}return a??this.findTileAdjacentToBuilding(e,r)}computeDefaultRallyPoint(e,t,i){let r,n;if(t===s.FactoryType.NavalUnitType)n=this.computeNavalDefaultRallyPoint(e,i);else{if(t===s.FactoryType.InfantryType)r=this.computeBarracksInternalRallyCoords(e);else{if(t!==s.FactoryType.UnitType)throw new Error("Unsupported factory type "+s.FactoryType[t]);r=this.computeWarFactoryDefaultRallyCoords(e)}n=i.tiles.getByMapCoords(r.rx,r.ry)}return n??this.findTileAdjacentToBuilding(e,i)}findTileAdjacentToBuilding(e,t){return new m.RadialTileFinder(t.tiles,t.mapBounds,e.tile,e.getFoundation(),1,1,(()=>!0)).getNextTile()}computeBarracksDefaultExitCoords(e){var t=e.getFoundation();let i,r;return t.width<=2||t.height<=2?(i=t.width-1,r=t.height-1,e.rules.gdiBarracks&&2<t.width&&(i=Math.floor(t.width/2))):(i=0,r=t.height-1),{rx:e.tile.rx+i,ry:e.tile.ry+r}}computeBarracksInternalRallyCoords(e){var t=e.getFoundation();let{rx:i,ry:r}=this.computeBarracksDefaultExitCoords(e);return!(t.width<=2||t.height<=2)||e.rules.gdiBarracks?r+=1:e.rules.nodBarracks&&(i+=t.width<=2?1:0,r+=t.height<=2?1:0),{rx:i,ry:r}}computeWarFactoryExitCoords(e){var t=e.getFoundation();return{rx:e.tile.rx+Math.floor(t.width/2),ry:e.tile.ry+Math.floor(t.height/2)}}computeWarFactoryInternalRallyCoords(e){var t=e.getFoundation();return{rx:e.tile.rx+t.width-1,ry:e.tile.ry+Math.floor(t.height/2)}}computeWarFactoryDefaultRallyCoords(e){var t=e.getFoundation();return{rx:e.tile.rx+t.width,ry:e.tile.ry+Math.floor(t.height/2)}}computeNavalDefaultRallyPoint(e,t){let i=new c.CardinalTileFinder(t.tiles,t.mapBounds,e.centerTile,5,5,(e=>e.terrainType===a.TerrainType.Water&&!t.getObjectsOnTile(e).find((e=>e.isBuilding()||e.isOverlay()&&e.isBridge()))));return i.diagonal=!1,i.getNextTile()??t.tiles.getByMapCoords(e.tile.rx+e.getFoundation().width,e.tile.ry+e.getFoundation().height)}computeNavalInternalRallyPoint(e,t,i){var r=new v.Vector2(t.rx,t.ry).sub(new v.Vector2(e.centerTile.rx,e.centerTile.ry));return i.tiles.getByMapCoords(e.centerTile.rx+Math.sign(r.x)*(Math.floor(e.getFoundation().width/2)+1),e.centerTile.ry+Math.sign(r.y)*(Math.floor(e.getFoundation().height/2)+1))}},e("FactoryTrait",S)}}})),System.register("game/map/tileFinder/RadialBackFirstTileFinder",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RadialBackFirstTileFinder",class{constructor(e,t,i,r,s,n,a,o=!0){this.tiles=e,this.mapBounds=t,this.startTile=i,this.foundation=r,this.maxDistance=n,this.predicate=a,this.checkBounds=o,this.distance=s,this.generator=this.generate()}getNextTile(){return this.generator.next().value}*generate(){var e=(e,t)=>{var i=this.tiles.getByMapCoords(e,t);if(i&&(!this.checkBounds||this.mapBounds.isWithinBounds(i))&&this.predicate(i))return i};do{var t=this.startTile.rx-this.distance,i=this.startTile.ry-this.distance,r=this.startTile.rx+this.foundation.width-1+this.distance,s=this.startTile.ry+this.foundation.height-1+this.distance;let n,a,o;if(0<this.distance){for(a=1+i;a<s;a++)o=e(t,a),o&&(yield o);for(n=t;n<r;n++)o=e(n,i),o&&(yield o);for(a=s-1;a>=i;a--)o=e(r,a),o&&(yield o);for(n=r;n>=t;n--)o=e(n,s),o&&(yield o)}else this.predicate(this.startTile)&&(yield this.startTile)}while(this.distance++,this.distance<=this.maxDistance)}})}}})),System.register("game/gameobject/trait/FreeUnitTrait",["game/gameobject/trait/interface/NotifySpawn","engine/type/ObjectType","game/map/tileFinder/RadialBackFirstTileFinder"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{[i.NotifySpawn.onSpawn](e,t){if(!e.owner.isNeutral){let n;if(t.rules.hasObject(e.rules.freeUnit,r.ObjectType.Vehicle))n=t.rules.getObject(e.rules.freeUnit,r.ObjectType.Vehicle);else{if(!t.rules.hasObject(e.rules.freeUnit,r.ObjectType.Infantry))return void console.warn(`Free unit "${e.rules.freeUnit}" is not a vehicle or infantry type.`);n=t.rules.getObject(e.rules.freeUnit,r.ObjectType.Infantry)}let a,o=t.createUnitForPlayer(n,e.owner);var i=new s.RadialBackFirstTileFinder(t.map.tiles,t.map.mapBounds,e.tile,e.getFoundation(),1,1,(i=>{var r=0<t.map.terrain.getPassableSpeed(i,o.rules.speedType,!1)&&Math.abs(i.z-e.tile.z)<2&&!t.map.terrain.findObstacles({tile:i,onBridge:void 0},o).length;return!a&&r&&(a=i),r&&!t.map.getObjectsOnTile(i).find((e=>e.isOverlay()))})).getNextTile()??a;if(!i)return e.owner.removeOwnedObject(o),void o.dispose();t.spawnObject(o,i)}}},e("FreeUnitTrait",n)}}})),System.register("game/gameobject/trait/CabHutTrait",["engine/type/ObjectType","game/map/BridgeOverlayTypes","game/gameobject/task/ScatterTask","game/gameobject/unit/ZoneType","game/gameobject/common/DeathType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("CabHutTrait",class{constructor(e,t){this.gameObject=e,this.bridges=t,this.checkedClosestBridge=!1}canRepairBridge(){var e=this.findClosestBridgeBounds();return e?this.bridges.canBeRepaired(e):(console.warn(`No bridge associated with hut at ${this.gameObject.tile.rx}, ${this.gameObject.tile.ry}.`),!1)}repairBridge(e,t){var s=this.findClosestBridgeBounds();if(!s)throw new Error("No bridge bounds found");var n=this.bridges.findDestroyedPieceTiles(s),a=s.start.rx!==s.end.rx;let o;o=s.isHigh?r.BridgeOverlayTypes.calculateHighBridgeOverlayId(s.type,a):r.BridgeOverlayTypes.calculateLowBridgeOverlayId(s.type,a);var l,c,h=e.rules.getOverlayName(o);for(l of n){let r=e.createObject(i.ObjectType.Overlay,h);r.overlayId=o,r.value=0,r.position.tileElevation=s.isHigh?4:0,e.spawnObject(r,l),this.updateUnitsUnderBridgePiece(l,s,e,t)}for(c of this.bridges.findBridgePieces(s))c.obj.bridgeTrait.bridgeSpec=s}updateUnitsUnderBridgePiece(e,t,i,r){var a;for(let o of this.bridges.getPieceTiles(this.bridges.getPieceAtTile(e)))if(t.isHigh){i.map.getGroundObjectsOnTile(o).filter((e=>e.tile===o&&e.isUnit()&&!e.unitOrderTrait.hasTasks()&&e.rules.tooBigToFitUnderBridge)).forEach((e=>e.unitOrderTrait.addTask(new s.ScatterTask(i))))}else for(a of i.map.getGroundObjectsOnTile(o))a.isUnit()&&(i.map.terrain.getPassableSpeed(o,a.rules.speedType,!0)?(a.zone=n.ZoneType.Ground,a.onBridge=!0):a.isDestroyed||i.destroyObject(a,{player:r}))}demolishBridge(e,t){var i=this.getBridgePieces();if(i)for(var r of i)r.obj.isLowBridge()&&e.map.getTileZone(r.obj.tile,!0)!==n.ZoneType.Water||r.obj.isDestroyed||(r.obj.deathType=a.DeathType.Demolish,e.destroyObject(r.obj,t,!0))}getBridgePieces(){var e=this.findClosestBridgeBounds();if(e)return this.bridges.findBridgePieces(e)}findClosestBridgeBounds(){return this.checkedClosestBridge||(this.checkedClosestBridge=!0,this.closestBridge=this.bridges.findClosestBridgeSpec(this.gameObject.tile)),this.closestBridge}dispose(){this.gameObject=void 0}})}}})),System.register("game/gameobject/trait/OilDerrickTrait",["game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifySpawn"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{constructor(){this.isActive=!1,this.produceCashCooldown=0}[s.NotifySpawn.onSpawn](e){e.owner.isNeutral||(this.isActive=!0)}[i.NotifyOwnerChange.onChange](e,t){t.isNeutral&&!e.owner.isNeutral&&(e.owner.credits=Math.max(0,e.owner.credits+e.rules.produceCashStartup),this.isActive=!0,this.produceCashCooldown=e.rules.produceCashDelay)}[r.NotifyTick.onTick](e){this.isActive&&(this.produceCashCooldown--,this.produceCashCooldown<=0&&(this.produceCashCooldown=e.rules.produceCashDelay,e.owner.credits=Math.max(0,e.owner.credits+e.rules.produceCashAmount)))}},e("OilDerrickTrait",n)}}})),System.register("game/gameobject/trait/OverpoweredTrait",["game/gameobject/task/AttackTask","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(e){this.obj=e,this.chargers=new Set}isOverpowered(){let e=1;return this.obj?.poweredTrait?.isPoweredOn(!0)||(e+=2),this.chargers.size>=e}hasChargersToPowerOn(){return 2<=this.chargers.size}chargeFrom(e){this.chargers.add(e),this.swapAttackTaskWeapon()}[r.NotifyTick.onTick](e){if(0<this.chargers.size){let t=!1;this.chargers.forEach((i=>{(i.isDestroyed||i.isCrashing||i.owner!==e.owner||i.attackTrait?.currentTarget?.obj!==e)&&(this.chargers.delete(i),t=!0)})),t&&this.swapAttackTaskWeapon()}}swapAttackTaskWeapon(){let e=this.obj?.unitOrderTrait.getCurrentTask();var t;e instanceof i.AttackTask&&((t=this.getWeapon())?e.setWeapon(t):e.cancel())}getWeapon(){return this.isOverpowered()?this.obj?.secondaryWeapon:this.obj?.primaryWeapon}dispose(){this.obj=void 0,this.chargers.clear()}},e("OverpoweredTrait",s)}}})),System.register("game/event/UnitRepairFinishEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("UnitRepairFinishEvent",class{constructor(e,t){this.target=e,this.from=t,this.type=i.EventType.UnitRepairFinish}})}}})),System.register("game/event/UnitRepairStartEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("UnitRepairStartEvent",class{constructor(e){this.target=e,this.type=i.EventType.UnitRepairStart}})}}})),System.register("game/gameobject/trait/UnitRepairTrait",["game/event/UnitRepairFinishEvent","game/event/UnitRepairStartEvent","game/GameSpeed","game/math/Vector2","game/gameobject/task/move/MoveTask","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){var t;(t=h=h||{})[t.Idle=0]="Idle",t[t.Repairing=1]="Repairing",e("RepairStatus",h),u=class{constructor(){this.status=h.Idle,this.cooldownTicks=0,this.lastRepairTickSuccessful=!1}[l.NotifySpawn.onSpawn](e,t){this.resetRallyPoint(e,t)}resetRallyPoint(e,t){var i;e.factoryTrait||(i=this.computeDefaultRallyPoint(e,t.map),e.rallyTrait.changeRallyPoint(i,e,t))}[c.NotifyTick.onTick](e,t){if(e.dockTrait&&(!e.rules.needsEngineer||!e.owner.isNeutral))if(!e.dockTrait.hasDockedUnits()||e.dockTrait.getDockedUnits().some((e=>e.zone===o.ZoneType.Air))||e.poweredTrait&&!e.poweredTrait.isPoweredOn())this.status=h.Idle;else if(this.cooldownTicks<=0){var n,l,c=t.rules.general.repair;c=e.rules.unitReload?c.reloadRate:c.uRepairRate;this.cooldownTicks+=s.GameSpeed.BASE_TICKS_PER_SECOND*c*60;let u=!1;for(n of e.dockTrait.getDockedUnits())n.zone!==o.ZoneType.Air&&(n.healthTrait.health<100&&t.areFriendly(n,e)?(this.tickRepair(n,t,e)&&(u=!0),!u||this.status!==h.Idle&&this.lastRepairTickSuccessful||e.helipadTrait||t.events.dispatch(new r.UnitRepairStartEvent(n))):((l=e.rallyTrait.findRallyNodeForUnit(n,t.map))&&(e.dockTrait.undockUnit(n),n.unitOrderTrait.addTask(new a.MoveTask(t,l.tile,!!l.onBridge,{closeEnoughTiles:t.rules.general.closeEnough}))),e.helipadTrait||t.events.dispatch(new i.UnitRepairFinishEvent(n,e))));this.lastRepairTickSuccessful=u,this.status=u?h.Repairing:h.Idle}else this.cooldownTicks--}tickRepair(e,t,i){var r=t.rules.general.repair,s=Math.floor(r.repairStep),n=r.repairPercent;let a;if(n){if(r=n*e.purchaseValue/e.healthTrait.maxHitPoints,n=Math.min(i.owner.credits,Math.max(1,Math.floor(r*s))),a=r&&n?Math.floor(n/r):s,!n)return!1;i.owner.credits-=n}else a=s;return a=Math.min(a,e.healthTrait.maxHitPoints-e.healthTrait.getHitPoints()),!!a&&(e.healthTrait.healBy(a,i,t),!0)}computeDefaultRallyPoint(e,t){var i=e.getFoundation();i=new n.Vector2(e.tile.rx,e.tile.ry+i.height);return t.tiles.getByMapCoords(i.x,i.y)??e.tile}},e("UnitRepairTrait",u)}}})),System.register("game/gameobject/trait/RallyTrait",["engine/type/TerrainType","game/map/tileFinder/RadialTileFinder","game/rules/TechnoRules","game/type/MovementZone","game/type/SpeedType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("RallyTrait",class{getRallyPoint(){return this.rallyPoint}changeRallyPoint(e,t,i){var r=this.findValidRallyPoint(t,e,i.map);r&&(this.rallyPoint=r)}findValidRallyPoint(e,t,n){let o=new r.RadialTileFinder(n.tiles,n.mapBounds,t,{width:1,height:1},0,20,(t=>e.rules.naval===(t.terrainType===i.TerrainType.Water)&&!n.tileOccupation.isTileOccupiedBy(t,e))),l=o.getNextTile();if(!l&&e.factoryTrait?.type===s.FactoryType.NavalUnitType){var{width:c,height:h}=e.getFoundation();for(let t=0;t<c;t++)for(let i=0;i<h;i++){var u=n.tiles.getByMapCoords(e.tile.rx+t,e.tile.ry+i);if(!u)break;if(0<n.terrain.getPassableSpeed(u,a.SpeedType.Float,!1)){l=u;break}}}return l}findRallyNodeForUnit(e,t){if(this.rallyPoint){var i=this.findRallyPointforUnit(e,this.rallyPoint,t,!0);return{tile:i,onBridge:e.rules.naval?void 0:t.tileOccupation.getBridgeOnTile(i)}}}findRallyPointforUnit(e,t,i,s,a){let o=e.rules.naval?void 0:i.tileOccupation.getBridgeOnTile(t),l=e.rules.movementZone===n.MovementZone.Fly,c=new r.RadialTileFinder(i.tiles,i.mapBounds,t,{width:1,height:1},0,5,(t=>{var r=!o||o.isHighBridge()?i.tileOccupation.getBridgeOnTile(t):void 0;return!(l?[]:i.terrain.findObstacles({tile:t,onBridge:r},e)).length&&(void 0===a||Math.abs(a-(t.z+(r?.tileElevation??0)))<4)&&(!s||!i.getObjectsOnTile(t).find((e=>e.isBuilding()&&!e.isDestroyed)))&&(l||0<i.terrain.getPassableSpeed(t,e.rules.speedType,!!r))}));return c.getNextTile()??t}})}}})),System.register("game/gameobject/unit/Timer",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Timer",class{constructor(){this.activeTicks=0}isActive(){return 0<this.activeTicks}setActiveFor(e,t){this.activeTicks=e,this.activeFor=e,this.activeSince=t}reset(){this.activeTicks=0,this.activeSince=void 0,this.activeFor=void 0}getTicksLeft(){return this.activeTicks}getInitialTicks(){return this.activeFor??0}tick(e){return 0<this.activeTicks&&(this.activeTicks--,this.activeTicks<=0||void 0!==this.activeSince&&e-this.activeSince>this.activeFor)&&(this.reset(),!0)}})}}})),System.register("game/gameobject/trait/C4ChargeTrait",["game/gameobject/common/DeathType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{constructor(){this.timer=new r.Timer}hasCharge(){return this.timer.isActive()}setCharge(e,t){this.hasCharge()||(this.timer.setActiveFor(e),this.attackerInfo=t)}[s.NotifyTick.onTick](e,t){this.timer.isActive()&&!0===this.timer.tick(t.currentTick)&&(e.invulnerableTrait.isActive()||(e.isBuilding()&&e.cabHutTrait?e.cabHutTrait.demolishBridge(t,this.attackerInfo):(e.deathType=i.DeathType.Demolish,t.destroyObject(e,this.attackerInfo,!0))))}},e("C4ChargeTrait",n)}}})),System.register("game/gameobject/trait/HelipadTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifyUnspawn"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{[r.NotifyOwnerChange.onChange](e,t,i){this.checkAircraftsForPlayer(t,i)}[s.NotifyUnspawn.onUnspawn](e,t){this.checkAircraftsForPlayer(e.owner,t)}checkAircraftsForPlayer(e,t){let r=t.rules.general.padAircraft;var s;for(s of e.getOwnedObjectsByType(i.ObjectType.Aircraft).filter((e=>r.includes(e.name))))s.airportBoundTrait&&(s.airportBoundTrait.preferredAirport=void 0)}},e("HelipadTrait",n)}}})),System.register("game/gameobject/trait/AmmoTrait",["util/math"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("AmmoTrait",class{constructor(e,t=e){this.maxAmmo=e,this.ammo=t}get ammo(){return this._ammo}set ammo(e){this._ammo=i.clamp(e,0,this.maxAmmo)}isFull(){return this.ammo===this.maxAmmo}})}}})),System.register("game/gameobject/trait/UnitReloadTrait",["game/GameSpeed","game/gameobject/unit/ZoneType","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{[s.NotifyTick.onTick](e,t){if(e.dockTrait&&e.dockTrait.hasDockedUnits()&&!e.dockTrait.getDockedUnits().every((e=>!this.canReloadUnit(e))))if(void 0===this.cooldownTicks&&(this.cooldownTicks=i.GameSpeed.BASE_TICKS_PER_SECOND*t.rules.general.repair.reloadRate*60),this.cooldownTicks<=0){this.cooldownTicks=i.GameSpeed.BASE_TICKS_PER_SECOND*t.rules.general.repair.reloadRate*60;let s=e.dockTrait.getDockedUnits();var r;for(r of 0===s[0].ammo?s.slice(0,1):s)this.canReloadUnit(r)&&r.ammoTrait.ammo++}else this.cooldownTicks--}canReloadUnit(e){return!(!e.ammoTrait||!e.rules.manualReload||e.ammoTrait.isFull()||e.zone===r.ZoneType.Air)}},e("UnitReloadTrait",n)}}})),System.register("game/gameobject/task/WaitForBuildUpTask",["game/gameobject/Building","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/task/system/WaitMinutesTask"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends s.TaskGroup{constructor(e){super(new n.WaitMinutesTask(e),new r.CallbackTask((e=>e.buildStatus=i.BuildStatus.Ready))),this.cancellable=!1}},e("WaitForBuildUpTask",a)}}})),System.register("game/gameobject/trait/SuperWeaponTrait",["engine/type/ObjectType","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class{constructor(e){this.name=e}getSuperWeapon(e){return e.owner.superWeaponsTrait?.get(this.name)}[s.NotifySpawn.onSpawn](e,t){this.addSuperWeaponToPlayerIfNeeded(e.owner,t)}[n.NotifyUnspawn.onUnspawn](e,t){this.removeSuperWeaponFromPlayerIfNeeded(e.owner)}[r.NotifyOwnerChange.onChange](e,t,i){this.removeSuperWeaponFromPlayerIfNeeded(t),this.addSuperWeaponToPlayerIfNeeded(e.owner,i)}addSuperWeaponToPlayerIfNeeded(e,t){if(e.superWeaponsTrait&&!e.superWeaponsTrait.has(this.name)){let i=t.createSuperWeapon(this.name,e);e.superWeaponsTrait.add(i),i.rules.isPowered&&e.powerTrait?.isLowPower()&&i.pauseTimer()}}removeSuperWeaponFromPlayerIfNeeded(e){let t=e.superWeaponsTrait;var r;t&&(e.getOwnedObjectsByType(i.ObjectType.Building).some((e=>e.superWeaponTrait?.name===this.name))||(r=t.get(this.name))&&!r.isGift&&t.remove(this.name))}},e("SuperWeaponTrait",a)}}})),System.register("game/map/MapShroud",["util/event","game/GameSpeed","engine/type/TerrainType","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){var t;5,4.25,o=(1<<(a=3))-1,(t=l=l||{})[t.Unexplored=0]="Unexplored",t[t.TemporaryReveal=1]="TemporaryReveal",t[t.Explored=2]="Explored",e("ShroudType",l),(c=c||{})[c.Darken=1<<a]="Darken",e("ShroudFlag",c),e("MapShroud",class e{constructor(){this.invalidations=new Map,this.temporaryReveals=new Map,this.fullInvalidation=!1,this._onChange=new i.EventDispatcher}get onChange(){return this._onChange.asEvent()}fromTiles(e){var t,i=e.getMapSize(),r=e.getMaxTileHeight();r=this.padding=(r+r%2)/2;for(t of(this.size={width:i.width+r,height:i.height+r},this.tiles=new Uint8Array(this.size.width*this.size.height),this.tiles.fill(l.Unexplored),this.tileElevation=new Uint8Array(this.size.width*this.size.height),e.getAll())){var n=this.getTileIndex(t);this.tileElevation[n]=Math.max(this.tileElevation[n],t.terrainType===s.TerrainType.Cliff&&0<t.z?t.z-1:t.z)}return this}getSize(){return this.size}getTileIndex(e){var{sx:t,sy:i}=this.rxyzToSxy(e.rx,e.ry,e.z);return t+i*this.size.width}rxyzToSxy(e,t,i){var r=(i|=0)+i%2;return{sx:e-r/2+this.padding,sy:t-r/2+this.padding}}sxyzToRxy(e,t,i){return{rx:e+Math.ceil(i/2)-this.padding,ry:t+Math.ceil(i/2)-this.padding}}shroudCoordsToWorld({sx:e,sy:t}){return this.sxyzToRxy(e,t,0)}findTilesAtShroudCoords({sx:e,sy:t},i){var r=i.getMaxTileHeight(),s=r+r%2;let n=[];for(let r=0;r<=s;r+=2){var a=r+r%2,{rx:o,ry:a}=this.sxyzToRxy(e,t,a);a=i.getByMapCoords(o,a);a?.z===r&&n.push(a)}return n}clone(){let t=new e;return t.tiles=this.tiles.slice(),t.size=this.size,t.padding=this.padding,t.tileElevation=this.tileElevation,t}copy(e){this.tiles=e.tiles.slice(),this.size=e.size,this.padding=e.padding,this.tileElevation=e.tileElevation}merge(e){if(this.size.width!==e.size.width||this.size.height!==e.size.height)throw new Error("Size mismatch");var t=e.tiles;for(let e=0,i=this.tiles.length;e<i;e++)this.tiles[e]=Math.max(t[e]&o,this.tiles[e]&o)|(t[e]|this.tiles[e])>>a<<a}isShrouded(e,t=0){var i=this.rxyzToSxy(e.rx,e.ry,e.z+t);return this.getShroudTypeByShroudCoords(i)===l.Unexplored}getShroudType(e){return this.tiles[this.getTileIndex(e)]&o}isFlagged(e,t){return 0!=(this.tiles[this.getTileIndex(e)]&t)}getShroudTypeByTileCoords(e,t,i){return this.getShroudTypeByShroudCoords(this.rxyzToSxy(e,t,i))}getShroudTypeByShroudCoords({sx:e,sy:t}){return e<0||t<0||e>=this.size.width||t>=this.size.height?l.Unexplored:this.tiles[e+t*this.size.width]&o??l.Unexplored}invalidateFull(){this.fullInvalidation=!0}invalidate(e,t,i){var r=e.sx+e.sy*this.size.width;let s=this.invalidations.get(r);s||(s={center:e,elevation:0,radius:0},this.invalidations.set(r,s)),s.elevation=Math.max(s.elevation,t),s.radius=Math.max(s.radius,i)}revealFrom(e){var t,i,r=e.sight;r&&(t=e.tile.z+e.tileElevation,i=this.rxyzToSxy(e.tile.rx,e.tile.ry,t),this.invalidate(i,t,r))}revealAround(e,t){var i=this.rxyzToSxy(e.rx,e.ry,e.z);this.invalidate(i,Number.POSITIVE_INFINITY,t)}unrevealAround(e,t){var i=[],r=this.rxyzToSxy(e.rx,e.ry,e.z);this.setValueAround(r,t,Number.POSITIVE_INFINITY,i,l.Unexplored,l.Explored),this._onChange.dispatch(this,{type:"incremental",coords:i})}revealTemporarily(e){var t=this.rxyzToSxy(e.tile.rx,e.tile.ry,e.tile.z+e.tileElevation);this.temporaryReveals.set(t,5*r.GameSpeed.BASE_TICKS_PER_SECOND)}revealObject(e){var t=this.rxyzToSxy(e.tile.rx,e.tile.ry,e.tile.z+e.tileElevation);this.invalidate(t,Number.POSITIVE_INFINITY,4.25)}toggleFlagsAround(e,t,i,r){var s=[],n=this.rxyzToSxy(e.rx,e.ry,e.z);this.setValueAround(n,t,Number.POSITIVE_INFINITY,s,void 0,void 0,r?{setFlags:i}:{clearFlags:i}),this._onChange.dispatch(this,{type:"incremental",coords:s})}update(){let e=[];if(this.invalidations.size){for(var t of this.invalidations.values())this.setValueAround(t.center,t.radius,t.elevation,e,l.Explored,[l.Unexplored,l.TemporaryReveal]);this.invalidations.clear()}this.temporaryReveals.size&&this.temporaryReveals.forEach(((t,i)=>{t<=0?(this.setValueAround(i,3,Number.POSITIVE_INFINITY,e,l.Unexplored,l.TemporaryReveal),this.temporaryReveals.delete(i)):(t===5*r.GameSpeed.BASE_TICKS_PER_SECOND&&this.setValueAround(i,3,Number.POSITIVE_INFINITY,e,l.TemporaryReveal,l.Unexplored),this.temporaryReveals.set(i,t-1))})),this.fullInvalidation?(this.fullInvalidation=!1,this._onChange.dispatch(this,{type:"full"})):e.length&&this._onChange.dispatch(this,{type:"incremental",coords:e})}setValueAround(e,t,i,r,s,l=void 0,{setFlags:c,clearFlags:h}={}){var u=Math.ceil(t),d=n.clamp(e.sx-u,0,this.size.width-1),g=n.clamp(e.sx+u,0,this.size.width-1),p=n.clamp(e.sy-u,0,this.size.height-1),m=n.clamp(e.sy+u,0,this.size.height-1),f=this.size.width;for(let n=d;n<=g;n++)for(let u=p;u<=m;u++){var y=n+u*f,T=this.tiles[y]&o,v=this.tiles[y]>>a<<a;let d=v;void 0!==c&&(d|=c),void 0!==h&&(d&=~h),void 0!==l&&("number"!=typeof l?!l.includes(T):l!==T)||(n-e.sx)*(n-e.sx)+(u-e.sy)*(u-e.sy)>t*t+1||this.tileElevation[y]>=i+4||(this.tiles[y]=(s??T)|d,T===s&&v===d||r.push({sx:n,sy:u}))}}revealAll(){this.tiles.fill(l.Explored),this._onChange.dispatch(this,{type:"clear"})}reset(){this.tiles.fill(l.Unexplored),this._onChange.dispatch(this,{type:"cover"})}})}}})),System.register("game/gameobject/trait/GapGeneratorTrait",["game/GameSpeed","game/map/MapShroud","game/math/Box2","game/math/Vector2","game/rules/TechnoRules","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class{constructor(e){this.radiusTiles=e,this.refreshTicks=0}[h.NotifyTick.onTick](e,t){0<this.refreshTicks&&this.refreshTicks--,this.refreshTicks<=0&&this.update(e,t)}[c.NotifySpawn.onSpawn](e,t){this.markGapTilesForFriendlies(e,e.owner,t,!0)}[u.NotifyUnspawn.onUnspawn](e,t){this.markGapTilesForFriendlies(e,e.owner,t,!1),this.update(e,t)}[l.NotifyOwnerChange.onChange](e,t,i){this.markGapTilesForFriendlies(e,t,i,!1),this.markGapTilesForFriendlies(e,e.owner,i,!0),this.update(e,i)}[d.NotifyWarpChange.onChange](e,t,i){this.markGapTilesForFriendlies(e,e.owner,t,!i),i&&this.update(e,t)}markGapTilesForFriendlies(e,t,i,s){let n,a=[t,...i.alliances.getAllies(t)];for(var l of a){let t=i.mapShroudTrait.getPlayerShroud(l);if(t&&(t.toggleFlagsAround(e.tile,this.radiusTiles,r.ShroudFlag.Darken,s),!s)){if(!n){let t=new o.RangeHelper(i.map.tileOccupation);n=a.map((e=>[...e.buildings])).flat().filter((i=>i.gapGeneratorTrait&&i!==e&&t.tileDistance(i,e)<=i.gapGeneratorTrait.radiusTiles+this.radiusTiles))}for(var c of n)t.toggleFlagsAround(c.tile,c.gapGeneratorTrait.radiusTiles,r.ShroudFlag.Darken,!0)}}}update(e,t){let r;this.refreshTicks=5*i.GameSpeed.BASE_TICKS_PER_SECOND;var o,l,c,h,u=e.owner.buildings.has(e)&&e.poweredTrait?.isPoweredOn();for(o of t.getCombatants())if(o!==e.owner&&!t.alliances.areAllied(e.owner,o)){let i=t.mapShroudTrait.getPlayerShroud(o);if(i)if(u)for(h of(i.unrevealAround(e.tile,this.radiusTiles),r||(c=this.radiusTiles+a.TechnoRules.MAX_SIGHT,l=new n.Vector2(e.tile.rx,e.tile.ry).addScalar(-c),c=new n.Vector2(e.tile.rx,e.tile.ry).addScalar(c),r=t.map.technosByTile.queryRange(new s.Box2(l,c))),r))h.owner===o||t.alliances.areAllied(h.owner,o)?i.revealFrom(h):h.rules.revealToAll&&i.revealObject(h);else[...o.buildings].some((e=>e.rules.spySat))&&i.revealAround(e.tile,this.radiusTiles)}}},e("GapGeneratorTrait",g)}}})),System.register("game/gameobject/trait/PsychicDetectorTrait",["game/Coords","game/GameSpeed","game/gameobject/unit/RangeHelper","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyWarpChange"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=r.GameSpeed.BASE_TICKS_PER_SECOND,l=class{constructor(e){this.radiusTiles=e,this.detectionLines=[],this.nextScan=o}[n.NotifyTick.onTick](e,t){e.owner.powerTrait?.isLowPower()?this.disable():(0<this.nextScan&&this.nextScan--,this.nextScan<=0&&(this.nextScan=o,this.detectionLines=this.scan(e,t)))}[a.NotifyWarpChange.onChange](e,t,i){i&&this.disable()}disable(){this.detectionLines.length&&(this.detectionLines=[],this.nextScan=0)}scan(e,t){var r=t.getCombatants().filter((i=>i!==e.owner&&!t.alliances.areAllied(i,e.owner)));let n=[],a=new s.RangeHelper(t.map.tileOccupation);var o,l,c,h=t=>a.distance2(t,e)/i.Coords.LEPTONS_PER_TILE<=this.radiusTiles;for(o of r)for(var u of o.getOwnedObjects())u.attackTrait?.currentTarget?h((l=u.attackTrait.currentTarget).obj??l.tile)&&n.push({source:u,target:l}):u.isUnit()&&u.unitOrderTrait.targetLinesConfig&&((c=u.unitOrderTrait.targetLinesConfig).target?h(c.target)&&(l=t.createTarget(c.target,c.target.tile),n.push({source:u,target:l})):(c=c.pathNodes[0])&&h(c.tile)&&(c=t.createTarget(c.onBridge,c.tile),n.push({source:u,target:c})));return n}},e("PsychicDetectorTrait",l)}}})),System.register("game/gameobject/trait/HospitalTrait",["engine/type/ObjectType","game/event/UnitRepairFinishEvent","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/gameobject/task/ScatterTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class{constructor(){this.healQueue=[]}addToHealQueue(e){return this.healQueue.push(e),this.healQueue.length-1}unitIsFirstInHealQueue(e){return this.healQueue[0]===e}removeFromHealQueue(e){var t=this.healQueue.indexOf(e);-1!==t&&this.healQueue.splice(t,1)}startHealing(e){if(this.unit)throw new Error(`Already busy healing unit ${i.ObjectType[this.unit.type]}#${this.unit.id}}`);this.unit=e,this.healTicks=5*s.GameSpeed.BASE_TICKS_PER_SECOND}[l.NotifyTick.onTick](e,t){var i;this.healQueue=this.healQueue.filter((e=>!e.isDestroyed&&!e.isCrashing)),this.unit&&void 0!==this.healTicks&&(0<this.healTicks&&this.healTicks--,this.healTicks<=0&&(this.healTicks=void 0,this.removeFromHealQueue(this.unit),this.unit.healthTrait.healToFull(e,t),e.ammoTrait&&e.ammoTrait.ammo--,this.evacuate(this.unit,e,t),i=this.unit,this.unit=void 0,t.events.dispatch(new r.UnitRepairFinishEvent(i,e))))}[o.NotifyDestroy.onDestroy](e,t,i){this.unit&&(t.destroyObject(this.unit,i,!0),this.unit=void 0)}evacuate(e,t,i){let r;var s={x:t.tile.rx,y:t.tile.ry+t.art.foundation.height};(s=i.map.tiles.getByMapCoords(s.x,s.y))&&i.map.isWithinBounds(s)&&this.canEvacuateTo(s,e,t,i)&&(r=s),r=r||new n.RadialTileFinder(i.map.tiles,i.map.mapBounds,t.tile,t.art.foundation,1,1,(r=>this.canEvacuateTo(r,e,t,i))).getNextTile(),r?(i.unlimboObject(e,r),e.unitOrderTrait.addTask(new a.ScatterTask(i))):i.destroyObject(e,{player:e.owner})}canEvacuateTo(e,t,i,r){return 0<r.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&Math.abs(e.z-i.tile.z)<2&&!r.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length}},e("HospitalTrait",c)}}})),System.register("game/gameobject/Building",["engine/type/ObjectType","game/gameobject/trait/GarrisonTrait","game/gameobject/trait/TurretTrait","game/rules/TechnoRules","game/event/BuildStatusChangeEvent","game/gameobject/trait/PoweredTrait","game/gameobject/trait/FactoryTrait","game/gameobject/trait/DockTrait","game/gameobject/trait/FreeUnitTrait","game/gameobject/Techno","game/gameobject/trait/CrewedTrait","game/gameobject/trait/CabHutTrait","game/gameobject/trait/OilDerrickTrait","game/gameobject/trait/WallTrait","game/Coords","game/gameobject/trait/OverpoweredTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/trait/RallyTrait","game/gameobject/trait/C4ChargeTrait","game/gameobject/trait/HelipadTrait","game/gameobject/trait/UnitReloadTrait","game/gameobject/task/WaitForBuildUpTask","game/gameobject/trait/SuperWeaponTrait","game/gameobject/trait/GapGeneratorTrait","game/gameobject/trait/PsychicDetectorTrait","game/gameobject/trait/HospitalTrait","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e}],execute:function(){var t;(t=R=R||{})[t.BuildUp=0]="BuildUp",t[t.Ready=1]="Ready",t[t.BuildDown=2]="BuildDown",e("BuildStatus",R),P=class extends u.Techno{constructor(e,t,r){super(i.ObjectType.Building,e,t,r),this.showWeaponRange=!1,this.wallType=[0,0,0,0],this.direction=0,this.buildStatus=R.BuildUp,this.lastBuildStatus=this.buildStatus}static factory(e,t,i,a,u,f){let C=new this(e,t,a);return t.canBeOccupied&&(C.garrisonTrait=new r.GarrisonTrait(C,i.audioVisual.conditionRed,t.maxNumberOccupants),C.traits.add(C.garrisonTrait)),t.canC4&&!t.wall&&(C.c4ChargeTrait=new b.C4ChargeTrait,C.traits.add(C.c4ChargeTrait)),t.bridgeRepairHut&&(C.cabHutTrait=new g.CabHutTrait(C,f),C.traits.add(C.cabHutTrait)),t.crewed&&(C.crewedTrait=new d.CrewedTrait,C.traits.add(C.crewedTrait)),t.turret&&(C.turretTrait=new s.TurretTrait,C.traits.add(C.turretTrait)),t.overpowerable&&(C.overpoweredTrait=new y.OverpoweredTrait(C),C.traits.add(C.overpoweredTrait)),(t.powered&&0!==t.power||t.needsEngineer)&&(C.poweredTrait=new o.PoweredTrait(C),C.traits.add(C.poweredTrait)),(t.factory||t.cloning)&&(C.factoryTrait=new l.FactoryTrait(t.cloning?n.FactoryType.InfantryType:t.factory,t.cloning),C.traits.add(C.factoryTrait)),t.superWeapon&&(C.superWeaponTrait=new E.SuperWeaponTrait(t.superWeapon),C.traits.add(C.superWeaponTrait)),t.numberOfDocks&&(C.dockTrait=new c.DockTrait(C,u,t.numberOfDocks,a.dockingOffsets),C.traits.add(C.dockTrait),t.helipad&&(C.helipadTrait=new S.HelipadTrait,C.traits.add(C.helipadTrait)),(t.unitRepair||t.unitReload)&&(C.unitRepairTrait=new T.UnitRepairTrait,C.traits.add(C.unitRepairTrait)),t.unitReload&&(C.unitReloadTrait=new w.UnitReloadTrait,C.traits.add(C.unitReloadTrait))),t.hospital&&(C.hospitalTrait=new A.HospitalTrait,C.traits.add(C.hospitalTrait)),(t.factory||t.cloning||t.numberOfDocks)&&(C.rallyTrait=new v.RallyTrait,C.traits.add(C.rallyTrait)),t.freeUnit&&C.traits.add(new h.FreeUnitTrait),t.produceCashStartup&&C.traits.add(new p.OilDerrickTrait),t.wall&&(C.wallTrait=new m.WallTrait,C.traits.add(C.wallTrait)),t.gapGenerator&&(C.gapGeneratorTrait=new x.GapGeneratorTrait(t.gapRadiusInCells),C.traits.add(C.gapGeneratorTrait)),t.psychicDetectionRadius&&(C.psychicDetectorTrait=new O.PsychicDetectorTrait(t.psychicDetectionRadius),C.traits.add(C.psychicDetectorTrait)),C}isBuilding(){return!0}getFoundation(){return this.art.foundation}getFoundationCenterOffset(){var e=this.getFoundation();return new M.Vector2(e.width/2*f.Coords.LEPTONS_PER_TILE,e.height/2*f.Coords.LEPTONS_PER_TILE)}update(e){this.buildStatus!==R.BuildUp||this.unitOrderTrait.hasTasks()||this.unitOrderTrait.addTask(new C.WaitForBuildUpTask(e.rules.general.buildupTime)),this.buildStatus!==this.lastBuildStatus&&(this.lastBuildStatus=this.buildStatus,e.events.dispatch(new a.BuildStatusChangeEvent(this,this.buildStatus))),this.attackTrait?.setDisabled(this.buildStatus!==R.Ready||!!this.poweredTrait&&!this.poweredTrait.isPoweredOn()),super.update(e)}},e("Building",P)}}})),System.register("util/disposable/Disposable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/Traits",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Traits",class{constructor(){this.allTraits=[],this.traitsByTypeCache=new Map}add(e){this.allTraits.push(e),this.traitsByTypeCache.clear()}addToFront(e){this.allTraits.unshift(e),this.traitsByTypeCache.clear()}remove(e){var t=this.allTraits.indexOf(e);-1!==t&&(this.allTraits.splice(t,1),this.traitsByTypeCache.clear())}filter(e){let t=this.traitsByTypeCache.get(e);return t||(t="function"==typeof e?this.allTraits.filter((t=>t instanceof e)):this.allTraits.filter((t=>this.traitImplements(t,e))),this.traitsByTypeCache.set(e,t)),t}get(e){var t=this.find(e);if(!t)throw new Error("No matching trait found");return t}find(e){return this.filter(e)[0]}getAll(){return this.allTraits}traitImplements(e,t){for(var i of Object.getOwnPropertyNames(t))if(void 0===e[t[i]])return!1;return!0}clear(){this.allTraits.length=0,this.traitsByTypeCache.clear()}dispose(){this.getAll().forEach((e=>e.dispose?.())),this.clear()}})}}})),System.register("game/player/trait/RadarTrait",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RadarTrait",class{constructor(){this.disabled=!0,this.activeEvents=[]}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}})}}})),System.register("game/player/production/Production",["game/player/production/ProductionQueue","game/rules/TechnoRules","engine/type/ObjectType","util/event","game/rules/GeneralRules","game/SideType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=(new Map).set("POWER",a.PrereqCategory.Power).set("FACTORY",a.PrereqCategory.Factory).set("BARRACKS",a.PrereqCategory.Barracks).set("RADAR",a.PrereqCategory.Radar).set("TECH",a.PrereqCategory.Tech).set("PROC",a.PrereqCategory.Proc),e("Production",class e{constructor(e,t,i,r,s){this.player=e,this.maxTechLevel=t,this.gameOpts=i,this.rules=r,this.allAvailableObjects=s,this.buildSpeedModifier=1,this.queues=new Map,this._onQueueUpdate=new n.EventDispatcher,this.primaryFactories=new Map,this.factoryCounts=new Map,this.veteranTypes=new Set,this.stolenTech=new Set}static factory(t,r,s,n){let a=new e(t,r.mpDialogSettings.techLevel,s,r,n);var o=r.general.maximumQueuedObjects+1;return a.addQueue(i.QueueType.Structures,new i.ProductionQueue(i.QueueType.Structures,1,1)),a.addQueue(i.QueueType.Armory,new i.ProductionQueue(i.QueueType.Armory,1,1)),a.addQueue(i.QueueType.Infantry,new i.ProductionQueue(i.QueueType.Infantry,o,o)),a.addQueue(i.QueueType.Vehicles,new i.ProductionQueue(i.QueueType.Vehicles,o,o)),a.addQueue(i.QueueType.Ships,new i.ProductionQueue(i.QueueType.Ships,o,o)),a.addQueue(i.QueueType.Aircrafts,new i.ProductionQueue(i.QueueType.Aircrafts,0,o)),a}get onQueueUpdate(){return this._onQueueUpdate.asEvent()}addQueue(e,t){this.queues.set(e,t),t.onUpdate.subscribe((()=>this._onQueueUpdate.dispatch(this,t)))}getQueue(e){var t=this.queues.get(e);if(!t)throw new Error("No queue found with type "+i.QueueType[e]);return t}getAllQueues(){return[...this.queues.values()]}getQueueTypeForObject(e){if(e.type===s.ObjectType.Building)return e.buildCat===r.BuildCat.Combat?i.QueueType.Armory:i.QueueType.Structures;if(e.type===s.ObjectType.Infantry)return i.QueueType.Infantry;if(e.type===s.ObjectType.Vehicle)return e.naval?i.QueueType.Ships:i.QueueType.Vehicles;if(e.type===s.ObjectType.Aircraft)return i.QueueType.Aircrafts;throw new Error("Unsupported object type "+s.ObjectType[e.type])}getQueueForObject(e){return this.getQueue(this.getQueueTypeForObject(e))}getQueueTypeForFactory(e){if(e===r.FactoryType.InfantryType)return i.QueueType.Infantry;if(e===r.FactoryType.UnitType)return i.QueueType.Vehicles;if(e===r.FactoryType.AircraftType)return i.QueueType.Aircrafts;if(e===r.FactoryType.NavalUnitType)return i.QueueType.Ships;throw new Error("Unsupported factory type "+r.FactoryType[e])}getFactoryTypeForQueueType(e){if(e===i.QueueType.Structures||e===i.QueueType.Armory)return r.FactoryType.BuildingType;if(e===i.QueueType.Infantry)return r.FactoryType.InfantryType;if(e===i.QueueType.Vehicles)return r.FactoryType.UnitType;if(e===i.QueueType.Aircrafts)return r.FactoryType.AircraftType;if(e===i.QueueType.Ships)return r.FactoryType.NavalUnitType;throw new Error("Unsupported queue type "+i.QueueType[e])}getQueueForFactory(e){return this.getQueue(this.getQueueTypeForFactory(e))}isAvailableForProduction(e){return e.isAvailableTo(this.player.country)&&-1!==e.techLevel&&e.techLevel<=this.maxTechLevel&&!(0===e.buildLimit&&!this.player.isAi)&&!(e.superWeapon&&this.rules.getSuperWeapon(e.superWeapon).disableableFromShell&&!this.gameOpts.superWeapons)&&this.hasFactoryFor(e)&&this.meetsPrerequisites(e)&&this.meetsStolenTech(e)}getAvailableObjects(){return this.allAvailableObjects.filter((e=>this.isAvailableForProduction(e)))}hasFactoryFor(e){if(e.owner.length){let t=this.getFactoryTypeFor(e);return!![...this.player.buildings].find((i=>i.factoryTrait?.type===t&&(t!==r.FactoryType.UnitType||i.rules.naval===e.naval)&&!!i.rules.owner.find((t=>e.owner.includes(t)))))}return!0}meetsStolenTech(e){return e.requiresStolenAlliedTech?this.stolenTech.has(o.SideType.GDI):!e.requiresStolenSovietTech||this.stolenTech.has(o.SideType.Nod)}getFactoryTypeFor(e){return e.type===s.ObjectType.Building?r.FactoryType.BuildingType:e.type===s.ObjectType.Infantry?r.FactoryType.InfantryType:e.type===s.ObjectType.Aircraft?r.FactoryType.AircraftType:e.naval?r.FactoryType.NavalUnitType:r.FactoryType.UnitType}meetsPrerequisites(e){let t=[...this.player.buildings].map((e=>e.name));var i;for(i of e.prerequisite)if(i=i.toUpperCase(),l.has(i)){var r=l.get(i);if(void 0===r)throw new Error("Unknown prereqName "+i);var s,n=this.rules.general.prereqCategories.get(r);if(void 0===n)throw new Error(`Missing prerequisite category ${r} in rules`);let e=!1;for(s of n)if(-1!==t.indexOf(s)){e=!0;break}if(!e)return!1}else if(-1===t.indexOf(i))return!1;return!0}getPrimaryFactory(e){return this.primaryFactories.get(e)}setPrimaryFactory(e){e.rules.factory&&this.primaryFactories.set(e.rules.factory,e)}isPrimaryFactory(e){return this.getPrimaryFactory(e.rules.factory)===e}incrementFactoryCount(e){this.factoryCounts.set(e,(this.factoryCounts.get(e)??0)+1)}decrementFactoryCount(e){if(!this.factoryCounts.get(e))throw new Error(`Can't decrement factory count ${r.FactoryType[e]}. Already 0`);this.factoryCounts.set(e,this.factoryCounts.get(e)-1)}getFactoryCount(e){return this.factoryCounts.get(e)??0}crownPrimaryFactoryHeir(e){var t=[...this.player.buildings].find((t=>t.rules.factory===e));t?this.primaryFactories.set(e,t):this.primaryFactories.delete(e)}hasAnyFactory(){return 0<this.primaryFactories.size}addVeteranType(e){this.veteranTypes.add(e)}hasVeteranType(e){return this.veteranTypes.has(e)}addStolenTech(e){this.stolenTech.add(e)}dispose(){this.queues.clear(),this.player=void 0}})}}})),System.register("game/event/SuperWeaponReadyEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SuperWeaponReadyEvent",class{constructor(e){this.target=e,this.type=i.EventType.SuperWeaponReady}})}}})),System.register("game/SuperWeapon",["game/event/SuperWeaponReadyEvent","game/GameSpeed"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.Charging=0]="Charging",t[t.Paused=1]="Paused",t[t.Ready=2]="Ready",e("SuperWeaponStatus",s),e("SuperWeapon",class{constructor(e,t,i,n=!1){this.name=e,this.rules=t,this.owner=i,this.oneTimeOnly=n,this.status=s.Charging,this.isGift=!1,this.rechargeTicks=60*t.rechargeTime*r.GameSpeed.BASE_TICKS_PER_SECOND,this.chargeTicks=this.rechargeTicks,n&&(this.status=s.Ready,this.chargeTicks=0)}update(e){0<this.chargeTicks&&this.status!==s.Paused&&(this.chargeTicks--,0===this.chargeTicks&&(this.status=s.Ready,e.events.dispatch(new i.SuperWeaponReadyEvent(this))))}pauseTimer(){this.status=s.Paused}resumeTimer(){this.status=0<this.chargeTicks?s.Charging:s.Ready}resetTimer(){this.chargeTicks=this.rechargeTicks,this.status===s.Ready&&(this.status=s.Charging)}getTimerSeconds(){return this.chargeTicks/r.GameSpeed.BASE_TICKS_PER_SECOND}getChargeProgress(){return(this.rechargeTicks-this.chargeTicks)/this.rechargeTicks}})}}})),System.register("game/player/trait/SuperWeaponsTrait",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SuperWeaponsTrait",class{constructor(){this.superWeapons=new Map}getAll(){return[...this.superWeapons.values()]}add(e){this.superWeapons.set(e.name,e)}has(e){return this.superWeapons.has(e)}get(e){return this.superWeapons.get(e)}remove(e){this.superWeapons.delete(e)}})}}})),System.register("game/player/trait/SharedDetectDisguiseTrait",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SharedDetectDisguiseTrait",class{constructor(){this.objects=new Set}add(e){this.objects.add(e)}delete(e){this.objects.delete(e)}has(e){return this.objects.has(e)}dispose(){this.objects.clear()}})}}})),System.register("game/Player",["util/Color","engine/type/ObjectType","game/Traits","util/math"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("Player",class{constructor(e,t=void 0,r=0,n=new i.Color(255,0,0)){this.name=e,this.country=t,this.startLocation=r,this.color=n,this.isAi=!1,this.defeated=!1,this.resigned=!1,this.dropped=!1,this.objectsByType=new Map,this.objectsById=new Map,this.traits=new s.Traits,this._credits=0,this.score=0,this.unitsBuiltByType=new Map,this.unitsKilledByType=new Map,this.unitsLostByType=new Map,this.buildingsCaptured=0,this.cratesPickedUp=0,this.cheerCooldownTicks=0,this.isObserver=!t,this.isNeutral=!!t&&!t.isPlayable()}get credits(){return this._credits}set credits(e){if(e<0)throw new RangeError("Can't set credits to a negative value");this._credits=e}getOrCreateObjectsForType(e){let t=this.objectsByType.get(e);return t||(t=new Set,this.objectsByType.set(e,t)),t}addOwnedObject(e){this.getOrCreateObjectsForType(e.type).add(e),(e.owner=this).objectsById.set(e.id,e)}removeOwnedObject(e){let t=this.objectsByType.get(e.type);if(!t||!t.has(e))throw new Error(`GameObject ${e.name} does not belong to player `+this.name);t.delete(e),this.objectsById.delete(e.id)}getOwnedObjectById(e){return this.objectsById.get(e)}getOwnedObjectsByType(e,t=!1){let i=[];return i=[...this.objectsByType.get(e)||new Set],t||(i=i.filter((e=>!e.limboData))),i}getOwnedObjects(e=!1){let t=[];return[...this.objectsByType.values()].forEach((e=>{e.forEach((e=>t.push(e)))})),e||(t=t.filter((e=>!e.limboData))),t}removeAllOwnedObjects(){this.objectsByType.forEach((e=>e.clear())),this.objectsById.clear()}get buildings(){return this.getOrCreateObjectsForType(r.ObjectType.Building)}addUnitsBuilt(e,t){this.unitsBuiltByType.set(e,(this.unitsBuiltByType.get(e)??0)+t)}getUnitsBuilt(e){return void 0!==e?this.unitsBuiltByType.get(e)??0:[...this.unitsBuiltByType.values()].reduce(((e,t)=>e+t),0)}addUnitsKilled(e,t){this.unitsKilledByType.set(e,(this.unitsKilledByType.get(e)??0)+t)}getUnitsKilled(e){return void 0!==e?this.unitsKilledByType.get(e)??0:[...this.unitsKilledByType.values()].reduce(((e,t)=>e+t),0)}addUnitsLost(e,t){this.unitsLostByType.set(e,(this.unitsLostByType.get(e)??0)+t)}getUnitsLost(e){return void 0!==e?this.unitsLostByType.get(e)??0:[...this.unitsLostByType.values()].reduce(((e,t)=>e+t),0)}isCombatant(){return!this.isNeutral&&!this.isObserver&&!this.defeated}canProduceVeteran(e){if(!this.production||!this.country)throw new Error("Non-combatants can't produce units");var t=this.production.getQueueTypeForObject(e);t=this.production.getFactoryTypeForQueueType(t);return this.production.hasVeteranType(t)||this.country.hasVeteranUnit(e.type,e.name)}getHash(){return n.fnv32a([this.credits,...this.traits.getAll().map((e=>e.getHash?.()??0))])}debugGetState(){return{name:this.name,credits:this.credits,traits:this.traits.getAll().reduce(((e,t)=>{var i=t.debugGetState?.();return void 0!==i&&(e[t.constructor.name]=i),e}),{})}}dispose(){this.traits.dispose(),this.production?.dispose()}})}}})),System.register("game/art/Art",["game/art/ObjectArt","engine/type/ObjectType","game/rules/ObjectRules","data/IniSection"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("Art",class{constructor(e,t,i,r){this.rules=e,this.artIni=t,this.mapFile=i,this.logger=r,this.objectArt=new Map,this.parse()}hasObject(e,t){return this.objectArt.get(t)?.has(e)}getObject(e,t){if(!e)throw new Error(`Must specify an art name for type "${r.ObjectType[t]}"`);var a=this.objectArt.get(t)?.get(e);return a||(this.logger?.debug(`Missing art for object "${e}"`),new i.ObjectArt(t,this.rules.hasObject(e,t)?this.rules.getObject(e,t):new s.ObjectRules(t,new n.IniSection(e)),new n.IniSection(e)))}getAnimation(e){return this.getObject(e,r.ObjectType.Animation)}getProjectile(e){var t=this.rules.getProjectile(e),r=t.imageName;let s=this.artIni.getSection(r);return s||(this.logger?.debug(`Image ${r} (Projectile: ${e}) has no section in art.ini`),s=new n.IniSection(r)),i.ObjectArt.factory(t.type,t,this.artIni,s)}getIni(){return this.artIni}parse(){this.rules.allObjectRules.forEach(((e,t)=>{let s=new Map;this.objectArt.set(t,s),e.forEach((e=>{var t=this.artIni.getSection(e.imageName),n=this.artIni.getSection(e.name);(t=this.applyUnitMapOverrides(e,this.mapFile,n,t))?(t=i.ObjectArt.factory(e.type,e,this.artIni,t),s.set(e.name,t)):this.logger?.debug(`${r.ObjectType[e.type]} "${e.name}" has no art section "${e.imageName}"`)}))})),[[r.ObjectType.Animation,this.rules.animationNames]].forEach((([e,t])=>{let a=new Map;this.objectArt.set(e,a),t.forEach((t=>{var o,l=this.artIni.getSection(t);l?(o=new s.ObjectRules(e,new n.IniSection(t)),l=new i.ObjectArt(e,o,l),a.set(t,l)):this.logger?.debug(r.ObjectType[e]+` "${t}" has no art section`)}))}))}applyUnitMapOverrides(e,t,i,s){if([r.ObjectType.Infantry,r.ObjectType.Vehicle,r.ObjectType.Aircraft].includes(e.type)&&t?.getSection(e.name)?.getString("Image")&&i){let t=i.clone();s?.entries.forEach(((e,i)=>{t.set(i,e)})),s=t,this.logger?.debug(`${r.ObjectType[e.type]} "${e.name}": Using merged art sections ${e.name} and `+e.imageName)}return s}})}}})),System.register("game/gameobject/task/morph/PackBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/system/WaitMinutesTask"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends i.Task{onTick(e){return!(e.buildStatus!==r.BuildStatus.BuildDown&&(e.buildStatus=r.BuildStatus.BuildDown,!e.rules.wall)&&(this.children.push(new s.WaitMinutesTask(.035)),1))}},e("PackBuildingTask",n)}}})),System.register("util/disposable/LegacyDisposable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("util/disposable/CompositeDisposable",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=e=>!e.dispose,e("CompositeDisposable",class{constructor(){this.disposables=new Set}add(...e){e.map((e=>this.disposables.add("function"==typeof e?{dispose:e}:e)))}remove(...e){e.map((e=>this.disposables.delete(e)))}dispose(){this.disposables.forEach((e=>{"function"==typeof e?e():i(e)?e.destroy():e.dispose()})),this.disposables.clear()}})}}})),System.register("game/ConstructionWorker",["util/geometry","engine/type/ObjectType","game/type/SpeedType","game/map/tileFinder/CardinalTileFinder","game/gameobject/task/morph/PackBuildingTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","util/disposable/CompositeDisposable","game/event/EventType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("ConstructionWorker",class{constructor(e,t,i,r,s){this.player=e,this.rules=t,this.art=i,this.map=r,this.game=s,this.adjacencyMaps=new Map,this.disposables=new c.CompositeDisposable;let n=({object:e})=>{e.isBuilding()&&this.adjacencyMaps.clear()};this.map.tileOccupation.onChange.subscribe(n),this.disposables.add((()=>this.map.tileOccupation.onChange.unsubscribe(n))),this.disposables.add(this.game.events.subscribe(h.EventType.AllianceChange,(()=>this.adjacencyMaps.clear())),this.game.events.subscribe(h.EventType.ObjectOwnerChange,(e=>{e.target.isBuilding()&&this.adjacencyMaps.clear()})),this.game.events.subscribe(h.EventType.ObjectDestroy,(e=>{e.target.isBuilding()&&e.target.rules.leaveRubble&&this.adjacencyMaps.clear()})))}getAdjacentRect(e,t,i){return{x:e.rx-i,y:e.ry-i,width:t.width+2*i,height:t.height+2*i}}getAdjacencyMap(e){var t;let i=[];for(t of[...this.player.buildings,...this.game.gameOpts.buildOffAlly?this.game.alliances.getAllies(this.player).map((e=>[...e.buildings].filter((e=>e.rules.eligibileForAllyBuilding)))).flat():[]])t.rules.baseNormal&&i.push(this.getAdjacentRect(t.tile,t.art.foundation,e));return i}meetsAdjacency(e,t){let r=this.adjacencyMaps.get(t);for(var s of(r||(r=this.getAdjacencyMap(t),this.adjacencyMaps.set(t,r)),r))if(i.rectIntersect(e,s))return!0;return!1}getPlacementPreview(e,t,i={}){var{normalizedTile:s=!1,ignoreObjects:n,ignoreAdjacent:a=!1}=i,o=this.rules.getBuilding(e),l=this.art.getObject(e,r.ObjectType.Building);let c=[];var h=l.foundation,u=s?t:this.normalizePlacementTileCoords(l,t);let d=!0;l={x:u.rx,y:u.ry,width:h.width,height:h.height},o.constructionYard||a||this.meetsAdjacency(l,o.adjacent)||(d=!1);for(let e=0;e<h.width;e++)for(let t=0;t<h.height;t++){var g={x:u.rx+e,y:u.ry+t},p=this.map.tiles.getByMapCoords(g.x,g.y);p&&c.push({rx:g.x,ry:g.y,buildable:d&&this.isTileBuildable(p,o,n)})}if(o.wall&&c[0].buildable){this.getWallConnectingTiles(u,o).forEach((e=>{c.push({rx:e.rx,ry:e.ry,buildable:!0})}))}return c}canPlaceAt(e,t,i={}){var{normalizedTile:s=!1,ignoreObjects:n,ignoreAdjacent:a=!1}=i,o=this.rules.getBuilding(e),l=(h=this.art.getObject(e,r.ObjectType.Building)).foundation,c=s?t:this.normalizePlacementTileCoords(h,t),h={x:c.rx,y:c.ry,width:l.width,height:l.height};if(!o.constructionYard&&!a&&!this.meetsAdjacency(h,o.adjacent))return!1;for(let e=0;e<l.width;e++)for(let t=0;t<l.height;t++){var u={x:c.rx+e,y:c.ry+t};if(!(u=this.map.tiles.getByMapCoords(u.x,u.y))||!this.isTileBuildable(u,o,n))return!1}return!0}placeAt(e,t,i=!1){let r=[],s=this.rules.getBuilding(e),n=i?t:this.normalizePlacementTile(e,t);if(s.wall){let e=[[n,s]],t=this.getWallConnectingTiles(n,s);for(var a of(t.forEach((t=>{t!==n&&e.push([t,s])})),e))r.push(this.executePlacement(a[0],a[1]));t.forEach((e=>{var t=this.map.getObjectsOnTile(e).find((e=>e.isBuilding()&&e.name===s.name&&e.owner===this.player));this.connectWall(t)}))}else{var o,l=this.executePlacement(n,s);for(o of(r.push(l),this.map.tileOccupation.calculateTilesForGameObject(n,l))){var c=this.map.getObjectsOnTile(o).find((e=>e.isSmudge()));c&&this.game.unspawnObject(c)}}return r}normalizePlacementTileCoords(e,t){var i=e.foundationCenter;return{rx:t.rx-i.x,ry:t.ry-i.y}}normalizePlacementTile(e,t){var i=this.art.getObject(e,r.ObjectType.Building),s=this.normalizePlacementTileCoords(i,t);if(!(i=this.map.tiles.getByMapCoords(s.rx,s.ry)))throw new Error(`Can't build outside map (${s.rx}, ${s.ry})`);return i}unplace(e,t){e.unitOrderTrait.cancelAllTasks(),e.unitOrderTrait.addTasks(new l.TaskGroup(new a.PackBuildingTask,new o.CallbackTask((()=>{this.game.unspawnObject(e),e.rules.wall&&this.updateAdjacentWalls(e),t()}))).setCancellable(!1))}executePlacement(e,t){let i=this.game.createObject(r.ObjectType.Building,t.name);return this.game.changeObjectOwner(i,this.player),i.purchaseValue=this.game.sellTrait.computePurchaseValue(t,this.player),this.game.spawnObject(i,e),i}getWallConnectingTiles(e,t){var i,r=t.guardRange+1;let s=[];for(i of[[0,1],[0,-1],[1,0],[-1,0]]){let a=[];for(let o=0;o<r;++o){var n={x:e.rx+i[0]*o,y:e.ry+i[1]*o};if(!(n=this.map.tiles.getByMapCoords(n.x,n.y)))break;if(this.map.getObjectsOnTile(n).find((e=>e.isBuilding()&&e.name===t.name&&e.owner===this.player))){s=s.concat(a);break}if(!this.isTileBuildable(n,t))break;a.push(n)}}return s}getAdjacentBuildingData(e,t){var i;let r=[];for(i of[[0,1],[0,-1],[1,0],[-1,0]]){var s={x:e.rx+i[0],y:e.ry+i[1]},n=this.map.tiles.getByMapCoords(s.x,s.y);n&&(s=this.map.getObjectsOnTile(n).find((e=>e.isBuilding()&&e.name===t&&e.owner===this.player)))&&r.push({direction:i,tile:n,building:s})}return r}updateAdjacentWalls(e){let t=new n.CardinalTileFinder(this.map.tiles,this.map.mapBounds,e.tile,1,1);for(t.diagonal=!1;i=t.getNextTile();){var i=this.map.getObjectsOnTile(i).find((t=>t.isBuilding()&&t.name===e.rules.name&&t.owner===this.player));i&&this.connectWall(i)}}connectWall(e){let t=this.getAdjacentBuildingData(e.tile,e.name);this.updateWallType(e,t.map((e=>e.direction))),t.forEach((e=>{let t=this.getAdjacentBuildingData(e.tile,e.building.name);this.updateWallType(e.building,t.map((e=>e.direction)))}))}updateWallType(e,t){for(var i of(e.wallType=[0,0,0,0],t))0===i[0]&&-1===i[1]&&(e.wallType[0]=1),1===i[0]&&0===i[1]&&(e.wallType[1]=1),0===i[0]&&1===i[1]&&(e.wallType[2]=1),-1===i[0]&&0===i[1]&&(e.wallType[3]=1)}isTileBuildable(e,t,i){return!!this.map.isWithinBounds(e)&&!this.game.mapShroudTrait.getPlayerShroud(this.player)?.isShrouded(e)&&!this.map.getGroundObjectsOnTile(e).some((e=>!(i?.includes(e)||e.isBuilding()&&e.rules.invisibleInGame||e.isSmudge())))&&(t.waterBound?0<this.rules.getLandRules(e.landType).getSpeedModifier(s.SpeedType.Float):0===e.rampType&&this.rules.getLandRules(e.landType).buildable)}dispose(){this.disposables.dispose()}})}}})),System.register("util/BoxedVar",["util/event"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BoxedVar",class{constructor(e){this._onChange=new i.EventDispatcher,this.value=e}get value(){return this._value}set value(e){var t=e!==this._value;this._value=e,t&&this._onChange.dispatch(this,e)}get onChange(){return this._onChange.asEvent()}})}}})),System.register("game/theater/rampHeights",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("rampHeights",[[0,0,0,0],[0,0,1,1],[1,0,0,1],[1,1,0,0],[0,1,1,0],[0,0,0,1],[1,0,0,0],[0,1,0,0],[0,0,1,0],[1,0,1,1],[1,1,0,1],[1,1,1,0],[0,1,1,1],[1,0,1,2],[2,1,0,1],[1,2,1,0],[0,1,2,1],[1,0,1,0],[0,1,0,1],[1,0,1,0],[0,1,0,1]])}}})),System.register("game/gameobject/ObjectPosition",["game/Coords","util/event","game/theater/rampHeights","game/math/Vector3","game/math/Vector2","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("ObjectPosition",class e{constructor(e,t){this.tiles=e,this.tileOccupation=t,this._worldPosition=new n.Vector3,this._tileOffset=new a.Vector2,this._centerOffset=new a.Vector2,this.desiredSubCell=0,this._tileElevation=0,this._onPositionChange=new r.EventDispatcher}get onPositionChange(){return this._onPositionChange.asEvent()}get worldPosition(){return this._worldPosition}get tile(){return this._tile}set tile(e){var t=!!this._tile&&e!==this._tile;(this._tile=e)&&(this.updateWorldPosition(e,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:t}))}get tileElevation(){return void 0===this._tileElevation?(void 0===this._computedTileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos()),this._computedTileElevation):this._tileElevation}set tileElevation(e){this._absoluteElevation=void 0,this._tileElevation=e,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}get subCell(){if(!this._tileOffset.x&&!this._tileOffset.y)return 0;var e=Math.sign(this._tileOffset.x/i.Coords.LEPTONS_PER_TILE-.5),t=Math.sign(this._tileOffset.y/i.Coords.LEPTONS_PER_TILE-.5);return e&&t?t+1+(e+1)/2+1:0}set subCell(e){this._tileOffset=this.computeSubCellOffset(e),this.desiredSubCell=e,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}getTileOffset(){return this._tileOffset.clone()}setTileOffset(e){this._tileOffset.copy(e),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}setCenterOffset(e){this._centerOffset.copy(e),this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}getMapPosition(){if(this._tile)return new a.Vector2(this._tile.rx*i.Coords.LEPTONS_PER_TILE+this._tileOffset.x+this._centerOffset.x,this._tile.ry*i.Coords.LEPTONS_PER_TILE+this._tileOffset.y+this._centerOffset.y)}getBridgeBelow(){return this._tile?.onBridgeLandType?this.tileOccupation.getBridgeOnTile(this._tile):void 0}moveToTileCell(e,t=0){if(!this._tile)throw new Error("Tile is not set");var i=e!==this._tile;this._tile=e,this._tileOffset=this.computeSubCellOffset(t),this.desiredSubCell=t,this.updateWorldPosition(e,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:i})}moveToTileCoords(e,t,r=!1){var s=Math.floor(e),n=Math.floor(t),a=!this._tile||this._tile.rx!==s||this._tile.ry!==n;if(a){let e=this.tiles.getByMapCoords(s,n);if(!e){if(!r)throw new RangeError(`Attempted move to a non-existent tile: [${s},${n}]`);e=this.tiles.getPlaceholderTile(s,n)}this._tile=e}this._tileOffset.set((e-s)*i.Coords.LEPTONS_PER_TILE,(t-n)*i.Coords.LEPTONS_PER_TILE),this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:a})}moveToLeptons(e,t=!1){this.moveToTileCoords(e.x/i.Coords.LEPTONS_PER_TILE,e.y/i.Coords.LEPTONS_PER_TILE,t)}moveByLeptons(e,t,r=!1){if(!this._tile)throw new Error("Tile is not set");this.moveToTileCoords(this._tile.rx+(this._tileOffset.x+e)/i.Coords.LEPTONS_PER_TILE,this._tile.ry+(this._tileOffset.y+t)/i.Coords.LEPTONS_PER_TILE,r)}moveByLeptons3(e,t=!1){var i=this._worldPosition.y;this.moveByLeptons(e.x,e.z,t),this.setAbsoluteElevationWorld(i+e.y)}setAbsoluteElevationWorld(e){this._absoluteElevation=e,this._tileElevation=void 0,this._tile&&(this.updateWorldPosition(this._tile,this._tileOffset),this._onPositionChange.dispatch(this,{tileChanged:!1}))}computeSubCellOffset(e){let t={width:0,height:0};var r;e&&(r=(e-1)%2*2-1,s=2*Math.floor((e-1)/2)-1,t={width:r*i.Coords.LEPTONS_PER_TILE/4,height:s*i.Coords.LEPTONS_PER_TILE/4});var s=i.Coords.LEPTONS_PER_TILE/2;return new a.Vector2(s+t.width,s+t.height)}interpolateRampHeight(e,t,i){var r=s.rampHeights[i],n=r[1],a=r[0];return n*(1-e)*(1-t)+r[2]*e*(1-t)+a*(1-e)*t+r[3]*e*t}updateWorldPosition(e,t){var r=t.x+this._centerOffset.x,s=t.y+this._centerOffset.y,n=r/i.Coords.LEPTONS_PER_TILE,a=s/i.Coords.LEPTONS_PER_TILE;let o;if(void 0!==this._tileElevation){let t=0;0!==e.rampType&&(t=this.interpolateRampHeight(n,a,e.rampType)),o=i.Coords.tileHeightToWorld(e.z+t+this._tileElevation)}else o=this._absoluteElevation;this._worldPosition.set(e.rx*i.Coords.LEPTONS_PER_TILE+r,o,e.ry*i.Coords.LEPTONS_PER_TILE+s),void 0===this._tileElevation&&(this._computedTileElevation=this.computeTileElevationFromWorldPos())}computeTileElevationFromWorldPos(){if(!this._tile)return 0;var e=o.roundToDecimals(i.Coords.worldToTileHeight(this._worldPosition.y),14),t=(this._tileOffset.x+this._centerOffset.x)/i.Coords.LEPTONS_PER_TILE,r=(this._tileOffset.y+this._centerOffset.y)/i.Coords.LEPTONS_PER_TILE;let s=0;return 0!==this._tile.rampType&&(s=this.interpolateRampHeight(t,r,this._tile.rampType)),e-this._tile.z-s}clone(){let t=new e(this.tiles,this.tileOccupation);return t._worldPosition=this._worldPosition.clone(),t._tile=this._tile,t._tileOffset=this._tileOffset.clone(),t._centerOffset=this._centerOffset.clone(),t._tileElevation=this._tileElevation,t._absoluteElevation=this._absoluteElevation,t._computedTileElevation=this._computedTileElevation,t}})}}})),System.register("game/gameobject/unit/CollisionHelper",["engine/type/TerrainType","game/type/LandType","game/gameobject/unit/CollisionType","game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("CollisionHelper",class{constructor(e){this.tileOccupation=e}checkCollisions(e,t,i){var n,a=e.tile;let o,l;for(n of this.tileOccupation.getObjectsOnTile(a))n.isOverlay()&&n.isBridge()&&(o=n),n.isBuilding()&&(l=n);if(i.walls){if(e.tileElevation<=2&&a.landType===r.LandType.Wall)return s.CollisionType.Wall;if(i.buildings&&l?.tile===a&&e.tileElevation<=1.1&&i.buildings(l.owner))return s.CollisionType.Wall}if(i.shore&&a.landType!==r.LandType.Water)return s.CollisionType.Shore;if(i.ground&&e.tileElevation<0)return s.CollisionType.Ground;var c=e.tileElevation+a.z,h=t.tileElevation+t.tile.z;if(o?.isHighBridge()){var u=o.tile.z+o.tileElevation;if(u<h&&c<=u||h<u&&u-1<=c)return h<u?s.CollisionType.UnderBridge:s.CollisionType.OnBridge}else if(o?.isLowBridge()&&i.shore)return s.CollisionType.UnderBridge;return i.cliffs&&(a=a.z-t.tile.z,e.tileElevation<0&&4<=a)?s.CollisionType.Cliff:s.CollisionType.None}computeDetonationZone(e,t,r){let a=this.tileOccupation.getBridgeOnTile(e);return r===s.CollisionType.None&&t>1.5+(a?.tileElevation??0)?n.ZoneType.Air:a&&1.5<t||e.terrainType!==i.TerrainType.Water||a?.isLowBridge()?n.ZoneType.Ground:n.ZoneType.Water}})}}})),System.register("game/gameobject/Projectile",["game/gameobject/GameObject","engine/type/ObjectType","game/Weapon","game/WeaponType","game/gameobject/unit/FacingUtil","game/Coords","game/gameobject/unit/ZoneType","game/map/TileOccupation","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/RangeHelper","game/gameobject/unit/TargetUtil","game/math/geometry","game/map/tileFinder/RandomTileFinder","util/math","game/type/MovementZone","game/gameobject/infantry/StanceType","game/gameobject/unit/MovePositionHelper","game/GameSpeed","game/gameobject/unit/VeteranLevel","game/gameobject/task/ScatterTask","game/Warhead","game/rules/ObjectRules","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e}],execute:function(){var t;(t=M=M||{})[t.Travel=0]="Travel",t[t.Impact=1]="Impact",t[t.Detonation=2]="Detonation",e("ProjectileState",M),R=class extends i.GameObject{constructor(e,t,i,s){super(r.ObjectType.Projectile,e,t,i),this.tileOccupation=s,this.state=M.Travel,this.detonationTimer=0,this.collisionType=x.CollisionType.None,this.direction=0,this.zone=l.ZoneType.Air,this.isShrapnel=!1,this.isNuke=!1,this.baseDamageMultiplier=1,this.veteranDamageMult=1,this.snapToTarget=!1,this.targetLockLost=!1,this.limboTravelTicks=0,this.homingTravelDistance=0,this.homingTravelTicks=0,this.velocity=new A.Vector3,this.sonicVisitedObjects=new Map,this.collisionHelper=new E.CollisionHelper(s)}get fromObject(){return this._fromObject}set fromObject(e){(this._fromObject=e)&&e.veteranTrait&&!e.isDestroyed&&(this.veteranDamageMult=e.veteranTrait.getVeteranDamageMultiplier())}get rot(){return this.fromWeapon.rules.isSonic?C.ObjectRules.iniRotToDegsPerTick(this.iniRot):this.rules.rot}get iniRot(){return this.fromWeapon.rules.isSonic?10:this.rules.iniRot}static factory(e,t,i,r){return new this(e,t,i,r)}onSpawn(e){var t;if(super.onSpawn(e),this.initialSelfPosition=this.position.worldPosition.clone(),!this.target.obj||this.fromWeapon.type===n.WeaponType.DeathWeapon||this.fromWeapon.rules.limboLaunch||!this.isHoming()&&this.fromWeapon.speed===Number.POSITIVE_INFINITY||this.rules.inaccurate||this.rules.arcing||this.rules.flakScatter||0<(t=this.computeBaseDamage(e))&&(t=this.fromWeapon.warhead.computeDamage(t,this.target.obj),this.target.obj.healthTrait?.projectDamage(t)),e.afterTick((()=>{var t=new u.RangeHelper(this.tileOccupation).distance2(this.target.getWorldCoords(),this)/o.Coords.LEPTONS_PER_TILE;this.initialTileDistToTarget=t,this.maxSpeed=this.computeMaxSpeed(this.fromWeapon.speed,t,e.rules.audioVisual.gravity)})),this.isHoming()){if(1===this.iniRot&&(this.homingMoveDir=this.target.getWorldCoords().clone().sub(this.position.worldPosition)),this.fromObject?.isAircraft()&&this.rules.isAntiGround&&!this.rules.isAntiAir){let t=this.target.obj;!t?.isVehicle()||t.isDestroyed||t.veteranLevel!==b.VeteranLevel.Elite||t.unitOrderTrait.hasTasks()||t.unitOrderTrait.addTask(new S.ScatterTask(e))}}else if(this.rules.vertical){let e=this.position.clone();e.tileElevation=this.fromWeapon.warhead.rules.nukeMaker?o.Coords.worldToTileHeight(this.fromWeapon.projectileRules.detonationAltitude):0,this.aimPoint=e.worldPosition.clone()}else{let t=this.target.getWorldCoords().clone();e.afterTick((()=>{var i=this.target.getWorldCoords().clone().sub(t).length()>o.Coords.LEPTONS_PER_TILE;let r=i?t:this.target.obj?.isUnit()&&this.target.obj.moveTrait.velocity.length()&&isFinite(this.maxSpeed)?this.computeAimPointVersusMovingTarget(this.target.obj,this.maxSpeed,this.position.worldPosition,e.map):this.target.getWorldCoords().clone();this.aimPoint=r,this.snapToTarget=!i&&isFinite(this.maxSpeed)&&!this.fromWeapon.warhead.rules.sonic,(this.rules.inaccurate||this.rules.flakScatter)&&(this.adjustAimForBallisticScatter(e,r),this.snapToTarget=!1),!i&&this.rules.arcing&&(this.rules.inaccurate?(this.overshootTiles=this.calculateInaccurateBallisticOvershoot(e),this.snapToTarget=!1):this.target.obj?.isVehicle()&&this.target.obj.moveTrait.isMoving()&&(this.overshootTiles=this.calculateBallisticOvershootVsMoving(e,this.target.obj),this.overshootTiles&&(this.snapToTarget=!1))),r.clone().sub(this.position.worldPosition).length()<this.fromWeapon.speed&&this.update(e)}))}}adjustAimForBallisticScatter(e,t){let i,r=e.rules.combatDamage.ballisticScatter;i=this.rules.flakScatter?(this.rules.inviso&&(r*=2),e.generateRandom()*r):r/2+e.generateRandom()*(r/2);let s=i*o.Coords.LEPTONS_PER_TILE;this.rules.flakScatter&&(s*=(a=t.clone().sub(this.initialSelfPosition).length())/(this.fromWeapon.range*o.Coords.LEPTONS_PER_TILE));var n=g.rotateVec2(new O.Vector2(s,0),e.generateRandomInt(0,360)),a=o.Coords.vecWorldToGround(t).add(n).multiplyScalar(1/o.Coords.LEPTONS_PER_TILE).floor();e.map.tiles.getByMapCoords(a.x,a.y)&&t.add(new A.Vector3(n.x,0,n.y))}calculateBallisticOvershootVsMoving(e,t){let i=this.target.getWorldCoords().clone().sub(this.initialSelfPosition);var r=o.Coords.vecWorldToGround(i),s=o.Coords.vecWorldToGround(t.moveTrait.velocity);s=(s=(90<(r=g.angleDegBetweenVec2(r,s))?180-r:r)/90)*(r=i.length()/o.Coords.LEPTONS_PER_TILE)/5;return e.generateRandom()<=s?2*Math.min(1,r/5):0}calculateInaccurateBallisticOvershoot(e){return e.generateRandom()<=.5?2:0}update(e){if(void 0!==this.maxSpeed)if(super.update(e),this.state!==M.Impact){var t=this.velocity.clone(),i=this.position.clone();if(this.velocity.set(0,0,0),this.fromWeapon.rules.limboLaunch){if(!this.fromObject)throw new Error("Limbo launch projectile must be fired from a unit");if(this.fromObject.isDestroyed)return void e.destroyObject(this)}var r=this.updateSpeed(this.maxSpeed);this.speed=r;let C=this.target.getWorldCoords();if(this.lastTargetLockPosition&&(this.targetLockLost||C.clone().sub(this.lastTargetLockPosition).length()>=o.Coords.LEPTONS_PER_TILE)?(C=this.lastTargetLockPosition,this.targetLockLost=!0):this.lastTargetLockPosition=C.clone(),this.isHoming()){if(this.target.obj?.isUnit()&&(this.target.obj.isDestroyed||this.target.obj.isCrashing||!this.target.obj.isSpawned)&&(this.fromWeapon.rules.limboLaunch||this.homingTravelDistance>=2*o.Coords.LEPTONS_PER_TILE))return void this.detonate(e);if(this.homingMoveDir||(s=a.FacingUtil.toMapCoords(this.direction),this.homingMoveDir=new A.Vector3(s.x,0,s.y),this.fromObject?.isAircraft()&&(this.homingMoveDir.y=-9999999,this.homingMoveDir.normalize())),this.fromWeapon.rules.limboLaunch){if(!this.targetLockLost){if(10<this.limboTravelTicks)return this.position.moveToLeptons(this.target.obj.position.getMapPosition()),this.position.tileElevation=this.target.obj.position.tileElevation,void this.detonate(e);this.limboTravelTicks++}}else if(!this.isInHomingRange(C,e))return void this.detonate(e);let t=new u.RangeHelper(this.tileOccupation);var s=2<(n=Math.floor(t.distance2(C,this)/o.Coords.LEPTONS_PER_TILE))&&1<this.iniRot;let d=C.clone().sub(this.position.worldPosition),p=0;this.homingTravelTicks<this.rules.courseLockDuration||(s?(g.rotateVec3Towards(this.homingMoveDir,new A.Vector3(d.x,this.homingMoveDir.y,d.z),this.rot),this.rules.level||(l=m.clamp(Math.floor(this.initialTileDistToTarget)-1,0,2)+m.clamp(n-2,0,3)-this.position.tileElevation)&&(h=.25+6/this.iniRot*.1,p=o.Coords.tileHeightToWorld(Math.sign(l)*Math.min(Math.abs(l),h)))):g.rotateVec3Towards(this.homingMoveDir,d,this.rot)),this.direction=a.FacingUtil.fromMapCoords(new O.Vector2(this.homingMoveDir.x,this.homingMoveDir.z));var n=d.length(),l=Math.min(n,r);this.homingTravelDistance+=l,this.homingTravelTicks++;let f=!1,y=x.CollisionType.None;if(1<=l){let t=this.homingMoveDir.clone().setLength(l);p&&(t.y+=p),l===r&&this.velocity.copy(t);var c=t.clone().add(this.position.worldPosition);e.map.mapBounds.isWithinHardBounds(c)?this.position.moveByLeptons3(t):f=!0,y=this.checkObstacles(i,e),(y||l<r)&&(f=!0)}else this.position.moveByLeptons3(d),f=!0;f&&(this.collisionType=y,this.detonate(e,y))}else{let s=this.aimPoint.clone().sub(this.position.worldPosition);this.rules.vertical||(this.direction=a.FacingUtil.fromMapCoords(new O.Vector2(s.x,s.z))),this.rules.arcing&&(s.y=0);var h=Math.min(s.length(),r);if(s.setLength(h),this.rules.arcing){let t=o.Coords.vecWorldToGround(this.position.worldPosition.clone().sub(this.initialSelfPosition).add(s));n=this.aimPoint.clone().sub(this.initialSelfPosition);var d=t.length();c=o.Coords.vecWorldToGround(n).length(),l=n.y,n=e.rules.audioVisual.gravity;s.y=(l/c*r+n/2*c/r)*d/r-n*(d/r)*(d/r)/2+this.initialSelfPosition.y-this.position.worldPosition.y}let u=!1;d=s.clone().add(this.position.worldPosition),e.map.isWithinHardBounds(d)?this.position.moveByLeptons3(s):u=!0;let m=x.CollisionType.None;if(1<=h?(h!==r&&!this.overshootTiles||this.velocity.copy(s),m=this.checkObstacles(i,e),(m||h<r)&&(u=!0)):u=!0,u){if(!m)if(this.overshootTiles){var p=o.Coords.vecWorldToGround(t).setLength(this.overshootTiles*o.Coords.LEPTONS_PER_TILE);if(g.rotateVec2(p,e.generateRandomInt(-45,45)),d=o.Coords.vecGroundToWorld(p).add(this.position.worldPosition),!e.map.isWithinHardBounds(d))return void e.unspawnObject(this);this.position.moveByLeptons(p.x,p.y)}else if(this.snapToTarget&&!this.targetLockLost){if(!e.map.isWithinHardBounds(C))return void e.unspawnObject(this);this.position.moveByLeptons3(C.clone().sub(this.position.worldPosition))}this.collisionType=m,this.isNuke?(this.state=M.Impact,this.detonationTimer=2.5*v.GameSpeed.BASE_TICKS_PER_SECOND):this.detonate(e,m)}}let E=this.fromWeapon.warhead;if(E.rules.sonic){p=11/30*o.Coords.LEPTONS_PER_TILE,p=this.position.worldPosition.clone().add(this.velocity.clone().setLength(p)),p=o.Coords.vecWorldToGround(p).multiplyScalar(1/o.Coords.LEPTONS_PER_TILE).floor();var f,y,T=e.map.tiles.getByMapCoords(p.x,p.y);if(T&&T!==this.fromObject?.tile){var b,S=e.map.getTileZone(T);for(b of e.map.getGroundObjectsOnTile(T))if((!b.isUnit()||!b.onBridge)&&(!b.isTechno()||!b.rules.typeImmune||b.owner!==this.fromPlayer||b.name!==this.fromObject?.name)&&(!b.isAircraft()||!b.rules.spawned)&&E.canDamage(b,T,S)){let e=this.sonicVisitedObjects.get(b)??new Set;e.add(T),this.sonicVisitedObjects.set(b,e)}}for([f,y]of this.sonicVisitedObjects)for(var w of y)e.map.tileOccupation.isTileOccupiedBy(w,f)&&f.isSpawned&&(w=this.fromWeapon.rules.ambientDamage*this.veteranDamageMult*this.baseDamageMultiplier,w=E.computeDamage(w,f),E.inflictDamage(w,f,{player:this.fromPlayer,weapon:this.fromWeapon,obj:this.fromObject},e,f!==this.target.obj))}}else 0<this.detonationTimer?this.detonationTimer--:this.detonate(e,this.collisionType)}isHoming(){return!!this.rot&&!this.rules.arcing}isInHomingRange(e,t){let i=!0,r=this.target.obj;if(r?.isUnit()&&this.fromObject){let a=new u.RangeHelper(this.tileOccupation);var s,n=a.computeWeaponRangeVsTarget(this.fromObject,r,this.fromWeapon,t.rules).range;this.fromWeapon.rules.limboLaunch?i=a.isInRange3(this.initialSelfPosition,e,0,n+.5):(s=r.moveTrait.velocity.length())&&(this.fromObject.rules.movementZone===f.MovementZone.Fly?5<this.speed/s&&(i=a.isInRange2(this.initialSelfPosition,this.position.worldPosition,0,n)):isFinite(this.fromWeapon.speed)&&3.5<this.fromWeapon.speed/r.rules.speed&&(i=a.isInRange3(this.initialSelfPosition,this.position.worldPosition,0,n)))}return i}updateSpeed(e){let t;return t=this.isHoming()||this.rules.vertical?void 0===this.speed?Math.min(e,this.rules.acceleration):Math.min(e,this.speed+this.rules.acceleration):e,t}computeMaxSpeed(e,t,i){let r=e;return this.rules.arcing&&(r*=(1+i/6)/2,r*=(t=Math.floor(t))<=8?1:1+t/8*.5),this.fromWeapon.warhead.rules.sonic&&(r=Math.ceil(t*o.Coords.LEPTONS_PER_TILE/21)),r}checkObstacles(e,t){return this.fromWeapon.rules.limboLaunch?x.CollisionType.None:this.collisionHelper.checkCollisions(this.position,e,{cliffs:this.rules.subjectToCliffs,ground:this.isHoming(),shore:this.rules.level,walls:this.rules.subjectToWalls,buildings:e=>this.fromPlayer!==e&&!t.alliances.areAllied(this.fromPlayer,e)})}computeBaseDamage(e){var t=this.fromWeapon,i=t.warhead;let r=t.rules.damage;t.type===n.WeaponType.DeathWeapon&&i.rules.ivanBomb&&(r=e.rules.combatDamage.ivanDamage);let s=r*this.baseDamageMultiplier;return t.type===n.WeaponType.DeathWeapon&&this.fromObject&&(s*=this.fromObject.rules.deathWeaponDamageModifier),s*=this.veteranDamageMult,s}detonate(e,t=x.CollisionType.None){var i=this.fromWeapon;let r=i.warhead;var a,o=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,t);let l=this.tile;i.type===n.WeaponType.DeathWeapon&&r.rules.ivanBomb&&(r=new w.Warhead(e.rules.getWarhead(e.rules.combatDamage.ivanWarhead)));let d=this.computeBaseDamage(e);e.destroyObject(this),this.state=M.Detonation;let g=this.target.obj,m=!1;if(r.rules.parasite&&g?.isUnit()&&l===g.tile&&r.canDamage(g,l,o))if(g.isInfantry())d=Number.POSITIVE_INFINITY;else if(g.parasiteableTrait&&this.fromObject?.isUnit()){if(!(this.fromWeapon instanceof s.Weapon))throw new Error("Projectile with parasite warhead must have a weapon reference");g.parasiteableTrait.infest(this.fromObject,this.fromWeapon),m=!0}let v=!0;if(m&&(v=!1),r.rules.sonic&&(v=!1),r.rules.ivanBomb&&(v=!1,!g?.isTechno()||!g.tntChargeTrait||g.tntChargeTrait.hasCharge()||g.isDestroyed||g.warpedOutTrait.isInvulnerable()||(a=e.rules.combatDamage.ivanTimedDelay,g.tntChargeTrait.setCharge(a,e.currentTick,{player:this.fromPlayer}))),r.rules.bombDisarm&&(v=!1,g?.isTechno()&&g.tntChargeTrait?.hasCharge()&&!g.isDestroyed&&g.tntChargeTrait.removeCharge()),r.rules.mindControl&&(v=!1,this.fromObject&&!this.fromObject.isDestroyed&&g?.isTechno()&&g.mindControllableTrait&&!g.mindControllableTrait?.isActive()&&!e.areFriendly(g,this.fromObject)&&r.canDamage(g,l,o)&&!g.invulnerableTrait.isActive()&&this.fromObject.mindControllerTrait.control(g,e)),r.rules.temporal&&(v=!1,this.fromObject&&!this.fromObject.isDestroyed&&g?.isTechno()&&r.canDamage(g,l,o)&&!g.invulnerableTrait.isActive()&&(r.inflictDamage(0,g,{player:this.fromPlayer,weapon:i,obj:this.fromObject},e),this.fromObject.temporalTrait.updateTarget(g,i,e))),r.rules.makesDisguise&&(v=!1,this.fromObject&&!this.fromObject.isDestroyed&&(this.fromObject.isInfantry()||this.fromObject.isVehicle())&&g?.isUnit()&&g.type===this.fromObject.type&&this.fromObject.disguiseTrait?.disguiseAs(g,this.fromObject,e)),r.rules.electricAssault&&(this.fromObject?.isUnit()&&!this.fromObject.isDestroyed&&g?.isBuilding()&&!g.isDestroyed&&g.overpoweredTrait&&g.owner===this.fromPlayer&&g.overpoweredTrait.chargeFrom(this.fromObject),v=!1),v&&r.detonate(e,d,l,this.tileElevation,this.position.worldPosition,o,t,this.target,{player:this.fromPlayer,weapon:i,obj:this.fromObject},this.isShrapnel,!1,this.impactAnim),r.rules.nukeMaker){let t;t=this.fromObject?(b=s.Weapon.factory(s.Weapon.NUKE_PAYLOAD_NAME,n.WeaponType.Primary,this.fromObject,e.rules),e.createProjectile(b.projectileRules.name,this.fromObject,b,this.target,!1)):e.createLooseProjectile(s.Weapon.NUKE_PAYLOAD_NAME,this.fromPlayer,this.target),t.isNuke=!0,t.impactAnim="NUKEBALL";var b=this.target.tile;t.position.moveToTileCoords(b.rx+.5,b.ry+.5),t.position.tileElevation=this.position.tileElevation,e.spawnObject(t,b)}if(this.rules.shrapnelCount&&this.rules.shrapnelWeapon&&((this.target.obj?!this.target.obj.isBuilding():e.map.getGroundObjectsOnTile(this.target.tile).some((e=>e.isTerrain()))&&!i.projectileRules.isAntiAir)||this.isShrapnel)){let t=e.rules.getWeapon(this.rules.shrapnelWeapon);var S,C=e.rules.getProjectile(t.projectile);let i=this.rules.shrapnelCount,r=new u.RangeHelper(e.map.tileOccupation),s=new h.RadialTileFinder(e.map.tiles,e.map.mapBounds,l,{width:1,height:1},1,t.range,(e=>r.isInTileRange(l,e,t.minimumRange,t.range))),n=new Set;for(;0<Math.floor(i);){var E,O=s.getNextTile();if(!O)break;for(E of e.map.tileOccupation.getObjectsOnTileByLayer(O,C.isAntiAir?c.LayerType.Air:c.LayerType.Ground).filter((t=>e.isValidTarget(t)&&(t.isTerrain()||t.isTechno()&&t.owner!==this.fromPlayer&&!e.alliances.areAllied(t.owner,this.fromPlayer)&&!(t.isInfantry()&&t.stance===y.StanceType.Paradrop)))))if(!n.has(E)&&(n.add(E),i=Math.max(0,i-1-(E.isTechno()?.5:0)),Math.floor(i)<=0))break}for(S of n){var A=e.createTarget(S.isTerrain()?void 0:S,S.tile);this.createShrapnel(e,A,t.name)}i=Math.floor(i);let a=new p.RandomTileFinder(e.map.tiles,e.map.mapBounds,l,t.range,e,(e=>r.isInTileRange(l,e,t.minimumRange,t.range)));for(let r=0;r<i;r++){var R=a.getNextTile();if(!R)break;R=e.createTarget(void 0,R),this.createShrapnel(e,R,t.name)}}if(i.rules.limboLaunch&&!m&&this.fromObject?.isUnit()){let t,s,n=this.fromObject;if(r.rules.parasite&&(this.target.obj.isVehicle()||this.target.obj?.isAircraft())&&this.target.obj.parasiteableTrait&&(this.target.obj.parasiteableTrait.beingBoarded=!1),i=n.rules.movementZone===f.MovementZone.Fly)t=l,s=!1;else{let i=this.target.obj.isUnit()&&this.target.obj.tile.onBridgeLandType&&!this.target.obj.onBridge?void 0:e.map.tileOccupation.getBridgeOnTile(l),r=new T.MovePositionHelper(e.map),a=new h.RadialTileFinder(e.map.tiles,e.map.mapBounds,l,{width:1,height:1},0,1,(t=>{var s=e.map.tileOccupation.getBridgeOnTile(t);return 0<e.map.terrain.getPassableSpeed(t,n.rules.speedType,!!s)&&r.isEligibleTile(t,s,i,l)&&(t===l||!e.map.terrain.findObstacles({tile:t,onBridge:i},n).length)}));t=a.getNextTile(),s=!!t?.onBridgeLandType}t?(!i&&this.target.obj.isUnit()&&(n.onBridge=s,n.position.tileElevation=s?e.map.tileOccupation.getBridgeOnTile(t)?.tileElevation??0:0),e.unlimboObject(n,t),n.isInfantry()&&(n.position.subCell=this.target.obj.position.subCell),n.direction=this.direction):n.owner.removeOwnedObject(n)}}createShrapnel(e,t,i){let r=e.createLooseProjectile(i,this.fromPlayer,t);r.isShrapnel=!0,r.veteranDamageMult=this.veteranDamageMult,r.position.moveToLeptons(this.position.getMapPosition()),r.position.tileElevation=this.position.tileElevation,e.spawnObject(r,r.position.tile)}computeAimPointVersusMovingTarget(e,t,i,r){let s=e.position.worldPosition,n=s.clone();var a=t,c=e.moveTrait.velocity.length();if(a<3*c)return s.clone();let h=d.TargetUtil.computeInterceptPoint(i,a,s,e.moveTrait.velocity);if(h.length()){let t=h.clone().sub(s);if(a=t.length(),a=c?Math.ceil(a/c):0,h=s.clone().add(t.setLength(a*c)),r.isWithinHardBounds(h))if(e.zone!==l.ZoneType.Air){h.multiplyScalar(1/o.Coords.LEPTONS_PER_TILE);let t=e.position.clone();t.moveToTileCoords(h.x,h.z),n=t.worldPosition}else n=h;else n=s}return n.clone()}},e("Projectile",R)}}})),System.register("game/trait/interface/NotifyHealthChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyHealthChange",i)}}})),System.register("game/event/InflictDamageEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("InflictDamageEvent",class{constructor(e,t,r,s,n){this.target=e,this.attacker=t,this.damageHitPoints=r,this.currentHealth=s,this.prevHealth=n,this.type=i.EventType.InflictDamage}})}}})),System.register("game/gameobject/trait/interface/NotifyHealthChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyHealthChange",i)}}})),System.register("game/gameobject/unit/HealthLevel",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Green=0]="Green",t[t.Yellow=1]="Yellow",t[t.Red=2]="Red",e("HealthLevel",i)}}})),System.register("game/event/HealthChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("HealthChangeEvent",class{constructor(e,t,r){this.target=e,this.currentHealth=t,this.prevHealth=r,this.type=i.EventType.HealthChange}})}}})),System.register("game/gameobject/trait/HealthTrait",["util/math","game/gameobject/trait/interface/NotifyDamage","game/trait/interface/NotifyHealthChange","game/event/InflictDamageEvent","game/gameobject/trait/interface/NotifyHealthChange","game/gameobject/trait/interface/NotifyHeal","game/gameobject/unit/HealthLevel","game/gameobject/trait/interface/NotifyTick","game/event/HealthChangeEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){u=class{constructor(e,t,i,r){this.maxHitPoints=e,this.gameObject=t,this.conditionYellow=i,this.conditionRed=r,this.setHitPoints(e),this.projectedHitPoints=this.hitPoints}get health(){return this._computedHealth}set health(e){this.setHitPoints(0<e?Math.max(1,Math.floor(e*this.maxHitPoints/100)):0),this.projectedHitPoints=this.hitPoints}get level(){return this.health>100*this.conditionYellow?l.HealthLevel.Green:this.health>100*this.conditionRed?l.HealthLevel.Yellow:l.HealthLevel.Red}setHitPoints(e){if(e!==Math.floor(e))throw new Error(`Value ${e} is not an integer`);this.hitPoints=i.clamp(e,0,this.maxHitPoints),this._computedHealth=this.hitPoints/this.maxHitPoints*100}getHitPoints(){return this.hitPoints}getProjectedHitPoints(){return this.projectedHitPoints}inflictDamage(e,t,i){var s=this.hitPoints,a=this.health;this.applyHitPoints(s-e,i),s!==this.hitPoints&&0<e&&(this.gameObject.traits.filter(r.NotifyDamage).forEach((s=>{s[r.NotifyDamage.onDamage](this.gameObject,i,e,t)})),i.events.dispatch(new n.InflictDamageEvent(this.gameObject,t,e,this.health,a)))}healBy(e,t,i){if(e<0)throw new Error("Can't heal by negative value "+e);if(this.hitPoints<this.maxHitPoints){var r=this.hitPoints;this.applyHitPoints(this.hitPoints+e,i),this.projectedHitPoints=this.hitPoints;let s=this.hitPoints-r;this.gameObject.traits.filter(o.NotifyHeal).forEach((e=>{e[o.NotifyHeal.onHeal]?.(this.gameObject,i,s,t)}))}}healToFull(e,t){if(this.hitPoints<this.maxHitPoints){var i=this.hitPoints;this.applyHitPoints(this.maxHitPoints,t),this.projectedHitPoints=this.hitPoints;let r=this.hitPoints-i;this.gameObject.traits.filter(o.NotifyHeal).forEach((i=>{i[o.NotifyHeal.onHeal]?.(this.gameObject,t,r,e)}))}}applyHitPoints(e,t){let i=this.health;this.setHitPoints(e),i!==this.health&&(t.traits.filter(s.NotifyHealthChange).forEach((e=>{e[s.NotifyHealthChange.onChange](this.gameObject,t,i)})),this.gameObject.traits.filter(a.NotifyHealthChange).forEach((e=>{e[a.NotifyHealthChange.onChange](this.gameObject,t,i)})),t.events.dispatch(new h.HealthChangeEvent(this.gameObject,this.health,i)))}projectDamage(e){if(e<0)throw new Error("Projected damage must be positive");this.projectedHitPoints=Math.max(-30,this.projectedHitPoints-e)}[c.NotifyTick.onTick](e,t){t.currentTick%4==0&&(this.projectedHitPoints=Math.min(this.projectedHitPoints+1,this.hitPoints))}getHash(){return this.hitPoints}debugGetState(){return{hitPoints:this.hitPoints}}dispose(){this.gameObject=void 0}},e("HealthTrait",u)}}})),System.register("game/gameobject/trait/BridgeTrait",["game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/infantry/InfDeathType","game/type/LandType","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class e{constructor(e){this.bridges=e,this.needsImageUpdate=!1,this.dominoHandled=!1}[i.NotifyDamage.onDamage](){this.needsImageUpdate=!0}[r.NotifyTick.onTick](e){this.needsImageUpdate&&(this.needsImageUpdate=!1,this.bridges.handlePieceHealthChange(this.bridges.getPieceAtTile(e.tile)))}[s.NotifyDestroy.onDestroy](t,i,r){var s=this.bridges.getPieceAtTile(t.tile);this.dominoHandled||this.bridges.findDominoPieces(s).filter((e=>!e.obj.isDestroyed)).forEach((t=>{t.obj.traits.get(e).dominoHandled=!0,i.destroyObject(t.obj,r)})),i.map.tileOccupation.calculateTilesForGameObject(t.tile,t).forEach((e=>{let s=a.getLandType(e.terrainType),c=i.rules.getLandRules(s);i.map.getGroundObjectsOnTile(e).forEach((e=>{e.isUnit()&&e.onBridge&&!e.isDestroyed&&(t.isLowBridge()&&0<c.getSpeedModifier(e.rules.speedType)||e.isInfantry()&&e.stance===l.StanceType.Paradrop?(e.onBridge=!1,e.zone=o.getZoneType(s)):(e.isInfantry()&&(e.infDeathType=n.InfDeathType.None),i.destroyObject(e,r,!0)))}))}))}},e("BridgeTrait",c)}}})),System.register("game/map/OreSpread",["game/map/OreOverlayTypes","engine/type/OverlayTibType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("OreSpread",class{static calculateOverlayId(e,t){if(e!==r.OverlayTibType.NotSpecial){var s=t.dx,n=t.dy;s=Math.floor((n-9)/2%12*((n-8)/2%12)%12-(s-13)/2%12*((s-12)/2%12)%12+12e4);return s%=12,e===r.OverlayTibType.Ore?i.OreOverlayTypes.minIdRiparius+s:e===r.OverlayTibType.Gems?i.OreOverlayTypes.minIdCruentus+s:e===r.OverlayTibType.Vinifera?i.OreOverlayTypes.minIdVinifera+s:e===r.OverlayTibType.Aboreus?i.OreOverlayTypes.minIdAboreus+s:void 0}}})}}})),System.register("game/gameobject/trait/TiberiumTreeTrait",["game/gameobject/trait/interface/NotifyTick","game/map/tileFinder/RadialTileFinder","game/type/LandType","engine/type/ObjectType","game/map/OreSpread","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){var t;(t=c=c||{})[t.Idle=0]="Idle",t[t.Spawning=1]="Spawning",e("SpawnStatus",c),h=class{constructor(e){this.rules=e,this.ticksSinceLastSpawn=0,this.cooldownTicks=Math.floor(1/this.rules.animationProbability),this.status=c.Idle}[i.NotifyTick.onTick](e,t){this.status=c.Idle,this.ticksSinceLastSpawn++>this.cooldownTicks&&(this.ticksSinceLastSpawn=0,this.status=c.Spawning,this.spawnTiberium(e.tile,t))}spawnTiberium(e,t){for(let u=1;u<=2;u++){let d=new r.RadialTileFinder(t.map.tiles,t.map.mapBounds,e,{width:1,height:1},u,u,(e=>l.TiberiumTrait.canBePlacedOn(e,t.map)));var i=d.getNextTile();if(i){var c=a.OreSpread.calculateOverlayId(o.OverlayTibType.Ore,i);if(void 0===c)throw new Error("Expected an overlayId");let e=t.createObject(n.ObjectType.Overlay,t.rules.getOverlayName(c));return e.overlayId=c,e.value=3,void t.spawnObject(e,i)}let g;for(d=new r.RadialTileFinder(t.map.tiles,t.map.mapBounds,e,{width:1,height:1},u,u,(e=>e.landType===s.LandType.Tiberium));!g;){var h=d.getNextTile();if(!h)break;g=t.map.getObjectsOnTile(h).find((e=>e.isOverlay()&&e.isTiberium()&&e.traits.get(l.TiberiumTrait).getBailCount()+1<=l.TiberiumTrait.maxBails))}if(g)return void g.traits.get(l.TiberiumTrait).spawnBails(1)}}},e("TiberiumTreeTrait",h)}}})),System.register("game/gameobject/trait/AutoRepairTrait",["game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyOwnerChange","game/GameSpeed"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{constructor(e=!1){this.freeRepair=e,this.disabled=!0,this.cooldownTicks=0,this.healLeftover=0}isDisabled(){return this.disabled}setDisabled(e){this.disabled=e}[i.NotifyTick.onTick](e,t){if(!this.isDisabled())if(100===e.healthTrait.health&&this.setDisabled(!0),this.cooldownTicks<=0){var i=t.rules.general.repair,r=e.isInfantry()?i.iRepairRate:e.isBuilding()?i.repairRate:i.uRepairRate;this.cooldownTicks+=s.GameSpeed.BASE_TICKS_PER_SECOND*r*60;var n=e.isInfantry()?i.iRepairStep:i.repairStep;let a;(r=this.freeRepair?0:i.repairPercent)?(i=r*e.purchaseValue/e.healthTrait.maxHitPoints,(r=Math.min(e.owner.credits,Math.max(1,Math.floor(i*n))))?(a=i?r/i:n,e.owner.credits-=r):(a=0,this.setDisabled(!0))):a=n,a&&(a+=this.healLeftover,a=Math.min(e.healthTrait.maxHitPoints-e.healthTrait.getHitPoints(),a),a&&(n=Math.floor(a),this.healLeftover=a-n,n&&e.healthTrait.healBy(n,e,t)))}else this.cooldownTicks--}[r.NotifyOwnerChange.onChange](){this.setDisabled(!0)}},e("AutoRepairTrait",n)}}})),System.register("game/trait/interface/NotifyTargetDestroy",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onDestroy=Symbol(),e("NotifyTargetDestroy",i)}}})),System.register("game/event/UnitPromoteEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("UnitPromoteEvent",class{constructor(e){this.target=e,this.type=i.EventType.UnitPromote}})}}})),System.register("game/gameobject/trait/SelfHealingTrait",["game/gameobject/trait/interface/NotifyTick","game/GameSpeed"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.cooldownTicks=0}[i.NotifyTick.onTick](e,t){100!==e.healthTrait.health&&(this.cooldownTicks<=0?(this.cooldownTicks+=r.GameSpeed.BASE_TICKS_PER_SECOND*t.rules.general.repair.repairRate*60,e.healthTrait.healBy(1,e,t)):this.cooldownTicks--)}},e("SelfHealingTrait",s)}}})),System.register("game/event/ObjectCloakChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectCloakChangeEvent",class{constructor(e){this.target=e,this.type=i.EventType.ObjectCloakChange}})}}})),System.register("game/gameobject/trait/CloakableTrait",["game/event/ObjectCloakChangeEvent","game/GameSpeed","game/gameobject/trait/interface/NotifyDamage","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class{constructor(e,t){this.gameObject=e,this.cloakDelayMinutes=t,this.isActive=!1,this.resetCloakCooldown()}isCloaked(){return this.isActive}uncloak(e){var t=this.isActive;this.resetCloakCooldown(),t&&(this.isActive=!1,e.events.dispatch(new i.ObjectCloakChangeEvent(this.gameObject)))}resetCloakCooldown(){this.cooldownTicks=Math.floor(60*this.cloakDelayMinutes*r.GameSpeed.BASE_TICKS_PER_SECOND)}[n.NotifySpawn.onSpawn](e,t){this.resetCloakCooldown()}[a.NotifyTick.onTick](e,t){0<this.cooldownTicks&&this.cooldownTicks--,!(this.cooldownTicks<=0)||this.isActive||e.isVehicle()&&e.submergibleTrait&&!e.submergibleTrait.isSubmerged()||e.temporalTrait.getTarget()||(this.isActive=!0,t.events.dispatch(new i.ObjectCloakChangeEvent(this.gameObject)))}[s.NotifyDamage.onDamage](e,t){this.uncloak(t)}dispose(){this.gameObject=void 0}},e("CloakableTrait",o)}}})),System.register("game/gameobject/trait/ArmedTrait",["game/Weapon","game/WeaponType","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/unit/VeteranLevel","util/typeGuard"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class{constructor(e,t){this.gameObject=e,this.rules=t,this.specialWeaponIndex=0;var i=e.veteranLevel===a.VeteranLevel.Elite;e.rules.weaponCount?(this.selectSpecialWeapon(0,i),this.guardWeaponRangeOverride=this.primaryWeapon?.range):this.selectStandardWeapons(i)}selectStandardWeapons(e=!1){var t=this.gameObject,s=e&&t.rules.elitePrimary||t.rules.primary;s?(a=e?t.art.elitePrimaryFireFlh:t.art.primaryFireFlh,this.primaryWeapon=i.Weapon.factory(s,r.WeaponType.Primary,t,this.rules,a)):this.primaryWeapon=void 0;var n,a=e&&t.rules.eliteSecondary||t.rules.secondary;a?(n=e?t.art.eliteSecondaryFireFlh:t.art.secondaryFireFlh,this.secondaryWeapon=i.Weapon.factory(a,r.WeaponType.Secondary,t,this.rules,n)):this.secondaryWeapon=void 0,(t.explodes||t.crashableTrait)&&(n=t.rules.deathWeapon||!!t.crashableTrait&&this.secondaryWeapon?.rules.name||this.primaryWeapon?.rules.name||this.rules.combatDamage.deathWeapon,this.deathWeapon=i.Weapon.factory(n,r.WeaponType.DeathWeapon,t,this.rules))}selectSpecialWeapon(e,t=!1){let s=this.gameObject;var n=s.rules.weaponCount;if(n<1)throw new Error(`Object "${s.name}" doesn't support special weapons`);if(n-1<e)throw new RangeError(`Weapon index ${e} out of bounds (max ${n}) for object `+s.name);var a=t&&s.rules.getEliteWeaponAtIndex(e)||s.rules.getWeaponAtIndex(e);if(!a)throw new Error(`Missing weapon at index ${e} for object "${s.name}"`);n=s.art.getSpecialWeaponFlh(e),this.primaryWeapon=i.Weapon.factory(a,r.WeaponType.Primary,s,this.rules,n),this.secondaryWeapon=void 0,this.specialWeaponIndex=e,this.deathWeapon=this.primaryWeapon.rules.suicide?i.Weapon.factory(s.rules.deathWeapon||this.primaryWeapon.name,r.WeaponType.DeathWeapon,s,this.rules):void 0}toggleEliteWeapons(e){this.gameObject.rules.weaponCount?this.selectSpecialWeapon(this.specialWeaponIndex,e):this.selectStandardWeapons(e)}getSpecialWeaponIndex(){return this.specialWeaponIndex}computeGuardScanRange(e){var t=this.guardWeaponRangeOverride??[this.primaryWeapon,this.secondaryWeapon].filter((t=>t===e||t?.rules.neverUse)).reduce(((e,t)=>Math.max(e,t.range)),0);t=Math.max(t,this.gameObject.rules.guardRange);return Math.min(15,2*t-1)}getDeployFireWeapon(){if(this.gameObject.rules.deployFire)return this.gameObject.rules.deployFireWeapon===r.WeaponType.Primary?this.primaryWeapon:this.secondaryWeapon}isEquippedWithWeapon(e){return[this.primaryWeapon,this.secondaryWeapon].includes(e)}getWeapons(){return[this.primaryWeapon,this.secondaryWeapon].filter(o.isNotNullOrUndefined)}[s.NotifyTick.onTick](){this.primaryWeapon&&this.primaryWeapon.tick(),this.secondaryWeapon&&this.secondaryWeapon.tick()}[n.NotifyDestroy.onDestroy](e,t,i){!this.deathWeapon||i?.weapon?.warhead.rules.temporal||e.crashableTrait&&!e.isCrashing||i?.obj?.isVehicle()&&i.weapon?.rules.suicide&&i.obj.transportTrait?.units.find((t=>t===e))||this.deathWeapon.fire(t.createTarget(e,e.tile),t)}dispose(){this.gameObject=void 0,this.primaryWeapon=void 0,this.secondaryWeapon=void 0,this.deathWeapon=void 0}},e("ArmedTrait",l)}}})),System.register("game/gameobject/trait/SensorsTrait",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SensorsTrait",class{})}}})),System.register("game/gameobject/trait/VeteranTrait",["game/gameobject/unit/VeteranLevel","game/trait/interface/NotifyTargetDestroy","game/event/UnitPromoteEvent","game/gameobject/unit/VeteranAbility","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SensorsTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class{constructor(e,t){this.gameObject=e,this.veteranRules=t,this.veteranLevel=i.VeteranLevel.None,this.xp=0,this.promotionThresh=e.rules.cost*t.veteranRatio+1}[r.NotifyTargetDestroy.onDestroy](e,t,i,r){e.isDestroyed&&!e.isCrashing||t.isTechno()&&(t.rules.dontScore||t.rules.insignificant||(i&&(i.warhead.rules.temporal||i.warhead.rules.parasite&&e.rules.organic)||!r.areFriendly(e,t))&&(this.veteranLevel>=this.veteranRules.veteranCap||this.gainXP(t.rules.cost*(t.veteranLevel+1))&&this.handlePromotion(e,r)))}setRelativeXP(e){this.gainXP(Math.floor(e*this.promotionThresh))}gainXP(e){if(this.xp+=e,this.xp>=this.promotionThresh){var t=Math.min(this.veteranLevel+Math.floor(this.xp/this.promotionThresh),this.veteranRules.veteranCap),i=t-this.veteranLevel;if(i)return this.xp-=i*this.promotionThresh,this.setVeteranLevel(t),!0}return!1}promote(e,t){var i=Math.min(this.veteranLevel+e,this.veteranRules.veteranCap);i-this.veteranLevel&&(this.setVeteranLevel(i),this.handlePromotion(this.gameObject,t))}isMaxLevel(){return this.veteranLevel===this.veteranRules.veteranCap}isElite(){return this.veteranLevel===i.VeteranLevel.Elite}setVeteranLevel(e){this.veteranLevel=e,this.veteranLevel===i.VeteranLevel.Elite&&this.gameObject.armedTrait?.toggleEliteWeapons(!0)}handlePromotion(e,t){this.hasVeteranAbility(n.VeteranAbility.SELF_HEAL)&&(e.traits.find(a.SelfHealingTrait)||t.addObjectTrait(e,new a.SelfHealingTrait)),this.hasVeteranAbility(n.VeteranAbility.CLOAK)&&(e.cloakableTrait||(e.cloakableTrait=new o.CloakableTrait(e,t.rules.general.cloakDelay),t.addObjectTrait(e,e.cloakableTrait))),this.hasVeteranAbility(n.VeteranAbility.EXPLODES)&&(e.explodes||(e.explodes=!0,e.armedTrait||(e.armedTrait=new l.ArmedTrait(e,t.rules),t.addObjectTrait(e,e.armedTrait)))),this.hasVeteranAbility(n.VeteranAbility.RADAR_INVISIBLE)&&(e.radarInvisible||(e.radarInvisible=!0)),this.hasVeteranAbility(n.VeteranAbility.SENSORS)&&(e.sensorsTrait||(e.sensorsTrait=new c.SensorsTrait,t.addObjectTrait(e,e.sensorsTrait))),e.isInfantry()&&this.hasVeteranAbility(n.VeteranAbility.FEARLESS)&&e.suppressionTrait?.disable(),this.hasVeteranAbility(n.VeteranAbility.C4)&&(e.c4||(e.c4=!0)),this.hasVeteranAbility(n.VeteranAbility.GUARD_AREA)&&(e.defaultToGuardArea||(e.defaultToGuardArea=!0,e.unitOrderTrait.isIdle()&&e.resetGuardModeToIdle())),this.hasVeteranAbility(n.VeteranAbility.CRUSHER)&&(e.crusher||(e.crusher=!0)),t.events.dispatch(new s.UnitPromoteEvent(e))}getVeteranSightMultiplier(){return this.getVeteranAbilityMultiplier(n.VeteranAbility.SIGHT)}getVeteranSpeedMultiplier(){return this.getVeteranAbilityMultiplier(n.VeteranAbility.FASTER)}getVeteranArmorMultiplier(){return this.getVeteranAbilityMultiplier(n.VeteranAbility.STRONGER)}getVeteranDamageMultiplier(){return this.getVeteranAbilityMultiplier(n.VeteranAbility.FIREPOWER)}getVeteranRofMultiplier(){return this.getVeteranAbilityMultiplier(n.VeteranAbility.ROF)}hasVeteranAbility(e){return this.veteranLevel===i.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(e)||this.veteranLevel>=i.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(e)}getVeteranAbilityMultiplier(e){let t=1;return(this.veteranLevel===i.VeteranLevel.Veteran&&this.gameObject.rules.veteranAbilities.has(e)||this.veteranLevel>=i.VeteranLevel.Elite&&this.gameObject.rules.eliteAbilities.has(e))&&(t=this.getVeteranRulesMultiplier(e)),t}getVeteranRulesMultiplier(e){switch(e){case n.VeteranAbility.FASTER:return this.veteranRules.veteranSpeed;case n.VeteranAbility.STRONGER:return this.veteranRules.veteranArmor;case n.VeteranAbility.FIREPOWER:return this.veteranRules.veteranCombat;case n.VeteranAbility.ROF:return this.veteranRules.veteranROF;case n.VeteranAbility.SIGHT:return this.veteranRules.veteranSight;default:throw new Error("Unhandled VeteranAbility "+e)}}dispose(){this.gameObject=void 0}},e("VeteranTrait",h)}}})),System.register("game/gameobject/trait/InvulnerableTrait",["game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.timer=new i.Timer}isActive(){return this.timer.isActive()}setActiveFor(e,t){this.timer.setActiveFor(e,t)}[r.NotifyTick.onTick](e,t){this.timer.tick(t.currentTick)}},e("InvulnerableTrait",s)}}})),System.register("game/trait/interface/NotifyWarpChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyWarpChange",i)}}})),System.register("game/gameobject/trait/WarpedOutTrait",["game/gameobject/trait/interface/NotifyWarpChange","game/trait/interface/NotifyWarpChange","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class{constructor(e){this.gameObject=e,this.ticksWhenWarpedOut=!0,this.remainingTicks=0,this.invulnerable=!1}isActive(){return 0<this.remainingTicks}setActive(e,t,i){this.remainingTicks=e?Number.POSITIVE_INFINITY:0,this.invulnerable=t,this.notifyChange(e,i)}setTimed(e,t,i){this.remainingTicks=e,this.invulnerable=t,this.notifyChange(!0,i)}debugSetActive(e){this.remainingTicks=e?Number.POSITIVE_INFINITY:0}notifyChange(e,t){t.traits.filter(r.NotifyWarpChange).forEach((i=>{i[r.NotifyWarpChange.onChange](this.gameObject,t,e)})),this.gameObject.traits.filter(i.NotifyWarpChange).forEach((r=>{r[i.NotifyWarpChange.onChange](this.gameObject,t,e)}))}expire(e){this.remainingTicks=0,this.notifyChange(!1,e)}isInvulnerable(){return this.isActive()&&this.invulnerable}[s.NotifyTick.onTick](e,t){0<this.remainingTicks&&(this.remainingTicks--,this.remainingTicks<=0&&this.notifyChange(!1,t))}dispose(){this.gameObject=void 0}},e("WarpedOutTrait",n)}}})),System.register("game/gameobject/trait/TntChargeTrait",["game/Coords","game/Warhead","game/gameobject/common/DeathType","game/gameobject/unit/CollisionType","game/gameobject/unit/Timer","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class{constructor(){this.timer=new a.Timer}hasCharge(){return this.timer.isActive()}setCharge(e,t,i){this.hasCharge()||(this.timer.setActiveFor(e,t),this.attackerInfo=i)}getChargeOwner(){return this.attackerInfo?.player}removeCharge(){this.timer.reset()}getTicksLeft(){return this.timer.getTicksLeft()}getInitialTicks(){return this.timer.getInitialTicks()}[l.NotifyTick.onTick](e,t){this.timer.isActive()&&!0===this.timer.tick(t.currentTick)&&(e.isBuilding()&&e.cabHutTrait&&e.cabHutTrait.demolishBridge(t,this.attackerInfo),this.detonateIvanWarhead(t,e))}[o.NotifyDestroy.onDestroy](e,t,i){this.timer.isActive()&&!i?.weapon?.warhead.rules.ivanBomb&&e.deathType!==s.DeathType.None&&e.deathType!==s.DeathType.Temporal&&(this.timer.reset(),this.detonateIvanWarhead(t,e))}detonateIvanWarhead(e,t){var s=e.rules.combatDamage.ivanDamage;let a=new r.Warhead(e.rules.getWarhead(e.rules.combatDamage.ivanWarhead));var o=t.tile,l=t.tileElevation,c=t.isUnit()?t.zone:e.map.getTileZone(o),h=!!t.isUnit()&&t.onBridge;a.detonate(e,s,o,l,t.isBuilding()?i.Coords.tile3dToWorld(o.rx+.5,o.ry+.5,o.z+l):t.position.worldPosition,c,h?n.CollisionType.OnBridge:n.CollisionType.None,e.createTarget(t,o),{...this.attackerInfo,weapon:void 0},!1,!1,void 0)}},e("TntChargeTrait",c)}}})),System.register("game/gameobject/trait/MindControllableTrait",["game/gameobject/trait/interface/NotifyUnspawn"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class{constructor(e){this.gameObject=e}getOriginalOwner(){return this.prevOwner}isActive(){return!!this.controller}getController(){return this.controller}controlBy(e,t){if(this.controller)throw new Error(`Object "${this.gameObject?.name}" is already mind controlled by "${e.name}"`);this.controller=e,this.prevOwner=this.gameObject.owner,t.changeObjectOwner(this.gameObject,e.owner)}restore(e){this.prevOwner&&(e.changeObjectOwner(this.gameObject,this.prevOwner),this.prevOwner=void 0,this.controller=void 0)}[i.NotifyUnspawn.onUnspawn](e,t){this.controller&&(this.controller.mindControllerTrait.cleanTarget(e),!e.isDestroyed&&e.limboData&&this.restore(t))}dispose(){this.gameObject=void 0}},e("MindControllableTrait",r)}}})),System.register("game/gameobject/trait/MindControllerTrait",["game/gameobject/trait/interface/NotifyUnspawn"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class{constructor(e,t=1){this.gameObject=e,this.maxCapacity=t,this.targets=[]}isActive(){return 0<this.targets.length}isAtCapacity(){return this.targets.length===this.maxCapacity}getTargets(){return this.targets}control(e,t){if(!this.gameObject)throw new Error("Trait already disposed");if(!e.mindControllableTrait)throw new Error(`Target "${e.name}" cannot be mind controlled`);if(e.isDisposed)throw new Error(`Target "${e.name}" is disposed`);for(e.mindControllableTrait.controlBy(this.gameObject,t),this.targets.push(e);this.targets.length>this.maxCapacity;){this.targets.shift().mindControllableTrait.restore(t)}}cleanTarget(e){var t=this.targets.indexOf(e);-1!==t&&this.targets.splice(t,1)}[i.NotifyUnspawn.onUnspawn](e,t){for(var i of this.targets)i.mindControllableTrait.restore(t);this.targets.length=0}dispose(){this.gameObject=void 0}},e("MindControllerTrait",r)}}})),System.register("game/gameobject/trait/TemporalTrait",["game/gameobject/common/DeathType","game/gameobject/task/AttackTask","game/gameobject/task/move/MoveTask","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class{constructor(e){this.gameObject=e,this.ticksWhenWarpedOut=!0,this.attackers=new Set}[a.NotifyTick.onTick](e,t){if(e.attackTrait&&(e.attackTrait.currentTarget&&!e.warpedOutTrait.isActive()||this.releaseCurrentTarget(t)),void 0!==this.eraseTicks)for(var r of this.attackers){var s=r.temporalTrait.currentWeapon;if(!s)throw new Error(`Attacker "${r.name}" is no longer targeting "${e.name}"`);var n=s.rules.damage;if(this.eraseTicks-=n,this.eraseTicks<=0){e.deathType=i.DeathType.Temporal,t.destroyObject(e,{player:r.owner,obj:r,weapon:s},!0),this.eraseTicks=void 0;break}}}getTarget(){return this.currentTarget}updateTarget(e,t,i){if(this.currentTarget!==e){this.releaseCurrentTarget(i),this.currentTarget=e,this.currentWeapon=t;var n=e.temporalTrait.attackers.size;if(e.temporalTrait.attackers.add(this.gameObject),!n){e.warpedOutTrait.setActive(!0,!0,i);let t=e.unitOrderTrait.getCurrentTask();(t&&t instanceof r.AttackTask||t instanceof s.MoveTask)&&t.cancel(),e.temporalTrait.eraseTicks=10*e.healthTrait.maxHitPoints}}}releaseCurrentTarget(e){if(this.currentTarget){if(!this.currentTarget.isDisposed){let t=this.currentTarget.temporalTrait.attackers;t.delete(this.gameObject),t.size||(this.currentTarget.warpedOutTrait.expire(e),this.currentTarget.temporalTrait.eraseTicks=void 0)}this.currentTarget=void 0,this.currentWeapon=void 0}}[n.NotifyDestroy.onDestroy](e,t){this.releaseCurrentTarget(t)}dispose(){this.gameObject=void 0,this.attackers.clear()}},e("TemporalTrait",o)}}})),System.register("game/gameobject/trait/AirSpawnTrait",["game/Coords","engine/type/ObjectType","game/Warhead","game/gameobject/unit/CollisionType","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/task/system/TaskGroup","game/gameobject/unit/FacingUtil","game/gameobject/trait/interface/NotifyDestroy","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyWarpChange","game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){T=class{constructor(){this.spawns=[],this.storage=[],this.missileLaunches=[],this.nextRegenTicks=[]}get availableSpawns(){return this.storage.length}debugSetStorage(e,t){this.storage.length=t,this.storage.fill(e,0,t)}isLaunchingMissiles(){return 0<this.missileLaunches.length}[d.NotifySpawn.onSpawn](e,t){var i=t.rules.getObject(e.rules.spawns,r.ObjectType.Aircraft);for(let r=0;r<e.rules.spawnsNumber;r++)this.pushNewSpawn(i,t,e)}[m.NotifyUnspawn.onUnspawn](e,t){this.destroySpawns(e,t)}[h.NotifyDestroy.onDestroy](e,t,i,r){this.destroySpawns(e,t,i,r)}pushNewSpawn(e,t,i){let r=t.createUnitForPlayer(e,i.owner);r.limboData={selected:!1,controlGroup:void 0},e.missileSpawn&&(r.pitch=90*t.rules.general.getMissileRules(e.name).pitchInitial),this.spawns.push(r),this.storage.push(r)}destroySpawns(e,t,i,r){for(var s of this.spawns)s.isDestroyed||(s.isSpawned&&!s.rules.missileSpawn&&s.crashableTrait?s.crashableTrait.crash(i):(s.isSpawned||(s.armedTrait&&(s.armedTrait.deathWeapon=void 0),s.position.tileElevation=e.position.tileElevation,s.zone=e.isUnit()?e.zone:y.ZoneType.Ground,s.onBridge=!!e.isUnit()&&e.onBridge,s.position.tile=e.tile),t.destroyObject(s,i,r)));this.spawns.length=0,this.storage.length=0,this.missileLaunches.length=0}[p.NotifyTick.onTick](e,t){var s;if(this.spawns=this.spawns.filter((e=>!e.isDestroyed)),this.missileLaunches=this.missileLaunches.filter((e=>!e.missile.isDestroyed)),this.spawns.length<e.rules.spawnsNumber){var h=e.rules.spawnsNumber-this.spawns.length,u=t.rules.getObject(e.rules.spawns,r.ObjectType.Aircraft);for(let i=0;i<h;i++)u.missileSpawn&&i&&void 0===this.nextRegenTicks[i]?this.nextRegenTicks[i]=this.nextRegenTicks[0]:((s=this.nextRegenTicks)[i]??(s[i]=e.rules.spawnRegenRate),0<this.nextRegenTicks[i]&&this.nextRegenTicks[i]--),this.nextRegenTicks[i]<=0&&this.pushNewSpawn(u,t,e);this.nextRegenTicks=this.nextRegenTicks.filter((e=>0<e))}if(this.storage.length){if(this.nextReloadTicks??(this.nextReloadTicks=e.rules.spawnReloadRate),0<this.nextReloadTicks&&this.nextReloadTicks--,this.nextReloadTicks<=0){for(var d of this.storage)d.ammoTrait&&d.ammoTrait.ammo<d.ammoTrait.maxAmmo&&d.ammoTrait.ammo++;this.nextReloadTicks=e.rules.spawnReloadRate}}else this.nextReloadTicks=void 0;for(let r of this.missileLaunches.slice()){var g=t.rules.general.getMissileRules(r.missile.name);if(r.pauseFrames??(r.pauseFrames=g.pauseFrames),0<r.pauseFrames&&r.pauseFrames--,r.pauseFrames<=0){var p=90*g.pitchFinal;g=90*(g.pitchFinal-g.pitchInitial)/g.tiltFrames;let s=r.missile;if(s.pitch<p)s.pitch=Math.min(p,s.pitch+g);else{if(s.unitOrderTrait.addTask(new l.TaskGroup(new a.MoveTask(t,r.targetTile,!!r.targetBridge),new o.CallbackTask((()=>{var a,o;s.isDestroyed||(t.unspawnObject(s),s.dispose(),o=i.Coords.vecGroundToWorld(c.FacingUtil.toMapCoords(s.direction).multiplyScalar(1)),a=r.targetWorldPos.clone().add(o),o=t.map.getTileZone(r.targetTile),r.warhead.detonate(t,r.damage,r.targetTile,r.targetBridge?.tileElevation??0,a,o,r.targetBridge?n.CollisionType.OnBridge:n.CollisionType.None,r.target,{player:s.owner,obj:e,weapon:void 0},!1,!1,void 0))}))).setCancellable(!1)),-1===(g=this.spawns.indexOf(s)))throw new Error("Missile not found in spawns list");this.spawns.splice(g,1),this.missileLaunches.splice(this.missileLaunches.indexOf(r),1)}}}}[u.NotifyOwnerChange.onChange](e,t,i){for(var r of this.spawns)r.isDestroyed||i.changeObjectOwner(r,e.owner)}[f.NotifyWarpChange.onChange](e,t,i){i&&this.removeMissileLaunches(t)}[g.NotifyTeleport.onBeforeTeleport](e,t,i,r){r||this.removeMissileLaunches(t)}removeMissileLaunches(e){if(this.missileLaunches.length){for(var t of this.missileLaunches){if(e.unspawnObject(t.missile),t.missile.dispose(),-1===(t=this.spawns.indexOf(t.missile)))throw new Error("Missile not found in spawns list");this.spawns.splice(t,1)}this.missileLaunches.length=0}}prepareLaunch(e,t,i){if(this.storage.length){let a=this.storage[0];if(!a.ammo)return;if(this.storage.shift(),a.missileSpawnTrait){let o,l;var r=e.veteranTrait?.isElite(),n=i.rules;if(e.rules.spawns===n.general.v3Rocket.type)o=r?n.combatDamage.v3EliteWarhead:n.combatDamage.v3Warhead,l=r?n.general.v3Rocket.eliteDamage:n.general.v3Rocket.damage;else{if(e.rules.spawns!==n.general.dMisl.type)throw new Error(`Unhandled missile type "${e.rules.spawns}"`);o=r?n.combatDamage.dMislEliteWarhead:n.combatDamage.dMislWarhead,l=r?n.general.dMisl.eliteDamage:n.general.dMisl.damage}n=new s.Warhead(i.rules.getWarhead(o)),a.missileSpawnTrait.setDamage(l).setWarhead(n).setLauncher(e),this.missileLaunches.push({missile:a,targetTile:(t.obj?.isUnit()?t.obj:t).tile,targetBridge:t.getBridge(),targetWorldPos:t.getWorldCoords().clone(),target:t,warhead:n,damage:l,pauseFrames:void 0})}else{if(!a.spawnLinkTrait)throw new Error(`Aircraft "${a.name}" must have Spawned=yes to be launchable`);a.spawnLinkTrait.setParent(e)}return a}}storeAircraft(e,t){if(!this.spawns.includes(e))throw new Error(`Object "${e.name}#${e.id}" not found in list of linked spawns`);if(e.limboData)throw new Error(`Object "${e.name}#${e.id}" is already in limbo`);t.limboObject(e,{selected:!1,controlGroup:void 0}),this.storage.push(e)}},e("AirSpawnTrait",T)}}})),System.register("game/gameobject/trait/SpawnDebrisTrait",["engine/type/ObjectType","game/gameobject/common/DeathType","game/gameobject/trait/interface/NotifyCrash","game/gameobject/trait/interface/NotifyDestroy"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class{[s.NotifyCrash.onCrash](e,t){this.handleDestroy(e,t)}[n.NotifyDestroy.onDestroy](e,t,i){i?.weapon?.warhead.rules.temporal||e.isCrashing||e.deathType!==r.DeathType.Sink&&e.isSpawned&&this.handleDestroy(e,t)}handleDestroy(e,t){var i,r;(e.isVehicle()||e.isBuilding()||e.isOverlay())&&(i=e.isOverlay()?0:e.rules.minDebris,r=e.isOverlay()?t.rules.general.bridgeVoxelMax:e.rules.maxDebris,0<(r=t.generateRandomInt(i,r))&&this.spawnDebris(e,t,r))}spawnDebris(e,t,r){let s=e.position.getMapPosition();if(t.map.isWithinHardBounds(s)){let n=e.isOverlay()?[]:e.isVehicle()?e.rules.debrisTypes:e.rules.debrisAnims;n.length||(n=t.rules.audioVisual.metallicDebris),n=n.filter((e=>t.rules.hasObject(e,i.ObjectType.VoxelAnim)||t.art.hasObject(e,i.ObjectType.Animation))),new Array(r).fill(0).map((()=>n[t.generateRandomInt(0,n.length-1)])).map((e=>t.createObject(i.ObjectType.Debris,e))).forEach((i=>{i.position.moveToLeptons(s),i.position.tileElevation=e.position.tileElevation,t.spawnObject(i,i.position.tile)}))}}},e("SpawnDebrisTrait",a)}}})),System.register("game/gameobject/Debris",["game/gameobject/GameObject","engine/type/ObjectType","game/gameobject/unit/ZoneType","game/Warhead","game/gameobject/unit/FacingUtil","game/gameobject/common/AnimTerrainEffect","game/gameobject/unit/CollisionHelper","game/gameobject/unit/CollisionType","game/math/Vector3","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.GameObject{constructor(e,t,i,n){super(r.ObjectType.Debris,e,t,i),this.age=0,this.direction=0,this.rotationAxis=new h.Vector3,this.angularVelocity=0,this.zone=s.ZoneType.Air,this.velocity=new h.Vector3,this.collisionHelper=new l.CollisionHelper(n)}static factory(e,t,i,r){return new this(e,t,i,r)}onSpawn(e){super.onSpawn(e),this.direction=e.generateRandomInt(0,359),this.xySpeed=u.lerp(0,this.rules.maxXYVel,e.generateRandom()),this.zSpeed=u.lerp(this.rules.minZVel,this.rules.maxZVel||1.5*this.rules.minZVel,e.generateRandom()),this.rotationAxis.set(e.generateRandom(),e.generateRandom(),e.generateRandom()).normalize(),this.angularVelocity=u.lerp(this.rules.minAngularVelocity,this.rules.maxAngularVelocity,e.generateRandom())}update(e){if(super.update(e),this.age++,this.rules.duration&&this.age>this.rules.duration)return this.velocity.set(0,0,0),void this.detonate(e);--this.zSpeed;var t=a.FacingUtil.toMapCoords(this.direction).setLength(this.xySpeed);let i=new h.Vector3(t.x,this.zSpeed,t.y);var r=this.position.clone();t=i.clone().add(this.position.worldPosition);if(e.map.isWithinHardBounds(t)){this.position.moveByLeptons3(i);let t=!1;(r=this.collisionHelper.checkCollisions(this.position,r,{cliffs:!0,ground:!0,shore:!1,walls:!0,buildings:!1}))&&(!([c.CollisionType.Ground,c.CollisionType.OnBridge].includes(r)&&0<this.rules.elasticity&&e.map.getTileZone(this.tile)!==s.ZoneType.Water)||Math.abs(this.zSpeed)<1?t=!0:(this.zSpeed=-this.zSpeed*this.rules.elasticity,this.velocity.y=-this.velocity.y*this.rules.elasticity,this.rotationAxis.negate())),t?(this.velocity.set(0,0,0),this.detonate(e,r)):this.velocity.copy(i)}else e.unspawnObject(this)}detonate(e,t=c.CollisionType.None){var i,r=this.rules.warhead?e.rules.getWarhead(this.rules.warhead):void 0,a=this.zone=this.collisionHelper.computeDetonationZone(this.tile,this.tileElevation,t);let l;a===s.ZoneType.Water?l=(i=e.rules.combatDamage.splashList)[0]:(i=this.rules.expireAnim)&&e.rules.animationNames.has(i)&&(l=i),this.explodeAnim=l;let h=new o.AnimTerrainEffect;if(l&&h.spawnSmudges(l,this.tile,e),e.destroyObject(this),r){new n.Warhead(r).detonate(e,this.rules.damage,this.tile,this.tileElevation,this.position.worldPosition,a,t,e.createTarget(void 0,this.tile),void 0,!1,!1,void 0,this.rules.damageRadius||void 0,!0)}}},e("Debris",d)}}})),System.register("game/gameobject/ObjectFactory",["engine/type/ObjectType","game/gameobject/Building","game/gameobject/Terrain","game/gameobject/Overlay","game/gameobject/Smudge","game/gameobject/Infantry","game/gameobject/Vehicle","game/gameobject/Aircraft","game/art/ObjectArt","data/IniSection","game/gameobject/trait/UnitOrderTrait","game/gameobject/ObjectPosition","game/gameobject/trait/AttackTrait","game/gameobject/Projectile","game/gameobject/trait/DeployerTrait","game/gameobject/trait/HealthTrait","game/gameobject/trait/BridgeTrait","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait","game/gameobject/trait/TiberiumTreeTrait","game/gameobject/trait/AutoRepairTrait","game/gameobject/trait/VeteranTrait","game/gameobject/trait/ArmedTrait","game/gameobject/trait/SelfHealingTrait","game/gameobject/trait/AmmoTrait","game/gameobject/trait/DisguiseTrait","game/gameobject/trait/InvulnerableTrait","game/gameobject/trait/WarpedOutTrait","game/gameobject/trait/TntChargeTrait","game/gameobject/trait/MindControllableTrait","game/gameobject/trait/MindControllerTrait","game/gameobject/trait/TemporalTrait","game/gameobject/trait/CloakableTrait","game/gameobject/trait/AirSpawnTrait","game/gameobject/trait/SpawnDebrisTrait","game/gameobject/Debris","game/rules/DebrisRules","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/SensorsTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e}],execute:function(){e("ObjectFactory",class{constructor(e,t,i,r){this.tiles=e,this.tileOccupation=t,this.bridges=i,this.nextObjectId=r}create(e,t,V,W){let z,K,q;switch(e===i.ObjectType.Debris?z=V.hasObject(t,i.ObjectType.VoxelAnim)?(K=W.getObject(t,i.ObjectType.VoxelAnim),V.getObject(t,i.ObjectType.VoxelAnim)):(K=W.getAnimation(t),new U.DebrisRules(i.ObjectType.Debris,W.getIni().getOrCreateSection(t))):K=e===i.ObjectType.Projectile?(z=V.getProjectile(t),z.inviso?new h.ObjectArt(i.ObjectType.Projectile,z,new u.IniSection(t)):W.getProjectile(t)):(z=V.getObject(t,e),W.getObject(t,e)),e){case i.ObjectType.Building:q=r.Building.factory(t,z,V,K,this.tiles,this.bridges);break;case i.ObjectType.Infantry:q=o.Infantry.factory(t,z,K,this.tileOccupation);break;case i.ObjectType.Vehicle:q=l.Vehicle.factory(t,z,K,V,this.tileOccupation);break;case i.ObjectType.Aircraft:q=c.Aircraft.factory(t,z,K,V,this.tileOccupation);break;case i.ObjectType.Terrain:q=s.Terrain.factory(t,z,K);break;case i.ObjectType.Overlay:q=n.Overlay.factory(t,z,K);break;case i.ObjectType.Smudge:q=a.Smudge.factory(t,z,K);break;case i.ObjectType.Projectile:q=m.Projectile.factory(t,z,K,this.tileOccupation);break;case i.ObjectType.Debris:q=_.Debris.factory(t,z,K,this.tileOccupation);break;default:throw new Error("Not implemented")}if(q.id=this.nextObjectId.value++,q.position=new g.ObjectPosition(this.tiles,this.tileOccupation),q.isUnit()?q.position.subCell=0:q.isBuilding()&&q.position.setCenterOffset(q.getFoundationCenterOffset()),q.isTechno()&&((q.rules.primary||q.rules.secondary||q.rules.weaponCount||q.rules.explodes)&&(q.armedTrait=new O.ArmedTrait(q,V),q.traits.add(q.armedTrait)),-1!==q.rules.ammo&&($=q.rules.initialAmmo,q.ammoTrait=new M.AmmoTrait(q.rules.ammo,-1!==$?$:void 0),q.traits.add(q.ammoTrait)),q.unitOrderTrait=new d.UnitOrderTrait(q),q.traits.addToFront(q.unitOrderTrait),(q.primaryWeapon||q.secondaryWeapon)&&(q.attackTrait=new p.AttackTrait(this.tiles,this.tileOccupation),q.traits.add(q.attackTrait)),(q.isInfantry()||q.isVehicle())&&q.rules.deployer&&(q.deployerTrait=new f.DeployerTrait(q),q.traits.add(q.deployerTrait)),(q.isInfantry()||q.isVehicle())&&q.rules.canDisguise&&(q.disguiseTrait=new R.DisguiseTrait,q.traits.add(q.disguiseTrait)),q.rules.cloakable&&(q.cloakableTrait=new L.CloakableTrait(q,V.general.cloakDelay),q.traits.add(q.cloakableTrait)),q.rules.sensors&&(q.sensorsTrait=new G.SensorsTrait,q.traits.add(q.sensorsTrait)),q.autoRepairTrait=new E.AutoRepairTrait(!q.isBuilding()),q.traits.add(q.autoRepairTrait),q.rules.trainable&&(q.veteranTrait=new x.VeteranTrait(q,V.general.veteran),q.traits.add(q.veteranTrait)),q.rules.selfHealing&&q.traits.add(new A.SelfHealingTrait),q.invulnerableTrait=new P.InvulnerableTrait,q.traits.add(q.invulnerableTrait),q.warpedOutTrait=new I.WarpedOutTrait(q),q.traits.add(q.warpedOutTrait),q.temporalTrait=new N.TemporalTrait(q),q.traits.add(q.temporalTrait),q.rules.bombable&&(q.tntChargeTrait=new k.TntChargeTrait,q.traits.add(q.tntChargeTrait)),q.rules.immuneToPsionics||q.isBuilding()||(q.mindControllableTrait=new B.MindControllableTrait(q),q.traits.add(q.mindControllableTrait)),[q.primaryWeapon,q.secondaryWeapon].some((e=>e?.warhead.rules.mindControl))&&(q.mindControllerTrait=new j.MindControllerTrait(q),q.traits.add(q.mindControllerTrait)),q.rules.spawns&&(q.airSpawnTrait=new D.AirSpawnTrait,q.traits.add(q.airSpawnTrait)),q.rules.maxDebris&&q.traits.add(new F.SpawnDebrisTrait)),q.isTechno()||q.isOverlay()||q.isTerrain()){var $=q.isOverlay()&&v.BridgeOverlayTypes.isBridge(V.getOverlayId(q.name));let e=q.rules.strength;!e&&q.isTerrain()&&(e=V.general.treeStrength),$&&(e=V.combatDamage.bridgeStrength),(e||q.isTechno())&&(q.healthTrait=new y.HealthTrait(e,q,V.audioVisual.conditionYellow,V.audioVisual.conditionRed),q.traits.add(q.healthTrait)),q.isOverlay()&&$&&(q.bridgeTrait=new T.BridgeTrait(this.bridges),q.traits.add(q.bridgeTrait),v.BridgeOverlayTypes.getOverlayBridgeType(V.getOverlayId(q.name))===v.OverlayBridgeType.Concrete&&q.traits.add(new F.SpawnDebrisTrait))}return q.isOverlay()&&q.isOverlay()&&b.OreOverlayTypes.getOverlayTibType(V.getOverlayId(q.name))!==S.OverlayTibType.NotSpecial&&q.traits.add(new w.TiberiumTrait(q)),q.isTerrain()&&q.rules.spawnsTiberium&&q.traits.add(new C.TiberiumTreeTrait(q.rules)),q.cachedTraits.tick.push(...q.traits.filter(H.NotifyTick)),q}})}}})),System.register("game/PlayerList",["game/SideType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PlayerList",class{constructor(){this.players=[]}addPlayer(e){this.players.push(e)}getPlayerAt(e){if(e>=this.players.length)throw new RangeError(`Player #${e} out of bounds`);return this.players[e]}getPlayerByName(e){var t=this.players.find((t=>t.name===e));if(!t)throw new Error(`Player with name "${e}" not found`);return t}getPlayerNumber(e){var t=this.players.indexOf(e);if(-1===t)throw new Error(`Player ${e.name} not found`);return t}getCombatants(){return this.players.filter((e=>e.isCombatant()))}getNonNeutral(){return this.players.filter((e=>!e.isNeutral))}getCivilian(){return this.players.find((e=>e.country?.side===i.SideType.Civilian))}getAll(){return this.players}})}}})),System.register("game/Alliances",["util/math"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;r=class{constructor(e,t){this.first=e,this.second=t}has(e){return this.first===e||this.second===e}equals(e){return this.first===e.first&&this.second===e.second||this.first===e.second&&this.second===e.first}},(t=s=s||{})[t.Requested=0]="Requested",t[t.Formed=1]="Formed",e("AllianceStatus",s),e("Alliances",class{constructor(e){this.playerList=e,this.alliances=[]}findByPlayers(e,t){let i=new r(e,t);return this.alliances.find((e=>e.players.equals(i)))}filterByPlayer(e){return this.alliances.filter((t=>t.players.first===e||t.players.second===e))}request(e,t){if(!this.canRequestAlliance(t))throw new Error(`Player ${t.name} is not a human combatant.`);if(this.canFormAlliance(e,t)){if(this.findByPlayers(e,t))throw new Error(`Can't request alliance because an alliance is already pending or formed between ${e.name} and ${t.name}.`);return this.setAlliance(e,t,s.Requested)}}cancelRequest(e,t){var i=this.findByPlayers(e,t);if(!i||i.status!==s.Requested)throw new Error(`There is no pending alliance request for player ${t.name} from player `+e.name);if(i.players.first!==e)throw new Error(`Can't cancel request initiated by the other player (${t.name})`);this.alliances.splice(this.alliances.indexOf(i),1)}acceptRequest(e,t){if(this.canFormAlliance(e,t)){let i=this.findByPlayers(e,t);if(!i||i.status!==s.Requested)throw new Error(`There is no pending alliance request for player ${t.name} from player `+e.name);if(i.players.first!==e)throw new Error("Can't accept own alliance request for player "+t.name);i.status=s.Formed}}setAlliance(e,t,i){if(!this.canFormAlliance(e,t))throw new Error(`Can't form alliance between players "${e.name}" and "${t.name}"`);var s;if(this.findByPlayers(e,t))throw new Error(`An alliance already exists between players ${e.name} and `+t.name);return s={players:new r(e,t),status:i},this.alliances.push(s),s}breakAlliance(e,t){var i=this.findByPlayers(e,t);if(!i||i.status!==s.Formed)throw new Error(`There is no alliance between player ${e.name} and player `+t.name);this.alliances.splice(this.alliances.indexOf(i),1)}areAllied(e,t){var i=this.findByPlayers(e,t);return!!i&&i.status===s.Formed}getAllies(e){return this.filterByPlayer(e).filter((e=>e.status===s.Formed)).map((t=>t.players.first===e?t.players.second:t.players.first))}haveSharedIntel(e,t){return e.isObserver||t.isObserver||e===t||this.areAllied(e,t)}canRequestAlliance(e){return e.isCombatant()&&!e.isAi}canFormAlliance(e,t){let i=this.getHostilePlayers();if(0===i.filter((i=>i.has(e)&&!i.has(t))).length)return!1;if(0===i.filter((i=>i.has(t)&&!i.has(e))).length)return!1;let s=new r(e,t);return!!i.filter((e=>!e.equals(s))).length}getHostilePlayers(){var e,t=this.playerList.getCombatants();let i=[];for(let s=0;s<t.length;s++)for(let n=s+1;n<t.length;n++)this.getAllies(t[s]).includes(t[n])||(e=new r(t[s],t[n]),i.push(e));return i}getHash(){return i.fnv32a(this.alliances.map((e=>[this.playerList.getPlayerNumber(e.players.first),this.playerList.getPlayerNumber(e.players.second),e.status])).flat())}debugGetState(){return this.alliances.map((e=>({first:e.players.first,second:e.players.second,status:e.status})))}})}}})),System.register("game/gameobject/selection/SelectionLevel",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Hover=1]="Hover",t[t.Selected=2]="Selected",t[t.SelectedHover=3]="SelectedHover",e("SelectionLevel",i)}}})),System.register("game/gameobject/selection/SelectionModel",["game/gameobject/selection/SelectionLevel"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SelectionModel",class{constructor(e){this.selectionLevel=i.SelectionLevel.None,e.isBuilding()&&e.rules.wall?this.maxSelectionLevel=i.SelectionLevel.None:this.maxSelectionLevel=e.rules.selectable?i.SelectionLevel.Selected|i.SelectionLevel.Hover:i.SelectionLevel.Hover}getSelectionLevel(){return this.selectionLevel}setSelectionLevel(e){this.selectionLevel=Math.min(this.maxSelectionLevel,e)}setHover(e){this.setSelectionLevel(e?this.selectionLevel|i.SelectionLevel.Hover:this.selectionLevel&~i.SelectionLevel.Hover)}setSelected(e){this.setSelectionLevel(e?this.selectionLevel|i.SelectionLevel.Selected:this.selectionLevel&~i.SelectionLevel.Selected)}isHovered(){return this.selectionLevel>>i.SelectionLevel.Hover&1}isSelected(){return this.selectionLevel>=i.SelectionLevel.Selected}getControlGroupNumber(){return this.controlGroupNumber}setControlGroupNumber(e){this.controlGroupNumber=e}})}}})),System.register("game/gameobject/selection/SelectionList",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameobject/selection/UnitSelection",["game/gameobject/selection/SelectionModel","util/math"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("UnitSelection",class{constructor(){this.selectedUnits=new Set,this.selectionModelsByUnit=new Map,this.groups=new Map,this.hashNeedsUpdate=!0}getOrCreateSelectionModel(e){let t=this.selectionModelsByUnit.get(e);return t||(t=new i.SelectionModel(e),this.selectionModelsByUnit.set(e,t)),t}deselectAll(){this.selectedUnits.forEach((e=>this.selectionModelsByUnit.get(e)?.setSelected(!1))),this.selectedUnits.clear(),this.hashNeedsUpdate=!0}addToSelection(e){this.selectedUnits.add(e),this.getOrCreateSelectionModel(e).setSelected(!0),this.hashNeedsUpdate=!0}removeFromSelection(e){e.forEach((e=>{this.selectedUnits.delete(e),this.getOrCreateSelectionModel(e).setSelected(!1)})),this.hashNeedsUpdate=!0}getSelectedUnits(){return[...this.selectedUnits].filter((e=>!e.isDestroyed&&!e.isCrashing&&!e.isDisposed&&e.isSpawned))}isSelected(e){return this.selectedUnits.has(e)}cleanupUnit(e){this.selectionModelsByUnit.delete(e),this.selectedUnits.delete(e),this.unassignUnitsFromGroup([e]),this.hashNeedsUpdate=!0}updateHash(){this.hash=r.fnv32a([...this.selectedUnits].map((e=>e.id)))}getHash(){return this.hashNeedsUpdate&&(this.updateHash(),this.hashNeedsUpdate=!1),this.hash}createGroup(e){this.addUnitsToGroup(e,this.getSelectedUnits())}addUnitsToGroup(e,t,i=!0){this.unassignUnitsFromGroup(t);let r=this.groups.get(e);for(var s of(r||(r=new Set,this.groups.set(e,r)),i&&([...r.values()].forEach((e=>this.selectionModelsByUnit.get(e)?.setControlGroupNumber(void 0))),r.clear()),t))r.add(s),this.getOrCreateSelectionModel(s).setControlGroupNumber(e)}addGroupToSelection(e){if(this.groups.has(e))for(var t of[...this.groups.get(e)])this.addToSelection(t)}selectGroup(e){this.deselectAll(),this.addGroupToSelection(e)}getGroupUnits(e){return[...this.groups.get(e)??[]]}unassignUnitsFromGroup(e){for(var t of this.groups.values())for(var i of e)t.delete(i)}})}}})),System.register("game/StartingUnitsGenerator",["engine/type/ObjectType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("StartingUnitsGenerator",class{static generate(e,t,r,s){var n,a=r.reduce(((e,t)=>e+t.cost),0)/r.length*e;let o=[],l=a,c=(r=r.filter((e=>e.isAvailableTo(s)&&e.hasOwner(s)))).filter((e=>t.includes(e.name)));for(n of c){if(l<=0)break;var h=2/3/c.length;l-=(h=Math.ceil(h*a/n.cost))*n.cost,o.push({name:n.name,type:i.ObjectType.Vehicle,count:h})}var u,d=r.filter((e=>!c.includes(e))),g=l/d.length;for(u of d){if(l<=0)break;var p=Math.ceil(g/u.cost);l-=p*u.cost,o.push({name:u.name,type:i.ObjectType.Infantry,count:p})}return o}})}}})),System.register("game/event/GameEvent",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/event/ObjectOwnerChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectOwnerChangeEvent",class{constructor(e,t){this.target=e,this.prevOwner=t,this.type=i.EventType.ObjectOwnerChange}})}}})),System.register("game/event/RadarEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("RadarEvent",class{constructor(e,t,r){this.target=e,this.radarEventType=t,this.tile=r,this.type=i.EventType.RadarEvent}})}}})),System.register("game/event/ObjectDestroyEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectDestroyEvent",class{constructor(e,t,r){this.target=e,this.attackerInfo=t,this.incidental=r,this.type=i.EventType.ObjectDestroy}})}}})),System.register("game/event/LightningStormManifestEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("LightningStormManifestEvent",class{constructor(e){this.target=e,this.type=i.EventType.LightningStormManifest}})}}})),System.register("game/event/LightningStormCloudEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("LightningStormCloudEvent",class{constructor(e){this.position=e,this.type=i.EventType.LightningStormCloud}})}}})),System.register("game/event/SuperWeaponActivateEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SuperWeaponActivateEvent",class{constructor(e,t,r,s,n){this.target=e,this.owner=t,this.atTile=r,this.atTile2=s,this.noSfxWarning=n,this.type=i.EventType.SuperWeaponActivate}})}}})),System.register("game/event/BuildingInfiltrationEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingInfiltrationEvent",class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.BuildingInfiltration}})}}})),System.register("game/event/PingLocationEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PingLocationEvent",class{constructor(e,t){this.tile=e,this.player=t,this.type=i.EventType.PingLocation}})}}})),System.register("game/event/BuildingPlaceEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingPlaceEvent",class{constructor(e){this.target=e,this.type=i.EventType.BuildingPlace}})}}})),System.register("game/event/BuildingFailedPlaceEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingFailedPlaceEvent",class{constructor(e,t,r){this.name=e,this.player=t,this.tile=r,this.type=i.EventType.BuildingFailedPlace}})}}})),System.register("game/event/PlayerResignedEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PlayerResignedEvent",class{constructor(e){this.target=e,this.type=i.EventType.PlayerResigned}})}}})),System.register("game/event/PlayerDisconnectedEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PlayerDroppedEvent",class{constructor(e){this.target=e,this.type=i.EventType.PlayerDropped}})}}})),System.register("game/event/AllianceChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Requested=0]="Requested",t[t.Formed=1]="Formed",t[t.Broken=2]="Broken",e("AllianceEventType",r),e("AllianceChangeEvent",class{constructor(e,t,r){this.alliance=e,this.changeType=t,this.from=r,this.type=i.EventType.AllianceChange}})}}})),System.register("game/event/EventMap",["game/event/EventType"],(function(e,t){"use strict";return t&&t.id,{setters:[function(e){}],execute:function(){}}})),System.register("game/GameEventBus",["util/event"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("GameEventBus",class{constructor(){this.dispatcher=new i.EventDispatcher,this.dispatchersByType=new Map}dispatch(e){this.dispatcher.dispatch(void 0,e),this.dispatchersByType.get(e.type)?.dispatch(void 0,e)}subscribe(e,t){let i,r;return r="function"==typeof e?e:(i=e,t),void 0===i?(this.dispatcher.subscribe(r),()=>this.unsubscribe(r)):this.subscribeType(i,r)}unsubscribe(e,t){let i,r;r="function"==typeof e?e:(i=e,t),void 0===i?this.dispatcher.unsubscribe(r):this.unsubscribeType(i,r)}subscribeType(e,t){let r=this.dispatchersByType.get(e);return r||(r=new i.EventDispatcher,this.dispatchersByType.set(e,r)),r.subscribe(t),()=>this.unsubscribeType(e,t)}unsubscribeType(e,t){this.dispatchersByType.get(e)?.unsubscribe(t)}})}}})),System.register("game/event/PlayerDefeatedEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PlayerDefeatedEvent",class{constructor(e){this.target=e,this.type=i.EventType.PlayerDefeated}})}}})),System.register("game/trait/interface/NotifyTick",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onTick=Symbol(),e("NotifyTick",i)}}})),System.register("game/trait/interface/NotifyDestroy",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onDestroy=Symbol(),e("NotifyDestroy",i)}}})),System.register("game/trait/interface/NotifySpawn",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onSpawn=Symbol(),e("NotifySpawn",i)}}})),System.register("game/event/BuildingSellEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingSellEvent",class{constructor(e){this.target=e,this.type=i.EventType.BuildingSell}})}}})),System.register("game/trait/SellTrait",["game/event/BuildingSellEvent","game/gameobject/trait/interface/NotifySell"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("SellTrait",class{constructor(e,t){this.game=e,this.generalRules=t}sell(e){if(!e.rules.unsellable){let t=this.computeRefundValue(e);t&&(e.rules.wall&&(t=0),e.traits.filter(r.NotifySell).forEach((t=>{t[r.NotifySell.onSell](e,this.game)})),e.isBuilding()?this.game.getConstructionWorker(e.owner).unplace(e,(()=>this.afterObjectUnspawned(e,t))):(this.game.unspawnObject(e),this.afterObjectUnspawned(e,t)))}}afterObjectUnspawned(e,t){e.owner.credits+=t,e.isBuilding()&&this.game.events.dispatch(new i.BuildingSellEvent(e)),e.dispose()}computeRefundValue(e){let t=0;return 0<e.rules.soylent?t=e.rules.soylent:e.rules.cost&&(t=e.purchaseValue,e.owner.isAi||(t=Math.floor(t*this.generalRules.refundPercent))),t}computePurchaseValue(e,t){return e.cost}dispose(){this.game=void 0}})}}})),System.register("game/trait/interface/NotifyUnspawn",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onUnspawn=Symbol(),e("NotifyUnspawn",i)}}})),System.register("game/trait/interface/NotifyOwnerChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyOwnerChange",i)}}})),System.register("game/trait/interface/NotifyAllianceChange",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onChange=Symbol(),e("NotifyAllianceChange",i)}}})),System.register("game/event/RadarOnOffEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("RadarOnOffEvent",class{constructor(e,t){this.target=e,this.radarEnabled=t,this.type=i.EventType.RadarOnOff}})}}})),System.register("game/trait/interface/NotifySuperWeaponActivate",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onActivate=Symbol(),e("NotifySuperWeaponActivate",i)}}})),System.register("game/trait/interface/NotifySuperWeaponDeactivate",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onDeactivate=Symbol(),e("NotifySuperWeaponDeactivate",i)}}})),System.register("game/trait/RadarTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","game/event/RadarOnOffEvent","game/trait/interface/NotifyOwnerChange","game/gameobject/unit/RangeHelper","game/rules/general/RadarRules","game/event/RadarEvent","game/trait/interface/NotifyAttack","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifySuperWeaponActivate","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponDeactivate"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class{constructor(){this.activeLightningStrikes=new Map}[i.NotifySpawn.onSpawn](e,t){e.isBuilding()&&e.rules.radar&&this.updateRadarForPlayer(e.owner,t)}[r.NotifyUnspawn.onUnspawn](e,t){e.isBuilding()&&e.rules.radar&&this.updateRadarForPlayer(e.owner,t)}[s.NotifyPower.onPowerLow](e,t){this.updateRadarForPlayer(e,t)}[s.NotifyPower.onPowerRestore](e,t){this.updateRadarForPlayer(e,t)}[s.NotifyPower.onPowerChange](){}[o.NotifyOwnerChange.onChange](e,t,i){e.rules.radar&&(this.updateRadarForPlayer(t,i),this.updateRadarForPlayer(e.owner,i))}[d.NotifyWarpChange.onChange](e,t){e.rules.radar&&this.updateRadarForPlayer(e.owner,t)}[g.NotifySuperWeaponActivate.onActivate](e,t,i){if(e===p.SuperWeaponType.LightningStorm)for(var r of(this.activeLightningStrikes.set(t,(this.activeLightningStrikes.get(t)??0)+1),i.getCombatants()))r===t||i.alliances.areAllied(r,t)||this.updateRadarForPlayer(r,i)}[m.NotifySuperWeaponDeactivate.onDeactivate](e,t,i){if(e===p.SuperWeaponType.LightningStorm){var r=(this.activeLightningStrikes.get(t)??0)-1;if(0<r?this.activeLightningStrikes.set(t,r):this.activeLightningStrikes.delete(t),r<=0)for(var s of i.getCombatants())this.updateRadarForPlayer(s,i)}}updateRadarForPlayer(e,t){var i,r;e.radarTrait&&(i=e.radarTrait?.isDisabled(),r=![...e.buildings].find((e=>e.rules.radar&&!e.warpedOutTrait.isActive()))||e.powerTrait.level===n.PowerLevel.Low||[...this.activeLightningStrikes.entries()].some((([i,r])=>r&&i!==e&&!t.alliances.areAllied(i,e))),e.radarTrait.setDisabled(r),i!==r&&t.events.dispatch(new a.RadarOnOffEvent(e,!r)))}[u.NotifyAttack.onAttack](e,t,i){e.isTechno()&&(!e.isBuilding()||e.rules.canBeOccupied||e.rules.needsEngineer?e.isVehicle()&&e.harvesterTrait&&this.addEventForPlayer(c.RadarEventType.HarvesterUnderAttack,e.owner,e.tile,i):this.addEventForPlayer(c.RadarEventType.BaseUnderAttack,e.owner,e.tile,i))}addEventForPlayer(e,t,i,r){let s=t.radarTrait;if(s){let n=r.rules.general.radar;s.activeEvents=s.activeEvents.filter((e=>r.currentTick-e.startTick<n.getEventDuration(e.type)));let a=new l.RangeHelper(r.map.tileOccupation);s.activeEvents.find((t=>t.type===e&&a.isInTileRange(i,t.tile,0,n.getEventSuppresionDistance(t.type))))||(s.activeEvents.push({startTick:r.currentTick,tile:i,type:e}),r.events.dispatch(new h.RadarEvent(t,e,i)))}}},e("RadarTrait",f)}}})),System.register("game/trait/MapShroudTrait",["game/map/MapShroud","game/trait/interface/NotifyTick","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyAllianceChange","util/typeGuard","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/RadarTrait","game/rules/general/RadarRules","engine/type/ObjectType","game/trait/interface/NotifyPower","game/trait/interface/NotifyElevationChange"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=class{constructor(e,t){this.map=e,this.alliances=t,this.shroudByPlayer=new Map,this.revealedToAll=new Set,this.gapGenerators=new Set,this.handleTileOccupationUpdate=({object:e,type:t})=>{if("removed"!==t&&e.isTechno()){var i,r=e.owner;for(i of[r,...this.alliances.getAllies(r)])this.shroudByPlayer.get(i)?.revealFrom(e)}}}getPlayerShroud(e){return this.shroudByPlayer.get(e)}init(e){e.map.tileOccupation.onChange.subscribe(this.handleTileOccupationUpdate);let t=(new i.MapShroud).fromTiles(this.map.tiles);for(var r of e.getCombatants()){let i=t.clone();this.shroudByPlayer.set(r,i),this.revealObjects(i,r,e),i.update()}}[g.NotifyElevationChange.onElevationChange](e,t,i){if(Math.floor(e.tileElevation)!==Math.floor(i)){var r,s=e.owner;for(r of[s,...this.alliances.getAllies(s)])this.shroudByPlayer.get(r)?.revealFrom(e)}}[r.NotifyTick.onTick](e){for(var[t,i]of this.shroudByPlayer)t.defeated&&!t.isObserver?this.shroudByPlayer.delete(t):i.update()}[s.NotifyOwnerChange.onChange](e,t,i){if(e.isBuilding()&&e.rules.spySat&&(this.revealMap(e.owner,i),t.getOwnedObjectsByType(u.ObjectType.Building).find((e=>e.rules.spySat))||this.resetShroud(t,i)),e.isSpawned)for(var r of[e.owner,...i.alliances.getAllies(e.owner)])this.shroudByPlayer.get(r)?.revealFrom(e)}[n.NotifyAllianceChange.onChange](e,t,i){if(t){let t=this.getPlayerShroud(e.players.first);var r,s,n=i.alliances.getAllies(e.players.first).map((e=>this.getPlayerShroud(e))).filter(a.isNotNullOrUndefined);for(r of n)t.merge(r);for(s of(t.invalidateFull(),n))s.copy(t),s.invalidateFull()}}[o.NotifySpawn.onSpawn](e,t){if(e.isBuilding()){if(e.rules.spySat&&this.revealMap(e.owner,t),e.rules.revealToAll)for(var i of(this.revealedToAll.add(e),t.getCombatants()))i===e.owner||t.alliances.areAllied(e.owner,i)||(this.shroudByPlayer.get(i)?.revealObject(e),t.traits.get(c.RadarTrait).addEventForPlayer(h.RadarEventType.EnemyObjectSensed,i,e.centerTile,t));e.gapGeneratorTrait&&this.gapGenerators.add(e)}}[l.NotifyUnspawn.onUnspawn](e,t){e.isBuilding()&&(e.rules.spySat&&(e.owner.getOwnedObjectsByType(u.ObjectType.Building).find((e=>e.rules.spySat))||this.resetShroud(e.owner,t)),e.rules.revealToAll&&this.revealedToAll.delete(e),e.gapGeneratorTrait&&this.gapGenerators.delete(e))}[d.NotifyPower.onPowerLow](e,t){this.updateGaps(t,e)}[d.NotifyPower.onPowerRestore](e,t){this.updateGaps(t,e)}[d.NotifyPower.onPowerChange](e,t){}revealMap(e,t){this.shroudByPlayer.get(e)?.revealAll(),this.markOwnGapTiles(t,e),this.updateGaps(t)}resetShroud(e,t){let i=this.shroudByPlayer.get(e);i&&(i.reset(),this.markOwnGapTiles(t,e),this.revealObjects(i,e,t))}revealObjects(e,t,i){var r;for(r of[...t.getOwnedObjects(),...i.alliances.getAllies(t).map((e=>e.getOwnedObjects())).flat()])e.revealFrom(r);this.revealedToAll.forEach((t=>e.revealObject(t)))}updateGaps(e,t){for(var i of this.gapGenerators)t&&i.owner!==t||i.gapGeneratorTrait.update(i,e)}markOwnGapTiles(e,t){for(var r of this.gapGenerators)r.owner!==t&&!e.alliances.areAllied(r.owner,t)||this.getPlayerShroud(t)?.toggleFlagsAround(r.tile,r.gapGeneratorTrait.radiusTiles,i.ShroudFlag.Darken,!0)}dispose(){this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate)}},e("MapShroudTrait",p)}}})),System.register("game/event/ObjectUnspawnEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectUnspawnEvent",class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectUnspawn}})}}})),System.register("game/event/ObjectSpawnEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectSpawnEvent",class{constructor(e){this.gameObject=e,this.type=i.EventType.ObjectSpawn}})}}})),System.register("game/trait/MapRadiationTrait",["game/gameobject/infantry/StanceType","game/gameobject/unit/RangeHelper","game/map/tileFinder/RadialTileFinder","game/Warhead","util/event","util/math","game/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class{constructor(e){this.map=e,this.radSites=new Map,this.radLevelByTile=new Map,this._onChange=new a.EventDispatcher}get onChange(){return this._onChange.asEvent()}getRadLevel(e){return this.radLevelByTile.get(e)}[l.NotifyTick.onTick](e){var t;this.radLevelByTile.size&&(t=e.rules.radiation,void 0===this.nextDamage?this.nextDamage=Math.max(0,t.radApplicationDelay-1):this.nextDamage<=0?(this.applyDamage(e),this.nextDamage=Math.max(0,t.radApplicationDelay)):this.nextDamage--,void 0===this.nextDecay?this.nextDecay=Math.max(0,t.radLevelDelay-1):this.nextDecay<=0?(this.applyDecay(Math.ceil(t.radLevelDelay/t.radDurationMultiple)),this.radLevelByTile.size?this.nextDecay=Math.max(0,t.radLevelDelay):this.nextDecay=void 0):this.nextDecay--)}applyDamage(e){let t=e.rules.radiation,r=new n.Warhead(e.rules.getWarhead(t.radSiteWarhead));this.radLevelByTile.forEach(((s,n)=>{var a,o,l=Math.min(t.radLevelMax,s)*t.radLevelFactor;for(a of e.map.getGroundObjectsOnTile(n).filter((e=>e.isUnit()&&!(e.isInfantry()&&e.stance===i.StanceType.Paradrop&&1<e.tileElevation))))r.canDamage(a,n,a.zone)&&0<(o=r.computeDamage(l,a))&&r.inflictDamage(o,a,void 0,e,!0)}))}applyDecay(e){var t=new Set(this.radLevelByTile.keys());this.radLevelByTile.clear(),this.radSites.forEach((({radLevel:t,radius:i},r)=>{var s=t-e;s<=0?this.radSites.delete(r):(this.radSites.set(r,{radLevel:s,radius:i}),this.setRadLevelAround(r,i,s))})),this._onChange.dispatch(this,t)}createRadSite(e,t,i){var r;(t-=this.radSites.get(e)?.radLevel??0)<=0||(this.radSites.set(e,{radLevel:(this.radSites.get(e)?.radLevel??0)+t,radius:i}),(r=this.setRadLevelAround(e,i,t)).size&&this._onChange.dispatch(this,r))}setRadLevelAround(e,t,i){let n=new r.RangeHelper(this.map.tileOccupation),a=new s.RadialTileFinder(this.map.tiles,this.map.mapBounds,e,{width:1,height:1},0,t,(e=>!!e),!1);var l;let c=new Set;for(;l=a.getNextTile();){var h=n.tileDistance(e,l);h<=t&&(h=Math.ceil(o.lerp(i,0*i,h/t)),this.radLevelByTile.set(l,Math.min(1e3,(this.radLevelByTile.get(l)??0)+h)),c.add(l))}return c}getRadSiteLevel(e){return this.radSites.get(e)?.radLevel}},e("MapRadiationTrait",c)}}})),System.register("util/Serializable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/action/ActionType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NoAction=0]="NoAction",t[t.DropPlayer=1]="DropPlayer",t[t.ObserveGame=2]="ObserveGame",t[t.ResignGame=3]="ResignGame",t[t.DebugCommand=4]="DebugCommand",t[t.PlaceBuilding=5]="PlaceBuilding",t[t.SellBuilding=6]="SellBuilding",t[t.ToggleRepair=7]="ToggleRepair",t[t.SelectUnits=8]="SelectUnits",t[t.OrderUnits=9]="OrderUnits",t[t.UpdateQueue=10]="UpdateQueue",t[t.ToggleAlliance=11]="ToggleAlliance",t[t.ActivateSuperWeapon=12]="ActivateSuperWeapon",t[t.PingLocation=13]="PingLocation",e("ActionType",i)}}})),System.register("game/action/Action",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Action",class{constructor(e){this.actionType=e}unserialize(e){}serialize(){return new Uint8Array}print(){return""}})}}})),System.register("game/action/ActionFactory",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ActionFactory",class{constructor(){this.factories=new Map}registerFactory(e,t){this.factories.set(e,t)}create(e){let t=this.factories.get(e);if(!t)throw new Error("No factory registered for action type "+e);return t.create()}})}}})),System.register("game/action/ActionQueue",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ActionQueue",class{constructor(){this.actions=[]}push(...e){this.actions.push(...e)}getLast(){return this.actions[this.actions.length-1]}dequeueAll(){var e=[...this.actions];return this.actions.length=0,e}dequeueLast(){return this.actions.pop()}clear(){this.actions.length=0}})}}})),System.register("game/trait/interface/NotifyPlaceBuilding",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onPlace=Symbol(),e("NotifyPlaceBuilding",i)}}})),System.register("game/action/PlaceBuildingAction",["game/action/Action","data/DataStream","game/event/BuildingPlaceEvent","game/player/production/ProductionQueue","game/rules/TechnoRules","game/gameobject/trait/FactoryTrait","game/action/ActionType","game/event/BuildingFailedPlaceEvent","game/trait/interface/NotifyPlaceBuilding","engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.Action{constructor(e){super(l.ActionType.PlaceBuilding),this.game=e}unserialize(e){let t=new r.DataStream(e);this.buildingRules=this.game.rules.getTechnoByInternalId(t.readUint32(),u.ObjectType.Building),this.tile={x:t.readUint16(),y:t.readUint16()}}serialize(){let e=new r.DataStream(8);return e.writeUint32(this.buildingRules.index),e.writeUint16(this.tile.x),e.writeUint16(this.tile.y),e.toUint8Array()}print(){return`Place building ${this.buildingRules.name} at tile (${this.tile.x}, ${this.tile.y})`}process(){var e=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(e){var t=this.player;const i=this.tryPlaceBuilding(t,e);i?(this.game.traits.filter(h.NotifyPlaceBuilding).forEach((e=>{e[h.NotifyPlaceBuilding.onPlace](i,this.game)})),this.game.events.dispatch(new s.BuildingPlaceEvent(i))):this.game.events.dispatch(new c.BuildingFailedPlaceEvent(this.buildingRules.name,t,e))}else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}tryPlaceBuilding(e,t){var i=this.buildingRules;if(e.production){let s=e.production.getQueueForObject(i);if(s.status===n.QueueStatus.Ready&&s.getFirst().rules===i){let n=this.game.getConstructionWorker(e);if(e.production.isAvailableForProduction(i)&&n.canPlaceAt(i.name,t,{normalizedTile:!0})){var r=n.placeAt(i.name,t,!0);e.addUnitsBuilt(u.ObjectType.Building,1),s.shift(i,1);let l=e.production.getPrimaryFactory(a.FactoryType.BuildingType);return l&&(l.factoryTrait.status=o.FactoryStatus.Delivering),r[0]}}}}},e("PlaceBuildingAction",d)}}})),System.register("game/action/SellBuildingAction",["game/action/Action","data/DataStream","game/gameobject/Building","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends i.Action{constructor(e){super(n.ActionType.SellBuilding),this.game=e}unserialize(e){this.buildingId=new r.DataStream(e).readUint32()}serialize(){return new r.DataStream(4).writeUint32(this.buildingId).toUint8Array()}print(){return"Sell building "+this.buildingId}process(){var e=this.player;if(this.game.getWorld().hasObjectId(this.buildingId)){let t=this.game.getObjectById(this.buildingId);t.isBuilding()&&(e!==t.owner||t.isDestroyed||t.buildStatus!==s.BuildStatus.Ready||t.warpedOutTrait.isActive()||this.game.sellTrait.sell(t))}}},e("SellBuildingAction",a)}}})),System.register("game/event/BuildingRepairStartEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingRepairStartEvent",class{constructor(e){this.target=e,this.type=i.EventType.BuildingRepairStart}})}}})),System.register("game/action/ToggleRepairAction",["game/action/Action","data/DataStream","game/gameobject/trait/AutoRepairTrait","game/event/BuildingRepairStartEvent","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Action{constructor(e){super(a.ActionType.ToggleRepair),this.game=e}unserialize(e){this.buildingId=new r.DataStream(e).readUint32()}serialize(){return new r.DataStream(4).writeUint32(this.buildingId).toUint8Array()}print(){return"Toggle repair "+this.buildingId}process(){var e=this.player;if(this.game.getWorld().hasObjectId(this.buildingId)){let t=this.game.getObjectById(this.buildingId);if(t.isBuilding()&&e===t.owner&&!t.isDestroyed&&t.rules.repairable&&t.rules.clickRepairable&&100!==t.healthTrait.health){let e=t.traits.get(s.AutoRepairTrait);e.setDisabled(!e.isDisabled()),e.isDisabled()||this.game.events.dispatch(new n.BuildingRepairStartEvent(t))}}}},e("ToggleRepairAction",o)}}})),System.register("game/action/ToggleAllianceAction",["game/action/Action","game/Alliances","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Action{constructor(e){super(a.ActionType.ToggleAlliance),this.game=e}unserialize(e){this.toPlayer=this.game.getPlayer(e[0]),this.toggle=Boolean(e[1])}serialize(){return new Uint8Array([this.game.getPlayerNumber(this.toPlayer),this.toggle?1:0])}print(){return`Toggle alliance ${this.toggle?"on":"off"} with `+this.toPlayer.name}process(){if((a=this.game.rules.mpDialogSettings).alliesAllowed&&a.allyChangeAllowed){var e,t=this.player,i=this.toPlayer,a=this.toggle;let o=t,l=i,c=this.game.alliances;if(!t.defeated&&c.canRequestAlliance(l)){let i=c.findByPlayers(o,l);i?i.status===r.AllianceStatus.Formed?a||(c.breakAlliance(o,l),this.game.onAllianceChange(i,o,!1)):i.status===r.AllianceStatus.Requested&&(i.players.first===l?a&&c.canFormAlliance(o,l)&&(c.acceptRequest(l,o),this.game.onAllianceChange(i,o,!0),1!==(t=this.game.getCombatants().filter((e=>e!==o&&!c.areAllied(o,e)))).length||(e=c.findByPlayers(t[0],o))&&c.cancelRequest(e.players.first,e.players.second),1!==(e=this.game.getCombatants().filter((e=>e!==l&&!c.areAllied(l,e)))).length||(e=c.findByPlayers(e[0],l))&&c.cancelRequest(e.players.first,e.players.second)):a||(c.cancelRequest(o,l),this.game.events.dispatch(new s.AllianceChangeEvent(i,s.AllianceEventType.Broken,o)),this.game.traits.filter(n.NotifyAllianceChange).forEach((e=>{e[n.NotifyAllianceChange.onChange](i,!1,this.game)})))):a&&c.canFormAlliance(o,l)&&(a=c.request(o,l))&&this.game.events.dispatch(new s.AllianceChangeEvent(a,s.AllianceEventType.Requested,o))}}}},e("ToggleAllianceAction",o)}}})),System.register("game/action/UpdateQueueAction",["game/action/Action","data/DataStream","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.Add=0]="Add",t[t.Cancel=1]="Cancel",t[t.Pause=2]="Pause",t[t.Resume=3]="Resume",e("UpdateType",o),l=class extends i.Action{constructor(e){super(a.ActionType.UpdateQueue),this.game=e}unserialize(e){let t=new r.DataStream(e);var i,s;this.queueType=t.readUint8(),this.updateType=t.readUint8(),this.updateType!==o.Add&&this.updateType!==o.Cancel||(i=t.readUint32(),s=t.readUint8(),this.item=this.game.rules.getTechnoByInternalId(i,s),this.quantity=t.readUint16())}serialize(){let e=new r.DataStream(9);if(e.dynamicSize=!1,e.writeUint8(this.queueType),e.writeUint8(this.updateType),this.updateType===o.Add||this.updateType===o.Cancel){if(void 0===this.quantity)throw new Error("Missing quantity");if(65535<this.quantity)throw new Error("Maximum quantity exceeded");e.writeUint32(this.item.index),e.writeUint8(this.item.type),e.writeUint16(this.quantity)}return new Uint8Array(e.buffer,e.byteOffset,e.position)}print(){return this.updateType===o.Resume?"Resume queue "+s.QueueType[this.queueType]:this.updateType===o.Add?`Add to queue ${this.item.name} x `+this.quantity:this.updateType===o.Pause?`Put queue ${s.QueueType[this.queueType]} on hold.`:this.updateType===o.Cancel?`Cancel ${this.item.name} x `+this.quantity:"Unhandled queue update type "+this.updateType}process(){let e=this.player,t=this.item,i=e.production.getQueue(this.queueType);if(this.updateType===o.Resume)i.status===s.QueueStatus.OnHold&&(i.status=s.QueueStatus.Active);else if(this.updateType===o.Add){let o=i.find(t);var r,a;(i.status===s.QueueStatus.Active||i.status===s.QueueStatus.Idle||i.status===s.QueueStatus.OnHold&&o[0]!==i.getFirst()||i.status===s.QueueStatus.Ready&&t.type!==n.ObjectType.Building)&&(r=o.reduce(((e,t)=>e+t.quantity),0),a=e.getOwnedObjectsByType(t.type,!0).filter((e=>e.name===t.name)).length,(a=Number.isFinite(t.buildLimit)?Math.max(0,t.buildLimit-(a+r)):Number.POSITIVE_INFINITY)&&e.production.isAvailableForProduction(t)&&(l=Math.min(i.maxSize-i.currentSize,i.maxItemQuantity-r,a),0<(c=Math.min(this.quantity,l))&&i.push(t,c,t.cost)))}else if(this.updateType===o.Cancel){if([s.QueueStatus.Ready,s.QueueStatus.OnHold,s.QueueStatus.Active].includes(i.status)){let r=i.find(t);var l,c;r.length&&(l=r.reduce(((e,t)=>e+t.quantity),0),0<(c=Math.min(l,this.quantity))&&(i.pop(t,c),c===l&&(e.credits+=r[0].creditsSpent)))}}else this.updateType===o.Pause&&i.status===s.QueueStatus.Active&&(i.status=s.QueueStatus.OnHold)}},e("UpdateQueueAction",l)}}})),System.register("game/gameobject/selection/UnitSelectionLite",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("UnitSelectionLite",class{constructor(e){this.player=e,this.selectedUnits=new Set}update(e){var t,i=[...e].reverse().find((e=>e.owner!==this.player));for(t of(i&&(e=[i]),this.selectedUnits.clear(),e))t.rules.selectable&&this.selectedUnits.add(t)}getSelectedUnits(){return[...this.selectedUnits].filter((e=>!e.isDestroyed&&!e.isCrashing))}isSelected(e){return this.selectedUnits.has(e)}})}}})),System.register("game/action/OrderActionContext",["game/gameobject/selection/UnitSelectionLite"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("OrderActionContext",class{constructor(){this.unitSelectionByPlayer=new Map}getOrCreateSelection(e){let t=this.unitSelectionByPlayer.get(e);return t||(t=new i.UnitSelectionLite(e),this.unitSelectionByPlayer.set(e,t)),t}})}}})),System.register("game/event/ObjectMorphEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObjectMorphEvent",class{constructor(e,t){this.from=e,this.to=t,this.type=i.EventType.ObjectMorph}})}}})),System.register("game/gameobject/task/morph/MorphIntoTask",["game/gameobject/task/system/Task","engine/type/ObjectType","game/gameobject/Building","game/gameobject/task/move/MoveTask","game/event/ObjectMorphEvent","game/gameobject/task/TurnTask","game/gameobject/task/morph/PackBuildingTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends i.Task{constructor(e){super(),this.game=e}onStart(e){if(!this.morphInto)throw new Error("morphInto not set");e.isBuilding()&&e.buildStatus!==s.BuildStatus.BuildDown&&this.morphInto.type!==r.ObjectType.Building&&this.children.push(new l.PackBuildingTask),e.isVehicle()&&this.morphInto.type===r.ObjectType.Building&&this.children.push(new o.TurnTask(180))}onTick(e){if(!this.morphInto)throw new Error("morphInto not set");let t=this.game.getUnitSelection();var i=t.isSelected(e),s=t.getOrCreateSelectionModel(e).getControlGroupNumber();let o;if(this.morphInto.type===r.ObjectType.Building){if(e.isVehicle()&&e.parasiteableTrait?.isInfested())return!0;var l=e.tile;let t=this.game.getConstructionWorker(e.owner);if(!t.canPlaceAt(this.morphInto.name,l,{ignoreAdjacent:!0,ignoreObjects:[e]}))return!0;this.game.unspawnObject(e),e.dispose(),[o]=t.placeAt(this.morphInto.name,l),o.healthTrait.health=e.healthTrait.health}else{let t=e.unitOrderTrait.getTasks().filter((e=>e instanceof n.MoveTask));this.game.unspawnObject(e),e.dispose(),o=this.game.createUnitForPlayer(this.morphInto,e.owner),o.direction=180,o.healthTrait.health=e.healthTrait.health,l=e.art.foundationCenter,this.game.spawnObject(o,this.game.map.tiles.getByMapCoords(e.tile.rx+l.x,e.tile.ry+l.y)),t.forEach((e=>o.unitOrderTrait.addTask(e)))}return o.purchaseValue=e.purchaseValue,e.replacedBy=o,i&&t.addToSelection(o),void 0!==s&&t.addUnitsToGroup(s,[o],!1),this.game.events.dispatch(new a.ObjectMorphEvent(e,o)),!0}},e("MorphIntoTask",c)}}})),System.register("game/gameobject/task/morph/DeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MorphIntoTask{onStart(e){var t=e.rules.deploysInto;if(!t)throw new Error(`Object type "${e.name}" doesn't deploy into anything`);this.morphInto=this.game.rules.getObject(t,r.ObjectType.Building),super.onStart(e)}onTick(e){return!!this.isCancelling()||super.onTick(e)}},e("DeployIntoTask",s)}}})),System.register("game/event/UnitDeployUndeployEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("UnitDeployUndeployEvent",class{constructor(e,t){this.unit=e,this.deployType=t,this.type=i.EventType.UnitDeployUndeploy}})}}})),System.register("game/event/PrimaryFactoryChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PrimaryFactoryChangeEvent",class{constructor(e){this.target=e,this.type=i.EventType.PrimaryFactoryChange}})}}})),System.register("game/gameobject/task/EvacuateTransportTask",["game/event/LeaveTransportEvent","game/gameobject/unit/FacingUtil","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/ScatterTask","game/gameobject/task/system/Task","game/gameobject/task/TurnTask","game/gameobject/task/system/WaitMinutesTask","game/gameobject/unit/ZoneType","game/gameobject/task/system/CallbackTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var t;(t=d=d||{})[t.None=0]="None",t[t.OnlyPassengers=1]="OnlyPassengers",t[t.All=2]="All",g=class extends o.Task{constructor(e,t){super(),this.game=e,this.soft=t,this.evacState=d.None,this.evacTries=0,this.turnPerformed=!1,this.preventLanding=!1}forceEvac(){this.evacState=d.All}onStart(e){if(!e.transportTrait)throw new Error(`Object "${e.name}" is not a valid transport`);var t=e.transportTrait;0<t.units.length&&(this.evacState=this.evacState!==d.OnlyPassengers&&1!==t.units.length||!e.rules.gunner?d.OnlyPassengers:d.All)}onTick(e){if(this.isCancelling()||this.evacState===d.None)return!0;if(e.zone===h.ZoneType.Air)return this.children.push(new u.CallbackTask((()=>e.zone!==h.ZoneType.Air))),!1;let t=e.transportTrait.units;if(!t.length||e.rules.gunner&&1===t.length&&this.evacState!==d.All)return!0;var i=t[t.length-1],r=this.findValidEvacTarget(e,i);if(r&&!this.turnPerformed){this.turnPerformed=!0;var s=(r.dir+180)%360;if(e.direction!==s)return this.children.push(new l.TurnTask(s)),!1}return this.evacuateUnit(i,e,r)?(t.pop(),this.children.push(new c.WaitMinutesTask(1/60)),!1):!(++this.evacTries<=3&&(this.children.push(new c.WaitMinutesTask(.05)),1))}evacuateUnit(e,t,r){if(!r)return!this.soft&&(e.position.tile=t.tile,e.position.tileElevation=t.tileElevation,e.onBridge=t.onBridge,e.zone=t.zone,this.game.destroyObject(e,{player:e.owner}),!0);var{spawnNode:s,moveNode:o}=r;return e.position.tileElevation=s.onBridge?.tileElevation??0,e.onBridge=!!s.onBridge,e.zone=this.game.map.getTileZone(s.tile,!s.onBridge),this.game.unlimboObject(e,s.tile),e.unitOrderTrait.unmarkNextQueuedOrder(),o?e.unitOrderTrait.addTask(new n.MoveTask(this.game,o.tile,!!o.onBridge)):e.unitOrderTrait.addTask(new a.ScatterTask(this.game)),this.game.events.dispatch(new i.LeaveTransportEvent(t)),!0}findValidEvacTarget(e,t){let i=this.game.map,n=new s.MovePositionHelper(i);var a,o,l,c,h,u=e.onBridge?i.tileOccupation.getBridgeOnTile(e.tile):void 0,d=(e.direction+180)%360;let g;for(let s=0;s<=180;s+=45)for(a of s&&s<180?[d+s,d-s]:[d]){var p=r.FacingUtil.toMapCoords(a);let s,d=e.tile,v=u;for(let r=1;r<=2;r++){if(2===r){if(!s)break;d=s.tile,v=s.onBridge}var m,f=e.tile.rx+Math.sign(p.x)*r,y=e.tile.ry+Math.sign(p.y)*r,T=i.tiles.getByMapCoords(f,y);if(!T||!i.mapBounds.isWithinBounds(T))break;let u=[i.tileOccupation.getBridgeOnTile(T)];for(m of(u[0]&&u.push(void 0),u))if(o=T,l=m,c=v,h=d,0<i.terrain.getPassableSpeed(o,t.rules.speedType,!!l)&&n.isEligibleTile(o,l,c,h)&&!i.terrain.findObstacles({tile:o,onBridge:l},t).length){if(1!==r)return{spawnNode:s,moveNode:{tile:T,onBridge:m},dir:a};s={tile:T,onBridge:m},g={spawnNode:s,moveNode:void 0,dir:a}}}}if(g)return g}},e("EvacuateTransportTask",g)}}})),System.register("game/order/DeployOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/morph/DeployIntoTask","game/gameobject/infantry/StanceType","game/gameobject/task/system/CallbackTask","game/event/UnitDeployUndeployEvent","game/event/PrimaryFactoryChangeEvent","game/gameobject/task/EvacuateTransportTask","game/type/SpeedType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.Order{constructor(e,t){super(t?r.OrderType.Deploy:r.OrderType.DeploySelected),this.game=e,this.targeted=t,this.minimapAllowed=!1,this.getPointerType=()=>this.isAllowed()?s.PointerType.Deploy:s.PointerType.NoDeploy,this.targetOptional=!t,this.singleSelectionRequired=t}isValid(){if(this.targeted&&(!this.target.obj||this.target.obj!==this.sourceObject))return!1;let e=this.sourceObject;return!!(e.isInfantry()&&e.deployerTrait&&![a.StanceType.Cheer].includes(e.stance)||e.isVehicle()&&e.deployerTrait||e.isVehicle()&&e.rules.deploysInto||e.isVehicle()&&e.transportTrait||e.isBuilding()&&e.rules.factory&&!e.owner.production?.isPrimaryFactory(e)||e.isBuilding()&&e.garrisonTrait?.units.length)}isAllowed(){let e=this.sourceObject;if(e.isVehicle()&&e.transportTrait)return!!(e.transportTrait.units.length&&0<this.game.map.terrain.getPassableSpeed(e.tile,u.SpeedType.Foot,e.onBridge));if((e.isInfantry()||e.isVehicle())&&e.deployerTrait)return!0;if(e.isVehicle()&&e.rules.deploysInto){if(e.parasiteableTrait?.isInfested())return!1;let i=this.game.getConstructionWorker(e.owner);if(e.moveTrait.currentWaypoint?.onBridge)return!1;var t=e.moveTrait.currentWaypoint?.tile??e.tile;return i.canPlaceAt(e.rules.deploysInto,t,{ignoreObjects:[e],ignoreAdjacent:!0})}if(e.isBuilding()&&e.rules.factory)return!0;if(e.isBuilding()&&e.garrisonTrait?.units.length)return!0;throw new Error("Shouldn't reach this point. Missed a case.")}process(){const e=this.sourceObject;return e.isVehicle()&&e.transportTrait?[new h.EvacuateTransportTask(this.game,!0)]:e.isBuilding()&&e.rules.factory?void 0:e.isVehicle()&&e.rules.deploysInto?[new n.DeployIntoTask(this.game)]:(e.isInfantry()||e.isVehicle())&&e.deployerTrait?[new o.CallbackTask((()=>{e.deployerTrait.toggleDeployed(),this.game.events.dispatch(new l.UnitDeployUndeployEvent(e,e.deployerTrait.isDeployed()?"undeploy":"deploy"))}))]:e.isBuilding()&&e.garrisonTrait?.units.length?[new o.CallbackTask((()=>{e.garrisonTrait.evacuate(this.game,!0)}))]:void 0}onAdd(e,t){let i=this.sourceObject;if(i.isBuilding()&&i.rules.factory)return i.owner.production.setPrimaryFactory(i),this.game.events.dispatch(new c.PrimaryFactoryChangeEvent(i)),!1;if(i.isVehicle()&&i.transportTrait&&!t&&this.isValid()&&this.isAllowed()){let t=e.find((e=>e.constructor===h.EvacuateTransportTask&&!e.isCancelling()));if(t)return t.forceEvac(),!1}return!0}},e("DeployOrder",d)}}})),System.register("game/gameobject/task/morph/UndeployIntoTask",["game/gameobject/task/morph/MorphIntoTask","engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MorphIntoTask{onStart(e){var t=e.rules.undeploysInto;if(!t)throw new Error(`Object type "${e.name}" doesn't undeploy into anything`);this.morphInto=this.game.rules.getObject(t,r.ObjectType.Vehicle),super.onStart(e)}},e("UndeployIntoTask",s)}}})),System.register("game/order/OrderFeedbackType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Move=1]="Move",t[t.Attack=2]="Attack",t[t.Enter=3]="Enter",t[t.Capture=4]="Capture",t[t.SpecialAttack=5]="SpecialAttack",e("OrderFeedbackType",i)}}})),System.register("game/event/RallyPointChangeEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("RallyPointChangeEvent",class{constructor(e){this.target=e,this.type=i.EventType.RallyPointChange}})}}})),System.register("game/gameobject/task/move/MoveToBlockTask",["game/gameobject/trait/MoveTrait","game/gameobject/task/system/Task","game/gameobject/task/move/MoveTask"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends r.Task{constructor(e,t){super(),this.game=e,this.target=t,this.preventOpportunityFire=!1,this.useChildTargetLines=!0,this.attackPerformed=!1}onStart(e){this.children.push(new s.MoveTask(this.game,this.target.centerTile,!1,{closeEnoughTiles:1,pathFinderIgnoredBlockers:[this.target],stopOnBlocker:this.target}))}onTick(e){if(this.attackPerformed||this.isCancelling()||!e.attackTrait||e.attackTrait.isDisabled())return!0;if(e.moveTrait.lastMoveResult!==i.MoveResult.CloseEnough)return!0;var t=e.attackTrait.selectWeaponVersus(e,this.target,this.game,!0);return!(t&&(this.children.push(e.attackTrait.createAttackTask(this.game,this.target,this.target.tile,t,{force:!0})),this.attackPerformed=!0))}},e("MoveToBlockTask",n)}}})),System.register("game/order/MoveOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/morph/UndeployIntoTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/event/RallyPointChangeEvent","game/type/MovementZone","game/type/SpeedType","game/gameobject/task/AttackTask","game/gameobject/Building","game/gameobject/task/WaitForBuildUpTask","game/gameobject/task/move/MoveToBlockTask","game/type/LandType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class extends i.Order{constructor(e,t,i,s=!1){super(s?r.OrderType.ForceMove:r.OrderType.Move),this.game=e,this.map=t,this.unitSelection=i,this.forceMove=s,this.targetOptional=!1,this.feedbackType=o.OrderFeedbackType.Move}getPointerType(e){let t=this.isAllowed();var i,r,n,a;return!t||this.forceMove||this.sourceObject.isBuilding()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)||(i=!!this.target.getBridge(),r=this.sourceObject.rules.speedType,n=this.sourceObject.rules.movementZone===c.MovementZone.Fly,a=this.map.getObjectsOnTile(this.target.tile).some((e=>(e.isInfantry()||e.isVehicle())&&e.disguiseTrait?.hasTerrainDisguise())),t=n?this.sourceObject.rules.airportBound||this.target.tile.landType===m.LandType.Cliff||0<this.map.terrain.getPassableSpeed(this.target.tile,h.SpeedType.Amphibious,i)&&!a:0<this.map.terrain.getPassableSpeed(this.target.tile,r,i)&&!a&&!(this.target.obj?.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))),e?t?s.PointerType.MoveMini:s.PointerType.NoActionMini:t?s.PointerType.Move:s.PointerType.NoMove}isValid(){return!(this.sourceObject.isBuilding()&&(!this.sourceObject.rules.undeploysInto||this.sourceObject.rules.constructionYard&&!this.game.gameOpts.mcvRepacks)&&!this.sourceObject.rallyTrait?.getRallyPoint())&&(this.forceMove||!this.target.obj||(this.target.obj.isOverlay()||this.target.obj.isBuilding())&&this.target.obj.rules.wall||this.target.obj.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)||(this.target.obj.isInfantry()||this.target.obj.isVehicle())&&!!this.target.obj.disguiseTrait?.hasTerrainDisguise()||this.target.obj.isTechno()&&!this.game.areFriendly(this.target.obj,this.sourceObject))}isAllowed(){return(!this.sourceObject.isUnit()||!this.sourceObject.moveTrait.isDisabled())&&(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)?this.sourceObject.rules.moveToShroud:!(!this.forceMove&&this.target.obj?.isTechno()&&this.target.obj.owner===this.sourceObject.owner&&this.unitSelection.isSelected(this.target.obj)))}process(){const e=this.sourceObject;if(!e.isBuilding()||!e.rallyTrait?.getRallyPoint()){var t=this.game.rules.general.closeEnough;return e.isBuilding()&&e.rules.undeploysInto?[new n.UndeployIntoTask(this.game),new a.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:t})]:e.isUnit()?this.isEnemyBuildingBlock()?[new p.MoveToBlockTask(this.game,this.target.obj)]:[new a.MoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:t})]:void 0}}isEnemyBuildingBlock(){return this.forceMove&&this.sourceObject.isVehicle()&&this.target.obj?.isBuilding()&&!this.game.areFriendly(this.sourceObject,this.target.obj)}onAdd(e,t){var i=this.sourceObject.isBuilding()&&this.sourceObject.rules.undeploysInto;if(i&&this.sourceObject.buildStatus===d.BuildStatus.BuildUp)return this.sourceObject.unitOrderTrait.getTasks().find((e=>e instanceof g.WaitForBuildUpTask))?.setCancellable(!0),!0;if(!i&&this.sourceObject.isBuilding()&&this.sourceObject.rallyTrait?.getRallyPoint())return this.sourceObject.rallyTrait.changeRallyPoint(this.target.tile,this.sourceObject,this.game),this.game.events.dispatch(new l.RallyPointChangeEvent(this.sourceObject)),!1;if(!this.isEnemyBuildingBlock()&&!t&&this.isValid()&&this.isAllowed()){this.sourceObject.attackTrait?.cancelOpportunityFire();let t=e.find((e=>e.constructor===a.MoveTask&&!e.isCancelling()));if(t)return t.updateTarget(this.target.tile,!!this.target.getBridge()),t.children.length&&t.children[0]instanceof u.AttackTask&&t.children[0].cancel(),e.splice(e.indexOf(t)+1),this.sourceObject.unitOrderTrait.clearOrders(),!1;if(this.sourceObject.isUnit()&&this.sourceObject.rules.movementZone===c.MovementZone.Fly){let t=e.find((e=>e.constructor===u.AttackTask&&!e.isCancelling()));t&&t.forceCancel(this.sourceObject)&&e.splice(e.indexOf(t))}}return!0}},e("MoveOrder",f)}}})),System.register("game/gameobject/task/move/MoveOutsideTask",["game/gameobject/task/move/MoveTask"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.MoveTask{constructor(e,t){super(e,t.tile,!1,{ignoredBlockers:[t]}),this.target=t,this.cancellable=!1}canStopAtTile(e,t,i){return!this.game.map.tileOccupation.isTileOccupiedBy(t,this.target)&&super.canStopAtTile(e,t,i)}},e("MoveOutsideTask",r)}}})),System.register("game/gameobject/task/move/MoveInsideTask",["game/gameobject/task/move/MoveTask"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class e extends i.MoveTask{constructor(t,i){super(t,e.chooseTargetFoundationTile(i,t),!1,{ignoredBlockers:[i],closeEnoughTiles:0}),this.target=i}static chooseTargetFoundationTile(e,t){if(e.isBuilding()){let i=e.centerTile;return t.map.mapBounds.isWithinBounds(i)||(i=t.map.tileOccupation.calculateTilesForGameObject(e.tile,e).find((e=>t.map.mapBounds.isWithinBounds(e)))??e.tile),i}return e.tile}hasReachedDestination(e){return super.hasReachedDestination(e)||this.canStopAtTile(e,e.tile,e.onBridge)}canStopAtTile(e,t,i){var r=this.game.map.tileOccupation.isTileOccupiedBy(t,this.target);return!(this.isCancelling()&&r||!this.isCancelling()&&!r)}isCloseEnoughToDest(e,t,i){return this.game.map.tileOccupation.isTileOccupiedBy(t,this.target)}},e("MoveInsideTask",r)}}})),System.register("game/event/BuildingGarrisonEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingGarrisonEvent",class{constructor(e){this.target=e,this.type=i.EventType.BuildingGarrison}})}}})),System.register("game/event/EnterObjectEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("EnterObjectEvent",class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.EnterObject}})}}})),System.register("game/gameobject/task/GarrisonBuildingTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingGarrisonEvent","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(e){return!this.target.isDestroyed&&this.target.garrisonTrait?.canBeOccupied()&&this.target.garrisonTrait.units.length<this.target.garrisonTrait.maxOccupants&&!(this.target.garrisonTrait.units.length&&this.target.garrisonTrait.units[0].owner!==e.owner)&&!e.mindControllableTrait?.isActive()}onTick(e){if(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())return!0;let t=this.target.garrisonTrait;return this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)):(this.game.limboObject(e,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(e).getControlGroupNumber()}),t.units.length||(e.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,e.owner),this.game.events.dispatch(new n.BuildingGarrisonEvent(this.target))),this.game.events.dispatch(new a.EnterObjectEvent(this.target,e)),t.units.push(e),!0):!(!this.movePerformed&&(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,this.preventOpportunityFire=!0))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("GarrisonBuildingTask",o)}}})),System.register("game/event/UnitRecycleEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("UnitRecycleEvent",class{constructor(e){this.target=e,this.type=i.EventType.UnitRecycle}})}}})),System.register("game/gameobject/task/EnterRecyclerTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/type/LocomotorType","game/type/MovementZone","game/event/UnitRecycleEvent","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return e.rules.movementZone!==o.MovementZone.Fly&&e.rules.locomotor!==a.LocomotorType.Chrono&&0<this.game.sellTrait.computeRefundValue(e)&&this.target.rules.cloning&&!this.target.isDestroyed&&this.target.buildStatus===r.BuildStatus.Ready&&e.owner===this.target.owner}onTick(e){return!(!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())&&(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new s.MoveOutsideTask(this.game,this.target)),this.aborted=!0):(this.game.sellTrait.sell(e),this.game.events.dispatch(new l.UnitRecycleEvent(e)),this.game.events.dispatch(new c.EnterObjectEvent(this.target,e)),0):!this.movePerformed&&(this.children.push(new n.MoveInsideTask(this.game,this.target)),this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("EnterRecyclerTask",h)}}})),System.register("game/gameobject/task/InfiltrateBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingInfiltrationEvent","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return e.rules.infiltrate&&this.target.rules.spyable&&!this.target.isDestroyed&&this.target.buildStatus!==r.BuildStatus.BuildDown&&!this.game.areFriendly(e,this.target)}onTick(e){return!(!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())&&(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new s.MoveOutsideTask(this.game,this.target)),this.aborted=!0):(this.game.unspawnObject(e),e.agentTrait?.infiltrate(e,this.target,this.game),this.game.events.dispatch(new a.BuildingInfiltrationEvent(this.target,e)),this.game.events.dispatch(new o.EnterObjectEvent(this.target,e)),0):!this.movePerformed&&(this.children.push(new n.MoveInsideTask(this.game,this.target)),this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("InfiltrateBuildingTask",l)}}})),System.register("game/gameobject/task/EnterHospitalTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/type/MovementZone","game/gameobject/unit/MovePositionHelper","game/map/tileFinder/RadialTileFinder","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/gameobject/trait/MoveTrait","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){var t;(t=d=d||{})[t.MoveToQueueingTile=0]="MoveToQueueingTile",t[t.WaitForTurn=1]="WaitForTurn",t[t.MoveToTarget=2]="MoveToTarget",t[t.EnterTarget=3]="EnterTarget",t[t.ClearTarget=4]="ClearTarget",g=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.movePerformed=!1}isAllowed(e){return e.rules.movementZone!==n.MovementZone.Fly&&e.healthTrait.health<100&&this.target.hospitalTrait&&!this.target.isDestroyed&&!this.target.warpedOutTrait.isActive()&&this.game.areFriendly(e,this.target)&&(!this.target.ammoTrait||0<this.target.ammoTrait.ammo)}onStart(e){if(!this.target.hospitalTrait)throw new Error(`Target ${this.target.name} is not a valid hospital`);0<this.target.hospitalTrait.addToHealQueue(e)?this.state=d.MoveToQueueingTile:this.state=d.MoveToTarget}onEnd(e){!this.target.isDestroyed&&e.isSpawned&&this.target.hospitalTrait.removeFromHealQueue(e)}onTick(e){if(this.isCancelling()&&this.state!==d.EnterTarget||this.state===d.ClearTarget||e.moveTrait.isDisabled())return!0;if(this.state===d.MoveToQueueingTile){let i=new a.MovePositionHelper(this.game.map);var t=new o.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,(t=>0<this.game.map.terrain.getPassableSpeed(t,e.rules.speedType,!1)&&i.isEligibleTile(t,void 0,void 0,this.target.tile))).getNextTile();return!t||(this.children.push(new l.MoveTask(this.game,t,!1,{closeEnoughTiles:5})),this.children.push(new c.CallbackTask((()=>{[h.MoveResult.Success,h.MoveResult.CloseEnough].includes(e.moveTrait.lastMoveResult)||this.cancel()}))),this.state=d.WaitForTurn,this.queueingTile=t,!1)}if(this.state===d.WaitForTurn){if(!this.target.hospitalTrait.unitIsFirstInHealQueue(e))return!1;this.queueingTile=void 0,this.state=d.MoveToTarget}if(this.state===d.MoveToTarget){if(!this.isAllowed(e))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target))return!(!this.movePerformed&&(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0));this.state=d.EnterTarget}return this.state===d.EnterTarget&&(!this.isAllowed(e)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),this.state=d.ClearTarget,!1):(this.game.limboObject(e,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(e).getControlGroupNumber()}),this.target.hospitalTrait.startHealing(e),this.game.events.dispatch(new u.EnterObjectEvent(this.target,e)),!0))}getTargetLinesConfig(e){return{target:this.queueingTile?void 0:this.target,pathNodes:this.queueingTile?[{tile:this.queueingTile,onBridge:void 0}]:[]}}},e("EnterHospitalTask",g)}}})),System.register("game/order/OccupyOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/GarrisonBuildingTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/type/MovementZone","game/type/LocomotorType","game/gameobject/task/EnterRecyclerTask","game/gameobject/task/InfiltrateBuildingTask","game/gameobject/task/EnterHospitalTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class extends i.Order{constructor(e){super(r.OrderType.Occupy),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=o.OrderFeedbackType.Capture}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){return!!(this.target.obj?.isSpawned&&this.target.obj?.isBuilding()&&this.sourceObject.isInfantry())&&(!!this.isInfantryRecycle(this.sourceObject,this.target.obj)||(this.target.obj.isBuilding()&&this.target.obj.hospitalTrait?this.game.areFriendly(this.sourceObject,this.target.obj)&&this.sourceObject.isInfantry():this.target.obj.garrisonTrait?this.target.obj.garrisonTrait.canBeOccupied()&&this.sourceObject.rules.occupier&&!(this.target.obj.garrisonTrait.units.length&&this.target.obj.garrisonTrait.units[0].owner!==this.sourceObject.owner)&&!this.sourceObject.mindControllableTrait?.isActive()&&!this.sourceObject.mindControllerTrait?.isActive():!(!this.target.obj.rules.spyable||!this.sourceObject.rules.infiltrate||this.game.areFriendly(this.sourceObject,this.target.obj))))}isInfantryRecycle(e,t){return t.rules.cloning&&e.owner===t.owner}isAllowed(){var e=this.target.obj,t=this.sourceObject;return this.isInfantryRecycle(t,e)?t.rules.movementZone!==l.MovementZone.Fly&&t.rules.locomotor!==c.LocomotorType.Chrono&&0<this.game.sellTrait.computeRefundValue(t):e.hospitalTrait?t.healthTrait.health<100&&t.rules.movementZone!==l.MovementZone.Fly:!e.garrisonTrait||e.garrisonTrait.units.length<e.rules.maxNumberOccupants}process(){var e=this.target.obj,t=this.sourceObject;return this.isInfantryRecycle(t,e)?[new h.EnterRecyclerTask(this.game,e)]:e.hospitalTrait?[new d.EnterHospitalTask(this.game,e)]:e.garrisonTrait?[new n.GarrisonBuildingTask(this.game,e)]:[new u.InfiltrateBuildingTask(this.game,e)]}onAdd(e,t){if(!t){let t=e.find((e=>e instanceof n.GarrisonBuildingTask||e instanceof u.InfiltrateBuildingTask));if(this.isValid()&&this.isAllowed()&&t&&!t.isCancelling()&&t.target===this.target.obj&&new a.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("OccupyOrder",g)}}})),System.register("game/gameobject/task/PlantC4Task",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/GameSpeed","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(e){return!this.target.isDestroyed&&!this.target.invulnerableTrait.isActive()}onTick(e){if(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target))return!(!this.movePerformed&&(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,this.preventOpportunityFire=!0));if(!this.isAllowed(e)||this.isCancelling())return this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0);var t=Math.floor(60*this.game.rules.combatDamage.c4Delay*n.GameSpeed.BASE_TICKS_PER_SECOND);return this.target.c4ChargeTrait.setCharge(t,{player:e.owner,obj:e}),this.game.events.dispatch(new a.EnterObjectEvent(this.target,e)),this.children.push(new r.MoveOutsideTask(this.game,this.target)),!(this.aborted=!0)}getTargetLinesConfig(e){return{target:this.target,pathNodes:[],isAttack:!0}}},e("PlantC4Task",o)}}})),System.register("game/order/AttackOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/AttackTask","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/unit/LosHelper","game/type/ArmorType","game/gameobject/task/PlantC4Task","game/gameobject/unit/ZoneType","game/gameobject/task/move/MoveTask","game/type/MovementZone","game/type/LocomotorType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class extends i.Order{constructor(e,{forceAttack:t,noIvanBomb:i}={}){super(t?r.OrderType.ForceAttack:r.OrderType.Attack),this.game=e,this.isC4=!1,this.forceAttack=!!t,this.ivanBombAllowed=!i||!!t,this.targetOptional=!1,this.feedbackType=o.OrderFeedbackType.None,this.rangeHelper=new a.RangeHelper(this.game.map.tileOccupation),this.losHelper=new l.LosHelper(this.game.map.tiles,e.map.tileOccupation)}getPointerType(e,t){if(!this.isAllowed())return e?s.PointerType.NoActionMini:s.PointerType.NoAction;if(this.isC4)return s.PointerType.C4;var i=this.sourceObject.attackTrait?.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return i?.rules.sabotageCursor?s.PointerType.C4:this.ivanBombAllowed&&this.sourceObject.rules.ivan&&i?.warhead.rules.ivanBomb?s.PointerType.Dynamite:i?.warhead.rules.bombDisarm?s.PointerType.DefuseBomb:i&&i.rules.damage<0?s.PointerType.RepairMove:(i=t.every((e=>{if(!e.attackTrait)return!0;var t=e.attackTrait.selectWeaponVersus(e,this.target,this.game,this.forceAttack);return!t||this.rangeHelper.isInWeaponRange(e,this.target.obj||this.target.tile,t,this.game.rules)&&this.losHelper.hasLineOfSight(e,this.target.obj||this.target.tile,t)})),e?s.PointerType.AttackMini:i?s.PointerType.AttackRange:s.PointerType.AttackNoRange)}isValid(){if(!this.sourceObject.attackTrait)return!1;if(this.forceAttack&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.isBuilding())return!1;let e=this.target.obj;var t=this.game.map.getGroundObjectsOnTile(this.target.tile).find((e=>e.isTerrain()));return this.terminal=!e&&!t,this.sourceObject.c4&&e?.isBuilding()&&e.c4ChargeTrait&&(this.forceAttack||!this.game.areFriendly(e,this.sourceObject)||e.cabHutTrait)?(this.isC4=!0,this.feedbackType=o.OrderFeedbackType.SpecialAttack,!0):(this.isC4=!1,this.feedbackType=o.OrderFeedbackType.Attack,!!this.game.isValidTarget(e)&&(!(!e&&t?.rules.immune)&&(!!(e||this.target.tile!==this.sourceObject.tile||this.sourceObject.isUnit()&&this.sourceObject.zone===u.ZoneType.Air)&&(e!==this.sourceObject&&(!!(t=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack))&&!(!this.ivanBombAllowed&&t.warhead.rules.ivanBomb)&&!(e?.isBuilding()&&e.cabHutTrait&&!t.warhead.rules.ivanBomb&&!t.warhead.rules.bombDisarm)&&!!(this.sourceObject.isUnit()&&this.sourceObject.moveTrait&&!this.sourceObject.moveTrait.isDisabled()||this.rangeHelper.isInWeaponRange(this.sourceObject,e||this.target.tile,t,this.game.rules))&&!(this.sourceObject.airSpawnTrait&&t.rules.spawner&&!this.game.map.isWithinBounds(this.target.tile))&&(!!this.forceAttack||(!e?.isBuilding()||!e.hospitalTrait)&&!(!e||!e.healthTrait)&&!e.isDestroyed&&!e.isCrashing&&(!(!e.isOverlay()||!(t.warhead.rules.wall||t.warhead.rules.wood&&e.rules.armor===c.ArmorType.Wood))||e.isTechno())))))))}isAllowed(){return!this.sourceObject.attackTrait.isDisabled()}process(){if(this.isC4)return[new h.PlantC4Task(this.game,this.target.obj)];var e=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game,this.forceAttack);return[new n.AttackTask(this.game,this.target,e,{force:this.forceAttack})]}onAdd(e,t){let i=this.sourceObject;if(!t&&i.isUnit()&&this.isValid()&&this.isAllowed())if(i.rules.movementZone===g.MovementZone.Fly){let t=e.find((e=>(e.constructor===d.MoveTask||e.constructor===n.AttackTask)&&!e.isCancelling()));t&&(i.moveTrait.currentWaypoint?.tile===this.target.tile||i.isAircraft()||t.constructor===n.AttackTask)&&t.forceCancel(i)&&e.splice(e.indexOf(t))}else{e.length&&i.isUnit()&&(i.rules.locomotor===p.LocomotorType.Vehicle||i.rules.locomotor===p.LocomotorType.Ship)&&(i.moveTrait.speedPenalty=.5);let t=e.find((e=>e.constructor===n.AttackTask&&!e.isCancelling()));if(t?.getWeapon().warhead.rules.temporal)return t.setForceAttack(this.forceAttack),t.requestTargetUpdate(this.target),!1}return!0}},e("AttackOrder",m)}}})),System.register("game/order/StopOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/type/LocomotorType","game/gameobject/task/system/CallbackTask"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Order{constructor(e){super(r.OrderType.Stop),this.game=e,this.getPointerType=()=>s.PointerType.NoAction}isValid(){return this.sourceObject.isTechno()}isAllowed(){return!0}process(){return[new a.CallbackTask((e=>{!e.isUnit()||e.rules.locomotor!==n.LocomotorType.Vehicle&&e.rules.locomotor!==n.LocomotorType.Ship||(e.moveTrait.speedPenalty=0)}))]}onAdd(e,t){let i=this.sourceObject;return t||!e.length||!i.isUnit()||i.rules.locomotor!==n.LocomotorType.Vehicle&&i.rules.locomotor!==n.LocomotorType.Ship||(i.moveTrait.speedPenalty=.5),i.isBuilding()&&i.rallyTrait?.getRallyPoint()&&(i.unitRepairTrait?.resetRallyPoint(i,this.game),i.factoryTrait?.resetRallyPoint(i,this.game)),!0}},e("StopOrder",o)}}})),System.register("game/gameobject/task/CheerTask",["game/gameobject/task/system/Task","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/task/system/WaitMinutesTask"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends i.Task{constructor(){super(),this.executed=!1,this.cancellable=!1}onTick(e){return this.executed?(e.stance=s.StanceType.None,!0):!e.isInfantry()||!e.art.sequences.has(r.SequenceType.Cheer)||e.stance!==s.StanceType.None&&e.stance!==s.StanceType.Guard||(e.stance=s.StanceType.Cheer,this.children.push(new n.WaitMinutesTask(1/60).setCancellable(!1)),!(this.executed=!0))}},e("CheerTask",a)}}})),System.register("game/order/CheerOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/CheerTask","game/gameobject/infantry/StanceType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Order{constructor(){super(r.OrderType.Cheer),this.getPointerType=()=>s.PointerType.NoAction}isValid(){return this.sourceObject.isInfantry()&&[a.StanceType.None,a.StanceType.Guard].includes(this.sourceObject.stance)}isAllowed(){return!0}process(){return[new n.CheerTask]}},e("CheerOrder",o)}}})),System.register("game/order/DockOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/Building","game/gameobject/task/harvester/ReturnOreTask","game/order/OrderFeedbackType","game/gameobject/task/MoveToDockTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends i.Order{constructor(e){super(r.OrderType.Dock),this.game=e,this.targetOptional=!1,this.feedbackType=o.OrderFeedbackType.Move}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){if(!this.target.obj?.isBuilding()||this.target.obj.isDestroyed||!this.target.obj.dockTrait||this.target.obj.buildStatus!==n.BuildStatus.Ready||!this.sourceObject.isUnit()||this.target.obj.warpedOutTrait.isActive())return!1;var e=!(this.target.obj.rules.refinery||this.target.obj.unitRepairTrait);return this.game.areFriendly(this.target.obj,this.sourceObject)&&this.target.obj.dockTrait.isValidUnitForDock(this.sourceObject)&&!this.target.obj.dockTrait.isDocked(this.sourceObject)&&!(this.target.obj.unitRepairTrait&&!this.sourceObject.rules.dock.includes(this.target.obj.name)&&100===this.sourceObject.healthTrait.health)&&(!e||0<(this.target.obj.dockTrait.getAvailableDockCount()??0)||this.target.obj.dockTrait.hasReservedDockForUnit(this.sourceObject))}isAllowed(){return!0}process(){var e=this.target.obj;return e.rules.refinery&&this.sourceObject.isVehicle()&&this.sourceObject.harvesterTrait?[new a.ReturnOreTask(this.game,e,!0,!0)]:e.unitRepairTrait||this.sourceObject.rules.dock.includes(e.name)?[new l.MoveToDockTask(this.game,e)]:[]}},e("DockOrder",c)}}})),System.register("game/order/GatherOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/harvester/GatherOreTask","game/order/OrderFeedbackType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Order{constructor(e){super(r.OrderType.Gather),this.game=e,this.targetOptional=!1,this.feedbackType=a.OrderFeedbackType.Move}getPointerType(e){return e?s.PointerType.AttackMini:s.PointerType.AttackNoRange}isValid(){return!(!this.sourceObject.isVehicle()||!this.sourceObject.harvesterTrait||this.sourceObject.moveTrait.isDisabled()||this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation))&&this.target.isOre}isAllowed(){return!0}process(){return[new n.GatherOreTask(this.game,this.target.tile,!0)]}},e("GatherOrder",o)}}})),System.register("game/order/AttackMoveOrder",["game/order/OrderType","gui/PointerType","game/gameobject/task/move/AttackMoveTask","game/order/OrderFeedbackType","game/type/MovementZone","game/order/AttackOrder","game/gameobject/task/PlantC4Task","game/gameobject/task/move/AttackMoveTargetTask","game/gameobject/task/move/MoveTask","game/gameobject/task/AttackTask","game/type/LocomotorType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){g=class extends o.AttackOrder{constructor(e,t){super(e),this.map=t,this.orderType=i.OrderType.AttackMove,this.targetOptional=!1,this.feedbackType=n.OrderFeedbackType.Attack}getPointerType(e,t){if(this.target.obj?.isTechno()){let i=super.getPointerType(e,t);return i!==r.PointerType.AttackRange&&i!==r.PointerType.AttackNoRange||(i=r.PointerType.AttackMove),i}let i=this.isAllowed();var s,n;return i&&(s=!!this.target.getBridge(),n=this.sourceObject.rules.speedType,i=this.sourceObject.rules.movementZone===a.MovementZone.Fly||0<this.map.terrain.getPassableSpeed(this.target.tile,n,s)||!!this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)),e?i?r.PointerType.AttackMini:r.PointerType.NoActionMini:i?r.PointerType.AttackMove:r.PointerType.NoMove}isValid(){return this.sourceObject.isUnit()&&!!this.sourceObject.attackTrait&&!this.sourceObject.rules.preventAttackMove&&!(this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)&&(!this.target.obj?.isTechno()||super.isValid())}isAllowed(){return!(!this.target.obj?.isTechno()&&this.sourceObject.moveTrait.isDisabled())&&super.isAllowed()}process(){if(this.target.obj?.isTechno()){if(this.isC4)return[new l.PlantC4Task(this.game,this.target.obj)];var e=this.sourceObject.attackTrait.selectWeaponVersus(this.sourceObject,this.target,this.game);return[new c.AttackMoveTargetTask(this.game,this.target,e)]}return[new s.AttackMoveTask(this.game,this.target.tile,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})]}onAdd(e,t){if(!this.target.obj?.isTechno())return!0;let i=this.sourceObject;if(!t&&i.isUnit()&&this.isValid()&&this.isAllowed())if(i.rules.movementZone===a.MovementZone.Fly){let t=e.find((e=>[h.MoveTask,u.AttackTask,c.AttackMoveTargetTask].includes(e.constructor)&&!e.isCancelling()));t&&(i.moveTrait.currentWaypoint?.tile===this.target.tile||i.isAircraft()||t.constructor===u.AttackTask||t.constructor===c.AttackMoveTargetTask)&&t.forceCancel(i)&&e.splice(e.indexOf(t))}else e.length&&i.isUnit()&&(i.rules.locomotor===d.LocomotorType.Vehicle||i.rules.locomotor===d.LocomotorType.Ship)&&(i.moveTrait.speedPenalty=.5);return!0}},e("AttackMoveOrder",g)}}})),System.register("game/event/BuildingRepairFullEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingRepairFullEvent",class{constructor(e,t){this.target=e,this.source=t,this.type=i.EventType.BuildingRepairFull}})}}})),System.register("game/event/BridgeRepairEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BridgeRepairEvent",class{constructor(e,t){this.source=e,this.tile=t,this.type=i.EventType.BridgeRepair}})}}})),System.register("game/gameobject/task/RepairBuildingTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingRepairFullEvent","game/event/BridgeRepairEvent","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return this.target.cabHutTrait?this.target.cabHutTrait.canRepairBridge():e.rules.engineer&&!this.target.isDestroyed&&this.target.rules.repairable&&this.target.healthTrait.health<100&&(!this.target.owner.isCombatant()||this.game.areFriendly(e,this.target))}onTick(e){return!(!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())&&(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),this.aborted=!0):(this.game.unspawnObject(e),this.target.cabHutTrait?(this.target.cabHutTrait.repairBridge(this.game,e.owner),this.game.events.dispatch(new a.BridgeRepairEvent(e.owner,this.target.centerTile))):(this.target.healthTrait.healToFull(e,this.game),this.game.events.dispatch(new n.BuildingRepairFullEvent(this.target,e.owner))),this.game.events.dispatch(new o.EnterObjectEvent(this.target,e)),0):!this.movePerformed&&(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("RepairBuildingTask",l)}}})),System.register("game/order/RepairOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/RepairBuildingTask","game/order/OrderFeedbackType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends i.Order{constructor(e){super(r.OrderType.Repair),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=o.OrderFeedbackType.Capture}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.RepairMove:s.PointerType.NoRepair}isValid(){return!!this.target.obj?.isBuilding()&&!this.target.obj.isDestroyed&&this.sourceObject.isInfantry()&&this.sourceObject.rules.engineer}isAllowed(){let e=this.target.obj;return e.cabHutTrait?e.cabHutTrait.canRepairBridge():!(!(e.rules.repairable&&e.healthTrait.health<100)||e.owner.isCombatant()&&!this.game.areFriendly(e,this.sourceObject))}process(){var e=this.target.obj;return[new a.RepairBuildingTask(this.game,e)]}onAdd(e,t){if(!t){let t=e.find((e=>e instanceof a.RepairBuildingTask));if(this.isValid()&&this.isAllowed()&&t&&!t.isCancelling()&&t.target===this.target.obj&&new n.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("RepairOrder",l)}}})),System.register("game/order/GuardAreaOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask","game/order/OrderFeedbackType","game/gameobject/trait/MoveTrait","game/gameobject/task/harvester/GatherOreTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class extends i.Order{constructor(e,t){super(t?r.OrderType.GuardArea:r.OrderType.Guard),this.game=e,this.targeted=t,this.getPointerType=e=>e?this.isAllowed()?s.PointerType.GuardMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Guard:s.PointerType.NoMove,this.terminal=!0,this.targetOptional=!t,this.minimapAllowed=t,this.feedbackType=t?o.OrderFeedbackType.Move:o.OrderFeedbackType.None}isValid(){return this.sourceObject.isUnit()&&(!!this.targetOptional||!this.sourceObject.moveTrait.isDisabled())&&!(this.target&&this.game.mapShroudTrait.getPlayerShroud(this.sourceObject.owner)?.isShrouded(this.target.tile,this.target.obj?.tileElevation)&&!this.sourceObject.rules.moveToShroud)}isAllowed(){return!0}process(){let e=this.targeted?this.target.tile:void 0;const t=this.sourceObject;if(!e&&t.isVehicle()&&t.harvesterTrait)return[new n.CallbackTask((()=>t.harvesterTrait.lastOreSite=void 0)),new c.GatherOreTask(this.game,void 0,!0)];let i=[];return e&&i.push(new a.MoveTask(this.game,e,!!this.target.getBridge(),{closeEnoughTiles:this.game.rules.general.closeEnough})),i.push(new n.CallbackTask((t=>{e&&![l.MoveResult.Success,l.MoveResult.CloseEnough].includes(this.sourceObject.moveTrait?.lastMoveResult)||(this.sourceObject.guardMode=!0)}))),i}},e("GuardAreaOrder",h)}}})),System.register("game/order/ScatterOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/task/ScatterTask","game/type/MovementZone"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Order{constructor(e){super(r.OrderType.Scatter),this.game=e,this.getPointerType=()=>s.PointerType.NoAction}isValid(){return(this.sourceObject.isInfantry()||this.sourceObject.isVehicle())&&this.sourceObject.rules.movementZone!==a.MovementZone.Fly&&!this.sourceObject.moveTrait.isDisabled()}isAllowed(){return!0}process(){if(!this.target)throw new Error("Target should be set for executing a scatter order. See OrderUnitsAction.");return[new n.ScatterTask(this.game,{tile:this.target.tile,toBridge:!!this.target.getBridge()})]}},e("ScatterOrder",o)}}})),System.register("game/event/EnterTransportEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("EnterTransportEvent",class{constructor(e){this.target=e,this.type=i.EventType.EnterTransport}})}}})),System.register("game/gameobject/task/EnterTransportTask",["game/gameobject/task/system/Task","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/EnterTransportEvent","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/map/tileFinder/RadialTileFinder","game/gameobject/unit/MovePositionHelper","game/gameobject/task/move/MoveTask","game/gameobject/task/system/CallbackTask","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){var t;(t=g=g||{})[t.MoveToQueueingTile=0]="MoveToQueueingTile",t[t.WaitForTurn=1]="WaitForTurn",t[t.MoveToTransport=2]="MoveToTransport",t[t.EnterTransport=3]="EnterTransport",t[t.ClearTransport=4]="ClearTransport",p=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.movePerformed=!1,this.preventOpportunityFire=!1}isAllowed(e){return!this.target.isDestroyed&&!this.target.isCrashing&&this.game.areFriendly(this.target,e)&&e.zone!==a.ZoneType.Air&&this.target.zone!==a.ZoneType.Air&&this.target.transportTrait.unitFitsInside(e)&&this.target.moveTrait.moveState===o.MoveState.Idle&&!this.target.warpedOutTrait.isActive()&&!e.mindControllableTrait?.isActive()&&!e.mindControllerTrait?.isActive()}onStart(e){if(!this.target.transportTrait)throw new Error(`Unit ${this.target.name} is not a valid transport`);this.initialTargetTile=this.target.tile,0<this.target.transportTrait.addToLoadQueue(e)?this.state=g.MoveToQueueingTile:this.state=g.MoveToTransport}onEnd(e){this.target.isDestroyed||this.target.transportTrait?.removeFromLoadQueue(e)}onTick(e){if(this.isCancelling()&&this.state!==g.EnterTransport||this.state===g.ClearTransport||e.moveTrait.isDisabled())return!0;if(this.target.tile!==this.initialTargetTile||this.target.moveTrait.moveState!==o.MoveState.Idle)return!0;if(this.state===g.MoveToQueueingTile){let i,r=new c.MovePositionHelper(this.game.map),s=this.target.onBridge?this.game.map.tileOccupation.getBridgeOnTile(this.target.tile):void 0;var t=new l.RadialTileFinder(this.game.map.tiles,this.game.map.mapBounds,this.target.tile,this.target.getFoundation(),1,1,(t=>{let n=[this.game.map.tileOccupation.getBridgeOnTile(t)];for(var a of(n[0]&&n.push(void 0),n))if(0<this.game.map.terrain.getPassableSpeed(t,e.rules.speedType,!!a)&&r.isEligibleTile(t,a,s,this.target.tile))return i=a,!0;return!1})).getNextTile();return!t||(this.children.push(new h.MoveTask(this.game,t,!!i,{closeEnoughTiles:5})),this.children.push(new u.CallbackTask((()=>{[o.MoveResult.Success,o.MoveResult.CloseEnough].includes(e.moveTrait.lastMoveResult)||this.cancel()}))),this.queueingNode={tile:t,onBridge:i},this.state=g.WaitForTurn,!1)}if(this.state===g.WaitForTurn){if(!this.target.transportTrait.unitIsFirstInLoadQueue(e))return!1;this.queueingNode=void 0,this.state=g.MoveToTransport}if(this.state===g.MoveToTransport){if(!this.isAllowed(e))return!0;if(!this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target))return!(!this.movePerformed&&(this.children.push(new s.MoveInsideTask(this.game,this.target)),this.movePerformed=!0,this.preventOpportunityFire=!0));this.state=g.EnterTransport}return this.state===g.EnterTransport&&(!this.isAllowed(e)||this.isCancelling()?(this.children.push(new r.MoveOutsideTask(this.game,this.target)),this.state=g.ClearTransport,!1):(this.game.limboObject(e,{selected:!1,controlGroup:this.game.getUnitSelection().getOrCreateSelectionModel(e).getControlGroupNumber(),inTransport:!0}),this.game.events.dispatch(new n.EnterTransportEvent(this.target)),this.game.events.dispatch(new d.EnterObjectEvent(this.target,e)),this.target.transportTrait.units.push(e),!0))}getTargetLinesConfig(e){return{target:this.queueingNode?void 0:this.target,pathNodes:this.queueingNode?[this.queueingNode]:[]}}},e("EnterTransportTask",p)}}})),System.register("game/order/EnterTransportOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/unit/RangeHelper","game/order/OrderFeedbackType","game/gameobject/task/EnterTransportTask","game/gameobject/unit/ZoneType","game/gameobject/trait/MoveTrait","game/gameobject/task/system/CallbackTask","game/gameobject/task/move/MoveTask"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends i.Order{constructor(e){super(r.OrderType.EnterTransport),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=a.OrderFeedbackType.Enter}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){return!(!this.target.obj?.isVehicle()||!this.target.obj.transportTrait||this.target.obj.isDestroyed||this.target.obj===this.sourceObject||!this.game.areFriendly(this.target.obj,this.sourceObject)||!this.sourceObject.isVehicle()&&!this.sourceObject.isInfantry())}isAllowed(){let e=this.target.obj,t=this.sourceObject;return t.zone!==l.ZoneType.Air&&e.zone!==l.ZoneType.Air&&e.transportTrait.unitFitsInside(t)&&e.moveTrait.moveState===c.MoveState.Idle&&!e.warpedOutTrait.isActive()&&!t.mindControllableTrait?.isActive()&&!t.mindControllerTrait?.isActive()}process(){let e=this.sourceObject,t=this.target.obj;return this.game.map.terrain.getPassableSpeed(t.tile,e.rules.speedType,e.onBridge)?[new o.EnterTransportTask(this.game,t)]:[new h.CallbackTask((()=>{t.unitOrderTrait.addTask(new u.MoveTask(this.game,e.tile,e.onBridge)),t.unitOrderTrait.addTask(new h.CallbackTask((()=>{this.game.map.terrain.getPassableSpeed(t.tile,e.rules.speedType,e.onBridge)&&e.unitOrderTrait.addTask(new o.EnterTransportTask(this.game,t))})))}))]}onAdd(e,t){if(!t){let t=e.find((e=>e instanceof o.EnterTransportTask));if(this.isValid()&&this.isAllowed()&&t&&!t.isCancelling()&&t.target===this.target.obj&&new n.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("EnterTransportOrder",d)}}})),System.register("game/event/BuildingCaptureEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BuildingCaptureEvent",class{constructor(e){this.target=e,this.type=i.EventType.BuildingCapture}})}}})),System.register("game/gameobject/task/CaptureBuildingTask",["game/gameobject/task/system/Task","game/gameobject/Building","game/gameobject/task/move/MoveOutsideTask","game/gameobject/task/move/MoveInsideTask","game/event/BuildingCaptureEvent","game/event/EnterObjectEvent"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends i.Task{constructor(e,t){super(),this.game=e,this.target=t,this.aborted=!1,this.movePerformed=!1}isAllowed(e){return e.rules.engineer&&this.target.rules.capturable&&!this.target.isDestroyed&&this.target.buildStatus!==r.BuildStatus.BuildDown&&!this.game.areFriendly(e,this.target)}onTick(e){return!(!(this.isCancelling()&&!this.movePerformed||this.aborted||e.moveTrait.isDisabled())&&(this.game.map.tileOccupation.isTileOccupiedBy(e.tile,this.target)?!this.isAllowed(e)||this.isCancelling()?(this.children.push(new s.MoveOutsideTask(this.game,this.target)),this.aborted=!0):(this.game.unspawnObject(e),e.owner.buildingsCaptured++,this.game.changeObjectOwner(this.target,e.owner),this.game.events.dispatch(new a.BuildingCaptureEvent(this.target)),this.game.events.dispatch(new o.EnterObjectEvent(this.target,e)),0):!this.movePerformed&&(this.children.push(new n.MoveInsideTask(this.game,this.target)),this.movePerformed=!0)))}getTargetLinesConfig(e){return{target:this.target,pathNodes:[]}}},e("CaptureBuildingTask",l)}}})),System.register("game/order/CaptureOrder",["game/order/Order","game/order/OrderType","gui/PointerType","game/gameobject/unit/RangeHelper","game/gameobject/task/CaptureBuildingTask","game/order/OrderFeedbackType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends i.Order{constructor(e){super(r.OrderType.Capture),this.game=e,this.targetOptional=!1,this.terminal=!0,this.feedbackType=o.OrderFeedbackType.Capture}getPointerType(e){return e?this.isAllowed()?s.PointerType.OccupyMini:s.PointerType.NoActionMini:this.isAllowed()?s.PointerType.Occupy:s.PointerType.NoOccupy}isValid(){return!(this.target.obj?.isDestroyed||!this.target.obj?.isBuilding()||!this.sourceObject.isInfantry())&&this.target.obj.rules.capturable&&this.sourceObject.rules.engineer&&!this.game.areFriendly(this.sourceObject,this.target.obj)}isAllowed(){return!0}process(){return[new a.CaptureBuildingTask(this.game,this.target.obj)]}onAdd(e,t){if(!t){let t=e.find((e=>e instanceof a.CaptureBuildingTask));if(this.isValid()&&this.isAllowed()&&t&&!t.isCancelling()&&t.target===this.target.obj&&new n.RangeHelper(this.game.map.tileOccupation).isInTileRange(this.sourceObject,this.target.obj,0,Math.SQRT2))return!1}return!0}},e("CaptureOrder",l)}}})),System.register("game/order/OrderFactory",["game/order/OrderType","game/order/DeployOrder","game/order/MoveOrder","game/order/OccupyOrder","game/order/AttackOrder","game/order/StopOrder","game/order/CheerOrder","game/order/DockOrder","game/order/GatherOrder","game/order/AttackMoveOrder","game/order/RepairOrder","game/order/GuardAreaOrder","game/order/ScatterOrder","game/order/EnterTransportOrder","game/order/CaptureOrder"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e}],execute:function(){e("OrderFactory",class{constructor(e,t){this.game=e,this.map=t}create(e,t){switch(e){case i.OrderType.Deploy:return new r.DeployOrder(this.game,!0);case i.OrderType.DeploySelected:return new r.DeployOrder(this.game,!1);case i.OrderType.ForceMove:return new s.MoveOrder(this.game,this.map,t,!0);case i.OrderType.Move:return new s.MoveOrder(this.game,this.map,t);case i.OrderType.ForceAttack:return new a.AttackOrder(this.game,{forceAttack:!0});case i.OrderType.Attack:return new a.AttackOrder(this.game,{noIvanBomb:!0});case i.OrderType.PlaceBomb:return new a.AttackOrder(this.game);case i.OrderType.AttackMove:return new u.AttackMoveOrder(this.game,this.map);case i.OrderType.Capture:return new f.CaptureOrder(this.game);case i.OrderType.Occupy:return new n.OccupyOrder(this.game);case i.OrderType.Stop:return new o.StopOrder(this.game);case i.OrderType.Cheer:return new l.CheerOrder;case i.OrderType.Dock:return new c.DockOrder(this.game);case i.OrderType.Gather:return new h.GatherOrder(this.game);case i.OrderType.Repair:return new d.RepairOrder(this.game);case i.OrderType.Guard:return new g.GuardAreaOrder(this.game,!1);case i.OrderType.GuardArea:return new g.GuardAreaOrder(this.game,!0);case i.OrderType.Scatter:return new p.ScatterOrder(this.game);case i.OrderType.EnterTransport:return new m.EnterTransportOrder(this.game);default:throw new Error("Unhandled order type "+i.OrderType[e])}}})}}})),System.register("game/order/orderPriorities",["game/order/OrderType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("orderPriorities",[i.OrderType.Occupy,i.OrderType.Dock,i.OrderType.Attack,i.OrderType.Capture,i.OrderType.Repair,i.OrderType.EnterTransport,i.OrderType.PlaceBomb,i.OrderType.Deploy,i.OrderType.Gather])}}})),System.register("game/event/CheerEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("CheerEvent",class{constructor(e){this.player=e,this.type=i.EventType.Cheer}})}}})),System.register("game/event/DeployNotAllowedEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("DeployNotAllowedEvent",class{constructor(e){this.target=e,this.type=i.EventType.DeployNotAllowed}})}}})),System.register("game/action/OrderUnitsAction",["data/DataStream","game/action/Action","game/order/OrderType","game/order/orderPriorities","game/order/MoveOrder","game/gameobject/unit/MovePositionHelper","game/order/DeployOrder","game/event/CheerEvent","game/event/DeployNotAllowedEvent","util/typeGuard","game/gameobject/unit/ScatterPositionHelper","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){e("ORDER_UNIT_LIMIT",128),p=class extends r.Action{constructor(e,t,i,r){super(g.ActionType.OrderUnits),this.game=e,this.map=t,this.orderActionContext=i,this.orderFactory=r,this.queue=!1,this.isInvalid=!1}unserialize(e){let t=new i.DataStream(e);this.orderType=t.readUint8();var r=t.readUint8();if(0!==r){var s=t.readUint16(),n=t.readUint16();let e;if(this.queue=2<r&&Boolean(t.readUint8()),3<r){if(r=t.readUint32(),!this.game.getWorld().hasObjectId(r))return void(this.isInvalid=!0);e=this.game.getObjectById(r)}else e=void 0;(n=this.map.tiles.getByMapCoords(s,n))?this.target=this.game.createTarget(e,n):this.isInvalid=!0}}serialize(){let e=new i.DataStream(11);e.dynamicSize=!1,e.writeUint8(this.orderType);let t=0;e.writeUint8(t),this.target&&(e.writeUint16(this.target.tile.rx),e.writeUint16(this.target.tile.ry),t+=2,r=(this.target.obj||this.target.getBridge())?.id,!this.queue&&void 0===r||(e.writeUint8(Number(this.queue)),t+=1),void 0!==r&&(e.writeUint32(r),t+=1));var r=e.position;return 0<t&&(e.seek(1),e.writeUint8(t)),new Uint8Array(e.buffer,e.byteOffset,r)}print(){return this.isInvalid?"":s.OrderType[this.orderType]+" order "+(this.target?`[obj: ${(this.target.obj||this.target.getBridge())?.name||"<none>"}, tile: ${this.target.tile.rx},${this.target.tile.ry}]`+(this.queue?"(queue)":""):"")}process(){if(!this.isInvalid){let t=this.player;const i=this.game.mapShroudTrait.getPlayerShroud(t);if(i){const r=this.target?.obj;if(r){if(!this.game.map.tileOccupation.calculateTilesForGameObject(r.tile,r).find((e=>!i.isShrouded(e,r.tileElevation))))return}let n=this.validateOrders(t).slice(0,128),l=[],h=[],u=[],g=[],p=[];if(n.forEach((e=>{(e instanceof a.MoveOrder?h:e.orderType===s.OrderType.Scatter?u:e.orderType===s.OrderType.DeploySelected?g:e.orderType===s.OrderType.Cheer?p:l).push(e)})),h.length&&this.target)if(h[0].isEnemyBuildingBlock())h.forEach((e=>l.push(e)));else{let t=this.target.getBridge();var e=h.map((e=>e.sourceObject));let i=new o.MovePositionHelper(this.map).findPositions(e,this.target.tile,t);h.forEach((e=>{var r=i.get(e.sourceObject),s=!t||t.isHighBridge()?this.map.tileOccupation.getBridgeOnTile(r):t;r=this.game.createTarget(s,r);e.target=r,l.push(e)}))}if(u.length){e=u.map((e=>e.sourceObject)).filter((e=>e.isInfantry()||e.isVehicle()));let t=new d.ScatterPositionHelper(this.game).findPositions(e);u.forEach((e=>{var i=t.get(e.sourceObject);i&&(i=this.game.createTarget(i.onBridge,i.tile),e.target=i,l.push(e))}))}if(g.length){let e=[];g.forEach((t=>{((t.sourceObject.isInfantry()||t.sourceObject.isVehicle())&&t.sourceObject.deployerTrait?e:l).push(t)}));let t=e.filter((e=>!e.sourceObject.deployerTrait.isDeployed()));t.length?t.forEach((e=>l.push(e))):e.forEach((e=>l.push(e)))}p.length&&(t.cheerCooldownTicks||(t.cheerCooldownTicks=this.game.rules.general.maximumCheerRate,l.push(...p),this.game.events.dispatch(new c.CheerEvent(t)))),l.forEach((e=>e.sourceObject.unitOrderTrait.addOrder(e,this.queue))),this.updateWaypointPaths(l)}}}validateOrders(e){let t=this.orderActionContext.getOrCreateSelection(e);var i,r=t.getSelectedUnits();let a=this.orderFactory.create(this.orderType,t);a.target=this.target;let o=[];for(i of r)if(!(i.owner!==e||i.rules.spawned||i.isDestroyed||i.isCrashing||i.isDisposed||i.warpedOutTrait.isActive()||(a.sourceObject=i,a instanceof l.DeployOrder&&a.isValid()&&!a.isAllowed()&&this.game.events.dispatch(new h.DeployNotAllowedEvent(i)),a.singleSelectionRequired&&1<r.length)))if(a.isValid()&&a.isAllowed()){let e=this.orderFactory.create(this.orderType,t);e.set(i,this.target),o.push(e)}else{let e=!1;for(var c of n.orderPriorities){let s=this.orderFactory.create(c,t);if(s.set(i,this.target),!(s.singleSelectionRequired&&1<r.length)&&s.targetOptional===!this.target&&s.isValid()&&s.isAllowed()){o.push(s),e=!0;break}}if(!e&&this.target&&this.orderType!==s.OrderType.Deploy){let e=this.orderFactory.create(s.OrderType.Move,t);e.set(i,this.target),e.isValid()&&e.isAllowed()&&o.push(e)}}return o}updateWaypointPaths(e){if(this.queue&&this.target){let r=e.map((e=>e.sourceObject));var t=[...new Set(r.map((e=>e.unitOrderTrait.waypointPath)).filter(u.isNotNullOrUndefined))];if(t.length<=1){var i={orderType:this.orderType,target:this.target,terminal:e.some((e=>e.terminal)),next:void 0};if(0===t.length){let e={units:r,waypoints:[i]};r.forEach((t=>{t.unitOrderTrait.waypointPath=e}))}else{let e=t[0];e.waypoints[e.waypoints.length-1].next=i,e.waypoints.push(i)}}}}},e("OrderUnitsAction",p)}}})),System.register("game/action/SelectUnitsAction",["game/action/Action","game/action/ActionType","data/DataStream","game/action/OrderUnitsAction"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends i.Action{constructor(e,t){super(r.ActionType.SelectUnits),this.orderActionContext=t}get unitIds(){return this._unitIds}set unitIds(e){this._unitIds=e.slice(0,n.ORDER_UNIT_LIMIT)}unserialize(e){let t=new s.DataStream(e);this.unitIds=new Array(e.byteLength/4);for(let i=0;i<e.byteLength/4;i++)this.unitIds[i]=t.readUint32()}serialize(){let e=new s.DataStream(4*this.unitIds.length);for(var t of(e.dynamicSize=!1,this.unitIds))e.writeUint32(t);return e.toUint8Array()}print(){return`Select unit(s) [${this.unitIds.join(",")}]`}process(){let e=this.player,t=[];for(var i of this.unitIds)(i=e.getOwnedObjectById(i))&&t.push(i);this.orderActionContext.getOrCreateSelection(e).update(t)}},e("SelectUnitsAction",a)}}})),System.register("game/action/ResignGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends i.Action{constructor(e,t){super(s.ActionType.ResignGame),this.game=e,this.localPlayerName=t}process(){if(this.localPlayerName!==this.player.name){let e=this.player;this.game.removeAllPlayerAssets(e),e.isCombatant()&&(e.resigned=!0,this.game.events.dispatch(new r.PlayerResignedEvent(e)))}}},e("ResignGameAction",n)}}})),System.register("game/superweapon/SuperWeaponEffect",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NotStarted=0]="NotStarted",t[t.Running=1]="Running",t[t.Finished=2]="Finished",e("EffectStatus",i),e("SuperWeaponEffect",class{constructor(e,t,r){this.type=e,this.owner=t,this.tile=r,this.status=i.NotStarted}onStart(e){}onTick(e){return!0}})}}})),System.register("game/gameobject/task/ParadropTask",["game/Coords","game/math/Vector3","game/gameobject/infantry/InfDeathType","game/gameobject/infantry/StanceType","game/gameobject/task/system/Task"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends a.Task{constructor(e){super(),this.game=e}onTick(e){var t=Math.abs(this.game.rules.general.parachuteMaxFallRate),a=e.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(e.tile).tileElevation:0,o=i.Coords.tileHeightToWorld(a),l=e.tileElevation,c=i.Coords.tileHeightToWorld(l);return o<Math.max(o,c-t)?(e.position.moveByLeptons3(new r.Vector3(0,-t,0)),e.moveTrait.handleElevationChange(l,this.game),!1):(e.position.tileElevation=a,e.stance=n.StanceType.None,this.game.map.terrain.getPassableSpeed(e.tile,e.rules.speedType,e.onBridge)||(e.infDeathType=s.InfDeathType.None,this.game.destroyObject(e,void 0,!0)),!0)}},e("ParadropTask",o)}}})),System.register("game/superweapon/ParadropEffect",["game/Coords","engine/type/ObjectType","game/gameobject/Infantry","game/gameobject/infantry/StanceType","game/gameobject/task/move/MoveTask","game/gameobject/task/ParadropTask","game/gameobject/trait/UnlandableTrait","game/gameobject/unit/FacingUtil","game/gameobject/unit/RangeHelper","game/gameobject/unit/VeteranLevel","game/gameobject/unit/ZoneType","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/math/Vector2","util/bresenham","game/superweapon/SuperWeaponEffect"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){var t;(t=T=T||{})[t.Spawning=0]="Spawning",t[t.EnRoute=1]="EnRoute",t[t.Dropping=2]="Dropping",t[t.TurningAround=3]="TurningAround",v=5*g.GameSpeed.BASE_TICKS_PER_SECOND,b=class extends y.SuperWeaponEffect{constructor(e,t,i,r,s){super(e,t,i),this.paradropSquad=r,this.state=T.Spawning,this.spawnDelay=s*v}onStart(e){this.passengerRules=e.rules.getObject(this.paradropSquad.inf,r.ObjectType.Infantry),this.passengerCount=this.paradropSquad.num}computeFlightPath(e,t,r){if(t.equals(e))throw new Error("Source and destination must be different");let s=e.clone().sub(t);var n=r.rules.general.paradrop.paradropRadius/i.Coords.LEPTONS_PER_TILE;n=t.clone().add(s.clone().setLength(s.length()+2*n)).floor();let a=f.bresenham(t.x,t.y,n.x,n.y).map((e=>r.map.tiles.getByMapCoords(e.x,e.y)??r.map.tiles.getPlaceholderTile(e.x,e.y)));for(;a.length;){var o=a[0];o=i.Coords.tileToWorld(o.rx+.5,o.ry+.5);if(r.map.isWithinHardBounds(new m.Vector2(o.x,o.y)))break;a.shift()}if(!a.length)throw new Error("No valid paradrop path found");return{fromTile:a[0],toTile:a[a.length-1]}}onTick(e){if(this.state===T.Spawning){if(0<this.spawnDelay)return this.spawnDelay--,!1;var t=e.map.tiles.getMapSize(),s=[new m.Vector2(0,0),new m.Vector2(Math.floor(t.width/2),0),new m.Vector2(0,Math.floor(t.height/2))][e.generateRandomInt(0,2)];let n=this.passengerRules.speedType,o=new p.RadialTileFinder(e.map.tiles,e.map.mapBounds,this.tile,{width:1,height:1},0,50,(t=>0<e.map.terrain.getPassableSpeed(t,n,!!t.onBridgeLandType)));if(!(f=this.targetTile=o.getNextTile()))return!0;let h=new m.Vector2(f.rx,f.ry);var{fromTile:g,toTile:t}=this.computeFlightPath(h,s,e),f=e.rules.general.paradrop.paradropPlane;s=e.rules.getObject(f,r.ObjectType.Aircraft);let u=this.pdPlane=e.createUnitForPlayer(s,this.owner);e.spawnObject(u,g),u.direction=c.FacingUtil.fromMapCoords(h.clone().sub(new m.Vector2(g.rx,g.ry))),u.position.tileElevation=i.Coords.worldToTileHeight(u.rules.flightLevel??e.rules.general.flightLevel),u.zone=d.ZoneType.Air,u.onBridge=!1,u.unitOrderTrait.addTask(new a.MoveTask(e,t,!1,{allowOutOfBoundsTarget:!0})),u.traits.get(l.UnlandableTrait).setEnabled(!1),this.state=T.EnRoute}if(!this.pdPlane||this.pdPlane.isDestroyed||this.pdPlane.isCrashing)return!0;if(f=this.targetTile,!this.pdPlane.unitOrderTrait.hasTasks())return this.state=T.TurningAround,this.pdPlane.unitOrderTrait.addTask(new a.MoveTask(e,f,!1,{allowOutOfBoundsTarget:!0})),!1;if(s=e.rules.general.paradrop.paradropRadius/i.Coords.LEPTONS_PER_TILE,g=new h.RangeHelper(e.map.tileOccupation).isInTileRange(this.pdPlane.tile,f,0,s),this.state===T.EnRoute&&g&&(this.state=T.Dropping),this.state===T.Dropping)if(g&&0<this.passengerCount){let i=!!(t=this.pdPlane.tile).onBridgeLandType;if(!e.map.terrain.getPassableSpeed(t,this.passengerRules.speedType,i))return!1;if(e.map.getGroundObjectsOnTile(t).some((e=>e.isVehicle()&&e.onBridge===i||e.isBuilding()&&!e.isDestroyed||e.isInfantry()&&e.stance===n.StanceType.Paradrop)))return!1;if(!(s=this.findFreeSubCell(e,t)))return!1;this.passengerCount--;let r=e.createUnitForPlayer(this.passengerRules,this.owner);r.stance=n.StanceType.Paradrop,r.position.tileElevation=this.pdPlane.tileElevation,r.position.subCell=s,r.onBridge=i,r.rules.trainable&&this.owner.canProduceVeteran(r.rules)&&r.veteranTrait?.setVeteranLevel(u.VeteranLevel.Veteran),e.spawnObject(r,t),r.unitOrderTrait.addTask(new o.ParadropTask(e).setCancellable(!1))}else{if(!(0<this.passengerCount))return this.pdPlane.unitOrderTrait.getCurrentTask().forceCancel(this.pdPlane),this.pdPlane.traits.get(l.UnlandableTrait).setEnabled(!0),!0;this.state=T.TurningAround,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(f,!!f.onBridgeLandType)}return this.state===T.TurningAround&&g&&(f=this.computeFlightPath(new m.Vector2(f.rx,f.ry),new m.Vector2(this.pdPlane.tile.rx,this.pdPlane.tile.ry),e).toTile,this.pdPlane.unitOrderTrait.getCurrentTask().updateTarget(f,!1),this.state=T.EnRoute),!1}findFreeSubCell(e,t){let i=e.map.getGroundObjectsOnTile(t).filter((e=>e.isTerrain())).map((t=>t.rules.getOccupiedSubCells(e.map.getTheaterType()))).flat();var r=s.Infantry.SUB_CELLS.filter((e=>-1===i.indexOf(e)));if(r.length)return 1<r.length?r[e.generateRandomInt(0,r.length-1)]:r[0]}},e("ParadropEffect",b)}}})),System.register("game/superweapon/NukeEffect",["game/Coords","engine/type/ObjectType","game/math/Vector2","game/Weapon","game/WeaponType","game/superweapon/SuperWeaponEffect"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends o.SuperWeaponEffect{constructor(e,t,i,r){super(e,t,i),this.weaponType=r}onStart(e){var t=e.rules.getWeapon(this.weaponType),i=e.createTarget(void 0,this.tile),s=this.owner.getOwnedObjectsByType(r.ObjectType.Building).find((e=>e.rules.nukeSilo));if(s){n.Weapon.factory(t.name,a.WeaponType.Primary,s,e.rules).fire(i,e)}else this.fireLooseNuke(t,i,e)}fireLooseNuke(e,t,r){var n=new s.Vector2(this.tile.rx+.5,this.tile.ry+.5).multiplyScalar(i.Coords.LEPTONS_PER_TILE);if(r.map.isWithinHardBounds(n)){let s=r.createLooseProjectile(e.name,this.owner,t);s.position.moveToLeptons(n),s.position.tileElevation=i.Coords.worldToTileHeight(s.rules.detonationAltitude),r.spawnObject(s,s.position.tile)}}onTick(e){return!0}},e("NukeEffect",l)}}})),System.register("game/superweapon/LightningStormEffect",["game/Coords","game/event/LightningStormCloudEvent","game/event/LightningStormManifestEvent","game/gameobject/unit/CollisionType","game/gameobject/unit/RangeHelper","game/GameSpeed","game/map/tileFinder/RandomTileFinder","game/Warhead","game/superweapon/SuperWeaponEffect"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){var t;(t=u=u||{})[t.Approaching=0]="Approaching",t[t.Manifesting=1]="Manifesting",d=class extends h.SuperWeaponEffect{constructor(){super(...arguments),this.state=u.Approaching,this.clouds=[]}onStart(e){var t=e.rules.general.lightningStorm;this.manifestStartTimer=t.deferment,this.manifestEndTimer=t.duration,this.nextDirectHitTimer=0,this.nextRandomHitTimer=0}onTick(e){if(this.state===u.Approaching&&(0<this.manifestStartTimer?this.manifestStartTimer--:(this.state=u.Manifesting,e.events.dispatch(new s.LightningStormManifestEvent(this.tile)))),this.state===u.Manifesting){var t,r=e.rules.general.lightningStorm;if(0<this.manifestEndTimer&&(this.manifestEndTimer--,0<this.nextDirectHitTimer&&this.nextDirectHitTimer--,this.nextDirectHitTimer<=0&&(this.nextDirectHitTimer=r.hitDelay,this.spawnCloudAt(this.tile,e)),0<this.nextRandomHitTimer&&this.nextRandomHitTimer--,this.nextRandomHitTimer<=0)){this.nextRandomHitTimer=r.scatterDelay;var o=Math.floor(r.cellSpread/2);let t=r.separation,i=new a.RangeHelper(e.map.tileOccupation),s=new l.RandomTileFinder(e.map.tiles,e.map.mapBounds,this.tile,o,e,(e=>!this.clouds.some((r=>i.tileDistance(e,r.tile)<t))),!1);(o=s.getNextTile())&&this.spawnCloudAt(o,e)}for(t of this.clouds.slice())if(0<t.ticksLeft){if(t.ticksLeft--,t.ticksLeft===Math.floor(t.durationTicks/2)){var h=r.warhead;let s=new c.Warhead(e.rules.getWarhead(h));var d=t.tile,g=e.map.tileOccupation.getBridgeOnTile(d),p=g?.tileElevation??0;h=e.map.getTileZone(d);s.detonate(e,r.damage,d,p,i.Coords.tile3dToWorld(d.rx+.5,d.ry+.5,d.z+p),h,g?n.CollisionType.OnBridge:n.CollisionType.None,e.createTarget(g,d),{player:this.owner,weapon:void 0},!1,!0,void 0)}}else this.clouds.splice(this.clouds.indexOf(t),1);if(!this.clouds.length&&this.manifestEndTimer<=0)return!0}return!1}spawnCloudAt(e,t){var s=t.rules.audioVisual.weatherConClouds;s=t.generateRandomInt(0,s.length-1);s=t.art.getAnimation(t.rules.audioVisual.weatherConClouds[s]).art.getNumber("Rate",60*o.GameSpeed.BASE_TICKS_PER_SECOND)/60,s=Math.floor(o.GameSpeed.BASE_TICKS_PER_SECOND/s*60),this.clouds.push({tile:e,durationTicks:s,ticksLeft:s}),s=(t.map.tileOccupation.getBridgeOnTile(e)?.tileElevation??0)+i.Coords.worldToTileHeight(t.rules.general.flightLevel),s=i.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z+s),t.events.dispatch(new r.LightningStormCloudEvent(s))}},e("LightningStormEffect",d)}}})),System.register("game/superweapon/IronCurtainEffect",["game/map/tileFinder/RadialTileFinder","game/superweapon/SuperWeaponEffect"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.SuperWeaponEffect{onStart(e){var t,r,s=e.rules.combatDamage.ironCurtainDuration,n={player:this.owner};let a=new i.RadialTileFinder(e.map.tiles,e.map.mapBounds,this.tile,{width:1,height:1},0,1,(()=>!0));for(;t=a.getNextTile();)for(r of e.map.getGroundObjectsOnTile(t))!r.isTechno()||r.isUnit()&&r.tile!==t||r.rules.missileSpawn||(r.rules.organic?r.isDestroyed||e.destroyObject(r,n):(r.invulnerableTrait.setActiveFor(s,e.currentTick),(r.isVehicle()||r.isAircraft())&&r.parasiteableTrait?.isInfested()&&r.parasiteableTrait.destroyParasite(n,e)))}onTick(e){return!0}},e("IronCurtainEffect",s)}}})),System.register("game/superweapon/ChronoSphereEffect",["game/gameobject/common/DeathType","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/map/tileFinder/RadialTileFinder","game/type/MovementZone","game/type/SpeedType","game/superweapon/SuperWeaponEffect"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends l.SuperWeaponEffect{constructor(e,t,i,r){super(e,t,i),this.tile2=r,this.objectsToTeleport=[]}onStart(e){this.delayTicks=e.rules.general.chronoDelay;let t=e.map.tiles;for(let o=-1;o<=1;o++)for(let l=-1;l<=1;l++){var i=t.getByMapCoords(this.tile.rx+o,this.tile.ry+l);if(i){var s,n=!!i.onBridgeLandType,a=t.getByMapCoords(this.tile2.rx+o,this.tile2.ry+l);for(s of e.map.getGroundObjectsOnTile(i))!s.isUnit()||s.tile!==i||s.onBridge!==n||s.isInfantry()&&s.stance===r.StanceType.Paradrop||s.isDisposed||(s.rules.organic&&!s.rules.teleporter||!a?e.destroyObject(s,{player:this.owner}):s.warpedOutTrait.isActive()||(s.warpedOutTrait.setActive(!0,!0,e),this.objectsToTeleport.push({obj:s,destTile:a})))}}}onTick(e){if(0<this.delayTicks&&this.delayTicks--,this.delayTicks)return!1;for(let{obj:h,destTile:u}of this.objectsToTeleport)if(h.isSpawned){let d=!1,g=u?e.map.tileOccupation.getBridgeOnTile(u):void 0,p=e.map.getGroundObjectsOnTile(u),m=p.find((e=>e.isBuilding()));var t=p.some((t=>e.rules.general.padAircraft.includes(t.name))),l=e.rules.general.padAircraft.includes(h.name)&&!!m?.helipadTrait&&!!m.dockTrait?.getAllDockTiles().includes(u)&&!m.dockTrait.hasReservedDockAt(m.dockTrait.getDockNumberByTile(u))&&m.owner===h.owner;let f=!1,y=h.rules.speedType;h.rules.movementZone===a.MovementZone.Fly&&(y=o.SpeedType.Wheel);var c=e.map.mapBounds.isWithinBounds(u);if(!(l||e.map.terrain.getPassableSpeed(u,y,!!g)&&c)){let r=!1;if(!t&&(0<e.map.terrain.getPassableSpeed(u,y,!!g,void 0,!0)||!c)){m&&(d=!0),(c=new n.RadialTileFinder(e.map.tiles,e.map.mapBounds,u,{width:1,height:1},1,15,(t=>0<e.map.terrain.getPassableSpeed(t,y,!!t.onBridgeLandType)&&!e.map.terrain.findObstacles({tile:t,onBridge:!!t.onBridgeLandType},h).length)).getNextTile())&&(u=c,g=e.map.tileOccupation.getBridgeOnTile(u),p=e.map.getGroundObjectsOnTile(u),r=!0)}r||(h.moveTrait.teleportUnitToTile(u,g,!0,!1,e),h.warpedOutTrait.setActive(!1,!0,e),e.map.getTileZone(u)===s.ZoneType.Water&&(h.deathType=i.DeathType.Sink),e.destroyObject(h,{player:this.owner}),f=!0)}if(!f||t)for(let t of p)t.isDisposed||t.isUnit()&&(this.objectsToTeleport.some((({obj:e})=>e===t))||t.onBridge!==!!g&&t.tile===u||2<Math.abs(t.tileElevation-h.tileElevation)||(t.isInfantry()&&t.stance!==r.StanceType.Paradrop&&(t.deathType=i.DeathType.Crush),e.destroyObject(t,{player:this.owner,obj:h})));if(!f){if(h.moveTrait.teleportUnitToTile(u,g,!0,!1,e),l&&m?.dockTrait){if(l=m.dockTrait.getAllDockTiles().indexOf(u),m.dockTrait.undockUnitAt(l),m.dockTrait.hasReservedDockAt(l))throw new Error("Target building dock is already reserved by another unit");m.dockTrait.dockUnitAt(h,l)}d?h.warpedOutTrait.setTimed(e.rules.general.chronoDelay,!1,e):h.warpedOutTrait.setActive(!1,!0,e)}}return!0}},e("ChronoSphereEffect",c)}}})),System.register("game/trait/SuperWeaponsTrait",["game/trait/interface/NotifyWarpChange","game/SuperWeapon","game/superweapon/SuperWeaponEffect","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/interface/NotifySuperWeaponActivate","game/event/SuperWeaponActivateEvent","game/superweapon/ParadropEffect","game/superweapon/NukeEffect","game/superweapon/LightningStormEffect","game/superweapon/IronCurtainEffect","game/superweapon/ChronoSphereEffect","game/trait/interface/NotifySuperWeaponDeactivate"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class{constructor(){this.effects=[]}[a.NotifyTick.onTick](e){for(var t of e.getCombatants()){var i;for(i of t.superWeaponsTrait.getAll())i.update(e)}for(let t of this.effects)t.status===s.EffectStatus.NotStarted&&(t.onStart(e),t.status=s.EffectStatus.Running),t.onTick(e)&&(t.status=s.EffectStatus.Finished,e.traits.filter(m.NotifySuperWeaponDeactivate).forEach((i=>{i[m.NotifySuperWeaponDeactivate.onDeactivate](t.type,t.owner,e)})));this.effects=this.effects.filter((e=>e.status!==s.EffectStatus.Finished))}[n.NotifyPower.onPowerLow](e,t){e.superWeaponsTrait?.getAll()?.filter((e=>e.rules.isPowered)).forEach((e=>{this.updateTimer(e,!1)}))}[n.NotifyPower.onPowerRestore](e,t){e.superWeaponsTrait?.getAll()?.filter((e=>e.rules.isPowered)).forEach((e=>{this.updateTimer(e,!0)}))}[n.NotifyPower.onPowerChange](e,t){}[i.NotifyWarpChange.onChange](e,t){var i;e.owner.powerTrait&&e.isBuilding()&&e.superWeaponTrait&&(i=e.superWeaponTrait.getSuperWeapon(e))&&this.updateTimer(i,!e.owner.powerTrait.isLowPower())}updateTimer(e,t){var i=this.superWeaponHasValidBuilding(e);t&&i?e.resumeTimer():e.pauseTimer()}superWeaponHasValidBuilding(e){return[...e.owner.buildings].find((t=>!(t.superWeaponTrait?.getSuperWeapon(t)!==e||t.warpedOutTrait.isActive()&&e.rules.isPowered)))}addEffect(e){this.effects.push(e)}activateSuperWeapon(e,t,i,s,n){let a=t.superWeaponsTrait?.getAll().find((t=>t.rules.type===e));if(a&&a.status===r.SuperWeaponStatus.Ready){if(a.oneTimeOnly)for(var o of(t.superWeaponsTrait.remove(a.name),t.buildings))o.rules.superWeapon===a.name&&o.superWeaponTrait&&o.superWeaponTrait.addSuperWeaponToPlayerIfNeeded(t,i);else a.resetTimer();this.activateEffect(a.rules,t,i,s,n)}}activateEffect(e,t,i,r,s,n=!1){const a=e.type;if(void 0!==a){let b=[];switch(a){case o.SuperWeaponType.AmerParaDrop:for(var[m,f]of i.rules.general.paradrop.amerParaDrop.entries())b.push(new h.ParadropEffect(a,t,r,f,m));break;case o.SuperWeaponType.ParaDrop:{let e=i.rules.general.paradrop.getParadropSquads(t.country.side);for(var[y,T]of e.entries())b.push(new h.ParadropEffect(a,t,r,T,y));break}case o.SuperWeaponType.MultiMissile:if(!e.weaponType)throw new Error("Missing WeaponType in super weapon rules");b.push(new u.NukeEffect(a,t,r,e.weaponType));break;case o.SuperWeaponType.LightningStorm:b.push(new d.LightningStormEffect(a,t,r));break;case o.SuperWeaponType.IronCurtain:b.push(new g.IronCurtainEffect(a,t,r));break;case o.SuperWeaponType.ChronoSphere:if(!s)throw new Error("Missing tile2 action param");b.push(new p.ChronoSphereEffect(a,t,r,s))}for(var v of b)this.addEffect(v);i.traits.filter(l.NotifySuperWeaponActivate).forEach((e=>{e[l.NotifySuperWeaponActivate.onActivate](a,t,i,r,s)})),i.events.dispatch(new c.SuperWeaponActivateEvent(a,t,r,s,n))}}},e("SuperWeaponsTrait",f)}}})),System.register("game/action/ActivateSuperWeaponAction",["data/DataStream","game/action/Action","game/action/ActionType","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends r.Action{constructor(e){super(s.ActionType.ActivateSuperWeapon),this.game=e}unserialize(e){let t=new i.DataStream(e);this.superWeaponType=t.readUint8();var r=t.readUint8();this.tile={x:t.readUint16(),y:t.readUint16()},this.tile2=2<r?{x:t.readUint16(),y:t.readUint16()}:void 0}serialize(){let e=new i.DataStream(6+(this.tile2?4:0));return e.dynamicSize=!1,e.writeUint8(this.superWeaponType),e.writeUint8(this.tile2?4:2),e.writeUint16(this.tile.x),e.writeUint16(this.tile.y),this.tile2&&(e.writeUint16(this.tile2.x),e.writeUint16(this.tile2.y)),e.toUint8Array()}print(){return`Activate SuperW ${n.SuperWeaponType[this.superWeaponType]} at tile (${this.tile.x}, ${this.tile.y})`+(this.tile2?`, (${this.tile2.x}, ${this.tile2.y})`:"")}process(){var e,t=this.player,i=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);i?(e=this.tile2?this.game.map.tiles.getByMapCoords(this.tile2.x,this.tile2.y):void 0,this.game.traits.get(a.SuperWeaponsTrait).activateSuperWeapon(this.superWeaponType,t,this.game,i,e)):console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},e("ActivateSuperWeaponAction",o)}}})),System.register("game/api/ChatApi",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/action/DebugAction",["data/DataStream","game/action/Action","game/action/ActionType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){var t;(t=n=n||{})[t.SetGlobalDebugText=0]="SetGlobalDebugText",t[t.SetUnitDebugText=1]="SetUnitDebugText",e("DebugCommandType",n),e("DebugCommand",a=class{constructor(e,t){this.type=e,this.params=t}}),o=class extends r.Action{constructor(e){super(s.ActionType.DebugCommand),this.game=e}unserialize(e){let t=new i.DataStream(e);var r=t.readUint8();r===n.SetUnitDebugText?this.command=new a(r,{unitId:t.readUint32(),label:t.readCString()||void 0}):r===n.SetGlobalDebugText?this.command=new a(r,{text:t.readCString()}):console.warn(`Debug command ${r} not implemented`)}serialize(){let e=new i.DataStream;if(e.writeUint8(this.command.type),this.command.type===n.SetUnitDebugText){var t=this.command.params;e.writeUint32(t.unitId),e.writeCString(t.label||"")}else{if(this.command.type!==n.SetGlobalDebugText)throw new Error(`Debug command ${this.command.type} not implemented`);t=this.command.params,e.writeCString(t.text)}return e.toUint8Array()}process(){if(this.command.type===n.SetUnitDebugText){var{unitId:e,label:t}=this.command.params;if(this.game.getWorld().hasObjectId(e)){let i=this.game.getObjectById(e);i.isTechno()&&(i.debugLabel=t)}}else this.command.type===n.SetGlobalDebugText?(t=this.command.params.text,this.game.debugText.value=t):console.warn(`Debug command ${this.command.type} not implemented`)}},e("DebugAction",o)}}})),System.register("game/api/EventsApi",["game/event/EventType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.ObjectOwnerChange=0]="ObjectOwnerChange",t[t.ObjectSpawn=1]="ObjectSpawn",t[t.ObjectUnspawn=2]="ObjectUnspawn",t[t.ObjectDestroy=3]="ObjectDestroy",e("ApiEventType",o),e("EventsApi",class{constructor(e){i.add(this),r.set(this,void 0),s.set(this,[]),__classPrivateFieldSet(this,r,e,"f")}subscribe(e,t){let a,o;o="function"==typeof e?e:(a=e,t);var l=__classPrivateFieldGet(this,r,"f").subscribe((e=>{var t=__classPrivateFieldGet(this,i,"m",n).call(this,e);!t||void 0!==a&&a!==t.type||o(t)}));return __classPrivateFieldGet(this,s,"f").push(l),l}dispose(){for(var e of __classPrivateFieldGet(this,s,"f"))e();__classPrivateFieldGet(this,s,"f").length=0}}),r=new WeakMap,s=new WeakMap,i=new WeakSet,n=function(e){switch(e.type){case a.EventType.ObjectOwnerChange:return{type:o.ObjectOwnerChange,prevOwnerName:e.prevOwner.name,newOwnerName:e.target.owner.name,target:e.target.id};case a.EventType.ObjectSpawn:return{type:o.ObjectSpawn,target:e.gameObject.id};case a.EventType.ObjectUnspawn:return{type:o.ObjectUnspawn,target:e.gameObject.id};case a.EventType.ObjectDestroy:{let t=e;return t.target.isProjectile()?void 0:{type:o.ObjectDestroy,target:t.target.id,attackerInfo:t.attackerInfo?{playerName:t.attackerInfo.player.name,objId:t.attackerInfo.obj?.id,weaponName:t.attackerInfo.weapon?.rules.name}:void 0}}default:return}}}}})),System.register("game/api/interface/PlayerData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/interface/GameObjectData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/interface/UnitData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/interface/TileResourceData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/interface/PathNode",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/interface/PathFinderOptions",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/MapApi",["game/gameobject/trait/TiberiumTrait","engine/type/TiberiumType","game/math/Vector2"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("MapApi",class{constructor(e){i.add(this),r.set(this,void 0),s.set(this,void 0),__classPrivateFieldSet(this,r,e,"f"),__classPrivateFieldSet(this,s,e.map,"f")}getRealMapSize(){return __classPrivateFieldGet(this,s,"f").tiles.getMapSize()}getStartingLocations(){return __classPrivateFieldGet(this,s,"f").startingLocations.map((e=>new l.Vector2(e.x,e.y)))}getTheaterType(){return __classPrivateFieldGet(this,s,"f").getTheaterType()}getTile(e,t){var i=__classPrivateFieldGet(this,s,"f").tiles.getByMapCoords(e,t);if(i&&__classPrivateFieldGet(this,s,"f").mapBounds.isWithinBounds(i))return i}getTilesInRect(e,t){return __classPrivateFieldGet(this,s,"f").tiles.getInRectangle(e,t).filter((e=>__classPrivateFieldGet(this,s,"f").mapBounds.isWithinBounds(e)))}getObjectsOnTile(e){return __classPrivateFieldGet(this,s,"f").getObjectsOnTile(e).map((e=>e.id))}hasBridgeOnTile(e){return!!e.onBridgeLandType}hasHighBridgeOnTile(e){return!!__classPrivateFieldGet(this,s,"f").tileOccupation.getBridgeOnTile(e)?.isHighBridge()}isPassableTile(e,t,i){return 0<__classPrivateFieldGet(this,s,"f").terrain.getPassableSpeed(e,t,i)}findPath(e,t,i,s){let n=__classPrivateFieldGet(this,r,"f").map.terrain.computePath(e,t.tile,t.onBridge,i.tile,i.onBridge,{bestEffort:s?.bestEffort,excludeTiles:s?.excludeNodes?e=>s.excludeNodes({tile:e.tile,onBridge:!!e.onBridge}):void 0,maxExpandedNodes:s?.maxExpandedNodes});return n.map((e=>({tile:e.tile,onBridge:!!e.onBridge})))}isVisibleTile(e,t,i=0){var s=__classPrivateFieldGet(this,r,"f").getPlayerByName(t);if(!s)throw new Error(`Player "${t}" doesn't exist`);return!__classPrivateFieldGet(this,r,"f").mapShroudTrait.getPlayerShroud(s)?.isShrouded(e,i)}getTileResourceData(e){var t=__classPrivateFieldGet(this,s,"f").getObjectsOnTile(e).find((e=>e.isOverlay()&&e.isTiberium()||e.isTerrain()&&e.rules.spawnsTiberium));return t?__classPrivateFieldGet(this,i,"m",n).call(this,t):void 0}getAllTilesResourceData(){var e;let t=[];for(e of __classPrivateFieldGet(this,r,"f").getWorld().getAllObjects()){var s=__classPrivateFieldGet(this,i,"m",n).call(this,e);s&&t.push(s)}return t}}),r=new WeakMap,s=new WeakMap,i=new WeakSet,n=function(e){let t;if(e.isOverlay()&&e.isTiberium()){let s=e.traits.get(a.TiberiumTrait);var i=s.getTiberiumType(),r=s.getBailCount();t={tile:e.tile,ore:i===o.TiberiumType.Ore?r:0,gems:i===o.TiberiumType.Gems?r:0,spawnsOre:!1}}else e.isTerrain()&&e.rules.spawnsTiberium&&(t={tile:e.tile,ore:0,gems:0,spawnsOre:!0});return t}}}})),System.register("game/api/interface/BuildingPlacementData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/interface/SuperWeaponData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/api/RulesApi",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("RulesApi",class{constructor(e){i.set(this,void 0),__classPrivateFieldSet(this,i,e,"f")}get allObjectRules(){return __classPrivateFieldGet(this,i,"f").allObjectRules}get buildingRules(){return __classPrivateFieldGet(this,i,"f").buildingRules}get infantryRules(){return __classPrivateFieldGet(this,i,"f").infantryRules}get vehicleRules(){return __classPrivateFieldGet(this,i,"f").vehicleRules}get aircraftRules(){return __classPrivateFieldGet(this,i,"f").aircraftRules}get terrainRules(){return __classPrivateFieldGet(this,i,"f").terrainRules}get overlayRules(){return __classPrivateFieldGet(this,i,"f").overlayRules}get countryRules(){return __classPrivateFieldGet(this,i,"f").countryRules}get general(){return __classPrivateFieldGet(this,i,"f").general}get ai(){return __classPrivateFieldGet(this,i,"f").ai}get crateRules(){return __classPrivateFieldGet(this,i,"f").crateRules}get combatDamage(){return __classPrivateFieldGet(this,i,"f").combatDamage}get radiation(){return __classPrivateFieldGet(this,i,"f").radiation}hasObject(e,t){return __classPrivateFieldGet(this,i,"f").hasObject(e,t)}getObject(e,t){return __classPrivateFieldGet(this,i,"f").getObject(e,t)}getBuilding(e){return __classPrivateFieldGet(this,i,"f").getBuilding(e)}getWeapon(e){return __classPrivateFieldGet(this,i,"f").getWeapon(e)}getWarhead(e){return __classPrivateFieldGet(this,i,"f").getWarhead(e)}getProjectile(e){return __classPrivateFieldGet(this,i,"f").getProjectile(e)}getOverlayName(e){return __classPrivateFieldGet(this,i,"f").getOverlayName(e)}getOverlayId(e){return __classPrivateFieldGet(this,i,"f").getOverlayId(e)}getOverlay(e){return __classPrivateFieldGet(this,i,"f").getOverlay(e)}getCountry(e){return __classPrivateFieldGet(this,i,"f").getCountry(e)}getMultiplayerCountries(){return __classPrivateFieldGet(this,i,"f").getMultiplayerCountries()}getIni(){return __classPrivateFieldGet(this,i,"f").getIni()}}),i=new WeakMap}}})),System.register("game/api/GameApi",["game/player/trait/PowerTrait","game/api/MapApi","engine/type/ObjectType","game/GameSpeed","game/api/RulesApi"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("GameApi",class{constructor(e,t){i.add(this),r.set(this,void 0),s.set(this,void 0),__classPrivateFieldSet(this,r,e,"f"),__classPrivateFieldSet(this,s,t,"f"),this.mapApi=new o.MapApi(e),this.rulesApi=new h.RulesApi(e.rules)}isPlayerDefeated(e){return __classPrivateFieldGet(this,r,"f").getPlayerByName(e).defeated}areAlliedPlayers(e,t){var i=__classPrivateFieldGet(this,r,"f").getPlayerByName(e);if(!i)throw new Error(`Player "${e}" doesn't exist`);var s=__classPrivateFieldGet(this,r,"f").getPlayerByName(t);if(!s)throw new Error(`Player "${t}" doesn't exist`);return __classPrivateFieldGet(this,r,"f").alliances.areAllied(i,s)}canPlaceBuilding(e,t,i){var s=__classPrivateFieldGet(this,r,"f").getPlayerByName(e);if(!s)throw new Error(`Player "${e}" doesn't exist`);return __classPrivateFieldGet(this,r,"f").getConstructionWorker(s).canPlaceAt(t,i,{normalizedTile:!0})}getBuildingPlacementData(e){var t=__classPrivateFieldGet(this,r,"f").art.getObject(e,l.ObjectType.Building);return{foundation:t.foundation,foundationCenter:t.foundationCenter}}getPlayers(){return __classPrivateFieldGet(this,r,"f").getNonNeutralPlayers().map((e=>e.name))}getPlayerData(e){let t=__classPrivateFieldGet(this,r,"f").getPlayerByName(e);if(!t)throw new Error(`Player "${e}" doesn't exist`);return{name:t.name,country:t.country,startLocation:this.mapApi.getStartingLocations()[t.startLocation],isObserver:t.isObserver,isAi:t.isAi,isCombatant:t.isCombatant(),credits:t.credits,power:{total:t.powerTrait?.power??0,drain:t.powerTrait?.drain??0,isLowPower:t.powerTrait?.level===a.PowerLevel.Low},radarDisabled:!!t.radarTrait?.isDisabled()}}getAllTerrainObjects(){return __classPrivateFieldGet(this,r,"f").getWorld().getAllObjects().filter((e=>e.isTerrain())).map((e=>e.id))}getAllUnits(e=(()=>!0)){return __classPrivateFieldGet(this,r,"f").getWorld().getAllObjects().filter((t=>t.isTechno()&&e(t.rules))).map((e=>e.id))}getNeutralUnits(e=(()=>!0)){return __classPrivateFieldGet(this,r,"f").getCivilianPlayer().getOwnedObjects().filter((t=>e(t.rules))).map((e=>e.id))}getUnitsInArea(e){return __classPrivateFieldGet(this,r,"f").map.technosByTile.queryRange(e).map((e=>e.id))}getVisibleUnits(e,t,i=(()=>!0)){const s=__classPrivateFieldGet(this,r,"f").getPlayerByName(e);if(!s)throw new Error(`Player "${e}" doesn't exist`);if("self"===t)return s.getOwnedObjects().filter((e=>i(e.rules))).map((e=>e.id));let n;if("allied"===t)n=e=>e.owner===s||__classPrivateFieldGet(this,r,"f").alliances.areAllied(e.owner,s);else{if("hostile"!==t&&"enemy"!==t)throw new Error("Unexpected type "+t);{let e=__classPrivateFieldGet(this,r,"f").mapShroudTrait.getPlayerShroud(s);n=i=>__classPrivateFieldGet(this,r,"f").map.tileOccupation.calculateTilesForGameObject(i.tile,i).some((t=>!e?.isShrouded(t,i.tileElevation)))&&i.owner!==s&&!__classPrivateFieldGet(this,r,"f").alliances.areAllied(i.owner,s)&&("enemy"!==t||i.owner.isCombatant())}}return __classPrivateFieldGet(this,r,"f").getWorld().getAllObjects().filter((e=>e.isTechno()&&n(e)&&i(e.rules))).map((e=>e.id))}getGameObjectData(e){if(__classPrivateFieldGet(this,r,"f").getWorld().hasObjectId(e)){let t=__classPrivateFieldGet(this,r,"f").getObjectById(e);return{id:t.id,type:t.type,name:t.name,rules:t.rules,tile:t.tile,tileElevation:t.tileElevation,worldPosition:t.position.worldPosition.clone(),foundation:t.getFoundation(),hitPoints:t.healthTrait?.getHitPoints(),maxHitPoints:t.healthTrait?.maxHitPoints}}}getUnitData(e){var t=this.getGameObjectData(e);if(t){let s=__classPrivateFieldGet(this,r,"f").getObjectById(e);if(!s.isTechno())throw new Error(`Game object with id ${e} is not a Techno type`);return{...t,owner:s.owner.name,sight:s.sight,veteranLevel:s.veteranLevel,guardMode:s.guardMode,purchaseValue:s.purchaseValue,primaryWeapon:s.primaryWeapon?__classPrivateFieldGet(this,i,"m",n).call(this,s.primaryWeapon):void 0,secondaryWeapon:s.secondaryWeapon?__classPrivateFieldGet(this,i,"m",n).call(this,s.secondaryWeapon):void 0,deathWeapon:s.armedTrait?.deathWeapon?__classPrivateFieldGet(this,i,"m",n).call(this,s.armedTrait.deathWeapon):void 0,attackState:s.attackTrait?.attackState,direction:s.direction,onBridge:s.isInfantry()||s.isVehicle()?s.onBridge:void 0,zone:s.isUnit()?s.zone:void 0,buildStatus:s.isBuilding()?s.buildStatus:void 0,factory:s.isBuilding()&&s.factoryTrait?{deliveringUnit:s.factoryTrait.deliveringUnit?.id,status:s.factoryTrait.status}:void 0,rallyPoint:s.isBuilding()?s.rallyTrait?.getRallyPoint():void 0,isPoweredOn:s.isBuilding()&&s.poweredTrait?.isPoweredOn(),hasWrenchRepair:s.isBuilding()&&!s.autoRepairTrait.isDisabled(),turretFacing:s.isBuilding()||s.isVehicle()?s.turretTrait?.facing:void 0,turretNo:s.isVehicle()?s.turretNo:void 0,garrisonUnitCount:s.isBuilding()?s.garrisonTrait?.units.length:void 0,garrisonUnitsMax:s.isBuilding()?s.garrisonTrait?.maxOccupants:void 0,isIdle:!s.unitOrderTrait.hasTasks(),canMove:s.isUnit()?!s.moveTrait.isDisabled():void 0,velocity:s.isUnit()?s.moveTrait.velocity.clone():void 0,stance:s.isInfantry()?s.stance:void 0,harvestedOre:s.isVehicle()?s.harvesterTrait?.ore:void 0,harvestedGems:s.isVehicle()?s.harvesterTrait?.gems:void 0,ammo:s.isAircraft()?s.ammo:void 0,isWarpedOut:s.warpedOutTrait.isActive(),mindControlledBy:s.mindControllableTrait?.getController()?.id,tntTimer:s.tntChargeTrait?.getTicksLeft()}}}getAllSuperWeaponData(){return __classPrivateFieldGet(this,r,"f").getCombatants().map((e=>e.superWeaponsTrait.getAll().map((t=>({playerName:e.name,type:t.rules.type,status:t.status,timerSeconds:t.getTimerSeconds()}))))).flat()}getGeneralRules(){return __classPrivateFieldGet(this,r,"f").rules.general}getRulesIni(){return __classPrivateFieldGet(this,r,"f").rules.getIni()}getArtIni(){return __classPrivateFieldGet(this,r,"f").art.getIni()}getAiIni(){return __classPrivateFieldGet(this,r,"f").ai.getIni()}generateRandomInt(e,t){if(__classPrivateFieldGet(this,s,"f"))return __classPrivateFieldGet(this,r,"f").generateRandomInt(e,t);var i=this.generateRandom();return Math.round(i*(t-e))+e}generateRandom(){return __classPrivateFieldGet(this,s,"f")?__classPrivateFieldGet(this,r,"f").generateRandom():Math.random()}getTickRate(){return __classPrivateFieldGet(this,r,"f").speed.value*c.GameSpeed.BASE_TICKS_PER_SECOND}getBaseTickRate(){return c.GameSpeed.BASE_TICKS_PER_SECOND}getCurrentTick(){return __classPrivateFieldGet(this,r,"f").currentTick}getCurrentTime(){return __classPrivateFieldGet(this,r,"f").currentTime/1e3}}),r=new WeakMap,s=new WeakMap,i=new WeakSet,n=function(e){return{type:e.type,rules:e.rules,projectileRules:e.projectileRules,warheadRules:e.warhead.rules,minRange:e.minRange,maxRange:e.range,speed:e.speed,cooldownTicks:e.getCooldownTicks()}}}}})),System.register("util/format",["util/string"],(function(e,t){"use strict";var i;return t&&t.id,e("formatTimeDuration",(function(e,t=!1){var r=Math.floor(e/3600);e-=3600*r;var s=Math.floor(e/60),n=e-=60*s;return[...r||!t?[r]:[],i.pad(s,"00"),i.pad(n,"00")].join(":")})),{setters:[function(e){i=e}],execute:function(){}}})),System.register("game/api/LoggerApi",["util/format","util/Logger"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){a=e},function(e){o=e}],execute:function(){e("LoggerApi",class{constructor(e,t){i.add(this),r.set(this,void 0),s.set(this,void 0),__classPrivateFieldSet(this,r,e,"f"),__classPrivateFieldSet(this,s,t,"f")}setDebugLevel(e){__classPrivateFieldGet(this,r,"f").setLevel(e?o.AppLogger.DEBUG:o.AppLogger.WARN)}debug(...e){__classPrivateFieldGet(this,r,"f").debug(__classPrivateFieldGet(this,i,"m",n).call(this),...e)}info(...e){__classPrivateFieldGet(this,r,"f").info(__classPrivateFieldGet(this,i,"m",n).call(this),...e)}log(...e){__classPrivateFieldGet(this,r,"f").log(__classPrivateFieldGet(this,i,"m",n).call(this),...e)}warn(...e){__classPrivateFieldGet(this,r,"f").warn(__classPrivateFieldGet(this,i,"m",n).call(this),...e)}error(...e){__classPrivateFieldGet(this,r,"f").error(__classPrivateFieldGet(this,i,"m",n).call(this),...e)}time(e){__classPrivateFieldGet(this,r,"f").time(e)}timeEnd(e){__classPrivateFieldGet(this,r,"f").timeEnd(e)}}),r=new WeakMap,s=new WeakMap,i=new WeakSet,n=function(){return"["+a.formatTimeDuration(Math.floor(__classPrivateFieldGet(this,s,"f").getCurrentTime()))+"]"}}}})),System.register("game/api/ProductionApi",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("ProductionApi",class{constructor(e){i.set(this,void 0),__classPrivateFieldSet(this,i,e,"f")}isAvailableForProduction(e){return __classPrivateFieldGet(this,i,"f").isAvailableForProduction(e)}getAvailableObjects(e){let t=__classPrivateFieldGet(this,i,"f").getAvailableObjects();return void 0!==e&&(t=t.filter((t=>this.getQueueTypeForObject(t)===e))),t}getQueueTypeForObject(e){return __classPrivateFieldGet(this,i,"f").getQueueTypeForObject(e)}getQueueData(e){let t=__classPrivateFieldGet(this,i,"f").getQueue(e);return{size:t.currentSize,maxSize:t.maxSize,status:t.status,type:t.type,items:t.getAll().map((e=>({rules:e.rules,quantity:e.quantity})))}}}),i=new WeakMap}}})),System.register("game/bot/Bot",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("Bot",class{constructor(e,t){this.name=e,this.country=t,i.set(this,!1)}setGameApi(e){this.gameApi=e}setActionsApi(e){this.actionsApi=e}setProductionApi(e){this.productionApi=e}setLogger(e){this.logger=e,this.logger.setDebugLevel(__classPrivateFieldGet(this,i,"f"))}setDebugMode(e){return __classPrivateFieldSet(this,i,e,"f"),this.logger?.setDebugLevel(e),this}getDebugMode(){return __classPrivateFieldGet(this,i,"f")}onGameStart(e){}onGameTick(e){}onGameEvent(e,t){}}),i=new WeakMap}}})),System.register("game/api/ActionsApi",["game/action/ActionType","game/action/UpdateQueueAction","game/action/DebugAction"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("ActionsApi",class{constructor(e,t,l,c,h){i.add(this),r.set(this,void 0),s.set(this,void 0),n.set(this,void 0),a.set(this,void 0),o.set(this,void 0),__classPrivateFieldSet(this,r,t,"f"),__classPrivateFieldSet(this,s,l,"f"),__classPrivateFieldSet(this,n,e,"f"),__classPrivateFieldSet(this,a,c,"f"),__classPrivateFieldSet(this,o,h,"f")}placeBuilding(e,t,r){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.PlaceBuilding,(i=>{i.buildingRules=__classPrivateFieldGet(this,n,"f").rules.getBuilding(e),i.tile={x:t,y:r}}))}sellBuilding(e){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.SellBuilding,(t=>{t.buildingId=e}))}toggleRepairWrench(e){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.ToggleRepair,(t=>{t.buildingId=e}))}toggleAlliance(e,t){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.ToggleAlliance,(i=>{i.toPlayer=__classPrivateFieldGet(this,n,"f").getPlayerByName(e),i.toggle=t}))}pauseProduction(e){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.UpdateQueue,(t=>{t.queueType=e,t.updateType=h.UpdateType.Pause}))}resumeProduction(e){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.UpdateQueue,(t=>{t.queueType=e,t.updateType=h.UpdateType.Resume}))}queueForProduction(e,t,r,s){let a=__classPrivateFieldGet(this,n,"f").rules.getObject(t,r);__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.UpdateQueue,(t=>{t.queueType=e,t.updateType=h.UpdateType.Add,t.item=a,t.quantity=s}))}unqueueFromProduction(e,t,r,s){let a=__classPrivateFieldGet(this,n,"f").rules.getObject(t,r);__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.UpdateQueue,(t=>{t.queueType=e,t.updateType=h.UpdateType.Cancel,t.item=a,t.quantity=s}))}activateSuperWeapon(e,t,r){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.ActivateSuperWeapon,(i=>{i.superWeaponType=e,i.tile={x:t.rx,y:t.ry},i.tile2=r?{x:r.rx,y:r.ry}:void 0}))}orderUnits(e,t,r,s,a){let o;if(__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.SelectUnits,(t=>{t.unitIds=e})),r){let e,t;if(s){e=void 0;var h=__classPrivateFieldGet(this,n,"f").map.tiles.getByMapCoords(r,s);if(!h)throw new Error(`No tile found at rx,ry=${r},`+s);t=h,a&&(e=__classPrivateFieldGet(this,n,"f").map.tileOccupation.getBridgeOnTile(h))}else{if(!__classPrivateFieldGet(this,n,"f").getWorld().hasObjectId(r))return;e=__classPrivateFieldGet(this,n,"f").getObjectById(r),t=e.tile}o=__classPrivateFieldGet(this,n,"f").createTarget(e,t)}__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.OrderUnits,(e=>{e.orderType=t,e.target=o}))}sayAll(e){__classPrivateFieldGet(this,o,"f")?.sayAll(__classPrivateFieldGet(this,a,"f").name,e)}setGlobalDebugText(e){__classPrivateFieldGet(this,a,"f").getDebugMode()&&__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.DebugCommand,(t=>{t.command=new u.DebugCommand(u.DebugCommandType.SetGlobalDebugText,{text:e||""})}))}setUnitDebugText(e,t){__classPrivateFieldGet(this,a,"f").getDebugMode()&&__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.DebugCommand,(i=>{i.command=new u.DebugCommand(u.DebugCommandType.SetUnitDebugText,{unitId:e,label:t})}))}quitGame(){__classPrivateFieldGet(this,i,"m",l).call(this,c.ActionType.ResignGame)}}),r=new WeakMap,s=new WeakMap,n=new WeakMap,a=new WeakMap,o=new WeakMap,i=new WeakSet,l=function(e,t){let i=__classPrivateFieldGet(this,r,"f").create(e);i.player=__classPrivateFieldGet(this,n,"f").getPlayerByName(__classPrivateFieldGet(this,a,"f").name),t?.(i),__classPrivateFieldGet(this,s,"f").push(i)}}}})),System.register("game/api/interface/PlayerStats",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/type/PipColor",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Green=0]="Green",t[t.Yellow=1]="Yellow",t[t.White=2]="White",t[t.Red=3]="Red",t[t.Blue=4]="Blue",e("PipColor",i)}}})),System.register("game/api/index",["game/bot/Bot","game/api/EventsApi","game/math/GameMath","game/math/Box2","game/math/Vector2","game/math/Vector3","game/math/Euler","game/math/Quaternion","game/math/Matrix4","game/math/Spherical","game/math/Cylindrical","engine/TheaterType","engine/type/ObjectType","game/gameobject/Building","game/gameobject/infantry/StanceType","game/gameobject/unit/ZoneType","game/gameobject/trait/AttackTrait","game/gameobject/trait/FactoryTrait","game/gameobject/unit/VeteranLevel","game/order/OrderType","game/player/production/ProductionQueue","game/rules/GeneralRules","game/rules/general/RadarRules","game/type/SpeedType","game/WeaponType","game/rules/TechnoRules","data/map/tag/TagRepeatType","engine/type/TerrainType","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranAbility","game/SideType","game/type/ArmorType","game/type/LandTargeting","game/type/LandType","game/type/LocomotorType","game/type/MovementZone","game/type/NavalTargeting","game/type/PipColor","game/type/SuperWeaponType","game/SuperWeapon","game/type/VhpScan"],(function(e,t){"use strict";return t&&t.id,{setters:[function(t){e({Bot:t.Bot})},function(t){e({ApiEventType:t.ApiEventType})},function(t){e({GameMath:t.GameMath})},function(t){e({Box2:t.Box2})},function(t){e({Vector2:t.Vector2})},function(t){e({Vector3:t.Vector3})},function(t){e({Euler:t.Euler})},function(t){e({Quaternion:t.Quaternion})},function(t){e({Matrix4:t.Matrix4})},function(t){e({Spherical:t.Spherical})},function(t){e({Cylindrical:t.Cylindrical})},function(t){e({TheaterType:t.TheaterType})},function(t){e({ObjectType:t.ObjectType})},function(t){e({BuildStatus:t.BuildStatus})},function(t){e({StanceType:t.StanceType})},function(t){e({ZoneType:t.ZoneType})},function(t){e({AttackState:t.AttackState})},function(t){e({FactoryStatus:t.FactoryStatus})},function(t){e({VeteranLevel:t.VeteranLevel})},function(t){e({OrderType:t.OrderType})},function(t){e({QueueType:t.QueueType}),e({QueueStatus:t.QueueStatus})},function(t){e({PrereqCategory:t.PrereqCategory})},function(t){e({RadarEventType:t.RadarEventType})},function(t){e({SpeedType:t.SpeedType})},function(t){e({WeaponType:t.WeaponType})},function(t){e({FactoryType:t.FactoryType}),e({BuildCat:t.BuildCat})},function(t){e({TagRepeatType:t.TagRepeatType})},function(t){e({TerrainType:t.TerrainType})},function(t){e({InfDeathType:t.InfDeathType})},function(t){e({VeteranAbility:t.VeteranAbility})},function(t){e({SideType:t.SideType})},function(t){e({ArmorType:t.ArmorType})},function(t){e({LandTargeting:t.LandTargeting})},function(t){e({LandType:t.LandType})},function(t){e({LocomotorType:t.LocomotorType})},function(t){e({MovementZone:t.MovementZone})},function(t){e({NavalTargeting:t.NavalTargeting})},function(t){e({PipColor:t.PipColor})},function(t){e({SuperWeaponType:t.SuperWeaponType})},function(t){e({SuperWeaponStatus:t.SuperWeaponStatus})},function(t){e({VhpScan:t.VhpScan})}],execute:function(){}}})),System.register("game/bot/BotsLib",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/bot/DummyBot",["game/bot/Bot","game/order/OrderType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.Initial=0]="Initial",t[t.Deployed=1]="Deployed",t[t.Attacking=2]="Attacking",t[t.Defeated=3]="Defeated",n=class extends i.Bot{constructor(){super(...arguments),this.botState=s.Initial}onGameStart(e){var t=e.getTickRate();this.tickRatio=Math.ceil(t/5),this.enemyPlayers=e.getPlayers().filter((t=>t!==this.name&&!e.areAlliedPlayers(this.name,t)))}onGameTick(e){if(e.getCurrentTick()%this.tickRatio==0)switch(this.botState){case s.Initial:{const i=e.getGeneralRules().baseUnit;if(e.getVisibleUnits(this.name,"self",(e=>e.constructionYard)).length){this.botState=s.Deployed;break}var t=e.getVisibleUnits(this.name,"self",(e=>i.includes(e.name)));t.length&&this.actionsApi.orderUnits([t[0]],r.OrderType.DeploySelected);break}case s.Deployed:break;case s.Attacking:e.getVisibleUnits(this.name,"self",(e=>e.isSelectableCombatant)).length||(this.botState=s.Defeated,this.actionsApi.quitGame())}}},e("DummyBot",n)}}})),System.register("game/bot/BotFactory",["game/gameopts/GameOpts","game/bot/DummyBot"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("BotFactory",class{constructor(e){this.botsLib=e}create(e){if(!e.isAi)throw new Error(`Player "${e.name}" is not an AI`);switch(e.aiDifficulty){case i.AiDifficulty.Easy:return new r.DummyBot(e.name,e.country.name);case i.AiDifficulty.Medium:if(this.botsLib.SupalosaBot)return new this.botsLib.SupalosaBot(e.name,e.country.name);default:throw new Error(`Unsupported AI difficulty "${e.aiDifficulty}"`)}}})}}})),System.register("game/BotManager",["util/disposable/CompositeDisposable","util/Logger","game/action/ActionQueue","game/api/ActionsApi","game/api/EventsApi","game/api/GameApi","game/api/LoggerApi","game/api/ProductionApi"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("BotManager",class{constructor(e,t,r,s,n){this.actionFactory=e,this.actionQueue=t,this.botFactory=r,this.botDebugIndex=s,this.actionLogger=n,this.bots=new Map,this.disposables=new i.CompositeDisposable}static factory(e,t,i,r){return new this(e,new s.ActionQueue,t,i,r)}init(e){this.gameApi=new o.GameApi(e,!0);let t=new a.EventsApi(e.events);var i,s;for(i of e.getCombatants().filter((e=>e.isAi)))this.bots.set(i,this.botFactory.create(i));this.updateDebugBotIndex(this.botDebugIndex.value,e);let h=t=>this.updateDebugBotIndex(t,e);for(s of(this.botDebugIndex.onChange.subscribe(h),this.disposables.add((()=>this.botDebugIndex.onChange.unsubscribe(h))),t.subscribe((e=>this.bots.forEach((t=>t.onGameEvent(e,this.gameApi))))),this.disposables.add(t),this.bots.values()))s.setGameApi(this.gameApi),s.setActionsApi(new n.ActionsApi(e,this.actionFactory,this.actionQueue,s)),s.setProductionApi(new c.ProductionApi(e.getPlayerByName(s.name).production)),s.setLogger(new l.LoggerApi(r.AppLogger.get(s.name),this.gameApi)),s.onGameStart(this.gameApi)}update(e){var t,i;for(t of this.actionQueue.dequeueAll()){t.process();var r=t.print();r&&this.actionLogger.debug(`(${t.player.name})@${e.currentTick}: `+r)}for(i of e.getCombatants().filter((e=>e.isAi)))this.bots.get(i).onGameTick(this.gameApi)}updateDebugBotIndex(e,t){var i,r=0<e?t.getAiPlayerName(e):void 0;for(i of this.bots.values())i.setDebugMode(i.name===r)}dispose(){this.gameApi=void 0,this.bots.clear(),this.disposables.dispose()}})}}})),System.register("game/gameopts/constants",["game/gameopts/GameOpts"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("RANDOM_COUNTRY_ID",-2),e("RANDOM_COLOR_ID",-2),e("RANDOM_START_POS",-2),e("NO_TEAM_ID",-2),e("OBS_COUNTRY_ID",-3),e("OBS_COLOR_ID",-2),e("RANDOM_COUNTRY_NAME","Random"),e("OBS_COUNTRY_NAME","Observer"),e("aiUiNames",(new Map).set(i.AiDifficulty.Easy,"GUI:AIDummy").set(i.AiDifficulty.Medium,"GUI:AIEasyBeta")),e("aiUiTooltips",new Map),e("RANDOM_COUNTRY_UI_NAME","GUI:RandomEx"),e("RANDOM_COUNTRY_UI_TOOLTIP","STT:PlayerSideRandom"),e("OBS_COUNTRY_UI_NAME","GUI:Observer"),e("OBS_COUNTRY_UI_TOOLTIP","STT:PlayerSideObserver"),e("RANDOM_COLOR_NAME","")}}})),System.register("game/event/StalemateDetectEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("StalemateDetectEvent",class{constructor(){this.type=i.EventType.StalemateDetect}})}}})),System.register("game/trait/StalemateDetectTrait",["game/event/StalemateDetectEvent","game/GameSpeed","game/trait/interface/NotifyDestroy","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyPlaceBuilding","game/trait/interface/NotifyProduceUnit","game/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class e{constructor(){this.stale=!1,this.allPlayersCredits=new Map,this.resetCountdown()}isStale(){return this.stale}getCountdownTicks(){return this.countdownTicks}resetCountdown(){this.countdownTicks=Math.floor(60*e.graceMinutes*r.GameSpeed.BASE_TICKS_PER_SECOND)}clearStale(){this.stale=!1,this.resetCountdown()}[l.NotifyTick.onTick](e){for(var t of(0<this.countdownTicks?this.countdownTicks--:this.stale||(this.stale=!0,this.resetCountdown(),e.events.dispatch(new i.StalemateDetectEvent)),e.getCombatants())){var r=this.allPlayersCredits.get(t);r!==t.credits&&(this.allPlayersCredits.set(t,t.credits),t.credits>(r??0)&&t.production.hasAnyFactory()&&this.clearStale())}}[o.NotifyProduceUnit.onProduce](){this.clearStale()}[a.NotifyPlaceBuilding.onPlace](e){e.wallTrait||this.clearStale()}[s.NotifyDestroy.onDestroy](e,t,i){!e.isBuilding()||e.owner.isNeutral||e.wallTrait||e.rules.insignificant||i?.obj&&t.areFriendly(e,i.obj)||this.clearStale()}[n.NotifyOwnerChange.onChange](e,t,i){e.isBuilding()&&!t.isNeutral&&(i.alliances.areAllied(e.owner,t)||this.clearStale())}},e("StalemateDetectTrait",c),c.graceMinutes=5}}})),System.register("game/Prng",["mersenne-twister"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Prng",class{constructor(e){this.prng=new i.default(e)}generateRandomInt(e,t){var i=this.prng.random();return this.lastRandom=i,Math.round(i*(t-e))+e}generateRandom(){var e=this.prng.random();return this.lastRandom=e}getLastRandom(){return this.lastRandom}})}}})),System.register("game/trigger/TriggerTarget",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/trigger/TriggerCondition",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("TriggerCondition",class{constructor(e,t){this.event=e,this.trigger=t,this.blocking=!1,this.targets=[]}init(e){var t=e.getAllPlayers().find((e=>e.country?.name===this.trigger.houseName));t&&(this.player=t)}setTargets(e){this.targets=e}reset(){}getDebugName(){return`${this.event.triggerId}[${this.event.eventIndex}] (${this.trigger.name}).`}})}}})),System.register("game/trigger/TriggerInstance",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/trigger/TriggerExecutor",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("TriggerExecutor",class{constructor(e,t){this.action=e,this.trigger=t}getDebugName(){return`${this.action.triggerId}[${this.action.index}] (${this.trigger.name}).`}})}}})),System.register("game/trigger/executor/AddSuperWeaponExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.oneTimeOnly=i,this.superWeaponIdx=Number(e.params[1])}execute(e){var t=[...e.rules.superWeaponRules.values()].find((e=>e.index===this.superWeaponIdx));if(t){let i=e.getAllPlayers().find((e=>e.country?.name===this.trigger.houseName));if(i&&i.superWeaponsTrait&&!i.superWeaponsTrait.has(t.name)){let r=e.createSuperWeapon(t.name,i,this.oneTimeOnly);r.isGift=!0,i.superWeaponsTrait.add(r)}}else console.warn(`No superweapon found with index "${this.superWeaponIdx}". Skipping action ${this.getDebugName()}.`)}},e("AddSuperWeaponExecutor",r)}}})),System.register("game/trigger/executor/ApplyDamageExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends n.TriggerExecutor{constructor(e,t,i){super(e,t),this.damage=i}execute(e){var t=Number(this.action.params[1]),n=e.map.getTileAtWaypoint(t);if(n){var a=e.rules.getWarhead(s.Warhead.HE_WARHEAD_NAME);let t=new s.Warhead(a);var o=e.map.tileOccupation.getBridgeOnTile(n),l=o?.tileElevation??0;a=e.map.getTileZone(n);t.detonate(e,this.damage,n,l,i.Coords.tile3dToWorld(n.rx+.5,n.ry+.5,n.z+l),a,o?r.CollisionType.OnBridge:r.CollisionType.None,e.createTarget(o,n),void 0,!1,!1,void 0)}else console.warn(`No valid location found for waypoint ${t}. Skipping action ${this.getDebugName()}.`)}},e("ApplyDamageExecutor",a)}}})),System.register("game/trigger/executor/ChangeHouseAllExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){let t=e.getAllPlayers().find((e=>e.country?.name===this.trigger.houseName));if(t){let s=Number(this.action.params[1]);var i=e.getAllPlayers().find((e=>e.country?.id===s));if(i)for(var r of t.getOwnedObjects(!0))e.changeObjectOwner(r,i)}}},e("ChangeHouseAllExecutor",r)}}})),System.register("game/trigger/executor/ChangeHouseExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}execute(e,t){var r=e.getAllPlayers().find((e=>e.country?.id===this.houseId));if(r)for(var s of t)s instanceof i.GameObject&&s.isSpawned&&e.changeObjectOwner(s,r)}},e("ChangeHouseExecutor",s)}}})),System.register("game/trigger/executor/CheerExecutor",["engine/type/ObjectType","game/gameobject/task/CheerTask","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerExecutor{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}execute(e){let t=e.getAllPlayers().filter((e=>e.country&&!e.defeated));if(-1!==this.houseId&&(t=t.filter((e=>e.country?.id===this.houseId))),t.length)for(var s of t[0].getOwnedObjectsByType(i.ObjectType.Infantry))s.unitOrderTrait.isIdle()&&s.unitOrderTrait.addTask(new r.CheerTask)}},e("CheerExecutor",n)}}})),System.register("game/trigger/executor/CreateCrateExecutor",["game/type/PowerupType","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=new Map([[0,e=>{var t=e.rules.powerups.powerups.find((e=>e.type===i.PowerupType.Money));return t?{...t,data:"5000"}:void 0}],[1,i.PowerupType.Unit],[2,i.PowerupType.HealBase],[3,i.PowerupType.Cloak],[4,i.PowerupType.Explosion],[5,i.PowerupType.Napalm],[6,i.PowerupType.Money],[7,i.PowerupType.Darkness],[8,i.PowerupType.Reveal],[9,i.PowerupType.Armor],[10,i.PowerupType.Speed],[11,i.PowerupType.Firepower],[12,i.PowerupType.ICBM],[13,void 0],[14,i.PowerupType.Veteran],[15,void 0],[16,i.PowerupType.Gas],[17,i.PowerupType.Tiberium],[18,void 0]]),n=class extends r.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),i=this.action.params[6],r=e.map.getTileAtWaypoint(i);if(r)if(s.has(t)){const i=s.get(t);(t="function"==typeof i?i(e):e.rules.powerups.powerups.find((e=>e.type===i)))&&e.crateGeneratorTrait.spawnCrateAt(r,t,e)}else e.crateGeneratorTrait.spawnRandomCrateAt(r,e);else console.warn(`No valid location found for waypoint ${i}. Skipping action ${this.getDebugName()}.`)}},e("CreateCrateExecutor",n)}}})),System.register("game/trigger/executor/CreateRadarEventExecutor",["game/rules/general/RadarRules","game/trait/RadarTrait","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerExecutor{execute(e){var t=Number(this.action.params[1])-1;if(Object.values(i.RadarEventType).includes(t)){var s=this.action.params[6],n=e.map.getTileAtWaypoint(s);if(n)for(var a of e.getCombatants())e.traits.get(r.RadarTrait).addEventForPlayer(t,a,n,e);else console.warn(`No valid location found for waypoint ${s}. Skipping action ${this.getDebugName()}.`)}else console.warn(`Unknown radar event type "${1+t}". Skipping action ${this.getDebugName()}.`)}},e("CreateRadarEventExecutor",n)}}})),System.register("game/trigger/executor/DestroyObjectExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e,t){for(var r of t)r instanceof i.GameObject&&r.isSpawned&&e.destroyObject(r)}},e("DestroyObjectExecutor",s)}}})),System.register("game/trigger/executor/DestroyTagExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action.params[1];e.triggers.destroyTag(t)}},e("DestroyTagExecutor",r)}}})),System.register("game/trigger/executor/DestroyTriggerExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action.params[1];e.triggers.destroyTrigger(t)}},e("DestroyTriggerExecutor",r)}}})),System.register("game/trigger/executor/DetonateWarheadExecutor",["game/Coords","game/gameobject/unit/CollisionType","game/Warhead","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends n.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),n=this.action.params[6],a=e.map.getTileAtWaypoint(n);if(a){let c,h;try{c=e.rules.getWeaponByInternalId(t)}catch(n){if(n instanceof RangeError)return void console.warn(`Weapon with internal ID "${t}" not found. Skipping action ${this.getDebugName()}.`);throw n}try{h=e.rules.getWarhead(c.warhead)}catch(n){return void console.warn(`Warhead "${c.warhead}" not found. Skipping action ${this.getDebugName()}.`)}let u=new s.Warhead(h);var o=e.map.tileOccupation.getBridgeOnTile(a),l=o?.tileElevation??0;t=e.map.getTileZone(a);u.detonate(e,c.damage,a,l,i.Coords.tile3dToWorld(a.rx+.5,a.ry+.5,a.z+l),t,o?r.CollisionType.OnBridge:r.CollisionType.None,e.createTarget(o,a),void 0,!1,!1,void 0)}else console.warn(`No valid location found for waypoint ${n}. Skipping action ${this.getDebugName()}.`)}},e("DetonateWarheadExecutor",a)}}})),System.register("game/trigger/executor/EvictOccupiersExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e,t){for(var r of t)r instanceof i.GameObject&&r.isBuilding()&&r.garrisonTrait&&!r.isDestroyed&&r.garrisonTrait.evacuate(e)}},e("EvictOccupiersExecutor",s)}}})),System.register("game/trigger/executor/FireSaleExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}execute(e){var t=e.getAllPlayers().find((e=>e.country?.id===this.houseId));if(t)for(var i of t.buildings)e.sellTrait.sell(i)}},e("FireSaleExecutor",r)}}})),System.register("game/trigger/executor/ForceEndExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.end()}},e("ForceEndExecutor",r)}}})),System.register("game/trigger/executor/ForceTriggerExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=this.action.params[1];e.triggers.forceTrigger(t,e)}},e("ForceTriggerExecutor",r)}}})),System.register("game/trigger/executor/GlobalVariableExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.value=i,this.variableIdx=Number(e.params[1])}execute(e){e.triggers.toggleGlobalVariable(this.variableIdx,this.value)}},e("GlobalVariableExecutor",r)}}})),System.register("game/trigger/executor/IronCurtainExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerExecutor{execute(e){var t,s,n=this.action.params[6],a=e.map.getTileAtWaypoint(n);a?!(t=e.getAllPlayers().find((e=>!e.defeated&&e.country?.name===this.trigger.houseName)))||(s=[...e.rules.superWeaponRules.values()].find((e=>e.type===r.SuperWeaponType.IronCurtain)))&&e.traits.get(i.SuperWeaponsTrait).activateEffect(s,t,e,a,void 0,!0):console.warn(`No valid location found for waypoint ${n}. Skipping action ${this.getDebugName()}.`)}},e("IronCurtainExecutor",n)}}})),System.register("game/trigger/executor/LightningStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerExecutor{execute(e){var t,s,n=this.action.params[6],a=e.map.getTileAtWaypoint(n);a?!(t=e.getAllPlayers().find((e=>!e.defeated&&e.country?.name===this.trigger.houseName)))||(s=[...e.rules.superWeaponRules.values()].find((e=>e.type===r.SuperWeaponType.LightningStorm)))&&e.traits.get(i.SuperWeaponsTrait).activateEffect(s,t,e,a,void 0,!0):console.warn(`No valid location found for waypoint ${n}. Skipping action ${this.getDebugName()}.`)}},e("LightningStrikeExecutor",n)}}})),System.register("game/trigger/executor/LocalVariableExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.value=i,this.variableIdx=Number(e.params[1])}execute(e){e.triggers.toggleLocalVariable(this.variableIdx,this.value)}},e("LocalVariableExecutor",r)}}})),System.register("game/trigger/executor/NoActionExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(){}},e("NoActionExecutor",r)}}})),System.register("game/trigger/executor/NukeStrikeExecutor",["game/trait/SuperWeaponsTrait","game/type/SuperWeaponType","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerExecutor{execute(e){var t,s,n=this.action.params[6],a=e.map.getTileAtWaypoint(n);a?!(t=e.getAllPlayers().find((e=>!e.defeated&&e.country?.name===this.trigger.houseName)))||(s=[...e.rules.superWeaponRules.values()].find((e=>e.type===r.SuperWeaponType.MultiMissile)))&&e.traits.get(i.SuperWeaponsTrait).activateEffect(s,t,e,a,void 0,!0):console.warn(`No valid location found for waypoint ${n}. Skipping action ${this.getDebugName()}.`)}},e("NukeStrikeExecutor",n)}}})),System.register("game/event/TriggerAnimEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TriggerAnimEvent",class{constructor(e,t){this.name=e,this.tile=t,this.type=i.EventType.TriggerAnim}})}}})),System.register("game/trigger/executor/PlayAnimAtExecutor",["game/event/TriggerAnimEvent","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t,r=this.action,s=Number(r.params[1]),n=e.rules.getAnimationName(s);void 0!==n?(t=r.params[6],(r=e.map.getTileAtWaypoint(t))?e.events.dispatch(new i.TriggerAnimEvent(n,r)):console.warn(`No valid location found for waypoint ${t}. Skipping action ${this.getDebugName()}.`)):console.warn(`No animation found for index "${s}". Skipping action `+this.getDebugName())}},e("PlayAnimAtExecutor",s)}}})),System.register("game/event/TriggerSoundFxEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TriggerSoundFxEvent",class{constructor(e,t){this.soundId=e,this.tile=t,this.type=i.EventType.TriggerSoundFx}})}}})),System.register("game/trigger/executor/PlaySoundFxAtExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t,r=(t=this.action).params[1],s=t.params[6];(t=e.map.getTileAtWaypoint(s))?e.events.dispatch(new i.TriggerSoundFxEvent(r,t)):console.warn(`No valid location found for waypoint ${s}. Skipping action ${this.getDebugName()}.`)}},e("PlaySoundFxAtExecutor",s)}}})),System.register("game/trigger/executor/PlaySoundFxExecutor",["game/event/TriggerSoundFxEvent","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){e.events.dispatch(new i.TriggerSoundFxEvent(this.action.params[1]))}},e("PlaySoundFxExecutor",s)}}})),System.register("game/event/TriggerEvaEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TriggerEvaEvent",class{constructor(e){this.soundId=e,this.type=i.EventType.TriggerEva}})}}})),System.register("game/trigger/executor/PlaySpeechExecutor",["game/event/TriggerEvaEvent","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){e.events.dispatch(new i.TriggerEvaEvent(this.action.params[1]))}},e("PlaySpeechExecutor",s)}}})),System.register("game/trigger/executor/ReshroudMapExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){for(var t of e.getCombatants())e.mapShroudTrait.resetShroud(t,e)}},e("ReshroudMapExecutor",r)}}})),System.register("game/trigger/executor/ResizePlayerViewExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var[t,i,r,s]=this.action.params.slice(2,6).map(Number);e.map.mapBounds.updateRawLocalSize({x:t,y:i,width:r,height:s})}},e("ResizePlayerViewExecutor",r)}}})),System.register("game/trigger/executor/RevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),i=e.map.getTileAtWaypoint(t);if(i)for(var r of e.getCombatants())e.mapShroudTrait.getPlayerShroud(r)?.revealAround(i,e.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${t}. Skipping action ${this.getDebugName()}.`)}},e("RevealAroundWaypointExecutor",r)}}})),System.register("game/trigger/executor/RevealMapExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){for(var t of e.getCombatants())e.mapShroudTrait.revealMap(t,e)}},e("RevealMapExecutor",r)}}})),System.register("game/trigger/executor/SellBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e,t){for(var r of t)r instanceof i.GameObject&&r.isBuilding()&&!r.isDestroyed&&e.sellTrait.sell(r)}},e("SellBuildingExecutor",s)}}})),System.register("game/trigger/executor/SetAmbientLightExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1])/100;e.mapLightingTrait.setTargetAmbientIntensity(t)}},e("SetAmbientLightExecutor",r)}}})),System.register("util/number",[],(function(e,t){"use strict";return t&&t.id,e("int32ToFloat32",(function(e){let t=new DataView(new ArrayBuffer(4));return t.setInt32(0,e),t.getFloat32(0)})),{setters:[],execute:function(){}}})),System.register("game/trigger/executor/SetAmbientRateExecutor",["util/number","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t=i.int32ToFloat32(Number(this.action.params[1]));e.mapLightingTrait.setAmbientChangeRate(t)}},e("SetAmbientRateExecutor",s)}}})),System.register("game/trigger/executor/SetAmbientStepExecutor",["util/number","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t=i.int32ToFloat32(Number(this.action.params[1]));e.mapLightingTrait.setAmbientChangeStep(t)}},e("SetAmbientStepExecutor",s)}}})),System.register("game/event/TriggerStopSoundFxEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TriggerStopSoundFxEvent",class{constructor(e){this.tile=e,this.type=i.EventType.TriggerStopSoundFx}})}}})),System.register("game/trigger/executor/StopSoundFxAtExecutor",["game/event/TriggerStopSoundFxEvent","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){var t=this.action.params[6],r=e.map.getTileAtWaypoint(t);r?e.events.dispatch(new i.TriggerStopSoundFxEvent(r)):console.warn(`No valid location found for waypoint ${t}. Skipping action ${this.getDebugName()}.`)}},e("StopSoundFxAtExecutor",s)}}})),System.register("game/event/TriggerTextEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TriggerTextEvent",class{constructor(e){this.label=e,this.type=i.EventType.TriggerText}})}}})),System.register("game/trigger/executor/TextTriggerExecutor",["game/event/TriggerTextEvent","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{execute(e){e.events.dispatch(new i.TriggerTextEvent(this.action.params[1]))}},e("TextTriggerExecutor",s)}}})),System.register("game/trigger/executor/TimerExtendExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.addSeconds(Number(this.action.params[1]))}},e("TimerExtendExecutor",r)}}})),System.register("game/trigger/executor/TimerSetExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.setSeconds(Number(this.action.params[1]))}},e("TimerSetExecutor",r)}}})),System.register("game/trigger/executor/TimerShortenExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.addSeconds(-Number(this.action.params[1]))}},e("TimerShortenExecutor",r)}}})),System.register("game/trigger/executor/TimerStartExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.start()}},e("TimerStartExecutor",r)}}})),System.register("game/trigger/executor/TimerStopExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.stop()}},e("TimerStopExecutor",r)}}})),System.register("game/trigger/executor/TimerTextExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){e.countdownTimer.text=this.action.params[1]}},e("TimerTextExecutor",r)}}})),System.register("game/trigger/executor/ToggleTriggerExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{constructor(e,t,i){super(e,t),this.triggerEnable=i}execute(e){var t=this.action.params[1];e.triggers.setTriggerEnabled(t,this.triggerEnable)}},e("ToggleTriggerExecutor",r)}}})),System.register("game/trigger/executor/TurnOnOffBuildingExecutor",["game/gameobject/GameObject","game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerExecutor{constructor(e,t,i){super(e,t),this.turnOn=i}execute(e,t){for(var r of t)r instanceof i.GameObject&&r.isBuilding()&&r.poweredTrait?.setTurnedOn(this.turnOn)}},e("TurnOnOffBuildingExecutor",s)}}})),System.register("game/trigger/executor/UnrevealAroundWaypointExecutor",["game/trigger/TriggerExecutor"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerExecutor{execute(e){var t=Number(this.action.params[1]),i=e.map.getTileAtWaypoint(t);if(i)for(var r of e.getCombatants())e.mapShroudTrait.getPlayerShroud(r)?.unrevealAround(i,e.rules.general.revealTriggerRadius);else console.warn(`No valid location found for waypoint ${t}. Skipping action ${this.getDebugName()}.`)}},e("UnrevealAroundWaypointExecutor",r)}}})),System.register("game/trigger/TriggerExecutorFactory",["data/map/trigger/TriggerActionType","game/trigger/executor/AddSuperWeaponExecutor","game/trigger/executor/ApplyDamageExecutor","game/trigger/executor/ChangeHouseAllExecutor","game/trigger/executor/ChangeHouseExecutor","game/trigger/executor/CheerExecutor","game/trigger/executor/CreateCrateExecutor","game/trigger/executor/CreateRadarEventExecutor","game/trigger/executor/DestroyObjectExecutor","game/trigger/executor/DestroyTagExecutor","game/trigger/executor/DestroyTriggerExecutor","game/trigger/executor/DetonateWarheadExecutor","game/trigger/executor/EvictOccupiersExecutor","game/trigger/executor/FireSaleExecutor","game/trigger/executor/ForceEndExecutor","game/trigger/executor/ForceTriggerExecutor","game/trigger/executor/GlobalVariableExecutor","game/trigger/executor/IronCurtainExecutor","game/trigger/executor/LightningStrikeExecutor","game/trigger/executor/LocalVariableExecutor","game/trigger/executor/NoActionExecutor","game/trigger/executor/NukeStrikeExecutor","game/trigger/executor/PlayAnimAtExecutor","game/trigger/executor/PlaySoundFxAtExecutor","game/trigger/executor/PlaySoundFxExecutor","game/trigger/executor/PlaySpeechExecutor","game/trigger/executor/ReshroudMapExecutor","game/trigger/executor/ResizePlayerViewExecutor","game/trigger/executor/RevealAroundWaypointExecutor","game/trigger/executor/RevealMapExecutor","game/trigger/executor/SellBuildingExecutor","game/trigger/executor/SetAmbientLightExecutor","game/trigger/executor/SetAmbientRateExecutor","game/trigger/executor/SetAmbientStepExecutor","game/trigger/executor/StopSoundFxAtExecutor","game/trigger/executor/TextTriggerExecutor","game/trigger/executor/TimerExtendExecutor","game/trigger/executor/TimerSetExecutor","game/trigger/executor/TimerShortenExecutor","game/trigger/executor/TimerStartExecutor","game/trigger/executor/TimerStopExecutor","game/trigger/executor/TimerTextExecutor","game/trigger/executor/ToggleTriggerExecutor","game/trigger/executor/TurnOnOffBuildingExecutor","game/trigger/executor/UnrevealAroundWaypointExecutor"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e}],execute:function(){e("TriggerExecutorFactory",class{create(e,t){switch(e.type){case i.TriggerActionType.NoAction:return new w.NoActionExecutor(e,t);case i.TriggerActionType.FireSale:return new m.FireSaleExecutor(e,t);case i.TriggerActionType.TextTrigger:return new D.TextTriggerExecutor(e,t);case i.TriggerActionType.DestroyTrigger:return new d.DestroyTriggerExecutor(e,t);case i.TriggerActionType.ChangeHouse:return new a.ChangeHouseExecutor(e,t);case i.TriggerActionType.RevealMap:return new I.RevealMapExecutor(e,t);case i.TriggerActionType.RevealAroundWaypoint:return new P.RevealAroundWaypointExecutor(e,t);case i.TriggerActionType.PlaySoundFx:return new O.PlaySoundFxExecutor(e,t);case i.TriggerActionType.PlaySpeech:return new A.PlaySpeechExecutor(e,t);case i.TriggerActionType.ForceTrigger:return new y.ForceTriggerExecutor(e,t);case i.TriggerActionType.TimerStart:return new H.TimerStartExecutor(e,t);case i.TriggerActionType.TimerStop:return new G.TimerStopExecutor(e,t);case i.TriggerActionType.TimerExtend:return new F.TimerExtendExecutor(e,t);case i.TriggerActionType.TimerShorten:return new U.TimerShortenExecutor(e,t);case i.TriggerActionType.TimerSet:return new _.TimerSetExecutor(e,t);case i.TriggerActionType.GlobalSet:return new T.GlobalVariableExecutor(e,t,!0);case i.TriggerActionType.GlobalClear:return new T.GlobalVariableExecutor(e,t,!1);case i.TriggerActionType.DestroyObject:return new h.DestroyObjectExecutor(e,t);case i.TriggerActionType.AddOneTimeSuperWeapon:return new r.AddSuperWeaponExecutor(e,t,!0);case i.TriggerActionType.AddRepeatingSuperWeapon:return new r.AddSuperWeaponExecutor(e,t,!1);case i.TriggerActionType.AllChangeHouse:return new n.ChangeHouseAllExecutor(e,t);case i.TriggerActionType.ResizePlayerView:return new R.ResizePlayerViewExecutor(e,t);case i.TriggerActionType.PlayAnimAt:return new E.PlayAnimAtExecutor(e,t);case i.TriggerActionType.DetonateWarhead:return new g.DetonateWarheadExecutor(e,t);case i.TriggerActionType.ReshroudMap:return new M.ReshroudMapExecutor(e,t);case i.TriggerActionType.EnableTrigger:return new W.ToggleTriggerExecutor(e,t,!0);case i.TriggerActionType.DisableTrigger:return new W.ToggleTriggerExecutor(e,t,!1);case i.TriggerActionType.CreateRadarEvent:return new c.CreateRadarEventExecutor(e,t);case i.TriggerActionType.LocalSet:return new S.LocalVariableExecutor(e,t,!0);case i.TriggerActionType.LocalClear:return new S.LocalVariableExecutor(e,t,!1);case i.TriggerActionType.SellBuilding:return new k.SellBuildingExecutor(e,t);case i.TriggerActionType.TurnOffBuilding:return new z.TurnOnOffBuildingExecutor(e,t,!1);case i.TriggerActionType.TurnOnBuilding:return new z.TurnOnOffBuildingExecutor(e,t,!0);case i.TriggerActionType.ApplyOneHundredDamage:return new s.ApplyDamageExecutor(e,t,100);case i.TriggerActionType.ForceEnd:return new f.ForceEndExecutor(e,t);case i.TriggerActionType.DestroyTag:return new u.DestroyTagExecutor(e,t);case i.TriggerActionType.SetAmbientStep:return new N.SetAmbientStepExecutor(e,t);case i.TriggerActionType.SetAmbientRate:return new j.SetAmbientRateExecutor(e,t);case i.TriggerActionType.SetAmbientLight:return new B.SetAmbientLightExecutor(e,t);case i.TriggerActionType.NukeStrike:return new C.NukeStrikeExecutor(e,t);case i.TriggerActionType.PlaySoundFxAt:return new x.PlaySoundFxAtExecutor(e,t);case i.TriggerActionType.UnrevealAroundWaypoint:return new K.UnrevealAroundWaypointExecutor(e,t);case i.TriggerActionType.LightningStrike:return new b.LightningStrikeExecutor(e,t);case i.TriggerActionType.TimerText:return new V.TimerTextExecutor(e,t);case i.TriggerActionType.CreateCrate:return new l.CreateCrateExecutor(e,t);case i.TriggerActionType.IronCurtainAt:return new v.IronCurtainExecutor(e,t);case i.TriggerActionType.EvictOccupiers:return new p.EvictOccupiersExecutor(e,t);case i.TriggerActionType.Cheer:return new o.CheerExecutor(e,t);case i.TriggerActionType.StopSoundsAt:return new L.StopSoundFxAtExecutor(e,t);default:throw new Error(`Unhandled action type "${i.TriggerActionType[e.type]}"`)}}})}}})),System.register("game/trigger/condition/AmbientLightCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.type=i,this.threshold=Number(e.params[1])/100}check(e){var t=this.previousAmbient,i=e.mapLightingTrait.getAmbient().ambient;return this.previousAmbient=i,void 0!==t&&t!==i&&("above"===this.type?i>=this.threshold&&t<this.threshold:i<=this.threshold&&t>this.threshold)}},e("AmbientLightCondition",r)}}})),System.register("game/trigger/condition/AnyEventCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(e){return!0}},e("AnyEventCondition",r)}}})),System.register("game/trigger/condition/AttackedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter((t=>{if(t.type!==i.EventType.ObjectAttacked)return!1;let r=t.target;if(!r.isTechno()||!this.targets.includes(r))return!1;var s=t.attacker?.player;return(!s||!e.alliances.areAllied(s,r.owner)&&s!==r.owner)&&!t.incidental})).map((e=>e.target))}},e("AttackedByAnyCondition",s)}}})),System.register("game/trigger/condition/AttackedByHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}check(e,t){return t.filter((e=>{if(e.type!==i.EventType.ObjectAttacked)return!1;let t=e.target;if(!t.isTechno()||!this.targets.includes(t))return!1;var r=e.attacker?.player;return r&&(-1===this.houseId||r?.country?.id===this.houseId)})).map((e=>e.target))}},e("AttackedByHouseCondition",s)}}})),System.register("game/trigger/condition/BuildingExistsCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i=!1){super(e,t),this.negate=i,this.objectIndex=Number(e.params[1])}check(){if(!this.player)return!1;for(var e of this.player.buildings)if(e.rules.index===this.objectIndex)return!this.negate;return this.negate}},e("BuildingExistsCondition",r)}}})),System.register("game/trigger/condition/BuildObjectTypeCondition",["game/trigger/TriggerCondition","game/event/EventType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.objectType=i,this.objectIndex=Number(e.params[1])}check(e,t){return t.some((e=>e.type===r.EventType.ObjectSpawn&&e.gameObject.type===this.objectType&&e.gameObject.rules.index===this.objectIndex))}},e("BuildObjectTypeCondition",s)}}})),System.register("game/trigger/condition/ComesNearWaypointCondition",["game/event/EventType","game/gameobject/unit/RangeHelper","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t)}init(e){super.init(e);var t=Number(this.event.params[1]);this.waypointTile=e.map.getTileAtWaypoint(t),this.waypointTile||console.warn(`No valid location found for waypoint ${t}. Skipping event ${this.getDebugName()}.`)}check(e,t){if(!this.waypointTile||!this.player)return!1;for(var s of t)if(s.type===i.EventType.EnterTile&&s.source.owner===this.player){if(new r.RangeHelper(e.map.tileOccupation).tileDistance(s.target,this.waypointTile)<2)return!0}return!1}},e("ComesNearWaypointCondition",n)}}})),System.register("game/trigger/condition/CreditsBelowCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.threshold=Number(e.params[1])}check(e,t){return!!this.player&&this.player.credits<this.threshold}},e("CreditsBelowCondition",r)}}})),System.register("game/trigger/condition/CreditsExceedCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.threshold=Number(e.params[1])}check(e,t){return!!this.player&&this.player.credits>this.threshold}},e("CreditsExceedCondition",r)}}})),System.register("game/trigger/condition/CrossHorizLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter((e=>e.type===i.EventType.EnterTile&&e.source.zone!==r.ZoneType.Air&&this.targets.some((t=>t.ry===e.target.ry))&&(-1===this.houseId||e.source.owner.country?.id===this.houseId))).map((e=>e.target))}},e("CrossHorizLineCondition",n)}}})),System.register("game/trigger/condition/CrossVertLineCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter((e=>e.type===i.EventType.EnterTile&&e.source.zone!==r.ZoneType.Air&&this.targets.some((t=>t.rx===e.target.rx))&&(-1===this.houseId||e.source.owner.country?.id===this.houseId))).map((e=>e.target))}},e("CrossVertLineCondition",n)}}})),System.register("game/trigger/condition/DestroyedAllBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some((e=>{if(e.type!==i.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isBuilding()||t.owner.country?.id!==this.houseId||t.owner.buildings.size)}))&&(this.allDestroyed=!0)}},e("DestroyedAllBuildingsCondition",s)}}})),System.register("game/trigger/condition/DestroyedAllCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some((e=>{if(e.type!==i.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isTechno()||t.owner.country?.id!==this.houseId||t.owner.getOwnedObjects(!0).length)}))&&(this.allDestroyed=!0)}},e("DestroyedAllCondition",s)}}})),System.register("game/trigger/condition/DestroyedAllUnitsCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some((e=>{if(e.type!==r.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isUnit()||t.owner.country?.id!==this.houseId||this.hasUnitsLeft(t.owner))}))&&(this.allDestroyed=!0)}hasUnitsLeft(e){var t;for(t of[i.ObjectType.Aircraft,i.ObjectType.Vehicle,i.ObjectType.Infantry])if(e.getOwnedObjectsByType(t,!0).length)return!0;return!1}},e("DestroyedAllUnitsCondition",n)}}})),System.register("game/trigger/condition/DestroyedAllUnitsLandCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some((e=>{if(e.type!==r.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isUnit()||t.owner.country?.id!==this.houseId||this.hasLandUnitsLeft(t.owner))}))&&(this.allDestroyed=!0)}hasLandUnitsLeft(e){var t;for(t of[i.ObjectType.Vehicle,i.ObjectType.Infantry])if(e.getOwnedObjectsByType(t,!0).filter((e=>!e.rules.naval)).length)return!0;return!1}},e("DestroyedAllUnitsLandCondition",n)}}})),System.register("game/trigger/condition/DestroyedAllUnitsNavalCondition",["engine/type/ObjectType","game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.allDestroyed=!1,this.houseId=Number(e.params[1])}check(e,t){return!!this.allDestroyed||!!t.some((e=>{if(e.type!==r.EventType.ObjectDestroy)return!1;let t=e.target;return!(!t.isVehicle()||t.owner.country?.id!==this.houseId||t.owner.getOwnedObjectsByType(i.ObjectType.Vehicle,!0).filter((e=>e.rules.naval)).length)}))&&(this.allDestroyed=!0)}},e("DestroyedAllUnitsNavalCondition",n)}}})),System.register("game/trigger/condition/DestroyedBridgeCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter((t=>{if(t.type!==i.EventType.ObjectDestroy)return!1;let r=t.target;if(!r.isOverlay()||!r.isBridge())return!1;var s=r.bridgeTrait?.bridgeSpec;if(!s)return!1;return e.map.bridges.findAllBridgeTiles(s).find((e=>this.targets.includes(e)))})).map((e=>e.target.tile))}},e("DestroyedBridgeCondition",s)}}})),System.register("game/trigger/condition/DestroyedBuildingsCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.count=0,this.threshold=Number(e.params[1])}check(e,t){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var r of t)if(r.type===i.EventType.ObjectDestroy){let e=r.target;e.isBuilding()&&e.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},e("DestroyedBuildingsCondition",s)}}})),System.register("game/trigger/condition/DestroyedByAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter((t=>{if(t.type!==i.EventType.ObjectDestroy)return!1;let r=t.target;if(!r.isTechno()||!this.targets.includes(r))return!1;var s=t.attackerInfo?.player;return(!s||!e.alliances.areAllied(s,r.owner)&&s!==r.owner)&&!t.incidental})).map((e=>e.target))}},e("DestroyedByAnyCondition",s)}}})),System.register("game/trigger/condition/DestroyedOrCapturedCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter((e=>{if(e.type!==i.EventType.ObjectDestroy&&e.type!==i.EventType.ObjectOwnerChange)return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))})).map((e=>e.target))}},e("DestroyedOrCapturedCondition",s)}}})),System.register("game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(){super(...arguments),this.eventsFilter=[i.EventType.ObjectDestroy,i.EventType.ObjectOwnerChange,i.EventType.BuildingInfiltration]}check(e,t){return t.filter((e=>{if(!this.eventsFilter.includes(e.type))return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))})).map((e=>e.target))}},e("DestroyedOrCapturedOrInfiltratedCondition",s)}}})),System.register("game/trigger/condition/DestroyedUnitsCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.count=0,this.threshold=Number(e.params[1])}check(e,t){if(!this.player)return!1;if(this.count>=this.threshold)return!0;for(var r of t)if(r.type===i.EventType.ObjectDestroy){let e=r.target;e.isUnit()&&e.owner.country?.id===this.houseId&&this.count++}return this.count>=this.threshold}},e("DestroyedUnitsCondition",s)}}})),System.register("game/trigger/condition/ElapsedScenarioTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.timerTicks=Number(this.event.params[1])*i.GameSpeed.BASE_TICKS_PER_SECOND}check(e){return e.currentTick>this.timerTicks}},e("ElapsedScenarioTimeCondition",s)}}})),System.register("game/trigger/condition/ElapsedTimeCondition",["game/GameSpeed","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.elapsedTicks=0,this.timerTicks=Number(this.event.params[1])*i.GameSpeed.BASE_TICKS_PER_SECOND}check(e){return this.elapsedTicks++>this.timerTicks}reset(){this.elapsedTicks=0}},e("ElapsedTimeCondition",s)}}})),System.register("game/trigger/condition/EnteredByCondition",["game/event/EventType","game/gameobject/unit/ZoneType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter((e=>(e.type===i.EventType.EnterObject||e.type===i.EventType.EnterTile)&&this.targets.includes(e.target)&&(e.type!==i.EventType.EnterTile||e.source.zone!==r.ZoneType.Air)&&(-1===this.houseId||e.source.owner.country?.id===this.houseId))).map((e=>e.target))}},e("EnteredByCondition",n)}}})),System.register("game/trigger/condition/GlobalVariableCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.value=i,this.blocking=!0,this.variableIdx=Number(e.params[1])}check(e){return e.triggers.getGlobalVariable(this.variableIdx)===this.value}},e("GlobalVariableCondition",r)}}})),System.register("game/trigger/condition/HealthBelowAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t,i){super(e,t),this.threshold=i}check(e,t){return t.filter((e=>{if(e.type!==i.EventType.HealthChange)return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))&&e.currentHealth<this.threshold&&e.prevHealth>this.threshold})).map((e=>e.target))}},e("HealthBelowAnyCondition",s)}}})),System.register("game/trigger/condition/HealthBelowCombatCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t,i){super(e,t),this.threshold=i}check(e,t){return t.filter((e=>{if(e.type!==i.EventType.InflictDamage)return!1;let t=e.target;return!(!t.isTechno()||!this.targets.includes(t))&&e.currentHealth<this.threshold&&e.prevHealth>this.threshold})).map((e=>e.target))}},e("HealthBelowCombatCondition",s)}}})),System.register("game/trigger/condition/LocalVariableCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t,i){super(e,t),this.value=i,this.blocking=!0,this.variableIdx=Number(e.params[1])}check(e){return e.triggers.getLocalVariable(this.variableIdx)===this.value}},e("LocalVariableCondition",r)}}})),System.register("game/trigger/condition/LowPowerCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}init(e){super.init(e),this.targetPlayer=e.getAllPlayers().find((e=>e.country?.id===this.houseId))}check(){return!!this.targetPlayer?.powerTrait?.isLowPower()}},e("LowPowerCondition",r)}}})),System.register("game/trigger/condition/NoEventCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(e){return!1}},e("NoEventCondition",r)}}})),System.register("game/trigger/condition/NoFactoriesLeftCondition",["game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.TriggerCondition{check(){if(!this.player)return!1;for(var e of this.player.buildings)if(e.factoryTrait)return!1;return!0}},e("NoFactoriesLeftCondition",r)}}})),System.register("game/trigger/condition/PickupCrateAnyCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.some((e=>e.type===i.EventType.CratePickup))}},e("PickupCrateAnyCondition",s)}}})),System.register("game/trigger/condition/PickupCrateCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.filter((e=>e.type===i.EventType.CratePickup&&this.targets.includes(e.source))).map((e=>e.source))}},e("PickupCrateCondition",s)}}})),System.register("game/trigger/condition/RandomDelayCondition",["game/GameSpeed","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(){super(...arguments),this.elapsedTicks=0}check(e){return this.timerTicks??(this.timerTicks=Math.floor(e.generateRandomInt(50,150)/100*Number(this.event.params[1]))*i.GameSpeed.BASE_TICKS_PER_SECOND),this.elapsedTicks++>this.timerTicks}reset(){this.timerTicks=void 0,this.elapsedTicks=0}},e("RandomDelayCondition",s)}}})),System.register("game/trigger/condition/SpiedByCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(this.event.params[1])}check(e,t){return t.filter((e=>e.type===i.EventType.BuildingInfiltration&&this.targets.includes(e.target)&&(-1===this.houseId||e.source.owner.country?.id===this.houseId))).map((e=>e.target))}},e("SpiedByCondition",s)}}})),System.register("game/trigger/condition/SpyEnteringAsHouseCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.houseId=Number(e.params[1])}check(e,t){return t.filter((e=>{if(e.type!==i.EventType.BuildingInfiltration)return!1;var t=e.target;return!!this.targets.includes(t)&&(-1===this.houseId||e.source.disguiseTrait?.getDisguise()?.owner?.country?.id===this.houseId)})).map((e=>e.target))}},e("SpyEnteringAsHouseCondition",s)}}})),System.register("game/trigger/condition/SpyEnteringAsInfantryCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{constructor(e,t){super(e,t),this.infantryIdx=Number(e.params[1])}check(e,t){return t.filter((e=>{if(e.type!==i.EventType.BuildingInfiltration)return!1;var t=e.target;return!!this.targets.includes(t)&&e.source.disguiseTrait?.getDisguise()?.rules.index===this.infantryIdx})).map((e=>e.target))}},e("SpyEnteringAsInfantryCondition",s)}}})),System.register("game/trigger/condition/TimerExpiredCondition",["game/event/EventType","game/trigger/TriggerCondition"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.TriggerCondition{check(e,t){return t.some((e=>e.type===i.EventType.TimerExpire))}},e("TimerExpiredCondition",s)}}})),System.register("game/trigger/TriggerConditionFactory",["data/map/trigger/TriggerEventType","engine/type/ObjectType","game/trigger/condition/AmbientLightCondition","game/trigger/condition/AnyEventCondition","game/trigger/condition/AttackedByAnyCondition","game/trigger/condition/AttackedByHouseCondition","game/trigger/condition/BuildingExistsCondition","game/trigger/condition/BuildObjectTypeCondition","game/trigger/condition/ComesNearWaypointCondition","game/trigger/condition/CreditsBelowCondition","game/trigger/condition/CreditsExceedCondition","game/trigger/condition/CrossHorizLineCondition","game/trigger/condition/CrossVertLineCondition","game/trigger/condition/DestroyedAllBuildingsCondition","game/trigger/condition/DestroyedAllCondition","game/trigger/condition/DestroyedAllUnitsCondition","game/trigger/condition/DestroyedAllUnitsLandCondition","game/trigger/condition/DestroyedAllUnitsNavalCondition","game/trigger/condition/DestroyedBridgeCondition","game/trigger/condition/DestroyedBuildingsCondition","game/trigger/condition/DestroyedByAnyCondition","game/trigger/condition/DestroyedOrCapturedCondition","game/trigger/condition/DestroyedOrCapturedOrInfiltratedCondition","game/trigger/condition/DestroyedUnitsCondition","game/trigger/condition/ElapsedScenarioTimeCondition","game/trigger/condition/ElapsedTimeCondition","game/trigger/condition/EnteredByCondition","game/trigger/condition/GlobalVariableCondition","game/trigger/condition/HealthBelowAnyCondition","game/trigger/condition/HealthBelowCombatCondition","game/trigger/condition/LocalVariableCondition","game/trigger/condition/LowPowerCondition","game/trigger/condition/NoEventCondition","game/trigger/condition/NoFactoriesLeftCondition","game/trigger/condition/PickupCrateAnyCondition","game/trigger/condition/PickupCrateCondition","game/trigger/condition/RandomDelayCondition","game/trigger/condition/SpiedByCondition","game/trigger/condition/SpyEnteringAsHouseCondition","game/trigger/condition/SpyEnteringAsInfantryCondition","game/trigger/condition/TimerExpiredCondition"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e}],execute:function(){e("TriggerConditionFactory",class{create(e,t){switch(e.type){case i.TriggerEventType.NoEvent:return new j.NoEventCondition(e,t);case i.TriggerEventType.EnteredBy:return new M.EnteredByCondition(e,t);case i.TriggerEventType.SpiedBy:return new _.SpiedByCondition(e,t);case i.TriggerEventType.AttackedByAny:return new a.AttackedByAnyCondition(e,t);case i.TriggerEventType.DestroyedByAny:return new w.DestroyedByAnyCondition(e,t);case i.TriggerEventType.AnyEvent:return new n.AnyEventCondition(e,t);case i.TriggerEventType.DestroyedAllUnits:return new y.DestroyedAllUnitsCondition(e,t);case i.TriggerEventType.DestroyedAllBuildings:return new m.DestroyedAllBuildingsCondition(e,t);case i.TriggerEventType.DestroyedAll:return new f.DestroyedAllCondition(e,t);case i.TriggerEventType.CreditsExceed:return new d.CreditsExceedCondition(e,t);case i.TriggerEventType.ElapsedTime:return new A.ElapsedTimeCondition(e,t);case i.TriggerEventType.MissionTimerExpired:return new G.TimerExpiredCondition(e,t);case i.TriggerEventType.DestroyedBuildings:return new S.DestroyedBuildingsCondition(e,t);case i.TriggerEventType.DestroyedUnits:return new x.DestroyedUnitsCondition(e,t);case i.TriggerEventType.NoFactoriesLeft:return new N.NoFactoriesLeftCondition(e,t);case i.TriggerEventType.BuildBuilding:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Building);case i.TriggerEventType.BuildUnit:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Vehicle);case i.TriggerEventType.BuildInfantry:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Infantry);case i.TriggerEventType.BuildAircraft:return new c.BuildObjectTypeCondition(e,t,r.ObjectType.Aircraft);case i.TriggerEventType.CrossesHorizontalLine:return new g.CrossHorizLineCondition(e,t);case i.TriggerEventType.CrossesVerticalLine:return new p.CrossVertLineCondition(e,t);case i.TriggerEventType.GlobalIsSet:return new R.GlobalVariableCondition(e,t,!0);case i.TriggerEventType.GlobalIsCleared:return new R.GlobalVariableCondition(e,t,!1);case i.TriggerEventType.DestroyedOrCaptured:return new C.DestroyedOrCapturedCondition(e,t);case i.TriggerEventType.LowPower:return new B.LowPowerCondition(e,t);case i.TriggerEventType.DestroyedBridge:return new b.DestroyedBridgeCondition(e,t);case i.TriggerEventType.BuildingExists:return new l.BuildingExistsCondition(e,t);case i.TriggerEventType.ComesNearWaypoint:return new h.ComesNearWaypointCondition(e,t);case i.TriggerEventType.LocalIsSet:return new k.LocalVariableCondition(e,t,!0);case i.TriggerEventType.LocalIsCleared:return new k.LocalVariableCondition(e,t,!1);case i.TriggerEventType.FirstDamagedCombat:return new I.HealthBelowCombatCondition(e,t,100);case i.TriggerEventType.HalfHealthCombat:return new I.HealthBelowCombatCondition(e,t,50);case i.TriggerEventType.QuarterHealthCombat:return new I.HealthBelowCombatCondition(e,t,25);case i.TriggerEventType.FirstDamagedAny:return new P.HealthBelowAnyCondition(e,t,100);case i.TriggerEventType.HalfHealthAny:return new P.HealthBelowAnyCondition(e,t,50);case i.TriggerEventType.QuarterHealthAny:return new P.HealthBelowAnyCondition(e,t,25);case i.TriggerEventType.AttackedByHouse:return new o.AttackedByHouseCondition(e,t);case i.TriggerEventType.AmbientLightBelow:return new s.AmbientLightCondition(e,t,"below");case i.TriggerEventType.AmbientLightAbove:return new s.AmbientLightCondition(e,t,"above");case i.TriggerEventType.ElapsedScenarioTime:return new O.ElapsedScenarioTimeCondition(e,t);case i.TriggerEventType.DestroyedOrCapturedOrInfiltrated:return new E.DestroyedOrCapturedOrInfiltratedCondition(e,t);case i.TriggerEventType.PickupCrate:return new D.PickupCrateCondition(e,t);case i.TriggerEventType.PickupCrateAny:return new L.PickupCrateAnyCondition(e,t);case i.TriggerEventType.RandomDelay:return new F.RandomDelayCondition(e,t);case i.TriggerEventType.CreditsBelow:return new u.CreditsBelowCondition(e,t);case i.TriggerEventType.SpyEnteringAsHouse:return new U.SpyEnteringAsHouseCondition(e,t);case i.TriggerEventType.SpyEnteringAsInfantry:return new H.SpyEnteringAsInfantryCondition(e,t);case i.TriggerEventType.DestroyedAllUnitsNaval:return new v.DestroyedAllUnitsNavalCondition(e,t);case i.TriggerEventType.DestroyedAllUnitsLand:return new T.DestroyedAllUnitsLandCondition(e,t);case i.TriggerEventType.BuildingNotExists:return new l.BuildingExistsCondition(e,t,!0);default:throw new Error(`Unhandled trigger event type "${i.TriggerEventType[e.type]}"`)}}})}}})),System.register("game/trigger/TriggerManager",["data/map/tag/TagRepeatType","game/trigger/TriggerExecutorFactory","game/trigger/TriggerConditionFactory","util/disposable/CompositeDisposable","data/map/Variable"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("TriggerManager",class{constructor(){this.disposables=new n.CompositeDisposable,this.triggerInstances=new Map,this.targetsByTag=new Map,this.conditionFactory=new s.TriggerConditionFactory,this.executorFactory=new r.TriggerExecutorFactory,this.pendingGameEvents=[],this.globalVariables=new Map,this.localVariables=new Map}init(e){var t,i,r,s,n=e.map.getInitialMapObjects().technos;for(let t of n)if(t.tag){let i=this.targetsByTag.get(t.tag);i||(i=[],this.targetsByTag.set(t.tag,i));var a=e.map.tiles.getByMapCoords(t.rx,t.ry);!a||(a=e.map.getObjectsOnTile(a).find((e=>e.name===t.name&&e.type===t.type)))&&i.push(a)}for(t of e.map.getCellTags()){var o=e.map.tiles.getByMapCoords(t.coords.x,t.coords.y);if(o){let e=this.targetsByTag.get(t.tagId);e||(e=[],this.targetsByTag.set(t.tagId,e)),e.push(o)}else console.warn(`CellTag out of bounds at (${t.coords.x}, ${t.coords.y}). Skipping.`)}for([i,r]of e.map.getVariables())this.localVariables.set(i,r.clone());for(s of e.map.getTriggers())this.triggerInstances.set(s.id,this.createTriggerInstance(s,e));this.disposables.add(e.events.subscribe((e=>this.pendingGameEvents.push(e))))}createTriggerInstance(e,t){let r=this.targetsByTag.get(e.tag.id)??[];return{trigger:e,conditions:e.events.map((i=>{let s=this.conditionFactory.create(i,e);return s.setTargets(r),s.init(t),s})).sort(((e,t)=>Number(t.blocking)-Number(e.blocking))),targets:r,remainingTargets:new Set(e.tag.repeatType===i.TagRepeatType.OnceAll?r:[]),disabled:e.disabled,finished:!1}}update(e){var t,r=this.pendingGameEvents.splice(0,this.pendingGameEvents.length);for(t of this.triggerInstances.values())if(!t.finished&&!t.disabled){let l=!0,c=[];for(var s of t.conditions){var n=s.check(e,r);if("boolean"==typeof n?n||(l=!1):n.length?c.push(...n):l=!1,s.blocking&&!l)break}if(l){var a=t.trigger;t.conditions.forEach((e=>e.reset?.()));let r=[];if(a.tag.repeatType===i.TagRepeatType.OnceAll){for(var o of c)t.remainingTargets.delete(o);if(t.remainingTargets.size)continue;r=c.length?[c[c.length-1]]:[]}else r=t.targets;this.executeActions(a,r,e),a.tag.repeatType!==i.TagRepeatType.Repeat&&(t.finished=!0)}}}executeActions(e,t,i){for(var r of e.actions){this.executorFactory.create(r,e).execute(i,t)}}setTriggerEnabled(e,t){let i=this.triggerInstances.get(e);i&&(i.disabled=!t)}forceTrigger(e,t){var i=this.triggerInstances.get(e);i&&this.executeActions(i.trigger,i.targets,t)}destroyTrigger(e){this.triggerInstances.delete(e)}destroyTag(e){let t=[];for(var[i,r]of this.triggerInstances)r.trigger.tag.id===e&&t.push(i);for(var s of t)this.destroyTrigger(s)}getGlobalVariable(e){return!!this.globalVariables.get(e)?.value}toggleGlobalVariable(e,t){let i=this.globalVariables.get(e);void 0===i?this.globalVariables.set(e,new a.Variable("No name",t)):i.value=t}getLocalVariable(e){return!!this.localVariables.get(e)?.value}toggleLocalVariable(e,t){let i=this.localVariables.get(e);void 0===i?this.localVariables.set(e,new a.Variable("No name",t)):i.value=t}dispose(){this.disposables.dispose()}})}}})),System.register("game/trait/MapLightingTrait",["data/map/MapLighting","game/GameSpeed","util/event","game/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class{constructor(e,t){this.mapLighting=new i.MapLighting,this._onChange=new s.EventDispatcher,this.ambientChangeRate=e.ambientChangeRate,this.ambientChangeStep=e.ambientChangeStep,t&&this.mapLighting.copy(t)}get onChange(){return this._onChange.asEvent()}setAmbientChangeRate(e){this.ambientChangeRate=e}setAmbientChangeStep(e){this.ambientChangeStep=e}setTargetAmbientIntensity(e){this.targetAmbient=e}getAmbient(){return this.mapLighting}[n.NotifyTick.onTick](){var e;void 0!==this.targetAmbient&&(this.ambientUpdateTicks??(this.ambientUpdateTicks=Math.floor(60*r.GameSpeed.BASE_TICKS_PER_SECOND*this.ambientChangeRate)),this.ambientUpdateTicks<=0?(this.ambientUpdateTicks=void 0,e=this.mapLighting.ambient,(e=this.targetAmbient-e)?(e=Math.sign(e)*Math.min(this.ambientChangeStep,Math.abs(e)),this.mapLighting.ambient+=e,this._onChange.dispatch(this,this.mapLighting)):this.targetAmbient=void 0):this.ambientUpdateTicks--)}},e("MapLightingTrait",a)}}})),System.register("game/event/TimerExpireEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TimerExpireEvent",class{constructor(e){this.target=e,this.type=i.EventType.TimerExpire}})}}})),System.register("game/CountdownTimer",["game/event/TimerExpireEvent","game/GameSpeed"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("CountdownTimer",class{constructor(){this.ticks=0,this.running=!1}getSeconds(){return Math.floor(this.ticks/r.GameSpeed.BASE_TICKS_PER_SECOND)}setSeconds(e){this.ticks=Math.max(0,Math.floor(r.GameSpeed.BASE_TICKS_PER_SECOND*e))}addSeconds(e){this.ticks=Math.max(0,this.ticks+Math.floor(r.GameSpeed.BASE_TICKS_PER_SECOND*e))}start(){this.running=!0}stop(){this.running=!1}isRunning(){return this.running}update(e){this.running&&(0<this.ticks?this.ticks--:(this.running=!1,e.events.dispatch(new i.TimerExpireEvent(this))))}})}}})),System.register("game/trait/interface/NotifyObjectTraitAdd",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onAdd=Symbol(),e("NotifyObjectTraitAdd",i)}}})),System.register("game/ai/Ai",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("Ai",class{constructor(e){this.ini=e}getIni(){return this.ini}})}}})),System.register("game/Game",["game/ConstructionWorker","game/gameopts/GameOpts","engine/type/ObjectType","util/event","game/map/OreSpread","game/gameobject/Infantry","game/Alliances","util/BoxedVar","game/StartingUnitsGenerator","game/map/tileFinder/CardinalTileFinder","game/type/SpeedType","game/Target","game/map/BridgeOverlayTypes","util/math","game/GameEventBus","game/event/ObjectDestroyEvent","game/event/PlayerDefeatedEvent","game/ini/GameModeType","game/Traits","game/trait/interface/NotifyTick","game/trait/interface/NotifyDestroy","game/trait/interface/NotifySpawn","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/event/ObjectOwnerChangeEvent","game/event/ObjectUnspawnEvent","game/trait/interface/NotifyTargetDestroy","game/gameobject/unit/VeteranLevel","game/event/ObjectSpawnEvent","engine/type/OverlayTibType","game/map/OreOverlayTypes","game/Weapon","game/GameSpeed","game/gameobject/common/DeathType","game/map/Bridges","game/SuperWeapon","game/event/AllianceChangeEvent","game/trait/interface/NotifyAllianceChange","game/gameopts/constants","game/gameobject/unit/ZoneType","game/Prng","game/trigger/TriggerManager","game/CountdownTimer","game/WeaponType","game/Warhead","game/trait/interface/NotifyObjectTraitAdd"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e}],execute:function(){var t;(t=$=$||{})[t.NotStarted=0]="NotStarted",t[t.Started=1]="Started",t[t.Ended=2]="Ended",e("GameStatus",$),e("Game",class{constructor(e,t,i,r,s,a,o,l,h,u,d,g,p,m,y){this.updatableObjects=new Set,this.constructionWorkers=new Map,this.currentTick=0,this.currentTime=0,this.countdownTimer=new W.CountdownTimer,this._onEnd=new n.EventDispatcher,this.afterTickCallbacks=[],this.events=new f.GameEventBus,this.traits=new b.Traits,this.debugText=new c.BoxedVar(""),this.world=e,this.map=t,this.rules=i,this.art=r,this.ai=s,this.id=a,this.startTimestamp=o,this.prng=new G.Prng(Number(a+""+o)),this.gameOpts=l,this.gameModeType=h,this.playerList=u,this.unitSelection=d,this.alliances=g,this.desiredSpeed=new c.BoxedVar(j.GameSpeed.computeGameSpeed(l.gameSpeed)),this.speed=new c.BoxedVar(this.desiredSpeed.value),this.nextObjectId=p,this.objectFactory=m,this.botManager=y,this.triggers=new V.TriggerManager}get onEnd(){return this._onEnd.asEvent()}addPlayer(e){this.playerList.addPlayer(e),this.constructionWorkers.set(e,this.createConstructionWorker(e))}getPlayer(e){return this.playerList.getPlayerAt(e)}getPlayerByName(e){return this.playerList.getPlayerByName(e)}getAiPlayerName(e){let t;return t="number"==typeof e?e:this.gameOpts.aiPlayers.indexOf(e),`@@AI${t+1}@@`}getPlayerNumber(e){return this.playerList.getPlayerNumber(e)}getCombatants(){return this.playerList.getCombatants()}getCivilianPlayer(){return this.playerList.getCivilian()}getAllPlayers(){return this.playerList.getAll()}getNonNeutralPlayers(){return this.playerList.getNonNeutral()}areFriendly(e,t){return e.owner===t.owner||this.alliances.areAllied(e.owner,t.owner)}getWorld(){return this.world}createConstructionWorker(e){return new i.ConstructionWorker(e,this.rules,this.art,this.map,this)}getConstructionWorker(e){var t=this.constructionWorkers.get(e);if(!t)throw new Error(`No construction worker found for player "${e.name}"`);return t}getUnitSelection(){return this.unitSelection}init(e){this.localPlayer=e,this.createMapObjects(),this.createPlayerInitialUnits(),this.map.terrain.computeAllPassabilityGraphs(),this.mapShroudTrait.init(this),this.crateGeneratorTrait.init(this),this.playerList.getAll().forEach((e=>e.credits=this.gameOpts.credits)),this.rules.mpDialogSettings.alliesAllowed&&this.createInitialTeams()}start(){this.status=$.Started,this.currentTick=0,this.currentTime=0,this.botManager.init(this),this.triggers.init(this)}createInitialTeams(){for(let s=0;s<this.gameOpts.maxSlots;s++){var e=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter((e=>e?.teamId===s&&e.countryId!==U.OBS_COUNTRY_ID)).map((e=>r.isHumanPlayerInfo(e)?e.name:this.getAiPlayerName(e)));if(1<e.length)for(let r=0;r<e.length-1;r++)for(let s=r+1;s<e.length;s++){var t=this.getPlayerByName(e[r]),i=this.getPlayerByName(e[s]);i=this.alliances.setAlliance(t,i,l.AllianceStatus.Formed);this.onAllianceChange(i,t,!0)}}}createMapObjects(){var e=this.rules.general.harvesterUnit.every((e=>!m.isBetween(this.rules.getObject(e,s.ObjectType.Vehicle).techLevel,0,this.rules.mpDialogSettings.techLevel))),t=this.map.getInitialMapObjects();this.createInitialMapTerrains(t.terrains,e),this.createInitialMapOverlays(t.overlays,e),this.createInitialMapSmudges(t.smudges),this.createInitialMapTechnos(t.technos)}createInitialMapTerrains(e,t){for(var i of e){var r,n,a=i.name;this.validateMapObjectRulesAndArt(a,s.ObjectType.Terrain)&&((r=this.map.tiles.getByMapCoords(i.rx,i.ry))?(n=this.rules.getObject(a,s.ObjectType.Terrain),t&&n.spawnsTiberium||(a=this.createObject(s.ObjectType.Terrain,a),this.spawnObject(a,r))):console.warn(`Invalid map object location (${i.rx},${i.ry})`,i))}}createInitialMapOverlays(e,t){let i=new Map,r=new Map;for(var n of e){var o=this.rules.getOverlayName(n.id);if(this.validateMapObjectRulesAndArt(o,s.ObjectType.Overlay)){let e=this.createObject(s.ObjectType.Overlay,o);e.overlayId=n.id,e.value=n.value;let c=n.rx,h=n.ry;e.isBridge()&&e.isHighBridge()&&(e.position.tileElevation=4,c+=e.isXBridge()?0:-1,h+=e.isXBridge()?-1:0);var l=this.map.tiles.getByMapCoords(c,h);if(l)if(e.rules.tiberium&&(o=k.OreOverlayTypes.getOverlayTibType(n.id),void 0!==(o=a.OreSpread.calculateOverlayId(o,l))&&o!==n.id&&(e.dispose(),e=this.createObject(s.ObjectType.Overlay,this.rules.getOverlayName(o)),e.overlayId=o,e.value=n.value)),p.BridgeOverlayTypes.isLowBridge(n.id))p.BridgeOverlayTypes.isBridgePlaceholder(n.id)||(i.set(l,n.value),1===n.value?r.set(l,e):e.dispose());else{if(e.isTiberium()){if(![I.OverlayTibType.Ore,I.OverlayTibType.Gems,I.OverlayTibType.Vinifera].includes(k.OreOverlayTypes.getOverlayTibType(e.overlayId))){console.warn(`Found unsupported TS tiberium overlay ${e.overlayId} @${l.rx},${l.ry}. Skipping.`);continue}if(this.map.getObjectsOnTile(l).find((e=>e.isTerrain()))){e.dispose();continue}}t&&e.isTiberium()?e.dispose():this.spawnObject(e,l)}else console.warn(`Invalid map object location (${c},${h})`,n),e.dispose()}}for(var[c,h]of r){var u=h.isXBridge(),d=this.map.tiles.getByMapCoords(c.rx+(u?0:-1),c.ry+(u?-1:0));u=this.map.tiles.getByMapCoords(c.rx+(u?0:1),c.ry+(u?1:0));d&&u&&(0===i.get(d)||2===i.get(u))?(h.value=0,this.spawnObject(h,d)):(h.dispose(),console.warn(`Invalid bridge segment @${c.rx},${c.ry}. Skipping.`))}var g,m=[...r.keys()].filter((e=>this.map.bridges.getPieceAtTile(e)?.headType!==L.BridgeHeadType.None)),f=this.map.bridges.findMapHighBridgeHeadTiles();let y=this.map.bridges.findBridgeSpecsForHeadTiles([...m,...f]);for(g of y)for(var T of this.map.bridges.findBridgePieces(g))T.obj.bridgeTrait.bridgeSpec=g;f=y.map((e=>this.map.bridges.findAllBridgeTiles(e))).flat();var v,b=p.BridgeOverlayTypes.bridgePlaceholderIds[0],S=this.rules.getOverlayName(b);for(v of f){let e=this.createObject(s.ObjectType.Overlay,S);e.overlayId=b,this.spawnObject(e,v)}}createInitialMapSmudges(e){for(var t of e){var i=t.name,r=this.map.tiles.getByMapCoords(t.rx,t.ry);r?(i=this.createObject(s.ObjectType.Smudge,i),this.spawnObject(i,r)):console.warn(`Invalid map object location (${t.rx},${t.ry})`,t)}}createInitialMapTechnos(e){let t=new Map(this.playerList.getAll().filter((e=>!!e.country)).map((e=>[e.country.name,e]))),i=this.map.getTags();for(let a of e){var r=a.name;if(this.validateMapObjectRulesAndArt(r,a.type)){var s=this.map.tiles.getByMapCoords(a.rx,a.ry);if(s){var n=t.get(a.owner);if(n){if(n.isNeutral){let e=this.createObject(a.type,r);a.tag&&(e.tag=i.find((e=>e.id===a.tag))),e.healthTrait.health=a.health/256*100;let t=!1;if(!e.healthTrait.health){if(!e.isBuilding()||!e.rules.leaveRubble){e.dispose();continue}t=!0}if(a.isInfantry()||a.isVehicle()||a.isAircraft()){e.direction=(-a.direction/256*360+360)%360,a.isInfantry()&&(e.position.subCell=a.subCell);let t=!1;a.onBridge&&(void 0===s.onBridgeLandType?console.warn(`Cannot place unit "${a.name}" on a bridge because no bridge was found at ${s.rx}, `+s.ry):t=!0),e.onBridge=t,e.zone=H.getZoneType(t?s.onBridgeLandType:s.landType),t&&(e.position.tileElevation+=this.map.tileOccupation.getBridgeOnTile(s)?.tileElevation??0),a.veterancy&&e.veteranTrait?.setRelativeXP(a.veterancy)}else e.poweredTrait?.setTurnedOn(a.poweredOn);this.changeObjectOwner(e,n),this.spawnObject(e,s),t&&this.destroyObject(e,void 0,!0)}}else console.warn(`Invalid owner "${a.owner}" for map object`,a)}else console.warn(`Invalid map object location (${a.rx},${a.ry})`,a)}}}validateMapObjectRulesAndArt(e,t){return this.rules.hasObject(e,t)?!!this.art.hasObject(e,t)||(console.warn(`Map object '${e}' has no art section. Skipping.`),!1):(console.warn(`Map object '${e}' has no rules section. Skipping.`),!1)}createPlayerInitialUnits(){let e=this.playerList.getCombatants().map((e=>e.country));var t=[...this.rules.infantryRules.values(),...this.rules.vehicleRules.values()].filter((t=>t.allowedToStartInMultiplayer&&!t.naval&&-1!==t.techLevel&&t.techLevel<=this.rules.mpDialogSettings.techLevel&&!this.rules.general.baseUnit.includes(t.name)&&e.some((e=>t.isAvailableTo(e)&&t.hasOwner(e)))));for(let e of this.playerList.getCombatants()){var i=this.map.startingLocations[e.startLocation],r=this.map.tiles.getByMapCoords(i.x,i.y);let m=this.rules.general.baseUnit.find((t=>{let i=this.rules.getObject(t,s.ObjectType.Vehicle);return i.isAvailableTo(e.country)&&i.hasOwner(e.country)}));if(!m)throw new Error("No suitable MCV found for player country "+e.country);i=this.rules.getObject(m,s.ObjectType.Vehicle),i=this.createUnitForPlayer(i,e),this.spawnObject(i,r);let f=h.StartingUnitsGenerator.generate(this.gameOpts.unitCount,[...this.rules.vehicleRules.keys()],t,e.country);var n,a,l;this.gameModeType===v.GameModeType.Unholy&&f.push(...this.rules.general.baseUnit.filter((e=>e!==m)).map((e=>({name:e,type:s.ObjectType.Vehicle,count:1}))));let y=[],T=!1,b=new u.CardinalTileFinder(this.map.tiles,this.map.mapBounds,r,4,4,(e=>!this.map.getGroundObjectsOnTile(e).find((e=>!(e.isSmudge()||e.isOverlay()&&e.isTiberium())))&&0<this.map.terrain.getPassableSpeed(e,d.SpeedType.Foot,!1))),S=new Map,w=0;for({name:n,type:a,count:l}of f){let t=l;for(;0<t;){let i;if(T||(i=b.getNextTile(),i?y.push(i):T=!0),T&&y.length){var c=y[w];let e=S.get(c);e||(e=new u.CardinalTileFinder(this.map.tiles,this.map.mapBounds,c,1,0,(e=>!this.map.getGroundObjectsOnTile(e).find((e=>!(e.isSmudge()||e.isOverlay()&&e.isTiberium())))&&0<this.map.terrain.getPassableSpeed(e,d.SpeedType.Foot,!1))),S.set(c,e)),w=(w+1)%y.length,i=e.getNextTile()}if(i){var g,p=this.rules.getObject(n,a);if(a===s.ObjectType.Vehicle)c=this.createUnitForPlayer(p,e),this.applyInitialVeteran(c,e),this.spawnObject(c,i),t--;else{if(a!==s.ObjectType.Infantry)throw new Error("Should not reach this line");for(g of o.Infantry.SUB_CELLS.slice(0,t)){let r=this.createUnitForPlayer(p,e);r.position.subCell=g,this.applyInitialVeteran(r,e),this.spawnObject(r,i),t--}}}else t--}}}}applyInitialVeteran(e,t){e.veteranTrait&&(this.rules.general.veteran.initialVeteran?e.veteranTrait.setVeteranLevel(R.VeteranLevel.Elite):t.country.hasVeteranUnit(e.type,e.name)&&e.veteranTrait.setVeteranLevel(R.VeteranLevel.Veteran))}createObject(e,t){return this.objectFactory.create(e,t,this.rules,this.art)}createUnitForPlayer(e,t){if(![s.ObjectType.Aircraft,s.ObjectType.Vehicle,s.ObjectType.Infantry].includes(e.type))throw new Error(`Attempted to create an invalid unit type "${e.type}"`);let i=this.createObject(e.type,e.name);return this.changeObjectOwner(i,t),i.purchaseValue=this.sellTrait.computePurchaseValue(i.rules,t),i}createProjectile(e,t,i,r,n){let a=this.createObject(s.ObjectType.Projectile,e);return a.fromWeapon=i,a.fromObject=t,a.fromPlayer=t.owner,a.target=r,a.isShrapnel=n,a}createLooseProjectile(e,t,i){var r=this.rules.getWeapon(e),n=r.projectile,a=this.rules.getProjectile(n),o=this.rules.getWarhead(r.warhead);o={minRange:0,projectileRules:a,range:Number.POSITIVE_INFINITY,rules:r,speed:B.Weapon.computeSpeed(r,a),type:z.WeaponType.Primary,warhead:new K.Warhead(o)};let l=this.createObject(s.ObjectType.Projectile,n);return l.fromWeapon=o,l.fromObject=void 0,l.fromPlayer=t,l.target=i,l}createSuperWeapon(e,t,i=!1){var r=this.rules.getSuperWeapon(e);return new D.SuperWeapon(e,r,t,i)}createTarget(e,t){return new g.Target(e,t,this.map.tileOccupation)}isValidTarget(e){if(e){if(!e.isSpawned||e.isCrashing)return!1;if(!(e.rules.legalTarget||e.isBuilding()&&e.rules.hospital))return!1;if(e.isBuilding()&&e.rules.invisibleInGame)return!1}return!0}spawnObject(e,t){if(e.isTechno()&&e.limboData)throw new Error(`Object ${e.name}#${e.id} is in limbo. Use unlimboObject instead or clear limboData first`);this.doSpawnObject(e,t)}unspawnObject(e){e.isTechno()&&e.owner&&e.owner.removeOwnedObject(e),this.doUnspawnObject(e)}limboObject(e,t){e.limboData=t,this.doUnspawnObject(e)}unlimboObject(e,t,i=!1){var r=e.limboData;if(!r)throw new Error(`Object ${e.name}#${e.id} has no limboData attached`);e.limboData=void 0,this.doSpawnObject(e,t);let s=this.getUnitSelection();r.selected&&!i&&s.addToSelection(e),void 0!==r.controlGroup&&s.addUnitsToGroup(r.controlGroup,[e],!1)}doSpawnObject(e,t){var i,r;e.position.tile=t,e.isBuilding()&&(r=e.art.foundationCenter,i=t.rx+r.x,r=t.ry+r.y,e.centerTile=this.map.tiles.getByMapCoords(i,r)??this.map.tiles.getPlaceholderTile(i,r)),this.world.spawnObject(e),(e.cachedTraits.tick.length||e.isProjectile()||e.isDebris()||e.isTechno())&&this.updatableObjects.add(e),e.isTechno()&&this.map.technosByTile.add(e),e.isProjectile()||e.isDebris()||this.map.tileOccupation.occupyTileRange(t,e),e.art.canHideThings&&this.map.tileOcclusion.addOccluder(e),e.onSpawn(this),this.traits.filter(C.NotifySpawn).forEach((t=>{t[C.NotifySpawn.onSpawn](e,this)})),this.events.dispatch(new P.ObjectSpawnEvent(e))}doUnspawnObject(e){var t=e.tile;e.isProjectile()||e.isDebris()||this.map.tileOccupation.unoccupyTileRange(t,e),e.art.canHideThings&&this.map.tileOcclusion.removeOccluder(e),e.isTechno()&&(this.unitSelection.cleanupUnit(e),this.map.technosByTile.remove(e)),this.world.removeObject(e),this.updatableObjects.delete(e),e.onUnspawn(this),this.traits.filter(E.NotifyUnspawn).forEach((t=>{t[E.NotifyUnspawn.onUnspawn](e,this)})),this.events.dispatch(new A.ObjectUnspawnEvent(e))}destroyObject(e,t,i=!1,r=!1){if(e.isDestroyed)throw new Error(`Object with ID "${e.id}" is already destroyed`);if(e.isTechno()){let i=e.mindControllableTrait?.getOriginalOwner()??e.owner;!t||e.isBuilding()&&!i.isCombatant()||(t.player.addUnitsKilled(e.type,1),t.player===i||this.alliances.areAllied(t.player,i)||(t.player.score+=e.rules.points)),i.isNeutral||i.addUnitsLost(e.type,1)}if(e.isDestroyed=!0,e.healthTrait&&(e.healthTrait.health=0),e.onDestroy(this,t,i),this.traits.filter(w.NotifyDestroy).forEach((i=>{i[w.NotifyDestroy.onDestroy](e,this,t)})),t?.obj?.traits.filter(M.NotifyTargetDestroy).forEach((i=>{i[M.NotifyTargetDestroy.onDestroy](t.obj,e,t.weapon,this)})),this.events.dispatch(new y.ObjectDestroyEvent(e,t,r)),e.isBuilding()&&e.rules.leaveRubble&&e.deathType!==N.DeathType.Temporal){e.owner.removeOwnedObject(e),this.unitSelection.cleanupUnit(e);var s=this.map.tileOccupation.calculateTilesForGameObject(e.tile,e);this.map.terrain.invalidateTiles(s),e.art.canHideThings&&this.map.tileOcclusion.removeOccluder(e),this.updatableObjects.delete(e),e.onUnspawn(this),this.traits.filter(E.NotifyUnspawn).forEach((t=>{t[E.NotifyUnspawn.onUnspawn](e,this)})),this.events.dispatch(new A.ObjectUnspawnEvent(e))}else if(e.isSpawned)this.unspawnObject(e);else if(e.isTechno()&&e.owner){if(!e.limboData)throw new Error(`Object with ID "${e.id}" should be in limbo but has no limboData`);e.owner.removeOwnedObject(e)}e.dispose()}getObjectById(e){return this.world.getObjectById(e)}changeObjectOwner(e,t){const i=e.owner;i&&i.removeOwnedObject(e),t.addOwnedObject(e),i&&i!==t&&(this.traits.filter(x.NotifyOwnerChange).forEach((t=>{t[x.NotifyOwnerChange.onChange](e,i,this)})),e.onOwnerChange(i,this),this.events.dispatch(new O.ObjectOwnerChangeEvent(e,i)))}addObjectTrait(e,t){e.addTrait(t),this.traits.filter(q.NotifyObjectTraitAdd).forEach((i=>{i[q.NotifyObjectTraitAdd.onAdd](e,t,this)}))}onAllianceChange(e,t,i){this.events.dispatch(new F.AllianceChangeEvent(e,i?F.AllianceEventType.Formed:F.AllianceEventType.Broken,t)),this.traits.filter(_.NotifyAllianceChange).forEach((t=>{t[_.NotifyAllianceChange.onChange](e,i,this)}))}update(){if(this.status!==$.NotStarted){for(var e of(this.botManager.update(this),this.status!==$.Ended&&(void 0===this.lastGameEndCheck||1e3<=this.currentTime-this.lastGameEndCheck)&&(this.checkGameEndConditions(),this.lastGameEndCheck=this.currentTime),[...this.updatableObjects]))e.isSpawned&&e.update(this);if(this.playerList.getCombatants().forEach((e=>e.cheerCooldownTicks=Math.max(0,e.cheerCooldownTicks-1))),this.traits.filter(S.NotifyTick).forEach((e=>{e[S.NotifyTick.onTick](this)})),this.localPlayer&&!this.localPlayer.isObserver&&!this.localPlayer.defeated){var t=this.unitSelection.getSelectedUnits();if(1===t.length){let e=t[0];if(e.isTechno()&&e.owner!==this.localPlayer){let t=this.mapShroudTrait.getPlayerShroud(this.localPlayer);this.map.tileOccupation.calculateTilesForGameObject(e.tile,e).find((i=>!t.isShrouded(i,e.tileElevation)))||(this.unitSelection.deselectAll(),this.unitSelection.cleanupUnit(e))}}}for(var i of this.afterTickCallbacks)i();this.afterTickCallbacks.length=0,this.triggers.update(this),this.countdownTimer.update(this),this.currentTick++,this.currentTime+=1e3/j.GameSpeed.BASE_TICKS_PER_SECOND}}afterTick(e){this.afterTickCallbacks.push(e)}checkGameEndConditions(){this.updateDefeatedPlayers(this.playerList.getCombatants()),(this.localPlayer?.defeated&&!this.localPlayer.isObserver||!this.alliances.getHostilePlayers().length&&1<this.gameOpts.humanPlayers.length+this.gameOpts.aiPlayers.length)&&this.end()}end(){this.status!==$.Ended&&(this.status=$.Ended,this._onEnd.dispatch(this,void 0))}updateDefeatedPlayers(e){let t=this.stalemateDetectTrait?.isStale()&&0===this.stalemateDetectTrait.getCountdownTicks(),i=this.gameOpts.shortGame;e.forEach((e=>{let r;if(t)r=!0;else{let t;t=i?(t=[...e.getOwnedObjectsByType(s.ObjectType.Building,!0)].some((e=>!e.rules.insignificant)),t||e.getOwnedObjects(!0).some((e=>this.rules.general.baseUnit.includes(e.name)))):e.getOwnedObjects(!0).some((e=>!e.rules.insignificant&&!e.limboData?.inTransport)),r=!t}r&&(e.defeated=!0,this.removeAllPlayerAssets(e),this.events.dispatch(new T.PlayerDefeatedEvent(e)))}))}removeAllPlayerAssets(e){e.getOwnedObjects().forEach((e=>{e.isDestroyed||this.destroyObject(e,void 0,!0)})),e.getOwnedObjects(!0).forEach((e=>{e.isDestroyed||(e.limboData?.inTransport?this.changeObjectOwner(e,this.getCivilianPlayer()):this.destroyObject(e,void 0,!0))}))}generateRandomInt(e,t){return this.prng.generateRandomInt(e,t)}generateRandom(){return this.prng.generateRandom()}getHash(){return m.fnv32a([...new Uint8Array(new Float64Array([this.prng.getLastRandom()]).buffer),this.nextObjectId.value,...this.world.getAllObjects().map((e=>e.getHash())),...this.playerList.getAll().map((e=>e.getHash())),this.alliances.getHash(),...this.traits.getAll().map((e=>e.getHash?.()??0))])}debugGetState(){return{currentTick:this.currentTick,lastRandom:this.prng.getLastRandom(),nextObjectId:this.nextObjectId.value,objects:this.world.getAllObjects().map((e=>e.debugGetState())),players:this.playerList.getAll().map((e=>e.debugGetState())),alliances:this.alliances.debugGetState(),traits:this.traits.getAll().reduce(((e,t)=>{var i=t.debugGetState?.();return void 0!==i&&(e[t.constructor.name]=i),e}),{})}}dispose(){this.world.getAllObjects().forEach((e=>e.dispose())),this.playerList.getAll().forEach((e=>e.dispose())),this.constructionWorkers.forEach((e=>e.dispose())),this.botManager.dispose(),this.triggers.dispose(),this.map.dispose(),this.traits.dispose()}})}}})),System.register("game/gameobject/trait/interface/NotifyDamage",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){(i=i||{}).onDamage=Symbol(),e("NotifyDamage",i)}}})),System.register("game/gameobject/trait/WallTrait",["game/gameobject/trait/interface/NotifyDamage","game/type/LandType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{constructor(){this.linkedDamageHandled=!1}[i.NotifyDamage.onDamage](e,t,i,s){if(!this.linkedDamageHandled){var n=Math.floor(i/2);if(n)for(var a of t.map.tiles.getAllNeighbourTiles(e.tile))if(a.landType===r.LandType.Wall){let e=t.map.getObjectsOnTile(a).find((e=>(e.isBuilding()||e.isOverlay())&&e.wallTrait));e.wallTrait.linkedDamageHandled=!0,e.healthTrait.inflictDamage(n,s,t),e.wallTrait.linkedDamageHandled=!1,e.healthTrait.health||t.destroyObject(e,s)}}}},e("WallTrait",s)}}})),System.register("game/gameobject/Overlay",["engine/type/ObjectType","game/gameobject/GameObject","game/map/BridgeOverlayTypes","game/map/OreOverlayTypes","engine/type/OverlayTibType","game/gameobject/trait/WallTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends r.GameObject{constructor(e,t,r){super(i.ObjectType.Overlay,e,t,r),this.radarInvisible=this.rules.radarInvisible}static factory(e,t,i){let r=new this(e,t,i);return t.wall&&(r.wallTrait=new o.WallTrait,r.traits.add(r.wallTrait)),r}isTiberium(){return n.OreOverlayTypes.getOverlayTibType(this.overlayId)!==a.OverlayTibType.NotSpecial}isBridge(){return s.BridgeOverlayTypes.isBridge(this.overlayId)}isXBridge(){return s.BridgeOverlayTypes.isXBridge(this.overlayId)}isHighBridge(){return s.BridgeOverlayTypes.isHighBridge(this.overlayId)}isLowBridge(){return s.BridgeOverlayTypes.isLowBridge(this.overlayId)}isBridgePlaceholder(){return s.BridgeOverlayTypes.isBridgePlaceholder(this.overlayId)}getFoundation(){let e={width:1,height:1};return this.isBridge()&&(this.isXBridge()?e.height+=2:e.width+=2),e}},e("Overlay",l)}}})),System.register("game/map/Terrain",["game/map/TileCollection","game/type/SpeedType","ngraph.graph","ngraph.path","util/typeGuard","game/map/tileFinder/RadialTileFinder","util/geometry","game/type/LandType","game/rules/TerrainRules"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("Terrain",class{constructor(e,t,i,s,n){this.tiles=e,this.theaterType=t,this.mapBounds=i,this.tileOccupation=s,this.rules=n,this.passabilityGraphs=new Map,this.invalidatedTiles=new Map,this.handleTileOccupationUpdate=({tiles:e,object:t})=>{var i=e.filter((e=>{let i=r.SpeedType.Foot;return t.isTerrain()&&t.rules.getOccupationBits(this.theaterType)!==h.OccupationBits.All&&(i=r.SpeedType.Wheel),t.isOverlay()&&(t.isBridge()||t.isTiberium())||this.isBlockerObject(t,e,!1,i)||this.isBlockerObject(t,e,!0,i)||t.isBuilding()&&t.rules.leaveRubble}));i.length&&this.invalidateTiles(i)},this.handleMapBoundsResize=()=>{this.passabilityGraphs.clear()},s.onChange.subscribe(this.handleTileOccupationUpdate),i.onLocalResize.subscribe(this.handleMapBoundsResize)}invalidateTiles(e){e.length&&[...this.passabilityGraphs.keys()].forEach((t=>{let i=this.invalidatedTiles.get(t);i?e.forEach((e=>i.add(e))):this.invalidatedTiles.set(t,new Set(e))}))}computePath(e,t,i,r,s,{maxExpandedNodes:a=Number.POSITIVE_INFINITY,bestEffort:l=!0,excludeTiles:c,ignoredBlockers:h=[]}={}){let u=this.computePassabilityGraph(e);var d=h.map((e=>this.tileOccupation.calculateTilesForGameObject(e.tile,e))).reduce(((e,t)=>e.concat(t)),[]);if(d.length&&this.updatePassability(d,e,u,h),!this.getPassableSpeed(t,e,i,h))return d.length&&this.updatePassability(d,e,u),[];var g,p=this.getNodeId(r,s),m=!!u.hasNode(p);m||((g=new o.RadialTileFinder(this.tiles,this.mapBounds,r,{width:1,height:1},1,5,(t=>0<this.getPassableSpeed(t,e,!1)&&Math.abs(t.z-r.z)<2&&!c?.({tile:t,onBridge:void 0,speed:100}))).getNextTile())?(r=g,s=!1):(u.addNode(p,{tile:r,onBridge:void 0,speed:100}),a=Math.min(a,500)));let f=n.aStar(u,{bestEffort:l,maxExpandedNodes:a,distance(e,t){if(c?.(t.data)||!t.data.speed)return Number.POSITIVE_INFINITY;var i=Math.abs(e.data.tile.rx-t.data.tile.rx),r=Math.abs(e.data.tile.ry-t.data.tile.ry);return i+r+(Math.SQRT2-2)*Math.min(i,r)},heuristic(e,t,i){if(c?.(t.data)||!t.data.speed)return Number.POSITIVE_INFINITY;var r=Math.abs(e.data.tile.rx-t.data.tile.rx),s=Math.abs(e.data.tile.ry-t.data.tile.ry);let n=r+s+(Math.SQRT2-2)*Math.min(r,s);return i?.parent&&(s=(r=i.parent.node).data.tile.rx-e.data.tile.rx,r=r.data.tile.ry-e.data.tile.ry,i.dirX=s,i.dirY=r,s===i.parent.dirX&&r===i.parent.dirY||(n+=.2)),n}}),y=f.find(this.getNodeId(t,i),this.getNodeId(r,s)).map((e=>({tile:e.data.tile,onBridge:e.data.onBridge})));return(y.length<2||c&&y.length&&(!l&&y[0].tile!==r||y[y.length-1].tile!==t))&&(y=[]),!m&&u.hasNode(p)&&u.removeNode(p),d.length&&this.updatePassability(d,e,u),y}computeAllPassabilityGraphs(){Object.keys(r.SpeedType).forEach((e=>{var t=Number(e);isNaN(t)||t===r.SpeedType.Winged||this.computePassabilityGraph(t)}))}computePassabilityGraph(e){let t=this.passabilityGraphs.get(e);if(t){let i=this.invalidatedTiles.get(e);i?.size&&(this.updatePassability([...i],e,t),i.clear())}else t=s.default({multigraph:!0}),this.passabilityGraphs.set(e,t),this.tiles.forEach((i=>{this.computePassability(i,e,t)}));return t}updatePassability(e,t,r,s=[]){let n=new Set;e.forEach((e=>{[e,this.tiles.getNeighbourTile(e,i.TileDirection.Right),this.tiles.getNeighbourTile(e,i.TileDirection.BottomRight),this.tiles.getNeighbourTile(e,i.TileDirection.Bottom),this.tiles.getNeighbourTile(e,i.TileDirection.BottomLeft)].filter(a.isNotNullOrUndefined).forEach((e=>n.add(e)))})),e.forEach((e=>{r.removeNode(this.getNodeId(e,!1)),r.removeNode(this.getNodeId(e,!0))})),n.forEach((e=>{this.computePassability(e,t,r,s)}))}computePassability(e,t,r,s=[]){var n=[i.TileDirection.Left,i.TileDirection.TopLeft,i.TileDirection.Top,i.TileDirection.TopRight];let a=this.getPassableSpeed(e,t,!1,s);if(a){var o,l=this.getNodeId(e,!1);for(o of(r.hasNode(l)||r.addNode(l,{speed:a,tile:e,onBridge:void 0}),n))this.connectTiles(e,void 0,o,t,r,s)}var c=this.tileOccupation.getBridgeOnTile(e);if(c&&(a=this.getPassableSpeed(e,t,!0,s),a)){var h;l=this.getNodeId(e,!0);for(h of(r.hasNode(l)||r.addNode(l,{speed:a,tile:e,onBridge:c}),n))this.connectTiles(e,c,h,t,r,s)}}connectTiles(e,t,i,r,s,n=[]){var a=this.tiles.getNeighbourTile(e,i);if(a){let i=this.tileOccupation.getBridgeOnTile(a);var o=t||i?0:1;if(Math.abs(e.z+(t?.tileElevation??0)-(a.z+(i?.tileElevation??0)))>o){if(!i?.isHighBridge()&&!t?.isHighBridge()||0!==Math.abs(e.z-a.z)||!s.hasNode(this.getNodeId(e,!1)))return;t=i=void 0}var l=this.getPassableSpeed(a,r,!!i,n);l&&(o=this.getNodeId(a,!!i),s.hasNode(o)||s.addNode(o,{speed:l,tile:a,onBridge:i}),a=this.getNodeId(e,!!t),s.getLink(a,o)||s.addLink(a,o))}}getNodeId(e,t){return e.id+(t?"_bridge":"")}getPassableSpeed(e,t,i,s=[],n=!1){if(!this.mapBounds.isWithinBounds(e))return 0;let a=i?e.onBridgeLandType:e.landType;if(void 0===a)return 0;a===c.LandType.Wall&&t===r.SpeedType.Track&&(a=c.getLandType(e.terrainType));var o,l=this.rules.getLandRules(a).getSpeedModifier(t);if(!l)return 0;if(!n)for(o of this.tileOccupation.getObjectsOnTile(e))if(this.isBlockerObject(o,e,i,t)&&!s.includes(o))return 0;return l}isBlockerObject(e,t,i,s){if(e.isTerrain()&&s===r.SpeedType.Foot&&e.rules.getOccupationBits(this.theaterType)!==h.OccupationBits.All)return!1;if(e.isBuilding()){if(e.rules.invisibleInGame)return!1;if(e.isDestroyed&&e.rules.leaveRubble)return!1;if(e.rules.gate)return!1;var n=e.art.foundation;let i=e.rules.numberImpassableRows;return s===r.SpeedType.Foot?i=n.width:e.rules.weaponsFactory&&!i&&(i=n.width-1),n={x:e.tile.rx,y:e.tile.ry,width:(i||n.width)-1,height:n.height-1},l.rectContainsPoint(n,{x:t.rx,y:t.ry})}return!(e.isAircraft()||e.isInfantry()||e.isVehicle()||e.isSmudge()||e.isOverlay()&&(i&&e.isBridge()||!i&&e.isHighBridge()||e.isTiberium()||e.rules.crate||e.isBridgePlaceholder())||s===r.SpeedType.Track&&e.rules.crushable)}findObstacles(e,t){var i,s,n=t.rules.speedType;let a=[];for(i of this.tileOccupation.getGroundObjectsOnTile(e.tile))i!==t&&((s=this.isBlockerObject(i,e.tile,!!e.onBridge,n))||i.isUnit()&&(i.tile===e.tile&&i.onBridge===!!e.onBridge||i.moveTrait.reservedPathNodes.find((t=>t.tile===e.tile&&!!t.onBridge==!!e.onBridge)))||n===r.SpeedType.Track&&i.rules.crushable||n===r.SpeedType.Foot&&i.isTerrain()||i.isBuilding()&&i.rules.gate)&&(s={obj:i,static:s},i.isInfantry()&&t.isInfantry()?i.position.desiredSubCell===t.position.desiredSubCell&&a.push(s):i.isTerrain()&&t.isInfantry()&&!i.rules.getOccupiedSubCells(this.theaterType).includes(t.position.desiredSubCell)||a.push(s));return a}dispose(){this.tileOccupation.onChange.unsubscribe(this.handleTileOccupationUpdate),this.mapBounds.onLocalResize.unsubscribe(this.handleMapBoundsResize)}})}}})),System.register("game/gameobject/task/system/TargetLinesConfig",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("cloneConfig",(e=>e?{...e}:void 0)),e("configsAreEqual",((e,t)=>!e&&!t||e?.isAttack===t?.isAttack&&e?.pathNodes===t?.pathNodes&&e?.target===t?.target)),e("configHasTarget",(e=>!(!e?.pathNodes.length&&!e?.target)))}}})),System.register("game/gameobject/task/system/Task",["game/gameobject/task/system/TaskStatus"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Task",class{constructor(){this.status=i.TaskStatus.NotStarted,this.children=[],this.cancellable=!0,this.useChildTargetLines=!1,this.blocking=!0,this.waitingForChildrenToFinish=!1,this.preventOpportunityFire=!0,this.preventLanding=!0}isRunning(){return this.status===i.TaskStatus.Running}isCancelling(){return this.status===i.TaskStatus.Cancelling}setCancellable(e){return this.cancellable=e,this}onStart(e){}onEnd(e){}cancel(){if(this.cancellable)if(this.status===i.TaskStatus.Running)this.status=i.TaskStatus.Cancelling,this.children.length&&this.children.forEach((e=>e.cancel()));else if(this.status===i.TaskStatus.NotStarted&&(this.status=i.TaskStatus.Cancelled,this.children.length))throw new Error("Should't have any children before starting a task")}getTargetLinesConfig(e){}})}}})),System.register("game/order/Order",["gui/PointerType","game/order/OrderFeedbackType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Order",class{constructor(e){this.orderType=e,this.targetOptional=!0,this.minimapAllowed=!0,this.singleSelectionRequired=!1,this.terminal=!1,this.feedbackType=r.OrderFeedbackType.None}getPointerType(e,t){return e?i.PointerType.Mini:i.PointerType.Default}set(e,t){return this.sourceObject=e,this.target=t,this}isValid(){return!0}isAllowed(){return!0}onAdd(e,t){return!0}})}}})),System.register("game/gameobject/trait/UnitOrderTrait",["game/gameobject/task/system/TaskRunner","game/gameobject/task/system/TaskStatus","game/gameobject/trait/interface/NotifyTick","game/gameobject/task/system/WaitTicksTask","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/task/system/CallbackTask","game/gameobject/trait/interface/NotifyTeleport","game/gameobject/trait/interface/NotifyOrder"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class{constructor(e){this.gameObject=e,this.orders=[],this.queuedOrders=new Set,this.tasks=[],this.taskRunner=new i.TaskRunner}[s.NotifyTick.onTick](e,t){if(e.isSpawned){var i=this.hasTasks(),r=this.tasks.find((e=>!e.isCancelling()));i&&this.taskRunner.tick(this.tasks,e);var s,a=this.orders.length;if(a&&(!i||!r)){let t,r=!1;for(;(t=this.orders[0])&&(t.isValid()&&t.isAllowed()&&((s=t.process())&&(this.queuedOrders.has(t)&&(this.tasks.push(new n.WaitTicksTask(5)),this.tasks.push(new o.CallbackTask((()=>{e.resetGuardModeToIdle()})))),this.tasks.push(...s),i||this.taskRunner.tick(this.tasks,e)),r=!0),this.orders.shift(),this.queuedOrders.delete(t),this.waypointPath&&(this.currentWaypoint?(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.currentWaypoint=this.currentWaypoint?.next):this.currentWaypoint=this.waypointPath.waypoints[0],this.currentWaypoint||this.cleanupWaypointPath()),!r););}!a&&!i&&this.waypointPath&&this.currentWaypoint&&(this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath());let t=r;for(;t?.useChildTargetLines;){var l=t.children.find((e=>!e.isCancelling()));if(!l)break;t=l}this.targetLinesTask!==t&&(this.targetLinesTask=t,this.targetLinesConfig=t?.getTargetLinesConfig(this.gameObject))}}[a.NotifyOwnerChange.onChange](){this.clearOrders(),this.cancelAllTasks()}[l.NotifyTeleport.onBeforeTeleport](e,t,i,r){i&&!r&&(this.clearOrders(),this.tasks.length=0)}addOrder(e,t=!1){!1!==e.onAdd(this.tasks,t)?(t||(this.clearOrders(),this.tasks=this.tasks.filter((e=>e.status!==r.TaskStatus.NotStarted)),this.tasks.forEach((e=>e.cancel()))),this.orders.push(e),t&&this.queuedOrders.add(e),this.gameObject.traits.filter(c.NotifyOrder).forEach((t=>{t[c.NotifyOrder.onPush](this.gameObject,e.orderType)}))):this.targetLinesTask=void 0}clearOrders(){this.orders.length=0,this.queuedOrders.clear(),this.currentWaypoint&&this.waypointPath&&this.cleanupWaypoint(this.currentWaypoint,this.waypointPath),this.cleanupWaypointPath(),this.gameObject.resetGuardModeToIdle()}unmarkNextQueuedOrder(){this.orders.length&&this.queuedOrders.delete(this.orders[0])}hasTasks(){return!!this.tasks.length}isIdle(){return!this.orders.length&&!this.tasks.length}getCurrentTask(){return this.tasks[0]}cancelAllTasks(){this.tasks.forEach((e=>e.cancel()))}addTask(e){this.tasks.push(e)}addTasks(...e){e.forEach((e=>this.addTask(e)))}addTaskToFront(e){this.tasks.unshift(e)}addTaskNext(e){this.tasks.splice(1,0,e)}getTasks(){return[...this.tasks]}dispose(){this.clearOrders(),this.tasks.length=0,this.gameObject=void 0}cleanupWaypointPath(){this.waypointPath&&(this.waypointPath.units.splice(this.waypointPath.units.indexOf(this.gameObject),1),this.waypointPath.units.length||(this.waypointPath.waypoints.forEach((e=>e.next=void 0)),this.waypointPath.waypoints.length=0),this.waypointPath=void 0),this.currentWaypoint=void 0}cleanupWaypoint(e,t){if(!t.units.find((t=>t!==this.gameObject&&(t.unitOrderTrait.currentWaypoint??t.unitOrderTrait.waypointPath?.waypoints[0])===e))&&!t.waypoints.find((t=>t.next===e))){var i=t.waypoints.indexOf(e);if(-1===i)throw new Error("Given waypoint not found in waypoint path");t.waypoints.splice(i,1)}}},e("UnitOrderTrait",h)}}})),System.register("game/gameobject/Techno",["game/gameobject/GameObject","game/rules/TechnoRules","game/gameobject/unit/VeteranLevel","game/gameobject/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends i.GameObject{constructor(e,t,i,r){super(e,t,i,r),this.explodes=this.rules.explodes,this.radarInvisible=this.rules.radarInvisible,this.c4=this.rules.c4,this.crusher=this.rules.crusher,this.defaultToGuardArea=this.rules.defaultToGuardArea,this.guardMode=this.rules.defaultToGuardArea,this.purchaseValue=this.rules.cost}get primaryWeapon(){return this.armedTrait?.primaryWeapon}get secondaryWeapon(){return this.armedTrait?.secondaryWeapon}get ammo(){return this.ammoTrait?.ammo}get sight(){return Math.min(r.TechnoRules.MAX_SIGHT,this.rules.sight*(this.veteranTrait?.getVeteranSightMultiplier()??1))}get veteranLevel(){return this.veteranTrait?.veteranLevel??s.VeteranLevel.None}resetGuardModeToIdle(){this.guardMode=this.defaultToGuardArea,this.guardArea=void 0}update(e){if(this.warpedOutTrait.isActive())for(var t of this.cachedTraits.tick)t.ticksWhenWarpedOut&&t[n.NotifyTick.onTick](this,e);else super.update(e)}isTechno(){return!0}},e("Techno",a)}}})),System.register("game/event/CratePickupEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("CratePickupEvent",class{constructor(e,t,r,s){this.target=e,this.player=t,this.source=r,this.tile=s,this.type=i.EventType.CratePickup}})}}})),System.register("game/trait/CrateGeneratorTrait",["engine/type/ObjectType","engine/type/TerrainType","game/event/CratePickupEvent","game/gameobject/unit/RangeHelper","game/gameobject/unit/ZoneType","game/gameopts/constants","game/GameSpeed","game/map/tileFinder/RadialTileFinder","game/type/PowerupType","game/type/SpeedType","game/trait/interface/NotifyTick","game/type/SuperWeaponType","game/trait/SuperWeaponsTrait","game/gameobject/trait/CloakableTrait","game/Warhead","game/gameobject/unit/CollisionType","game/map/tileFinder/RandomTileFinder","game/map/OreSpread","engine/type/OverlayTibType","game/gameobject/trait/TiberiumTrait","game/math/Vector2","game/math/Box2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){e("UNSUPPORTED_POWERUP_TYPES",[h.PowerupType.IonStorm,h.PowerupType.Gas,h.PowerupType.Pod,h.PowerupType.Squad]),E=class{constructor(e){this.randomCrateSpawn=e,this.crates=[],this.availEdgeTiles=[],this.allTiles=[]}init(e){var t=e.map.tiles.getMapSize();let i=e.map.tiles,r=[],s=0;for(let o=0;o<t.width;++o){let c,h,u=!1,d=!1;for(let r=0;r<t.height;++r){var n=i.getByMapCoords(o,r);if(n&&this.canPlaceCrateOnTile(e,n)){var l=e.map.getTileZone(n)===a.ZoneType.Water;c?(l||(h=n),d=l):l?u=d=!0:c=h=n}else if(c&&!n)break}c&&(r.push(c),h&&h!==c&&r.push(h),u||d||s++)}this.availEdgeTiles=r,this.allTiles=i.getAll(),this.mapEdgeIsWater=0===s,this.minCrates=e.rules.crateRules.crateMinimum*e.gameOpts.humanPlayers.filter((e=>e.countryId!==o.OBS_COUNTRY_ID)).length}[d.NotifyTick.onTick](e){for(var t of this.crates)t.ticksLeft--,t.ticksLeft<=0&&(e.unspawnObject(t.obj),t.obj.dispose());if(this.crates=this.crates.filter((e=>0<e.ticksLeft)),this.randomCrateSpawn)for(let t=0;t<this.minCrates-this.crates.length&&this.spawnCrateAtRandom(this.allTiles,e);t++);}spawnCrateAtRandom(e,t){var i=this.chooseSpawnTile(e,t);if(i)return this.spawnRandomCrateAt(i,t)}spawnRandomCrateAt(e,t){if(this.canPlaceCrateOnTile(t,e)){var i=t.map.getTileZone(e,!0)===a.ZoneType.Water;if(i=this.choosePowerup(i,t.rules.powerups.powerups,t))return this.spawnCrateAt(e,i,t)}}spawnCrateAt(e,t,r){if(this.canPlaceCrateOnTile(r,e)){var s=r.map.getTileZone(e,!0)===a.ZoneType.Water,n=r.rules.crateRules;s=s?n.waterCrateImg:n.crateImg;let o=r.createObject(i.ObjectType.Overlay,s);return o.overlayId=r.rules.getOverlayId(s),o.value=0,r.spawnObject(o,e),n=60*n.crateRegen*l.GameSpeed.BASE_TICKS_PER_SECOND*(.5+1.5*r.generateRandom()),this.crates.push({obj:o,powerup:t,ticksLeft:n}),o}}chooseSpawnTile(e,t){return t.generateRandom()<(this.mapEdgeIsWater?1/3:2/3)&&this.availEdgeTiles.length&&(e=this.availEdgeTiles),this.chooseRandomTile(e,t)}chooseRandomTile(e,t){let i,r=0;for(;i=e[t.generateRandomInt(0,e.length-1)],r++,r<100&&!this.canPlaceCrateOnTile(t,i););if(100<=r){var s=t.map.tileOccupation.getEmptyTiles();if(!s.length)return;i=s[t.generateRandomInt(0,s.length-1)]}return i}canPlaceCrateOnTile(e,t){return e.map.mapBounds.isWithinBounds(t)&&!e.map.getGroundObjectsOnTile(t).length&&0<e.map.terrain.getPassableSpeed(t,u.SpeedType.Amphibious,!1)&&t.terrainType!==r.TerrainType.Shore&&0===t.rampType}choosePowerup(e,t,i){if((t=e?t.filter((e=>e.waterAllowed)):t).length){var r,s=t.reduce(((e,t)=>e+t.probShares),0),n=i.generateRandomInt(0,s);let e=0;for(r of t)if(e+=r.probShares,n<e)return r}}peekInsideCrate(e){return this.crates.find((t=>t.obj===e))?.powerup.type}pickupCrate(e,t,i){let r=this.crates.find((e=>e.obj===t));if(r){this.crates.splice(this.crates.indexOf(r),1),i.unspawnObject(r.obj),r.obj.dispose();let t=this.grantPowerup(e,r.powerup,r.obj.tile,i);var n;return void 0!==t&&(e.owner.cratesPickedUp++,n=i.rules.powerups.powerups.find((e=>e.type===t)),i.events.dispatch(new s.CratePickupEvent(n,e.owner,e,r.obj.tile))),this.randomCrateSpawn&&this.spawnCrateAtRandom(this.allTiles,i),t}}grantPowerup(e,t,r,s){let n=e.owner,a=!1;if(n.isCombatant()){if(t.type===h.PowerupType.Unit){let e;if(![...n.buildings].some((e=>e.rules.constructionYard))&&s.rules.crateRules.freeMCV){let t=s.rules.general.baseUnit;if(!n.getOwnedObjects(!0).some((e=>t.includes(e.name)))&&n.credits>=[...s.rules.ai.buildPower,...s.rules.ai.buildRefinery].map((e=>s.rules.getBuilding(e))).filter((e=>e.aiBasePlanningSide===n.country.side)).reduce(((e,t)=>e+t.cost),0)){var o=t.find((e=>{let t=s.rules.getObject(e,i.ObjectType.Vehicle);return t.isAvailableTo(n.country)&&t.hasOwner(n.country)}));if(!o)throw new Error("No suitable MCV found for player country "+n.country);e=s.rules.getObject(o,i.ObjectType.Vehicle)}}if(e||(o=(o=s.rules.crateRules.unitCrateType)?s.rules.hasObject(o,i.ObjectType.Vehicle)?[s.rules.getObject(o,i.ObjectType.Vehicle)]:[]:[...s.rules.vehicleRules.values()].filter((e=>e.crateGoodie&&0<s.map.terrain.getPassableSpeed(r,e.speedType,!1)))).length&&(e=o[s.generateRandomInt(0,o.length-1)]),e){let t=s.createUnitForPlayer(e,n);var l=new c.RadialTileFinder(s.map.tiles,s.map.mapBounds,r,{width:1,height:1},0,3,(e=>0<s.map.terrain.getPassableSpeed(e,t.rules.speedType,!1)&&!s.map.terrain.findObstacles({tile:e,onBridge:void 0},t).length)).getNextTile();l?(s.spawnObject(t,l),a=!0):(n.removeOwnedObject(t),t.dispose())}}else if(t.type===h.PowerupType.Money){if(!t.data)throw new Error("Money powerup missing data field");n.credits=Math.max(0,n.credits+Math.floor(Number(t.data)*(.55+2*s.generateRandom()*.45))),a=!0}else if(t.type===h.PowerupType.HealBase){var u;for(u of n.getOwnedObjects(!0))u.isDestroyed||u.healthTrait.healToFull(void 0,s);a=!0}else if(t.type===h.PowerupType.Reveal)s.mapShroudTrait.revealMap(n,s),a=!0;else if(t.type===h.PowerupType.Darkness)s.mapShroudTrait.resetShroud(n,s),a=!0;else if(t.type===h.PowerupType.Veteran){if(e.veteranTrait&&!e.veteranTrait.isMaxLevel()){a=!0;var d,w=Number(t.data);for(d of this.getUnitsInCrateRadius(s,r,n))d.veteranTrait?.promote(w,s)}}else if(t.type===h.PowerupType.Armor){if(1===e.crateBonuses.armor){a=!0;var C,E=Number(t.data);for(C of this.getUnitsInCrateRadius(s,r,n))1===C.crateBonuses.armor&&(C.crateBonuses.armor=E)}}else if(t.type===h.PowerupType.Firepower){if(1===e.crateBonuses.firepower){a=!0;var x,O=Number(t.data);for(x of this.getUnitsInCrateRadius(s,r,n))1===x.crateBonuses.firepower&&(x.crateBonuses.firepower=O)}}else if(t.type===h.PowerupType.Speed){if(1===e.crateBonuses.speed){a=!0;var A,M=Number(t.data);for(A of this.getUnitsInCrateRadius(s,r,n))1===A.crateBonuses.speed&&(A.crateBonuses.speed=M)}}else if(t.type===h.PowerupType.Cloak){if(!e.cloakableTrait)for(var R of(a=!0,this.getUnitsInCrateRadius(s,r,n)))R.cloakableTrait||(R.cloakableTrait=new m.CloakableTrait(R,s.rules.general.cloakDelay),s.addObjectTrait(R,R.cloakableTrait))}else if(t.type===h.PowerupType.ICBM){if(l=[...s.rules.superWeaponRules.values()].find((e=>e.type===g.SuperWeaponType.MultiMissile)),l&&n.superWeaponsTrait&&!n.superWeaponsTrait.has(l.name)){let e=s.createSuperWeapon(l.name,n,!0);e.isGift=!0,n.superWeaponsTrait.add(e),a=!0}}else if(t.type===h.PowerupType.Invulnerability){var P=[...s.rules.superWeaponRules.values()].find((e=>e.type===g.SuperWeaponType.IronCurtain));P&&(s.traits.get(p.SuperWeaponsTrait).activateEffect(P,n,s,r,void 0,!0),a=!0)}else if(t.type===h.PowerupType.Explosion||t.type===h.PowerupType.Napalm){a=!0;var I=Number(t.data);P=t.type===h.PowerupType.Napalm?s.rules.combatDamage.flameDamage:s.rules.combatDamage.c4Warhead;new f.Warhead(s.rules.getWarhead(P)).detonate(s,I,e.tile,e.tileElevation,e.position.worldPosition,e.zone,y.CollisionType.None,s.createTarget(e,e.tile),{player:e.owner,weapon:void 0},!1,!1,void 0,0)}else{if(t.type!==h.PowerupType.Tiberium)return void console.warn(`Unhandled powerup type "${h.PowerupType[t.type]}"`);{let e,t=new T.RandomTileFinder(s.map.tiles,s.map.mapBounds,r,2,s,(e=>S.TiberiumTrait.canBePlacedOn(e,s.map))),n=0;for(;n++<6&&(e=t.getNextTile());){var k=v.OreSpread.calculateOverlayId(b.OverlayTibType.Ore,e);if(void 0===k)throw new Error("Expected an overlayId");let t=s.createObject(i.ObjectType.Overlay,s.rules.getOverlayName(k));t.overlayId=k,t.value=3,s.spawnObject(t,e),a=!0}}}return a?t.type:(I=s.rules.powerups.powerups.find((e=>e.type===h.PowerupType.Money&&0<e.probShares)),I?this.grantPowerup(e,I,r,s):void 0)}}getUnitsInCrateRadius(e,t,i){let r=e.rules.crateRules.crateRadius,s=new n.RangeHelper(e.map.tileOccupation);return e.map.technosByTile.queryRange((new C.Box2).setFromCenterAndSize(new w.Vector2(t.rx,t.ry),new w.Vector2(r,r))).filter((e=>e.owner===i&&e.isUnit()&&s.tileDistance(e,t)<=r))}},e("CrateGeneratorTrait",E)}}})),System.register("game/rules/PowerupsRules",["game/trait/CrateGeneratorTrait","game/type/PowerupType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("PowerupsRules",class{constructor(){this.powerups=[]}readIni(e){for(var[t,s]of e.entries){let[e,a,o,l]=s.split(",");var s,n=Number(e);void 0!==(s=r.PowerupType[t])?i.UNSUPPORTED_POWERUP_TYPES.includes(s)||this.powerups.push({type:s,probShares:n,animName:"<none>"!==a.toLowerCase()?a:void 0,waterAllowed:"yes"===o,data:l}):console.warn(`Unknown powerup "${t}". Skipping.`)}return this}})}}})),System.register("game/rules/mpAllowedColors",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("mpAllowedColors",["Gold","DarkRed","DarkBlue","DarkGreen","Orange","DarkSky","Purple","Magenta"])}}})),System.register("game/rules/Rules",["util/Color","engine/type/ObjectType","game/rules/CountryRules","game/rules/WeaponRules","game/rules/AudioVisualRules","game/rules/GeneralRules","game/rules/MpDialogSettings","game/type/LandType","game/rules/LandRules","game/rules/WarheadRules","game/rules/ProjectileRules","game/rules/ObjectRulesFactory","game/rules/CombatDamageRules","game/rules/TiberiumRules","game/rules/AiRules","game/rules/ElevationModelRules","game/rules/RadiationRules","game/rules/SuperWeaponRules","game/rules/CrateRules","game/rules/PowerupsRules","game/rules/mpAllowedColors","util/typeGuard","game/Weapon"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e}],execute:function(){e("Rules",class{constructor(e,t){this.ini=e,this.logger=t,this.buildingTypes=new Map,this.vehicleTypes=new Map,this.infantryTypes=new Map,this.aircraftTypes=new Map,this.terrainTypes=new Map,this.overlayTypes=new Map,this.overlayIdsByType=new Map,this.animationTypes=new Map,this.animationNames=new Set,this.voxelAnimTypes=new Map,this.smudgeTypes=new Map,this.warheadTypes=new Map,this.tiberiumTypes=new Map,this.superWeaponTypes=new Map,this.countryTypes=new Map,this.weaponTypes=new Map,this.allObjectRules=new Map,this.buildingRules=new Map,this.infantryRules=new Map,this.vehicleRules=new Map,this.aircraftRules=new Map,this.terrainRules=new Map,this.overlayRules=new Map,this.smudgeRules=new Map,this.voxelAnimRules=new Map,this.countryRules=new Map,this.warheadRules=new Map,this.powerups=new S.PowerupsRules,this.colors=new Map,this.general=new o.GeneralRules,this.ai=new f.AiRules,this.crateRules=new b.CrateRules,this.elevationModel=new y.ElevationModelRules,this.mpDialogSettings=new l.MpDialogSettings,this.audioVisual=new a.AudioVisualRules,this.combatDamage=new p.CombatDamageRules,this.radiation=new T.RadiationRules,this.landRules=new Map,this.tiberiumRules=new Map,this.superWeaponRules=new Map,this.cachedWeaponRules=new Map,this.cachedProjectileRules=new Map,this.init()}hasObject(e,t){return this.allObjectRules.get(t)?.has(e)}getObject(e,t){var i=this.allObjectRules.get(t)?.get(e);if(!i)throw new Error(`Missing rules for object "${e}"`);return i}getTechnoByInternalId(e,t){let i;if(t===r.ObjectType.Building)i=this.buildingTypes.get(e);else if(t===r.ObjectType.Infantry)i=this.infantryTypes.get(e);else if(t===r.ObjectType.Vehicle)i=this.vehicleTypes.get(e);else{if(t!==r.ObjectType.Aircraft)throw new Error(`Type ${r.ObjectType[t]} is not a techno type`);i=this.aircraftTypes.get(e)}if(void 0===i)throw new Error(`Object type "${r.ObjectType[t]}" with ID "${e}" not found`);return this.getObject(i,t)}getBuilding(e){var t=this.buildingRules.get(e);if(!t)throw new Error(`Missing rules for building "${e}"`);return t}getWeapon(e){let t=this.cachedWeaponRules.get(e);if(!t){var i=this.ini.getSection(e);if(!i)throw new Error(`Weapon ${e} is missing ini section`);t=new n.WeaponRules(i),this.cachedWeaponRules.set(e,t)}return t}getWeaponByInternalId(e){var t=this.weaponTypes.get(e);if(!t)throw new RangeError(`Weapon with internal ID "${e}" not found`);return this.getWeapon(t)}getWarhead(e){let t=this.warheadRules.get(e.toLowerCase());var i;if(t||(i=this.ini.getSection(e))&&(t=new u.WarheadRules(i),this.warheadRules.set(e.toLowerCase(),t)),!t)throw new Error("Unknown warhead "+e);return t}getProjectile(e){let t=this.cachedProjectileRules.get(e);if(!t){var i=this.ini.getSection(e);if(!i)throw new Error(`Projectile ${e} is missing ini section`);t=new d.ProjectileRules(r.ObjectType.Projectile,i),this.cachedProjectileRules.set(e,t)}return t}getOverlayName(e){var t=this.overlayTypes.get(e);if(!t)throw new Error("Invalid overlay id "+e);return t}hasOverlayId(e){return this.overlayTypes.has(e)}getOverlayId(e){var t=this.overlayIdsByType.get(e);if(void 0===t)throw new Error("Invalid overlay name "+e);return t}getOverlay(e){var t=this.overlayRules.get(e);if(!t)throw new Error(`Missing rules for overlay "${e}"`);return t}getAnimationName(e){return this.animationTypes.get(e)}getCountry(e){if(!this.countryRules.has(e))throw new Error("Unknown country "+e);return this.countryRules.get(e)}getMultiplayerCountries(){return[...this.countryRules.values()].filter((e=>e.multiplay))}getMultiplayerColors(){let e=new Map;return w.mpAllowedColors.forEach((t=>{if(!this.colors.has(t))throw new Error(`Multiplayer color "${t}" does not exist in the rules [Colors] section.`);e.set(t,this.colors.get(t))})),e}getLandRules(e){let t=this.landRules.get(e);var i;return t||(i=e===c.LandType.Cliff?"Rock":c.LandType[e],t=(new h.LandRules).readIni(this.ini.getOrCreateSection(i)),this.landRules.set(e,t)),t}getTiberium(e){var t=this.tiberiumTypes.get(e);if(!t)throw new Error("Unknown tiberium type "+e);return this.tiberiumRules.get(t)}getSuperWeapon(e){if(!this.superWeaponRules.has(e))throw new Error(`Unknown superweapon type "${e}"`);return this.superWeaponRules.get(e)}getIni(){return this.ini}applySpecialFlags(e){e.initialVeteran&&(this.general.veteran.initialVeteran=!0)}init(){this.readAudioVisual(),this.readCombatDamage(),this.readRadiation(),this.readGeneral(),this.readAi(),this.readCrateRules(),this.readElevationModel(),this.readMpDialogSettings(),this.readObjectTypes("BuildingTypes",this.buildingTypes),this.readObjectTypes("InfantryTypes",this.infantryTypes),this.readObjectTypes("VehicleTypes",this.vehicleTypes),this.readObjectTypes("AircraftTypes",this.aircraftTypes),this.readObjectTypes("TerrainTypes",this.terrainTypes),this.readObjectTypes("SmudgeTypes",this.smudgeTypes),this.readObjectTypes("Animations",this.animationTypes),this.animationNames=new Set(this.animationTypes.values()),this.readObjectTypes("VoxelAnims",this.voxelAnimTypes),this.readObjectTypes("OverlayTypes",this.overlayTypes),this.overlayTypes.forEach(((e,t)=>this.overlayIdsByType.set(e,t))),this.readColors(),this.readObjectTypes("Countries",this.countryTypes),this.readObjectTypes("Warheads",this.warheadTypes),this.readObjectTypes("Tiberiums",this.tiberiumTypes),this.readObjectTypes("SuperWeaponTypes",this.superWeaponTypes),this.allObjectRules.set(r.ObjectType.Building,this.buildingRules).set(r.ObjectType.Infantry,this.infantryRules).set(r.ObjectType.Vehicle,this.vehicleRules).set(r.ObjectType.Aircraft,this.aircraftRules).set(r.ObjectType.Terrain,this.terrainRules).set(r.ObjectType.Overlay,this.overlayRules).set(r.ObjectType.Smudge,this.smudgeRules).set(r.ObjectType.VoxelAnim,this.voxelAnimRules),this.readObjects(r.ObjectType.Building,this.buildingTypes,this.buildingRules),this.readObjects(r.ObjectType.Infantry,this.infantryTypes,this.infantryRules),this.readObjects(r.ObjectType.Vehicle,this.vehicleTypes,this.vehicleRules),this.readObjects(r.ObjectType.Aircraft,this.aircraftTypes,this.aircraftRules),this.readObjects(r.ObjectType.Terrain,this.terrainTypes,this.terrainRules),this.readObjects(r.ObjectType.Overlay,this.overlayTypes,this.overlayRules),this.readObjects(r.ObjectType.Smudge,this.smudgeTypes,this.smudgeRules),this.readObjects(r.ObjectType.VoxelAnim,this.voxelAnimTypes,this.voxelAnimRules),this.readCountries(),this.readWarheads(),this.readPowerups(),this.readTiberiums(),this.readSuperWeapons(),this.buildWeaponsList()}readAudioVisual(){var e=this.ini.getSection("AudioVisual");if(!e)throw new Error("Missing [AudioVisual] section");this.audioVisual.readIni(e)}readCombatDamage(){var e=this.ini.getSection("CombatDamage");if(!e)throw new Error("Missing [CombatDamage] section");this.combatDamage.readIni(e)}readRadiation(){var e=this.ini.getSection("Radiation");if(!e)throw new Error("Missing [Radiation] section");this.radiation.readIni(e)}readGeneral(){var e=this.ini.getSection("General");if(!e)throw new Error("Missing [General] section");this.general.readIni(e)}readAi(){var e=this.ini.getSection("AI");if(!e)throw new Error("Missing [AI] section");this.ai.readIni(e)}readCrateRules(){var e=this.ini.getSection("CrateRules");if(!e)throw new Error("Missing [CrateRules] section");this.crateRules.readIni(e)}readElevationModel(){var e=this.ini.getSection("ElevationModel");if(!e)throw new Error("Missing [ElevationModel] section");this.elevationModel.readIni(e)}readMpDialogSettings(){var e=this.ini.getSection("MultiplayerDialogSettings");if(!e)throw new Error("Missing [MultiplayerDialogSettings] section");this.mpDialogSettings.readIni(e)}readObjectTypes(e,t){let i=this.ini.getSection(e);if(!i)throw new Error(`Missing [${e}] section`);let r=0,s=new Set;i.entries.forEach(((i,n)=>{Number.isNaN(Number(n))?this.logger?.debug(`Non-numeric id "${n}" found in rules section [${e}]. Skipping.`):s.has(i)?this.logger?.debug(`Duplicate type "${i}" in rules section [${e}]. Skipping.`):(t.set(r++,i),s.add(i))}))}readColors(){let e=this.ini.getSection("Colors");if(!e)throw new Error("Missing [Colors] section");e.entries.forEach(((e,t)=>{var[r,s,n]=e.split(","),n=i.Color.fromHsv(parseInt(r,10),parseInt(s,10),parseInt(n,10));this.colors.set(t,n)}))}readObjects(e,t,i){t.forEach(((t,s)=>{var n=this.ini.getSection(t);n?(n=(new g.ObjectRulesFactory).create(e,n,s),i.set(t,n)):this.logger?.debug(r.ObjectType[e]+` type "${t}" has no rules section`)}))}readCountries(){this.countryTypes.forEach(((e,t)=>{var i=this.ini.getSection(e);if(!i)throw new Error("Missing ini section for country "+e);let r=new s.CountryRules(t);r.readIni(i),this.countryRules.set(e,r)}))}readWarheads(){this.warheadTypes.forEach((e=>{var t=this.ini.getSection(e);t?(t=new u.WarheadRules(t),this.warheadRules.set(e.toLowerCase(),t)):this.logger?.debug(`Warhead "${e}" has no rules section`)}))}readPowerups(){var e=this.ini.getSection("Powerups");if(!e)throw new Error("Missing [Powerups] section");this.powerups.readIni(e)}readTiberiums(){this.tiberiumTypes.forEach((e=>{var t=this.ini.getSection(e);if(!t)throw new Error("Missing rules section for tiberium type "+e);this.tiberiumRules.set(e,(new m.TiberiumRules).readIni(t))}))}readSuperWeapons(){this.superWeaponTypes.forEach(((e,t)=>{var i=this.ini.getSection(e);if(!i)throw new Error("Missing rules section for superweapon type "+e);this.superWeaponRules.set(e,new v.SuperWeaponRules(t).readIni(i))}))}buildWeaponsList(){let e=new Set;for(var t of(e.add(this.general.dropPodWeapon),this.superWeaponRules.values()))t.weaponType&&e.add(t.weaponType);var i,r;e.add(E.Weapon.NUKE_PAYLOAD_NAME);for(let t of[...this.buildingRules.values(),...this.aircraftRules.values(),...this.vehicleRules.values(),...this.infantryRules.values()])for(i of[t.deathWeapon,t.primary,t.secondary,t.elitePrimary,t.eliteSecondary,t.occupyWeapon,t.eliteOccupyWeapon,...t.weaponCount?new Array(t.weaponCount).fill(0).map(((e,i)=>[t.getWeaponAtIndex(i),t.getEliteWeaponAtIndex(i)])).flat():[]].filter(C.isNotNullOrUndefined).filter((e=>""!==e)))e.add(i);let s=0;for(r of e)this.weaponTypes.set(s++,r)}})}}})),System.register("game/Country",["engine/type/ObjectType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Country",class{constructor(e){this.rules=e}static factory(e,t){return new this(t.getCountry(e))}get id(){return this.rules.id}get side(){return this.rules.side}get name(){return this.rules.name}isPlayable(){return this.rules.multiplay&&!this.rules.multiplayPassive}hasVeteranUnit(e,t){let r=[];switch(e){case i.ObjectType.Aircraft:r=this.rules.veteranAircraft;break;case i.ObjectType.Infantry:r=this.rules.veteranInfantry;break;case i.ObjectType.Vehicle:r=this.rules.veteranUnits;break;default:throw new Error(`Unsupported object type "${i.ObjectType[e]}"`)}return r.includes(t)}})}}})),System.register("game/rules/TechnoRules",["engine/type/ObjectType","game/SideType","game/type/SpeedType","game/type/PipColor","game/type/LocomotorType","game/type/MovementZone","game/type/ArmorType","game/type/LandTargeting","game/type/NavalTargeting","game/rules/ObjectRules","game/WeaponType","game/gameobject/unit/VeteranAbility","game/type/VhpScan","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){var t;(t=f=f||{})[t.Combat=0]="Combat",t[t.Tech=1]="Tech",t[t.Resource=2]="Resource",t[t.Power=3]="Power",e("BuildCat",f),(t=y=y||{})[t.None=0]="None",t[t.BuildingType=1]="BuildingType",t[t.InfantryType=2]="InfantryType",t[t.UnitType=3]="UnitType",t[t.NavalUnitType=4]="NavalUnitType",t[t.AircraftType=5]="AircraftType",e("FactoryType",y),T=class e extends u.ObjectRules{parse(){super.parse(),this.owner=this.ini.getArray("Owner");var t=this.ini.getNumber("AIBasePlanningSide");this.aiBasePlanningSide=-1!==t&&void 0!==r.SideType[t]?t:void 0,this.requiredHouses=this.ini.getArray("RequiredHouses"),this.forbiddenHouses=this.ini.getArray("ForbiddenHouses"),this.requiresStolenAlliedTech=this.ini.getBool("RequiresStolenAlliedTech"),this.requiresStolenSovietTech=this.ini.getBool("RequiresStolenSovietTech"),this.techLevel=this.ini.getNumber("TechLevel",-1),this.cost=this.ini.getNumber("Cost"),this.points=this.ini.getNumber("Points"),this.power=this.ini.getNumber("Power"),this.powered=this.ini.getBool("Powered"),this.prerequisite=this.ini.getArray("Prerequisite"),this.soylent=this.ini.getNumber("Soylent"),this.crateGoodie=this.ini.getBool("CrateGoodie"),this.buildCat=this.ini.getEnum("BuildCat",f,f.Combat),this.adjacent=this.ini.getNumber("Adjacent",1),this.baseNormal=this.ini.getBool("BaseNormal",!0),this.buildLimit=this.ini.getNumber("BuildLimit",Number.POSITIVE_INFINITY),this.airRangeBonus=this.ini.getNumber("AirRangeBonus"),this.guardRange=this.ini.getNumber("GuardRange"),this.defaultToGuardArea=this.ini.getBool("DefaultToGuardArea"),this.eligibileForAllyBuilding=this.ini.getBool("EligibileForAllyBuilding"),this.numberImpassableRows=this.ini.getNumber("NumberImpassableRows"),this.bridgeRepairHut=this.ini.getBool("BridgeRepairHut"),this.constructionYard=this.ini.getBool("ConstructionYard"),this.refinery=this.ini.getBool("Refinery"),this.unitRepair=this.ini.getBool("UnitRepair"),this.unitReload=this.ini.getBool("UnitReload"),this.isBaseDefense=this.ini.getBool("IsBaseDefense"),this.superWeapon=this.parseWeaponName(this.ini.getString("SuperWeapon")),this.chargedAnimTime=this.ini.getNumber("ChargedAnimTime");var T=this.ini.getBool("Naval");this.naval=T,this.underwater=this.ini.getBool("Underwater"),this.waterBound=this.ini.getBool("WaterBound"),this.orePurifier=this.ini.getBool("OrePurifier"),this.cloning=this.ini.getBool("Cloning"),this.nukeSilo=this.ini.getBool("NukeSilo"),this.repairable=this.ini.getBool("Repairable",this.type===i.ObjectType.Building),this.clickRepairable=this.ini.getBool("ClickRepairable",this.type===i.ObjectType.Building),this.unsellable=this.ini.getBool("Unsellable"),this.gdiBarracks=this.ini.getBool("GDIBarracks"),this.nodBarracks=this.ini.getBool("NODBarracks"),this.numberOfDocks=this.ini.getNumber("NumberOfDocks"),this.unitRepair&&!this.numberOfDocks&&(this.numberOfDocks=1),this.factory=this.ini.getEnum("Factory",y,y.None),this.factory===y.UnitType&&T&&(this.factory=y.NavalUnitType),this.weaponsFactory=this.ini.getBool("WeaponsFactory"),this.helipad=this.ini.getBool("Helipad"),this.hospital=this.ini.getBool("Hospital"),this.landTargeting=this.ini.getEnumNumeric("LandTargeting",c.LandTargeting,c.LandTargeting.LandOk),this.navalTargeting=this.ini.getEnumNumeric("NavalTargeting",h.NavalTargeting,h.NavalTargeting.UnderwaterNever),this.tooBigToFitUnderBridge=this.ini.getBool("TooBigToFitUnderBridge",this.type===i.ObjectType.Building),this.canBeOccupied=this.ini.getBool("CanBeOccupied"),this.maxNumberOccupants=this.ini.getNumber("MaxNumberOccupants"),this.leaveRubble=this.ini.getBool("LeaveRubble"),this.undeploysInto=this.ini.getString("UndeploysInto"),this.deploysInto=this.ini.getString("DeploysInto"),this.capturable=this.ini.getBool("Capturable"),this.spyable=this.ini.getBool("Spyable"),this.needsEngineer=this.ini.getBool("NeedsEngineer"),this.c4=this.ini.getBool("C4"),this.canC4=this.ini.getBool("CanC4",!0),this.produceCashStartup=this.ini.getNumber("ProduceCashStartup"),this.produceCashAmount=this.ini.getNumber("ProduceCashAmount"),this.produceCashDelay=this.ini.getNumber("ProduceCashDelay"),this.explosion=this.ini.getArray("Explosion"),this.explodes=this.ini.getBool("Explodes"),this.ifvMode=this.ini.getNumber("IFVMode"),this.turretIndexesByIfvMode=this.parseTurretIndexes(),this.turret=this.ini.getBool("Turret"),this.turretCount=this.ini.getNumber("TurretCount",this.turret?1:0),this.turretAnim=this.ini.getString("TurretAnim"),this.turretAnimIsVoxel=this.ini.getBool("TurretAnimIsVoxel"),this.turretAnimX=this.ini.getNumber("TurretAnimX"),this.turretAnimY=this.ini.getNumber("TurretAnimY"),this.turretAnimZAdjust=this.ini.getNumber("TurretAnimZAdjust"),this.isChargeTurret=this.ini.getBool("IsChargeTurret"),this.overpowerable=this.ini.getBool("Overpowerable"),this.freeUnit=this.ini.getString("FreeUnit"),this.primary=this.parseWeaponName(this.ini.getString("Primary")),this.secondary=this.parseWeaponName(this.ini.getString("Secondary")),this.elitePrimary=this.parseWeaponName(this.ini.getString("ElitePrimary")),this.eliteSecondary=this.parseWeaponName(this.ini.getString("EliteSecondary")),this.weaponCount=this.ini.getNumber("WeaponCount"),this.deathWeapon=this.parseWeaponName(this.ini.getString("DeathWeapon")),this.deathWeaponDamageModifier=this.ini.getNumber("DeathWeaponDamageModifier",1),this.occupyWeapon=this.parseWeaponName(this.ini.getString("OccupyWeapon")),this.eliteOccupyWeapon=this.parseWeaponName(this.ini.getString("EliteOccupyWeapon")),this.veteranAbilities=new Set(this.ini.getEnumArray("VeteranAbilities",g.VeteranAbility)),this.eliteAbilities=new Set([...this.veteranAbilities,...this.ini.getEnumArray("EliteAbilities",g.VeteranAbility)]),this.selfHealing=this.ini.getBool("SelfHealing"),this.wall=this.ini.getBool("Wall"),this.gate=this.ini.getBool("Gate"),this.armor=this.ini.getEnum("Armor",l.ArmorType,l.ArmorType.None,!0),this.strength=Math.floor(this.ini.getNumber("Strength")),this.immune=this.ini.getBool("Immune"),this.immuneToRadiation=this.ini.getBool("ImmuneToRadiation"),this.immuneToPsionics=this.ini.getBool("ImmuneToPsionics"),this.typeImmune=this.ini.getBool("TypeImmune"),this.warpable=this.ini.getBool("Warpable",!0),this.isTilter=this.ini.getBool("IsTilter",!0),this.walkRate=this.ini.getNumber("WalkRate",1),this.idleRate=this.ini.getNumber("IdleRate",0),this.noSpawnAlt=this.ini.getBool("NoSpawnAlt"),this.crusher=this.ini.getBool("Crusher"),this.consideredAircraft=this.ini.getBool("ConsideredAircraft"),this.crashable=this.ini.getBool("Crashable");var v=this.ini.getBool("Landable");this.landable=v,this.airportBound=this.ini.getBool("AirportBound"),this.balloonHover=this.ini.getBool("BalloonHover"),this.hoverAttack=this.ini.getBool("HoverAttack"),this.omniFire=this.ini.getBool("OmniFire"),this.fighter=this.ini.getBool("Fighter"),this.flightLevel=this.ini.getNumber("FlightLevel")||void 0;var b=this.ini.getString("Locomotor");t=this.type===i.ObjectType.Building?a.LocomotorType.Statue:a.LocomotorType.Chrono;if(b?(T=a.locomotorTypesByClsId.get(b))?this.locomotor=T:(console.warn(`Object rules "${this.name}" has invalid Locomotor "${b}"`),this.locomotor=t):this.locomotor=t,this.locomotor!==a.LocomotorType.Statue){let e=a.defaultSpeedsByLocomotor.get(this.locomotor);void 0===e&&(this.type===i.ObjectType.Aircraft||this.consideredAircraft?e=s.SpeedType.Winged:this.type===i.ObjectType.Vehicle?e=this.crusher?s.SpeedType.Track:s.SpeedType.Wheel:this.type===i.ObjectType.Infantry&&(e=s.SpeedType.Foot)),this.speedType=this.ini.getEnum("SpeedType",s.SpeedType,e,!0)}t=[a.LocomotorType.Ship,a.LocomotorType.Vehicle,a.LocomotorType.Chrono].includes(this.locomotor)?65:100,this.speed=u.ObjectRules.iniSpeedToLeptonsPerTick(this.ini.getNumber("Speed"),t),this.movementZone=this.ini.getEnum("MovementZone",o.MovementZone,o.MovementZone.Normal),this.fearless=this.ini.getBool("Fearless"),this.deployer=this.ini.getBool("Deployer"),this.deployFire=this.ini.getBool("DeployFire"),this.deployFireWeapon=this.ini.getNumber("DeployFireWeapon",d.WeaponType.Secondary),this.undeployDelay=this.ini.getNumber("UndeployDelay"),this.fraidycat=this.ini.getBool("Fraidycat",!1),this.isHuman=!this.ini.getBool("NotHuman"),this.organic=this.type===i.ObjectType.Infantry||this.ini.getBool("Organic"),this.occupier=this.ini.getBool("Occupier"),this.engineer=this.ini.getBool("Engineer"),this.ivan=this.ini.getBool("Ivan"),this.civilian=this.ini.getBool("Civilian"),this.agent=this.ini.getBool("Agent"),this.infiltrate=this.ini.getBool("Infiltrate"),this.threatPosed=this.ini.getNumber("ThreatPosed"),this.specialThreatValue=this.ini.getNumber("SpecialThreatValue"),this.canPassiveAquire=this.ini.getBool("CanPassiveAquire",!0),this.canRetaliate=this.ini.getBool("CanRetaliate",!0),this.preventAttackMove=this.ini.getBool("PreventAttackMove"),this.opportunityFire=this.ini.getBool("OpportunityFire"),this.distributedFire=this.ini.getBool("DistributedFire"),this.radialFireSegments=this.ini.getNumber("RadialFireSegments"),this.attackCursorOnFriendlies=this.ini.getBool("AttackCursorOnFriendlies"),this.bombable=this.ini.getBool("Bombable",!0),this.trainable=this.ini.getBool("Trainable",this.type!==i.ObjectType.Building),this.crewed=this.ini.getBool("Crewed"),this.parasiteable=this.ini.getBool("Parasiteable",this.type!==i.ObjectType.Building),this.suppressionThreshold=this.ini.getNumber("SuppressionThreshold"),this.reselectIfLimboed=this.ini.getBool("ReselectIfLimboed"),this.rejoinTeamIfLimboed=this.ini.getBool("RejoinTeamIfLimboed"),this.weight=this.ini.getNumber("Weight"),this.accelerates=this.ini.getBool("Accelerates",!0),this.accelerationFactor=this.ini.getNumber("AccelerationFactor",.03),this.teleporter=this.ini.getBool("Teleporter"),this.canDisguise=this.ini.getBool("CanDisguise"),this.disguiseWhenStill=this.ini.getBool("DisguiseWhenStill"),this.permaDisguise=this.ini.getBool("PermaDisguise"),this.detectDisguise=this.ini.getBool("DetectDisguise"),this.detectDisguiseRange=this.ini.getNumber("DetectDisguiseRange"),this.cloakable=this.ini.getBool("Cloakable"),this.sensors=this.ini.getBool("Sensors"),this.sensorArray=this.ini.getBool("SensorArray"),this.sensorsSight=this.ini.getNumber("SensorsSight"),this.burstDelay=this.parseBurstDelay(),this.vhpScan=this.ini.getEnum("VHPScan",p.VhpScan,p.VhpScan.None,!0),this.pip=this.ini.getEnum("Pip",n.PipColor,n.PipColor.Green,!0),this.passengers=this.ini.getNumber("Passengers"),this.gunner=this.ini.getBool("Gunner"),this.ammo=this.ini.getNumber("Ammo",-1),this.initialAmmo=this.ini.getNumber("InitialAmmo",-1),this.manualReload=this.ini.getBool("ManualReload",this.type===i.ObjectType.Aircraft),this.storage=this.ini.getNumber("Storage"),this.spawned=this.ini.getBool("Spawned"),this.spawns=this.ini.getString("Spawns"),this.spawnsNumber=this.ini.getNumber("SpawnsNumber"),this.spawnRegenRate=this.ini.getNumber("SpawnRegenRate"),this.spawnReloadRate=this.ini.getNumber("SpawnReloadRate"),this.missileSpawn=this.ini.getBool("MissileSpawn"),this.size=this.ini.getNumber("Size",1),this.sizeLimit=this.ini.getNumber("SizeLimit"),this.sight=Math.min(e.MAX_SIGHT,this.ini.getNumber("Sight",1)),this.spySat=this.ini.getBool("SpySat"),this.gapGenerator=this.ini.getBool("GapGenerator"),this.gapRadiusInCells=this.ini.getNumber("GapRadiusInCells"),this.psychicDetectionRadius=this.ini.getNumber("PsychicDetectionRadius"),this.hasRadialIndicator=this.ini.getBool("HasRadialIndicator"),this.harvester=this.ini.getBool("Harvester"),this.unloadingClass=this.ini.getString("UnloadingClass"),this.dock=this.ini.getArray("Dock"),this.radar=this.ini.getBool("Radar"),this.radarInvisible=this.ini.getBool("RadarInvisible"),this.revealToAll=this.ini.getBool("RevealToAll"),this.selectable=!(this.type===i.ObjectType.Aircraft&&!v)&&this.ini.getBool("Selectable",!0),this.isSelectableCombatant=this.ini.getBool("IsSelectableCombatant"),this.invisibleInGame=this.ini.getBool("InvisibleInGame"),this.moveToShroud=this.ini.getBool("MoveToShroud",this.type!==i.ObjectType.Aircraft),this.leadershipRating=this.ini.getNumber("LeadershipRating",5),this.allowedToStartInMultiplayer=this.ini.getBool("AllowedToStartInMultiplayer",!0),this.rot=u.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("ROT",0)),this.jumpjetAccel=this.ini.getNumber("JumpJetAccel",2),this.jumpjetClimb=this.ini.getNumber("JumpjetClimb",5),this.jumpjetCrash=this.ini.getNumber("JumpjetCrash",5),this.jumpjetDeviation=this.ini.getNumber("JumpjetDeviation",40),this.jumpjetHeight=this.ini.getNumber("JumpjetHeight",500),this.jumpjetNoWobbles=this.ini.getBool("JumpjetNoWobbles"),this.jumpjetSpeed=this.ini.getNumber("JumpjetSpeed",14),this.jumpjetTurnRate=u.ObjectRules.iniRotToDegsPerTick(this.ini.getNumber("JumpJetTurnRate",4)),this.jumpjetWobbles=this.ini.getNumber("JumpjetWobbles",.15),this.pitchSpeed=this.ini.getNumber("PitchSpeed",.25),this.pitchAngle=1<=this.pitchSpeed?0:20,this.damageParticleSystems=this.ini.getArray("DamageParticleSystems"),v=this.ini.getNumberArray("DamageSmokeOffset",void 0,[0,0,0]),this.damageSmokeOffset=new m.Vector3(v[0],v[2]/Math.SQRT2,v[1]),this.minDebris=this.ini.getNumber("MinDebris"),this.maxDebris=this.ini.getNumber("MaxDebris"),this.debrisTypes=this.ini.getArray("DebrisTypes"),this.debrisAnims=this.ini.getArray("DebrisAnims"),this.isLightpost="GALITE"===this.imageName,this.lightVisibility=this.ini.getNumber("LightVisibility",5e3),this.lightIntensity=this.ini.getNumber("LightIntensity"),this.lightRedTint=this.ini.getNumber("LightRedTint",1),this.lightGreenTint=this.ini.getNumber("LightGreenTint",1),this.lightBlueTint=this.ini.getNumber("LightBlueTint",1),this.ambientSound=this.ini.getString("AmbientSound")||void 0,this.createSound=this.ini.getString("CreateSound")||void 0,this.deploySound=this.ini.getString("DeploySound")||void 0,this.undeploySound=this.ini.getString("UndeploySound")||void 0,this.voiceSelect=this.ini.getString("VoiceSelect")||void 0,this.voiceMove=this.ini.getString("VoiceMove")||void 0,this.voiceAttack=this.ini.getString("VoiceAttack")||void 0,this.voiceFeedback=this.ini.getString("VoiceFeedback")||void 0,this.voiceSpecialAttack=this.ini.getString("VoiceSpecialAttack")||void 0,this.voiceEnter=this.ini.getString("VoiceEnter")||void 0,this.voiceCapture=this.ini.getString("VoiceCapture")||void 0,this.voiceCrashing=this.ini.getString("VoiceCrashing")||void 0,this.crashingSound=this.ini.getString("CrashingSound")||void 0,this.impactLandSound=this.ini.getString("ImpactLandSound")||void 0,this.auxSound1=this.ini.getString("AuxSound1")||void 0,this.auxSound2=this.ini.getString("AuxSound2")||void 0,this.dieSound=this.ini.getString("DieSound")||void 0,this.moveSound=this.ini.getString("MoveSound")||void 0,this.enterWaterSound=this.ini.getString("EnterWaterSound")||void 0,this.leaveWaterSound=this.ini.getString("LeaveWaterSound")||void 0,this.turretRotateSound=this.ini.getString("TurretRotateSound")||void 0,this.workingSound=this.ini.getString("WorkingSound")||void 0,this.notWorkingSound=this.ini.getString("NotWorkingSound")||void 0,this.chronoInSound=this.ini.getString("ChronoInSound")||void 0,this.chronoOutSound=this.ini.getString("ChronoOutSound")||void 0,this.enterTransportSound=this.ini.getString("EnterTransportSound")||void 0,this.leaveTransportSound=this.ini.getString("LeaveTransportSound")||void 0}parseWeaponName(e){return e&&"none"!==e.toLowerCase()?e:void 0}parseTurretIndexes(){let e=new Map;return this.ini.getBool("Gunner")&&this.ini.entries.forEach(((t,i)=>{var r=i.match(/^(.*)TurretWeapon$/i);r&&(r=r[1]+"TurretIndex",this.ini.has(r)&&e.set(Number(t),this.ini.getNumber(r)))})),e}parseBurstDelay(){let e=[];for(let t=0;t<4;++t)e.push(this.ini.has("BurstDelay"+t)?this.ini.getNumber("BurstDelay"+t):void 0);return e}hasOwner(e){return!!this.owner.length&&-1!==this.owner.indexOf(e.name)}isAvailableTo(e){return(!this.requiredHouses.length||-1!==this.requiredHouses.indexOf(e.name))&&-1===this.forbiddenHouses.indexOf(e.name)}get proneWhenAttacked(){return!this.fearless&&this.isHuman}getWeaponAtIndex(e){return this.parseWeaponName(this.ini.getString("Weapon"+(e+1)))}getEliteWeaponAtIndex(e){return this.parseWeaponName(this.ini.getString("EliteWeapon"+(e+1)))}},e("TechnoRules",T),T.MAX_SIGHT=11}}})),System.register("game/art/RotorData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/art/ObjectArt",["engine/type/PaletteType","engine/type/ObjectType","game/Coords","game/art/SequenceReader","engine/type/LightingType","game/type/LandType","game/rules/OverlayRules","game/rules/TechnoRules","game/rules/TerrainRules","game/rules/ProjectileRules","game/art/FlhCoords","game/math/Vector2","game/math/Vector3"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){e("ObjectArt",m=class e{constructor(e,t,i){this.sequences=new Map,this.dockingOffsets=[],this.type=e,this.rules=t,this.art=i,this.init()}static getDefaultPalette(e){switch(e){case r.ObjectType.Building:case r.ObjectType.Aircraft:case r.ObjectType.Infantry:case r.ObjectType.Vehicle:case r.ObjectType.Projectile:case r.ObjectType.VoxelAnim:return i.PaletteType.Unit;case r.ObjectType.Overlay:return i.PaletteType.Overlay;case r.ObjectType.Smudge:case r.ObjectType.Terrain:return i.PaletteType.Iso;default:return r.ObjectType.Animation,i.PaletteType.Anim}}static getDefaultLighting(e){switch(e){case r.ObjectType.Animation:return a.LightingType.None;case r.ObjectType.Aircraft:case r.ObjectType.Building:case r.ObjectType.Infantry:case r.ObjectType.Vehicle:return a.LightingType.Ambient;case r.ObjectType.Projectile:case r.ObjectType.VoxelAnim:return a.LightingType.Global;case r.ObjectType.Overlay:case r.ObjectType.Smudge:case r.ObjectType.Terrain:default:return a.LightingType.Full}}static getDefaultRemapability(e){switch(e){case r.ObjectType.Aircraft:case r.ObjectType.Building:case r.ObjectType.Infantry:case r.ObjectType.Vehicle:return!0;case r.ObjectType.Overlay:case r.ObjectType.Smudge:case r.ObjectType.Terrain:case r.ObjectType.Animation:case r.ObjectType.Projectile:case r.ObjectType.VoxelAnim:return!1;default:throw new Error("Unknown object type "+e)}}static getDefaultDrawOffset(e){switch(e){case r.ObjectType.Animation:case r.ObjectType.Building:case r.ObjectType.Vehicle:case r.ObjectType.Infantry:case r.ObjectType.Overlay:case r.ObjectType.Smudge:case r.ObjectType.Projectile:case r.ObjectType.VoxelAnim:return new g.Vector2(0,0);case r.ObjectType.Terrain:case r.ObjectType.Aircraft:return new g.Vector2(0,(s.Coords.ISO_TILE_SIZE+1)/2);default:throw new Error("Unknown object type "+e)}}static getDefaultShadow(e){switch(e){case r.ObjectType.Overlay:case r.ObjectType.Building:case r.ObjectType.Infantry:case r.ObjectType.Terrain:case r.ObjectType.Vehicle:case r.ObjectType.Aircraft:return!0;default:case r.ObjectType.Smudge:case r.ObjectType.Animation:case r.ObjectType.Projectile:case r.ObjectType.VoxelAnim:return!1}}static getDefaultHeight(e){switch(e){case r.ObjectType.Building:return 2;case r.ObjectType.Infantry:case r.ObjectType.Vehicle:case r.ObjectType.Aircraft:return 1;default:return 0}}static factory(e,t,i,s){let a=new this(e,t,s);var o;return e===r.ObjectType.Infantry&&(!(o=s.getString("Sequence"))||(o=i.getSection(o))&&(a.sequences=(new n.SequenceReader).readIni(o))),a}init(){this.image=[r.ObjectType.Infantry,r.ObjectType.Vehicle,r.ObjectType.Aircraft].includes(this.type)?"":this.art.getString("Image"),this.report=this.art.getString("Report")||void 0,this.readRotors(),this.noHva=this.art.getBool("NoHVA"),this.startSound=this.art.getString("StartSound")||void 0,this.readMuzzleFlash(),this.readPaletteAndLightingTypes(),this.readRemapability(),this.readFlatness(),this.readDockingOffsets();var t=this.art.getNumberArray("QueueingCell");this.queueingCell=t.length?new g.Vector2(t[0],t[1]):void 0,this.demandLoad=this.art.getBool("DemandLoad");var i=this.art.getBool("UseLineTrail"),s=this.art.getNumberArray("LineTrailColor");t=this.art.getNumber("LineTrailColorDecrement",e.DEFAULT_LINE_TRAIL_DEC);i&&s.length?(this.useLineTrail=!0,this.lineTrailColor=s,this.lineTrailColorDecrement=t):this.useLineTrail=!1,this.crater=this.art.getBool("Crater"),this.forceBigCraters=this.art.getBool("ForceBigCraters"),this.scorch=this.art.getBool("Scorch"),this.height=this.art.getNumber("Height",e.getDefaultHeight(this.type)),this.isVoxel=this.art.getBool("Voxel"),this.occupyHeight=this.art.getNumber("OccupyHeight",this.height),this.type===r.ObjectType.Building?this.canHideThings=this.art.getBool("CanHideThings",!0):this.canHideThings=!1,this.canBeHidden=this.art.getBool("CanBeHidden",!0),this.addOccupy=this.readAddRemoveOccupy("AddOccupy"),this.removeOccupy=this.readAddRemoveOccupy("RemoveOccupy"),this.rotates=this.art.getBool("Rotates")}get imageName(){return(this.image||this.rules.imageName)+(this.rules.alternateArcticArt?"A":"")}get cameo(){return(this.art.getString("Cameo")||e.MISSING_CAMEO).toLowerCase()}get altCameo(){return(this.art.getString("AltCameo")||e.MISSING_CAMEO).toLowerCase()}get useTheaterExtension(){return this.art.getBool("Theater")}readPaletteAndLightingTypes(){this.paletteType=i.PaletteType.Default,this.lightingType=a.LightingType.Default,(this.rules instanceof l.OverlayRules?this.rules.noUseTileLandType:void 0)&&(this.paletteType=i.PaletteType.Iso,this.lightingType=a.LightingType.Full),this.art.getBool("TerrainPalette")||this.art.getBool("ShouldUseCellDrawer")?this.paletteType=i.PaletteType.Iso:this.art.getBool("AnimPalette")?(this.paletteType=i.PaletteType.Anim,this.lightingType=a.LightingType.None):this.art.getString("Palette")&&(this.paletteType=i.PaletteType.Custom,this.customPaletteName=this.art.getString("Palette")),this.art.getBool("AltPalette")&&(this.paletteType=i.PaletteType.Unit),(this.rules instanceof l.OverlayRules||this.rules instanceof c.TechnoRules)&&this.rules.wall&&(this.paletteType=i.PaletteType.Unit,this.lightingType=a.LightingType.Ambient),(this.rules instanceof h.TerrainRules||this.rules instanceof c.TechnoRules)&&this.rules.gate&&(this.paletteType=i.PaletteType.Unit),this.rules instanceof h.TerrainRules&&this.rules.spawnsTiberium&&(this.paletteType=i.PaletteType.Unit,this.lightingType=a.LightingType.None),this.rules instanceof l.OverlayRules&&(this.rules.isVeins&&(this.paletteType=i.PaletteType.Unit,this.lightingType=a.LightingType.None),this.rules.isVeinholeMonster&&(this.paletteType=i.PaletteType.Unit,this.lightingType=a.LightingType.None),this.rules.tiberium&&(this.lightingType=a.LightingType.None),this.rules.land===o.LandType.Railroad&&(this.paletteType=i.PaletteType.Iso,this.lightingType=a.LightingType.Full),this.rules.crate&&(this.paletteType=i.PaletteType.Iso,this.lightingType=a.LightingType.Full)),this.paletteType===i.PaletteType.Default&&(this.paletteType=e.getDefaultPalette(this.type)),this.lightingType===a.LightingType.Default&&(this.lightingType=e.getDefaultLighting(this.type))}readRemapability(){this.remapable=e.getDefaultRemapability(this.type),this.art.getBool("TerrainPalette")||this.art.getBool("AnimPalette")?this.remapable=!1:this.rules instanceof u.ProjectileRules&&this.rules.firersPalette&&(this.remapable=!0)}readFlatness(){let e=!1;this.type===r.ObjectType.Building||this.type===r.ObjectType.Animation?e=this.art.getBool("Flat"):this.type===r.ObjectType.Smudge&&(e=!0),this.rules instanceof l.OverlayRules&&(this.rules.wall||this.rules.crate||this.rules.isARock||(e=!0)),this.flat=e}readRotors(){var e=this.art.getArray("Rotors");if(e.length){let i=[];for(let r=0;r<e.length;++r){var t=this.art.getNumberArray(`Rotor${r+1}Axis`,void 0,[0,1,0]);t=new p.Vector3(-t[2],-t[0],t[1]).normalize();i.push({name:e[r],axis:t,speed:this.art.getNumber(`Rotor${r+1}Rate`)||void 0,idleSpeed:this.art.getNumber(`Rotor${r+1}IdleRate`)||void 0})}i.length&&(this.rotors=i)}}readMuzzleFlash(){let e=0,t="MuzzleFlash"+e,i=[];for(;this.art.has(t);){var[r,s]=this.art.getNumberArray(t);i.push({x:r,y:s}),e++,t="MuzzleFlash"+e}this.muzzleFlash=i.length?i:void 0}readDockingOffsets(){if(this.type===r.ObjectType.Building){var e=this.rules.numberOfDocks;for(let r=0;r<e;r++){var[t,i,s]=this.art.getNumberArray("DockingOffset"+r,/\,\s*/,[0,0,0]);this.dockingOffsets.push(new p.Vector3(t,s,i))}}}readAddRemoveOccupy(e){let t=0,i=[];for(;;){var r=this.art.getNumberArray(e+ ++t);if(!r.length)break;i.push(new g.Vector2(r[0],r[1]))}return i}get bibShape(){return this.art.getString("BibShape")}get foundation(){let e=this.art.getString("Foundation","1x1");var[t,i]=e.split("x");return{width:parseInt(t,10),height:parseInt(i,10)}}get foundationCenter(){return new g.Vector2(Math.floor(this.foundation.width/2-.5),Math.floor(this.foundation.height/2-.5))}getDrawOffset(){if(this.rules instanceof h.TerrainRules&&this.rules.spawnsTiberium)return new g.Vector2(0,0);let t=e.getDefaultDrawOffset(this.type);return this.rules instanceof l.OverlayRules&&this.rules.isARock&&(t.y+=(s.Coords.ISO_TILE_SIZE+1)/2),t}get hasShadow(){return this.art.getBool("Shadow",e.getDefaultShadow(this.type))&&!this.rules.noShadow}get turretOffset(){return this.art.getNumber("TurretOffset")}get walkFrames(){return this.art.getNumber("WalkFrames")}get firingFrames(){return this.art.getNumber("FiringFrames")}get isFlamingGuy(){return this.art.getBool("IsFlamingGuy")}get runningFrames(){return this.art.getNumber("RunningFrames")}get primaryFireFlh(){return new d.FlhCoords(this.art.getNumberArray("PrimaryFireFLH"))}get elitePrimaryFireFlh(){var e=this.art.getNumberArray("ElitePrimaryFireFLH");return e.length?new d.FlhCoords(e):this.primaryFireFlh}get primaryFirePixelOffset(){return this.art.getNumberArray("PrimaryFirePixelOffset")}get secondaryFirePixelOffset(){return this.art.getNumberArray("SecondaryFirePixelOffset")}get secondaryFireFlh(){return new d.FlhCoords(this.art.getNumberArray("SecondaryFireFLH"))}get eliteSecondaryFireFlh(){var e=this.art.getNumberArray("EliteSecondaryFireFLH");return e.length?new d.FlhCoords(e):this.secondaryFireFlh}getSpecialWeaponFlh(e){return new d.FlhCoords(this.art.getNumberArray(`Weapon${e+1}FLH`))}get fireUp(){return this.art.getNumber("FireUp")||this.art.getNumber("DelayedFireDelay")}get isAnimDelayedFire(){return this.art.getBool("IsAnimDelayedFire")}get zShapePointMove(){return this.art.getNumberArray("ZShapePointMove")}get zAdjust(){return this.art.getNumber("ZAdjust")}get trailer(){return this.art.getString("Trailer")}get spawnDelay(){return this.art.getNumber("SpawnDelay",1)}get translucent(){return this.art.getBool("Translucent")}get translucency(){var e=(e=this.art.getNumber("Translucency",0))/25*25;return e/100}}),m.DEFAULT_LINE_TRAIL_DEC=16,m.MISSING_CAMEO="xxicon"}}})),System.register("game/gameobject/Smudge",["engine/type/ObjectType","game/gameobject/GameObject"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.GameObject{constructor(e,t,r){super(i.ObjectType.Smudge,e,t,r)}static factory(e,t,i){return new this(e,t,i)}getFoundation(){return{width:this.rules.width,height:this.rules.height}}},e("Smudge",s)}}})),System.register("game/gameobject/GameObject",["engine/type/ObjectType","game/Traits","game/gameobject/trait/interface/NotifyTick","game/gameobject/trait/interface/NotifyDestroy","util/math","game/gameobject/trait/interface/NotifyOwnerChange","game/gameobject/trait/interface/NotifySpawn","game/gameobject/trait/interface/NotifyUnspawn","game/gameobject/trait/interface/NotifyAttack","game/gameobject/common/DeathType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("GameObject",class{constructor(e,t,i,s){this.traits=new r.Traits,this.cachedTraits={tick:[]},this.isCrashing=!1,this.isDestroyed=!1,this.deathType=u.DeathType.Normal,this.isDisposed=!1,this.isSpawned=!1,this.type=e,this.name=t,this.rules=i,this.art=s}get tile(){return this.position.tile}get tileElevation(){return this.position.tileElevation}getFoundation(){return{width:1,height:1}}isSmudge(){return this.type===i.ObjectType.Smudge}isOverlay(){return this.type===i.ObjectType.Overlay}isTerrain(){return this.type===i.ObjectType.Terrain}isProjectile(){return this.type===i.ObjectType.Projectile}isDebris(){return this.type===i.ObjectType.Debris}isBuilding(){return!1}isInfantry(){return!1}isVehicle(){return!1}isAircraft(){return!1}isUnit(){return!1}isTechno(){return!1}update(e){for(var t of this.cachedTraits.tick)t[s.NotifyTick.onTick](this,e)}onSpawn(e){this.isSpawned=!0,this.traits.filter(l.NotifySpawn).forEach((t=>{t[l.NotifySpawn.onSpawn](this,e)}))}onUnspawn(e){this.isSpawned=!1,this.traits.filter(c.NotifyUnspawn).forEach((t=>{t[c.NotifyUnspawn.onUnspawn](this,e)}))}onDestroy(e,t,i){this.traits.filter(n.NotifyDestroy).forEach((r=>{r[n.NotifyDestroy.onDestroy](this,e,t,i)}))}onOwnerChange(e,t){this.traits.filter(o.NotifyOwnerChange).forEach((i=>{i[o.NotifyOwnerChange.onChange](this,e,t)}))}onAttack(e,t){this.traits.filter(h.NotifyAttack).forEach((i=>{i[h.NotifyAttack.onAttack](this,t,e)}))}addTrait(e){this.traits.add(e),e[s.NotifyTick.onTick]&&this.cachedTraits.tick.push(e)}getUiName(){return this.rules.uiName}getHash(){var e=this.position.worldPosition;return a.fnv32a([this.id,...new Uint8Array(new Float64Array([e.x,e.y,e.z]).buffer),...this.traits.getAll().map((e=>e.getHash?.()??0))])}debugGetState(){return{id:this.id,position:this.position.worldPosition.toArray(),traits:this.traits.getAll().reduce(((e,t)=>{var i=t.debugGetState?.();return void 0!==i&&(e[t.constructor.name]=i),e}),{})}}dispose(){this.isDisposed=!0,this.traits.dispose(),this.cachedTraits.tick.length=0}})}}})),System.register("game/World",["util/event"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("World",class{constructor(){this.allObjects=new Map,this._onObjectSpawned=new i.EventDispatcher,this._onObjectRemoved=new i.EventDispatcher}get onObjectSpawned(){return this._onObjectSpawned.asEvent()}get onObjectRemoved(){return this._onObjectRemoved.asEvent()}spawnObject(e){if(this.allObjects.has(e.id))throw new Error("Trying to add an already existing object");this.allObjects.set(e.id,e),this._onObjectSpawned.dispatch(this,e)}removeObject(e){if(!this.allObjects.has(e.id))throw new Error("Trying to remove non-existent object");this.allObjects.delete(e.id),this._onObjectRemoved.dispatch(this,e)}hasObjectId(e){return this.allObjects.has(e)}getObjectById(e){if(!this.allObjects.has(e))throw new Error(`Object with id ${e} doesn't exist`);return this.allObjects.get(e)}getAllObjects(){return[...this.allObjects.values()]}})}}})),System.register("engine/gfx/RenderableContainer",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RenderableContainer",class{constructor(e){this.children=new Set,this.renderQueue=[],e&&this.set3DObject(e)}set3DObject(e){this.container=e}get3DObject(){return this.container}getChildren(){return[...this.children]}add(...e){for(var t of e)this.children.has(t)||(this.children.add(t),this.renderQueue.push(t))}remove(...e){for(var t of e){var i;this.children.has(t)&&(this.children.delete(t),-1===(i=this.renderQueue.indexOf(t))?(t=t.get3DObject())&&t.parent&&this.get3DObject().remove(t):this.renderQueue.splice(i,1))}}removeAll(){this.remove(...this.children)}processRenderQueue(){if(!this.get3DObject())throw new Error("A THREE.Object3D must be passed in the constructor or using the setter.");let e;for(;e=this.renderQueue.shift();){e.create3DObject();var t=e.get3DObject();t&&this.get3DObject().add(t)}}create3DObject(){this.processRenderQueue()}update(e,t){for(var i of(this.renderQueue.length&&this.processRenderQueue(),this.children))this.renderQueue.length&&this.processRenderQueue(),i.update(e,t)}})}}})),System.register("engine/renderable/CameraPan",["util/math"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("CameraPan",class{constructor(e){this.freeCamera=e,this.pan={x:0,y:0}}setPanLimits(e){this.panLimits=e,this.setPan({x:this.pan.x,y:this.pan.y})}getPanLimits(){return{...this.panLimits}}getPan(){return{...this.pan}}setPan(e){this.panLimits&&!this.freeCamera.value&&(e.x=i.clamp(e.x,this.panLimits.x,this.panLimits.x+this.panLimits.width),e.y=i.clamp(e.y,this.panLimits.y,this.panLimits.y+this.panLimits.height)),this.pan={x:e.x,y:e.y}}})}}})),System.register("engine/renderable/CameraZoom",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CameraZoom",class{constructor(e){this.freeCamera=e,this.zoom=1}getZoom(){return this.zoom}applyStep(e){this.freeCamera.value&&(this.zoom=Math.max(.1,this.zoom+e))}})}}})),System.register("engine/Lighting",["engine/type/LightingType","data/map/MapLighting","util/event","util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=new THREE.Vector3,e("Lighting",class{constructor(e){if(this.baseAmbient=new r.MapLighting,this.tileLights=new Map,this.disposables=new n.CompositeDisposable,this._onChange=new s.EventDispatcher,e){this.baseAmbient.copy(e.getAmbient());let t=e=>{this.baseAmbient.copy(e),this._onChange.dispatch(this,void 0)};e.onChange.subscribe(t),this.disposables.add((()=>e.onChange.unsubscribe(t)))}}get onChange(){return this._onChange.asEvent()}get mapLighting(){return this.ambientOverride??this.baseAmbient}forceUpdate(e){this._onChange.dispatch(this,e)}applyAmbientOverride(e){this.ambientOverride=e,this._onChange.dispatch(this,void 0)}getBaseAmbient(){return(new r.MapLighting).copy(this.baseAmbient)}addTileLight(e,t){this.tileLights.has(e)||this.tileLights.set(e,new Set),this.tileLights.get(e).add(t)}removeTileLight(e,t){let i=this.tileLights.get(e);i&&(i.delete(t),i.size||this.tileLights.delete(e))}compute(e,t,r=0){return e===i.LightingType.None?new THREE.Vector3(1,1,1):this.computeTint(e).add(this.computeTileTint(t,e,a)).multiplyScalar(this.mapLighting.ambient+this.mapLighting.ground+this.computeLevel(e,t.z+r)+this.computeTileLightIntensity(t))}computeNoAmbient(e,t,i=0){return this.computeLevel(e,t.z+i)+this.computeTileLightIntensity(t)}computeLevel(e,t){return e>=i.LightingType.Level?this.mapLighting.level*(t-1):0}computeTint(e){let t=1,r=1,s=1;return(e>=i.LightingType.Full||this.mapLighting.forceTint)&&(t=this.mapLighting.red,r=this.mapLighting.green,s=this.mapLighting.blue),new THREE.Vector3(t,r,s)}computeTileTint(e,t,r=new THREE.Vector3){let s=0,n=0,a=0;if(t>=i.LightingType.Full){var o=this.tileLights.get(e);if(o?.size)for(var l of o)s+=l.red,n+=l.green,a+=l.blue}return r.set(s,n,a)}computeTileLightIntensity(e){let t=0;var i=this.tileLights.get(e);if(i?.size)for(var r of i)t+=r.intensity;return t}getAmbientIntensity(){return this.mapLighting.ambient+this.mapLighting.ground}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/entity/unit/ShadowQuality",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Off=0]="Off",t[t.Low=1]="Low",t[t.Medium=2]="Medium",t[t.High=3]="High",e("ShadowQuality",i)}}})),System.register("engine/gfx/batch/BatchedMesh",[],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Instancing=0]="Instancing",t[t.Merging=1]="Merging",e("BatchMode",i),r=class extends THREE.Mesh{constructor(e,t,r=i.Instancing){super(e,t),this.geometry=e,this.material=t,this.batchMode=r,this.isBatchedMesh=!0,this.castShadow=!1,this.opacity=1,this.extraLight=new THREE.Vector3(0,0,0),this.paletteIndex=0,this.clippingPlanes=[],this.clippingPlanesHash="",this.layers.disable(0)}getOpacity(){return this.opacity}setOpacity(e){this.opacity=e}getExtraLight(){return this.extraLight}setExtraLight(e){this.extraLight=e}getPaletteIndex(){return this.paletteIndex}setPaletteIndex(e){this.paletteIndex=e}getClippingPlanes(){return this.clippingPlanes}setClippingPlanes(e){this.clippingPlanes=e,this.updateClippingPlanesHash(e)}updateClippingPlanesHash(e){this.clippingPlanesHash=e.map((e=>[...e.normal.toArray(),e.constant])).flat().join(",")}getClippingPlanesHash(){return this.clippingPlanesHash}},e("BatchedMesh",r)}}})),System.register("engine/gfx/material/paletteShaderLib",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("paletteShaderLib",{uniforms:{palette:{type:"t",value:null},paletteOffsetCount:{value:[0,1]},extraLight:{value:new THREE.Vector3(0,0,0)}},instanceParsVertex:"\n#ifdef INSTANCE_TRANSFORM\n    attribute float instancePaletteOffset;\n    varying float vInstancePaletteOffset;\n    attribute vec3 instanceExtraLight;\n    varying vec3 vInstanceExtraLight;\n#endif\n",instanceVertex:"\n  #ifdef INSTANCE_TRANSFORM\n    vInstancePaletteOffset = instancePaletteOffset;\n    vInstanceExtraLight = instanceExtraLight;\n  #endif\n",paletteColorParsVertex:"\n#ifdef VERTEX_PALETTE_OFFSET\n    attribute float vertexPaletteOffset;\n    varying float vVertexPaletteOffset;\n#endif\n",paletteColorVertex:"\n  #ifdef VERTEX_PALETTE_OFFSET\n    vVertexPaletteOffset = vertexPaletteOffset;\n  #endif\n",paletteColorParsFrag:"\nuniform sampler2D palette;\n#ifdef VERTEX_PALETTE_OFFSET\n    varying float vVertexPaletteOffset;\n#endif\nuniform vec2 paletteOffsetCount;\nuniform vec3 extraLight;\n\n#ifdef INSTANCE_TRANSFORM\nvarying float vInstancePaletteOffset;\nvarying vec3 vInstanceExtraLight;\n#endif\n",paletteColorFrag:"\n  float paletteColorIndex;\n\n  #ifdef USE_MAP\n  paletteColorIndex = texelColor.a;\n  #endif\n\n  #ifdef USE_COLOR\n  paletteColorIndex = vColor.r;\n  #endif\n\n  #ifdef INSTANCE_TRANSFORM\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vInstancePaletteOffset + 0.5) / paletteOffsetCount.y));\n  #elif defined(VERTEX_PALETTE_OFFSET)\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (vVertexPaletteOffset + 0.5) / paletteOffsetCount.y));\n  #else\n  diffuseColor = texture2D(palette, vec2(paletteColorIndex, (paletteOffsetCount.x + 0.5) / paletteOffsetCount.y));\n  #endif\n\n  #ifdef INSTANCE_OPACITY\n  diffuseColor.a *= vInstanceOpacity * opacity;\n  #else\n  diffuseColor.a *= opacity;\n  #endif\n  diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n",paletteBasicLightFragment:"\n  #ifdef INSTANCE_TRANSFORM\n  diffuseColor.rgb += vInstanceExtraLight.rgb * diffuseColor.rgb;\n  #else\n  diffuseColor.rgb += extraLight.rgb * diffuseColor.rgb;\n  #endif\n\n  diffuseColor = clamp(diffuseColor, 0.0, 1.0);\n",paletteFullLightFragment:"\n  #ifdef INSTANCE_TRANSFORM\n  vec3 extraIrradiance = vInstanceExtraLight.rgb;\n  #else\n  vec3 extraIrradiance = extraLight.rgb;\n  #endif\n\n  #if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n    #pragma unroll_loop\n    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n      directionalLight = directionalLights[ i ];\n      getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\n      directLight.color = extraIrradiance;\n      RE_Direct( directLight, geometry, material, reflectedLight );\n    }\n  #endif\n\n  #if defined( RE_IndirectDiffuse )\n  RE_IndirectDiffuse( extraIrradiance, geometry, material, reflectedLight );\n  #endif\n",vertexColorMultParsVertex:"\n#ifdef USE_VERTEX_COLOR_MULT\nattribute vec4 vertexColorMult;\nvarying vec4 vVertexColorMult;\n#endif\n",vertexColorMultVertex:"\n  #ifdef USE_VERTEX_COLOR_MULT\n  vVertexColorMult = vertexColorMult;\n  #endif\n",vertexColorMultParsFrag:"\n#ifdef USE_VERTEX_COLOR_MULT\nvarying vec4 vVertexColorMult;\n#endif\n",vertexColorMultFrag:"\n  #ifdef USE_VERTEX_COLOR_MULT\n  diffuseColor.rgba *= vVertexColorMult.rgba;\n  #endif\n"})}}})),System.register("engine/gfx/material/PalettePhongMaterial",["engine/gfx/material/paletteShaderLib"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.phong.uniforms,i.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshphong_vert.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+i.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshphong_frag.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+i.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+i.paletteShaderLib.paletteFullLightFragment)},s=class extends THREE.MeshPhongMaterial{constructor({palette:e,paletteCount:t,paletteOffset:i,extraLight:s,...n}={}){super(n),this.uniforms=THREE.UniformsUtils.clone(r.uniforms),e&&(this.palette=e),t&&(this.paletteCount=t),i&&(this.paletteOffset=i),s&&this.extraLight.copy(s),this.vertexShader=r.vertexShader,this.fragmentShader=r.fragmentShader,this.type="PalettePhongMaterial"}get palette(){return this.uniforms.palette.value}set palette(e){this.uniforms.palette.value=e}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(e){this.uniforms.paletteOffsetCount.value[0]=e}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(e){this.uniforms.paletteOffsetCount.value[1]=e}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(e){this.uniforms.extraLight.value=e}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.palette=e.palette,this}},e("PalettePhongMaterial",s)}}})),System.register("engine/gfx/batch/InstancedMesh",[],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[],execute:function(){(i=new THREE.MeshDepthMaterial).depthPacking=THREE.RGBADepthPacking,i.clipping=!0,i.defines={INSTANCE_TRANSFORM:""},a=THREE.ShaderLib.distanceRGBA,r=THREE.UniformsUtils.clone(a.uniforms),s={USE_SHADOWMAP:"",INSTANCE_TRANSFORM:""},n=new THREE.ShaderMaterial({defines:s,uniforms:r,vertexShader:a.vertexShader,fragmentShader:a.fragmentShader,clipping:!0}),a=class extends THREE.Mesh{constructor(e,t,r,s,a=!1){super((new THREE.InstancedBufferGeometry).copy(e)),this.maxInstances=r,this.uniformScale=s,this.useInstanceColor=a,this.initAttributes(this.geometry),this.material=this.decorateMaterial(t.clone()),this.frustumCulled=!1,this.customDepthMaterial=i,this.customDistanceMaterial=n}initAttributes(e){let t=[];for(let e=0;e<4;e++)t.push({name:"instanceMatrix"+e,data:new Float32Array(4*this.maxInstances),itemSize:4,normalized:!0});for(var{name:i,data:r,itemSize:s,normalized:n}of(this.useInstanceColor&&t.push({name:"instanceColor",data:new Uint8Array(3*this.maxInstances),itemSize:3,normalized:!0}),t.push({name:"instanceOpacity",data:new Float32Array(this.maxInstances).fill(1),itemSize:1,normalized:!0}),t)){let t=new THREE.InstancedBufferAttribute(r,s,n,1);t.dynamic=!0,e.addAttribute(i,t)}this.instanceMatrixAttributes=new Array(4).fill(0).map(((t,i)=>e.getAttribute("instanceMatrix"+i)))}decorateMaterial(e){let t=e;return t.defines??(t.defines={}),t.defines.INSTANCE_TRANSFORM="",this.uniformScale?t.defines.INSTANCE_UNIFORM="":delete t.defines.INSTANCE_UNIFORM,this.useInstanceColor?t.defines.INSTANCE_COLOR="":delete t.defines.INSTANCE_COLOR,t.defines.INSTANCE_OPACITY="",e}setRenderCount(e){if(e>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");this.geometry.maxInstancedCount=e}setMatrixAt(e,t){for(let r=0;r<4;r++){var i=4*r;this.instanceMatrixAttributes[r].setXYZW(e,t.elements[i++],t.elements[i++],t.elements[i++],t.elements[+i])}}updateFromMeshes(e){var t,i=!!e[0].material.palette,r=this.geometry.attributes;let s=r.instanceOpacity,n=r.instancePaletteOffset,a=r.instanceExtraLight;for(let t=0,r=e.length;t<r;t++){let r=e[t];this.setMatrixAt(t,r.matrixWorld);var o,l,c=r.getOpacity();s.getX(t)!==c&&(s.setX(t,c),s.needsUpdate=!0),i&&(o=r.getPaletteIndex(),n.getX(t)!==o&&(n.setX(t,o),n.needsUpdate=!0),l=r.getExtraLight(),c=Math.fround(l.x),o=Math.fround(l.y),l=Math.fround(l.z),c===a.getX(t)&&o===a.getY(t)&&l===a.getZ(t)||(a.setXYZ(t,c,o,l),a.needsUpdate=!0))}for(t of(this.setRenderCount(e.length),this.instanceMatrixAttributes))t.needsUpdate=!0}dispose(){this.geometry.dispose(),this.material.dispose()}},e("InstancedMesh",a)}}})),System.register("engine/gfx/batch/MeshInstancingBatch",["engine/gfx/batch/InstancedMesh"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MeshInstancingBatch",class{constructor(e){this.maxInstances=e,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e,this.instancedMesh&&(this.instancedMesh.castShadow=e)}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e,this.instancedMesh&&(this.instancedMesh.receiveShadow=e)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(e){this._clippingPlanes=e,this.instancedMesh&&(this.instancedMesh.material.clippingPlanes=e)}get renderOrder(){return this._renderOrder}set renderOrder(e){this._renderOrder=e,this.instancedMesh&&(this.instancedMesh.renderOrder=e)}get3DObject(){return this.target}create3DObject(){if(!this.target){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,this.target=e,this.instancedMesh&&e.add(this.instancedMesh)}}setMeshes(e){if(e.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");var t;e.length?(t=!!e[0].material.palette,this.instancedMesh||(this.instancedMesh=new i.InstancedMesh(e[0].geometry,e[0].material,this.maxInstances,!0),this.instancedMesh.castShadow=this._castShadow,this.instancedMesh.renderOrder=this._renderOrder,this.instancedMesh.material.clippingPlanes=this._clippingPlanes,t&&(this.instancedMesh.geometry.addAttribute("instancePaletteOffset",new THREE.InstancedBufferAttribute(new Float32Array(this.maxInstances),1)),this.instancedMesh.geometry.addAttribute("instanceExtraLight",new THREE.InstancedBufferAttribute(new Float32Array(3*this.maxInstances),3))),this.target?.add(this.instancedMesh)),this.instancedMesh.updateFromMeshes(e)):this.instancedMesh&&(this.target?.remove(this.instancedMesh),this.instancedMesh.dispose(),this.instancedMesh=void 0)}update(){}dispose(){this.instancedMesh?.dispose()}})}}})),System.register("engine/gfx/material/PaletteBasicMaterial",["engine/gfx/material/paletteShaderLib"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.basic.uniforms,i.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshbasic_vert.replace("#include <common>","#include <common>\n"+[i.paletteShaderLib.instanceParsVertex,i.paletteShaderLib.paletteColorParsVertex,i.paletteShaderLib.vertexColorMultParsVertex].join("\n")).replace("void main() {","void main() {\n"+[i.paletteShaderLib.instanceVertex,i.paletteShaderLib.paletteColorVertex,i.paletteShaderLib.vertexColorMultVertex].join("\n")),fragmentShader:THREE.ShaderChunk.meshbasic_frag.replace("#include <common>","#include <common>\n"+[i.paletteShaderLib.paletteColorParsFrag,i.paletteShaderLib.vertexColorMultParsFrag].join("\n")).replace("#include <color_fragment>","#include <color_fragment>\n"+[i.paletteShaderLib.paletteColorFrag,i.paletteShaderLib.paletteBasicLightFragment,i.paletteShaderLib.vertexColorMultFrag].join("\n"))},s=class extends THREE.MeshBasicMaterial{constructor({palette:e,paletteCount:t,paletteOffset:i,extraLight:s,useVertexColorMult:n,...a}={}){super(a),this.uniforms=THREE.UniformsUtils.clone(r.uniforms),e&&(this.palette=e),t&&(this.paletteCount=t),i&&(this.paletteOffset=i),s&&this.extraLight.copy(s),n&&(this.useVertexColorMult=n),this.vertexShader=r.vertexShader,this.fragmentShader=r.fragmentShader,this.type="PaletteBasicMaterial"}get palette(){return this.uniforms.palette.value}set palette(e){this.uniforms.palette.value=e}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(e){this.uniforms.paletteOffsetCount.value[0]=e}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(e){this.uniforms.paletteOffsetCount.value[1]=e}get extraLight(){return this.uniforms.extraLight.value}set extraLight(e){this.uniforms.extraLight.value=e}set useVertexColorMult(e){e?(this.defines??(this.defines={}),this.defines.USE_VERTEX_COLOR_MULT=""):this.defines&&delete this.defines.USE_VERTEX_COLOR_MULT}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.palette=e.palette,this}},e("PaletteBasicMaterial",s)}}})),System.register("engine/gfx/batch/MergedSpriteMesh",["util/array","engine/gfx/material/PaletteBasicMaterial"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=new THREE.Vector3,n=new THREE.Vector4,a=class e extends THREE.Mesh{constructor(t,i,r){super(e.createMergedGeometry(t,r,i)),this.maxInstances=r,this.material=this.decorateMaterial(i.clone()),this.verticesPerItem=t.getAttribute("position").count,this.indicesPerItem=t.index?.count,this.frustumCulled=!1}static createMergedGeometry(e,t,i){let s=new THREE.BufferGeometry;for(var n of Object.keys(e.attributes)){let i=e.getAttribute(n);var a=new i.array.constructor(t*i.array.length);s.addAttribute(n,new THREE.BufferAttribute(a,i.itemSize,i.normalized))}var o,l=e.getAttribute("position").count;for(o of(i instanceof r.PaletteBasicMaterial&&s.addAttribute("vertexColorMult",new THREE.BufferAttribute(new Float32Array(l*t*4),4)),i.palette&&s.addAttribute("vertexPaletteOffset",new THREE.BufferAttribute(new Float32Array(l*t),1)),Object.values(s.attributes)))o.setDynamic(!0);if(e.index){s.setIndex(new THREE.BufferAttribute(new Uint32Array(t*e.index.array.length),1));for(let i=0;i<t;i++){let t=i*l;s.index.array.set(Uint32Array.from(e.index.array,(e=>e+t)),i*e.index.array.length)}}return s}decorateMaterial(e){let t=e;return t.defines??(t.defines={}),e.palette&&(t.defines.VERTEX_PALETTE_OFFSET=""),e instanceof r.PaletteBasicMaterial&&(t.useVertexColorMult=!0),e}updateFromMeshes(e){var t,i=this.geometry.attributes,r=i.position,a=i.uv,o=i.vertexColorMult,l=i.vertexPaletteOffset,c=e.length;if(c>this.maxInstances)throw new RangeError("Exceeded maximum number of instances");for(let t=0;t<c;t++){var h=t*this.verticesPerItem;let i=e[t];this.setGeometryAt(h,i.geometry,s.setFromMatrixPosition(i.matrixWorld),r,a);var u=i.getExtraLight();o&&this.setColorMultAt(h,n.set(1+u.x,1+u.y,1+u.z,i.getOpacity()),o),l&&this.setPaletteIndexAt(h,i.getPaletteIndex(),l)}for(t of(this.geometry.setDrawRange(0,c*(this.geometry.index?this.indicesPerItem:this.verticesPerItem)),Object.values(i)))t.dynamic&&(t.updateRange.count=c<this.maxInstances?c*this.verticesPerItem*t.itemSize:-1)}setGeometryAt(e,t,r,s,n){var a=t.attributes,o=a.position.array;let l=s.array;for(let t=0;t<this.verticesPerItem;t++){var c=3*(e+t),h=Math.fround(o[3*t]+Math.fround(r.x)),u=Math.fround(o[3*t+1]+Math.fround(r.y)),d=Math.fround(o[3*t+2]+Math.fround(r.z));h===l[c]&&u===l[1+c]&&d===l[2+c]||(l[c]=h,l[1+c]=u,l[2+c]=d,s.needsUpdate=!0)}let g=n.array;a=a.uv.array,i.equals(a,g.subarray(2*e,2*e+a.length))||(g.set(a,2*e),n.needsUpdate=!0)}setColorMultAt(e,t,i){if(i.getX(e)!==t.x||i.getY(e)!==t.y||i.getZ(e)!==t.z||i.getW(e)!==t.w){i.needsUpdate=!0;for(let r=0;r<this.verticesPerItem;r++)i.setXYZW(e+r,t.x,t.y,t.z,t.w)}}setPaletteIndexAt(e,t,i){if(i.getX(e)!==t){i.needsUpdate=!0;for(let r=0;r<this.verticesPerItem;r++)i.setX(e+r,t)}}dispose(){this.geometry.dispose(),this.material.dispose()}},e("MergedSpriteMesh",a)}}})),System.register("engine/gfx/batch/MeshMergingBatch",["engine/gfx/batch/MergedSpriteMesh"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MeshMergingBatch",class{constructor(e){this.maxInstances=e,this._castShadow=!1,this._receiveShadow=!1,this._clippingPlanes=[],this._renderOrder=0}get castShadow(){return this._castShadow}set castShadow(e){this._castShadow=e,this.mergedGeoMesh&&(this.mergedGeoMesh.castShadow=e)}get receiveShadow(){return this._receiveShadow}set receiveShadow(e){this._receiveShadow=e,this.mergedGeoMesh&&(this.mergedGeoMesh.receiveShadow=e)}get clippingPlanes(){return this._clippingPlanes}set clippingPlanes(e){this._clippingPlanes=e,this.mergedGeoMesh&&(this.mergedGeoMesh.material.clippingPlanes=e)}get renderOrder(){return this._renderOrder}set renderOrder(e){this._renderOrder=e,this.mergedGeoMesh&&(this.mergedGeoMesh.renderOrder=e)}get3DObject(){return this.target}create3DObject(){if(!this.target){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,this.target=e,this.mergedGeoMesh&&e.add(this.mergedGeoMesh)}}setMeshes(e){if(e.length>this.maxInstances)throw new RangeError("Meshes array exceeds max number of instances");e.length?(this.mergedGeoMesh||(this.mergedGeoMesh=new i.MergedSpriteMesh(e[0].geometry,e[0].material,this.maxInstances),this.mergedGeoMesh.castShadow=this._castShadow,this.mergedGeoMesh.receiveShadow=this._receiveShadow,this.mergedGeoMesh.renderOrder=this._renderOrder,this.mergedGeoMesh.material.clippingPlanes=this._clippingPlanes,this.target?.add(this.mergedGeoMesh)),this.mergedGeoMesh.updateFromMeshes(e)):this.mergedGeoMesh&&(this.target?.remove(this.mergedGeoMesh),this.mergedGeoMesh.dispose(),this.mergedGeoMesh=void 0)}update(){}dispose(){this.mergedGeoMesh?.dispose()}})}}})),System.register("engine/gfx/batch/MeshBatchManager",["engine/gfx/batch/BatchedMesh","engine/gfx/batch/MeshInstancingBatch","engine/gfx/RenderableContainer","engine/gfx/batch/MeshMergingBatch"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends s.RenderableContainer{constructor(e){super(),this.renderableContainer=e,this.batches=new Map}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="mesh_batch_manager",e.matrixAutoUpdate=!1,this.set3DObject(e)),super.create3DObject()}updateMeshes(){var e=this.renderableContainer.get3DObject();e&&(e=this.collectMeshes(e),e=this.fillBatches(this.groupMeshesByBatchKey(e)),this.cleanUnusedBatches(e))}collectMeshes(e){let t=[];return e.traverseVisible((e=>{e.isBatchedMesh&&t.push(e)})),t}fillBatches(e){let t=new Map([...this.batches.keys()].map((e=>[e,0])));for(var[s,a]of e){let e=this.batches.get(s),c=0;for(;a.length;){var o=a[0].batchMode===i.BatchMode.Instancing,l=o?1024:128;let t=a.splice(0,l),h=e?.[c];h||(e||(e=[],this.batches.set(s,e)),h=new(o?r.MeshInstancingBatch:n.MeshMergingBatch)(l),h.castShadow=t[0].castShadow,h.receiveShadow=t[0].receiveShadow,h.renderOrder=t[0].renderOrder,h.clippingPlanes=t[0].getClippingPlanes(),e.push(h),this.add(h),this.processRenderQueue()),h.setMeshes(t),c++}t.set(s,c)}return t}cleanUnusedBatches(e){for(var[t,i]of e){let e=this.batches.get(t);if(e){var r;for(r of e.splice(i))this.remove(r),r.dispose();e.length||this.batches.delete(t)}}}groupMeshesByBatchKey(e){let t=new Map;for(let s=0,n=e.length;s<n;s++){var i=e[s],r=this.getBatchKey(i);let n=t.get(r);n||(n=[],t.set(r,n)),n.push(i)}return t}getBatchKey(e){return e.batchMode+"_"+(e.batchMode===i.BatchMode.Instancing?e.geometry.uuid:e.geometry.attributes.position.count)+"_"+e.material.uuid+"_"+Number(e.castShadow)+"_"+e.renderOrder+"_"+Number(e.receiveShadow)+"_"+e.getClippingPlanesHash()}dispose(){this.batches.forEach((e=>e.forEach((e=>e.dispose()))))}},e("MeshBatchManager",a)}}})),System.register("engine/renderable/WorldScene",["util/geometry","engine/gfx/RenderableContainer","engine/renderable/CameraPan","engine/renderable/CameraZoom","engine/type/LightingType","game/Coords","util/event","engine/renderable/entity/unit/ShadowQuality","engine/gfx/batch/MeshBatchManager"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){.8,16e3,u=new Map([[c.ShadowQuality.High,8],[c.ShadowQuality.Medium,4],[c.ShadowQuality.Low,2]]),d=class e extends r.RenderableContainer{constructor(e,t,i,r,s,n){super(e),this.scene=e,this.camera=t,this.viewport=i,this.cameraPan=r,this.cameraZoom=s,this.shadowQuality=n,this.initialized=!1,this.ambientLight=new THREE.AmbientLight(16777215,.8),this.directionalLight=new THREE.DirectionalLight(16777215,1),this._onBeforeCameraUpdate=new l.EventDispatcher,this._onCameraUpdate=new l.EventDispatcher}get onBeforeCameraUpdate(){return this._onBeforeCameraUpdate.asEvent()}get onCameraUpdate(){return this._onCameraUpdate.asEvent()}static factory(t,i,r){let a=new THREE.Scene;a.matrixAutoUpdate=!1;var o=e.createCamera(t),l=new s.CameraPan(i),c=new n.CameraZoom(i);return new e(a,o,t,l,c,r)}static getCameraParams(e){var t=o.Coords.ISO_CAMERA_ALPHA,i=o.Coords.ISO_CAMERA_BETA,r=o.Coords.ISO_WORLD_SCALE;return{alpha:t,beta:i,d:e.height/2*o.Coords.COS_ISO_CAMERA_BETA*r,aspect:e.width/e.height,far:16e3*r}}static createCamera(e){var{alpha:t,beta:i,d:r,aspect:s,far:n}=this.getCameraParams(e);let a=new THREE.OrthographicCamera(-r*s,r*s,r,-r,0,n);return a.rotation.order="YXZ",a.rotation.y=+i,a.rotation.x=-t,a}updateViewport(t){this.viewport=t;var{d:i,aspect:r}=e.getCameraParams(t);let s=this.camera;s.left=-i*r,s.right=i*r,s.top=i,s.bottom=-i,s.updateProjectionMatrix()}updateCamera(e,t){let i=this.camera;i.updateMatrix();var r=i.matrix.elements;let s=new THREE.Vector3;i.position.set(0,0,0),i.translateZ(16e3*o.Coords.ISO_WORLD_SCALE),s.set(r[0],r[1],r[2]),s.multiplyScalar(e.x*(i.right-i.left)/this.viewport.width/i.zoom),i.position.add(s),s.set(r[4],r[5],r[6]),s.multiplyScalar(-e.y*(i.top-i.bottom)/this.viewport.height/i.zoom),i.position.add(s),i.zoom=t,i.updateProjectionMatrix(),i.updateMatrixWorld(!1)}create3DObject(){if(super.create3DObject(),!this.initialized){this.initialized=!0,this.scene.position.x-=.1*o.Coords.ISO_WORLD_SCALE,this.scene.position.z-=.1*o.Coords.ISO_WORLD_SCALE,this.scene.updateMatrix();var e=new THREE.AxesHelper(o.Coords.LEPTONS_PER_TILE);this.scene.add(e),this.scene.add(this.ambientLight);let t=this.directionalLight;t.position.set(-87.012,204.338,195.409),this.lightFocusPoint&&(t.position.x+=this.lightFocusPoint.x,t.position.z+=this.lightFocusPoint.y,t.target.position.set(this.lightFocusPoint.x,0,this.lightFocusPoint.y),t.target.updateMatrixWorld(void 0)),this.updateShadowQuality(t,this.shadowQuality.value),this.shadowQualityListener=()=>this.updateShadowQuality(t,this.shadowQuality.value),this.shadowQuality.onChange.subscribe(this.shadowQualityListener),this.scene.add(t),this.scene.add(this.camera),e=this.meshBatchManager=new h.MeshBatchManager(this),this.add(e),this.scene.autoUpdate=!1}}updateShadowQuality(e,t){var i=t!==c.ShadowQuality.Off;if(e.castShadow=i){var r=o.Coords.ISO_WORLD_SCALE;i=3500*r;let s=e.shadow.camera;if(s.right=i,s.left=-i,s.top=i,s.bottom=-i,s.near=-4e3*r,s.far=3e3*r,!(r=u.get(t)))throw new Error(`Unsupported shadow quality "${t}"`);e.shadow.mapSize.width=1024*r,e.shadow.mapSize.height=1024*r}}setLightFocusPoint(e,t){this.lightFocusPoint={x:e,y:t}}applyLighting(e){var t=e.computeTint(a.LightingType.Ambient);this.ambientLight.color.setRGB(t.x,t.y,t.z),this.directionalLight.color.setRGB(t.x,t.y,t.z),t=e.getAmbientIntensity(),this.ambientLight.intensity=.8*t,this.directionalLight.intensity=t}update(e,t){super.update(e,t),this._onBeforeCameraUpdate.dispatch(this,e);var r=this.cameraZoom.getZoom(),s=this.cameraPan.getPan();i.pointEquals(s,this.lastCameraPan)&&this.lastCameraZoom===r||(this.updateCamera(s,r),this.lastCameraZoom=r,this.lastCameraPan=s),this._onCameraUpdate.dispatch(this,e),this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes()}dispose(){this.shadowQualityListener&&(this.shadowQuality.onChange.unsubscribe(this.shadowQualityListener),this.shadowQualityListener=void 0),this.directionalLight.shadow.map?.dispose(),this.meshBatchManager&&(this.meshBatchManager.dispose(),this.remove(this.meshBatchManager),this.meshBatchManager=void 0),this.scene.remove(this.ambientLight),this.scene.remove(this.directionalLight)}},e("WorldScene",d)}}})),System.register("engine/gfx/FrustumCuller",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("FrustumCuller",class{cull(e,t){var i=[];return function e(t,i,r,s=0){let n,a=t.children;var o,l=t.visible;if(i.intersectsBox(t.box)){if(t.visible=!0,null!==a)for(n=0,o=a.length;n<o;++n)a[n].isOctree?e(a[n],i,r,s+1):!l&&t.config.skipInvisMatrixUpdate&&a[n].updateMatrixWorld(!1);r.push(t)}else t.visible=!1}(e,t,i),i}})}}})),System.register("engine/gfx/OctreeContainer",["engine/gfx/RenderableContainer","engine/gfx/FrustumCuller","game/Coords"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){3,a=class e extends i.RenderableContainer{constructor(e,t,i){super(e),this.autoCull=!0,this.lastCameraPosition=new THREE.Vector3,this.tree=e,this.frustumCuller=t,this.camera=i}static factory(t){var{near:i,far:s}=t,n=new THREE.Box3(new THREE.Vector3(2*i,2*i,2*i),new THREE.Vector3(2*s,2*s,2*s));let a=new Octree(n,{maxDepth:Math.ceil(Math.log2(2*(s-i)/128)),splitThreshold:10,joinThreshold:5,skipInvisMatrixUpdate:!0});return a.name="octree",i=new r.FrustumCuller,new e(a,i,t)}update(e,t){super.update(e,t),this.autoCull&&this.cullChildren()}cullChildren(){if(!this.camera.position.equals(this.lastCameraPosition)){this.lastCameraPosition.copy(this.camera.position);var e=this.computeProjectionMatrix();this.camera.updateMatrixWorld(!1),this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld),e=(new THREE.Matrix4).multiplyMatrices(e,this.camera.matrixWorldInverse);let t=new THREE.Frustum;t.setFromMatrix(e),this.frustumCuller.cull(this.tree,t)}}computeProjectionMatrix(){return n?n.copy(this.camera):n=this.camera.clone(),n.top+=3*s.Coords.LEPTONS_PER_TILE*s.Coords.COS_ISO_CAMERA_BETA,n.bottom-=3*s.Coords.LEPTONS_PER_TILE*s.Coords.COS_ISO_CAMERA_BETA,n.left-=2*s.Coords.LEPTONS_PER_TILE*3*s.Coords.COS_ISO_CAMERA_BETA,n.right+=2*s.Coords.LEPTONS_PER_TILE*3*s.Coords.COS_ISO_CAMERA_BETA,n.updateProjectionMatrix(),n.projectionMatrix}updateChild(e){var t=e.get3DObject();t&&t.parent&&this.tree.updateObject(t)}},e("OctreeContainer",a)}}})),System.register("engine/renderable/Entity",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gfx/CanvasUtils",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CanvasUtils",class{static canvasFromRgbImageData(e,t,i){let r=document.createElement("canvas"),s=r.getContext("2d");if(!s)throw new Error("Couldn't acquire canvas 2d context");let n=s.createImageData(t,i);r.width=t,r.height=i;let a=0;for(let t=0,i=e.length;t<i;t+=3)n.data[a]=e[t],n.data[a+1]=e[t+1],n.data[a+2]=e[t+2],n.data[a+3]=255,a+=4;return s.putImageData(n,0,0),r}static canvasFromRgbaImageData(e,t,i){let r=document.createElement("canvas"),s=r.getContext("2d");if(!s)throw new Error("Couldn't acquire canvas 2d context");let n=s.createImageData(t,i);r.width=t,r.height=i;let a=0;for(let t=0,i=e.length;t<i;t+=4)n.data[a]=e[t],n.data[a+1]=e[t+1],n.data[a+2]=e[t+2],n.data[a+3]=e[t+3],a+=4;return s.putImageData(n,0,0),r}static canvasFromIndexedImageData(e,t,i,r){let s=document.createElement("canvas"),n=s.getContext("2d");if(!n)throw new Error("Couldn't acquire canvas 2d context");let a=n.createImageData(t,i);s.width=t,s.height=i;let o=0;return e.forEach((e=>{var{r:t,g:i,b:s}=r.getColor(e);a.data[o++]=t,a.data[o++]=i,a.data[o++]=s,a.data[o++]=e?255:0})),n.putImageData(a,0,0),s}static async canvasToBlob(e){return await new Promise(((t,i)=>{e.toBlob((r=>{if(!r)try{r=this.dataUrlToBlob(e.toDataURL())}catch(r){return void i(new Error("Failed to generate image from canvas using fallback",{cause:r}))}t(r)}))}))}static dataUrlToBlob(e){if(!(r=e.match(/^data:((.*?)(;charset=.*?)?)(;base64)?,/)))throw new Error("invalid dataURI");var t=r[2]?r[1]:"text/plain"+(r[3]||";charset=utf-8"),i=!!r[4],r=e.slice(r[0].length);let s=(i?atob:decodeURIComponent)(r),n=[];for(let e=0;e<s.length;e++)n.push(s.charCodeAt(e));return new Blob([new Uint8Array(n)],{type:t})}static drawText(e,t,i=0,r=0,{color:s="white",backgroundColor:n,outlineColor:a,outlineWidth:o,fontSize:l,fontFamily:c="Arial, sans-serif",fontWeight:h="normal",borderColor:u,borderWidth:d=0,paddingTop:g=0,paddingBottom:p=0,paddingLeft:m=0,paddingRight:f=0,textAlign:y="left",width:T,height:v,autoEnlargeCanvas:b=!1}){var S=h+` ${l}px `+c;e.font=S;var w=e.measureText(t),C=e.measureText("A"),E=C.actualBoundingBoxAscent+C.actualBoundingBoxDescent,x=Math.ceil(Math.max(w.width,Math.abs(w.actualBoundingBoxLeft)+Math.abs(w.actualBoundingBoxRight))),O=x+2*d+m+f;O={x:"right"===y&&void 0===T?e.canvas.width-O:i,y:r,width:T??O,height:v??E+2*d+g+p};b&&(O.x+O.width>e.canvas.width||O.y+O.height>e.canvas.height)&&(E=0<e.canvas.width+e.canvas.height?e.getImageData(0,0,e.canvas.width,e.canvas.height):void 0,O.x+O.width>e.canvas.width&&(e.canvas.width=O.x+O.width),O.y+O.height>e.canvas.height&&(e.canvas.height=O.y+O.height),E&&e.putImageData(E,0,0)),n&&(e.fillStyle=n,e.fillRect(O.x,O.y,O.width,O.height)),u&&(e.strokeStyle=u,e.lineWidth=1,e.strokeRect(.5+O.x,.5+O.y,O.width-1,O.height-1)),e.fillStyle=s,e.font=S;let A=d+m;return"right"===y?A=O.width-d-f-x:"center"===y&&(A+=Math.floor((O.width-2*d-m-f-x)/2)),w=w.actualBoundingBoxAscent+g+(C.actualBoundingBoxAscent-w.actualBoundingBoxAscent),a&&(e.strokeStyle=a,e.lineWidth=2*(o??1),e.strokeText(t,O.x+A+.5,O.y+w,O.width)),e.fillText(t,O.x+A+.5,O.y+w,O.width),O}})}}})),System.register("engine/gfx/drawable/PalDrawable",["data/Bitmap"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PalDrawable",class{constructor(e){this.pal=e}draw(){var e=this.pal.size;let t=new i.RgbaBitmap(e,1),r=0;for(let i=0,n=e;i<n;++i){var s=this.pal.getColor(i);t.data[r]=s.r,t.data[r+1]=s.g,t.data[r+2]=s.b,t.data[r+3]=i?255:0,r+=4}return t}})}}})),System.register("engine/gfx/TextureUtils",["data/Bitmap","util/math","engine/gfx/CanvasUtils","engine/gfx/drawable/PalDrawable"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("TextureUtils",a=class e{static textureFromPalette(t){var i=t.hash,r=e.cache.get(i);return r||(r=new n.PalDrawable(t).draw(),r=this.textureFromPalBitmap(r),e.cache.set(i,r),r)}static textureFromPalettes(t){if(!t.length)throw new Error("At least one palette is required");var s=r.fnv32a(t.map((e=>e.hash)));if(l=e.cache.get(s))return l;let a;var o,l=t.map((e=>new n.PalDrawable(e).draw()));a=new i.RgbaBitmap(l[0].width,l.length);let c=0;for(o of l)a.drawRgbaImage(o,0,c++);return l=this.textureFromPalBitmap(a),e.cache.set(s,l),l}static textureFromPalBitmap(e){var t=s.CanvasUtils.canvasFromRgbaImageData(e.data,e.width,e.height);let i=new THREE.Texture(t);return i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter,i.needsUpdate=!0,i.flipY=!1,i}}),a.cache=new Map}}})),System.register("engine/renderable/builder/ObjectBuilder",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gfx/BufferGeometryUtils",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("BufferGeometryUtils",class{static mergeVertices(e,t=1e-4){t=Math.max(t,Number.EPSILON);const i={},r=e.getIndex();var s=e.getAttribute("position"),n=(r||s).count;let a=0;var o=Object.keys(e.attributes);const l={},c={},h=[],u=[(e,t)=>e.getX(t),(e,t)=>e.getY(t),(e,t)=>e.getZ(t),(e,t)=>e.getW(t)];for(let t=0,i=o.length;t<i;t++){var d=o[t];l[d]=[];var g=e.morphAttributes[d];g&&(c[d]=new Array(g.length).fill(void 0).map((()=>[])))}s=Math.log10(1/t);var p=Math.pow(10,s);for(let t=0;t<n;t++){var m=r?r.getX(t):t;let s="";for(let t=0,i=o.length;t<i;t++){var f=o[t],y=e.getAttribute(f),T=y.itemSize;for(let e=0;e<T;e++)s+=~~(u[e](y,m)*p)+","}if(s in i)h.push(i[s]);else{for(let t=0,i=o.length;t<i;t++){var v=o[t],b=e.getAttribute(v),S=e.morphAttributes[v],w=b.itemSize;const i=l[v],r=c[v];for(let e=0;e<w;e++){const t=u[e];if(i.push(t(b,m)),S)for(let e=0,i=S.length;e<i;e++)r[e].push(t(S[e],m))}}i[s]=a,h.push(a),a++}}const C=e.clone();for(let t=0,i=o.length;t<i;t++){var E=o[t];const i=e.getAttribute(E);var x=new i.array.constructor(l[E]);x=new THREE.BufferAttribute(x,i.itemSize,i.normalized);if(C.addAttribute(E,x),E in c)for(let t=0;t<c[E].length;t++){const i=e.morphAttributes[E][t];var O=new i.array.constructor(c[E][t]);O=new THREE.BufferAttribute(O,i.itemSize,i.normalized);C.morphAttributes[E][t]=O}}return C.setIndex(new THREE.BufferAttribute(new Uint32Array(h),1)),C}static mergeBufferGeometries(e,t=!1){var i=null!==e[0].index;const r=new Set(Object.keys(e[0].attributes)),s={},n=new THREE.BufferGeometry;let a=0;for(let l=0;l<e.length;++l){var o=e[l];let c=0;if(i!=(null!==o.index))throw new Error("mergeBufferGeometries() failed with geometry at index "+l+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them.");if(Object.keys(o.morphAttributes).length)throw new Error("mergeBufferGeometries() failed with geometry at index "+l+". Morph attributes are not supported");for(const e in o.attributes){if(!r.has(e))throw new Error("mergeBufferGeometries() failed with geometry at index "+l+'. All geometries must have compatible attributes; make sure "'+e+'" attribute exists among all geometries, or in none of them.');void 0===s[e]&&(s[e]=[]),s[e].push(o.attributes[e]),c++}if(c!==r.size)throw new Error("mergeBufferGeometries() failed with geometry at index "+l+". Make sure all geometries have the same number of attributes.");if(t){let e;if(i)e=o.index.count;else{if(void 0===o.attributes.position)throw new Error("mergeBufferGeometries() failed with geometry at index "+l+". The geometry must have either an index or a position attribute");e=o.attributes.position.count}n.addGroup(a,e,l),a+=e}}if(i){let t=0;const i=[];for(let r=0;r<e.length;++r){const s=e[r].index;for(let e=0;e<s.count;++e)i.push(s.getX(e)+t);t+=e[r].attributes.position.count}n.setIndex(new THREE.BufferAttribute(new(65535<i.length?Uint32Array:Uint16Array)(i),1))}for(const e in s){var l=this.mergeBufferAttributes(s[e]);if(!l)throw new Error("mergeBufferGeometries() failed while trying to merge the "+e+" attribute.");n.addAttribute(e,l)}return n}static mergeBufferAttributes(e){let t,i,r,s=0;for(let a=0;a<e.length;++a){var n=e[a];if(n.isInterleavedBufferAttribute)throw new Error("mergeBufferAttributes() failed. InterleavedBufferAttributes are not supported.");if(void 0===t&&(t=n.array.constructor),t!==n.array.constructor)throw new Error("mergeBufferAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes.");if(void 0===i&&(i=n.itemSize),i!==n.itemSize)throw new Error("mergeBufferAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes.");if(void 0===r&&(r=n.normalized),r!==n.normalized)throw new Error("mergeBufferAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes.");s+=n.array.length}const a=new t(s);let o=0;for(let t=0;t<e.length;++t)a.set(e[t].array,o),o+=e[t].array.length;return new THREE.BufferAttribute(a,i,r)}})}}})),System.register("engine/gfx/SpriteUtils",["util/math","engine/gfx/BufferGeometryUtils"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){(s=class e{constructor(){this.USE_INDEXED_GEOMETRY=!0,this.VERTICES_PER_SPRITE=this.USE_INDEXED_GEOMETRY?8:12,this.TRIANGLES_PER_SPRITE=4}createSpriteGeometry(e){if("object"!=typeof e)throw new Error("Invalid argument");var t=e.camera,s=e.texture;e.textureArea||(e.textureArea={x:0,y:0,width:s.image.width,height:s.image.height}),e.offset||(e.offset={x:0,y:0});var n=e.textureArea.width,a=e.textureArea.height,o={width:e.texture.image.width,height:e.texture.image.height},l=Math.cos(t.rotation.y)*(e.scale??1),c=l/Math.sin(-t.rotation.x),h=n*l,u=a*(e.flat?c:l);let d;n=(s=e.depth&&!e.flat)&&i.isBetween(-e.offset.x,0,h/l)?-e.offset.x:h/l/2,a=this.createRectGeometry(n*l,u);let g=this.createRectGeometry(h-n*l,u);return this.addRectUvs(a,{...e.textureArea,width:n},o),this.addRectUvs(g,{...e.textureArea,x:e.textureArea.x+n,width:e.textureArea.width-n},o),g.applyMatrix((new THREE.Matrix4).makeTranslation((h-n*l+n*l)/2,0,0)),d=r.BufferGeometryUtils.mergeBufferGeometries([a,g]),d.applyMatrix((new THREE.Matrix4).makeTranslation(-(h/2-n*l/2),0,0)),a=e.align,n=e.offset,d.applyMatrix((new THREE.Matrix4).makeTranslation(a.x*h/2+n.x*l,a.y*u/2-n.y*(e.flat?c:l),0)),s?this.applyDepth(d,t,e.depthOffset??0):e.depth&&e.flat&&e.depthOffset&&this.applyFlatDepth(d,e.depthOffset),s=new THREE.Euler(t.rotation.x,t.rotation.y,0,"YXZ"),d.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(s).multiply(e.flat?(new THREE.Matrix4).makeRotationFromEuler(new THREE.Euler(-t.rotation.x-Math.PI/2,0,0)):(new THREE.Matrix4).identity())),d}createRectGeometry(e,t){return this.USE_INDEXED_GEOMETRY?this.createIndexedRectGeometry(e,t):this.createNonIndexedRectGeometry(e,t)}createNonIndexedRectGeometry(e,t){let i=new THREE.BufferGeometry;var r=new Float32Array([-.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0,.5*e,.5*t,0]);return i.addAttribute("position",new THREE.BufferAttribute(r,3)),i}createIndexedRectGeometry(e,t){let i=new THREE.BufferGeometry;var r=new Float32Array([-.5*e,.5*t,0,.5*e,.5*t,0,-.5*e,-.5*t,0,.5*e,-.5*t,0]);return i.addAttribute("position",new THREE.BufferAttribute(r,3)),r=new Uint16Array([0,2,1,2,3,1]),i.setIndex(new THREE.BufferAttribute(r,1)),i}addRectUvs(e,t,i){var r=new Float32Array(2*e.getAttribute("position").count);this.USE_INDEXED_GEOMETRY?this.writeIndexedRectUvsIntoBuffer(r,0,t,i):this.writeNonIndexedRectUvsIntoBuffer(r,0,t,i),e.addAttribute("uv",new THREE.BufferAttribute(r,2))}writeNonIndexedRectUvsIntoBuffer(e,t,i,r){var s=i.x/r.width,n=1-(i.y+i.height)/r.height,a=i.width/r.width,o=i.height/r.height;e.set([s,n+o,s,n,s+a,n+o,s,n,s+a,n,s+a,n+o],12*t)}writeIndexedRectUvsIntoBuffer(e,t,i,r){var s=i.x/r.width,n=1-(i.y+i.height)/r.height,a=i.width/r.width,o=i.height/r.height;e.set([s,n+o,s+a,n+o,s,n,s+a,n],8*t)}applyDepth(t,i,r){let s=t.getAttribute("position");for(let t=0,a=s.count;t<a;t++){var n=s.getX(t)*e.MAGIC_DEPTH_SCALE;let a;a=n<0?r-Math.abs(n)/Math.cos(i.rotation.x)*Math.tan(i.rotation.y):r-n/Math.cos(i.rotation.x)/Math.tan(i.rotation.y),s.setZ(t,a)}}applyFlatDepth(e,t){let i=e.getAttribute("position");for(let e=0,r=i.count;e<r;e++)i.setZ(e,t)}}).MAGIC_DEPTH_SCALE=.8,e("SpriteUtils",new s)}}})),System.register("engine/gfx/TextureAtlas",["data/Bitmap"],(function(e,t){"use strict";var i;function r(e){let t=e.target;t.isDisposed=!0,t.removeEventListener("dispose",r)}function s(e,t,r,s){let n=new i.IndexedBitmap(t,r);return e.forEach((e=>{if(!e.fit)throw new Error("Couldn't fit all images in a single texture");var t=e.image,i=e.fit.x,r=e.fit.y;s?.set(t,{x:i,y:r,width:e.w,height:e.h}),n.drawIndexedImage(t,i,r)})),n}return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TextureAtlas",class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(e){if(!this.imageRects)throw new Error("Texture atlas not initialized");var t=this.imageRects.get(e);if(!t)throw new Error("Image not found in atlas");return t}pack(e){let t=[];e.forEach((e=>{t.push({w:e.width+e.width%2,h:e.height+e.height%2,image:e})})),t.sort(((e,t)=>1e4*(t.w-e.w)+t.h-e.h));let i=new GrowingPacker;i.fit(t);var n,a,o,l=i.root.w,c=i.root.h,h=new Map,u=s(t,l,c,h);let d=new THREE.DataTexture(u.data,l,c,THREE.AlphaFormat);d.needsUpdate=!0,d.flipY=!0,d.minFilter=THREE.NearestFilter,d.magFilter=THREE.NearestFilter,d.onUpdate=(n=t,a=l,o=c,e=>{e.image={width:e.image.width,height:e.image.height,get data(){return e.isDisposed?new Uint8Array(this.width*this.height):(console.log("TextureAtlas: Rebuilding texture for upload to GPU..."),s(n,a,o).data)}},e.addEventListener("dispose",r)}),this.width=l,this.height=c,this.imageRects=h,this.texture=d}dispose(){this.texture?.dispose()}})}}})),System.register("engine/renderable/builder/ShpTextureAtlas",["data/Bitmap","engine/gfx/TextureAtlas"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ShpTextureAtlas",class{fromShpFile(e){let t=[];for(let r=0;r<e.numImages;r++){var s=e.getImage(r);t.push(new i.IndexedBitmap(s.width,s.height,s.imageData))}let n=new r.TextureAtlas;return n.pack(t),this.images=t,this.atlas=n,this}getTextureArea(e){return this.atlas.getImageRect(this.images[e])}getTexture(){return this.atlas.getTexture()}dispose(){this.atlas.dispose()}})}}})),System.register("engine/renderable/builder/SpriteBuilder",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/renderable/builder/ShpBuilder",["engine/gfx/TextureUtils","engine/gfx/SpriteUtils","engine/renderable/builder/ShpTextureAtlas","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("ShpBuilder",o=class e{constructor(e,t,i,r=1,s=!1,n=0){this.scale=r,this.depth=s,this.depthOffset=n,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1,this.forceTransparent=!1,this.offset={x:0,y:0},this.frameOffset=0,this.flat=!1,this.shpFile=e,this.palette=t,this.camera=i,this.shpSize={width:e.width,height:e.height},this.setFrame(0)}static prepareTexture(t){var i;e.textureCache.has(t)||(i=(new s.ShpTextureAtlas).fromShpFile(t),e.textureCache.set(t,i))}static clearCaches(){e.textureCache.forEach((e=>e.dispose())),e.textureCache.clear(),e.geometryCache.forEach((e=>e.forEach((e=>e.dispose())))),e.geometryCache.clear()}useMaterial(t,i,r){if(t.format!==THREE.AlphaFormat)throw new Error("Texture must have format THREE.AlphaFormat");this.materialCacheKey=t.uuid+"_"+i.uuid+"_"+Number(r);let s,a=e.materialCache.get(this.materialCacheKey);return a?(s=a.material,a.usages++):(s=new n.PaletteBasicMaterial({map:t,palette:i,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:r}),a={material:s,usages:1},e.materialCache.set(this.materialCacheKey,a)),s}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let t=e.materialCache.get(this.materialCacheKey);t&&(1===t.usages?(e.materialCache.delete(this.materialCacheKey),t.material.dispose()):t.usages--)}setBatched(e){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=e}setOffset(e){if(this.mesh)throw new Error("Offset can only be set before calling build()");this.offset=e}setFrameOffset(e){if(this.mesh)throw new Error("frameOffset can only be set before calling build()");this.frameOffset=e}initTexture(){e.prepareTexture(this.shpFile),this.atlas=e.textureCache.get(this.shpFile)}getSpriteGeometryOptions(e){e+=this.frameOffset;var t={x:(t=this.shpFile.getImage(e)).x-Math.floor(this.shpSize.width/2)+Math.floor(this.offset.x),y:t.y-Math.floor(this.shpSize.height/2)+Math.floor(this.offset.y)};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(e),flat:this.flat,align:{x:1,y:-1},offset:t,camera:this.camera,depth:this.depth,depthOffset:this.depthOffset,scale:this.scale}}getGeometryCacheKey(e){return e+this.frameOffset+"_"+this.shpSize.width+"_"+this.shpSize.height+"_"+this.offset.x+"_"+this.offset.y+"_"+this.flat+"_"+this.depth+"_"+this.depthOffset}setFrame(e){if(this.frameNo!==e&&(this.frameNo=e,this.mesh)){let i=this.getGeometryCache();var t=this.getGeometryCacheKey(e);let s=i.get(t);s||(s=r.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions(e)),i.set(t,s)),this.mesh.geometry=s}}getGeometryCache(){let t=e.geometryCache.get(this.shpFile);return t||(t=new Map,e.geometryCache.set(this.shpFile,t)),t}getFrame(){return this.frameNo}setSize(e){this.shpSize={width:e.width,height:e.height}}getSize(){return this.shpSize}get frameCount(){return this.shpFile.numImages}getBatchPaletteIndex(e){var t=this.batchPalettes.findIndex((t=>t.hash===e.hash));if(-1===t)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return t}setPalette(e){if(this.palette=e,this.mesh)if(this.useMeshBatching){var t=this.getBatchPaletteIndex(e);this.mesh.setPaletteIndex(t)}else{t=i.TextureUtils.textureFromPalette(e),this.mesh.material.palette=t}}setBatchPalettes(e){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=e}setExtraLight(e){if(this.extraLight=e,this.mesh)if(this.useMeshBatching)this.mesh.setExtraLight(e);else{this.mesh.material.extraLight=e}}setOpacity(e){var t=this.opacity;t!==e&&(this.opacity=e,this.updateOpacity()),Math.floor(t)===Math.floor(e)||this.forceTransparent||this.updateTransparency()}setForceTransparent(e){e!==this.forceTransparent&&(this.forceTransparent=e,this.updateTransparency())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}updateTransparency(){var e,t,i;this.mesh&&(e=this.forceTransparent||this.opacity<1,this.useMeshBatching?(t=this.mesh.material.map,i=this.mesh.material.palette,this.freeMaterial(),this.mesh.material=this.useMaterial(t,i,e)):this.mesh.material.transparent=e)}build(){if(this.mesh)return this.mesh;this.initTexture();var e,t=this.atlas.getTexture(),s=this.getGeometryCacheKey(this.frameNo);let o,l=this.getGeometryCache(),c=l.get(s);c||(e=this.getSpriteGeometryOptions(this.frameNo),c=r.SpriteUtils.createSpriteGeometry(e),l.set(s,c));var h;s=this.opacity<1||this.forceTransparent;return this.useMeshBatching?(h=i.TextureUtils.textureFromPalettes(this.batchPalettes),h=this.useMaterial(t,h,s),o=new a.BatchedMesh(c,h,a.BatchMode.Merging),o.castShadow=!1):(h=i.TextureUtils.textureFromPalette(this.palette),s=new n.PaletteBasicMaterial({map:t,palette:h,alphaTest:.5,flatShading:!0,transparent:s}),o=new THREE.Mesh(c,s)),o.matrixAutoUpdate=!1,this.mesh=o,this.setPalette(this.palette),this.updateOpacity(),this.extraLight&&this.setExtraLight(this.extraLight),o}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),o.textureCache=new Map,o.geometryCache=new Map,o.materialCache=new Map}}})),System.register("engine/renderable/builder/VxlBuilder",["game/Coords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("VxlBuilder",class{constructor(e){this.camera=e}build(){if(this.object)return this.object;let e=this.object=new THREE.Object3D,t=Math.cos(this.camera.rotation.y)*i.Coords.ISO_WORLD_SCALE;e.scale.set(t,t,t);let r=new THREE.Object3D;return r.rotation.x=-Math.PI/2,r.rotation.z=+Math.PI/2,r.matrixAutoUpdate=!1,r.updateMatrix(),e.add(r),(this.sections=this.createVxlMeshes()).forEach((e=>{var i;e.matrixAutoUpdate=!1,r.add(e),this.localBoundingBox||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),this.localBoundingBox=new THREE.Box3(e.geometry.boundingBox.min.clone().multiplyScalar(t),e.geometry.boundingBox.max.clone().multiplyScalar(t)),i=this.localBoundingBox.min.x,this.localBoundingBox.min.x=this.localBoundingBox.min.y,this.localBoundingBox.min.y=i,i=this.localBoundingBox.max.x,this.localBoundingBox.max.x=this.localBoundingBox.max.y,this.localBoundingBox.max.y=i)})),e.matrixAutoUpdate=!1,e.updateMatrix(),e}getSection(e){if(!this.sections)throw new Error("Vxl object must be built first");return this.sections.get(e)}getLocalBoundingBox(){return this.localBoundingBox}})}}})),System.register("engine/renderable/entity/building/DamageType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NORMAL=0]="NORMAL",t[t.CONDITION_YELLOW=1]="CONDITION_YELLOW",t[t.CONDITION_RED=2]="CONDITION_RED",t[t.DESTROYED=3]="DESTROYED",e("DamageType",i)}}})),System.register("engine/renderable/entity/building/AnimationType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.IDLE=0]="IDLE",t[t.PRODUCTION=1]="PRODUCTION",t[t.ACTIVE=2]="ACTIVE",t[t.SPECIAL=3]="SPECIAL",t[t.SUPER=4]="SUPER",t[t.BUILDUP=5]="BUILDUP",t[t.UNBUILD=6]="UNBUILD",t[t.FACTORY_DEPLOYING=7]="FACTORY_DEPLOYING",t[t.FACTORY_ROOF_DEPLOYING=8]="FACTORY_ROOF_DEPLOYING",t[t.SUPER_IDLE=9]="SUPER_IDLE",t[t.SUPER_CHARGE_START=10]="SUPER_CHARGE_START",t[t.SUPER_CHARGE_LOOP=11]="SUPER_CHARGE_LOOP",t[t.SUPER_CHARGE_END=12]="SUPER_CHARGE_END",t[t.SPECIAL_DOCKING=13]="SPECIAL_DOCKING",t[t.SPECIAL_REPAIR_START=14]="SPECIAL_REPAIR_START",t[t.SPECIAL_REPAIR_LOOP=15]="SPECIAL_REPAIR_LOOP",t[t.SPECIAL_REPAIR_END=16]="SPECIAL_REPAIR_END",t[t.SPECIAL_SHOOT=17]="SPECIAL_SHOOT",t[t.FACTORY_UNDER_DOOR=18]="FACTORY_UNDER_DOOR",t[t.FACTORY_UNDER_ROOF_DOOR=19]="FACTORY_UNDER_ROOF_DOOR",e("AnimationType",i)}}})),System.register("engine/gfx/OverlayUtils",["engine/gfx/CanvasUtils"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("OverlayUtils",class{static createGroundCircle(e,t){var i=new THREE.LineBasicMaterial({color:t,transparent:!0,depthTest:!1,depthWrite:!1});let r=new THREE.CircleGeometry(e,64);r.vertices.shift(),r.vertices.push(r.vertices[0]);let s=new THREE.Line(r,i);return s.rotation.x=Math.PI/2,s.renderOrder=1e6,s}static createTextBox(e,t){let r=document.createElement("canvas");r.width=r.height=0;var s=r.getContext("2d",{alpha:!t.backgroundColor||!!t.backgroundColor.match(/^rgba/)});return i.CanvasUtils.drawText(s,e,0,0,{...t,autoEnlargeCanvas:!0}),r}})}}})),System.register("engine/AnimProps",["game/GameSpeed","util/math"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("AnimProps",s=class e{constructor(e,t){this.art=e,this.init(t)}init(t){this.shadow=this.art.getBool("Shadow"),this.reverse=this.art.getBool("Reverse"),this.frameCount="number"==typeof t?t:this.shadow?t.numImages/2:t.numImages,this.end=this.art.getNumber("End",this.frameCount-1);var i=this.art.getNumberArray("RandomRate").sort();2===i.length?this.rate=r.getRandomInt(i[0],i[1])/60:this.rate=this.art.getNumber("Rate",60*e.defaultRate)/60,this.start=this.art.getNumber("Start",0),this.loopStart=this.art.getNumber("LoopStart",0),this.loopEnd=Math.max(this.loopStart,this.art.getNumber("LoopEnd",this.end+1)-1),this.loopCount=this.art.getNumber("LoopCount",1),i=this.art.getNumberArray("RandomLoopDelay").sort(),this.randomLoopDelay=2===i.length?[i[0],i[1]]:void 0}getArt(){return this.art}setArt(e){this.art=e,this.init(this.frameCount)}}),s.defaultRate=i.GameSpeed.BASE_TICKS_PER_SECOND}}})),System.register("engine/Animation",["util/math"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.NOT_STARTED=0]="NOT_STARTED",t[t.RUNNING=1]="RUNNING",t[t.STOPPED=2]="STOPPED",t[t.DELAYED=3]="DELAYED",t[t.PAUSED=4]="PAUSED",e("AnimationState",r),e("Animation",class{constructor(e,t){this.props=e,this.state=r.NOT_STARTED,this.endLoopFlag=!1,this.playToEndFlag=!1,this.speed=t}getState(){return this.state}start(e,t=0){this.time=e,this.frameNo=this.props.reverse?this.props.end:this.props.start,this.loopNo=0,this.delayFrames=t,this.state=t?r.DELAYED:r.RUNNING}pause(){this.state===r.RUNNING&&(this.state=r.PAUSED)}unpause(){this.state===r.PAUSED&&(this.state=r.RUNNING)}reset(){this.state=r.NOT_STARTED}stop(){this.state=r.STOPPED}update(e){var t=(e-this.time)/1e3,i=this.props.rate*this.speed.value;if(!((i=Math.floor(t*i))<1)&&(this.time=e,this.state!==r.PAUSED)){if(0<this.delayFrames){if(this.delayFrames=Math.max(0,this.delayFrames-i),0<this.delayFrames)return void(this.state=r.DELAYED);this.state=r.RUNNING}this.computeNextFrame(i)&&(this.state=r.STOPPED)}}endLoop(){this.endLoopFlag=!0}endLoopAndPlayToEnd(){this.endLoopFlag=!0,this.playToEndFlag=!0}rewind(){this.props.reverse?this.frameNo=this.loopNo?this.props.loopEnd:this.props.end:this.frameNo=this.loopNo?this.props.loopStart:this.props.start}getCurrentFrame(){return this.frameNo}computeNextFrame(e){let t=this.frameNo;for(;0<e;){var s=this.endLoopFlag&&this.playToEndFlag?this.props.reverse?this.props.start:this.props.end:this.props.reverse?this.props.loopStart:this.props.loopEnd;if(!this.props.reverse&&t+e<=s||this.props.reverse&&t-e>=s){t+=this.props.reverse?-e:e;break}if(-1!==this.props.loopCount&&this.loopNo>=this.props.loopCount-1)return this.frameNo=s,!0;if(this.endLoopFlag)return!(this.endLoopFlag=!1);e-=1+(this.props.reverse?t-s:s-t),t=this.props.reverse?this.props.loopEnd:this.props.loopStart,this.loopNo++,this.props.randomLoopDelay&&(this.state=r.DELAYED,this.delayFrames=i.getRandomInt(this.props.randomLoopDelay[0],this.props.randomLoopDelay[1]))}return this.frameNo=t,!1}})}}})),System.register("engine/renderable/entity/wallTypes",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("wallTypes",[[0,0,0,0],[1,0,0,0],[0,1,0,0],[1,1,0,0],[0,0,1,0],[1,0,1,0],[0,1,1,0],[1,1,1,0],[0,0,0,1],[1,0,0,1],[0,1,0,1],[1,1,0,1],[0,0,1,1],[1,0,1,1],[0,1,1,1],[1,1,1,1]])}}})),System.register("engine/renderable/WithPosition",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("WithPosition",class{constructor(){this.matrixUpdate=!1,this.position=new THREE.Vector3}setPosition(e,t,i){this.position.x=e,this.position.y=t,this.position.z=i,this.updatePosition()}getPosition(){return this.position}updatePosition(){if(this.target){let e=this.target.get3DObject();e&&(e.position.set(this.position.x,this.position.y,this.position.z),this.matrixUpdate&&(e.matrix.setPosition(e.position),e.matrixWorldNeedsUpdate=!0))}}applyTo(e){this.target=e,this.updatePosition()}})}}})),System.register("engine/IsoCoords",["game/Coords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("IsoCoords",class e{static init(t){e.worldOrigin=t}static worldToScreen(t,r){if(!e.worldOrigin)throw new Error("Coords not initialized with world origin");return t-=e.worldOrigin.x,r-=e.worldOrigin.y,{x:(t/=i.Coords.ISO_WORLD_SCALE)-(r/=i.Coords.ISO_WORLD_SCALE),y:(t+r)/2}}static screenToWorld(t,r){if(!e.worldOrigin)throw new Error("Coords not initialized with world origin");return{x:(t+2*r)/2*i.Coords.ISO_WORLD_SCALE+e.worldOrigin.x,y:(2*r-t)/2*i.Coords.ISO_WORLD_SCALE+e.worldOrigin.y}}static vecWorldToScreen(t){let r=e.worldToScreen(t.x,t.z);return r.y-=e.tileHeightToScreen(i.Coords.worldToTileHeight(t.y)),r}static tileToScreen(t,r){var s=i.Coords.tileToWorld(t,r);return e.worldToScreen(s.x,s.y)}static tileHeightToScreen(e){return e*(i.Coords.ISO_TILE_SIZE/2)}static tile3dToScreen(t,i,r){let s=e.tileToScreen(t,i);return s.y-=e.tileHeightToScreen(r),s}static screenTileToScreen(e,t){return{x:e*i.Coords.ISO_TILE_SIZE,y:t*i.Coords.ISO_TILE_SIZE/2}}static screenToScreenTile(e,t){return{x:e/i.Coords.ISO_TILE_SIZE,y:t/(i.Coords.ISO_TILE_SIZE/2)}}static screenTileToWorld(t,i){var r=e.screenTileToScreen(t,i);return e.screenToWorld(r.x,r.y)}static getScreenTileSize(){return{width:e.tileToScreen(1,0).x-e.tileToScreen(0,1).x,height:e.tileToScreen(1,1).y-e.tileToScreen(0,0).y}}static screenDistanceToWorld(e,t){return i.Coords.screenDistanceToWorld(e,t)}})}}})),System.register("engine/renderable/entity/map/MapSurface",["game/Coords","game/theater/rampHeights","engine/gfx/BufferGeometryUtils","util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("MAGIC_OFFSET",.05),e("MapSurface",class{constructor(e,t){this._textureTilesNo=20,this.visible=!0,this.disposables=new n.CompositeDisposable,this.map=e,this.theater=t}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=this.createObject(),e.name="map_surface_shadow",e.matrixAutoUpdate=!1,e.visible=this.visible,this.target=e)}update(){}setVisible(e){this.visible=e,this.target&&(this.target.visible=e)}createObject(){let e=[];this.map.tiles.forEach((t=>{var r=i.Coords.tile3dToWorld(t.rx,t.ry,t.z);let s=this.createRectGeometry(t.rampType);s.applyMatrix((new THREE.Matrix4).makeTranslation(r.x,r.y+.05,r.z)),e.push(s)}));var t=s.BufferGeometryUtils.mergeBufferGeometries(e);let r=new THREE.ShadowMaterial;r.transparent=!0,r.opacity=.5;let n=new THREE.Mesh(t,r);return n.receiveShadow=!0,n.renderOrder=5,n.frustumCulled=!1,this.disposables.add(t,r),n}createRectGeometry(e){var t=i.Coords.getWorldTileSize(),s=r.rampHeights[e];let n=new THREE.BufferGeometry;return t=new Float32Array([0,i.Coords.tileHeightToWorld(s[0]),t,t,i.Coords.tileHeightToWorld(s[3]),t,0,i.Coords.tileHeightToWorld(s[1]),0,t,i.Coords.tileHeightToWorld(s[2]),0]),s=new Uint16Array([0,1,2,3,2,1]),n.addAttribute("position",new THREE.BufferAttribute(t,3)),n.setIndex(new THREE.BufferAttribute(s,1)),n}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/ShadowRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","game/Coords","engine/IsoCoords","engine/renderable/entity/map/MapSurface"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("ShadowRenderable",class e{constructor(e,t,i,r=0){this.shpFile=e,this.camera=t,this.shadowHeightTileAdjust=r,this.baseFrameNo=0,this.frameOffset=0,this.visible=!0,this.useBatching=!1,this.drawOffset={...i}}static getOrCreateShadowPalette(){let t=e.shadowPalette;return t||(t=new i.Palette(new Array(768).fill(0)),e.shadowPalette=t),t}setVisible(e){var t;this.visible=e,this.object3d&&(t=this.computeShadowFrameNo(this.baseFrameNo),this.object3d.visible=e&&this.frameHasShadowData(t))}setSize(e){this.shpSize=e,this.builder?.setSize(e)}setBatched(e){this.useBatching=e,this.builder?.setBatched(e)}setBaseFrame(e){var t;this.baseFrameNo=e,this.builder&&(t=this.computeShadowFrameNo(e),this.builder.setFrame(t),this.object3d.visible=this.visible&&this.frameHasShadowData(t))}setFrameOffset(e){this.frameOffset=e,this.builder&&this.builder.setFrameOffset(e)}computeShadowFrameNo(e){return e<this.shpFile.numImages?this.shpFile.numImages/2+e:1}create3DObject(){if(!this.object3d){var t=e.getOrCreateShadowPalette();let o=new r.ShpBuilder(this.shpFile,t,this.camera,s.Coords.ISO_WORLD_SCALE);this.shpSize&&o.setSize(this.shpSize),o.setFrameOffset(this.frameOffset),o.setBatched(this.useBatching),this.useBatching&&o.setBatchPalettes([t]),o.flat=!0;var i=this.computeShadowFrameNo(this.baseFrameNo);o.setFrame(i),this.shadowHeightTileAdjust&&(t=n.IsoCoords.tileHeightToScreen(this.shadowHeightTileAdjust),this.drawOffset.y+=-t),o.setOffset(this.drawOffset),o.setOpacity(.5);let l=o.build();this.shadowHeightTileAdjust&&(l.position.y+=s.Coords.tileHeightToWorld(-this.shadowHeightTileAdjust),l.updateMatrix()),l.visible=this.visible&&this.frameHasShadowData(i),l.position.y+=a.MAGIC_OFFSET/5,l.updateMatrix(),this.builder=o,this.object3d=l}}frameHasShadowData(e){return!!this.shpFile.getImage(this.frameOffset+e).imageData.length}get3DObject(){return this.object3d}update(e){}dispose(){this.builder?.dispose()}})}}})),System.register("engine/renderable/ShpRenderable",["engine/renderable/builder/ShpBuilder","engine/renderable/ShadowRenderable","game/Coords"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("ShpRenderable",class{constructor(e,t,i){this.builder=e,this.shadowRenderable=t,this.zShapeFixBuilder=i}static factory(e,t,n,a,o=!1,l=0,c=!1,h=0,u=!1){var d=o?new r.ShadowRenderable(e,n,a,l):void 0,g=s.Coords.ISO_WORLD_SCALE;let p,m=new i.ShpBuilder(e,t,n,g,c,h);return m.setOffset(a),u&&(p=new i.ShpBuilder(e,t,n,g,c,h),p.setOffset(a),p.flat=!0),new this(m,d,p)}get3DObject(){return this.target}setBatched(e){this.builder.setBatched(e),this.zShapeFixBuilder?.setBatched(e),this.shadowRenderable?.setBatched(e)}setBatchPalettes(e){this.builder.setBatchPalettes(e),this.zShapeFixBuilder?.setBatchPalettes(e)}setSize(e){this.builder.setSize(e),this.zShapeFixBuilder?.setSize(e),this.shadowRenderable?.setSize(e)}getFlat(){return this.builder.flat}setFlat(e){this.builder.flat=e}setFrame(e){this.builder.getFrame()!==e&&(this.builder.setFrame(e),this.zShapeFixBuilder?.setFrame(e),this.shadowRenderable?.setBaseFrame(e))}setFrameOffset(e){this.builder.setFrameOffset(e),this.zShapeFixBuilder?.setFrameOffset(e),this.shadowRenderable?.setFrameOffset(e)}setPalette(e){this.builder.setPalette(e),this.zShapeFixBuilder?.setPalette(e)}setExtraLight(e){this.builder.setExtraLight(e),this.zShapeFixBuilder?.setExtraLight(e)}setOpacity(e){this.builder.setOpacity(e),this.zShapeFixBuilder?.setOpacity(e)}setForceTransparent(e){this.builder.setForceTransparent(e),this.zShapeFixBuilder?.setForceTransparent(e)}get frameCount(){return this.shadowRenderable?this.builder.frameCount/2:this.builder.frameCount}getShapeMesh(){return this.shapeMesh}getShadowMesh(){return this.shadowMesh}setShadowVisible(e){this.shadowRenderable?.setVisible(e)}create3DObject(){if(!this.target){var e,t=this.shapeMesh=this.builder.build();if(this.shadowRenderable||this.zShapeFixBuilder){let i=new THREE.Object3D;i.matrixAutoUpdate=!1,i.add(t),this.shadowRenderable&&(this.shadowRenderable.create3DObject(),e=this.shadowMesh=this.shadowRenderable.get3DObject(),i.add(e)),this.zShapeFixBuilder&&(e=this.zShapeFixBuilder.build(),i.add(e)),this.target=i}else this.target=t}}update(e){}dispose(){this.builder.dispose(),this.zShapeFixBuilder?.dispose(),this.shadowRenderable?.dispose()}})}}})),System.register("engine/ImageFinder",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("ImageFinder",i=class e{constructor(e,t){this.images=e,this.theater=t}findByObjectArt(e){return this.find(e.imageName,e.useTheaterExtension)}find(t,i){var r=this.getFilename(t,i),s=this.images.get(r);if(!s)throw new e.MissingImageError(`No image file found for artName="${t}" (file=${r})`);return s}tryFind(t,i){let r;try{r=this.find(t,i)}catch(t){if(!(t instanceof e.MissingImageError))throw t}return r}getFilename(e,t){let i=e.toLowerCase();return i+=t?this.theater.settings.Extension:".shp",i=this.applyNewTheaterIfNeeded(e,i),i}applyNewTheaterIfNeeded(e,t){return-1===["G","N","C","Y"].indexOf(e[0])||-1===["A","T","U","D","L","N"].indexOf(e[1])?t:this.applyNewTheater(t)}applyNewTheater(e){let t;var i=e[0],r=e.substr(2);return t=i+this.theater.settings.NewTheaterChar.toLowerCase()+r,this.images.has(t)||(t=i+"g"+r,this.images.has(t)||(t=e)),t}}),function(e){class t extends Error{}e.MissingImageError=t}(i=i||{}),e("ImageFinder",i)}}})),System.register("engine/gfx/DebugUtils",["game/Coords","data/Bitmap","three"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("DebugUtils",class{static createWireframe(e,t){return new s.Mesh(this.createBoxGeometry(e,t),new THREE.MeshBasicMaterial({wireframe:!0}))}static createBoxGeometry(e,t,r=!1){var s=i.Coords.getWorldTileSize(),n=e.width*s,a=e.height*s;s=i.Coords.tileHeightToWorld(t);let o=new THREE.BoxBufferGeometry(n,s,a);return r?o.translate(0,s/2,0):o.translate(n/2,s/2,a/2),o}static createIndexedCheckerTex(e,t){let i=new r.IndexedBitmap(64,64,new Uint8Array(4096).fill(e));for(let e=0;e<32;e++)for(let r=0;r<32;r++)i.data[e+64*r]=t,i.data[e+32+64*(r+32)]=t;let s=new THREE.DataTexture(i.data,64,64,THREE.AlphaFormat);return s.needsUpdate=!0,s.minFilter=THREE.NearestFilter,s.magFilter=THREE.NearestFilter,s}})}}})),System.register("engine/renderable/MapSpriteTranslation",["game/Coords","engine/IsoCoords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("MapSpriteTranslation",class{constructor(e,t){this.rx=e,this.ry=t}compute(){let e=i.Coords.tileToWorld(this.rx,this.ry);var t=r.IsoCoords.worldToScreen(e.x,e.y),s=r.IsoCoords.worldToScreen(0,0);let n=new THREE.Vector2(s.x-t.x,s.y-t.y);return 0!=(t=n.y-Math.floor(n.y))&&(n.y-=t,s=new THREE.Vector2(s.x-n.x,s.y-n.y),e=r.IsoCoords.screenToWorld(s.x,s.y)),{spriteOffset:n,anchorPointWorld:e}}})}}})),System.register("engine/renderable/entity/building/BuildingAnimData",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("BuildingAnimData",class{})}}})),System.register("engine/renderable/entity/building/BuildingAnimArtProps",["engine/renderable/entity/building/AnimationType","data/IniSection","engine/renderable/entity/building/BuildingAnimData","engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=(new Map).set(i.AnimationType.IDLE,["IdleAnim"]).set(i.AnimationType.PRODUCTION,["ProductionAnim"]).set(i.AnimationType.SUPER,["SuperAnim","SuperAnimTwo","SuperAnimThree","SuperAnimFour"]).set(i.AnimationType.ACTIVE,["ActiveAnim","ActiveAnimTwo","ActiveAnimThree","ActiveAnimFour"]).set(i.AnimationType.SPECIAL,["SpecialAnim","SpecialAnimTwo","SpecialAnimThree","SpecialAnimFour"]).set(i.AnimationType.FACTORY_DEPLOYING,["DeployingAnim","UnderDoorAnim"]).set(i.AnimationType.FACTORY_ROOF_DEPLOYING,["RoofDeployingAnim","UnderRoofDoorAnim"]).set(i.AnimationType.BUILDUP,["Buildup"]).set(i.AnimationType.UNBUILD,["Buildup"]),e("BuildingAnimArtProps",class{constructor(){this.animsByType=new Map}read(e,t){a.forEach(((a,o)=>{let l=[];a.forEach(((a,c)=>{var h=e.getString(a);if(h){let c,d,g=new s.BuildingAnimData;if(g.name=h,g.type=o,t.hasObject(h,n.ObjectType.Animation)&&(d=t.getObject(h,n.ObjectType.Animation),c=d.art),o===i.AnimationType.BUILDUP||o===i.AnimationType.UNBUILD)c=c?c.clone():new r.IniSection(h),c.has("Shadow")||c.set("Shadow","yes"),o===i.AnimationType.UNBUILD&&c.set("Reverse","yes");else if(!c)throw new Error(`Missing building anim section "${h}"`);g.art=c,g.pauseWhenUnpowered=e.getBool(a+"Powered",!0),g.showWhenUnpowered=!e.getBool(a+"PoweredLight",!1);var u=e.getString(a+"Damaged");u&&t.hasObject(u,n.ObjectType.Animation)&&(g.damagedArt=t.getObject(u,n.ObjectType.Animation).art),g.offset={x:e.getNumber(a+"X"),y:e.getNumber(a+"Y")};let p=c.getString("Image");p=p||h,g.image=p,g.flat="UnderDoorAnim"===a||"UnderRoofDoorAnim"===a||c.getBool("Flat"),d&&(g.translucent=d.translucent,g.translucency=d.translucency),l.push(g)}})),this.animsByType.set(o,l)}))}getByType(e){if(!this.animsByType.has(e))throw new Error(`Animation type "${i.AnimationType[e]}" has no data`);return this.animsByType.get(e)}getAll(){return this.animsByType}})}}})),System.register("engine/animation/Runner",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/animation/SimpleRunner",["engine/Animation"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SimpleRunner",class{tick(e){let t=this.animation;if(t)switch(t.getState()){case i.AnimationState.STOPPED:return;case i.AnimationState.NOT_STARTED:t.start(e);case i.AnimationState.RUNNING:default:t.update(e)}}getCurrentFrame(){return this.animation.getCurrentFrame()}shouldUpdate(){return this.animation.getState()!==i.AnimationState.STOPPED}})}}})),System.register("engine/sound/ChannelType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Master=0]="Master",t[t.Ui=1]="Ui",t[t.Ambient=2]="Ambient",t[t.Effect=3]="Effect",t[t.Voice=4]="Voice",t[t.Music=5]="Music",t[t.CreditTicks=6]="CreditTicks",e("ChannelType",i)}}})),System.register("engine/sound/Mixer",["util/event"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Mixer",class{constructor(){this.volumes=new Map,this.mutes=new Map,this._onVolumeChange=new i.EventDispatcher}get onVolumeChange(){return this._onVolumeChange.asEvent()}setVolume(e,t){this.getVolume(e)!==t&&(this.volumes.set(e,t),this._onVolumeChange.dispatch(this,e))}getVolume(e){return this.volumes.get(e)??1}setMuted(e,t){this.mutes.set(e,t),this._onVolumeChange.dispatch(this,e)}isMuted(e){return!!this.mutes.get(e)}serialize(){return[...this.volumes.entries()].map((([e,t])=>e+","+t)).join(";")}unserialize(e){return this.volumes=new Map(e.split(";").map((e=>e.split(",").map(Number)))),this}})}}})),System.register("engine/sound/InternalPlaybackHandle",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("InternalPlaybackHandle",class{constructor(){this.playing=!0,this.isLoop=!1,this.stopRequested=!1}setNodes(e,t,i){this.sourceNode=e,this.gainNode=t,this.panNode=i,this.stopRequested?this.stop():(this.volumeRequested&&(t.gain.value=this.volumeRequested),this.panRequested&&(i.pan.value=this.panRequested))}isPlaying(){return this.playing}stop(){try{this.sourceNode instanceof AudioBufferSourceNode?this.sourceNode.stop():this.sourceNode instanceof MediaElementAudioSourceNode?this.sourceNode.mediaElement?.pause():this.stopRequested=!0,this.playing=!1}catch(e){console.error(e)}}setVolume(e){this.gainNode?this.gainNode.gain.value=e:this.volumeRequested=e}setPan(e){this.panNode?this.panNode.pan.value=e:this.panRequested=e}})}}})),System.register("engine/sound/AudioLoop",["util/math"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("AudioLoop",class{constructor(e,t,i,r,s,n,a,o,l){this.audioContext=e,this.volume=t,this.pan=i,this.rate=r,this.delayMs=s,this.attack=n,this.decay=a,this.playBuffer=l,this.isLoop=!0,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.fill(this.buffers),this.remainingLoops||this.items.length||this.stop())},this.remainingLoops=o}setBuffers(e){this.buffers=e,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(e){if(this.playing)throw new Error("Already playing");this.timePointer=e,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){var e;this.playing&&(this.playing=!1,this.decay&&this.buffers?(this.removeCompleted(),this.items.length&&(e=this.items[0].startTime+this.items[0].duration,this.items.splice(1).forEach((e=>e.handle.stop())),this.queueBuffer(this.buffers[this.buffers.length-1],e))):(this.items.forEach((e=>e.handle.stop())),this.items.length=0))}setVolume(e){this.volume=e,this.items.forEach((t=>t.handle.setVolume(e)))}setPan(e){this.pan=e,this.items.forEach((t=>t.handle.setPan(e)))}add(e){this.items.push(e)}removeCompleted(){this.items=this.items.filter((e=>e.startTime+e.duration>=this.audioContext.currentTime))}fill(e){let t=this.items.length?this.timePointer-this.items[0].startTime:0;for(;t<.1||this.items.length<3;){if(!this.attack||void 0!==this.bufferPointer){if(this.remainingLoops<=0)break;this.remainingLoops--}this.attack?this.bufferPointer=void 0===this.bufferPointer?0:i.getRandomInt(1,e.length-1-(this.decay?1:0)):this.bufferPointer=i.getRandomInt(0,e.length-1);var r=e[this.bufferPointer];r=this.queueBuffer(r,this.timePointer);this.timePointer+=r,t+=r}}queueBuffer(e,t){var r=this.delayMs?i.getRandomInt(this.delayMs.min,this.delayMs.max)/1e3:0,s=t+r,n=e.duration/this.rate;let{handle:a,source:o}=this.playBuffer(e,s,this.volume,this.pan,this.rate);return o.addEventListener("ended",this.handleSoundEnded),this.add({startTime:s,duration:n,handle:a}),n+r}})}}})),System.register("engine/sound/AudioSequence",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("AudioSequence",class{constructor(e,t,i,r,s,n){this.audioContext=e,this.volume=t,this.pan=i,this.rate=r,this.delayMs=s,this.playBuffer=n,this.isLoop=!1,this.items=[],this.playing=!1,this.handleSoundEnded=()=>{this.playing&&(this.removeCompleted(),this.items.length||(this.playing=!1))}}setBuffers(e){this.buffers=e,this.playing&&(this.timePointer=Math.max(this.timePointer,this.audioContext.currentTime),this.fill(this.buffers))}start(e){if(this.playing)throw new Error("Already playing");this.timePointer=e,this.playing=!0,this.buffers&&this.fill(this.buffers)}isPlaying(){return this.playing}stop(){this.playing&&(this.playing=!1,this.items.forEach((e=>e.handle.stop())),this.items.length=0)}setVolume(e){this.volume=e,this.items.forEach((t=>t.handle.setVolume(e)))}setPan(e){this.pan=e,this.items.forEach((t=>t.handle.setPan(e)))}add(e){this.items.push(e)}removeCompleted(){this.items=this.items.filter((e=>e.startTime+e.duration>=this.audioContext.currentTime))}fill(e){let t=this.delayMs?this.delayMs/1e3:0;for(var i of e)i=this.queueBuffer(i,this.timePointer,t),this.timePointer+=i,t=0}queueBuffer(e,t,i){var r=t+i,s=e.duration/this.rate;let{handle:n,source:a}=this.playBuffer(e,r,this.volume,this.pan,this.rate);return a.addEventListener("ended",this.handleSoundEnded),this.add({startTime:r,duration:s,handle:n}),s+i}})}}})),System.register("engine/sound/AudioSystem",["engine/sound/ChannelType","util/disposable/CompositeDisposable","engine/sound/InternalPlaybackHandle","engine/sound/AudioLoop","engine/sound/AudioSequence"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("AudioSystem",class{constructor(e){this.mixer=e,this.channels=new Map,this.audioBufferCache=new Map,this.disposables=new r.CompositeDisposable,this.soundsPlaying=new Set,this.handleVolumeChange=(e,t)=>{this.getChannel(e).gain.value=t.isMuted(e)?0:t.getVolume(e)}}isInitialized(){return!!this.audioContext}isSuspended(){return"running"!==this.audioContext?.state}async canAutoPlay(){let e,t=document.createElement("audio");t.src="data:audio/mpeg;base64,/+MYxAAAAANIAUAAAASEEB/jwOFM/0MM/90b/+RhST//w4NFwOjf///PZu////9lns5GFDv//l9GlUIEEIAAAgIg8Ir/JGq3/+MYxDsLIj5QMYcoAP0dv9HIjUcH//yYSg+CIbkGP//8w0bLVjUP///3Z0x5QCAv/yLjwtGKTEFNRTMuOTeqqqqqqqqqqqqq/+MYxEkNmdJkUYc4AKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq";try{await t.play(),e=!0}catch(t){e=!1}return t.srcObject=null,e}initialize(){this.isInitialized()||(this.audioContext=new AudioContext,this.mixer.onVolumeChange.subscribe(this.handleVolumeChange),this.disposables.add((()=>this.mixer.onVolumeChange.unsubscribe(this.handleVolumeChange))),this.createChannels(this.audioContext,this.mixer))}dispose(){this.disposables.dispose(),this.audioContext&&(this.audioContext.close(),this.soundsPlaying.clear())}createChannels(e,t){let r=Object.keys(i.ChannelType).map(Number).filter((e=>!Number.isNaN(e)));r.forEach((i=>{let r=e.createGain();r.gain.value=t.getVolume(i),this.channels.set(i,r)}));let s=this.getChannel(i.ChannelType.Master);r.forEach((t=>{let r=this.getChannel(t);var n;t===i.ChannelType.Master?r.connect(e.destination):t===i.ChannelType.Effect?(n=e.createDynamicsCompressor(),r.connect(n).connect(s)):r.connect(s)}))}getChannel(e){if(!this.channels.has(e))throw new Error(`Sound channel "${e}" doesn't exist`);return this.channels.get(e)}setMuted(e){this.mixer.setMuted(i.ChannelType.Master,e)}playWavFile(e,t,i=1,r=0,s=0,n=1,a=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");var o=this.audioContext.currentTime+s/1e3;return this.removeSuspendedSounds(),this.playWavFileAtTime(e,t,o,i,r,n,a)}removeSuspendedSounds(){this.isSuspended()&&this.soundsPlaying.forEach((e=>{try{e instanceof AudioBufferSourceNode?e.stop():e.mediaElement?.pause()}catch(e){console.error(e)}}))}playWavLoop(e,t,i=1,r=0,a,o=1,l=!1,c=!1,h=Number.POSITIVE_INFINITY){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let u=this.audioContext;this.removeSuspendedSounds();let d=new n.AudioLoop(u,i,r,o,a,l,c,h,((e,i,r,n,a)=>{var o=new s.InternalPlaybackHandle;return{handle:o,source:this.playAudioBuffer(o,e,t,r,n,i,a,!1)}}));return Promise.all(e.map((e=>this.decodeFile(e,u)))).then((e=>{d.setBuffers(e)})).catch((e=>console.error(e))),d.start(u.currentTime),d}playWavSequence(e,t,i=1,r=0,n=0,o=1){if(!this.isInitialized())throw new Error("Can't play audio sequence because audio system is not initialized");let l=this.audioContext;this.removeSuspendedSounds();let c=new a.AudioSequence(l,i,r,o,n,((e,i,r,n,a)=>{var o=new s.InternalPlaybackHandle;return{handle:o,source:this.playAudioBuffer(o,e,t,r,n,i,a,!1)}}));return Promise.all(e.map((e=>this.decodeFile(e,l)))).then((e=>{c.setBuffers(e)})).catch((e=>console.error(e))),c.start(l.currentTime),c}async decodeFile(e,t){let i=this.audioBufferCache.get(e);var r;return i||(r=new Uint8Array(e.getData()).buffer,i=await t.decodeAudioData(r),100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(e,i)),i}playWavFileAtTime(e,t,i,r=1,n=0,a=1,o=!1){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");let l=this.audioContext,c=new s.InternalPlaybackHandle;var h=this.audioBufferCache.get(e);if(h)this.playAudioBuffer(c,h,t,r,n,i,a,o);else{let s;try{var u=e.getData();s=new Uint8Array(u).buffer}catch(h){return console.error("Failed to decode wav file",h),c}(async()=>{var h=await l.decodeAudioData(s);100<=this.audioBufferCache.size&&this.audioBufferCache.delete(this.audioBufferCache.keys().next().value),this.audioBufferCache.set(e,h),c.stopRequested||this.playAudioBuffer(c,h,t,r,n,i,a,o)})().catch((e=>console.error(e)))}return c}playAudioBuffer(e,t,i,r,s,n,a,o){let l=this.audioContext,c=l.createGain();c.gain.value=r;let h=l.createStereoPanner();h.pan.value=s;let u=l.createBufferSource();return u.buffer=t,u.playbackRate.value=a,u.loop=o,u.connect(h).connect(c).connect(this.getChannel(i)),e.setNodes(u,c,h),u.addEventListener("ended",(()=>{this.soundsPlaying.delete(u),e.playing=!1})),this.soundsPlaying.add(u),u.start(n),u}async playMp3File(e,t,i=1,r=0,n=!1,a){if(!this.isInitialized())throw new Error("Can't play audio file because audio system is not initialized");this.removeSuspendedSounds();var o=new s.InternalPlaybackHandle;let l=document.createElement("audio");l.loop=n;let c=l.src=URL.createObjectURL(e.asFile());return l.onended=l.onpause=()=>{URL.revokeObjectURL(c),l=void 0},a&&l.addEventListener("ended",a,{once:!0}),await this.playMedia(o,l,t,i,r),o}async playMedia(e,t,i,r,s){let n=this.audioContext,a=n.createGain();a.gain.value=r;let o=n.createStereoPanner();o.pan.value=s;let l=n.createMediaElementSource(t);return l.connect(o).connect(a).connect(this.getChannel(i)),e.setNodes(l,a,o),l.addEventListener("ended",(()=>{this.soundsPlaying.delete(l),e.playing=!1})),this.soundsPlaying.add(l),await(l.mediaElement.play()?.catch((e=>console.error(e)))),l}})}}})),System.register("engine/sound/SoundKey",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.CreateInfantrySound=0]="CreateInfantrySound",t[t.CreateUnitSound=1]="CreateUnitSound",t[t.CreateAircraftSound=2]="CreateAircraftSound",t[t.SpySatActivationSound=3]="SpySatActivationSound",t[t.SpySatDeactivationSound=4]="SpySatDeactivationSound",t[t.UpgradeVeteranSound=5]="UpgradeVeteranSound",t[t.UpgradeEliteSound=6]="UpgradeEliteSound",t[t.BaseUnderAttackSound=7]="BaseUnderAttackSound",t[t.BuildingGarrisonedSound=8]="BuildingGarrisonedSound",t[t.BuildingRepairedSound=9]="BuildingRepairedSound",t[t.CheerSound=10]="CheerSound",t[t.PlaceBeaconSound=11]="PlaceBeaconSound",t[t.StartPlanningModeSound=12]="StartPlanningModeSound",t[t.EndPlanningModeSound=13]="EndPlanningModeSound",t[t.AddPlanningModeCommandSound=14]="AddPlanningModeCommandSound",t[t.ExecutePlanSound=15]="ExecutePlanSound",t[t.CratePromoteSound=16]="CratePromoteSound",t[t.CrateMoneySound=17]="CrateMoneySound",t[t.CrateRevealSound=18]="CrateRevealSound",t[t.CrateFireSound=19]="CrateFireSound",t[t.CrateArmourSound=20]="CrateArmourSound",t[t.CrateSpeedSound=21]="CrateSpeedSound",t[t.CrateUnitSound=22]="CrateUnitSound",t[t.GUIMainButtonSound=23]="GUIMainButtonSound",t[t.GUIBuildSound=24]="GUIBuildSound",t[t.GUITabSound=25]="GUITabSound",t[t.GUIOpenSound=26]="GUIOpenSound",t[t.GUICloseSound=27]="GUICloseSound",t[t.GUIMoveOutSound=28]="GUIMoveOutSound",t[t.GUIMoveInSound=29]="GUIMoveInSound",t[t.GUIComboOpenSound=30]="GUIComboOpenSound",t[t.GUIComboCloseSound=31]="GUIComboCloseSound",t[t.GUICheckboxSound=32]="GUICheckboxSound",t[t.ScoreAnimSound=33]="ScoreAnimSound",t[t.SinkingSound=34]="SinkingSound",t[t.ImpactWaterSound=35]="ImpactWaterSound",t[t.ImpactLandSound=36]="ImpactLandSound",t[t.BombTickingSound=37]="BombTickingSound",t[t.ChronoInSound=38]="ChronoInSound",t[t.ChronoOutSound=39]="ChronoOutSound",t[t.BombAttachSound=40]="BombAttachSound",t[t.YuriMindControlSound=41]="YuriMindControlSound",t[t.DigSound=42]="DigSound",t[t.CloakSound=43]="CloakSound",t[t.SellSound=44]="SellSound",t[t.GameClosed=45]="GameClosed",t[t.IncomingMessage=46]="IncomingMessage",t[t.MessageCharTyped=47]="MessageCharTyped",t[t.SystemError=48]="SystemError",t[t.OptionsChanged=49]="OptionsChanged",t[t.GameForming=50]="GameForming",t[t.PlayerLeft=51]="PlayerLeft",t[t.PlayerJoined=52]="PlayerJoined",t[t.Construction=53]="Construction",t[t.BuildingDieSound=54]="BuildingDieSound",t[t.BuildingSlam=55]="BuildingSlam",t[t.RadarOn=56]="RadarOn",t[t.RadarOff=57]="RadarOff",t[t.MovieOn=58]="MovieOn",t[t.MovieOff=59]="MovieOff",t[t.ScoldSound=60]="ScoldSound",t[t.TeslaCharge=61]="TeslaCharge",t[t.TeslaZap=62]="TeslaZap",t[t.BuildingDamageSound=63]="BuildingDamageSound",t[t.ChuteSound=64]="ChuteSound",t[t.GenericClick=65]="GenericClick",t[t.GenericBeep=66]="GenericBeep",t[t.BuildingDrop=67]="BuildingDrop",t[t.StopSound=68]="StopSound",t[t.GuardSound=69]="GuardSound",t[t.ScatterSound=70]="ScatterSound",t[t.DeploySound=71]="DeploySound",t[t.StormSound=72]="StormSound",t[t.LightningSounds=73]="LightningSounds",t[t.ShellButtonSlideSound=74]="ShellButtonSlideSound",t[t.QuickMatchTimer=75]="QuickMatchTimer",e("SoundKey",i)}}})),System.register("engine/sound/SoundSpec",["engine/sound/SoundSpecs"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SoundSpec",class{read(e,t){let r=e.getNumber("Range",t.range);var s;return-2===r&&(r=Number.POSITIVE_INFINITY),this.name=e.name,this.control=new Set(e.getEnumArray("Control",i.SoundControl,/\s+/,[],!0)),this.sounds=e.getArray("Sounds",/\s+/).map((e=>e.replace(/^\$/,""))),this.volume=e.has("Volume")?e.getNumber("Volume",t.volume):e.getNumber("volume",t.volume),this.delay=this.createMinMaxPair(e.getNumberArray("Delay",/\s+/,[])),this.priority=e.getEnum("Priority",i.SoundPriority,t.priority,!0),this.type=e.getEnumArray("Type",i.SoundType,/\s+/,t.type,!0),this.type.some((e=>[i.SoundType.Screen,i.SoundType.Local,i.SoundType.Global].includes(e)))||(s=t.type.find((e=>[i.SoundType.Screen,i.SoundType.Local,i.SoundType.Global].includes(e))))&&this.type.push(s),this.fShift=this.createMinMaxPair(e.getNumberArray("FShift",/\s+/,[])),this.limit=e.getNumber("Limit",t.limit),this.loop=e.getNumber("Loop"),this.range=r,this.minVolume=e.getNumber("MinVolume",t.minVolume),this.vShift=this.createMinMaxPair(e.getNumberArray(e.has("Vshift")?"Vshift":"VShift",/\s+/,[])),this.attack=e.getNumber("Attack"),this.decay=e.getNumber("Decay"),this}createMinMaxPair(e){if(e.length){let[t,i]=e;return void 0===i&&(i=t),{min:t,max:i}}}})}}})),System.register("engine/sound/SoundSpecs",["engine/sound/SoundSpec"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Global=0]="Global",t[t.Normal=1]="Normal",t[t.Screen=2]="Screen",t[t.Local=3]="Local",t[t.Player=4]="Player",t[t.Unshroud=5]="Unshroud",t[t.Shroud=6]="Shroud",e("SoundType",r),(t=s=s||{})[t.Lowest=0]="Lowest",t[t.Low=1]="Low",t[t.Normal=2]="Normal",t[t.High=3]="High",t[t.Critical=4]="Critical",e("SoundPriority",s),(t=n=n||{})[t.All=0]="All",t[t.Loop=1]="Loop",t[t.Random=2]="Random",t[t.Predelay=3]="Predelay",t[t.Interrupt=4]="Interrupt",t[t.Attack=5]="Attack",t[t.Decay=6]="Decay",t[t.Ambient=7]="Ambient",e("SoundControl",n),e("SoundSpecs",class{constructor(e){this.ini=e,this.specs=new Map,this.parse()}parse(){let e=this.ini.getSection("Defaults");if(e){this.defaults={minVolume:e.getNumber("MinVolume"),range:e.getNumber("Range"),volume:e.getNumber("Volume"),limit:e.getNumber("Limit"),type:e.getEnumArray("Type",r,/\s+/,[],!0),priority:e.getEnum("Priority",s,s.Normal,!0)};let a=this.ini.getSection("SoundList");var t,n;if(a)for(t of new Set(a.entries.values()))t&&((n=this.ini.getSection(t))?this.specs.set(t,(new i.SoundSpec).read(n,this.defaults)):console.warn(`Missing sound section [${t}]`));else console.warn("Missing sound [SoundList] section. Sounds will not be played.")}else console.warn("Missing sound [Defaults] section. Sounds will not be played.")}getSpec(e){return this.specs.get(e)}getAll(){return[...this.specs.values()]}})}}})),System.register("engine/sound/Sound",["engine/sound/ChannelType","engine/sound/SoundKey","engine/sound/SoundSpecs","util/math","util/typeGuard"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("Sound",class{constructor(e,t,s,n,a){this.audioSystem=e,this.audioFiles=t,this.soundSpecs=s,this.audioVisualRules=n,this.document=a,this.playbackHandles=new Map,this.handleClick=e=>{let t=e.target;t.matches("button, .menu-button:not(.disabled)")?this.play(r.SoundKey.GUIMainButtonSound,i.ChannelType.Ui):t.matches(".list-item")?this.play(r.SoundKey.GenericClick,i.ChannelType.Ui):t instanceof HTMLInputElement&&["checkbox","radio","range"].includes(t.type)&&!t.disabled?this.play(r.SoundKey.GUICheckboxSound,i.ChannelType.Ui):(t instanceof HTMLSelectElement&&!t.disabled||t.matches(".select:not(.disabled) *"))&&this.play(r.SoundKey.GUIComboOpenSound,i.ChannelType.Ui)}}initialize(){this.audioSystem.initialize(),this.document.addEventListener("click",this.handleClick)}dispose(){this.audioSystem.dispose(),this.document.removeEventListener("click",this.handleClick)}getSoundKey(e){let t;if("string"==typeof r.SoundKey[e]){if(t=this.audioVisualRules.ini.getString(r.SoundKey[e]),!t)return}else t=e;return t}getSoundSpec(e){var t=this.getSoundKey(e);if(t){var i=this.soundSpecs.getSpec(t);if(i)return i;console.warn(`Sound "${t}" is not defined`)}else console.warn(`No sound is defined for key "${r.SoundKey[e]}"`)}play(e,t){let i=this.getSoundSpec(e);if(i){var r=i.control.has(s.SoundControl.Loop)?i.loop||Number.POSITIVE_INFINITY:0;return this.playWithOptions(i,t,i.volume/100,0,i.limit,r)}}playWithOptions(e,t,i,r,o,l){if(e.sounds.length){this.cleanOldHandles();let p=this.playbackHandles.get(e.name);if(p||(p=[],this.playbackHandles.set(e.name,p)),o&&p.length>=o){if(!e.control.has(s.SoundControl.Interrupt))return;p.shift().stop()}var c=1+(e.fShift?n.getRandomInt(e.fShift.min,e.fShift.max)/100:0);let m;var h=e.control.has(s.SoundControl.Attack),u=e.control.has(s.SoundControl.Decay);if(l&&(1<e.sounds.length||l!==Number.POSITIVE_INFINITY||e.delay)){var d=this.buildAttackDecaySequence(e,h,u,!0).map((e=>this.getWavFile(e))).filter(a.isNotNullOrUndefined);m=this.audioSystem.playWavLoop(d,t,i,r,e.delay,c,h,u,l)}else{let o=0;if(e.delay&&(o=n.getRandomInt(e.delay.min,e.delay.max)),h||u){var g=this.buildAttackDecaySequence(e,h,u,!1).map((e=>this.getWavFile(e))).filter(a.isNotNullOrUndefined);m=this.audioSystem.playWavSequence(g,t,i,r,o,c)}else{let a;if(a=e.control.has(s.SoundControl.Random)?e.sounds[n.getRandomInt(0,e.sounds.length-1)]:e.sounds[0],!(g=this.getWavFile(a)))return;m=this.audioSystem.playWavFile(g,t,i,r,o,c,0!==l)}}return m&&p.push(m),m}}buildAttackDecaySequence(e,t,i,r){var s=t?e.attack||1:0,a=i?e.decay||1:0,o=e.sounds.slice(s,e.sounds.length-a);let l=[];return 0<s&&(s=e.sounds[n.getRandomInt(0,s-1)],l.push(s)),r?l.push(...o):l.push(o[n.getRandomInt(0,o.length-1)]),0<a&&(a=e.sounds[n.getRandomInt(e.sounds.length-a,e.sounds.length-1)],l.push(a)),l}getWavFile(e){var t=e+".wav",i=this.audioFiles.get(t);if(i)return i;console.error(`Audio file "${t}" not found.`)}cleanOldHandles(){for(var[e,t]of this.playbackHandles)t=t.filter((e=>e.isPlaying())),this.playbackHandles.set(e,t)}})}}})),System.register("engine/util/WorldViewportHelper",["engine/IsoCoords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WorldViewportHelper",class{constructor(e){this.scene=e}distanceToViewport(e){var t=this.scene.viewport;t=new THREE.Box2(new THREE.Vector2(t.x,t.y),new THREE.Vector2(t.x+t.width-1,t.x+t.height-1));return this.distanceToScreenBox(e,t)}distanceToScreenBox(e,t){var r=i.IsoCoords.vecWorldToScreen(e),s=i.IsoCoords.worldToScreen(0,0),n=this.scene.cameraPan.getPan();return t.distanceToPoint(new THREE.Vector2(r.x-s.x-n.x+this.scene.viewport.width/2,r.y-s.y-n.y+this.scene.viewport.height/2))}distanceToViewportCenter(e){var t=i.IsoCoords.vecWorldToScreen(e),r=i.IsoCoords.worldToScreen(0,0),s=this.scene.cameraPan.getPan(),n=this.scene.viewport;return new THREE.Vector2(t.x-r.x-s.x+this.scene.viewport.width/2,t.y-r.y-s.y+this.scene.viewport.height/2).sub(new THREE.Vector2(n.x+n.width/2,n.y+n.height/2))}intersectsScreenBox(e,t){return 0===this.distanceToScreenBox(e,t)}})}}})),System.register("engine/util/MapTileIntersectHelper",["util/geometry","game/Coords","engine/IsoCoords"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("MapTileIntersectHelper",class{constructor(e,t){this.map=e,this.scene=t}getTileAtScreenPoint(e){var t=this.scene.viewport;if(i.rectContainsPoint(t,e))return(t=this.intersectTilesByScreenPos(e)).length?t[0]:void 0}intersectTilesByScreenPos(e){var t=s.IsoCoords.worldToScreen(0,0),i=this.scene.cameraPan.getPan(),n=(t={x:e.x+t.x+i.x-this.scene.viewport.width/2,y:e.y+t.y+i.y-this.scene.viewport.height/2},i=s.IsoCoords.screenToWorld(t.x,t.y),i=new THREE.Vector2(i.x,i.y).multiplyScalar(1/r.Coords.LEPTONS_PER_TILE).floor(),this.map.tiles.getByMapCoords(i.x,i.y));if(!n)return console.warn(`Tile coordinates (${i.x},${i.y}) out of range`),[];let a=[];var o;for(let e=0;e<30;e++)for(o of[{x:n.rx+e,y:n.ry+e},{x:n.rx+e+1,y:n.ry+e},{x:n.rx+e,y:n.ry+e+1}]){var l={x:o.x,y:o.y};(l=this.map.tiles.getByMapCoords(l.x,l.y))&&a.push(l)}let c=[],h=new THREE.Triangle;var u,d=new THREE.Vector3(t.x,0,t.y);for(u of a){var g=s.IsoCoords.tile3dToScreen(u.rx,u.ry,u.z),p=s.IsoCoords.tile3dToScreen(u.rx,u.ry+1.1,u.z),m=s.IsoCoords.tile3dToScreen(u.rx+1.1,u.ry,u.z),f=s.IsoCoords.tile3dToScreen(u.rx+1.1,u.ry+1.1,u.z);h.b.x=p.x,h.b.z=p.y,h.c.x=m.x,h.c.z=m.y,h.a.x=g.x,h.a.z=g.y,g=h.containsPoint(d),h.a.x=f.x,h.a.z=f.y,f=h.containsPoint(d),(g||f)&&c.unshift(u)}for(;!c.length;)c=this.intersectTilesByScreenPos({x:e.x,y:e.y-s.IsoCoords.tileHeightToScreen(1)});return c}})}}})),System.register("engine/sound/WorldSound",["engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/SoundSpecs","util/math","util/geometry","game/map/MapShroud","game/Coords","util/typeGuard"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("WorldSound",h=class e{constructor(t,i,r,s,n,o,l,h){this.sound=t,this.localPlayer=i,this.shroud=r,this.worldViewportHelper=s,this.mapTileIntersectHelper=n,this.world=o,this.worldScene=l,this.renderer=h,this.soundInstances=[],this.handleObjectRemoved=e=>{this.soundInstances.forEach((t=>{t.gameObject===e&&t.handle.stop()}))},this.handleFrame=e=>{let t=!1;this.lastViewport&&a.rectEquals(this.worldScene.viewport,this.lastViewport)||(this.lastViewport=this.worldScene.viewport,t=!0),(!this.lastUpdate||200<=e-this.lastUpdate)&&(t=!0),t&&(this.update(),this.lastUpdate=e)},this.noShroudSpecs=e.noShroudKeys.map((e=>{var t=this.sound.getSoundSpec(e);if(t)return t;console.warn(`Sound key "${e}" doesn't have a corresponding sound.ini entry`)})).filter(c.isNotNullOrUndefined)}init(){this.renderer.onFrame.subscribe(this.handleFrame),this.world.onObjectRemoved.subscribe(this.handleObjectRemoved)}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.world.onObjectRemoved.unsubscribe(this.handleObjectRemoved),this.soundInstances.forEach((e=>e.handle.stop()))}update(){var e=this.mapTileIntersectHelper.getTileAtScreenPoint({x:this.worldScene.viewport.x+this.worldScene.viewport.width/2,y:this.worldScene.viewport.y+this.worldScene.viewport.height/2});if(e){this.tileAtViewportCenter=e,this.cleanOldInstances();let r=new Map;for(var t of this.soundInstances){var i=t.gameObject?.position.worldPosition??t.worldPos;let{volume:e,pan:s}=this.computeVolumeAndPan(t.spec,i,t.player,t.gain);0<e&&(i=r.get(t.spec)??0,t.loop&&i>=t.spec.limit?e=0:r.set(t.spec,i+1)),t.handle.setVolume(e),t.handle.setPan(s),t.volume=e}}else console.warn("No tile found at viewport center. Can't update local sound positions.")}cleanOldInstances(){this.soundInstances=this.soundInstances.filter((e=>e.handle.isPlaying()))}playEffect(e,t,i,n=1,a){let o=this.sound.getSoundSpec(e);if(o&&(!o.type.includes(s.SoundType.Player)||i===this.localPlayer)){let e,u;t.position?(e=t.position.worldPosition,u=t):e=t;var l=o.control.has(s.SoundControl.Loop)||o.control.has(s.SoundControl.Ambient),c=l?o.loop||Number.POSITIVE_INFINITY:0;l&&void 0!==a&&(n=a);let{volume:d,pan:g}=this.computeVolumeAndPan(o,e,i,n),p=o.limit;if(l&&o.limit&&(p=0,this.cleanOldInstances(),this.soundInstances.filter((e=>e.spec===o&&0<e.volume)).length>=o.limit&&(d=0)),l||d||!o.limit){var h=o.control.has(s.SoundControl.Ambient)||o.name.startsWith("_Amb_")?r.ChannelType.Ambient:r.ChannelType.Effect;return(c=this.sound.playWithOptions(o,h,d,g,p,c))&&this.soundInstances.push({spec:o,gameObject:u,worldPos:e,player:i,handle:c,gain:n,volume:d,loop:l}),c}}}computeVolumeAndPan(e,t,i,r=1){let a=e.volume/100,c=0;var h,u,d;return e.type.includes(s.SoundType.Global)&&i!==this.localPlayer&&(a=e.minVolume/100),a*=r,(e.type.includes(s.SoundType.Screen)||e.type.includes(s.SoundType.Global))&&(h=this.worldViewportHelper.distanceToViewportCenter(t),c=n.clamp(h.x/(this.worldScene.viewport.width/2),-1,1)),e.type.includes(s.SoundType.Screen)?(u=this.worldViewportHelper.distanceToViewport(t),d=(this.worldScene.viewport.height+this.worldScene.viewport.width)/2/3,a*=THREE.Math.lerp(1,0,Math.min(1,u/d))):e.type.includes(s.SoundType.Local)&&(this.tileAtViewportCenter?(u=new THREE.Vector2(t.x/l.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.rx,t.z/l.Coords.LEPTONS_PER_TILE-this.tileAtViewportCenter.ry).length(),(d=e.range*Math.SQRT2)<u?a=0:(e.vShift&&(a*=n.getRandomInt(e.vShift.min,e.vShift.max)/100),a*=1-Math.min(1,(u/d)**2))):a=0),this.noShroudSpecs.includes(e)&&!e.type.includes(s.SoundType.Global)&&this.shroud?.getShroudTypeByTileCoords(Math.floor(t.x/l.Coords.LEPTONS_PER_TILE),Math.floor(t.z/l.Coords.LEPTONS_PER_TILE),Math.floor(l.Coords.worldToTileHeight(t.y)))===o.ShroudType.Unexplored&&(a=0),{volume:a,pan:c}}}),h.noShroudKeys=[i.SoundKey.BuildingSlam,i.SoundKey.SellSound,i.SoundKey.BuildingGarrisonedSound,i.SoundKey.BuildingRepairedSound,i.SoundKey.SpySatActivationSound,i.SoundKey.SpySatDeactivationSound]}}})),System.register("engine/gfx/MathUtils",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MathUtils",class{static rotateObjectAboutPoint(e,t,i,r,s=!1){(s=void 0!==s&&s)&&e.parent.localToWorld(e.position),e.position.sub(t),e.position.applyAxisAngle(i,r),e.position.add(t),s&&e.parent.worldToLocal(e.position),e.rotateOnAxis(i,r)}static translateTowardsCamera(e,t,i){var r=(new THREE.Quaternion).setFromEuler(t.rotation);e.setRotationFromQuaternion(r),e.translateZ(i*Math.cos(t.rotation.y)),e.setRotationFromEuler(new THREE.Euler(0,0,0))}})}}})),System.register("engine/renderable/entity/Anim",["engine/renderable/WithPosition","engine/AnimProps","engine/Animation","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/animation/SimpleRunner","engine/gfx/MathUtils","game/Coords"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){e("Anim",class{constructor(e,t,r,s,n,a,o,l,c,h=new THREE.Vector3(0,0,0),u,d){this.objectArt=t,this.extraOffset=r,this.imageFinder=s,this.theater=n,this.camera=a,this.debugFrame=o,this.gameSpeed=l,this.useSpriteBatching=c,this.extraLight=h,this.worldSound=u,this.renderOrder=0,this.name=e,this.palette=d??this.theater.getPalette(this.objectArt.paletteType,this.objectArt.customPaletteName),this.withPosition=new i.WithPosition}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="anim_"+this.name,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(e){if(this.animationRunner){(i=this.objectArt.startSound??this.objectArt.report)&&!this.soundHandle&&this.animation?.getState()===s.AnimationState.NOT_STARTED&&(this.soundHandle=this.worldSound?.playEffect(i,this.withPosition.getPosition(),void 0,1,.25)),this.animationRunner.tick(e),this.mainObj.get3DObject().visible=this.animation.getState()!==s.AnimationState.DELAYED,this.mainObj.setFrame(this.animationRunner.getCurrentFrame());var t=this.objectArt.translucent,i=this.objectArt.translucency;if(t||0<i){let e;e=t?(t=this.animation.props,1-this.animationRunner.getCurrentFrame()/(t.end-t.start)):1-i,this.mainObj.setOpacity(e)}}}createObjects(e){var t={width:1,height:1};this.debugFrame.value&&(n=o.DebugUtils.createWireframe(t,0),e.add(n));let i=new l.MapSpriteTranslation(t.width,t.height);var{spriteOffset:r,anchorPointWorld:s}=i.compute(),n=this.computeSpriteAnchorOffset(r);let a=new THREE.Object3D;if(a.matrixAutoUpdate=!1,this.mainObj=this.createMainObject(n),this.mainObj){if(this.mainObj.setExtraLight(this.extraLight),t=this.useSpriteBatching&&!this.renderOrder,this.mainObj.setBatched(t),t&&this.mainObj.setBatchPalettes([this.palette]),r=this.objectArt.translucent,n=this.objectArt.translucency,(r||0<n)&&this.mainObj.setForceTransparent(!0),this.mainObj.create3DObject(),this.renderOrder){if(t)throw new Error("Render order not supported with batching");this.mainObj.getShapeMesh().renderOrder=this.renderOrder,this.mainObj.getShapeMesh().material.depthTest=!this.renderOrder,this.mainObj.getShapeMesh().material.transparent=!!this.renderOrder}a.add(this.mainObj.get3DObject()),a.position.x=s.x,a.position.z=s.y,this.objectArt.zAdjust&&h.MathUtils.translateTowardsCamera(a,this.camera,-this.objectArt.zAdjust*u.Coords.ISO_WORLD_SCALE),a.updateMatrix(),e.add(a)}}setExtraLight(e){this.extraLight=e,this.mainObj?.setExtraLight(this.extraLight)}setRenderOrder(e){if(this.mainObj)throw new Error("Render order must be set before 3DObject is created");this.renderOrder=e}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x+this.extraOffset.x,y:e.y+t.y+this.extraOffset.y}}createMainObject(e){let t;try{t=this.shpFile=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(e instanceof a.ImageFinder.MissingImageError)return void console.warn(e.message);throw e}let i=n.ShpRenderable.factory(t,this.palette,this.camera,e);i.setFlat(this.objectArt.flat);var o=new r.AnimProps(this.objectArt.art,t);return this.animation=new s.Animation(o,this.gameSpeed),this.animationRunner=new c.SimpleRunner,this.animationRunner.animation=this.animation,i}getAnimProps(){return this.animation?.props}getShpFile(){return this.shpFile}remapColor(e){if(this.mainObj)throw new Error("Palette can only be remapped before creating 3DObject");let t=this.palette.clone();t.remap(e),this.palette=t}isAnimFinished(){return this.animation?.getState()===s.AnimationState.STOPPED}isAnimNotStarted(){return this.animation?.getState()===s.AnimationState.NOT_STARTED}endAnimationLoop(){this.animation?.endLoopAndPlayToEnd()}reset(){this.animation?.reset()}dispose(){this.mainObj?.dispose(),this.soundHandle?.isLoop&&this.soundHandle.stop()}})}}})),System.register("engine/renderable/fx/Effect",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/renderable/fx/RallyPointFx",["three.meshline","game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("RallyPointFx",class{constructor(e,t,i,r,s){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.renderOrder=s,this.needsUpdate=!1,this.visible=!0,this.cameraHash=this.camera.top+"_"+this.camera.right}setContainer(e){this.container=e}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.matrixAutoUpdate=!1,this.lineMesh=this.createLineMesh(),this.lineMesh.name="fx_rallypoint",this.lineMesh.matrixAutoUpdate=!1,this.shadowLineMesh=this.createLineShadowMesh(),this.shadowLineMesh.name="fx_rallypoint_shadow",this.shadowLineMesh.matrixAutoUpdate=!1,this.wrapper.add(this.lineMesh),this.wrapper.add(this.shadowLineMesh))}update(e){this.lastUpdateMillis||(this.lastUpdateMillis=e);let t=(e-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=e,this.wrapper.visible=this.visible;var i=this.camera.top+"_"+this.camera.right;if(i!==this.cameraHash&&(this.cameraHash=i,[this.lineMesh,this.shadowLineMesh].forEach((e=>{e.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))}))),this.needsUpdate){this.needsUpdate=!1,this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),this.shadowLineMesh.geometry=this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.lineMesh.material.uniforms.color.value=this.color.clone();let e=this.sourcePos.distanceTo(this.targetPos);[this.lineMesh,this.shadowLineMesh].forEach((t=>{let i=t.material;i.uniforms.dashArray.value=this.computeDashArray(e),i.depthTest=void 0===this.renderOrder})),this.lineMesh.renderOrder=this.renderOrder??0,this.shadowLineMesh.renderOrder=void 0!==this.renderOrder?this.renderOrder-1:0}[this.lineMesh,this.shadowLineMesh].forEach((e=>{let i=e.material;i.uniforms.dashOffset.value-=i.uniforms.dashArray.value/50*t}))}createLineMesh(){let e=this.sourcePos.clone();var t=this.targetPos.clone();let i=new THREE.Mesh(this.createLineGeometry(e,t),this.createLineMaterial(this.color.clone(),e.distanceTo(t)));return this.renderOrder&&(i.renderOrder=this.renderOrder),i}createLineShadowMesh(){let e=new THREE.Mesh(this.createShadowLineGeometry(this.sourcePos,this.targetPos),this.createLineMaterial(new THREE.Color(0),this.sourcePos.distanceTo(this.targetPos)));return this.renderOrder&&(e.renderOrder=this.renderOrder-1),e}createShadowLineGeometry(e,t){var i=new THREE.Vector3(+r.Coords.ISO_WORLD_SCALE,0,+r.Coords.ISO_WORLD_SCALE);return this.createLineGeometry(e.clone().add(i),t.clone().add(i))}createLineGeometry(e,t){let r=new THREE.Geometry;r.vertices.push(e,t);let s=new i.MeshLine;return s.setGeometry(r),s.geometry}createLineMaterial(e,t){return new i.MeshLineMaterial({color:e,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(t),depthTest:void 0===this.renderOrder})}computeDashArray(e){return Math.min(1,5/e)*r.Coords.ISO_WORLD_SCALE}computeResolution(e){var t=e.top,i=e.right/e.top,s=2*t/Math.cos(e.rotation.y);return new THREE.Vector2(s*i,s).multiplyScalar(t*Math.cos(this.camera.rotation.x)/r.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&[this.lineMesh,this.shadowLineMesh].forEach((e=>{e&&(e.geometry.dispose(),e.material.dispose())}))}})}}})),System.register("engine/renderable/entity/unit/FlyerHelperMode",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Always=0]="Always",t[t.Selected=1]="Selected",t[t.Never=2]="Never",e("FlyerHelperMode",i)}}})),System.register("engine/renderable/entity/unit/DebugLabel",["engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/Coords"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("DebugLabel",class{constructor(e,t,i){this.text=e,this.color=t,this.camera=i}get3DObject(){return this.mesh}create3DObject(){if(!this.mesh){let t=new THREE.Color(this.color);var e=.5<.299*t.r+.587*t.g+.114*t.b?"black":"white";e=this.texture=this.createTexture(this.text,"#"+t.getHexString(),e);this.mesh=this.createMesh(e)}}createMesh(e){var t=i.SpriteUtils.createSpriteGeometry({texture:e,camera:this.camera,align:{x:0,y:-1},offset:{x:0,y:s.Coords.ISO_TILE_SIZE/4},scale:s.Coords.ISO_WORLD_SCALE}),r=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide,transparent:!0,depthTest:!1,flatShading:!0});let n=new THREE.Mesh(t,r);return n.matrixAutoUpdate=!1,n}createTexture(e,t,i){let s=document.createElement("canvas");s.width=s.height=0;let n=s.getContext("2d"),a=0;for(var o of e.split("\n"))a+=(o=r.CanvasUtils.drawText(n,o,0,a,{color:t,outlineColor:i,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:10,fontWeight:"400",paddingTop:3,paddingBottom:3,paddingLeft:3,paddingRight:3,autoEnlargeCanvas:!0})).height;var l=s.width,c=s.height;c=n.getImageData(0,0,l,c);s.width+=1,s.height+=1,n.putImageData(c,1,1);let h=new THREE.Texture(s);return h.minFilter=THREE.NearestFilter,h.magFilter=THREE.NearestFilter,h.needsUpdate=!0,h.flipY=!0,h}update(){}dispose(){this.texture?.dispose(),this.mesh?.material?.dispose(),this.mesh?.geometry.dispose()}})}}})),System.register("engine/renderable/entity/PipOverlay",["engine/gfx/TextureAtlas","data/Bitmap","engine/gfx/SpriteUtils","game/Coords","engine/gfx/TextureUtils","game/gameobject/selection/SelectionLevel","game/type/PipColor","util/disposable/CompositeDisposable","engine/gfx/OverlayUtils","engine/renderable/fx/RallyPointFx","engine/renderable/entity/unit/FlyerHelperMode","game/gameobject/unit/ZoneType","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","engine/gfx/batch/BatchedMesh","game/gameobject/unit/HealthLevel","engine/renderable/entity/unit/DebugLabel"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){-1,v={width:8,height:11},b=1,S={0:o.SelectionLevel.Hover,2:o.SelectionLevel.Selected,1:o.SelectionLevel.Hover,3:o.SelectionLevel.Hover,4:o.SelectionLevel.Selected,5:o.SelectionLevel.Selected},w=(new Map).set(y.HealthLevel.Green,15).set(y.HealthLevel.Yellow,16).set(y.HealthLevel.Red,17),e("PipOverlay",C=class e{constructor(e,t,i,r,s,n,a,o,l,h,u,d,g,p,m,f){this.paradropRules=e,this.audioVisualRules=t,this.gameObject=i,this.viewer=r,this.alliances=s,this.selectionModel=n,this.imageFinder=a,this.palette=o,this.camera=l,this.strings=h,this.flyerHelperOpt=u,this.hiddenObjectsOpt=d,this.debugTextEnabled=g,this.animFactory=p,this.useSpriteBatching=m,this.useMeshInstancing=f,this.lastPrimaryFactory=!1,this.invalidatedElements=[],this.disposables=new c.CompositeDisposable}static clearCaches(){e.atlasCache?.dispose(),e.atlasCache=void 0,e.atlasImageHandles.clear(),[...e.unitHealthTextures.values()].forEach((e=>e.dispose())),e.unitHealthTextures.clear(),e.unitHealthMaterials.forEach((e=>e.dispose())),e.unitHealthMaterials.clear(),[...e.controlGroupTextures.values()].forEach((e=>e.dispose())),e.controlGroupTextures.clear(),e.controlGroupMaterials.forEach((e=>e.dispose())),e.controlGroupMaterials.clear(),[...e.primaryFactoryTextures.values()].forEach((e=>e.dispose())),e.primaryFactoryTextures.clear(),e.primaryFactoryMaterials.forEach((e=>e.dispose())),e.primaryFactoryMaterials.clear()}create3DObject(){let t=this.rootObj;if(!t){var i;if(t=new THREE.Object3D,t.name="pip_overlay",t.matrixAutoUpdate=!1,e.atlasCache||(i=this.initTexture(),e.atlasCache=i,[...e.atlasImageHandles.keys()].forEach((t=>{var i=s.SpriteUtils.createSpriteGeometry(this.buildSpriteGeometry(t));e.geometries.set(t,i)})),e.material=new m.PaletteBasicMaterial({map:e.atlasCache.getTexture(),palette:a.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1})),this.gameObject.isBuilding()){var r;this.healthBar=this.createBuildingHealthBar(this.gameObject),t.add(this.healthBar),1<=this.gameObject.art.height&&(n=this.selectionBox=this.createBuildingSelectionBox(this.gameObject),t.add(n)),(r=this.createBuildingOccupationInfo(this.gameObject))&&(t.add(r),this.pipsSprite=r),this.lastPipsDataKey=this.gameObject.garrisonTrait?.units.length}else{var{healthBarWrapper:n,selectionBox:r}=this.createUnitHealthBar(this.gameObject);if(this.healthBar=n,this.selectionBox=r,t.add(this.healthBar),this.gameObject.art.isVoxel&&(this.gameObject.rules.consideredAircraft||this.gameObject.isAircraft())&&!this.gameObject.rules.missileSpawn){let e=this.animFactory(this.audioVisualRules.flyerHelper);this.flyHelper=e,e.create3DObject(),t.add(e.get3DObject())}if(this.gameObject.isUnit()){let e=this.animFactory(this.audioVisualRules.behind);e.setRenderOrder(999995),this.behindAnim=e}}if(this.gameObject.debugLabel&&this.debugTextEnabled.value){let e=new T.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=e,e.create3DObject(),e.get3DObject().renderOrder=999999,t.add(e.get3DObject())}this.lastHealth=this.gameObject.healthTrait.health,this.lastOwner=this.gameObject.owner,this.rootObj=t}}onCreate(e){this.gameObject.isBuilding()&&this.gameObject.rallyTrait&&(this.rallyLine=new u.RallyPointFx(this.camera,new THREE.Vector3,new THREE.Vector3,new THREE.Color,999999),this.rallyLine.visible=!1,e.addEffect(this.rallyLine),this.disposables.add((()=>this.rallyLine.remove()),this.rallyLine))}initTexture(){e.pipBrdFile=this.imageFinder.find("pipbrd",!1),e.pipsFile=this.imageFinder.find("pips",!1),e.pips2File=this.imageFinder.find("pips2",!1);let t=[e.pipBrdFile,e.pipsFile,e.pips2File],s=[];t.forEach((t=>{for(let a=0;a<t.numImages;a++){var i=t.getImage(a),n=new r.IndexedBitmap(i.width,i.height,i.imageData);s.push(n),e.atlasImageHandles.set(i,{bitmap:n,shpFile:t})}}));let n=new i.TextureAtlas;return n.pack(s),n}buildSpriteGeometry(t){if(!e.atlasCache)throw new Error("Must build texture atlas before geometry");let i=e.atlasCache;var{bitmap:r,shpFile:s}=e.atlasImageHandles.get(t);return{texture:i.getTexture(),textureArea:i.getImageRect(r),align:{x:1,y:-1},offset:{x:t.x-Math.floor(s.width/2),y:t.y-Math.floor(s.height/2)},camera:this.camera,scale:n.Coords.ISO_WORLD_SCALE}}createBuildingHealthBar(t){var i=t.art.foundation.height,r=t.healthTrait.health,s=4*n.Coords.ISO_WORLD_SCALE,a=Math.floor(i*n.Coords.getWorldTileSize()/s),o=Math.max(1,Math.floor(r/100*a));let l;l=r>100*this.audioVisualRules.conditionYellow?1:r>100*this.audioVisualRules.conditionRed?2:4,i=l+"_"+i+"_"+o;let c=e.buildingHealthGeoCache.get(i);if(!c){let t=[];var h=e.pipsFile.getImage(0),u=e.pipsFile.getImage(l);for(let i=0;i<a;i++){var d=i<o?u:h;let r=e.geometries.get(d).clone();d=s*i+s/2,r.applyMatrix((new THREE.Matrix4).makeTranslation(s,0,d)),t.push(r)}c=p.BufferGeometryUtils.mergeBufferGeometries(t),e.buildingHealthGeoCache.set(i,c)}let g=this.useMeshInstancing?new f.BatchedMesh(c,e.material,f.BatchMode.Instancing):new THREE.Mesh(c,e.material);return g.matrixAutoUpdate=!1,g.renderOrder=999999,i=t.art.height||.5,g.position.y=n.Coords.tileHeightToWorld(i),g.updateMatrix(),g}createUnitHealthBar(t){var i=!t.isInfantry(),r=t.healthTrait.health,o=t.healthTrait.level;let l=e.unitHealthTextures.get(i);l||(l=this.createUnitHealthTexture(i),e.unitHealthTextures.set(i,l));var c=e.pipBrdFile.getImage(i?0:1),h=w.get(o);if(void 0===h)throw new Error(`Unhandled health level "${o}"`);h=e.pipsFile.getImage(h),h=Math.floor((c.width-2)/h.width),h=(i?1:0)+"_"+(r=Math.max(1,Math.floor(r/100*h)));let u=e.unitHealthGeoCache.get(h);u||(u=s.SpriteUtils.createSpriteGeometry({texture:l,textureArea:{x:0,y:(r-1)*c.height,width:c.width,height:c.height},camera:this.camera,align:{x:0,y:0},scale:n.Coords.ISO_WORLD_SCALE}),e.unitHealthGeoCache.set(h,u));let d=e.unitHealthMaterials.get(i);d||(d=new m.PaletteBasicMaterial({map:l,palette:a.TextureUtils.textureFromPalette(this.palette),alphaTest:.5,flatShading:!0,transparent:!0,depthTest:!1}),e.unitHealthMaterials.set(i,d));let g=this.useSpriteBatching?new f.BatchedMesh(u,d,f.BatchMode.Merging):new THREE.Mesh(u,d);g.matrixAutoUpdate=!1,g.renderOrder=999998,i=n.Coords.screenDistanceToWorld(Math.floor(c.width/2)+-1,0),g.applyMatrix((new THREE.Matrix4).makeTranslation(i.x,0,i.y)),g.updateMatrix(),i=e.geometries.get(c);let p=this.useSpriteBatching?new f.BatchedMesh(i,e.material,f.BatchMode.Merging):new THREE.Mesh(i,e.material);p.matrixAutoUpdate=!1,i=n.Coords.screenDistanceToWorld(Math.floor(e.pipBrdFile.getImage(0).width/2)+-1,0),p.applyMatrix((new THREE.Matrix4).makeTranslation(i.x,0,i.y)),p.updateMatrix(),p.renderOrder=999997;let y=new THREE.Object3D;return y.matrixAutoUpdate=!1,y.add(p),y.add(g),c=n.Coords.screenDistanceToWorld(-Math.floor(c.width/2),0),y.applyMatrix((new THREE.Matrix4).makeTranslation(c.x,n.Coords.tileHeightToWorld(2),c.y)),y.updateMatrix(),{healthBarWrapper:y,selectionBox:p}}createUnitHealthTexture(t){var i=e.pipBrdFile.getImage(t?0:1),s=e.pipsFile.getImage(w.values().next().value).width,n=Math.floor((i.width-2)/s);let a=new r.IndexedBitmap(i.width,i.height*n);for(let t=1;t<=n;++t){var o=t/n*100;let s;if(s=o>100*this.audioVisualRules.conditionYellow?y.HealthLevel.Green:o>100*this.audioVisualRules.conditionRed?y.HealthLevel.Yellow:y.HealthLevel.Red,void 0===(o=w.get(s)))throw new Error(`Unhandled health level "${s}"`);var l=e.pipsFile.getImage(o),c=new r.IndexedBitmap(l.width,l.height,l.imageData),h=(t-1)*i.height;for(let e=0;e<t;e++){var u=l.width*e;a.drawIndexedImage(c,u+1,h+1)}}let d=new THREE.DataTexture(a.data,a.width,a.height,THREE.AlphaFormat);return d.minFilter=THREE.NearestFilter,d.magFilter=THREE.NearestFilter,d.flipY=!0,d.needsUpdate=!0,d}createBuildingSelectionBox(e){let t=new THREE.Object3D;t.matrixAutoUpdate=!1;let i=e.art.foundation,r=n.Coords.getWorldTileSize();return[[0,0],[0,1],[1,1],[1,0]].forEach((([s,a],o)=>{let l=this.createBuildingSelectionCornerMesh();l.matrixAutoUpdate=!1,l.position.set(s*r*i.width,n.Coords.tileHeightToWorld(e.art.height),a*r*i.height),l.rotation.y=o*Math.PI/2,l.scale.set((o%2==0?i.width:i.height)/4*n.Coords.getWorldTileSize(),n.Coords.tileHeightToWorld(e.art.height/4),(o%2==0?i.height:i.width)/4*n.Coords.getWorldTileSize()),l.updateMatrix(),t.add(l)})),t}createBuildingSelectionCornerMesh(){var e=[0,0,0,1,0,0,0,0,0,0,-1,0,0,0,0,0,0,1],t=new Array(e.length).fill(1);let i=new THREE.BufferGeometry;return i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e),3)),i.addAttribute("color",new THREE.BufferAttribute(new Float32Array(t),3)),t=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors}),this.disposables.add(i,t),new THREE.LineSegments(i,t)}createBuildingOccupationInfo(t){if(t.garrisonTrait?.units.length&&!this.objectIsOpaqueToViewer()){var i=t.garrisonTrait.units.length,r=t.rules.maxNumberOccupants;let h=[];var s=4*n.Coords.ISO_WORLD_SCALE,a=e.pipsFile.getImage(6),o=e.pipsFile.getImage(7);for(let c=1;c<=r;c++){var l=c<=i?o:a;let r=e.geometries.get(l).clone();l=s*c+s/2,r.applyMatrix((new THREE.Matrix4).makeTranslation(l,0,t.art.foundation.height*n.Coords.getWorldTileSize())),h.push(r)}var c=p.BufferGeometryUtils.mergeBufferGeometries(h);let u=this.useSpriteBatching?new f.BatchedMesh(c,e.material,f.BatchMode.Merging):new THREE.Mesh(c,e.material);return u.matrixAutoUpdate=!1,u.renderOrder=999999,u}}createPipsSprite(t,i,r=!1){if(!this.objectIsOpaqueToViewer()){let h=[];var s=e.pips2File.getImage(r?12:0).width,a=e.pips2File.getImage(r?13:0);for(let c=0;c<i;c++){let i;if(c<t.length){var o=t[c];let s=r?12:3;o===l.PipColor.Blue?s=5:o===l.PipColor.Red?s=4:o===l.PipColor.Yellow&&(s=2),i=e.pips2File.getImage(s)}else i=a;let u=e.geometries.get(i).clone();o=s*c+s/2,o=n.Coords.screenDistanceToWorld(-Math.floor(e.pipBrdFile.getImage(this.gameObject.isInfantry()?1:0).width/2)+o,Math.floor(a.height/2)+3),u.applyMatrix((new THREE.Matrix4).makeTranslation(o.x,0,o.y)),h.push(u)}var c=p.BufferGeometryUtils.mergeBufferGeometries(h);let u=this.useSpriteBatching?new f.BatchedMesh(c,e.material,f.BatchMode.Merging):new THREE.Mesh(c,e.material);return u.renderOrder=999996,u}}createControlGroupTexture(e){let t=document.createElement("canvas"),i=t.getContext("2d",{alpha:!1});var r=b,s=v;t.width=10*(s.width+2*r),t.height=s.height+2*r,i.fillStyle="#000",i.fillRect(0,0,t.width,t.height),i.strokeStyle=e.asHexString(),i.fillStyle=e.asHexString(),i.font="bold 12px Arial, sans-serif";for(let e=0;e<10;e++){var n=(s.width+2*r)*e;i.strokeRect(.5+n,.5,s.width+2*r-1,t.height-1),i.fillText(String(e),n+r+.5,s.height)}let a=new THREE.Texture(t);return a.minFilter=THREE.NearestFilter,a.magFilter=THREE.NearestFilter,a.needsUpdate=!0,a}createControlGroupSprite(t){let i=this.gameObject.owner.color;e.controlGroupTextures.has(i.asHex())||(a=this.createControlGroupTexture(i),e.controlGroupTextures.set(i.asHex(),a));var r=e.controlGroupTextures.get(i.asHex()),a=s.SpriteUtils.createSpriteGeometry({texture:r,textureArea:{x:t*(v.width+2*b),y:0,width:v.width+2*b,height:v.height+2*b},camera:this.camera,align:{x:1,y:-1},scale:n.Coords.ISO_WORLD_SCALE});let o=e.controlGroupMaterials.get(r);o||(o=new THREE.MeshBasicMaterial({map:r,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),e.controlGroupMaterials.set(r,o));let l=this.useSpriteBatching?new f.BatchedMesh(a,o,f.BatchMode.Merging):new THREE.Mesh(a,o);return l.matrixAutoUpdate=!1,l.renderOrder=999996,l}createPrimaryFactoryTexture(e){var t=h.OverlayUtils.createTextBox(this.strings.get("TXT_PRIMARY"),{color:e.asHexString(),borderColor:e.asHexString(),backgroundColor:"#000",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4});let i=new THREE.Texture(t);return i.minFilter=THREE.NearestFilter,i.magFilter=THREE.NearestFilter,i.needsUpdate=!0,i}createPrimaryFactorySprite(){if(!this.objectIsOpaqueToViewer()){let r=this.gameObject.owner.color;e.primaryFactoryTextures.has(r.asHex())||(i=this.createPrimaryFactoryTexture(r),e.primaryFactoryTextures.set(r.asHex(),i));var t=e.primaryFactoryTextures.get(r.asHex()),i=s.SpriteUtils.createSpriteGeometry({texture:t,camera:this.camera,align:{x:1,y:-1},offset:{x:-Math.floor(t.image.width/2),y:-Math.floor(t.image.height/2)},scale:n.Coords.ISO_WORLD_SCALE});let a=e.primaryFactoryMaterials.get(t);a||(a=new THREE.MeshBasicMaterial({map:t,alphaTest:.5,transparent:!0,depthTest:!1,flatShading:!0}),e.primaryFactoryMaterials.set(t,a));let o=this.useSpriteBatching?new f.BatchedMesh(i,a,f.BatchMode.Merging):new THREE.Mesh(i,a);return o.renderOrder=999999,o}}createVeteranIndicator(t){if(t.veteranLevel){var i=e.pipsFile.getImage(13+t.veteranLevel-1);i=e.geometries.get(i);let r=this.useSpriteBatching?new f.BatchedMesh(i,e.material,f.BatchMode.Merging):new THREE.Mesh(i,e.material);return r.matrixAutoUpdate=!1,r.renderOrder=999996,r.receiveShadow=!1,r}}get3DObject(){return this.rootObj}update(e){let t=this.gameObject;if(t.isDestroyed||t.isCrashing)this.rootObj.visible=!1;else{t.healthTrait.health!==this.lastHealth&&(this.lastHealth=t.healthTrait.health,this.invalidatedElements[0]=!0);let r=this.selectionModel.getSelectionLevel();this.invalidatedElements[0]&&(r>=S[0]||r>=S[3])&&(this.invalidatedElements[0]=void 0,this.updateHealthBarSprite(r));var i=this.computePipsDataKey(t);if(this.lastPipsDataKey===i&&this.lastOwner===t.owner||(this.lastPipsDataKey=i,this.invalidatedElements[1]=!0),this.invalidatedElements[1]&&r>=S[1]&&(this.invalidatedElements[1]=void 0,this.updatePipsSprite()),i=this.selectionModel.getControlGroupNumber(),this.lastControlGroup!==i&&(this.lastControlGroup=i,this.invalidatedElements[3]=!0),this.invalidatedElements[3]&&r>=S[3]&&(this.invalidatedElements[3]=void 0,this.updateControlGroupSprite(i)),i=t.isBuilding()&&!!t.rules.factory&&t.owner.production?.getPrimaryFactory(t.rules.factory)===t,this.lastPrimaryFactory===i&&this.lastOwner===t.owner||(this.lastPrimaryFactory=i,this.invalidatedElements[4]=!0),this.invalidatedElements[4]&&r>=S[4]&&(this.invalidatedElements[4]=void 0,this.updatePrimaryFactorySprite(i)),i=t.isBuilding()&&t.rallyTrait?.getRallyPoint()||void 0,this.lastRallyPoint===i&&this.lastOwner===t.owner||(this.lastRallyPoint=i,this.invalidatedElements[5]=!0),this.invalidatedElements[5]&&r>=S[5]&&this.rallyLine&&(this.invalidatedElements[5]=void 0,this.updateRallyPointLine(i,this.rallyLine)),t.isBuilding()?(i=!t.autoRepairTrait.isDisabled(),this.lastRepairState!==i&&(this.lastRepairState=i,this.updateRepairWrenchSprite(i))):this.lastVeteranLevel!==t.veteranLevel&&(this.lastVeteranLevel=t.veteranLevel,this.updateVeteranIndicatorSprite(t)),this.updateFlyerHelper(r,e),this.updateBehindAnim(e),this.updateDebugLabel(),void 0===this.lastSelectionLevel||this.lastSelectionLevel!==r){this.lastSelectionLevel=r,new Map([[0,this.healthBar],[2,this.selectionBox],[1,this.pipsSprite],[3,this.controlGroupSprite],[4,this.primaryFactorySprite],[5,this.rallyLine]]).forEach(((e,t)=>{e&&(e.visible=r>=S[t])}))}this.lastOwner=t.owner,this.lastDebugTextEnabled=this.debugTextEnabled.value,this.repairWrench?.update(e)}}updateFlyerHelper(e,t){if(this.flyHelper&&this.gameObject.isUnit()){let r;switch(this.flyerHelperOpt.value){case d.FlyerHelperMode.Never:r=!1;break;case d.FlyerHelperMode.Always:r=!0;break;case d.FlyerHelperMode.Selected:r=e>=o.SelectionLevel.Selected;break;default:r=!1}r=r&&this.gameObject.zone===g.ZoneType.Air;let s=this.flyHelper.get3DObject();var i;s.visible=r,r&&(this.flyHelper.update(t),(i=-n.Coords.tileHeightToWorld(this.gameObject.tileElevation))!==s.position.y&&(s.position.y=i,s.updateMatrix()))}}updateBehindAnim(e){this.behindAnim&&(this.hiddenObjectsOpt.value&&this.gameObject.isSpawned&&this.gameObject.tile.occluded&&this.gameObject.art.canBeHidden&&this.gameObject.zone!==g.ZoneType.Air?(this.behindAnim?.update(e),this.behindAnim.get3DObject()?.parent||(this.behindAnim.create3DObject(),this.rootObj.add(this.behindAnim.get3DObject()),this.behindAnim.get3DObject().updateMatrix())):this.behindAnim.get3DObject()?.parent&&this.rootObj.remove(this.behindAnim.get3DObject()))}updateDebugLabel(){if((this.gameObject.debugLabel!==this.lastDebugLabel||this.gameObject.owner!==this.lastOwner||this.debugTextEnabled.value!==this.lastDebugTextEnabled)&&(this.lastDebugLabel=this.gameObject.debugLabel,this.debugLabel&&(this.rootObj.remove(this.debugLabel.get3DObject()),this.debugLabel.dispose(),this.debugLabel=void 0),this.gameObject.debugLabel&&this.debugTextEnabled.value)){let e=new T.DebugLabel(this.gameObject.debugLabel,this.gameObject.owner.color.asHex(),this.camera);this.debugLabel=e,e.create3DObject(),e.get3DObject().renderOrder=999999,this.rootObj.add(e.get3DObject())}}updateRepairWrenchSprite(e){this.repairWrench&&this.rootObj.remove(this.repairWrench.get3DObject()),e&&(this.repairWrench=this.createRepairWrench(),this.repairWrench&&(this.repairWrench.create3DObject(),this.rootObj.add(this.repairWrench.get3DObject())))}updateVeteranIndicatorSprite(t){var i;this.veteranIndicator&&this.rootObj.remove(this.veteranIndicator),this.veteranIndicator=this.createVeteranIndicator(t),this.veteranIndicator&&(this.rootObj.add(this.veteranIndicator),i=n.Coords.screenDistanceToWorld(Math.floor(e.pipBrdFile.getImage(t.isInfantry()?1:0).width/2)-Math.floor(e.pipsFile.getImage(13).width/2),0),this.veteranIndicator.position.x=i.x,this.veteranIndicator.position.y=0,this.veteranIndicator.position.z=i.y,this.veteranIndicator.updateMatrix())}updateRallyPointLine(e,t){t.visible=!1,e&&(this.objectIsOpaqueToViewer()||(t.sourcePos=this.gameObject.position.worldPosition,t.targetPos=n.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z),t.color=new THREE.Color(this.gameObject.owner.color.asHex()),t.needsUpdate=!0,t.visible=!0))}updatePrimaryFactorySprite(e){var t;this.primaryFactorySprite&&this.rootObj.remove(this.primaryFactorySprite),!e||(t=this.primaryFactorySprite=this.createPrimaryFactorySprite())&&this.rootObj.add(t)}updateControlGroupSprite(t){if(this.controlGroupSprite&&this.rootObj.remove(this.controlGroupSprite),void 0!==t){let r=this.controlGroupSprite=this.createControlGroupSprite(t),s=this.gameObject;var i;s.isBuilding()?(r.position.x=1,r.position.y=n.Coords.tileHeightToWorld(s.art.height-.5),r.position.z=n.Coords.getWorldTileSize()*s.art.foundation.height):s.isInfantry()?(i=n.Coords.screenDistanceToWorld(-(v.width+2*b+e.pipBrdFile.getImage(1).width/2+1),-e.pipBrdFile.height/2),r.position.x=i.x,r.position.y=this.healthBar.position.y,r.position.z=i.y):(i=n.Coords.screenDistanceToWorld(-e.pipBrdFile.getImage(0).width/2,e.pipBrdFile.height/2),r.position.x=i.x,r.position.y=this.healthBar.position.y,r.position.z=i.y),r.updateMatrix(),this.rootObj.add(r)}}updatePipsSprite(){this.pipsSprite&&(this.rootObj.remove(this.pipsSprite),this.pipsSprite=void 0);let e,t=this.gameObject;if(t.isBuilding())e=this.createBuildingOccupationInfo(t);else if(t.isVehicle()){let s,n=[];var i,r;t.harvesterTrait&&0<t.rules.storage?(s=5,r=t.rules.storage,i=Math.floor(t.harvesterTrait.gems/r*s),r=Math.floor(t.harvesterTrait.ore/r*s),n.push(...new Array(i).fill(l.PipColor.Blue),...new Array(r).fill(l.PipColor.Yellow))):t.transportTrait&&0<t.rules.passengers?(s=t.rules.passengers,t.transportTrait.units.forEach((e=>{let t=0;e.isVehicle()&&(n.push(l.PipColor.Blue),t++),n.push(...new Array(e.rules.size-t).fill(e.isVehicle()?l.PipColor.Red:e.rules.pip))}))):t.airSpawnTrait&&(n=new Array(t.airSpawnTrait.availableSpawns).fill(l.PipColor.Yellow),s=t.rules.spawnsNumber),s&&(e=this.createPipsSprite(n,s))}else t.isAircraft()&&t.ammo&&t.name!==this.paradropRules.paradropPlane&&!t.rules.missileSpawn&&(e=this.createPipsSprite(new Array(t.ammo).fill(l.PipColor.Green),t.ammo,!0));e&&(e.updateMatrix(),this.rootObj.add(e),this.pipsSprite=e)}computePipsDataKey(e){let t;return e.isBuilding()?t=e.garrisonTrait?.units.length:e.isVehicle()?e.harvesterTrait?t=e.harvesterTrait.ore+"_"+e.harvesterTrait.gems:e.transportTrait?t=e.transportTrait.units.length:e.airSpawnTrait&&(t=e.airSpawnTrait.availableSpawns):e.isAircraft()&&(t=e.ammo),t}updateHealthBarSprite(e){if(this.healthBar){if(this.rootObj.remove(this.healthBar),this.gameObject.isBuilding())this.healthBar=this.createBuildingHealthBar(this.gameObject);else{let{healthBarWrapper:t,selectionBox:i}=this.createUnitHealthBar(this.gameObject);this.healthBar=t,this.selectionBox=i,i.visible=e>=S[2]}this.rootObj.add(this.healthBar)}}createRepairWrench(){let e=this.animFactory("WRENCH");return e.setRenderOrder(999998),e}objectIsOpaqueToViewer(){return!(!this.viewer||this.viewer.isObserver||this.gameObject.owner===this.viewer||this.alliances.areAllied(this.gameObject.owner,this.viewer))}dispose(){this.disposables.dispose(),this.repairWrench?.dispose(),this.flyHelper?.dispose(),this.behindAnim?.dispose(),this.debugLabel?.dispose(),this.animFactory=void 0}}),C.atlasImageHandles=new Map,C.geometries=new Map,C.buildingHealthGeoCache=new Map,C.unitHealthGeoCache=new Map,C.unitHealthTextures=new Map,C.unitHealthMaterials=new Map,C.controlGroupTextures=new Map,C.controlGroupMaterials=new Map,C.primaryFactoryTextures=new Map,C.primaryFactoryMaterials=new Map}}})),System.register("engine/renderable/entity/HighlightAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.SimpleRunner{constructor(e,t=.5,i=2,o=5){super(),this.maxAmount=t;let l=new s.AnimProps(new n.IniSection("dummy"),new a.ShpFile);l.rate=o,l.loopEnd=i-1,l.loopCount=2,this.animation=new r.Animation(l,e),this.animation.stop()}animate(e){this.animation.props.loopCount=e,this.animation.reset()}getValue(){return(1-this.getCurrentFrame())*this.maxAmount}},e("HighlightAnimRunner",o)}}})),System.register("engine/renderable/entity/InvulnerableAnimRunner",["engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","data/ShpFile"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.SimpleRunner{constructor(e,t=-.75,i=-.5,o=10,l=10){super(),this.minAmount=t,this.maxAmount=i,this.steps=o;let c=new s.AnimProps(new n.IniSection("dummy"),new a.ShpFile);c.rate=l,c.loopEnd=o,c.loopCount=-1,this.animation=new r.Animation(c,e),this.animation.stop()}animate(){this.animation.reset()}getValue(){return this.minAmount+(1+Math.sin(2*Math.PI*this.getCurrentFrame()/this.steps))/2*(this.maxAmount-this.minAmount)}},e("InvulnerableAnimRunner",o)}}})),System.register("engine/renderable/RenderablePlugin",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gfx/geometry/BufferGeometrySerializer",["data/DataStream"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("BufferGeometrySerializer",class{serialize(e){if(Object.keys(e.morphAttributes).length)throw new Error("Morph attributes are not supported");if(1<e.groups.length)throw new Error("Groups are not supported");var t,r=Object.keys(e.attributes),s=e.index,n=1+22*r.length+Object.values(e.attributes).map((e=>this.getTypedArrayByteSize(e.array))).reduce(((e,t)=>e+t),0)+1+(s?this.getTypedArrayByteSize(s.array):0);let a=new i.DataStream(new ArrayBuffer(n));for(t of(a.writeUint8(r.length),r)){var o=e.getAttribute(t);a.writeCString(t,20),a.writeUint8(o.itemSize),a.writeUint8(Number(o.normalized)),this.writeTypedArray(a,o.array)}return a.writeUint8(Number(Boolean(s))),s&&this.writeTypedArray(a,s.array),a.seek(0),a.dynamicSize=!1,a.buffer}unserialize(e){let t=new THREE.BufferGeometry;var i,r=e.readUint8();for(let i=0;i<r;i++){var s=e.readCString(20),n=e.readUint8(),a=Boolean(e.readUint8()),o=this.readTypedArray(e);a=new THREE.BufferAttribute(o,n,a);t.addAttribute(s,a)}return Boolean(e.readUint8())&&(i=this.readTypedArray(e),t.setIndex(new THREE.BufferAttribute(i,1))),t}writeTypedArray(e,t){if(e.writeUint32(t.length),t instanceof Float32Array)e.writeUint8(0),e.writeFloat32Array(t);else if(t instanceof Uint32Array)e.writeUint8(1),e.writeUint32Array(t);else{if(!(t instanceof Uint16Array))throw new Error(`Unsupported array type "${t.constructor.name}"`);e.writeUint8(2),e.writeUint16Array(t)}}readTypedArray(e){var t=e.readUint32(),i=e.readUint8();switch(i){case 0:return e.readFloat32Array(t);case 1:return e.readUint32Array(t);case 2:return e.readUint16Array(t);default:throw new Error(`Unsupported array type "${i}"`)}}getTypedArrayByteSize(e){return 5+e.BYTES_PER_ELEMENT*e.length}})}}})),System.register("engine/gfx/geometry/VxlGeometryCache",["data/DataStream","data/vfs/VirtualFile","engine/gfx/geometry/BufferGeometrySerializer","data/vfs/FileNotFoundError"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("VxlGeometryCache",a=class e{constructor(e,t){this.cacheDir=e,this.activeMod=t,this.geometries=new Map}async loadFromStorage(e,t){let i=this.geometries.get(e);if(!i){let o=this.cacheDir;if(o){var r=this.getCacheFileName(t,e.name);try{var a=await o.openFile(r);i=(new s.BufferGeometrySerializer).unserialize(a.stream),this.set(e,i)}catch(e){e instanceof n.FileNotFoundError||console.error(`Failed to load buffer geometry from cache file "${r}"`,e)}}}return i}async persistToStorage(e,t,n){this.geometries.has(e)||this.set(e,(new s.BufferGeometrySerializer).unserialize(new i.DataStream(n))),await(this.cacheDir?.writeFile(new r.VirtualFile(new i.DataStream(n),this.getCacheFileName(t,e.name))))}async clearStorage(){await this.clearStorageFiles()}async clearOtherModStorage(){let t=e.cacheFilePrefix+this.getModPrefix();await this.clearStorageFiles((e=>!e.startsWith(t)))}async clearStorageFiles(t=(()=>!0)){let i=this.cacheDir;if(i)for await(var r of i.getEntries())r.startsWith(e.cacheFilePrefix)&&t(r)&&await i.deleteFile(r)}getCacheFileName(t,i){var r=this.getModPrefix();return""+e.cacheFilePrefix+r+t.replace(".vxl","")+"_"+i}getModPrefix(){return this.activeMod?this.activeMod+"#":"#"}clear(){this.geometries.forEach((e=>{for(var t of(e.dispose(),Object.keys(e.attributes)))e.removeAttribute(t)})),this.geometries.clear()}get(e){return this.geometries.get(e)}set(e,t){this.geometries.set(e,t)}}),a.cacheFilePrefix="geocache_"}}})),System.register("engine/renderable/entity/unit/ModelQuality",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Low=0]="Low",t[t.High=1]="High",e("ModelQuality",i)}}})),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder",["engine/gfx/BufferGeometryUtils"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("VxlGeometryMonotoneBuilder",class{build(e,t=!1){let s=e.getAllVoxels().voxelField;var{vertices:n,faces:a}=function(e,t){for(var i=[],s=[],n=0;n<3;++n){var a=(n+1)%3,o=(n+2)%3,l=new Int32Array(3),c=new Int32Array(3),h=new Int32Array(2*(t[a]+1)),u=new Int32Array(t[a]),d=new Int32Array(t[a]),g=new Int32Array(2*t[o]),p=new Int32Array(2*t[o]),m=new Int32Array(24*t[o]),f=[[0,0],[0,0]];for(c[n]=1,l[n]=-1;l[n]<t[n];){var y=[],T=0;for(l[o]=0;l[o]<t[o];++l[o]){var v=0,b=0,S=0;for(l[a]=0;l[a]<t[a];++l[a],b=S){var w=0<=l[n]?e(l[0],l[1],l[2]):0,C=l[n]<t[n]-1?e(l[0]+c[0],l[1]+c[1],l[2]+c[2]):0;!(S=w)==!C?S=0:w||(S=-C),b!==S&&(h[v++]=l[a],h[v++]=S)}h[v++]=t[a];for(var E=h[v++]=0,x=0,O=0;x<T&&O<v-2;){let e=y[u[x]];var A=e.left[e.left.length-1][0],M=e.right[e.right.length-1][0],R=e.color,P=h[O],I=h[O+2],k=h[O+1];A<I&&P<M&&k===R?(e.merge_run(l[o],P,I),d[E++]=u[x],++x,O+=2):(I<=M&&(k&&(B=new r(k,l[o],P,I),d[E++]=y.length,y.push(B)),O+=2),M<=I&&(e.close_off(l[o]),++x))}for(;x<T;++x)y[u[x]].close_off(l[o]);for(;O<v-2;O+=2){var B;P=h[O],I=h[O+2];(k=h[O+1])&&(B=new r(k,l[o],P,I),d[E++]=y.length,y.push(B))}var j=d;d=u,u=j,T=E}for(x=0;x<T;++x){y[u[x]].close_off(t[o])}for(l[n]++,x=0;x<y.length;++x){var N=y[x],L=!1;for((S=N.color)<0&&(L=!0,S=-S),O=0;O<N.left.length;++O){g[O]=i.length;var D=[0,0,0],F=N.left[O];D[n]=l[n],D[a]=F[0],D[o]=F[1],i.push({position:D,value:S})}for(O=0;O<N.right.length;++O)p[O]=i.length,D=[0,0,0],F=N.right[O],D[n]=l[n],D[a]=F[0],D[o]=F[1],i.push({position:D,value:S});var _=0,U=0,H=1,G=1,V=!0;for(m[U++]=g[0],m[U++]=N.left[0][0],m[U++]=N.left[0][1],m[U++]=p[0],m[U++]=N.right[0][0],m[U++]=N.right[0][1];H<N.left.length||G<N.right.length;){var W,z,K=!1;H===N.left.length?K=!0:G!==N.right.length&&(W=N.left[H],z=N.right[G],K=W[1]>z[1]);var q=K?p[G]:g[H],$=K?N.right[G]:N.left[H];if(K!==V)for(;_+3<U;)L===K?s.push([m[_],m[_+3],q]):s.push([m[_+3],m[_],q]),_+=3;else for(;_+3<U;){for(O=0;O<2;++O)for(var Q=0;Q<2;++Q)f[O][Q]=m[U-3*(O+1)+Q+1]-$[Q];var Z=f[0][0]*f[1][1]-f[1][0]*f[0][1];if(K===0<Z)break;0!=Z&&(L===K?s.push([m[U-3],m[U-6],q]):s.push([m[U-6],m[U-3],q])),U-=3}m[U++]=q,m[U++]=$[0],m[U++]=$[1],K?++G:++H,V=K}}}}return{vertices:i,faces:s}}(t?(e,t,i)=>{var r=s.get(e,t,i);return r?r.colorIndex:0}:(e,t,i)=>{var r=s.get(e,t,i);return r?r.normalIndex+256*r.colorIndex:0},[e.sizeX,e.sizeY,e.sizeZ]),o=e.minBounds,l=e.scale,c=e.getNormals();let h=new Float32Array(3*n.length),u=new Float32Array(3*n.length),d=new Float32Array(3*n.length),g=0,p=0,m=0;for(let e=0,i=n.length;e<i;e++){var f=n[e],y=t?f.value:f.value/256|0;h[g++]=o.x+f.position[0]*l.x,h[g++]=o.y+f.position[1]*l.y,h[g++]=o.z+f.position[2]*l.z,d[m++]=y/255,d[m++]=0,d[m++]=0,t||(f=f.value%256,f=c[Math.min(f,c.length-1)],u[p++]=f.x,u[p++]=f.y,u[p++]=f.z)}let T=new Uint32Array(3*a.length),v=0;for(let e=0,t=a.length;e<t;e++){var b=a[e];T[v++]=b[0],T[v++]=b[1],T[v++]=b[2]}let S=new THREE.BufferGeometry;return S.addAttribute("position",new THREE.BufferAttribute(h,3)),t||S.addAttribute("normal",new THREE.BufferAttribute(u,3)),S.addAttribute("color",new THREE.BufferAttribute(d,3)),S.setIndex(new THREE.BufferAttribute(T,1)),S=i.BufferGeometryUtils.mergeVertices(S),S.computeBoundingBox(),t&&S.computeVertexNormals(),S}}),r=class{constructor(e,t,i,r){this.color=e,this.left=[[i,t]],this.right=[[r,t]]}close_off(e){this.left.push([this.left[this.left.length-1][0],e]),this.right.push([this.right[this.right.length-1][0],e])}merge_run(e,t,i){var r=this.left[this.left.length-1][0],s=this.right[this.right.length-1][0];r!==t&&(this.left.push([r,e]),this.left.push([t,e])),s!==i&&(this.right.push([s,e]),this.right.push([i,e]))}},class{}}}})),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryPool",["engine/renderable/entity/unit/ModelQuality","util/typeGuard","engine/renderable/builder/vxlGeometry/VxlGeometryMonotoneBuilder"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("VxlGeometryPool",class{constructor(e,t=i.ModelQuality.High){this.cache=e,this.modelQuality=t}setModelQuality(e){this.modelQuality=e}getModelQuality(){return this.modelQuality}async loadFromStorage(e,t){return(await Promise.all(e.sections.map((e=>this.cache.loadFromStorage(e,t))))).every(r.isNotNullOrUndefined)}async persistToStorage(e,t,i){for(let s=0;s<e.sections.length;s++){var r=e.sections[s];await this.cache.persistToStorage(r,t,i[s])}}clear(){this.cache.clear()}async clearStorage(){await this.cache.clearStorage()}async clearOtherModStorage(){await this.cache.clearOtherModStorage()}get(e){let t=this.cache.get(e);return t||(t=(new s.VxlGeometryMonotoneBuilder).build(e),this.cache.set(e,t)),t}})}}})),System.register("engine/renderable/builder/VxlBatchedBuilder",["engine/gfx/TextureUtils","engine/gfx/batch/BatchedMesh","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class e extends s.VxlBuilder{constructor(e,t,i,r,s,n){super(n),this.vxlFile=e,this.hvaFile=t,this.palettes=i,this.palette=r,this.vxlGeometryPool=s,this.clippingPlanes=[],this.opacity=1,this.castShadow=!0}createVxlMeshes(){var e=i.TextureUtils.textureFromPalettes(this.palettes);let t=this.useMaterial(e);this.materialCacheKey=e;let s=this.getPaletteIndex(this.palette),n=this.vxlFile.sections,a=new Map;return n.forEach(((e,i)=>{var n=this.vxlGeometryPool.get(e);let o=new r.BatchedMesh(n,t),l=e.transfMatrix,c=this.hvaFile?.sections[i];c&&(l=e.scaleHvaMatrix(c.getMatrix(0))),o.applyMatrix(l),a.set(e.name,o),o.castShadow=this.castShadow,o.setPaletteIndex(s),this.extraLight&&o.setExtraLight(this.extraLight),o.setOpacity(this.opacity),o.setClippingPlanes(this.clippingPlanes)})),a}useMaterial(t){let i,r=e.materialCache.get(t);return r?(i=r.material,r.usages++):(i=new n.PalettePhongMaterial({palette:t,paletteCount:this.palettes.length,vertexColors:THREE.VertexColors,transparent:!0}),r={material:i,usages:1},e.materialCache.set(t,r)),i}freeMaterial(){let t=e.materialCache.get(this.materialCacheKey);t&&(1===t.usages?(e.materialCache.delete(this.materialCacheKey),t.material.dispose()):t.usages--)}getPaletteIndex(e){var t=this.palettes.findIndex((t=>t.hash===e.hash));if(-1===t)throw new Error("Provided palette not found in the list of available palettes");return t}setPalette(e){if(this.palette=e,this.object){let t=this.getPaletteIndex(e);this.sections.forEach((e=>e.setPaletteIndex(t)))}}setExtraLight(e){this.extraLight=e,this.object&&this.sections.forEach((t=>t.setExtraLight(e)))}setShadow(e){this.castShadow=e,this.sections?.forEach((t=>{t.castShadow=e}))}setClippingPlanes(e){this.clippingPlanes=e,this.object&&this.sections.forEach((t=>t.setClippingPlanes(e)))}setOpacity(e){this.opacity=e,this.object&&this.sections.forEach((t=>t.setOpacity(e)))}dispose(){this.object&&(this.freeMaterial(),this.object=void 0)}},e("VxlBatchedBuilder",a),a.materialCache=new Map}}})),System.register("engine/renderable/builder/VxlNonBatchedBuilder",["engine/gfx/TextureUtils","engine/renderable/builder/VxlBuilder","engine/gfx/material/PalettePhongMaterial"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends r.VxlBuilder{constructor(e,t,i,r,s){super(s),this.vxlFile=e,this.hvaFile=t,this.palette=i,this.vxlGeometryPool=r,this.clippingPlanes=[],this.castShadow=!0}createVxlMeshes(){var e=this.palette;e=i.TextureUtils.textureFromPalette(e);let t=this.material=new s.PalettePhongMaterial({palette:e,vertexColors:THREE.VertexColors});this.extraLight&&(t.extraLight=this.extraLight),t.clippingPlanes=this.clippingPlanes;let r=this.vxlFile.sections,n=new Map;return r.forEach(((e,i)=>{var r=this.vxlGeometryPool.get(e);let s=new THREE.Mesh(r,t),a=e.transfMatrix,o=this.hvaFile?.sections[i];o&&(a=e.scaleHvaMatrix(o.getMatrix(0))),s.applyMatrix(a),n.set(e.name,s),s.castShadow=this.castShadow})),n}setPalette(e){var t;this.palette=e,this.object&&(t=i.TextureUtils.textureFromPalette(e),this.material.palette=t)}setExtraLight(e){this.extraLight=e,this.object&&(this.material.extraLight=e)}setShadow(e){this.castShadow=e,this.sections?.forEach((t=>t.castShadow=e))}setClippingPlanes(e){this.clippingPlanes=e,this.object&&(this.material.clippingPlanes=e)}setOpacity(e){this.material.transparent=e<1,this.material.opacity=e}dispose(){this.object&&this.material.dispose()}},e("VxlNonBatchedBuilder",n)}}})),System.register("engine/renderable/builder/VxlBuilderFactory",["engine/renderable/builder/VxlBatchedBuilder","engine/renderable/builder/VxlNonBatchedBuilder"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("VxlBuilderFactory",class{constructor(e,t,i){this.vxlGeometryPool=e,this.useBatching=t,this.camera=i}create(e,t,s,n){return this.useBatching?new i.VxlBatchedBuilder(e,t,s,n,this.vxlGeometryPool,this.camera):new r.VxlNonBatchedBuilder(e,t,n,this.vxlGeometryPool,this.camera)}})}}})),System.register("engine/renderable/builder/ShpAggregator",["data/ShpFile","data/ShpImage"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ShpAggregator",class{static getShpFrameInfo(e,t){return{file:e,hasShadow:t,frameCount:Math.floor(e.numImages*(t?.5:1))}}aggregate(e,t){let s=new i.ShpFile;s.filename=t;let n=[],a=new Map,o=0;for(var{file:l,hasShadow:c,frameCount:h}of e)if(!a.has(l)){a.set(l,o);for(let e=0;e<h;e++)s.addImage(l.getImage(e)),n.push(c?l.getImage(h+e):new r.ShpImage),o++}return n.forEach((e=>s.addImage(e))),{file:s,imageIndexes:a}}})}}})),System.register("engine/renderable/entity/building/BuildingShpHelper",["engine/AnimProps","engine/ImageFinder","engine/renderable/builder/ShpAggregator"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("BuildingShpHelper",class{constructor(e){this.imageFinder=e}getShpFrameInfos(e,t,r,n){let a=new Map;for(var[o,l]of(t&&a.set(t,s.ShpAggregator.getShpFrameInfo(t,e.hasShadow)),r&&a.set(r,s.ShpAggregator.getShpFrameInfo(r,e.hasShadow)),n))o=new i.AnimProps(o.art,l),o=s.ShpAggregator.getShpFrameInfo(l,o.shadow),a.set(l,o);return a}collectAnimShpFiles(e,t){let i=new Map;return e.getAll().forEach(((e,s)=>{for(var n of e){let s;try{s=this.imageFinder.find(n.image,t.useTheaterExtension)}catch(e){if(e instanceof r.ImageFinder.MissingImageError){console.warn(e.message);continue}throw e}i.set(n,s)}})),i}})}}})),System.register("engine/renderable/entity/unit/ExtraLightHelper",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ExtraLightHelper",class{static multiplyShp(e,t,i){e.copy(t).add(t.clone().addScalar(1).multiplyScalar(i))}static multiplyVxl(e,t,i,r){e.copy(t).addScalar(2*r*i)}})}}})),System.register("engine/renderable/AlphaRenderable",["data/Palette","engine/renderable/builder/ShpBuilder","util/Color","game/Coords"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("AlphaRenderable",class e{constructor(e,t,i){this.shpFile=e,this.camera=t,this.visible=!0,this.drawOffset={...i}}static getOrCreateAlphaPalette(){let t=e.alphaPalette;if(!t){t=new i.Palette(new Array(768).fill(0));let n=[];for(let e=0;e<256;e++){var r=127<e?2*(e-127):0;n.push(new s.Color(r,r,r))}t.setColors(n),e.alphaPalette=t}return t}setVisible(e){this.visible=e,this.object3d&&(this.object3d.visible=e)}setSize(e){this.shpSize=e,this.builder?.setSize(e)}create3DObject(){if(!this.object3d){var t=e.getOrCreateAlphaPalette();let i=new r.ShpBuilder(this.shpFile,t,this.camera,n.Coords.ISO_WORLD_SCALE);this.shpSize&&i.setSize(this.shpSize),i.setFrame(0),i.setOffset(this.drawOffset);let s=i.build();s.visible=this.visible,s.renderOrder=999995;let a=s.material;a.depthTest=!1,a.depthWrite=!0,a.transparent=!0,a.blending=THREE.CustomBlending,a.blendEquation=THREE.AddEquation,a.blendSrc=THREE.DstColorFactor,a.blendDst=THREE.OneFactor,this.builder=i,this.object3d=s}}get3DObject(){return this.object3d}update(e){}dispose(){this.builder?.dispose()}})}}})),System.register("engine/renderable/DebugRenderable",["data/Palette","engine/gfx/DebugUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial","three","engine/gfx/batch/BatchedMesh"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("DebugRenderable",l=class e{constructor(e,t,i,r){this.foundation=e,this.height=t,this.palette=i,this.options=r,this.batchPalettes=[],this.useMeshBatching=!1,this.opacity=1}static getOrCreateTexture(){let t=e.checkerboardTex;return t||(t=r.DebugUtils.createIndexedCheckerTex(i.Palette.REMAP_START_IDX-1,i.Palette.REMAP_START_IDX),e.checkerboardTex=t),t}static clearCaches(){e.checkerboardTex?.dispose(),e.geometryCache.forEach((e=>e.dispose())),e.geometryCache.clear()}useMaterial(t){this.materialCacheKey=t.uuid;let i,r=e.materialCache.get(this.materialCacheKey);return r?(i=r.material,r.usages++):(i=new n.PaletteBasicMaterial({map:e.getOrCreateTexture(),palette:t,alphaTest:.05,paletteCount:this.batchPalettes.length,flatShading:!0,transparent:!0}),r={material:i,usages:1},e.materialCache.set(this.materialCacheKey,r)),i}freeMaterial(){if(!this.materialCacheKey)throw new Error("Material cache key not set");let t=e.materialCache.get(this.materialCacheKey);t&&(1===t.usages?(e.materialCache.delete(this.materialCacheKey),t.material.dispose()):t.usages--)}getGeometryCacheKey(){return this.foundation.width+"_"+this.foundation.height+"_"+this.height}setBatched(e){if(this.mesh)throw new Error("Batching can only be set before calling build()");this.useMeshBatching=e}getBatchPaletteIndex(e){var t=this.batchPalettes.findIndex((t=>t.hash===e.hash));if(-1===t)throw new Error("Provided palette not found in the list of batch palettes. Call setBatchPalettes first.");return t}setPalette(e){if(this.palette=e,this.mesh)if(this.useMeshBatching){var t=this.getBatchPaletteIndex(e);this.mesh.setPaletteIndex(t)}else{t=s.TextureUtils.textureFromPalette(e),this.mesh.material.palette=t}}setBatchPalettes(e){if(!this.useMeshBatching)throw new Error("Can't use multiple palettes when not batching");if(this.mesh)throw new Error("Palettes must be set before creating 3DObject");this.batchPalettes=e}setOpacity(e){this.opacity!==e&&(this.opacity=e,this.updateOpacity())}updateOpacity(){this.mesh&&(this.useMeshBatching?this.mesh.setOpacity(this.opacity):this.mesh.material.opacity=this.opacity)}create3DObject(){if(!this.mesh){var t,i,l=this.getGeometryCacheKey();let c,h=e.geometryCache,u=h.get(l);u||(u=r.DebugUtils.createBoxGeometry(this.foundation,this.height,this.options?.centerFoundation),h.set(l,u)),this.useMeshBatching?(t=s.TextureUtils.textureFromPalettes(this.batchPalettes),i=this.useMaterial(t),c=new o.BatchedMesh(u,i,o.BatchMode.Merging),c.castShadow=!1):(t=s.TextureUtils.textureFromPalette(this.palette),i=e.getOrCreateTexture(),i=new n.PaletteBasicMaterial({palette:t,map:i,alphaTest:.05,transparent:!0}),c=new a.Mesh(u,i)),c.matrixAutoUpdate=!1,this.mesh=c,this.setPalette(this.palette),this.updateOpacity()}}get3DObject(){return this.mesh}update(e){}dispose(){this.mesh&&(this.useMeshBatching?this.freeMaterial():this.mesh.material.dispose(),this.mesh=void 0)}}),l.geometryCache=new Map,l.materialCache=new Map}}})),System.register("engine/renderable/entity/Building",["engine/renderable/builder/ShpBuilder","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/gfx/OverlayUtils","game/gameobject/Building","engine/Animation","engine/renderable/entity/wallTypes","game/Coords","util/math","engine/AnimProps","engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/entity/building/BuildingAnimArtProps","util/typeGuard","engine/renderable/entity/HighlightAnimRunner","game/rules/TechnoRules","game/gameobject/trait/AttackTrait","game/SideType","game/gameobject/trait/FactoryTrait","game/gameobject/trait/UnitRepairTrait","game/gameobject/common/DeathType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/AlphaRenderable","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e}],execute:function(){k=(new Map).set(s.AnimationType.PRODUCTION,s.AnimationType.IDLE).set(s.AnimationType.BUILDUP,s.AnimationType.IDLE).set(s.AnimationType.SPECIAL_DOCKING,s.AnimationType.IDLE).set(s.AnimationType.SPECIAL_REPAIR_START,s.AnimationType.SPECIAL_REPAIR_LOOP).set(s.AnimationType.SPECIAL_REPAIR_LOOP,s.AnimationType.SPECIAL_REPAIR_END).set(s.AnimationType.SPECIAL_REPAIR_END,s.AnimationType.IDLE).set(s.AnimationType.SUPER_CHARGE_START,s.AnimationType.SUPER_CHARGE_LOOP).set(s.AnimationType.SUPER_CHARGE_LOOP,s.AnimationType.SUPER_CHARGE_END).set(s.AnimationType.SUPER_CHARGE_END,s.AnimationType.IDLE).set(s.AnimationType.FACTORY_DEPLOYING,s.AnimationType.IDLE).set(s.AnimationType.FACTORY_ROOF_DEPLOYING,s.AnimationType.IDLE),B=(new Map).set(s.AnimationType.SUPER_CHARGE_START,[s.AnimationType.SUPER,1]).set(s.AnimationType.SUPER_CHARGE_LOOP,[s.AnimationType.SUPER,2]).set(s.AnimationType.SUPER_CHARGE_END,[s.AnimationType.SUPER,3]).set(s.AnimationType.SPECIAL_REPAIR_START,[s.AnimationType.SPECIAL,0]).set(s.AnimationType.SPECIAL_REPAIR_LOOP,[s.AnimationType.SPECIAL,1]).set(s.AnimationType.SPECIAL_REPAIR_END,[s.AnimationType.SPECIAL,2]).set(s.AnimationType.SPECIAL_DOCKING,[s.AnimationType.SPECIAL,0]).set(s.AnimationType.SPECIAL_SHOOT,[s.AnimationType.SPECIAL,0]).set(s.AnimationType.FACTORY_DEPLOYING,[s.AnimationType.FACTORY_DEPLOYING,0]).set(s.AnimationType.FACTORY_UNDER_DOOR,[s.AnimationType.FACTORY_DEPLOYING,1]).set(s.AnimationType.FACTORY_ROOF_DEPLOYING,[s.AnimationType.FACTORY_ROOF_DEPLOYING,0]).set(s.AnimationType.FACTORY_UNDER_ROOF_DOOR,[s.AnimationType.FACTORY_ROOF_DEPLOYING,1]),e("Building",j=class e{constructor(e,t,i,r,n,a,o,l,c,h,u,g,m,f,T,b,S,w,C,E,x,M=s.AnimationType.IDLE){this.gameObject=e,this.selectionModel=t,this.rules=i,this.art=r,this.imageFinder=n,this.voxels=o,this.voxelAnims=l,this.palette=c,this.animPalette=h,this.isoPalette=u,this.camera=g,this.lighting=m,this.debugFrame=f,this.gameSpeed=T,this.vxlBuilderFactory=b,this.useSpriteBatching=S,this.buildingImageDataCache=C,this.pipOverlay=E,this.worldSound=x,this.initialAnimType=M,this.animObjects=new Map,this.animations=new Map,this.animSounds=new Map,this.powered=!0,this.repairStopRequested=!1,this.repairStartRequested=!1,this.highlightAnimRunner=new v.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new O.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=e.art,this.objectRules=e.rules,this.type=this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map((e=>this.palette.clone().remap(e))),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight);var R=this.animArtProps=new y.BuildingAnimArtProps;let P,I;this.animArtProps.read(this.objectArt.art,this.art);try{P=this.imageFinder.findByObjectArt(this.objectArt)}catch(e){if(!(e instanceof p.ImageFinder.MissingImageError))throw e;console.warn(e.message)}this.mainShpFile=P;try{I=this.objectArt.bibShape?this.imageFinder.find(this.objectArt.bibShape,this.objectArt.useTheaterExtension):void 0}catch(e){if(!(e instanceof p.ImageFinder.MissingImageError))throw e;console.warn(e.message)}this.bibShpFile=I;let k=new A.BuildingShpHelper(this.imageFinder);R=this.animShpFiles=k.collectAnimShpFiles(R,this.objectArt);let B=this.shpFrameInfos=k.getShpFrameInfos(this.objectArt,P,I,R),j=this.buildingImageDataCache.get(this.gameObject.name);j||(j=w.aggregate(B.values(),`agg_${this.objectRules.name}.shp`),this.buildingImageDataCache.set(this.gameObject.name,j)),this.aggregatedImageData=j,this.withPosition=new d.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile))}updateLighting(){this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.plugins.forEach((e=>e.updateLighting?.()))}get3DObject(){return this.target}getIntersectTarget(){return this.intersectTarget}updateIntersectTarget(){this.intersectTarget=[this.placeholderObj?.get3DObject(),this.mainObj?.getShapeMesh(),this.bib?.getShapeMesh(),...[...this.animObjects.values()].flat().map((e=>e.getShapeMesh()))].filter(T.isNotNullOrUndefined)}getUiName(){var e=this.plugins.reduce(((e,t)=>t.getUiNameOverride?.()??e),void 0);return void 0!==e?e:this.gameObject.getUiName()}create3DObject(){let e=this.get3DObject();if(!e){e=new THREE.Object3D,e.name="building_"+this.type,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this);var t=this.gameObject.rules.alphaImage;if(t){var r=this.imageFinder.tryFind(t,!1);if(r){let t=new R.AlphaRenderable(r,this.camera,new THREE.Vector2(0,(c.Coords.ISO_TILE_SIZE+1)/2));t.create3DObject(),e.add(t.get3DObject())}else console.warn(`<${this.objectRules.name}>: Alpha image "${t}" not found`)}this.objectRules.lightIntensity&&(this.createLamp(e),this.objectRules.isLightpost)||(this.createObjects(e),this.updateIntersectTarget(),this.pipOverlay&&(this.pipOverlay.create3DObject(),e.add(this.pipOverlay.get3DObject())),this.updateImage(this.computeDamageType(this.gameObject.healthTrait.health)),this.mainObj?.setExtraLight(this.shpExtraLight),[...this.animObjects.values()].forEach((e=>{e.forEach((e=>{this.animations.get(e).props.getArt().has("UseNormalLight")||e.setExtraLight(this.shpExtraLight)}))})),this.bib?.setExtraLight(this.shpExtraLight),this.turretBuilders?.forEach((e=>{e instanceof i.ShpBuilder?e.setExtraLight(this.shpExtraLight):e.setExtraLight(this.vxlExtraLight)})))}}createLamp(t){var i=this.objectRules;let r=(1+i.lightRedTint)*(1+Math.abs(i.lightIntensity))-1,s=(1+i.lightGreenTint)*(1+Math.abs(i.lightIntensity))-1,n=(1+i.lightBlueTint)*(1+Math.abs(i.lightIntensity))-1;var a=Math.max(r,s,n);1<a&&(r/=a,s/=a,n/=a),a=new THREE.Color(r,s,n).multiplyScalar(.9).getHexString();let o=e.lampTextures.get(a);o||(o=this.createLampTexture(a),e.lampTextures.set(a,o)),a=new THREE.MeshBasicMaterial({map:o,depthTest:!1,depthWrite:!1,transparent:!0,blending:THREE.CustomBlending,blendEquation:0<i.lightIntensity?THREE.AddEquation:THREE.ReverseSubtractEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor}),i=i.lightVisibility,i=new THREE.PlaneBufferGeometry(2*i,2*i);let l=new THREE.Mesh(i,a);l.rotation.x=-Math.PI/2,l.renderOrder=999995,l.matrixAutoUpdate=!1,l.updateMatrix(),t.add(l)}createLampTexture(e){let t=document.createElement("canvas");t.width=t.height=32;let i=t.getContext("2d");i.fillStyle="black",i.fillRect(0,0,32,32);let r=i.createRadialGradient(16,16,0,16,16,16);r.addColorStop(0,"#"+e),r.addColorStop(1,"black"),i.arc(16,16,16,0,2*Math.PI),i.fillStyle=r,i.fill();let s=new THREE.Texture(t);return s.needsUpdate=!0,s}setPosition(e){var t=this.gameObject.getFoundationCenterOffset();this.withPosition.setPosition(e.x-t.x,e.y,e.z-t.y)}getPosition(){return this.withPosition.getPosition()}registerPlugin(e){this.plugins.push(e)}highlight(){this.plugins.some((e=>e.shouldDisableHighlight?.()))||this.highlightAnimRunner.animate(2)}update(e){if(!this.objectRules.isLightpost){this.gameObject.isDestroyed||void 0!==this.currentAnimType||this.setAnimation(this.initialAnimType,e),this.plugins.forEach((t=>t.update(e))),this.pipOverlay?.update(e);var t=this.gameObject.c4ChargeTrait?.hasCharge();!this.gameObject.isDestroyed&&this.lastHasC4Charge!==t&&t&&(this.lastHasC4Charge=t,this.highlight());var i=this.highlightAnimRunner.shouldUpdate(),n=this.gameObject.invulnerableTrait.isActive();t=n!==this.lastInvulnerable;(this.lastInvulnerable=n)&&t&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(e),(i||t||n)&&(i&&this.highlightAnimRunner.tick(e),n=n?this.invulnAnimRunner.getValue():0,c=(i?this.highlightAnimRunner.getValue():0)||n,n=this.lighting.getAmbientIntensity(),M.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,n,c),M.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,c));var l,c=this.gameObject.warpedOutTrait.isActive();if(c!==this.lastWarpedOut){let e=(this.lastWarpedOut=c)?.5:1;for(l of[this.mainObj,this.bib,...[...this.animObjects.values()].flat()])l?.setOpacity(e);this.turretBuilders?.forEach((t=>t.setOpacity(e))),this.placeholderObj?.setOpacity(e)}this.gameObject.isDestroyed||(h=this.gameObject.owner.color,this.lastOwnerColor!==h&&(this.palette.remap(h),this.mainObj?.setPalette(this.palette),[...this.animObjects.values()].forEach((e=>{e.forEach((e=>e.setPalette(this.palette)))})),this.bib?.setPalette(this.palette),this.turretBuilders?.forEach((e=>e.setPalette(this.palette))),this.placeholderObj?.setPalette(this.palette),this.lastOwnerColor=h)),!this.gameObject.isDestroyed&&k.has(this.currentAnimType)&&(u=k.get(this.currentAnimType),this.hasObjectWithStoppedAnimation(this.currentAnimType)&&this.setAnimation(u,e)),this.gameObject.isDestroyed||this.gameObject.buildStatus!==a.BuildStatus.BuildDown||this.currentAnimType===s.AnimationType.UNBUILD||this.setAnimation(s.AnimationType.UNBUILD,e);var h=this.gameObject.attackTrait?.attackState;if((void 0===this.lastAttackState||this.lastAttackState!==h&&!this.gameObject.isDestroyed)&&(this.lastAttackState=h,!this.gameObject.isDestroyed&&this.hasAnimation(s.AnimationType.SPECIAL_SHOOT)&&(h===S.AttackState.FireUp?this.setAnimation(s.AnimationType.SPECIAL_SHOOT,e):this.currentAnimType===s.AnimationType.SPECIAL_SHOOT&&this.setAnimation(s.AnimationType.IDLE,e)),h===S.AttackState.JustFired&&this.objectArt.muzzleFlash)){let e=this.createMuzzleFlashAnim(this.spriteOffset,this.renderableManager);e&&(e.create3DObject(),this.spriteWrap.add(e.get3DObject()),this.muzzleAnims=this.muzzleAnims||[],this.muzzleAnims.push(e))}var u=this.gameObject.factoryTrait;if(u){var d=u.status;if(this.lastFactoryStatus!==d&&!this.gameObject.isDestroyed&&(h=this.lastFactoryStatus,this.lastFactoryStatus=d,void 0!==h)){let t,i=!1;[b.FactoryType.BuildingType,b.FactoryType.NavalUnitType].includes(u.type)?t=s.AnimationType.PRODUCTION:u.type===b.FactoryType.UnitType?(t=u.deliveringUnit?.rules.consideredAircraft?s.AnimationType.FACTORY_ROOF_DEPLOYING:s.AnimationType.FACTORY_DEPLOYING,i=!0):t=void 0,t&&this.hasAnimation(t)&&(d===C.FactoryStatus.Delivering?this.setAnimation(t,e):i&&this.setAnimation(s.AnimationType.IDLE,e))}}d=this.gameObject.unitRepairTrait?.status,this.lastRepairStatus===d||this.gameObject.isDestroyed||(m=this.lastRepairStatus,this.lastRepairStatus=d,this.hasAnimation(s.AnimationType.SPECIAL_REPAIR_START)&&(d===E.RepairStatus.Repairing?(this.currentAnimType!==s.AnimationType.SPECIAL_REPAIR_LOOP&&this.currentAnimType!==s.AnimationType.SPECIAL_REPAIR_END||m!==E.RepairStatus.Idle?this.setAnimation(s.AnimationType.SPECIAL_REPAIR_START,e):this.repairStartRequested=!0,this.repairStopRequested=!1):(this.currentAnimType===s.AnimationType.SPECIAL_REPAIR_START?this.repairStopRequested=!0:this.endCurrentAnimation(),this.repairStartRequested=!1)));let y=this.gameObject.superWeaponTrait?.getSuperWeapon(this.gameObject);!y||!this.hasAnimation(s.AnimationType.SUPER_CHARGE_START)||this.gameObject.isDestroyed||(f=y.getTimerSeconds()<=60*this.objectRules.chargedAnimTime)!==this.lastSuperWeaponAlmostCharged&&((this.lastSuperWeaponAlmostCharged=f)?this.setAnimation(s.AnimationType.SUPER_CHARGE_START,e):this.endCurrentAnimation()),this.repairStopRequested&&this.currentAnimType===s.AnimationType.SPECIAL_REPAIR_LOOP&&(this.endCurrentAnimation(),this.repairStopRequested=!1),this.repairStartRequested&&this.currentAnimType===s.AnimationType.IDLE&&(this.setAnimation(s.AnimationType.SPECIAL_REPAIR_START,e),this.repairStartRequested=!1),this.muzzleAnims&&this.updateMuzzleAnims(e),c||(this.animations.forEach(((t,i)=>{switch(t.getState()){case o.AnimationState.STOPPED:return;case o.AnimationState.DELAYED:t.update(e),i.get3DObject().visible=t.getState()!==o.AnimationState.DELAYED;break;case o.AnimationState.NOT_STARTED:t.start(e);case o.AnimationState.RUNNING:default:t.update(e)}i.setFrame(t.getCurrentFrame())})),this.animObjects.forEach(((e,t)=>{let i=this.animArtProps.getByType(t);e.forEach(((e,t)=>{var r=i[t];let s=this.animations.get(e);var n=r.translucent;r=r.translucency;if(n||0<r){let t;t=n?(n=s.props,1-s.getCurrentFrame()/(n.end-n.start)):1-r,e.setOpacity(t)}}))}))),this.toggleRangeCircleVisibility((this.gameObject.showWeaponRange||this.selectionModel.isSelected()&&-1!==this.gameObject.rules.techLevel)&&!c);d=this.needsWallImageRefresh();var g,p,m=void 0===this.lastOccupiedState||this.lastOccupiedState!==!!this.gameObject.garrisonTrait?.isOccupied(),f=void 0===this.lastHealth||this.lastHealth!==this.gameObject.healthTrait.health;(d||m||f)&&(g=this.computeDamageType(this.gameObject.healthTrait.health),f=f&&g!==this.computeDamageType(this.lastHealth),this.lastOccupiedState=!!this.gameObject.garrisonTrait?.isOccupied(),this.lastHealth=this.gameObject.healthTrait.health,this.lastWallType=this.gameObject.wallType,(d||m||f)&&this.updateImage(g),f&&g===r.DamageType.DESTROYED&&this.objectRules.explosion.length&&this.createExplosionAnims(this.renderableManager)),this.gameObject.turretTrait&&((g=this.gameObject.turretTrait.facing)!==this.lastTurretFacing&&(this.lastTurretFacing=g,this.turretRot.rotation.y=THREE.Math.degToRad(g),this.turretRot.updateMatrix()),g=this.gameObject.turretTrait.isRotating()&&!c,this.lastTurretRotating!==g&&(this.lastTurretRotating=g,(p=this.objectRules.turretRotateSound)&&(g&&!this.gameObject.isDestroyed?this.turretRotateSound=this.worldSound?.playEffect(p,this.gameObject,this.gameObject.owner):this.turretRotateSound?.stop()))),this.gameObject.poweredTrait&&(this.gameObject.isDestroyed?this.poweredSound&&(this.poweredSound.stop(),this.poweredSound=void 0):(p=this.gameObject.poweredTrait.isPoweredOn()&&!c)!==this.lastPowered&&(this.setPowered(p),this.lastPowered=p,this.poweredSound?.stop(),(p=p?this.gameObject.rules.workingSound:this.gameObject.rules.notWorkingSound)&&!c&&(this.poweredSound=this.worldSound?.playEffect(p,this.gameObject,this.gameObject.owner,.25))))}}createExplosionAnims(e){var t=this.objectArt.foundation,i=this.objectRules.explosion;for(let s=0;s<t.width;s++)for(let n=0;n<t.height;n++){var r=i[h.getRandomInt(0,i.length-1)];e.createTransientAnim(r,(e=>{e.setPosition(c.Coords.tile3dToWorld(s,n,0).add(this.withPosition.getPosition()))}))}}updateMuzzleAnims(e){let t=this.muzzleAnims,i=[];t.forEach((t=>{t.update(e),t.isAnimFinished()&&(this.spriteWrap.remove(t.get3DObject()),t.dispose(),i.push(t))})),i.forEach((e=>t.splice(t.indexOf(e),1)))}getNormalizedAnimType(e){let t=0,i=e;return B.has(e)&&([i,t]=B.get(e)),[i,t]}hasObjectWithStoppedAnimation(e){var t,[t,i]=this.getNormalizedAnimType(e);if(t=this.animObjects.get(t)){let r=this.animations.get(t[i]);if(!r)throw new Error(`Missing animation for type '${s.AnimationType[e]}'`);if(r.getState()===o.AnimationState.STOPPED)return!0}return!1}computeDamageType(e){if(!e)return r.DamageType.DESTROYED;let t;return t=e>100*this.rules.audioVisual.conditionYellow?r.DamageType.NORMAL:e>100*this.rules.audioVisual.conditionRed?r.DamageType.CONDITION_YELLOW:r.DamageType.CONDITION_RED,(t&&this.objectRules.canBeOccupied||t===r.DamageType.CONDITION_RED)&&(t-=1),t}updateImage(e){let t=e===r.DamageType.DESTROYED;t?(this.objectRules.leaveRubble&&this.rubbleObj&&(this.rubbleObj.get3DObject().visible=!0),this.mainObj&&(this.mainObj.get3DObject().visible=!1)):this.objectRules.wall?this.updateWallImage(this.gameObject.wallType,e):this.updateMainObjFrame(!!this.gameObject.garrisonTrait?.isOccupied(),e),this.bib&&(t&&(this.bib.get3DObject().visible=!1),this.bib.setFrame(e!==r.DamageType.NORMAL?1:0)),this.turret&&t&&(this.turret.visible=!1),this.animObjects.forEach(((i,n)=>{i.forEach(((a,o)=>{if(n!==s.AnimationType.BUILDUP&&n!==s.AnimationType.UNBUILD){t&&i.forEach((e=>e.get3DObject().visible=!1));let h=this.animations.get(a);var l=e!==r.DamageType.NORMAL,c=this.animArtProps.getByType(n)[o];!l||c.damagedArt?(h.props.setArt(l?c.damagedArt:c.art),h.rewind()):console.warn(`<${this.gameObject.name}>: Missing damaged anim ${s.AnimationType[n]},`+o)}}))}));let i=e!==r.DamageType.NORMAL&&!t;this.fireObjects.forEach((e=>{e.get3DObject().visible=i;let t=this.animations.get(e);t.rewind();var r=t.props.getArt().get("StartSound");r&&this.handleSoundChange(r,e,i,.15)}))}updateMainObjFrame(e,t){let i=e?2:t;this.mainShpFile&&this.mainObj&&(i>=this.shpFrameInfos.get(this.mainShpFile).frameCount&&(console.warn(`Building ${this.objectRules.name} has damage frame `+i+` (occupied=${e}, damageType=${r.DamageType[t]}) out of bounds`),i=r.DamageType.NORMAL),this.mainObj.setFrame(i))}needsWallImageRefresh(){var e=this.gameObject.wallType,t=this.lastWallType;return this.objectRules.wall&&(!t||e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3])}updateWallImage(e,t){if(this.objectRules.wall&&this.mainObj&&this.mainShpFile){let r=this.findWallImageIndex(e);-1===r&&(console.warn("Invalid wall type",e),r=0);var i=r+t*(i=this.shpFrameInfos.get(this.mainShpFile).frameCount<l.wallTypes.length?1:l.wallTypes.length);this.mainObj.setFrame(i)}}findWallImageIndex(e){for(let i=0;i<l.wallTypes.length;++i){var t=l.wallTypes[i];if(t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3])return i}return-1}createObjects(e){var t=this.objectArt.foundation;this.debugFrame.value&&(n=m.DebugUtils.createWireframe(t,this.objectArt.height),e.add(n));let i=new f.MapSpriteTranslation(t.width,t.height);var{spriteOffset:r,anchorPointWorld:s}=i.compute(),n=this.spriteOffset=this.computeSpriteAnchorOffset(r);let a=this.spriteWrap=new THREE.Object3D;a.matrixAutoUpdate=!1;let o=a,l={...n},h=!1;if(r=this.objectArt.zShapePointMove,(this.gameObject.rules.refinery||this.gameObject.rules.nukeSilo)&&r.length){o=new THREE.Object3D,o.matrixAutoUpdate=!1,a.add(o),h=!0,r={x:-r[0]/c.Coords.ISO_TILE_SIZE,y:-r[1]/c.Coords.ISO_TILE_SIZE};let e=new f.MapSpriteTranslation(r.x,r.y);var{spriteOffset:u,anchorPointWorld:r}=e.compute();o.position.x=r.x,o.position.z=r.y,o.updateMatrix(),l.x+=u.x,l.y+=u.y}if(this.mainShpFile?(this.mainObj=this.createMainObject(this.mainShpFile,l,h),this.mainObj.create3DObject(),o.add(this.mainObj.get3DObject()),this.mainObj.getFlat()&&(I.MathUtils.translateTowardsCamera(this.mainObj.get3DObject(),this.camera,+c.Coords.ISO_WORLD_SCALE),this.mainObj.get3DObject().updateMatrix())):(this.placeholderObj=new P.DebugRenderable(t,this.objectArt.height,this.palette),this.placeholderObj.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholderObj.setBatchPalettes(this.paletteRemaps),this.placeholderObj.create3DObject(),e.add(this.placeholderObj.get3DObject())),this.objectRules.leaveRubble&&(this.rubbleObj=this.createRubbleObject(n),this.rubbleObj&&(this.rubbleObj.setExtraLight(this.shpExtraLight),this.rubbleObj.create3DObject(),this.rubbleObj.get3DObject().visible=!1,a.add(this.rubbleObj.get3DObject()))),this.createAnimObjects(l,h).forEach((e=>{o.add(e)})),this.fireObjects=this.createFireObjects(n),this.fireObjects.forEach((e=>{a.add(e.get3DObject())})),this.objectRules.turret&&(({turret:u,turretRot:t}=this.createTurretObject(n,s)),this.turret=u,this.turretRot=t,a.add(this.turret)),this.bibShpFile){this.bib=this.createBibObject(this.bibShpFile,n),this.bib.create3DObject();let e=this.bib.get3DObject();I.MathUtils.translateTowardsCamera(e,this.camera,-1),e.updateMatrix(),a.add(this.bib.get3DObject())}if((this.gameObject.primaryWeapon||this.gameObject.rules.hasRadialIndicator)&&(n=this.gameObject.psychicDetectorTrait?.radiusTiles??this.gameObject.gapGeneratorTrait?.radiusTiles??this.gameObject.primaryWeapon?.range)){let t=this.rangeCircle=this.createRangeCircle(n);t.matrixAutoUpdate=!1,t.position.x=s.x/2,t.position.z=s.y/2,t.updateMatrix(),t.visible=!1,e.add(t)}a.position.x=s.x,a.position.z=s.y,a.updateMatrix(),e.add(a)}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x,y:e.y+t.y}}createMainObject(e,t,i=!1){let r=!1;this.objectRules.turret&&"CAOUTP"!==this.objectRules.name&&(r=!0);let s=g.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,t,this.objectArt.hasShadow,0,!r,0,i);return s.setSize(e),s.setFrameOffset(this.aggregatedImageData.imageIndexes.get(e)),s.setBatched(this.useSpriteBatching),this.useSpriteBatching&&s.setBatchPalettes(this.paletteRemaps),s.setFlat(r),s}createRubbleObject(e){var t=this.mainShpFile;if(t){let i=g.ShpRenderable.factory(this.aggregatedImageData.file,this.isoPalette,this.camera,e,this.objectArt.hasShadow);if(i.setSize(t),!(this.shpFrameInfos.get(t).frameCount<4))return i.setFrameOffset(this.aggregatedImageData.imageIndexes.get(t)),i.setBatched(this.useSpriteBatching),this.useSpriteBatching&&i.setBatchPalettes([this.isoPalette]),i.setFlat(!0),i.setFrame(3),i;console.warn(`Building image ${this.objectArt.imageName} has no rubble frame (missing 4th frame)`)}}createAnimObjects(e,t){let i=[];return this.animArtProps.getAll().forEach(((r,s)=>{let n=[],a=1;for(var o of r){var l=this.animShpFiles.get(o);if(l){let r=this.createAnimObject(o,l,e,a++,t);r&&(i.push(r.get3DObject()),n.push(r))}}this.animObjects.set(s,n)})),i}createFireObjects(e){let t=[],r=0;for(;;){let a=this.objectArt.art.getString("DamageFireOffset"+r++);if(!a)break;var s=this.rules.audioVisual.fireNames,n=s[h.getRandomInt(0,s.length-1)];let l;try{l=this.imageFinder.find(n,this.objectArt.useTheaterExtension)}catch(e){if(e instanceof p.ImageFinder.MissingImageError){console.warn(e.message);continue}throw e}s=a.split(/\.|,/).filter((e=>""!==e));let d=parseInt(s[0],10),m=parseInt(s[1],10);s=this.animPalette;let f=new i.ShpBuilder(l,s,this.camera,c.Coords.ISO_WORLD_SCALE,!0,3);f.setOffset({x:e.x+d,y:e.y+m});let y=new g.ShpRenderable(f);y.setBatched(this.useSpriteBatching),this.useSpriteBatching&&y.setBatchPalettes([s]),y.create3DObject(),y.get3DObject().visible=!1,n=this.art.getAnimation(n),n=new u.AnimProps(n.art,l),this.animations.set(y,new o.Animation(n,this.gameSpeed)),t.push(y)}return t}createMuzzleFlashAnim(e,t){if(this.objectArt.muzzleFlash?.length){var i=h.getRandomInt(0,this.objectArt.muzzleFlash.length-1),r=this.objectArt.muzzleFlash[i];if((i=this.gameObject.owner.country?.side===w.SideType.GDI?this.gameObject.primaryWeapon:this.gameObject.secondaryWeapon)&&(i=i.rules.anim).length){i=i[h.getRandomInt(0,i.length-1)];let s={x:e.x+r.x,y:e.y+r.y};return t.createAnim(i,(e=>{e.extraOffset=s}),!0)}}}createAnimObject(e,t,i,r,s){var n=e.art,a=new u.AnimProps(n,t);n={x:i.x+e.offset.x,y:i.y+e.offset.y};let l=g.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,n,a.shadow,0,!e.flat,r,s&&!e.flat);return l.setSize(t),l.setFrameOffset(this.aggregatedImageData.imageIndexes.get(t)),l.setBatched(this.useSpriteBatching),this.useSpriteBatching&&l.setBatchPalettes(this.paletteRemaps),l.setFlat(e.flat),(e.translucent||0<e.translucency)&&l.setForceTransparent(!0),l.create3DObject(),this.animations.set(l,new o.Animation(a,this.gameSpeed)),l}createBibObject(e,t){let i=g.ShpRenderable.factory(this.aggregatedImageData.file,this.palette,this.camera,t,this.objectArt.hasShadow);return i.setSize(e),i.setFrameOffset(this.aggregatedImageData.imageIndexes.get(e)),i.setBatched(this.useSpriteBatching),this.useSpriteBatching&&i.setBatchPalettes(this.paletteRemaps),i.setFlat(!0),i}createTurretObject(e,t){this.turretBuilders=[];let r=new THREE.Object3D;r.matrixAutoUpdate=!1;let s=new THREE.Object3D;s.matrixAutoUpdate=!1;let n=this.objectRules.turretAnim;var a={x:this.objectRules.turretAnimX,y:this.objectRules.turretAnimY};let o;if(this.objectRules.turretAnimIsVoxel){var l=!this.objectArt.noHva;let e=n.toLowerCase()+".vxl";var h=this.voxels.get(e);if(h){var u=l?this.voxelAnims.get(e.replace(".vxl",".hva")):void 0;let t=this.vxlBuilderFactory.create(h,u,this.paletteRemaps,this.palette);this.turretBuilders.push(t),o=t.build(),o.children.forEach((e=>e.castShadow=!1))}else console.warn(`Turret missing for building ${this.type}. Vxl file ${e} not found. `);if(n.toLowerCase().includes("tur")){let t=e.replace("tur","barl");if(u=this.voxels.get(t)){var d=l?this.voxelAnims.get(t.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(u,d,this.paletteRemaps,this.palette);this.turretBuilders.push(e);let i=e.build();i.children.forEach((e=>e.castShadow=!1)),s.add(i)}}d=c.Coords.screenDistanceToWorld(a.x,a.y),r.position.x=-t.x+d.x,r.position.z=-t.y+d.y}else{let r;try{r=this.imageFinder.find(n,this.objectArt.useTheaterExtension)}catch(t){if(!(t instanceof p.ImageFinder.MissingImageError))throw t;console.warn(t.message)}if(r){let t=new i.ShpBuilder(r,this.palette,this.camera,c.Coords.ISO_WORLD_SCALE,!0,2);t.setBatched(this.useSpriteBatching),this.useSpriteBatching&&t.setBatchPalettes(this.paletteRemaps),this.turretBuilders.push(t),t.setOffset({x:e.x+a.x,y:e.y+a.y}),o=t.build()}}return o&&s.add(o),r.add(s),I.MathUtils.translateTowardsCamera(r,this.camera,-(this.objectRules.turretAnimZAdjust+this.objectRules.turretAnimY/Math.cos(this.camera.rotation.y))*c.Coords.ISO_WORLD_SCALE),r.updateMatrix(),{turret:r,turretRot:s}}createRangeCircle(e){var t=e*c.Coords.getWorldTileSize();let i=this.gameObject.owner.color;return n.OverlayUtils.createGroundCircle(t,i.asHex())}toggleRangeCircleVisibility(e){this.rangeCircle&&(this.rangeCircle.visible=e)}setAnimationVisibility(e,t,i=-1){let r=this.animObjects.get(e);if(void 0===r)throw new Error(`Missing animObjects for animType "${s.AnimationType[e]}"`);if(-1!==i){if(i>=r.length)throw new RangeError(`Index ${i} exceeds length of animation objects (${r.length}) of type `+s.AnimationType[e]);r=[r[i]]}for(var n of r){n.get3DObject().visible=t;let e=this.animations.get(n).props.getArt(),i=e.get("Report");i=i||e.get("StartSound"),i&&this.handleSoundChange(i,n,t)}}setActiveAnimationVisible(){let e=this.animArtProps.getByType(s.AnimationType.ACTIVE);this.objectRules.refinery&&(e=[e[0]]),e.forEach((({showWhenUnpowered:e},t)=>{try{this.setAnimationVisibility(s.AnimationType.ACTIVE,this.powered||e,t)}catch(e){RangeError}}))}setPowered(e){if(this.powered=e,this.currentAnimType===s.AnimationType.IDLE&&this.setActiveAnimationVisible(),this.objectRules.superWeapon&&this.hasAnimation(s.AnimationType.SUPER)){var[t,i]=this.getNormalizedAnimType(s.AnimationType.SUPER_CHARGE_LOOP),r=this.animObjects.get(t);if(void 0===r)throw new Error(`Missing anim object for normalized anim type "${s.AnimationType[t]}"`);i=r[i];let n=this.animations.get(i);e?n.unpause():n.pause()}else this.animObjects.get(s.AnimationType.ACTIVE).forEach(((t,i)=>{let r=this.animations.get(t);r&&(!e&&this.animArtProps.getByType(s.AnimationType.ACTIVE)[i].pauseWhenUnpowered?r.pause():r.unpause())}))}hasAnimation(e){return e===s.AnimationType.IDLE||([e]=this.getNormalizedAnimType(e),this.animObjects.has(e)&&!!this.animObjects.get(e).length)}setAnimation(e,t){if(!this.gameObject.healthTrait.health)throw new Error("We can't switch building animation for a destroyed building");switch(this.hasAnimation(e)||(e=s.AnimationType.IDLE),this.currentAnimType=e,this.setAnimationVisibility(s.AnimationType.IDLE,!1),this.setAnimationVisibility(s.AnimationType.SPECIAL,!1),this.setAnimationVisibility(s.AnimationType.PRODUCTION,!1),this.setAnimationVisibility(s.AnimationType.SUPER,!1),this.setAnimationVisibility(s.AnimationType.BUILDUP,!1),this.setAnimationVisibility(s.AnimationType.UNBUILD,!1),this.setAnimationVisibility(s.AnimationType.FACTORY_DEPLOYING,!1),this.setAnimationVisibility(s.AnimationType.FACTORY_ROOF_DEPLOYING,!1),this.setActiveAnimationVisible(),e!==s.AnimationType.BUILDUP&&e!==s.AnimationType.UNBUILD?(this.mainObj&&(this.mainObj.get3DObject().visible=!0),this.bib&&(this.bib.get3DObject().visible=!0),this.turret&&(this.turret.visible=!0)):(this.mainObj&&(this.mainObj.get3DObject().visible=!1),this.bib&&(this.bib.get3DObject().visible=!1),this.turret&&(this.turret.visible=!1)),e!==s.AnimationType.FACTORY_DEPLOYING&&e!==s.AnimationType.FACTORY_ROOF_DEPLOYING||this.mainObj&&(this.mainObj.get3DObject().visible=!1),e){case s.AnimationType.PRODUCTION:this.setAnimationVisibility(s.AnimationType.PRODUCTION,!0),this.animObjects.get(s.AnimationType.PRODUCTION).forEach((e=>{this.animations.get(e).start(t)}));break;case s.AnimationType.BUILDUP:this.setAnimationVisibility(s.AnimationType.ACTIVE,!1),this.setAnimationVisibility(s.AnimationType.BUILDUP,!0),this.animObjects.get(s.AnimationType.BUILDUP).forEach((e=>{this.animations.get(e).start(t)}));break;case s.AnimationType.UNBUILD:this.setAnimationVisibility(s.AnimationType.ACTIVE,!1),this.setAnimationVisibility(s.AnimationType.UNBUILD,!0),this.animObjects.get(s.AnimationType.UNBUILD).forEach((e=>{this.animations.get(e).start(t)}));break;case s.AnimationType.FACTORY_DEPLOYING:if(this.hasAnimation(s.AnimationType.FACTORY_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(s.AnimationType.FACTORY_DEPLOYING,!0),this.animObjects.get(s.AnimationType.FACTORY_DEPLOYING).forEach((e=>{this.animations.get(e).start(t)}));break}case s.AnimationType.FACTORY_ROOF_DEPLOYING:if(this.hasAnimation(s.AnimationType.FACTORY_ROOF_DEPLOYING)&&this.objectRules.factory){this.setAnimationVisibility(s.AnimationType.FACTORY_ROOF_DEPLOYING,!0),this.animObjects.get(s.AnimationType.FACTORY_ROOF_DEPLOYING).forEach((e=>{this.animations.get(e).start(t)}));break}case s.AnimationType.SPECIAL_REPAIR_START:case s.AnimationType.SPECIAL_REPAIR_LOOP:case s.AnimationType.SPECIAL_REPAIR_END:case s.AnimationType.SPECIAL_DOCKING:if(this.hasAnimation(s.AnimationType.SPECIAL)&&(e===s.AnimationType.SPECIAL_DOCKING&&this.objectRules.refinery||e!==s.AnimationType.SPECIAL_DOCKING&&this.objectRules.unitRepair)){var[i,r]=this.getNormalizedAnimType(e);this.setAnimationVisibility(i,!0,r),r=this.animObjects.get(i)[r],this.animations.get(r).start(t);break}case s.AnimationType.SPECIAL_SHOOT:if(this.objectRules.isBaseDefense){this.setAnimationVisibility(s.AnimationType.ACTIVE,!1);var[r,n]=this.getNormalizedAnimType(e);this.setAnimationVisibility(r,!0,n),n=this.animObjects.get(r)[n],this.animations.get(n).start(t);break}case s.AnimationType.SUPER_CHARGE_START:case s.AnimationType.SUPER_CHARGE_LOOP:case s.AnimationType.SUPER_CHARGE_END:if(this.objectRules.superWeapon&&this.hasAnimation(s.AnimationType.SUPER)){var[n,a]=this.getNormalizedAnimType(e);this.setAnimationVisibility(n,!0,a),a=this.animObjects.get(n)[a],this.animations.get(a).start(t);break}case s.AnimationType.IDLE:default:this.currentAnimType=s.AnimationType.IDLE,this.objectRules.superWeapon&&this.hasAnimation(s.AnimationType.SUPER)?(this.setAnimationVisibility(s.AnimationType.SUPER,!0,0),a=this.animObjects.get(s.AnimationType.SUPER)[0],this.animations.get(a).start(t)):(this.setAnimationVisibility(s.AnimationType.IDLE,!0),this.animObjects.get(s.AnimationType.IDLE).forEach((e=>{this.animations.get(e).start(t)})))}}doWithAnimation(e,t){var[i,r]=this.getNormalizedAnimType(e);let n=this.animObjects.get(i);if(void 0===n)throw new Error(`Missing animObjects for anim type "${s.AnimationType[i]}"`);i!==e&&(n=[n[r]]),n.forEach(((e,i)=>{t(this.animations.get(e),e)}))}doWithCurrentAnimation(e){this.doWithAnimation(this.currentAnimType,e)}endCurrentAnimation(){this.doWithCurrentAnimation((e=>e.endLoop()))}handleSoundChange(e,t,i,r=1){if(i){var s;this.animSounds.has(t)&&this.animSounds.get(t).isPlaying()||(s=this.worldSound?.playEffect(e,this.gameObject,this.gameObject.owner,r))&&this.animSounds.set(t,s)}else{let e=this.animSounds.get(t);e&&e.isLoop&&(e.stop(),this.animSounds.delete(t))}}onCreate(e){this.renderableManager=e,this.plugins.forEach((t=>t.onCreate(e))),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject,void 0,.25)),this.pipOverlay?.onCreate(e)}onRemove(e){if(this.renderableManager=void 0,this.plugins.forEach((t=>t.onRemove(e))),this.animSounds.forEach((e=>e.stop())),this.ambientSound?.stop(),this.turretRotateSound?.stop(),this.poweredSound?.stop(),this.gameObject.isDestroyed)return this.gameObject.deathType===x.DeathType.Temporal||this.gameObject.deathType===x.DeathType.None?void 0:void(this.objectRules.explosion.length&&this.createExplosionAnims(e))}dispose(){this.plugins.forEach((e=>e.dispose())),this.pipOverlay?.dispose(),this.placeholderObj?.dispose(),this.mainObj?.dispose(),this.rubbleObj?.dispose(),this.bib?.dispose(),this.fireObjects?.forEach((e=>e.dispose())),this.turretBuilders?.forEach((e=>e.dispose())),[...this.animObjects?.values()].forEach((e=>e.forEach((e=>e.dispose()))))}}),j.lampTextures=new Map}}})),System.register("engine/renderable/entity/BoxIntersectObject3D",[],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[],execute:function(){i=new THREE.Ray,r=new THREE.Matrix4,s=new THREE.Box3,n=new THREE.Vector3,a=class extends THREE.Object3D{constructor(e){super(),this.boxSize=e}raycast(e,t){if(this.parent){r.getInverse(this.parent.matrixWorld),i.copy(e.ray).applyMatrix4(r),n.copy(this.position);let a=s.setFromCenterAndSize(n,this.boxSize);if(i.intersectsBox(a)){const i=new THREE.Vector3;a.getCenter(i),i.applyMatrix4(this.parent.matrixWorld),t.push({distance:e.ray.origin.distanceTo(i),point:i,object:this})}}}},e("BoxIntersectObject3D",a)}}})),System.register("engine/renderable/entity/unit/RotorHelper",["game/gameobject/unit/ZoneType","util/math"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("RotorHelper",class{static computeRotationStep(e,t,s){var n=e.zone===i.ZoneType.Air,a=e.rules.idleRate,o=n||!!s.idleSpeed||!!a;let l=s.speed??67;n||(s.idleSpeed?l=s.idleSpeed:a&&(l/=a));var c=Math.sign(l);n=Math.abs(THREE.Math.degToRad(l)),a=Math.abs(t);return c*r.clamp(a+.1*(o?1:a/n*-.5),0,n)}})}}})),System.register("engine/renderable/entity/Vehicle",["liang-barsky","game/gameobject/Vehicle","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","engine/ImageFinder","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","data/IniSection","engine/animation/SimpleRunner","util/math","engine/type/ObjectType","game/type/SpeedType","engine/renderable/entity/HighlightAnimRunner","game/gameobject/unit/VeteranLevel","game/gameobject/trait/HarvesterTrait","game/gameobject/common/DeathType","game/gameobject/unit/FacingUtil","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","game/GameSpeed","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e}],execute:function(){var t;P=Math.PI/4,(t=I=I||{})[t.Grab=0]="Grab",t[t.Shake1=1]="Shake1",t[t.Shake2=2]="Shake2",e("Vehicle",class{constructor(e,t,i,r,s,a,o,l,c,h,u,d,g,p,m,f,T){this.gameObject=e,this.rules=t,this.imageFinder=r,this.voxels=a,this.voxelAnims=o,this.palette=l,this.camera=c,this.lighting=h,this.debugFrame=u,this.gameSpeed=d,this.selectionModel=g,this.vxlBuilderFactory=p,this.useSpriteBatching=m,this.pipOverlay=f,this.worldSound=T,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new y.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new C.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=e.rules,this.objectArt=e.art,this.label="vehicle_"+this.objectRules.name,this.paletteRemaps=[...this.rules.colors.values()].map((e=>this.palette.clone().remap(e))),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.updateBaseLight(),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new n.WithPosition}updateBaseLight(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1).addScalar(this.rules.audioVisual.extraUnitLight),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)+this.rules.audioVisual.extraUnitLight)}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach((e=>e.updateLighting?.())),this.updateBaseLight(),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new x.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(s.Coords.LEPTONS_PER_TILE)),e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.vxlBuilders.forEach((e=>e.setExtraLight(this.vxlExtraLight))),this.shpRenderable?.setExtraLight(this.shpExtraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}updateClippingPlanes(e,t=!1){if(t||this.objectRules.naval&&!this.objectRules.underwater){var i=s.Coords.tileHeightToWorld(e);let t=[new THREE.Plane(new THREE.Vector3(0,1,0),-i)];this.vxlBuilders.forEach((e=>e.setClippingPlanes(t)))}}getIntersectTarget(){return this.target}getUiName(){var e=this.plugins.reduce(((e,t)=>t.getUiNameOverride?.()??e),void 0);return void 0!==e?e:this.gameObject.getUiName()}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some((e=>e.shouldDisableHighlight?.()))||this.highlightAnimRunner.animation.getState()!==h.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(e,t=0){this.plugins.forEach((t=>t.update(e))),this.pipOverlay?.update(e),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===T.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var i=this.gameObject.tile.z+this.gameObject.tileElevation,r=void 0===this.lastElevation||this.lastElevation!==i;r&&(this.lastElevation=i,this.updateBaseLight(),this.updateClippingPlanes(this.gameObject.tile.z));var n=this.gameObject.invulnerableTrait.isActive(),a=n!==this.lastInvulnerable;this.lastInvulnerable=n;var o=this.highlightAnimRunner.shouldUpdate();o&&this.highlightAnimRunner.tick(e),n&&a&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(e);var l=this.gameObject.warpedOutTrait.isActive(),c=l!==this.lastWarpedOut;this.lastWarpedOut=l;var p=this.gameObject.cloakableTrait?.isCloaked(),m=p!==this.lastCloaked;this.lastCloaked=p;let f=this.gameObject.submergibleTrait?.isSubmerged();if(i=f!==this.lastSubmerged,this.lastSubmerged=f,c||m||i){let e=l||p||f?.5:1;this.shpRenderable?.setOpacity(e),this.shpRenderable?.setFlat(!!f),this.vxlBuilders.forEach((t=>{t.setOpacity(e),t.setShadow(!f)})),this.placeholder?.setOpacity(e)}if((r||a||n||o)&&(y=n?this.invulnAnimRunner.getValue():0,S=(o?this.highlightAnimRunner.getValue():0)||y,v=this.lighting.getAmbientIntensity(),A.ExtraLightHelper.multiplyVxl(this.vxlExtraLight,this.baseVxlExtraLight,v,S),A.ExtraLightHelper.multiplyShp(this.shpExtraLight,this.baseShpExtraLight,S)),this.gameObject.isDestroyed&&this.resolveObjectRemove){if(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),this.destroyStartTime||(this.destroyStartTime=e),this.isSinker()){(E=1<=(C=(e-this.destroyStartTime)/3e3))?this.mainObj.visible=!1:(this.objectRules.naval&&(this.mainObj.rotation.x=Math.PI/4*C),this.mainObj.position.y=-16*s.Coords.ISO_WORLD_SCALE*C,this.mainObj.position.z=8*s.Coords.ISO_WORLD_SCALE*C,this.mainObj.updateMatrix());let t=!1;this.sinkWakeAnims.forEach((t=>t.update(e))),this.sinkWakeAnims.filter((e=>!e.isAnimFinished())).length||(this.sinkWakeAnims.forEach((e=>this.get3DObject().remove(e.get3DObject()))),this.sinkWakeAnims.length=0,t=!0),E&&t&&this.resolveObjectRemove()}}else if(!this.gameObject.warpedOutTrait.isActive()){let i=(Math.floor(this.gameObject.direction+this.gameObject.spinVelocity*t)+360)%360;var y=i!==this.lastDirection;y&&void 0!==this.lastDirection&&this.objectArt.isVoxel&&this.gameObject.zone===w.ZoneType.Air&&(x=i-this.lastDirection,void 0!==this.lastDirectionDelta&&Math.abs(x)<2&&Math.abs(this.lastDirectionDelta)<2&&Math.sign(x)!==Math.sign(this.lastDirectionDelta)?i=this.lastDirection:this.lastDirectionDelta=x),this.lastDirection=i;var v=this.gameObject.owner.color;this.lastOwnerColor!==v&&(this.palette.remap(v),this.lastOwnerColor=v,this.vxlBuilders.forEach((e=>e.setPalette(this.palette))),this.shpRenderable?.setPalette(this.palette),this.placeholder?.setPalette(this.palette));var b,S=this.gameObject.isMoving||!this.objectArt.isVoxel&&!!this.gameObject.spinVelocity,C=this.gameObject.isFiring,E=void 0===this.lastMoving||this.lastMoving!==S,x=void 0===this.lastFiring||this.lastFiring!==C;if(0<t&&(S||E)){v=this.gameObject.moveTrait.velocity.clone().multiplyScalar(t).add(this.gameObject.position.worldPosition),this.setPosition(v)}let r;if((E||x)&&(this.lastMoving=S,this.lastFiring=C,this.objectArt.isVoxel||this.updateShapeAnimation(S,C)),this.gameObject.rules.isChargeTurret){if(x&&C){this.chargeTurretRunner=new g.SimpleRunner;let e=new u.AnimProps(new d.IniSection("dummy"),this.gameObject.rules.turretCount);e.reverse=!0,e.rate=5;var O=new h.Animation(e,this.gameSpeed);this.chargeTurretRunner.animation=O}this.chargeTurretRunner?.tick(e);var M=this.chargeTurretRunner?.getCurrentFrame()??0;r=M!==this.currentTurretIdx,this.currentTurretIdx=M,this.chargeTurretRunner?.animation.getState()===h.AnimationState.STOPPED&&(this.chargeTurretRunner=void 0)}else r=this.gameObject.turretNo!==this.currentTurretIdx,this.currentTurretIdx=this.gameObject.turretNo;this.objectArt.isVoxel?(this.updateVxlRotation(i,y),this.updateBodyVxl(),O=(x=this.gameObject.rocking?.facing)!==this.lastRockingFacing,this.lastRockingFacing=x,!O||void 0===x||0<(b=this.gameObject.rocking.factor)&&this.startRocking(x,b,e),b=(M=!(!this.gameObject.parasiteableTrait?.isInfested()||!this.gameObject.parasiteableTrait.getParasite()?.rules.organic))!==this.lastSquidGrabbed,this.lastSquidGrabbed=M,this.updateRocking(e,M),1<this.objectRules.turretCount&&r&&this.updateActiveTurret(this.currentTurretIdx),this.updateSquidGrab(e,M,b,y,i,x,O)):this.shpAnimRunner&&(this.shpAnimRunner.tick(e),this.updateShapeFrame(i,S,C))}}updateVxlRotation(e,t){var i,r=this.gameObject.tilterTrait?.tilt??{yaw:0,pitch:0};this.lastTilt&&r.pitch===this.lastTilt.pitch&&r.yaw===this.lastTilt.yaw&&!t||(this.lastTilt=r,this.tiltObj.rotation.y=THREE.Math.degToRad(r.yaw),this.tiltObj.rotation.x=THREE.Math.degToRad(r.pitch),this.tiltObj.updateMatrix(),this.dirWrapObj.rotation.y=THREE.Math.degToRad(e-r.yaw),this.dirWrapObj.updateMatrix()),this.turret&&(r=(i=Math.floor(this.gameObject.turretTrait.facing))!==this.lastTurretFacing,this.lastTurretFacing=i,(r||t)&&(i=THREE.Math.degToRad(i-e),this.turret.rotation.y=i,this.turret.updateMatrix(),this.barrel&&(this.barrel.rotation.y=i,this.barrel.updateMatrix()))),this.rotors&&this.rotors.forEach(((e,t)=>{this.rotorSpeeds[t]=O.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[t]??0,this.objectArt.rotors[t]),this.rotorSpeeds[t]&&(e.rotateOnAxis(this.objectArt.rotors[t].axis,this.rotorSpeeds[t]),e.updateMatrix())}))}startRocking(e,t,r){if(this.bodyVxlBuilder){this.rockingStartTime=r,this.rockingFactor=t;var s=this.bodyVxlBuilder.getLocalBoundingBox();let a=new THREE.Box2(new THREE.Vector2(s.min.x,s.min.y),new THREE.Vector2(s.max.x,s.max.y));var n=THREE.Math.degToRad(S.FacingUtil.toWorldDeg(e));s=new THREE.Vector2;let o=new THREE.Vector2(10,0).rotateAround(new THREE.Vector2,n).setLength(a.getSize(s).length()+1);s=o.toArray(),i.default([0,0],s,[a.min.x,a.min.y,a.max.x,a.max.y]),this.rockingPoint=new THREE.Vector3(s[0],0,s[1]),s=o.clone().rotateAround(new THREE.Vector2,-Math.PI/2).normalize(),this.rockingAxis=new THREE.Vector3(s.x,0,s.y)}}updateRocking(e,t){if(this.rockingStartTime){var i=e-this.rockingStartTime;let n=this.rockingFactor;t||(n*=1-Math.min(1,this.gameObject.rules.weight/5));var s=i||n?Math.min(1,i/(r.ROCKING_TICKS/E.GameSpeed.BASE_TICKS_PER_SECOND*1e3)*this.gameSpeed.value/n):0;i=P*n*(1-Math.pow(2*(s-.5),2));this.rockingTiltObj.position.set(0,0,0),this.rockingTiltObj.rotation.set(0,0,0),this.rockingTiltObj.scale.set(1,1,1),R.MathUtils.rotateObjectAboutPoint(this.rockingTiltObj,this.rockingPoint,this.rockingAxis,i),this.rockingTiltObj.updateMatrix(),1!==s&&0!==n||(this.rockingStartTime=void 0)}}updateSquidGrab(e,t,i,r,n,a,o){var l;if(i&&(this.squidGrabAnim&&(this.posObj?.remove(this.squidGrabAnim.get3DObject()),this.squidGrabAnim.dispose(),this.squidGrabAnim=void 0),t&&(this.squidGrabAnim=this.renderableManager.createAnim("SQDG",(e=>{e.extraOffset={x:0,y:-s.Coords.ISO_TILE_SIZE/4},e.setExtraLight(this.shpExtraLight)}),!0),this.squidGrabAnim.remapColor(this.gameObject.parasiteableTrait.getParasite().owner.color),this.squidGrabAnim.create3DObject(),this.posObj?.add(this.squidGrabAnim.get3DObject()))),t&&(r||i)&&this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),n,I.Grab),t&&o&&a&&(l=0<a?I.Shake1:I.Shake2,this.updateSquidGrabAnim(this.squidGrabAnim.getAnimProps(),n,l),this.squidGrabAnim.reset()),t&&o&&!a){var c=this.rules.combatDamage.splashList;for(let e=0;e<3;e++){var h=c[p.getRandomInt(0,c.length-1)];this.renderableManager.createTransientAnim(h,(e=>{let t=this.withPosition.getPosition().clone();var i={x:p.getRandomInt(-s.Coords.ISO_TILE_SIZE/2,s.Coords.ISO_TILE_SIZE/2)*s.Coords.ISO_WORLD_SCALE,y:p.getRandomInt(-s.Coords.ISO_TILE_SIZE/2,s.Coords.ISO_TILE_SIZE/2)*s.Coords.ISO_WORLD_SCALE};e.setPosition(t.add(new THREE.Vector3(i.x,0,i.y)))}))}}this.squidGrabAnim?.update(e)}updateShapeAnimation(e,t){if(this.shpAnimRunner){let r=this.shpAnimRunner.animation.props;var i;t?(r.loopEnd=this.objectArt.firingFrames-1,r.rate=u.AnimProps.defaultRate/2):e||this.objectRules.naval?(r.loopEnd=this.objectArt.walkFrames-1,i=this.objectRules.naval&&!e?this.objectRules.idleRate:this.objectRules.walkRate,r.rate=u.AnimProps.defaultRate/i):r.loopEnd=0,this.shpAnimRunner.animation.rewind()}}updateShapeFrame(e,t,i){if(this.shpRenderable&&this.shpAnimRunner){let n;var r,s=Math.round((45-e+360)%360/360*8)%8;n=i?(r=this.shpAnimRunner.animation.getCurrentFrame(),8*this.objectArt.walkFrames+8+this.objectArt.firingFrames*s+r):t||this.objectRules.naval?(r=this.shpAnimRunner.animation.getCurrentFrame(),this.objectArt.walkFrames*s+r):8*this.objectArt.walkFrames+s,this.shpRenderable.setFrame(n)}}updateSquidGrabAnim(e,t,i){var s=Math.round((360-t)%360/360*8)%8;e.start=10*s+80*i,e.end=10*s+9+80*i,e.loopStart=e.start,e.loopEnd=e.end,e.loopCount=0,e.rate=10/(r.ROCKING_TICKS/E.GameSpeed.BASE_TICKS_PER_SECOND/(this.rockingFactor??1))}createObjects(e){if(this.debugFrame.value){let t=a.DebugUtils.createWireframe({width:1,height:1},1);t.translateX(-s.Coords.getWorldTileSize()/2),t.translateZ(-s.Coords.getWorldTileSize()/2),e.add(t)}let t=this.tiltObj=new THREE.Object3D;t.matrixAutoUpdate=!1,t.rotation.order="YXZ";let i=this.dirWrapObj=new THREE.Object3D;i.matrixAutoUpdate=!1;var r=this.mainObj=this.createMainObject();let n=this.rockingTiltObj=new THREE.Object3D;n.matrixAutoUpdate=!1,n.rotation.order="YXZ",n.add(r),i.add(n),t.add(i);let o=this.posObj=new THREE.Object3D;o.matrixAutoUpdate=!1,o.add(t),e.add(o)}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x,y:e.y+t.y}}createMainObject(){let e=new THREE.Object3D;if(e.matrixAutoUpdate=!1,this.objectArt.isVoxel){var t=!this.objectArt.noHva,i=this.objectArt.imageName.toLowerCase(),r=i+".vxl",s=this.voxels.get(r);if(s){var n=t?this.voxelAnims.get(i+".hva"):void 0;let r=this.bodyVxlBuilder=this.vxlBuilderFactory.create(s,n,this.paletteRemaps,this.palette);this.vxlBuilders.push(r),n=this.mainVxl=r.build(),e.add(n),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map((e=>{var t=r.getSection(e.name);if(!t)throw new Error(`Vehicle "${this.objectRules.name}" VXL section "${e.name}" not found`);return t})))}else console.warn(`VXL missing for vehicle ${this.objectRules.name}. Vxl file ${r} not found. `),e.add(this.createPlaceholder());if(this.objectRules.spawns&&this.objectRules.noSpawnAlt){let r=i+"wo.vxl";if(p=this.voxels.get(r)){var a=t?this.voxelAnims.get(r.replace(".vxl",".hva")):void 0;let i=this.vxlBuilderFactory.create(p,a,this.paletteRemaps,this.palette);this.vxlBuilders.push(i);let s=this.noSpawnAltVxl=i.build();s.visible=!1,e.add(s)}else console.warn(`<${this.gameObject.name}>: Couldn't find noSpawnAlt image "${r}"`)}if(this.gameObject.harvesterTrait&&this.objectRules.unloadingClass){var p,f=this.rules.getObject(this.objectRules.unloadingClass,m.ObjectType.Vehicle).imageName.toLowerCase();if(p=this.voxels.get(f+".vxl")){a=t?this.voxelAnims.get(f+".hva"):void 0;let i=this.vxlBuilderFactory.create(p,a,this.paletteRemaps,this.palette);this.vxlBuilders.push(i);let r=this.harvesterAltVxl=i.build();r.visible=!1,e.add(r)}else console.warn(`<${this.gameObject.name}>: Couldn't find UnloadingClass image "${f}.vxl"`)}if(this.gameObject.turretTrait){let r=e;if(f=this.objectArt.turretOffset){let t=new THREE.Object3D;t.matrixAutoUpdate=!1,t.position.z=-f,t.updateMatrix(),e.add(t),r=t}let s,n=[];for(let e=0;e<this.objectRules.turretCount;++e){let r=i+`tur${e||""}.vxl`;var y=this.voxels.get(r);if(y){var T=t?this.voxelAnims.get(r.replace(".vxl",".hva")):void 0;let i=this.vxlBuilderFactory.create(y,T,this.paletteRemaps,this.palette);this.vxlBuilders.push(i);let s=i.build();s.visible=e===this.gameObject.turretNo,n.push(s)}else console.warn(`<${this.gameObject.name}>: Missing turret file "${r}"`),n.push(void 0)}this.currentTurretIdx=this.gameObject.turretNo,this.allTurrets=n,1<n.length?(s=this.turret=new THREE.Object3D,s.matrixAutoUpdate=!1,n.forEach((e=>e&&s.add(e)))):s=this.turret=n[0],s&&r.add(s);let a=i+"barl.vxl";if(f=this.voxels.get(a)){var v=t?this.voxelAnims.get(a.replace(".vxl",".hva")):void 0;let e=this.vxlBuilderFactory.create(f,v,this.paletteRemaps,this.palette);this.vxlBuilders.push(e);var b=this.barrel=e.build();r.add(b)}}}else{let t=new c.MapSpriteTranslation(1,1);var{spriteOffset:v,anchorPointWorld:b}=t.compute();v=this.computeSpriteAnchorOffset(v);let r;try{r=this.imageFinder.findByObjectArt(this.objectArt)}catch(i){if(!(i instanceof l.ImageFinder.MissingImageError))throw i;console.warn(`<${this.gameObject.name}>: `+i.message)}if(r){let t=this.shpRenderable=o.ShpRenderable.factory(r,this.palette,this.camera,v,this.objectArt.hasShadow);t.setBatched(this.useSpriteBatching),this.useSpriteBatching&&t.setBatchPalettes(this.paletteRemaps),t.create3DObject(),e.add(t.get3DObject()),e.position.x=b.x,e.position.z=b.y,e.updateMatrix();let i=new u.AnimProps(new d.IniSection("dummy"),r);i.loopCount=-1,b=new h.Animation(i,this.gameSpeed),this.shpAnimRunner=new g.SimpleRunner,this.shpAnimRunner.animation=b}else e.add(this.createPlaceholder())}return e}createPlaceholder(){return this.placeholder=new M.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject()}updateActiveTurret(e){this.allTurrets.forEach(((t,i)=>{t&&(t.visible=i===e)}))}updateBodyVxl(){var e=!!this.noSpawnAltVxl&&!this.gameObject.airSpawnTrait.availableSpawns,t=!!this.harvesterAltVxl&&!!this.gameObject.harvesterTrait&&[v.HarvesterStatus.PreparingToUnload,v.HarvesterStatus.Unloading].includes(this.gameObject.harvesterTrait.status);this.noSpawnAltVxl&&(this.noSpawnAltVxl.visible=e),this.harvesterAltVxl&&(this.harvesterAltVxl.visible=t),this.mainVxl&&(this.mainVxl.visible=!e&&!t)}isSinker(){return this.gameObject.zone===w.ZoneType.Water&&this.gameObject.isSinker}onCreate(e){this.renderableManager=e,this.plugins.forEach((t=>t.onCreate(e))),this.objectRules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.objectRules.ambientSound,this.gameObject))}onRemove(e){if(this.renderableManager=void 0,this.plugins.forEach((t=>t.onRemove(e))),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.isVehicle()&&this.get3DObject()){if(this.gameObject.deathType===b.DeathType.Temporal)return;if(this.gameObject.deathType===b.DeathType.None)return;if(this.gameObject.deathType===b.DeathType.Crush)return;if(!this.isSinker()||this.objectRules.underwater||this.gameObject.deathType!==b.DeathType.Sink&&this.objectRules.speedType===f.SpeedType.Hover){if(this.objectRules.underwater&&this.objectRules.organic)return;if(!this.objectRules.explosion.length)return;if(this.gameObject.explodes&&this.objectRules.deathWeapon)return;var t=(t=this.objectRules.explosion)[p.getRandomInt(0,t.length-1)];return void e.createTransientAnim(t,(e=>e.setPosition(this.withPosition.getPosition())))}if(this.isSinker()){var i=this.rules.audioVisual.wake;this.sinkWakeAnims=[];for(let t=0;t<5;t++){let t=e.createAnim(i,void 0,!0);var r={x:p.getRandomInt(-15,15)*s.Coords.ISO_WORLD_SCALE,y:p.getRandomInt(-15,15)*s.Coords.ISO_WORLD_SCALE};t.setPosition(new THREE.Vector3(r.x,0,r.y)),this.sinkWakeAnims.push(t),t.create3DObject(),this.get3DObject().add(t.get3DObject())}this.gameObject.rules.naval||this.updateClippingPlanes(this.gameObject.tile.z,!0)}return new Promise((e=>this.resolveObjectRemove=e))}}dispose(){this.plugins.forEach((e=>e.dispose())),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.vxlBuilders.forEach((e=>e.dispose())),this.sinkWakeAnims?.forEach((e=>e.dispose())),this.squidGrabAnim?.dispose(),this.placeholder?.dispose()}})}}})),System.register("engine/renderable/builder/BatchShpBuilder",["engine/renderable/builder/ShpTextureAtlas","engine/gfx/SpriteUtils","engine/gfx/TextureUtils","engine/gfx/material/PaletteBasicMaterial"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("BatchShpBuilder",class{constructor(e,t,i,r,s=1,n=!1,a=1e4,o=1){this.shpFile=e,this.palette=t,this.camera=i,this.textureCache=r,this.opacity=s,this.transparent=n,this.batchSize=a,this.scale=o,this.specIndexes=new Map}get verticesPerSprite(){return r.SpriteUtils.VERTICES_PER_SPRITE}get trianglesPerSprite(){return r.SpriteUtils.TRIANGLES_PER_SPRITE}initTexture(){var e;this.textureCache.has(this.shpFile)?this.atlas=this.textureCache.get(this.shpFile):(e=(new i.ShpTextureAtlas).fromShpFile(this.shpFile),this.textureCache.set(this.shpFile,e),this.atlas=e)}getSpriteGeometryOptions(e){var t={x:(t=this.shpFile.getImage(e.frameNo)).x-e.shpFile.width/2+e.offset.x,y:t.y-e.shpFile.height/2+e.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getTextureArea(e.frameNo),flat:e.flat,depth:e.depth,align:{x:1,y:-1},offset:t,camera:this.camera,scale:this.scale}}setPalette(e){if(this.palette=e,this.mesh){var t=s.TextureUtils.textureFromPalette(e);this.mesh.material.palette=t}}build(){if(this.mesh)return this.mesh;this.initTexture();var e=s.TextureUtils.textureFromPalette(this.palette);let t=new THREE.BufferGeometry;var i,a=this.batchSize*this.verticesPerSprite,o=new THREE.BufferAttribute(new Float32Array(3*a),3);t.addAttribute("position",o),this.positionAttribute=o,t.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(2*a),2)),r.SpriteUtils.USE_INDEXED_GEOMETRY&&(i=this.batchSize*this.trianglesPerSprite*3,t.setIndex(new THREE.BufferAttribute(new Uint32Array(3*i),1)));var l;a=new THREE.BufferAttribute(new Float32Array(4*a),4);t.addAttribute("vertexColorMult",a),this.colorMultAttribute=a;let c=0;for(l of this.specIndexes.keys())this.specIndexes.set(l,c),this.setSpecGeometry(l,t,c),c++;if(this.firstFreeSpriteIdx=c<this.batchSize?c:-1,c<this.batchSize){let e=o.array;for(let t=c;t<this.batchSize-1;t++)e[t*this.verticesPerSprite*3]=t+1;e[(this.batchSize-1)*this.verticesPerSprite*3]=-1}e=new n.PaletteBasicMaterial({map:this.atlas.getTexture(),palette:e,alphaTest:this.transparent?.05:.5,flatShading:!0,transparent:this.transparent,opacity:this.opacity,useVertexColorMult:!0});let h=new THREE.Mesh(t,e);return h.matrixAutoUpdate=!1,h.frustumCulled=!1,this.mesh=h,h}add(e){if(!this.specIndexes.has(e)){if(this.isFull())throw new Error("Batch is full");var t=this.mesh?.geometry;if(t){var i=this.firstFreeSpriteIdx;if(-1===i)throw new Error("No free sprite index found");this.specIndexes.set(e,i);var r=(this.positionAttribute?.array)[i*this.verticesPerSprite*3];this.setSpecGeometry(e,t,i),this.firstFreeSpriteIdx=r}else this.specIndexes.set(e,void 0)}}setSpecGeometry(e,t,i){var s=this.getSpriteGeometryOptions(e);let n=r.SpriteUtils.createSpriteGeometry(s);s=e.position,n.applyMatrix((new THREE.Matrix4).makeTranslation(s.x,s.y,s.z));let a=n;if(a.getAttribute("position").count!==this.verticesPerSprite)throw new Error("Vertex count mismatch");t.merge(a,i*this.verticesPerSprite),a.index&&(t.index.array.set(Uint32Array.from(a.index.array,(e=>e+i*this.verticesPerSprite)),i*a.index.array.length),t.index.needsUpdate=!0);var o;s=e.lightMult??new THREE.Vector3(1,1,1);for(o of(this.setLightingAt(i,s,this.colorMultAttribute.array),this.setVisibilityAt(i,!0,this.colorMultAttribute.array),Object.values(t.attributes)))o.needsUpdate=!0}has(e){return this.specIndexes.has(e)}remove(e){if(this.specIndexes.has(e)){if(this.mesh){var t=this.specIndexes.get(e);this.setVisibilityAt(t,!1,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.positionAttribute.array[t*this.verticesPerSprite*3]=this.firstFreeSpriteIdx,this.firstFreeSpriteIdx=t}this.specIndexes.delete(e)}}update(e){var t;!this.specIndexes.has(e)||(t=this.mesh?.geometry)&&this.setSpecGeometry(e,t,this.specIndexes.get(e))}isFull(){return this.specIndexes.size===this.batchSize}isEmpty(){return 0===this.specIndexes.size}setLightingAt(e,t,i){for(let r=0;r<this.verticesPerSprite;r++)i[e*this.verticesPerSprite*4+4*r]=t.x,i[e*this.verticesPerSprite*4+4*r+1]=t.y,i[e*this.verticesPerSprite*4+4*r+2]=t.z}setVisibilityAt(e,t,i){for(let r=0;r<this.verticesPerSprite;r++)i[e*this.verticesPerSprite*4+4*r+3]=t?1:0}updateLighting(){if(this.mesh){let e=this.colorMultAttribute.array;this.specIndexes.forEach(((t,i)=>{var r=i.lightMult??new THREE.Vector3(1,1,1);this.setLightingAt(t,r,e)})),this.colorMultAttribute.needsUpdate=!0}}dispose(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose())}})}}})),System.register("engine/renderable/entity/map/MapSpriteBatchLayer",["game/Coords","engine/ImageFinder","engine/renderable/builder/BatchShpBuilder","engine/renderable/builder/ShpAggregator","engine/renderable/MapSpriteTranslation","engine/renderable/ShadowRenderable","util/typeGuard"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("MapSpriteBatchLayer",class{constructor(e,t,i,r,s,n,a,o,l){this.label=e,this.spriteUseDepth=i,this.theater=r,this.art=s,this.imageFinder=n,this.camera=a,this.lighting=o,this.shpAggregator=l,this.textureCache=new Map,this.batchShpSpecsByObject=new Map,this.batchShpBuilders=new Map,this.shadowBatchShpBuilders=[],this.batchedObjectRules=new Set(t),this.aggregatedImageData=this.createAggregatedShpFile(`agg_${e}.shp`)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,e.matrixAutoUpdate=!1,this.target=e)}createAggregatedShpFile(e){var t=[...this.batchedObjectRules.values()].map((e=>{var t=this.art.getObject(e.name,e.type);let i;try{i=this.imageFinder.findByObjectArt(t)}catch(e){if(e instanceof r.ImageFinder.MissingImageError)return;throw e}return n.ShpAggregator.getShpFrameInfo(i,t.hasShadow)})).filter(l.isNotNullOrUndefined);return this.shpAggregator.aggregate(t,e)}update(e){}updateLighting(){this.batchShpSpecsByObject.forEach(((e,t)=>{e.main.lightMult?.copy(this.lighting.compute(t.art.lightingType,t.tile))})),[...this.batchShpBuilders.values()].flat().forEach((e=>e.updateLighting()))}shouldBeBatched(e){return this.batchedObjectRules.has(e.rules)}getBatchKey(e){return e.art.paletteType+"_"+e.art.customPaletteName}addObject(e){var t=this.getBatchKey(e);let r=this.batchShpBuilders.get(t);r||(r=[],this.batchShpBuilders.set(t,r));let n,a=r.find((e=>!e.isFull()));if(!a){if(!this.get3DObject())throw new Error("Not implemented");{var l=this.theater.getPalette(e.art.paletteType,e.art.customPaletteName);let t=new s.BatchShpBuilder(this.aggregatedImageData.file,l,this.camera,this.textureCache,void 0,void 0,void 0,i.Coords.ISO_WORLD_SCALE);r.push(t),this.get3DObject().add(t.build()),a=t}}if(l=this.buildBatchShpSpec(e,this.aggregatedImageData),a.add(l),e.art.hasShadow){let e=this.shadowBatchShpBuilders.find((e=>!e.isFull()));if(!e){if(!this.get3DObject())throw new Error("Not implemented");{let t=new s.BatchShpBuilder(this.aggregatedImageData.file,o.ShadowRenderable.getOrCreateShadowPalette(),this.camera,this.textureCache,.5,!0,void 0,i.Coords.ISO_WORLD_SCALE);this.shadowBatchShpBuilders.push(t),this.get3DObject().add(t.build()),e=t}}n=this.buildShadowBatchShpSpec(l,this.aggregatedImageData),e.add(n)}this.batchShpSpecsByObject.set(e,{main:l,shadow:n})}buildBatchShpSpec(e,t){var i=e.getFoundation();let r=new a.MapSpriteTranslation(i.width,i.height),s=e.position.worldPosition.clone(),{spriteOffset:n,anchorPointWorld:o}=r.compute();s.x+=o.x,s.z+=o.y;var l=this.imageFinder.findByObjectArt(e.art);if(void 0===(i=t.imageIndexes.get(l)))throw new Error("SHP file not found in aggregated image data");return{shpFile:l,frameNo:i,depth:this.spriteUseDepth(e),flat:e.art.flat,position:s,offset:n.clone().add(e.art.getDrawOffset()),lightMult:this.lighting.compute(e.art.lightingType,e.tile)}}buildShadowBatchShpSpec(e,t){var i=t.imageIndexes.get(e.shpFile);if(void 0===i)throw new Error("SHP file not found in aggregated image data");return{...e,position:e.position.clone().add(new THREE.Vector3(0,.1,0)),flat:!0,frameNo:i+t.file.numImages/2,lightMult:void 0}}removeObject(e){const t=this.batchShpSpecsByObject.get(e);if(t){var i=this.getBatchKey(e);let r=this.batchShpBuilders.get(i),s=r?.find((e=>e.has(t.main)));if(s){if(s.remove(t.main),s.isEmpty()&&1<r.length&&(this.get3DObject()?.remove(s.build()),s.dispose(),r?.splice(r.indexOf(s),1)),t.shadow){let e=this.shadowBatchShpBuilders.find((e=>e.has(t.shadow)));e?.remove(t.shadow),e?.isEmpty()&&1<this.shadowBatchShpBuilders.length&&(this.get3DObject()?.remove(e.build()),e.dispose(),this.shadowBatchShpBuilders.splice(this.shadowBatchShpBuilders.indexOf(e),1))}this.batchShpSpecsByObject.delete(e)}}}hasObject(e){return this.batchShpSpecsByObject.has(e)}setObjectFrame(e,t){const i=this.batchShpSpecsByObject.get(e);if(!i)throw new Error(`Batch SHP spec for object "${e.name}" not found`);if(!(t>=i.main.shpFile.numImages*(i.shadow?.5:1))){var r=this.aggregatedImageData.imageIndexes.get(i.main.shpFile);i.main.frameNo=r+t,i.shadow&&(i.shadow.frameNo=i.main.frameNo+this.aggregatedImageData.file.numImages/2),r=this.getBatchKey(e);let s=this.batchShpBuilders.get(r)?.find((e=>e.has(i.main)));if(s?.update(i.main),i.shadow){let e=this.shadowBatchShpBuilders.find((e=>e.has(i.shadow)));e?.update(i.shadow)}}}dispose(){[...this.batchShpBuilders.values(),...this.shadowBatchShpBuilders].flat().forEach((e=>e.dispose())),[...this.textureCache.values()].forEach((e=>e.dispose())),this.textureCache.clear()}})}}})),System.register("engine/renderable/entity/Terrain",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","game/gameobject/trait/TiberiumTreeTrait","engine/animation/SimpleRunner","engine/AnimProps","engine/Animation","data/IniSection","engine/renderable/AlphaRenderable"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("Terrain",class{constructor(e,t,i,r,s,n,a,o,l){this.gameObject=e,this.terrainLayer=t,this.imageFinder=i,this.palette=r,this.camera=s,this.lighting=n,this.debugFrame=a,this.gameSpeed=o,this.useSpriteBatching=l,this.objectArt=e.art,this.label="terrain_"+e.rules.name,this.init()}init(){this.tiberiumTreeTrait=this.gameObject.traits.find(o.TiberiumTreeTrait),this.withPosition=new i.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(e){var t;this.tiberiumTreeTrait&&((t=this.tiberiumTreeTrait.status)!==this.lastTiberiumSpawnStatus&&(this.lastTiberiumSpawnStatus=t)===o.SpawnStatus.Spawning&&this.animationRunner?.animation.reset(),this.animationRunner&&(this.animationRunner.tick(e),this.animationRunner.animation.getState()!==h.AnimationState.STOPPED?this.mainObj.setFrame(this.animationRunner.getCurrentFrame()):this.mainObj.setFrame(0)))}createObjects(e){var t={width:1,height:1};let i;this.debugFrame.value&&(g=s.DebugUtils.createWireframe(t,2),e.add(g));try{i=this.imageFinder.findByObjectArt(this.objectArt)}catch(o){if(o instanceof r.ImageFinder.MissingImageError)return void console.warn(o.message);throw o}var o=this.gameObject.rules.alphaImage;if(o){var g=this.imageFinder.tryFind(o,!1);if(g){let t=new d.AlphaRenderable(g,this.camera,this.objectArt.getDrawOffset());t.create3DObject(),e.add(t.get3DObject())}else console.warn(`<${this.gameObject.name}>: Alpha image "${o}" not found`)}if(this.terrainLayer?.shouldBeBatched(this.gameObject))this.terrainLayer.addObject(this.gameObject);else{let r=new THREE.Object3D;r.matrixAutoUpdate=!1;let s=new n.MapSpriteTranslation(t.width,t.height),{spriteOffset:o,anchorPointWorld:d}=s.compute();r.position.x=d.x,r.position.z=d.y,r.updateMatrix(),t=o.clone().add(this.objectArt.getDrawOffset());let g=a.ShpRenderable.factory(i,this.palette,this.camera,t,this.objectArt.hasShadow);if(g.setBatched(this.useSpriteBatching),this.useSpriteBatching&&g.setBatchPalettes([this.palette]),g.setFrame(0),g.setExtraLight(this.extraLight),g.create3DObject(),r.add(g.get3DObject()),this.mainObj=g,this.tiberiumTreeTrait){let e=new u.IniSection("dummy");this.gameObject.rules.animationRate&&(e.set("Rate",""+60*this.gameObject.rules.animationRate),e.set("Shadow","yes")),t=new c.AnimProps(e,i);let r=new h.Animation(t,this.gameSpeed);this.animationRunner=new l.SimpleRunner,this.animationRunner.animation=r,r.stop()}e.add(r)}}onRemove(){this.terrainLayer?.hasObject(this.gameObject)&&this.terrainLayer.removeObject(this.gameObject)}dispose(){this.mainObj?.dispose()}})}}})),System.register("engine/renderable/entity/Overlay",["data/ShpFile","game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","util/math","game/map/BridgeOverlayTypes","engine/type/ObjectType","game/gameobject/common/DeathType","engine/renderable/entity/BoxIntersectObject3D","engine/gfx/MathUtils","engine/renderable/entity/map/MapSurface"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){e("Overlay",class{constructor(e,t,i,r,s,n,a,o,l,c,h){this.gameObject=e,this.rules=t,this.art=i,this.imageFinder=r,this.palette=s,this.camera=n,this.lighting=a,this.debugFrame=o,this.bridgeImageCache=l,this.mapOverlayLayer=c,this.useSpriteBatching=h,this.isInvisible=!1,this.objectRules=e.rules,this.objectArt=e.art,this.label="overlay_"+this.objectRules.name,this.init()}init(){this.withPosition=new s.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){var e=this.objectArt.lightingType;this.extraLight.copy(this.lighting.compute(e,this.gameObject.tile,this.gameObject.isHighBridge()?4:0)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}update(e){var t;this.isInvisible||(t=1e4*this.gameObject.overlayId+this.gameObject.value)!==this.lastOverlayHash&&(this.lastOverlayHash=t,t=this.computeFrame(),this.mainRenderable?t<this.mainRenderable.frameCount&&this.mainRenderable.setFrame(t):this.mapOverlayLayer.setObjectFrame(this.gameObject,t))}computeFrame(){let e=this.gameObject,t=e.value;return e.isBridge()&&0===t&&(t=l.getRandomInt(0,3)),t}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}getIntersectTarget(){return this.intersectTarget}getUiName(){return this.gameObject.getUiName()}createObjects(e){var t=this.gameObject.getFoundation();if(this.debugFrame.value&&(s=this.createWireframe(t,1),e.add(s)),this.objectRules.isRubble||this.gameObject.isBridgePlaceholder())this.isInvisible=!0;else{var i=this.gameObject.isBridge()||this.gameObject.isTiberium()||this.gameObject.rules.wall;if(this.mapOverlayLayer?.shouldBeBatched(this.gameObject)){if(this.mapOverlayLayer.addObject(this.gameObject),i){let i=new d.BoxIntersectObject3D(new THREE.Vector3(1,0,1).multiplyScalar(r.Coords.LEPTONS_PER_TILE));i.position.add(new THREE.Vector3(t.width/2,0,t.height/2).multiplyScalar(r.Coords.LEPTONS_PER_TILE)),i.matrixAutoUpdate=!1,i.updateMatrix(),e.add(i),this.intersectTarget=i}}else{let n=new THREE.Object3D;n.matrixAutoUpdate=!1;let o=new a.MapSpriteTranslation(t.width,t.height),{spriteOffset:l,anchorPointWorld:h}=o.compute();var s=l.clone().add(this.objectArt.getDrawOffset());let u;if(this.gameObject.isLowBridge()){t=c.BridgeOverlayTypes.getOverlayBridgeType(this.gameObject.overlayId);let e=this.bridgeImageCache.get(t);e||(e=this.buildVirtualBridgeFile(t),this.bridgeImageCache.set(t,e)),u=e}else u=this.imageFinder.findByObjectArt(this.objectArt);let d=this.mainRenderable=this.createMainObject(u,s);if(d.create3DObject(),n.add(d.get3DObject()),i&&d&&(this.intersectTarget=d.getShapeMesh()),s=r.Coords.getWorldTileSize(),n.position.x=h.x,n.position.z=h.y,i=this.gameObject.isXBridge(),this.gameObject.isBridge()&&(n.position.x+=s/2,n.position.z+=s/2,n.position.x+=i?0:s,n.position.z+=i?s:0),this.gameObject.isHighBridge()){n.position.x-=+r.Coords.ISO_WORLD_SCALE,n.position.z-=+r.Coords.ISO_WORLD_SCALE,n.position.x+=s+(i?.5*s:0),n.position.z+=s+(i?.5*s:0);let t=d.getShadowMesh();t&&(g.MathUtils.translateTowardsCamera(t,this.camera,(p.MAGIC_OFFSET+.05)*r.Coords.ISO_WORLD_SCALE),t.updateMatrix()),s=this.createBridgeShadowSurface(),e.add(s)}n.updateMatrix(),e.add(n)}}}buildVirtualBridgeFile(e){var t=e===c.OverlayBridgeType.Concrete?c.BridgeOverlayTypes.minLowBridgeConcreteId:c.BridgeOverlayTypes.minLowBridgeWoodId,r=e===c.OverlayBridgeType.Concrete?c.BridgeOverlayTypes.maxLowBridgeConcreteId:c.BridgeOverlayTypes.maxLowBridgeWoodId;let s=new i.ShpFile;s.filename="agg_"+this.gameObject.name+".shp";for(let e=t;e<=r;e++){var n=this.rules.getOverlay(this.rules.getOverlayName(e));n=this.art.getObject(n.name,h.ObjectType.Overlay);let t=this.imageFinder.findByObjectArt(n);s.width||(s.width=t.width,s.height=t.height),s.addImage(t.getImage(1))}return s}createBridgeShadowSurface(){var e=(t=this.gameObject.getFoundation()).width*r.Coords.getWorldTileSize(),t=t.height*r.Coords.getWorldTileSize();let i=new THREE.PlaneGeometry(e,t);i.applyMatrix((new THREE.Matrix4).makeTranslation(e/2,p.MAGIC_OFFSET,t/2).multiply((new THREE.Matrix4).makeRotationX(-Math.PI/2)));let s=new THREE.ShadowMaterial;s.transparent=!0,s.opacity=.5;let n=new THREE.Mesh(i,s);return n.receiveShadow=!0,n.renderOrder=5,n}createWireframe(e,t){let i=n.DebugUtils.createWireframe(e,t);var s=this.gameObject.isBridge();return i.position.y+=s?r.Coords.tileHeightToWorld(-1):0,i}createMainObject(e,t){var i=this.objectRules.wall,r=this.gameObject.isHighBridge()?4:0;let s=o.ShpRenderable.factory(e,this.palette,this.camera,t,this.objectArt.hasShadow&&!this.gameObject.isLowBridge(),r,i);return s.setBatched(this.useSpriteBatching),this.useSpriteBatching&&s.setBatchPalettes([this.palette]),s.setFlat(this.objectArt.flat),s.setExtraLight(this.extraLight),s}onRemove(e){if(this.mapOverlayLayer?.hasObject(this.gameObject)&&this.mapOverlayLayer.removeObject(this.gameObject),this.gameObject.isDestroyed&&(this.gameObject.deathType===u.DeathType.Demolish||this.gameObject.isHighBridge())){var t=this.gameObject.getFoundation(),i=this.rules.audioVisual.bridgeExplosions;for(let n=0;n<t.width;n++)for(let a=0;a<t.height;a++){var s=i[l.getRandomInt(0,i.length-1)];e.createTransientAnim(s,(e=>{e.setPosition(r.Coords.tile3dToWorld(n,a,0).add(this.withPosition.getPosition()))}))}}}dispose(){this.mainRenderable?.dispose()}})}}})),System.register("engine/renderable/entity/Smudge",["engine/renderable/builder/ShpBuilder","engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/MapSpriteTranslation","game/Coords"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("Smudge",class{constructor(e,t,i,r,s,n,a){this.gameObject=e,this.imageFinder=t,this.palette=i,this.camera=r,this.lighting=s,this.debugFrame=n,this.mapSmudgeLayer=a,this.objectArt=e.art,this.label="smudge_"+e.name,this.init()}init(){this.withPosition=new r.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting()}updateLighting(){this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile)).addScalar(-1)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}update(e){}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}createObjects(e){var t,r={width:1,height:1};let l=new THREE.Object3D;if(l.matrixAutoUpdate=!1,this.debugFrame.value&&(t=n.DebugUtils.createWireframe(r,0),e.add(t)),this.mapSmudgeLayer?.shouldBeBatched(this.gameObject))this.mapSmudgeLayer.addObject(this.gameObject);else{let n;try{n=this.imageFinder.findByObjectArt(this.objectArt)}catch(t){if(t instanceof s.ImageFinder.MissingImageError)return void console.warn(t.message);throw t}let c=new a.MapSpriteTranslation(r.width,r.height),{spriteOffset:h,anchorPointWorld:u}=c.compute();r=h.clone().add(this.objectArt.getDrawOffset());let d=this.builder=new i.ShpBuilder(n,this.palette,this.camera,o.Coords.ISO_WORLD_SCALE);d.setOffset(r),d.flat=this.objectArt.flat,d.setExtraLight(this.extraLight),r=d.build(),l.add(r),l.position.x=u.x,l.position.z=u.y,l.updateMatrix(),e.add(l)}}onRemove(){this.mapSmudgeLayer?.hasObject(this.gameObject)&&this.mapSmudgeLayer.removeObject(this.gameObject)}dispose(){this.builder?.dispose()}})}}})),System.register("game/gameobject/infantry/sequenceMap",["game/gameobject/unit/ZoneType","game/art/SequenceType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("getFireSequenceBy",a=(e,t=s.StanceType.None)=>t===s.StanceType.Deployed?r.SequenceType.DeployedFire:e===i.ZoneType.Water?r.SequenceType.WetAttack:e===i.ZoneType.Air?r.SequenceType.FireFly:t===s.StanceType.Prone?r.SequenceType.FireProne:r.SequenceType.FireUp),e("getMoveSequenceBy",o=(e,t,n)=>e===i.ZoneType.Air?r.SequenceType.Fly:e===i.ZoneType.Water?r.SequenceType.Swim:t===s.StanceType.Prone?r.SequenceType.Crawl:n?r.SequenceType.Panic:r.SequenceType.Walk),e("getIdleSequenceBy",((e,t=s.StanceType.None)=>t===s.StanceType.Deployed?[r.SequenceType.DeployedIdle]:e===i.ZoneType.Water?[r.SequenceType.WetIdle1,r.SequenceType.WetIdle2]:e!==i.ZoneType.Air?[r.SequenceType.Idle1,r.SequenceType.Idle2]:void 0)),e("getStillSequenceBy",l=(e,t=s.StanceType.None)=>t===s.StanceType.Deployed?r.SequenceType.Deployed:e===i.ZoneType.Water?r.SequenceType.Tread:e===i.ZoneType.Air?r.SequenceType.Hover:t===s.StanceType.Prone?r.SequenceType.Prone:t===s.StanceType.Guard?r.SequenceType.Guard:t===s.StanceType.Paradrop?r.SequenceType.Paradrop:r.SequenceType.Ready),e("getStanceTransitionSequenceBy",((e,t)=>e===s.StanceType.Prone?r.SequenceType.Up:t===s.StanceType.Prone?r.SequenceType.Down:e===s.StanceType.Deployed?r.SequenceType.Undeploy:t===s.StanceType.Deployed?r.SequenceType.Deploy:t===s.StanceType.Cheer?r.SequenceType.Cheer:void 0)),e("getCrashingSequences",(e=>{let t=[...e.art.sequences.keys()];var i=[r.SequenceType.AirDeathStart,r.SequenceType.AirDeathFalling].filter((e=>t.includes(e)));if(i.length)return i})),e("getDeathSequence",((e,t)=>{var s=e.zone,a=e.rules.isHuman;let o,l=[...e.art.sequences.keys()];return e.isCrashing?o=[r.SequenceType.AirDeathFinish]:s===i.ZoneType.Air?o=[r.SequenceType.Tumble]:s===i.ZoneType.Water?![n.InfDeathType.Gunfire,n.InfDeathType.Explode].includes(t)&&a||(o=[r.SequenceType.WetDie1,r.SequenceType.WetDie2]):t!==n.InfDeathType.Gunfire&&a?t===n.InfDeathType.Explode&&(o=[r.SequenceType.Die2]):o=[r.SequenceType.Die1],o&&(o=o.filter((e=>l.includes(e))),o.length||(o=void 0)),o})),e("getDeathAnim",((e,t)=>t===n.InfDeathType.ExplodeAlt?e.audioVisual.infantryExplode:t===n.InfDeathType.Fire?e.audioVisual.flamingInfantry:t===n.InfDeathType.Electro?[...e.animationNames][1]:t===n.InfDeathType.HeadExplode?e.audioVisual.infantryHeadPop:t===n.InfDeathType.Nuke?e.audioVisual.infantryNuked:void 0)),e("findSequence",((e,t,r,n,c,h)=>{var u=e=>-1!==h.indexOf(e);let d;return n&&(d=a(e,t),u(d)||(d=a(e),u(d)||(d=void 0))),void 0===d&&r&&(d=o(e,t,c),u(d)||(d=o(e,s.StanceType.None,c),u(d)||(d=void 0))),void 0===d&&(d=l(e,t),u(d)||(d=l(e),u(d)||(d=l(i.ZoneType.Ground)))),d}))}}})),System.register("engine/renderable/entity/unit/BlobShadow",["game/Coords","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","engine/gfx/batch/BatchedMesh"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("BlobShadow",a=class e{constructor(e,t,i){this.gameObject=e,this.radius=t,this.useMeshInstancing=i}get3DObject(){return this.obj}create3DObject(){if(!this.obj){let t=e.geometries.get(this.radius);t||(t=new THREE.CircleBufferGeometry(this.radius*i.Coords.ISO_WORLD_SCALE),e.geometries.set(this.radius,t)),this.obj=new(this.useMeshInstancing?n.BatchedMesh:THREE.Mesh)(t,e.mat),this.obj.rotation.x=-Math.PI/2,this.obj.matrixAutoUpdate=!1}}update(e,t){let n=this.obj;var a,o,l=this.gameObject.zone===r.ZoneType.Air||this.gameObject.isInfantry()&&this.gameObject.stance===s.StanceType.Paradrop;(n.visible=l)&&(a=this.gameObject.tile.z,o=this.gameObject.tileElevation,l=!!this.gameObject.tile.onBridgeLandType,a===this.lastTileZ&&o===this.lastTileElevation&&l===this.lastBridgeBelow||(this.lastTileZ=a,this.lastTileElevation=o,this.lastBridgeBelow=l,l=this.gameObject.position.getBridgeBelow(),n.position.y=i.Coords.tileHeightToWorld(-o)+(l?i.Coords.tileHeightToWorld(l.tileElevation)+.01*i.Coords.ISO_WORLD_SCALE:0),n.updateMatrix()))}dispose(){}}),a.geometries=new Map,a.mat=new THREE.MeshBasicMaterial({color:0,transparent:!0,opacity:.5,alphaTest:0})}}})),System.register("engine/renderable/entity/Infantry",["engine/renderable/WithPosition","engine/ImageFinder","engine/gfx/DebugUtils","engine/renderable/ShpRenderable","game/Coords","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","game/gameobject/infantry/sequenceMap","game/gameobject/unit/ZoneType","game/gameobject/infantry/StanceType","game/art/SequenceType","util/math","game/gameobject/infantry/InfDeathType","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","game/gameobject/common/DeathType","game/type/MovementZone","engine/renderable/entity/unit/BlobShadow","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable","engine/gfx/MathUtils"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e}],execute:function(){e("Infantry",class{constructor(e,t,r,s,n,a,o,l,c,h,u,d,g,p,m){this.gameObject=e,this.rules=t,this.art=r,this.imageFinder=s,this.palette=a,this.camera=o,this.lighting=l,this.debugFrame=c,this.gameSpeed=h,this.selectionModel=u,this.useSpriteBatching=d,this.useMeshInstancing=g,this.pipOverlay=p,this.worldSound=m,this.crashingSequencePlaying=!1,this.deathAnimSequencePlaying=!1,this.idleActionDue=!1,this.disguiseChanged=!1,this.highlightAnimRunner=new T.HighlightAnimRunner(this.gameSpeed),this.plugins=[],this.objectArt=e.art,this.label="infantry_"+e.rules.name,this.paletteRemaps=[...this.rules.colors.values()].map((e=>this.palette.clone().remap(e))),this.palette=this.palette.remap(this.gameObject.owner.color),this.withPosition=new i.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1+this.rules.audioVisual.extraInfantryLight)}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach((e=>e.updateLighting?.())),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var e=this.plugins.reduce(((e,t)=>t.getUiNameOverride?.()??e),void 0);return void 0!==e?e:this.gameObject.getUiName()}create3DObject(){let e=this.get3DObject();e||(e=new w.BoxIntersectObject3D(new THREE.Vector3(.5,2/3,.5).multiplyScalar(a.Coords.LEPTONS_PER_TILE)),e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.shpRenderable?.setExtraLight(this.extraLight),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posWrap.add(this.pipOverlay.get3DObject())))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}highlight(){this.plugins.some((e=>e.shouldDisableHighlight?.()))||this.highlightAnimRunner.animation.getState()!==l.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(e){this.plugins.forEach((t=>t.update(e)));var{zone:t,stance:i,isCrashing:r,isMoving:s,isFiring:n,isPanicked:o,owner:c,veteranLevel:h}=this.gameObject;this.pipOverlay?.update(e),this.blobShadow?.update(e),h!==this.lastVeteranLevel&&(h===y.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=h);var m=this.gameObject.tile.z+this.gameObject.tileElevation;void 0!==this.lastElevation&&this.lastElevation===m||(this.lastElevation=m,this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)),this.highlightAnimRunner.shouldUpdate()&&(this.highlightAnimRunner.tick(e),C.ExtraLightHelper.multiplyShp(this.extraLight,this.baseExtraLight,this.highlightAnimRunner.getValue()));var T=this.disguise?.owner??c;this.lastOwnerColor!==T.color&&(this.palette.remap(T.color),(this.shpRenderable??this.placeholder)?.setPalette(this.palette),this.lastOwnerColor=T.color);var v=this.gameObject.warpedOutTrait.isActive(),h=v!==this.lastWarpedOut;if(this.lastWarpedOut=v,m=this.gameObject.cloakableTrait?.isCloaked(),T=m!==this.lastCloaked,this.lastCloaked=m,(h||T)&&(this.shpRenderable??this.placeholder)?.setOpacity(v||m?.5:1),r||void 0!==this.lastZone&&this.lastZone===t||(t===d.ZoneType.Water?this.gameObject.rules.enterWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.enterWaterSound,this.gameObject,c):this.lastZone===d.ZoneType.Water&&this.gameObject.rules.leaveWaterSound&&this.worldSound?.playEffect(this.gameObject.rules.leaveWaterSound,this.gameObject,c),this.blobShadow&&this.shpRenderable?.setShadowVisible(!this.blobShadow.get3DObject().visible)),this.gameObject.isDestroyed&&this.deathPromiseResolve)if(this.deadBodyAnimRenderable){if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deadBodyAnimRenderable.update(e),this.deadBodyAnimRenderable.isAnimFinished())return void this.deathPromiseResolve()}else{if(!this.deathAnimRenderable){if(this.deathAnimSequencePlaying)return this.animRunner&&this.animRunner.animation.getState()!==l.AnimationState.STOPPED?(this.animRunner.tick(e),void this.updateShapeFrame(this.computeFacingNumber(this.gameObject.direction))):void([f.InfDeathType.Gunfire,f.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman&&this.gameObject.zone===d.ZoneType.Ground?this.prepareDeadBodyAnim():this.deathPromiseResolve());if(m=this.sequenceQueue.shift())return this.deathAnimSequencePlaying=!0,void this.setAnimParams(m,e,!1);throw new Error("We should have a death sequence scheduled right now")}if((this.shpRenderable??this.placeholder).get3DObject().visible=!1,this.deathAnimRenderable.update(e),this.deathAnimRenderable.isAnimFinished())return void([f.InfDeathType.Gunfire,f.InfDeathType.Explode].includes(this.gameObject.infDeathType)&&this.gameObject.rules.isHuman?this.prepareDeadBodyAnim():this.deathPromiseResolve())}else{if(this.gameObject.warpedOutTrait.isActive())return;r&&(this.crashingSequencePlaying||(this.crashingSequencePlaying=!0,(b=u.getCrashingSequences(this.gameObject))&&(this.sequenceQueue=b)))}void 0!==this.lastDirection&&this.lastDirection===this.gameObject.direction||(this.lastDirection=this.gameObject.direction,this.computedDirection=this.gameObject.direction);var b=this.idleActionDue;this.idleActionDue=this.gameObject.idleActionTrait.actionDueThisTick();let S=this.idleActionDue&&!b;if(void 0===this.lastMoving||this.lastMoving!==s||void 0===this.lastFiring||this.lastFiring!==n||void 0===this.lastZone||this.lastZone!==t||void 0===this.lastPanicked||this.lastPanicked!==o||this.disguiseChanged){var w=this.disguiseChanged,E=this.lastFiring!==n;if(this.lastMoving=s,this.lastFiring=n,this.lastZone=t,this.lastPanicked=o,this.computedDirection=this.gameObject.direction,this.disguiseChanged=!1,!r&&(this.sequenceQueue=[],!E||n||w)){let r=this.findSequenceBy(t,i,s,n,o);void 0!==r&&(this.disguise&&[p.SequenceType.FireUp,p.SequenceType.FireProne].includes(r)&&(r=p.SequenceType.Ready),this.setAnimParams(r,e,!n))}}if(void 0!==this.lastStance&&this.lastStance===i||(this.sequenceQueue=[],S=!1,E=u.getStanceTransitionSequenceBy(this.lastStance,i),this.lastStance=i,E&&this.objectArt.sequences.has(E)&&this.sequenceQueue.push(E),void 0!==(w=this.findSequenceBy(t,i,s,n,o))&&this.sequenceQueue.push(w),void 0!==this.currentSequenceParams?.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),w=this.sequenceQueue.shift(),this.setAnimParams(w,e,!E),w===p.SequenceType.Paradrop?(w=this.rules.audioVisual.parachute,this.paradropAnim=this.renderableManager.createAnim(w,void 0,!0),this.paradropAnim.remapColor(c.color),this.paradropAnim.create3DObject(),this.paradropAnim.get3DObject().position.y=a.Coords.tileHeightToWorld(1),this.paradropAnim.get3DObject().updateMatrix(),this.posWrap.add(this.paradropAnim.get3DObject())):this.paradropAnim&&(this.paradropAnim.endAnimationLoop(),this.blobShadow&&(this.posWrap.remove(this.blobShadow.get3DObject()),this.blobShadow.dispose(),this.blobShadow=void 0,this.shpRenderable?.setShadowVisible(!0)))),this.paradropAnim&&(this.paradropAnim.update(e),this.paradropAnim.isAnimFinished()&&(this.posWrap.remove(this.paradropAnim.get3DObject()),this.paradropAnim=void 0)),this.sequenceQueue.length||s||n||i!==g.StanceType.None&&i!==g.StanceType.Guard||t===d.ZoneType.Air||!S||(.5<=Math.random()?(c=this.findIdleSequence(t,i,this.objectArt))&&this.setAnimParams(c,e,!1):this.computedDirection=Math.floor(360*Math.random())),this.animRunner){if(this.animRunner.animation.getState()===l.AnimationState.STOPPED&&this.currentSequenceParams){let r;[p.SequenceType.Idle1,p.SequenceType.Idle2].includes(this.currentSequenceParams.type)&&void 0!==this.currentSequenceParams.onlyFacing&&(this.computedDirection=this.directionFromFacingNo(this.currentSequenceParams.onlyFacing)),r=this.sequenceQueue.length?this.sequenceQueue.shift():this.findSequenceBy(t,i,s,n,o),void 0!==r&&this.setAnimParams(r,e,!n)}this.animRunner.tick(e),n=this.computeFacingNumber(this.computedDirection),this.updateShapeFrame(n)}}findIdleSequence(e,t,i){let r=u.getIdleSequenceBy(e,t);if(r?.length&&(r=r.filter((e=>i.sequences.has(e))),r.length||e===d.ZoneType.Ground||(r=u.getIdleSequenceBy(d.ZoneType.Ground,t)?.filter((e=>i.sequences.has(e))))),r)return r[m.getRandomInt(0,r.length-1)]}prepareDeadBodyAnim(){var e=(e=this.rules.audioVisual.deadBodies)[m.getRandomInt(0,e.length-1)];this.deadBodyAnimRenderable=this.renderableManager.createAnim(e,void 0,!0),this.deadBodyAnimRenderable.create3DObject(),this.posWrap.add(this.deadBodyAnimRenderable.get3DObject())}findSequenceBy(e,t,i,r,s){var n=u.findSequence(e,t,i,r,s,[...this.objectArt.sequences.keys()]);if(void 0!==n)return n;console.warn(`Couldn't find a sequence for infantry "${this.gameObject.name}" (moving=${i}, firing=${r})`)}setAnimParams(e,t,i=!0){if(this.animRunner){var r=this.objectArt.sequences.get(e);if(r){this.currentSequenceParams=r;let s=this.animRunner.animation.props;s.loopCount=i?-1:1,s.loopEnd=r.frameCount-1,[p.SequenceType.Deploy,p.SequenceType.Undeploy,p.SequenceType.Paradrop].includes(e)?e===p.SequenceType.Paradrop?s.rate=2*c.AnimProps.defaultRate:s.rate=c.AnimProps.defaultRate:s.rate=c.AnimProps.defaultRate/2,[p.SequenceType.Walk].includes(e)&&(s.rate/=1.33),this.animRunner.animation.start(t)}else console.warn(`Infantry "${this.gameObject.name}" is missing sequence "${p.SequenceType[e]}"`)}}updateShapeFrame(e){var t,i;this.currentSequenceParams&&this.shpRenderable&&this.animRunner&&(({startFrame:t,facingMult:i}=this.currentSequenceParams),(i=t+i*e+this.animRunner.animation.getCurrentFrame())<this.shpRenderable.frameCount&&this.shpRenderable.setFrame(i))}computeFacingNumber(e){return Math.round((e-45+360)%360/360*8)%8}directionFromFacingNo(e){return 45+360*e/8}createObjects(e){if(this.debugFrame.value){let t=s.DebugUtils.createWireframe({width:.5,height:.5},1);t.translateX(-a.Coords.getWorldTileSize()/4),t.translateZ(-a.Coords.getWorldTileSize()/4),e.add(t)}let t=this.posWrap=new THREE.Object3D;t.matrixAutoUpdate=!1,e.add(t);var i=this.createMainObject(this.objectArt);t.add(i),(this.gameObject.rules.movementZone!==b.MovementZone.Fly||this.objectArt.isVoxel)&&this.gameObject.stance!==g.StanceType.Paradrop||(this.blobShadow=new S.BlobShadow(this.gameObject,3,this.useMeshInstancing),this.blobShadow.create3DObject(),this.posWrap.add(this.blobShadow.get3DObject()))}createMainObject(e){let t;try{t=this.imageFinder.findByObjectArt(e)}catch(e){if(!(e instanceof r.ImageFinder.MissingImageError))throw e;console.warn(`<${this.gameObject.name}>: `+e.message)}if(!t)return this.placeholder=new E.DebugRenderable({width:.25,height:.25},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();var i=e.getDrawOffset();let s=this.shpRenderable=n.ShpRenderable.factory(t,this.palette,this.camera,i,e.hasShadow);s.setBatched(this.useSpriteBatching),this.useSpriteBatching&&s.setBatchPalettes(this.paletteRemaps),s.create3DObject();let u=s.get3DObject();return x.MathUtils.translateTowardsCamera(u,this.camera,15*a.Coords.ISO_WORLD_SCALE),u.updateMatrix(),i=new c.AnimProps(new h.IniSection("dummy"),t),i=new l.Animation(i,this.gameSpeed),this.animRunner=new o.SimpleRunner,this.animRunner.animation=i,u}setDisguise(e){this.gameObject.isDestroyed||this.gameObject.isCrashing||(this.objectArt=e?.objectArt??this.gameObject.art,this.updateShpRenderableFromArt(this.objectArt),this.disguiseChanged=!0,this.disguise=e)}updateShpRenderableFromArt(e){var t=(this.shpRenderable??this.placeholder)?.get3DObject();t&&(this.posWrap.remove(t),(this.shpRenderable??this.placeholder)?.dispose()),this.posWrap.add(this.createMainObject(e))}onCreate(e){this.renderableManager=e,this.plugins.forEach((t=>t.onCreate(e))),this.gameObject.rules.ambientSound&&(this.ambientSound=this.worldSound?.playEffect(this.gameObject.rules.ambientSound,this.gameObject))}onRemove(e){if(this.renderableManager=void 0,this.plugins.forEach((t=>t.onRemove(e))),this.ambientSound?.stop(),this.gameObject.isDestroyed&&this.gameObject.deathType!==v.DeathType.Temporal&&this.gameObject.stance!==g.StanceType.Paradrop){var t,i=u.getDeathSequence(this.gameObject,this.gameObject.infDeathType);if(i)1<i.length?(t=i[m.getRandomInt(0,i.length-1)],this.sequenceQueue=[t]):this.sequenceQueue=[i[0]],this.disguise&&(this.objectArt=this.gameObject.art,this.updateShpRenderableFromArt(this.gameObject.art));else{if(!this.gameObject.rules.isHuman)return;if(!(i=u.getDeathAnim(this.rules,this.gameObject.infDeathType)))return;let t=this.art.getAnimation(i);if(this.deathAnimRenderable=e.createAnim(i,void 0,!0),this.deathAnimRenderable.create3DObject(),this.create3DObject(),this.posWrap.add(this.deathAnimRenderable.get3DObject()),t.isFlamingGuy){let e=t.art.clone();e.set("Shadow","yes"),e.set("LoopCount","0"),e.set("Start",String(8*t.runningFrames)),this.deathAnimRenderable.getAnimProps().setArt(e)}}return this.renderableManager=e,new Promise((e=>{this.deathPromiseResolve=()=>{this.renderableManager=void 0,e()}}))}}dispose(){this.plugins.forEach((e=>e.dispose())),this.pipOverlay?.dispose(),this.shpRenderable?.dispose(),this.placeholder?.dispose(),this.deathAnimRenderable?.dispose(),this.deadBodyAnimRenderable?.dispose(),this.paradropAnim?.dispose(),this.blobShadow?.dispose()}})}}})),System.register("engine/renderable/entity/Aircraft",["game/Coords","engine/renderable/WithPosition","engine/gfx/DebugUtils","util/math","game/gameobject/unit/VeteranLevel","engine/renderable/entity/HighlightAnimRunner","engine/Animation","game/gameobject/common/DeathType","game/gameobject/unit/ZoneType","engine/renderable/entity/InvulnerableAnimRunner","engine/renderable/entity/BoxIntersectObject3D","engine/renderable/entity/unit/RotorHelper","engine/renderable/entity/unit/ExtraLightHelper","engine/renderable/DebugRenderable"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){e("Aircraft",class{constructor(e,t,i,r,s,n,a,l,c,h,d,g,p){this.gameObject=e,this.rules=t,this.voxels=i,this.voxelAnims=r,this.palette=s,this.lighting=a,this.debugFrame=l,this.gameSpeed=c,this.selectionModel=h,this.vxlBuilderFactory=d,this.useSpriteBatching=g,this.pipOverlay=p,this.rotorSpeeds=[],this.vxlBuilders=[],this.highlightAnimRunner=new o.HighlightAnimRunner(this.gameSpeed),this.invulnAnimRunner=new u.InvulnerableAnimRunner(this.gameSpeed),this.plugins=[],this.objectRules=e.rules,this.objectArt=e.art,this.label="aircraft_"+this.objectRules.name,this.init()}init(){this.paletteRemaps=[...this.rules.colors.values()].map((e=>this.palette.clone().remap(e))),this.palette.remap(this.gameObject.owner.color),this.lastOwnerColor=this.gameObject.owner.color,this.withPosition=new r.WithPosition,this.updateBaseLight(),this.extraLight=(new THREE.Vector3).copy(this.baseExtraLight)}updateBaseLight(){this.baseExtraLight=(new THREE.Vector3).setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile)+this.rules.audioVisual.extraAircraftLight)}updateLighting(){this.plugins.forEach((e=>e.updateLighting?.())),this.updateBaseLight(),this.extraLight.copy(this.baseExtraLight)}get3DObject(){return this.target}getIntersectTarget(){return this.target}getUiName(){var e=this.plugins.reduce(((e,t)=>t.getUiNameOverride?.()??e),void 0);return void 0!==e?e:this.gameObject.getUiName()}create3DObject(){let e=this.get3DObject();e||(e=new d.BoxIntersectObject3D(new THREE.Vector3(1,1/3,1).multiplyScalar(i.Coords.LEPTONS_PER_TILE*(this.gameObject.rules.spawned?.5:1))),e.name=this.label,e.userData.id=this.gameObject.id,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.vxlBuilders.forEach((e=>e.setExtraLight(this.extraLight))),this.pipOverlay&&(this.pipOverlay.create3DObject(),this.posObj?.add(this.pipOverlay.get3DObject())))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}registerPlugin(e){this.plugins.push(e)}highlight(){this.plugins.some((e=>e.shouldDisableHighlight?.()))||this.highlightAnimRunner.animation.getState()!==l.AnimationState.RUNNING&&this.highlightAnimRunner.animate(2)}update(e){this.plugins.forEach((t=>t.update(e))),this.pipOverlay?.update(e),this.gameObject.veteranLevel!==this.lastVeteranLevel&&(this.gameObject.veteranLevel===a.VeteranLevel.Elite&&void 0!==this.lastVeteranLevel&&this.highlightAnimRunner.animate(30),this.lastVeteranLevel=this.gameObject.veteranLevel);var t=this.highlightAnimRunner.shouldUpdate(),i=this.gameObject.invulnerableTrait.isActive(),r=i!==this.lastInvulnerable;(this.lastInvulnerable=i)&&r&&this.invulnAnimRunner.animate(),this.invulnAnimRunner.shouldUpdate()&&this.invulnAnimRunner.tick(e),(t||r)&&(t&&this.highlightAnimRunner.tick(e),s=i?this.invulnAnimRunner.getValue():0,o=(t?this.highlightAnimRunner.getValue():0)||s,n=this.lighting.getAmbientIntensity(),p.ExtraLightHelper.multiplyVxl(this.extraLight,this.baseExtraLight,n,o));var s=(t=this.gameObject.warpedOutTrait.isActive())!==this.lastWarpedOut;this.lastWarpedOut=t;var n=this.gameObject.cloakableTrait?.isCloaked(),o=n!==this.lastCloaked;if(this.lastCloaked=n,s||o){let e=t||n?.5:1;this.vxlBuilders.forEach((t=>t.setOpacity(e))),this.placeholder?.setOpacity(e)}n=this.gameObject.owner.color,this.lastOwnerColor!==n&&(this.palette.remap(n),this.lastOwnerColor=n,this.vxlBuilders.forEach((e=>e.setPalette(this.palette))),this.placeholder?.setPalette(this.palette)),(n=this.gameObject.zone)!==this.lastZone&&(this.gameObject.rules.missileSpawn&&n===h.ZoneType.Air&&this.lastZone!==h.ZoneType.Air&&this.renderableManager.createTransientAnim("V3TAKOFF",(e=>e.setPosition(this.withPosition.getPosition()))),this.lastZone=n),this.updateVxlRotation()}updateVxlRotation(){var{pitch:e,yaw:t,roll:i}=this.gameObject;this.tiltObj.rotation.z=THREE.Math.degToRad(i),this.tiltObj.rotation.x=THREE.Math.degToRad(e),this.tiltObj.rotation.y=THREE.Math.degToRad(t),this.rotors&&this.rotors.forEach(((e,t)=>{this.rotorSpeeds[t]=g.RotorHelper.computeRotationStep(this.gameObject,this.rotorSpeeds[t]??0,this.objectArt.rotors[t]),this.rotorSpeeds[t]&&(e.rotateOnAxis(this.objectArt.rotors[t].axis,this.rotorSpeeds[t]),e.updateMatrix())}))}createObjects(e){if(this.debugFrame.value){let t=s.DebugUtils.createWireframe({width:1,height:1},1);t.translateX(-i.Coords.getWorldTileSize()/2),t.translateZ(-i.Coords.getWorldTileSize()/2),e.add(t)}let t=this.tiltObj=new THREE.Object3D;t.rotation.order="YXZ";var r=this.createMainObject();t.add(r);let n=this.posObj=new THREE.Object3D;n.matrixAutoUpdate=!1,n.add(t),e.add(n)}createMainObject(){var e=this.objectArt.imageName.toLowerCase(),t=e+".vxl",i=this.voxels.get(t);if(!i)return console.warn(`VXL missing for aircraft ${this.objectRules.name}. Vxl file ${t} not found. `),this.placeholder=new m.DebugRenderable({width:.5,height:.5},this.objectArt.height,this.palette,{centerFoundation:!0}),this.placeholder.setBatched(this.useSpriteBatching),this.useSpriteBatching&&this.placeholder.setBatchPalettes(this.paletteRemaps),this.placeholder.create3DObject(),this.placeholder.get3DObject();t=this.objectArt.noHva?void 0:this.voxelAnims.get(e+".hva"),e=[...this.rules.colors.values()].map((e=>this.palette.clone().remap(e)));let r=this.vxlBuilderFactory.create(i,t,e,this.palette);return this.vxlBuilders.push(r),e=r.build(),this.objectArt.rotors&&(this.rotors=this.objectArt.rotors.map((e=>{var t=r.getSection(e.name);if(!t)throw new Error(`Aircraft "${this.objectRules.name}" VXL section "${e.name}" not found`);return t}))),e}onCreate(e){this.renderableManager=e,this.plugins.forEach((t=>t.onCreate(e)))}onRemove(e){var t;this.renderableManager=void 0,this.plugins.forEach((t=>t.onRemove(e))),this.gameObject.isDestroyed&&this.objectRules.explosion.length&&this.gameObject.deathType!==c.DeathType.Temporal&&this.gameObject.deathType!==c.DeathType.None&&(t=(t=this.objectRules.explosion)[n.getRandomInt(0,t.length-1)],e.createTransientAnim(t,(e=>{let t=this.withPosition.getPosition();this.gameObject.rules.missileSpawn&&(t=t.clone().add(this.gameObject.moveTrait.velocity.clone().setLength(this.rules.general.getMissileRules(this.gameObject.name).bodyLength))),e.setPosition(t)})))}dispose(){this.plugins.forEach((e=>e.dispose())),this.pipOverlay?.dispose(),this.vxlBuilders.forEach((e=>e.dispose())),this.placeholder?.dispose()}})}}})),System.register("engine/renderable/entity/TransientAnim",["engine/renderable/entity/Anim"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.Anim{constructor(e,t,i,r,s,n,a,o,l,c,h){super(e,t,i,r,s,n,a,o,l,void 0,h),this.container=c}update(e){var t;!this.isAnimNotStarted()||(t=this.objectArt.report)&&this.worldSound?.playEffect(t,this.getPosition()),super.update(e),this.isAnimFinished()&&(this.remove(),this.dispose())}remove(){this.container.remove(this)}},e("TransientAnim",r)}}})),System.register("engine/renderable/fx/LaserFx",["three.meshline","game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("LaserFx",class{constructor(e,t,i,r,s,n){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.durationSeconds=s,this.width=n}setContainer(e){this.container=e}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_laser")}update(e){this.firstUpdateMillis||(this.firstUpdateMillis=e),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.durationSeconds)),this.lineMesh.material.uniforms.opacity.value=+this.timeLeft,this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var e=this.sourcePos.clone(),t=this.targetPos.clone();let s=new THREE.Geometry;s.vertices.push(e,t);let n=new i.MeshLine;n.setGeometry(s);var a=this.camera.top;e=this.camera.right/this.camera.top,e=(t=2*a/Math.cos(this.camera.rotation.y))*e,a=new i.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(e,t).multiplyScalar(a*Math.cos(this.camera.rotation.x)/r.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0,blending:THREE.AdditiveBlending});return new THREE.Mesh(n.geometry,a)}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}})),System.register("engine/renderable/fx/TeslaFx",["game/Coords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TeslaFx",class{constructor(e,t,i,r,s){this.sourcePos=e,this.targetPos=t,this.primaryColor=i,this.secondaryColor=r,this.durationSeconds=s,this.bolts=[],this.boltMeshes=[]}setContainer(e){this.container=e}get3DObject(){return this.target}create3DObject(){if(!this.target){this.target=new THREE.Object3D,this.target.name="fx_tesla";var e=this.primaryColor.getHex();[e,e,this.secondaryColor.getHex()].forEach((e=>{try{var{mesh:t,bolt:i}=this.createBolt(e);this.boltMeshes.push(t),this.bolts.push(i),this.target.add(t)}catch(e){console.warn("Couldn't create lightning FX",[e])}}))}}update(e){this.firstUpdateMillis||(this.firstUpdateMillis=e);let t=(e-this.firstUpdateMillis)/1e3;this.timeLeft=Math.max(0,1-t/this.durationSeconds);try{this.bolts.forEach((e=>e.update(t)))}catch(e){console.warn("Couldn't update lightning FX",[e])}this.isFinished()&&(this.container.remove(this),this.dispose())}createBolt(e){var t=this.sourcePos.clone(),r=this.targetPos.clone();t=new THREE.LightningStrike({sourceOffset:t,destOffset:r,radius0:.3*i.Coords.ISO_WORLD_SCALE,radius1:.3*i.Coords.ISO_WORLD_SCALE,isEternal:!0,timeScale:2,propagationTimeFactor:.05,vanishingTimeFactor:.95,ramification:0,roughness:.85,straightness:.7}),r=new THREE.MeshBasicMaterial({color:e});return{mesh:new THREE.Mesh(t,r),bolt:t}}isFinished(){return 0===this.timeLeft}dispose(){this.boltMeshes.forEach((e=>{e.geometry.dispose(),e.material.dispose()}))}})}}})),System.register("engine/renderable/fx/LineTrailFx",["game/art/ObjectArt","game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("LineTrailFx",class{constructor(e,t,i,r,s){this.lazyTarget=e,this.trailColor=t,this.trailDecrement=i,this.gameSpeed=r,this.camera=s,this.trailInitialized=!1}setContainer(e){this.container=e}get3DObject(){return this.placeholderObj}create3DObject(){this.placeholderObj||(this.placeholderObj=new THREE.Object3D,this.placeholderObj.name="fx_linetrail_placeholder")}update(e){var t;void 0!==this.timeLeft&&(t=this.prevUpdateMillis,this.prevUpdateMillis=e,t&&(this.timeLeft=Math.max(0,this.timeLeft-(e-t)/1e3))),this.trailInitialized||(this.trailInitialized=!0,(t=this.createTrail(this.trailColor,this.trailDecrement))?this.trail=t:this.timeLeft=0),this.trail&&(this.trail.advance(),this.lastTargetMatrix=this.trail.targetObject.matrixWorld),this.isFinished()&&(this.container.remove(this),this.dispose())}createTrail(e,t){var s=this.lazyTarget();if(s){let o=new THREE.TrailRenderer(this.container.get3DObject()),l=THREE.TrailRenderer.createBaseMaterial();l.uniforms.headColor.value.set(e.r,e.g,e.b,1),l.uniforms.tailColor.value.set(e.r,e.g,e.b,0);var n=Math.floor(3/this.gameSpeed.value*50/(t/i.ObjectArt.DEFAULT_LINE_TRAIL_DEC)),a=.8*r.Coords.ISO_WORLD_SCALE;let c=new THREE.PlaneGeometry(a,a);return a=(new THREE.Quaternion).setFromEuler(this.camera.rotation),c.applyMatrix((new THREE.Matrix4).makeRotationFromQuaternion(a)),o.initialize(l,n,!1,0,c.vertices,s),o.activate(),o}}isFinished(){return 0===this.timeLeft}requestFinishAndDispose(){this.timeLeft=.8/this.gameSpeed.value}stopTracking(){if(this.trail&&this.lastTargetMatrix){let e=new THREE.Object3D;e.updateMatrixWorld=()=>{},e.matrixWorld=this.lastTargetMatrix,this.trail.targetObject=e}}dispose(){this.trail?.deactivate(),this.trail?.material.dispose(),this.trail?.geometry.dispose()}})}}})),System.register("engine/renderable/fx/SparkFx",["game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){1,r=100,e("SparkFx",class e{constructor(e,t,i,r){this.pos=e,this.color=t,this.spawnDurationSeconds=i,this.gameSpeed=r,this.totalDurationSeconds=i+1}setContainer(e){this.container=e}create3DObject(){var t;this.particleGroup||(e.sparkTex||(e.sparkTex=new THREE.DataTexture(new Uint8Array(4).fill(255),1,1,THREE.RGBAFormat),e.sparkTex.needsUpdate=!0),this.particleGroup=new SPE.Group({texture:{value:e.sparkTex},maxParticleCount:100}),this.particleGroup.mesh.name="fx_spark",this.particleGroup.mesh.frustumCulled=!1,t=this.particleEmitter=new SPE.Emitter({maxAge:{value:1},position:{value:this.pos,spread:new THREE.Vector3(10,0,10).multiplyScalar(i.Coords.ISO_WORLD_SCALE)},acceleration:{value:new THREE.Vector3(0,-50,0).multiplyScalar(i.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(0,0,0)},velocity:{value:new THREE.Vector3(0,30,0).multiplyScalar(i.Coords.ISO_WORLD_SCALE),spread:new THREE.Vector3(40,5,40).multiplyScalar(i.Coords.ISO_WORLD_SCALE)},color:{value:[this.color]},opacity:{value:[1,.5]},size:{value:1},particleCount:r}),this.particleGroup.addEmitter(t))}get3DObject(){return this.particleGroup?.mesh}update(e){var t;this.lastUpdateMillis?(t=e-this.lastUpdateMillis,this.particleGroup.tick(t/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=e,this.particleGroup.tick(0)),this.lastUpdateMillis=e,this.particleEmitter.alive&&e-this.firstUpdateMillis>=1e3*this.spawnDurationSeconds/this.gameSpeed.value&&this.particleEmitter.disable(),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.totalDurationSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}})}}})),System.register("engine/renderable/fx/RadBeamFx",["three.meshline","game/Coords","util/math"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("RadBeamFx",class{constructor(e,t,i,r,s,n){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.durationSeconds=s,this.width=n,this.amplitude=0}setContainer(e){this.container=e}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_radbeam")}update(e){this.firstUpdateMillis||(this.firstUpdateMillis=e),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.durationSeconds));var t=s.truncToDecimals(r.Coords.LEPTONS_PER_TILE/6*(1-this.timeLeft),1);t!==this.amplitude&&(this.amplitude=t,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,t)),this.isFinished()&&(this.container.remove(this),this.dispose())}createObject(){var e=this.sourcePos.clone(),t=this.targetPos.clone(),s=this.createLineGeometry(e,t,this.amplitude),n=this.camera.top;e=this.camera.right/this.camera.top,e=(t=2*n/Math.cos(this.camera.rotation.y))*e,n=new i.MeshLineMaterial({color:this.color.clone(),lineWidth:this.width,resolution:new THREE.Vector2(e,t).multiplyScalar(n*Math.cos(this.camera.rotation.x)/r.Coords.ISO_WORLD_SCALE),transparent:!0,sizeAttenuation:0});return new THREE.Mesh(s,n)}createLineGeometry(e,t,s){let n=[];var a=t.clone().sub(e).length()/r.Coords.LEPTONS_PER_TILE,o=15*a;let l=new THREE.Vector3;for(let i=0;i<=o;i++){var c=i/o;l.lerpVectors(e,t,c),l.y+=s*Math.sin(c*a*(r.Coords.LEPTONS_PER_TILE/Math.PI)),n.push(l.x,l.y,l.z)}let h=new i.MeshLine;return h.setGeometry(n),h.geometry}isFinished(){return 0===this.timeLeft}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}})),System.register("engine/gfx/lighting/LightingFx",["data/map/MapLighting"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Normal=0]="Normal",t[t.High=1]="High",e("LightingFxPriority",r),e("LightingFx",class{constructor(){this.priority=r.Normal,this.mapLighting=new i.MapLighting,this.isRunning=!1}update(e,t){return{done:!0}}})}}})),System.register("engine/gfx/lighting/LightingDirector",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("LightingDirector",class{constructor(e,t,i){this.lighting=e,this.renderer=t,this.gameSpeed=i,this.effects=[],this.onFrame=e=>{if(this.effects.length){let t=!1;this.effects.slice().forEach(((i,r)=>{i.isRunning||(i.isRunning=!0,i.startTime=e,i.mapLighting.copy(this.lighting.getBaseAmbient()));var s=i.update(e,this.gameSpeed.value);s.done&&(this.effects.splice(this.effects.indexOf(i),1),r||(t=!0)),r||s.updated&&this.lighting.applyAmbientOverride(i.mapLighting)})),this.effects.length?t&&this.lighting.applyAmbientOverride(this.effects[0].mapLighting):this.lighting.applyAmbientOverride(void 0)}}}init(){this.renderer.onFrame.subscribe(this.onFrame)}addEffect(e){this.effects.push(e),this.effects.sort(((e,t)=>t.priority-e.priority))}dispose(){this.renderer.onFrame.unsubscribe(this.onFrame)}})}}})),System.register("engine/gfx/lighting/NukeLightingFx",["engine/gfx/lighting/LightingFx"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.LightingFx{constructor(){super(),this.priority=i.LightingFxPriority.High}update(e,t){let i=!1,r=!1;this.initialAmbient??(this.initialAmbient=this.mapLighting.ambient);let s,n=(e-this.startTime)/1e3*t;var a;return 3.3<=n?(n-=3.3,a=Math.min(1,n/.5),s=this.initialAmbient+1.5*(1-a),1===a&&(r=!0)):n<.3&&(a=n/.3,s=this.initialAmbient+1.5*a),void 0!==s&&this.mapLighting.ambient!==s&&(i=!0,this.mapLighting.ambient=s),{done:r,updated:i}}},e("NukeLightingFx",r)}}})),System.register("engine/renderable/entity/Projectile",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","game/gameobject/Projectile","game/Coords","engine/renderable/fx/LaserFx","game/WeaponType","engine/renderable/fx/TeslaFx","game/GameSpeed","engine/renderable/fx/LineTrailFx","engine/renderable/fx/SparkFx","engine/renderable/fx/RadBeamFx","engine/renderable/entity/unit/BlobShadow","engine/gfx/lighting/NukeLightingFx","engine/gfx/batch/BatchedMesh","game/rules/ObjectRules","game/math/geometry","engine/type/PaletteType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){e("Projectile",class e{constructor(e,t,r,s,n,a,o,l,c,h,u,d,g,p,m){var f,y;this.gameObject=e,this.rules=t,this.imageFinder=r,this.voxels=s,this.voxelAnims=n,this.theater=a,this.palette=o,this.specialPalette=l,this.camera=c,this.gameSpeed=h,this.lighting=u,this.lightingDirector=d,this.vxlBuilderFactory=g,this.useSpriteBatching=p,this.useMeshInstancing=m,this.plugins=[],this.objectArt=e.art,this.label="projectile_"+e.rules.name,this.withPosition=new i.WithPosition,this.extraLight=new THREE.Vector3,this.updateLighting(),this.gameObject.rules.firersPalette&&(f=(y=this.gameObject.fromObject)?.art.paletteType??T.PaletteType.Unit,y=y?.art.customPaletteName,this.palette=this.theater.getPalette(f,y),this.gameObject.art.remapable&&(this.palette=this.palette.clone(),this.palette.remap(this.gameObject.fromPlayer.color))),this.gameObject.rules.firersPalette&&this.objectArt.remapable?this.paletteRemaps=[...this.rules.colors.values()].map((e=>this.palette.clone().remap(e))):this.paletteRemaps=[this.palette]}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach((e=>e.updateLighting?.())),this.objectArt.isVoxel?this.extraLight.setScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)):this.extraLight.copy(this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)).addScalar(-1)}getIntersectTarget(){}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(e,t){if(this.plugins.forEach((t=>t.update(e))),0<t&&!this.gameObject.isDestroyed){var i=this.gameObject.velocity.clone().multiplyScalar(t).add(this.gameObject.position.worldPosition);this.setPosition(i)}this.blobShadow?.update(e,t);var r=this.gameObject.direction;!this.vxlRotWrapper&&void 0!==this.lastDirection&&this.lastDirection===r||(this.shpRenderable&&2<this.shpRenderable.frameCount?(this.lastDirection=r,this.updateShapeFrame(r)):this.vxlRotWrapper?(i=y.quaternionFromVec3(this.gameObject.velocity.clone().negate()),this.vxlRotWrapper.rotation.setFromQuaternion(i,"YXZ"),this.gameObject.rules.vertical&&(this.vxlRotWrapper.rotation.y=THREE.Math.degToRad(180+r)),this.vxlRotWrapper.updateMatrix()):this.sonicWaveMesh&&(this.sonicWaveMesh.rotation.y=THREE.Math.degToRad(r),this.sonicWaveMesh.updateMatrix())),this.gameObject.state!==this.lastState&&(this.lastState=this.gameObject.state,this.gameObject.state===s.ProjectileState.Impact&&(this.target.visible=!1,this.renderableManager.createTransientAnim(this.gameObject.impactAnim,(e=>{e.setPosition(this.withPosition.getPosition())})),this.gameObject.isNuke&&this.lightingDirector.addEffect(new p.NukeLightingFx)))}updateShapeFrame(e){let t=0;this.objectArt.rotates&&(t=Math.round((e-45+360)%360/360*32)%32),this.shpRenderable.setFrame(t)}createObjects(t){if(this.gameObject.fromWeapon.rules.isSonic){e.sonicWaveGeometry??(e.sonicWaveGeometry=this.createSonicWaveGeometry()),e.sonicWaveMaterial??(e.sonicWaveMaterial=new THREE.MeshBasicMaterial({color:48340,blending:THREE.CustomBlending,blendEquation:THREE.AddEquation,blendSrc:THREE.DstColorFactor,blendDst:THREE.OneFactor,transparent:!0,opacity:.25,alphaTest:.01,depthTest:!1,depthWrite:!1}));let i=new(this.useMeshInstancing?m.BatchedMesh:THREE.Mesh)(e.sonicWaveGeometry,e.sonicWaveMaterial);return i.rotation.order="YXZ",i.rotation.x=-Math.PI/2,i.rotation.y=THREE.Math.degToRad(this.gameObject.direction),i.updateMatrix(),i.matrixAutoUpdate=!1,t.add(i),void(this.sonicWaveMesh=i)}if(!this.gameObject.rules.inviso&&this.gameObject.rules.imageName!==f.ObjectRules.IMAGE_NONE){if(this.gameObject.art.isVoxel){var i=this.objectArt.imageName.toLowerCase(),s=i+".vxl",n=this.voxels.get(s);if(!n)throw new Error(`VXL missing for projectile ${this.gameObject.rules.name}. Vxl file ${s} not found. `);var a=this.objectArt.noHva?void 0:this.voxelAnims.get(i+".hva");let e=this.vxlBuilder=this.vxlBuilderFactory.create(n,a,this.paletteRemaps,this.palette);e.setExtraLight(this.extraLight),s=e.build();let r=this.vxlRotWrapper=new THREE.Object3D;r.rotation.order="YXZ",r.matrixAutoUpdate=!1,r.add(s),t.add(r)}else{i=this.imageFinder.findByObjectArt(this.objectArt),n=this.objectArt.getDrawOffset(),a=this.gameObject.rules.arcing,s=this.gameObject.rules.shadow&&!a&&1<i.numImages;let e=r.ShpRenderable.factory(i,this.palette,this.camera,n,s);e.setBatched(this.useSpriteBatching),this.useSpriteBatching&&e.setBatchPalettes(this.paletteRemaps),e.setExtraLight(this.extraLight),e.create3DObject(),this.shpRenderable=e,t.add(e.get3DObject()),a&&(this.blobShadow=new g.BlobShadow(this.gameObject,1.5,this.useMeshInstancing),this.blobShadow.create3DObject(),t.add(this.blobShadow.get3DObject()))}this.gameObject.fromWeapon.type===o.WeaponType.DeathWeapon&&(t.visible=!1)}}createSonicWaveGeometry(){let e=new THREE.PlaneBufferGeometry(n.Coords.LEPTONS_PER_TILE,n.Coords.LEPTONS_PER_TILE/3,10,10),t=e.getAttribute("position");for(let e=0;e<t.count;e++)t.setY(e,t.getY(e)+Math.cos(t.getX(e)*Math.PI/n.Coords.LEPTONS_PER_TILE)*n.Coords.ISO_WORLD_SCALE);return e}onCreate(e){this.renderableManager=e,this.plugins.forEach((t=>t.onCreate(e)));var t=this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===o.WeaponType.Secondary;let i;i=this.gameObject.fromObject?this.gameObject.fromWeapon.type===o.WeaponType.Primary||this.gameObject.fromWeapon.type===o.WeaponType.DeathWeapon||t?this.gameObject.fromObject.art.primaryFirePixelOffset:this.gameObject.fromObject.art.secondaryFirePixelOffset:[];var r,s;t=this.gameObject.fromWeapon.rules;if(this.gameObject.fromWeapon.type!==o.WeaponType.DeathWeapon&&!t.limboLaunch){let t;(g=this.gameObject.fromWeapon.rules.anim).length?t=1===g.length?g[0]:(p=this.gameObject.direction,g[Math.round((45-p+360)%360/360*8)%8]):this.gameObject.fromWeapon.warhead.rules.nukeMaker&&(t=this.rules.audioVisual.nukeTakeOff),t&&e.createTransientAnim(t,(e=>{e.setPosition(this.gameObject.position.worldPosition),i.length&&(e.extraOffset={x:i[0],y:-i[1]/2})}))}if(t.isLaser){let r=this.gameObject.position.worldPosition.clone(),s=new THREE.Vector3;i.length&&(m=n.Coords.screenDistanceToWorld(i[0],0),s.x=4*m.x,s.z=4*m.y,s.y=4*n.Coords.tileHeightToWorld(-i[1]/(n.Coords.ISO_TILE_SIZE/2)));let l=this.gameObject.target.getWorldCoords().clone();this.gameObject.fromObject?.name===this.rules.general.prism.type&&this.gameObject.fromWeapon.type===o.WeaponType.Secondary&&(s.y+=this.gameObject.fromObject.art.primaryFireFlh.vertical,l.add(s)),r.add(s);var g=new THREE.Color(t.isHouseColor?this.gameObject.fromPlayer.color.asHex():16711680),p=t.laserDuration/c.GameSpeed.BASE_TICKS_PER_SECOND/this.gameSpeed.value,m=2*(1<this.gameObject.baseDamageMultiplier?2:1);m=new a.LaserFx(this.camera,r,l,g,p,m);e.addEffect(m)}if(t.isElectricBolt){let i=this.gameObject.position.worldPosition.clone();this.gameObject.fromObject?.isBuilding()&&(i.y+=n.Coords.tileHeightToWorld(1)),m=this.gameObject.target.getWorldCoords();let r=this.specialPalette;var f=new THREE.Color(r.getColorAsHex(t.isAlternateColor?5:10)),y=new THREE.Color(r.getColorAsHex(15)),T=1/this.gameSpeed.value;f=new l.TeslaFx(i,m,f,y,T);e.addEffect(f)}t.isRadBeam&&(y=this.gameObject.position.worldPosition.clone(),T=this.gameObject.target.getWorldCoords().clone(),f=this.gameObject.fromWeapon.warhead.rules.temporal?new THREE.Color(...this.rules.audioVisual.chronoBeamColor.map((e=>e/255))):new THREE.Color(...this.rules.radiation.radColor.map((e=>e/255))),r=1/this.gameSpeed.value,r=new d.RadBeamFx(this.camera,y,T,f,r,1),e.addEffect(r)),this.objectArt.useLineTrail&&(r=(new THREE.Color).fromArray(this.objectArt.lineTrailColor.map((e=>e/255))),s=this.objectArt.lineTrailColorDecrement,s=new h.LineTrailFx((()=>this.target),r,s,this.gameSpeed,this.camera),e.addEffect(s),this.lineTrailFx=s),t.useSparkParticles&&(s=this.gameObject.position.worldPosition.clone(),t=20/c.GameSpeed.BASE_TICKS_PER_SECOND,t=new u.SparkFx(s,new THREE.Color(1,1,1),t,this.gameSpeed),e.addEffect(t))}onRemove(e){this.renderableManager=void 0,this.plugins.forEach((t=>t.onRemove(e))),this.gameObject.overshootTiles&&this.lineTrailFx?.stopTracking(),this.lineTrailFx?.requestFinishAndDispose()}dispose(){this.plugins.forEach((e=>e.dispose())),this.shpRenderable?.dispose(),this.vxlBuilder?.dispose(),this.blobShadow?.dispose()}})}}})),System.register("engine/gfx/drawable/TmpDrawable",["data/Bitmap"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TmpDrawable",class{drawTileBlock(e,t,i,r,s,n){let a=t.data;var o=r/2;let l=i/2-2+t.width*n+s;var c=t.width*t.height;let h=0,u=0,d=0;for(;u<o;u++){d+=4;for(let t=0;t<d;t++){var g=e.tileData[h];0!==g&&0<=l&&l<c&&(a[l]=g),l++,h++}l+=t.width-(d+2)}for(l+=4;u<r;u++){d-=4;for(let t=0;t<d;t++){var p=e.tileData[h];0<=l&&l<c&&(a[l]=p),l+=1,h++}l+=t.width-(d-2)}}draw(e,t,r){let s=t,n=r,a=0,o=0;e.hasExtraData&&(a+=Math.max(0,e.x-e.extraX),o+=Math.max(0,e.y-e.extraY),s+=Math.max(0,e.x-e.extraX),n+=Math.max(0,e.y-e.extraY));var l=new i.IndexedBitmap(s,n);return this.drawTileBlock(e,l,t,r,a,o),e.hasExtraData&&this.drawExtraData(e,l),l}drawExtraData(e,t){if(e.hasExtraData){let l=t.data;var i=t.width,r=t.height,s=Math.max(0,e.extraX-e.x),n=i,a=i*r;let c=0+n*Math.max(0,e.extraY-e.y)+s,h=0;for(let t=0;t<e.extraHeight;t++){for(let t=0;t<e.extraWidth;t++){var o=e.extraData[h];0!==o&&0<=c&&c<a&&(l[c]=o),c+=1,h++}c+=n-e.extraWidth}}}})}}})),System.register("engine/renderable/entity/map/MapTileLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/drawable/TmpDrawable","engine/gfx/TextureAtlas","engine/gfx/SpriteUtils","engine/renderable/entity/Anim","engine/type/LightingType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("MapTileLayer",class{constructor(e,t,i,r,s,n,a,o,l,h){this.theater=t,this.art=i,this.imageFinder=r,this.camera=s,this.debugFrame=n,this.gameSpeed=a,this.worldSound=o,this.lighting=l,this.useSpriteBatching=h,this.tileIndexes=new Map,this.tileAnimLightMultsByTile=new Map,this.disposables=new c.CompositeDisposable,this.theater=t,this.camera=s,this.allTiles=e.tiles.getAll()}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="map_tile_layer",e.matrixAutoUpdate=!1,this.target=e,this.createTileObjects(e))}createTileObjects(e){let t=new Map,c=new Map;var g,p=this.theater.isoPalette,m=r.TextureUtils.textureFromPalette(p);let f=this.theater.tileSets;for(g of this.allTiles){var y=g.tileNum;let e=f.getTile(y);if(!e)return;var T=e.getTmpFile(g.subTile,d.getRandomInt);if(!T||g.subTile>=T.images.length)return;var v=T.images[g.subTile];c.set(g,v),(y=t.get(v))||(y=(new s.TmpDrawable).draw(v,T.blockWidth,T.blockHeight),t.set(v,y))}let b=new n.TextureAtlas,S=[];t.forEach((e=>{S.push(e)})),b.pack(S),this.disposables.add(b);let w=[],C=[];for(let e=0,r=this.allTiles.length;e<r;e++){var E,x=this.allTiles[e];if(!(E=c.get(x)))throw new Error(`Missing tmp image for tile rx,ry=${x.rx},`+x.ry);let r=0,s=0;E.hasExtraData&&(r+=Math.max(0,E.x-E.extraX),s+=Math.max(0,E.y-E.extraY));var O=i.Coords.tile3dToWorld(x.rx,x.ry,x.z),A=t.get(E);let n=a.SpriteUtils.createSpriteGeometry({texture:b.getTexture(),textureArea:b.getImageRect(A),align:{x:0,y:-1},offset:{x:-r,y:-s},camera:this.camera,scale:i.Coords.ISO_WORLD_SCALE});n.applyMatrix((new THREE.Matrix4).makeTranslation(O.x,O.y,O.z)),w.push(n);var{x:E,y:A,z:O}=this.lighting.compute(l.LightingType.Full,x);C.push(E,A,O),this.tileIndexes.set(x,e)}var M=new u.PaletteBasicMaterial({map:b.getTexture(),palette:m,alphaTest:.5,flatShading:!0,useVertexColorMult:!0});let R=h.BufferGeometryUtils.mergeBufferGeometries(w);if((m=R.getAttribute("position").count)!==a.SpriteUtils.VERTICES_PER_SPRITE*C.length/3)throw new Error("Vertex count mismatch");m=new Float32Array(4*m),this.updateColorMultBuffer(C,m);var P;m=new THREE.BufferAttribute(m,4);R.addAttribute("vertexColorMult",m),this.colorMultAttribute=m,w.forEach((e=>e.dispose()));let I=new THREE.Mesh(R,M);I.matrixAutoUpdate=!1,I.frustumCulled=!1,e.add(I),this.disposables.add(R,M);let k=[];for(P of this.allTiles){var B=P.tileNum;let t=f.getTile(B);if(!t)return;var j=t.getAnimation();if(j&&P.subTile===j.subTile){B=this.lighting.compute(l.LightingType.Full,P).addScalar(-1),this.tileAnimLightMultsByTile.set(P,B);let t=new o.Anim(j.name,this.art.getAnimation(j.name),{x:j.offsetX,y:j.offsetY+(i.Coords.ISO_TILE_SIZE+1)/2},this.imageFinder,this.theater,this.camera,this.debugFrame,this.gameSpeed,this.useSpriteBatching,B,this.worldSound,p);B=i.Coords.tile3dToWorld(P.rx,P.ry,P.z),t.setPosition(B),t.create3DObject(),k.push(t),e.add(t.get3DObject()),this.disposables.add(t)}}this.anims=k}update(e){for(var t of this.anims)t.update(e)}updateLighting(e){if(e){for(var t of e){var i,r,s,n=this.tileIndexes.get(t);void 0!==n&&(({x:i,y:r,z:s}=this.lighting.compute(l.LightingType.Full,t)),this.updateColorMultBufferAtIndex(n,i,r,s,this.colorMultAttribute.array)),this.tileAnimLightMultsByTile.get(t)?.copy(this.lighting.compute(l.LightingType.Full,t))}this.colorMultAttribute.needsUpdate=!0}else{let e=[];for(var a of this.allTiles){var{x:o,y:c,z:a}=this.lighting.compute(l.LightingType.Full,a);e.push(o,c,a)}this.updateColorMultBuffer(e,this.colorMultAttribute.array),this.colorMultAttribute.needsUpdate=!0,this.tileAnimLightMultsByTile.forEach(((e,t)=>{e.copy(this.lighting.compute(l.LightingType.Full,t))}))}}updateColorMultBuffer(e,t){var i=a.SpriteUtils.VERTICES_PER_SPRITE,r=e.length/3;let s=0;for(let a=0;a<r;a++){var n=e[3*a],o=e[3*a+1],l=e[3*a+2];for(let e=0;e<i;e++)t[s++]=n,t[s++]=o,t[s++]=l,t[s++]=1}}updateColorMultBufferAtIndex(e,t,i,r,s){var n=a.SpriteUtils.VERTICES_PER_SPRITE;let o=e*n*4;for(let e=0;e<n;e++)s[o++]=t,s[o++]=i,s[o++]=r,s[o++]=1}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/entity/map/MapTileLayerDebug",["game/Coords","game/theater/rampHeights","engine/gfx/SpriteUtils","game/type/SpeedType","util/disposable/CompositeDisposable","engine/gfx/BufferGeometryUtils","engine/IsoCoords"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("MapTileLayerDebug",class e{constructor(e,t,i){this._textureTilesNo=20,this.visible=!0,this.needsLinesUpdate=!1,this.disposables=new a.CompositeDisposable,this.handleTileOccupationChanged=()=>this.needsLinesUpdate=!0,this.map=e,this.theater=t,this.camera=i}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();if(!e){if(e=new THREE.Object3D,e.name="map_tile_layer_debug",e.visible=this.visible,e.matrixAutoUpdate=!1,this.visible){if(!this.tileOverlay){let t=this.tileOverlay=this.createTileOverlay();t.matrixAutoUpdate=!1,t.frustumCulled=!1,e.add(t)}this.setupLines(e)}this.target=e}}update(){this.needsLinesUpdate&&this.visible&&(this.needsLinesUpdate=!1,this.destroyLines(),this.setupLines(this.target))}setVisible(e){if(e!==this.visible&&(this.visible=e,this.target))if(this.target.visible=e,this.visible){if(!this.tileOverlay){let e=this.tileOverlay=this.createTileOverlay();e.matrixAutoUpdate=!1,this.target.add(e)}this.setupLines(this.target)}else this.destroyLines()}setupLines(e){this.lines=new THREE.Object3D,this.lines.matrixAutoUpdate=!1,this.lines.add(this.createConnectivityLines(n.SpeedType.Foot,65280));let t=this.createConnectivityLines(n.SpeedType.Float,255);t.position.y=1,t.updateMatrix(),this.lines.add(t),e.add(this.lines),this.map.tileOccupation.onChange.subscribe(this.handleTileOccupationChanged)}destroyLines(){this.lines&&(this.target.remove(this.lines),this.lines=void 0,this.map.tileOccupation.onChange.unsubscribe(this.handleTileOccupationChanged))}createTileOverlay(){let e=[];this.map.tiles.forEach((t=>{var r=i.Coords.tile3dToWorld(t.rx,t.ry,t.z+1),n=l.IsoCoords.getScreenTileSize();let a=s.SpriteUtils.createSpriteGeometry({texture:this.getTileTexture(),textureArea:{x:t.z*n.width,y:2*t.rampType*n.height,width:n.width,height:2*n.height},align:{x:0,y:-1},camera:this.camera,scale:i.Coords.ISO_WORLD_SCALE});a.applyMatrix((new THREE.Matrix4).makeTranslation(r.x,r.y,r.z)),e.push(a)}));var t=o.BufferGeometryUtils.mergeBufferGeometries(e),r=new THREE.MeshBasicMaterial({map:this.getTileTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0});return this.disposables.add(t,r),new THREE.Mesh(t,r)}getTileTexture(){let t=e.textureCache;if(!t){var s=l.IsoCoords.getScreenTileSize(),n=this._textureTilesNo;let d=document.createElement("canvas"),g=d.getContext("2d");if(!g)throw new Error("Could not acquire canvas 2d context");d.width=s.width*n,d.height=2*s.height*r.rampHeights.length;let p=l.IsoCoords.tileToScreen(0,0);p.x+=-s.width/2;var a=i.Coords.ISO_TILE_SIZE/2;for(let e=0;e<n;++e)for(let t=0;t<r.rampHeights.length;++t){var o=r.rampHeights[t],c=[[0,1],[0,0],[1,0],[1,1]];let i=16711680-(e<<11)-(e<<7);g.beginPath();var h=l.IsoCoords.tileToScreen.apply(this,c[0]);g.moveTo(-p.x+h.x+e*s.width,-p.y+h.y+(1-o[0])*a+2*t*s.height);for(let i=1;i<c.length;++i){var u=l.IsoCoords.tileToScreen.apply(this,c[i]);g.lineTo(-p.x+u.x+e*s.width,-p.y+u.y+(1-o[i])*a+2*t*s.height)}g.closePath(),g.lineWidth=1,g.fillStyle="#"+i.toString(16),g.fill(),g.strokeStyle="#"+(16777215-i).toString(16),g.stroke()}t=new THREE.Texture(d),t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t.needsUpdate=!0,e.textureCache=t}return t}createConnectivityLines(e,t){let r=this.map.terrain.computePassabilityGraph(e),s=new THREE.Geometry;r.forEachLink((e=>{var t=r.getNode(e.fromId),n=r.getNode(e.toId);s.vertices.push(i.Coords.tile3dToWorld(t.data.tile.rx+.5,t.data.tile.ry+.5,t.data.tile.z+(t.data.onBridge?.tileElevation??0)),i.Coords.tile3dToWorld(n.data.tile.rx+.5,n.data.tile.ry+.5,n.data.tile.z+(n.data.onBridge?.tileElevation??0)))}));var n=new THREE.LineBasicMaterial({color:t,transparent:!0,depthTest:!1,depthWrite:!1});let a=new THREE.LineSegments(s,n);return a.matrixAutoUpdate=!1,this.disposables.add(s,n),a}onRemove(){this.lines&&this.destroyLines()}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/WithVisibility",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("WithVisibility",class{constructor(){this.visible=!0}setVisible(e){this.visible=e,this.updateVisibility()}isVisible(){return this.visible}updateVisibility(){if(this.target){let e=this.target.get3DObject();e&&(e.visible=this.visible)}}applyTo(e){this.target=e,this.updateVisibility()}})}}})),System.register("engine/renderable/entity/map/MapBounds",["engine/IsoCoords","engine/renderable/WithVisibility","util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("MapBounds",class{constructor(e){this.map=e,this.withVisibility=new r.WithVisibility,this.disposables=new s.CompositeDisposable;let t=()=>{this.target&&this.wrapperObj&&(this.target.remove(this.wrapperObj),this.wrapperObj=this.build(),this.target.add(this.wrapperObj))};e.mapBounds.onLocalResize.subscribe(t),this.disposables.add((()=>e.mapBounds.onLocalResize.unsubscribe(t)))}build(){var e=this.map.mapBounds.getClampedFullSize(),t=this.map.mapBounds.getLocalSize();let i=this.createBoundRect({x:e.x,y:e.y},{x:e.x+e.width,y:e.y+e.height},16711680);i.matrixAutoUpdate=!1;let r=this.createBoundRect({x:t.x,y:t.y},{x:t.x+t.width,y:t.y+t.height-1},255);r.matrixAutoUpdate=!1;let s=new THREE.Object3D;return s.matrixAutoUpdate=!1,s.add(i),s.add(r),s}createBoundRect(e,t,r){var s=i.IsoCoords.screenTileToWorld(e.x,e.y),n=i.IsoCoords.screenTileToWorld(t.x,t.y),a=i.IsoCoords.screenTileToWorld(t.x,e.y),o=i.IsoCoords.screenTileToWorld(e.x,t.y),l=new THREE.LineBasicMaterial({color:r,transparent:!0,depthTest:!1,depthWrite:!1});let c=new THREE.Geometry;c.vertices.push(new THREE.Vector3(s.x,0,s.y),new THREE.Vector3(o.x,0,o.y),new THREE.Vector3(n.x,0,n.y),new THREE.Vector3(a.x,0,a.y),new THREE.Vector3(s.x,0,s.y)),this.disposables.add(c,l);let h=new THREE.Line(c,l);return h.renderOrder=1e6,h}get3DObject(){return this.target}create3DObject(){if(!this.target){let e=new THREE.Object3D;e.matrixAutoUpdate=!1,e.name="map_bounds",e.visible=this.withVisibility.isVisible(),this.target=e,!this.wrapperObj&&e.visible&&(this.wrapperObj=this.build(),this.target.add(this.wrapperObj))}}update(){}setVisible(e){e!==this.withVisibility.isVisible()&&(this.withVisibility.setVisible(e),this.target&&((this.target.visible=e)?(this.wrapperObj||(this.wrapperObj=this.build()),this.target.add(this.wrapperObj)):this.wrapperObj&&this.target.remove(this.wrapperObj)))}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/entity/map/MapShroudLayer",["game/Coords","engine/gfx/TextureUtils","engine/gfx/SpriteUtils","util/disposable/CompositeDisposable","engine/renderable/builder/ShpTextureAtlas","data/Palette","util/Color","game/map/MapShroud","engine/gfx/BufferGeometryUtils","engine/gfx/material/PaletteBasicMaterial"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=[[1,32],[4,33],[8,34],[2,35],[5,36],[12,37],[10,38],[3,39],[13,40],[14,41],[11,42],[7,43],[9,44],[6,45],[15,46]].reduce(((e,t)=>(e[t[0]]=t[1],e)),new Array(16).fill(void 0)),g=[[24,16],[34,17],[50,18],[65,19],[97,20],[132,21],[152,22],[196,23],[18,24],[33,25],[68,26],[136,27],[26,28],[35,29],[69,30],[140,31]].reduce(((e,t)=>(e[t[0]]=t[1],e)),new Array(256).fill(void 0)),p=[0,5,12,13,10,15,14,15,3,7,15,15,11,15,15,15],e("MapShroudLayer",class{constructor(e,t,i){this.shroud=e,this.imageFinder=t,this.camera=i,this.disposables=new n.CompositeDisposable,this.needsIncrementalUpdate=[],this.needsFullUpdate=!1,this.onShroudChange=e=>{"incremental"===e.type?this.needsIncrementalUpdate.push(...e.coords):this.needsFullUpdate=e.type},this.camera=i}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name="map_shroud_layer",e.matrixAutoUpdate=!1,this.target=e,this.createTileObjects(e),this.shroud.onChange.subscribe(this.onShroudChange),this.disposables.add((()=>this.shroud.onChange.unsubscribe(this.onShroudChange))))}createTileObjects(e){var t=this.imageFinder.find("shroud",!1);let i=(new a.ShpTextureAtlas).fromShpFile(t);this.disposables.add(i);let n=new o.Palette,c=[new l.Color(0,0,0),new l.Color(0,0,0)];for(let e=0;e<254;e++){var d=Math.min(255,Math.floor(e/125*255));c.push(new l.Color(d,d,d))}n.setColors(c),t=r.TextureUtils.textureFromPalette(n);let g=[],p=0;var m=this.shroud.getSize();for(let e=0;e<m.height;e++)for(let t=0;t<m.width;t++){var f={sx:t,sy:e},y=this.getFrameNo(f);y=this.createTileGeometry(f,i,y);g.push(y),p++}t=new u.PaletteBasicMaterial({map:i.getTexture(),palette:t,alphaTest:.01,flatShading:!0,transparent:!0,depthTest:!1,blending:THREE.MultiplyBlending});let T=h.BufferGeometryUtils.mergeBufferGeometries(g);if(T.getAttribute("position").count!==s.SpriteUtils.VERTICES_PER_SPRITE*p)throw new Error("Vertex count mismatch");this.uvAttribute=T.getAttribute("uv"),this.uvElemsPerPiece=this.uvAttribute.count*this.uvAttribute.itemSize/p,this.uvLookup=new Float32Array(47*this.uvElemsPerPiece);for(let e=0;e<47;e++){let t=s.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(i,e));this.uvLookup.set(t.getAttribute("uv").array,e*this.uvElemsPerPiece)}g.forEach((e=>e.dispose()));let v=new THREE.Mesh(T,t);v.renderOrder=999999,v.matrixAutoUpdate=!1,v.frustumCulled=!1,e.add(v),this.disposables.add(T,t)}createTileGeometry(e,t,r){var{rx:n,ry:a}=this.shroud.shroudCoordsToWorld(e),a=i.Coords.tile3dToWorld(n,a,0);let o=s.SpriteUtils.createSpriteGeometry(this.getTileGeometryOptions(t,r));return o.applyMatrix((new THREE.Matrix4).makeTranslation(a.x,a.y,a.z)),o}getTileGeometryOptions(e,t){return{texture:e.getTexture(),textureArea:e.getTextureArea(t),flat:!0,align:{x:0,y:-1},camera:this.camera,scale:i.Coords.ISO_WORLD_SCALE}}update(e){var t;this.needsFullUpdate&&("cover"===this.needsFullUpdate||"clear"===this.needsFullUpdate?this.toggleAllTiles("cover"===this.needsFullUpdate?c.ShroudType.Unexplored:c.ShroudType.Explored):(this.updateAllTiles(),this.needsIncrementalUpdate=[]),this.uvAttribute.needsUpdate=!0,this.needsFullUpdate=!1),this.needsIncrementalUpdate.length&&(t=this.extendToAdjacentTiles(this.needsIncrementalUpdate),this.updateTiles(t),this.uvAttribute.needsUpdate=!0,this.needsIncrementalUpdate.length=0)}extendToAdjacentTiles(e){let t=new Map;var i,r=this.shroud.getSize();for(i of e)for(let e=-1;e<=1;e++)for(let a=-1;a<=1;a++){var s=i.sx+e,n=i.sy+a;0<=s&&0<=n&&s<r.width&&n<r.height&&t.set(s+"_"+n,{sx:s,sy:n})}return[...t.values()]}updateTiles(e){var t,i=this.shroud.getSize();for(t of e){var r=t.sx+t.sy*i.width;this.updateTilePiece(r,this.getFrameNo(t))}}updateAllTiles(){var e=this.shroud.getSize();for(let r=0;r<e.height;r++)for(let s=0;s<e.width;s++){var t={sx:s,sy:r},i=t.sx+t.sy*e.width;this.updateTilePiece(i,this.getFrameNo(t))}}toggleAllTiles(e){var t=e===c.ShroudType.Unexplored?15:0,i=this.uvLookup.subarray(t*this.uvElemsPerPiece,(1+t)*this.uvElemsPerPiece);let r=this.uvAttribute.array;for(let e=0,s=(t=this.shroud.getSize()).width*t.height;e<s;e++)r.set(i,e*this.uvElemsPerPiece)}updateTilePiece(e,t){this.uvAttribute.array.set(this.uvLookup.subarray(t*this.uvElemsPerPiece,(t+1)*this.uvElemsPerPiece),e*this.uvElemsPerPiece)}getFrameNo(e){if(this.shroud.getShroudTypeByShroudCoords(e)===c.ShroudType.Unexplored)return 15;let t=0;this.hasShroudedNeighbour(e,0,-1)&&(t+=1),this.hasShroudedNeighbour(e,1,0)&&(t+=2),this.hasShroudedNeighbour(e,0,1)&&(t+=4),this.hasShroudedNeighbour(e,-1,0)&&(t+=8);let i=0;for(let t=-1;t<=1;t+=2)for(let r=-1;r<=1;r+=2)this.hasShroudedNeighbour(e,t,r)&&(i+=1<<t+1+(r+1>>1));if(0<i)if(0===t)t=d[i];else{var r=i&~p[t];if(0<r){if(void 0===(r=g[r+(t<<4)]))throw new Error(`Missing mapped corner frame number for cornerValue "${i}",edgeFrameNo=`+t);t=r}}return t}hasShroudedNeighbour({sx:e,sy:t},i,r){return this.shroud.getShroudTypeByShroudCoords({sx:e+i,sy:t+r})===c.ShroudType.Unexplored}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/entity/map/MapRenderable",["engine/renderable/entity/map/MapTileLayer","engine/renderable/entity/map/MapTileLayerDebug","engine/renderable/entity/map/MapSurface","engine/renderable/entity/map/MapBounds","engine/renderable/entity/map/MapShroudLayer","engine/renderable/builder/ShpAggregator","engine/renderable/entity/map/MapSpriteBatchLayer","game/map/BridgeOverlayTypes"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("MapRenderable",class{constructor(e,t,i,r,s,n,a,o,l,c,h,u,d){this.gameObj=e,this.mapShroud=t,this.mapRadiation=i,this.lighting=r,this.theater=s,this.rules=n,this.art=a,this.imageFinder=o,this.camera=l,this.debugWireframe=c,this.gameSpeed=h,this.worldSound=u,this.useSpriteBatching=d,this.lastDebugValue=!1,this.invalidatedRadTiles=new Set,this.radTileLights=new Map,this.handleRadChange=e=>{for(var t of e)this.invalidatedRadTiles.add(t)},this._objects=[],this.init()}get3DObject(){return this.target}getGameObject(){return this.gameObj}init(){var e=this.getGameObject();this.tileLayer=new i.MapTileLayer(e,this.theater,this.art,this.imageFinder,this.camera,this.debugWireframe,this.gameSpeed,this.worldSound,this.lighting,this.useSpriteBatching),this.addObject(this.tileLayer),this.debugLayer=new r.MapTileLayerDebug(e,this.theater,this.camera),this.debugLayer.setVisible(!1),this.addObject(this.debugLayer),this.mapSurface=new s.MapSurface(e,this.theater),this.addObject(this.mapSurface),this.mapBounds=new n.MapBounds(e),this.mapBounds.setVisible(!1),this.mapShroud&&(this.shroudLayer=new a.MapShroudLayer(this.mapShroud,this.imageFinder,this.camera),this.addObject(this.shroudLayer)),this.addObject(this.mapBounds),e=new o.ShpAggregator,this.terrainLayer=new l.MapSpriteBatchLayer("map_terrain_layer",[...this.rules.terrainRules.values()].filter((e=>!e.isAnimated&&this.art.hasObject(e.name,e.type))),(()=>!1),this.theater,this.art,this.imageFinder,this.camera,this.lighting,e),this.addObject(this.terrainLayer),this.overlayLayer=new l.MapSpriteBatchLayer("map_overlay_layer",[...this.rules.overlayRules.values()].filter((e=>this.art.hasObject(e.name,e.type)&&!c.BridgeOverlayTypes.isBridge(this.rules.getOverlayId(e.name)))),(e=>e.rules.wall),this.theater,this.art,this.imageFinder,this.camera,this.lighting,e),this.addObject(this.overlayLayer),this.smudgeLayer=new l.MapSpriteBatchLayer("map_smudge_layer",[...this.rules.smudgeRules.values()].filter((e=>this.art.hasObject(e.name,e.type))),(()=>!1),this.theater,this.art,this.imageFinder,this.camera,this.lighting,e),this.addObject(this.smudgeLayer),this.mapRadiation.onChange.subscribe(this.handleRadChange)}addObject(e){this._objects.push(e)}create3DObject(){let e=this.get3DObject();if(!e){e=new THREE.Object3D,e.name="map",e.matrixAutoUpdate=!1,this.target=e;for(let t=0,i=this._objects.length;t<i;++t)this._objects[t].create3DObject(),e.add(this._objects[t].get3DObject())}}update(e,t){if(this.create3DObject(),this.debugWireframe.value!==this.lastDebugValue&&(this.lastDebugValue=this.debugWireframe.value,this.debugLayer.setVisible(this.debugWireframe.value),this.mapBounds.setVisible(this.debugWireframe.value)),this._objects.forEach((i=>i.update(e,t))),this.invalidatedRadTiles.size){for(var i of this.invalidatedRadTiles){var r,s=this.mapRadiation.getRadLevel(i);s?(r=Math.min(1,s/this.rules.radiation.radLevelMax),this.radTileLights.has(i)&&this.lighting.removeTileLight(i,this.radTileLights.get(i)),s=this.rules.radiation.radColor,r={intensity:this.rules.radiation.radLightFactor*r,red:s[0]/255*r,green:s[1]/255*r,blue:s[2]/255*r},this.lighting.addTileLight(i,r),this.radTileLights.set(i,r)):(this.lighting.removeTileLight(i,this.radTileLights.get(i)),this.radTileLights.delete(i))}this.lighting.forceUpdate([...this.invalidatedRadTiles]),this.invalidatedRadTiles.clear()}}updateLighting(e){this.tileLayer.updateLighting(e),this.terrainLayer.updateLighting(),this.overlayLayer.updateLighting(),this.smudgeLayer.updateLighting()}dispose(){this.mapRadiation.onChange.unsubscribe(this.handleRadChange),this.tileLayer.dispose(),this.debugLayer.dispose(),this.terrainLayer.dispose(),this.overlayLayer.dispose(),this.smudgeLayer.dispose(),this.shroudLayer?.dispose(),this.mapBounds.dispose(),this.mapSurface.dispose()}})}}})),System.register("engine/renderable/entity/plugin/HarvesterPlugin",["game/gameobject/trait/HarvesterTrait","game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("HarvesterPlugin",class{constructor(e,t){this.gameObject=e,this.harvesterTrait=t}onCreate(e){this.renderableManager=e}update(e){if(this.gameObject.warpedOutTrait.isActive())return this.disposeHarvAnim(),void(this.lastHarvesterStatus=void 0);var t;!this.renderableManager||(t=this.harvesterTrait.status)!==this.lastHarvesterStatus&&(this.lastHarvesterStatus=t,this.disposeHarvAnim(),t===i.HarvesterStatus.Harvesting&&(this.harvestAnim=this.renderableManager.createTransientAnim("OREGATH",(e=>{var t=this.gameObject.tile;e.setPosition(r.Coords.tile3dToWorld(t.rx+.5,t.ry+.5,t.z)),e.create3DObject();let i=e.getAnimProps();var s=Math.floor(e.getShpFile().numImages/8);t=(this.gameObject.direction-45+360)%360,t=Math.round(t/360*8)%8*s;i.loopStart=i.start=t,i.loopEnd=t+s-1,i.loopCount=-1}))))}disposeHarvAnim(){this.harvestAnim?.remove(),this.harvestAnim?.dispose(),this.harvestAnim=void 0}onRemove(){this.disposeHarvAnim()}dispose(){this.disposeHarvAnim()}})}}})),System.register("engine/renderable/entity/plugin/MoveSoundFxPlugin",["game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MoveSoundFxPlugin",class{constructor(e,t,i){this.gameObject=e,this.moveSound=t,this.worldSound=i,this.lastMovingOrRotating=!1}onCreate(){}update(){var e;this.gameObject.isDestroyed||this.gameObject.isCrashing||(e=!this.gameObject.warpedOutTrait.isActive()&&!!(!this.gameObject.rules.balloonHover&&this.gameObject.rules.hoverAttack&&this.gameObject.zone===i.ZoneType.Air||this.gameObject.spinVelocity||!this.gameObject.moveTrait.isIdle()&&!this.gameObject.moveTrait.isWaiting()))!==this.lastMovingOrRotating&&((this.lastMovingOrRotating=e)?this.soundHandle&&this.soundHandle.isPlaying()||(this.soundHandle=this.worldSound.playEffect(this.moveSound,this.gameObject,this.gameObject.owner,.35)):this.soundHandle?.isLoop&&(this.soundHandle.stop(),this.soundHandle=void 0))}onRemove(){this.soundHandle?.stop()}dispose(){this.soundHandle?.stop()}})}}})),System.register("engine/renderable/entity/plugin/VehicleDisguisePlugin",["engine/renderable/MapSpriteTranslation","engine/renderable/ShpRenderable","engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("VehicleDisguisePlugin",class{constructor(e,t,i,r,s,n,a,o,l,c,h,u){this.gameObject=e,this.disguiseTrait=t,this.localPlayer=i,this.alliances=r,this.renderable=s,this.art=n,this.imageFinder=a,this.theater=o,this.camera=l,this.lighting=c,this.gameSpeed=h,this.useSpriteBatching=u,this.lastRenderDisguised=!1,this.canSeeThroughDisguise=!1}onCreate(){}update(e){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let i=this.disguiseTrait.isDisguised();var t=i!==this.lastDisguised;if(t&&(this.lastDisguised=i,this.disguisedAt=i?e:void 0),i&&(this.canSeeThroughDisguise=!this.localPlayer||this.alliances.haveSharedIntel(this.localPlayer,this.gameObject.owner)||!!this.localPlayer.sharedDetectDisguiseTrait?.has(this.gameObject)),i&&this.canSeeThroughDisguise&&(i=!this.localPlayer?.sharedDetectDisguiseTrait?.has(this.gameObject)&&Math.floor((e-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3),this.lastRenderDisguised!==i&&(this.lastRenderDisguised=i,this.renderable.mainObj.visible=!i,this.renderable.posObj.visible=!i||this.canSeeThroughDisguise,this.disguiseObj&&(this.disguiseObj.visible=!1),i)){if((t=this.disguiseTrait.getDisguise()).rules.type!==s.ObjectType.Terrain)throw new Error("Unsupported disguise type "+s.ObjectType[t.rules.type]);t=this.art.getObject(t.rules.name,s.ObjectType.Terrain),this.disguiseObj||(this.disguiseObj=this.createDisguiseObj(t),this.renderable.get3DObject().add(this.disguiseObj)),this.disguiseObj.visible=!0,t=this.lighting.compute(t.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.disguiseRenderable.setExtraLight(t)}}}createDisguiseObj(e){let t=new THREE.Object3D;t.matrixAutoUpdate=!1;let s=new i.MapSpriteTranslation(1,1);var{spriteOffset:n,anchorPointWorld:a}=s.compute();t.position.x=a.x,t.position.z=a.y,t.updateMatrix();var o=this.imageFinder.findByObjectArt(e),a=this.theater.getPalette(e.paletteType,e.customPaletteName);let l=r.ShpRenderable.factory(o,a,this.camera,n,e.hasShadow);return l.setBatched(this.useSpriteBatching),this.useSpriteBatching&&l.setBatchPalettes([a]),l.setFrame(0),l.create3DObject(),t.add(l.get3DObject()),this.disguiseRenderable=l,t}updateLighting(){if(this.disguiseObj?.visible&&this.disguiseRenderable){var e=this.disguiseTrait.getDisguise();if(e){if(e.rules.type!==s.ObjectType.Terrain)throw new Error("Unsupported disguise type "+s.ObjectType[e.rules.type]);e=this.art.getObject(e.rules.name,s.ObjectType.Terrain),this.disguiseRenderable.setExtraLight(this.lighting.compute(e.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1))}}}onRemove(){this.disguiseObj&&(this.renderable.get3DObject().remove(this.disguiseObj),this.disguiseObj=void 0)}getUiNameOverride(){if(this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise)return""}shouldDisableHighlight(){return!!this.gameObject.disguiseTrait?.hasTerrainDisguise()&&!this.canSeeThroughDisguise}dispose(){this.disguiseRenderable?.dispose()}})}}})),System.register("engine/renderable/entity/plugin/ChronoSparkleFxPlugin",["game/Coords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ChronoSparkleFxPlugin",class{constructor(e,t){this.gameObject=e,this.sparkleAnimName=t,this.objMoveTrait=e.isUnit()?e.moveTrait:void 0}onCreate(e){this.renderableManager=e}update(){if(!this.gameObject.isDestroyed&&!this.gameObject.isCrashing&&this.renderableManager){var e=this.objMoveTrait?.lastTeleportTick,t=e!==this.lastTeleport;let r=this.gameObject.warpedOutTrait.isActive();(r!==this.lastWarpedOut||t)&&(this.lastTeleport=e,(this.lastWarpedOut=r)||t?(this.chronoSparkleAnim?.endAnimationLoop(),this.chronoSparkleAnim=this.renderableManager.createTransientAnim(this.sparkleAnimName,(e=>{e.extraOffset={x:0,y:i.Coords.ISO_TILE_SIZE/2},e.setPosition(this.gameObject.position.worldPosition.clone()),e.create3DObject(),e.getAnimProps().loopCount=r?-1:1}))):r||this.chronoSparkleAnim?.endAnimationLoop())}}onRemove(){this.renderableManager=void 0,this.chronoSparkleAnim?.endAnimationLoop()}dispose(){}})}}})),System.register("engine/renderable/entity/plugin/TntFxPlugin",["engine/type/ObjectType","engine/sound/SoundKey"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("TntFxPlugin",class{constructor(e,t,i,r,s,n,a,o,l,c){this.gameObject=e,this.tntChargeTrait=t,this.frameDurationTicks=i,this.renderable=r,this.imageFinder=s,this.art=n,this.alliances=a,this.viewer=o,this.worldSound=l,this.animFactory=c,this.lastHasCharge=!1}onCreate(){this.animStepCount=Math.floor(this.imageFinder.findByObjectArt(this.art.getObject("BOMBCURS",i.ObjectType.Animation)).numImages/2)}update(e){if(this.gameObject.isDestroyed||this.gameObject.isCrashing)this.gameObject.rules.leaveRubble&&(this.disposeBombAnim(),this.soundHandle?.stop());else{var t=this.tntChargeTrait.hasCharge(),i=t!==this.lastHasCharge;let n;n=t?(s=1-this.tntChargeTrait.getTicksLeft()/this.tntChargeTrait.getInitialTicks(),Math.floor(2*s*(this.animStepCount-1))):0;var s=n!==this.lastStartFrame;if(this.bombAnim?.update(e),i||s)if(this.lastHasCharge=t,this.lastStartFrame=n,t){if(i&&(this.soundHandle?.stop(),this.soundHandle=this.worldSound?.playEffect(r.SoundKey.BombTickingSound,this.gameObject)),this.disposeBombAnim(),i=this.gameObject.tntChargeTrait.getChargeOwner(),!this.viewer||this.alliances.haveSharedIntel(i,this.viewer)){let e=this.bombAnim=this.animFactory("BOMBCURS");e.setRenderOrder(999995),e.create3DObject();let t=e.getAnimProps();t.loopCount=-1,t.start=t.loopStart=n,t.end=n+2-1,t.loopEnd=t.end,t.rate/=this.frameDurationTicks,this.renderable.get3DObject()?.add(e.get3DObject())}}else this.disposeBombAnim(),this.soundHandle?.stop()}}disposeBombAnim(){this.bombAnim?.get3DObject()&&this.renderable.get3DObject()?.remove(this.bombAnim.get3DObject()),this.bombAnim?.dispose()}onRemove(){this.disposeBombAnim(),this.soundHandle?.stop()}dispose(){this.disposeBombAnim(),this.soundHandle?.stop()}})}}})),System.register("engine/renderable/fx/MindControlLinkFx",["game/Coords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MindControlLinkFx",class{constructor(e,t,i,r){this.sourcePos=e,this.targetPos=t,this.color=i,this.heightTiles=r,this.colorAnimProgress=0}setContainer(e){this.container=e}get3DObject(){return this.lineMesh}create3DObject(){this.lineMesh||(this.lineMesh=this.createObject(),this.lineMesh.name="fx_mclink")}updateEndpoints(e,t){var i=!e.equals(this.sourcePos)||!t.equals(this.targetPos);this.sourcePos=e,this.targetPos=t,i&&this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress))}update(e){this.lastUpdate??(this.lastUpdate=e),this.colorAnimProgress+=(e-this.lastUpdate)/1e3,this.colorAnimProgress-=Math.floor(this.colorAnimProgress),this.lastUpdate=e,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos,this.heightTiles,this.color,this.colorAnimProgress)}createObject(){var e=this.sourcePos,t=this.targetPos;e=this.createLineGeometry(e,t,this.heightTiles,this.color,this.colorAnimProgress),t=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,transparent:!0});let i=new THREE.Line(e,t);return i.renderOrder=1e6,i}createLineGeometry(e,t,r,s,n){var a=new THREE.Color(16777215),o=1.5*n,l=t.clone().sub(e).length()/i.Coords.LEPTONS_PER_TILE,c=Math.floor(15*l);let h=new Float32Array(3*c),u=new Float32Array(3*c),d=new THREE.Vector3;for(let n=0;n<=c;n++){var g=n/c;d.lerpVectors(e,t,g),d.y+=i.Coords.LEPTONS_PER_TILE/4+r*i.Coords.LEPTONS_PER_TILE*Math.sin(g*Math.PI),h[3*n]=d.x,h[3*n+1]=d.y,h[3*n+2]=d.z;let l=s;g<o&&o-.5<=g&&(l=s.clone().lerp(a,(g-(o-.5))/.5)),u[3*n]=l.r,u[3*n+1]=l.g,u[3*n+2]=l.b}let p=new THREE.BufferGeometry;return p.addAttribute("position",new THREE.BufferAttribute(h,3)),p.addAttribute("color",new THREE.BufferAttribute(u,3)),p}removeAndDispose(){this.container.remove(this),this.dispose()}dispose(){this.lineMesh&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose())}})}}})),System.register("engine/renderable/entity/plugin/MindControlLinkPlugin",["engine/renderable/fx/MindControlLinkFx"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MindControlLinkPlugin",class{constructor(e,t,i,r){this.source=e,this.selectionModel=t,this.alliances=i,this.viewer=r,this.links=new Map}onCreate(e){this.renderableManager=e}update(){if(!this.source.isDestroyed&&!this.source.isCrashing&&this.source.mindControllerTrait)if(!this.selectionModel.isSelected()||this.viewer&&!this.alliances.haveSharedIntel(this.source.owner,this.viewer))this.disposeLinks();else{let o=this.source.mindControllerTrait.getTargets();for(var[e,t]of this.links.entries())o.includes(e)||(t.removeAndDispose(),this.links.delete(e));var r,s=new THREE.Color(this.source.owner.color.asHex()),n=this.source.position.worldPosition.clone();for(r of o){var a=r.position.worldPosition.clone();let e=this.links.get(r);e||(e=new i.MindControlLinkFx(n,a,s,2),this.links.set(r,e),this.renderableManager?.addEffect(e)),e.updateEndpoints(n,a)}}}onRemove(){this.renderableManager=void 0,this.disposeLinks()}dispose(){this.disposeLinks()}disposeLinks(){this.links.forEach((e=>e.removeAndDispose())),this.links.clear()}})}}})),System.register("engine/renderable/entity/plugin/InfantryDisguisePlugin",["engine/type/ObjectType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("InfantryDisguisePlugin",class{constructor(e,t,i,r,s,n,a){this.gameObject=e,this.disguiseTrait=t,this.localPlayer=i,this.alliances=r,this.renderable=s,this.art=n,this.gameSpeed=a,this.canSeeThroughDisguise=!1}onCreate(){}update(e){if(!this.gameObject.isDestroyed&&!this.gameObject.warpedOutTrait.isActive()){let r=this.disguiseTrait.getDisguise();var t;r!==this.lastDisguise&&(this.lastDisguise=r,this.disguisedAt=r?e:void 0),r&&(this.canSeeThroughDisguise=!this.localPlayer||this.alliances.haveSharedIntel(this.localPlayer,this.gameObject.owner)||!!this.localPlayer.sharedDetectDisguiseTrait?.has(this.gameObject)),r&&this.canSeeThroughDisguise&&(r=this.localPlayer?.sharedDetectDisguiseTrait?.has(this.gameObject)?void 0:Math.floor((e-this.disguisedAt)*this.gameSpeed.value/1e3)%16<=3?r:void 0),this.lastRenderDisguise!==r&&(this.lastRenderDisguise=r,r?(t=this.art.getObject(r.rules.name,i.ObjectType.Infantry),this.renderable.setDisguise({objectArt:t,owner:r.owner})):this.renderable.setDisguise(void 0))}}onRemove(){}getUiNameOverride(){var e=this.gameObject.disguiseTrait?.getDisguise();if(e&&!this.canSeeThroughDisguise)return e.rules.uiName}dispose(){}})}}})),System.register("engine/renderable/fx/DetectionLineFx",["three.meshline","game/Coords"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=new THREE.Color(16777215),e("DetectionLineFx",n=class e{constructor(e,t,i,r,s){this.camera=e,this.sourcePos=t,this.targetPos=i,this.color=r,this.renderOrder=s,this.needsUpdate=!1,this.cameraHash=this.camera.top+"_"+this.camera.right,this.computedColor=r,this.lineHeadMaterial=new THREE.MeshBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1})}setContainer(e){this.container=e}get3DObject(){return this.wrapper}create3DObject(){this.wrapper||(this.wrapper=new THREE.Object3D,this.wrapper.name="fx_detectionline",this.lineMesh=this.createLineMesh(),this.srcLineHead=this.createLineHead(),this.destLineHead=this.createLineHead(),this.wrapper.add(this.srcLineHead),this.wrapper.add(this.destLineHead),this.wrapper.add(this.lineMesh),this.needsUpdate=!0)}update(e){this.lastUpdateMillis||(this.lastUpdateMillis=e);var t=(e-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=e;var i=this.camera.top+"_"+this.camera.right;i!==this.cameraHash&&(this.cameraHash=i,this.lineMesh.material.uniforms.resolution.value.copy(this.computeResolution(this.camera)));let r=this.lineMesh.material;this.needsUpdate&&(this.needsUpdate=!1,this.lineMesh.geometry.dispose(),this.lineMesh.geometry=this.createLineGeometry(this.sourcePos,this.targetPos),i=this.sourcePos.distanceTo(this.targetPos),r.uniforms.dashArray.value=this.computeDashArray(i),this.srcLineHead.position.copy(this.sourcePos),this.destLineHead.position.copy(this.targetPos)),r.uniforms.dashOffset.value-=r.uniforms.dashArray.value/50*t,t=Math.sin(e%1e3/1e3*Math.PI);let n=this.computedColor.copy(this.color).lerp(s,t);this.lineMesh.material.uniforms.color.value=n.clone(),this.lineHeadMaterial.color.set(n)}createLineMesh(){let e=this.sourcePos.clone();var t=this.targetPos.clone();let i=new THREE.Mesh(this.createLineGeometry(e,t),this.createLineMaterial(this.color.clone(),e.distanceTo(t)));return i.renderOrder=this.renderOrder,i}createLineGeometry(e,t){let r=new THREE.Geometry;r.vertices.push(e,t);let s=new i.MeshLine;return s.setGeometry(r),s.geometry}createLineMaterial(e,t){return new i.MeshLineMaterial({color:e,lineWidth:1,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(t),depthTest:!1})}createLineHead(){let t=new THREE.Mesh(e.lineHeadGeometry,this.lineHeadMaterial);var i=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return t.setRotationFromQuaternion(i),t.renderOrder=this.renderOrder,t}computeDashArray(e){return Math.min(1,5/e)*r.Coords.ISO_WORLD_SCALE}computeResolution(e){var t=e.top,i=e.right/e.top,s=2*t/Math.cos(e.rotation.y);return new THREE.Vector2(s*i,s).multiplyScalar(t*Math.cos(this.camera.rotation.x)/r.Coords.ISO_WORLD_SCALE)}remove(){this.container.remove(this)}dispose(){this.wrapper&&(this.lineMesh.geometry.dispose(),this.lineMesh.material.dispose(),this.lineHeadMaterial.dispose())}}),n.lineHeadGeometry=new THREE.PlaneGeometry(3*r.Coords.ISO_WORLD_SCALE,3*r.Coords.ISO_WORLD_SCALE)}}})),System.register("engine/renderable/entity/building/PsychicDetectPlugin",["engine/renderable/fx/DetectionLineFx"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PsychicDetectPlugin",class{constructor(e,t,i,r){this.gameObject=e,this.psychicDetectorTrait=t,this.localPlayer=i,this.camera=r,this.lineEffects=new Map}onCreate(e){this.renderableManager=e}update(e){if(this.localPlayer===this.gameObject.owner){let e=this.psychicDetectorTrait.detectionLines;var t,r,s,n,a=e!==this.lastDetectionLines;this.lastDetectionLines=e;let d=e.map((e=>({hash:e.source.id+"_"+(e.target.obj?.id??e.target.tile.id),line:e})));if(a){for(let e of this.lineEffects.keys())d.find((({hash:t})=>t===e))||(this.disposeLine(this.lineEffects.get(e)),this.lineEffects.delete(e));for(var{line:o,hash:l}of d)this.lineEffects.has(l)||(t=o.source.position.worldPosition.clone(),r=o.target.getWorldCoords().clone(),o=new THREE.Color(o.source.owner.color.asHex()),o=new i.DetectionLineFx(this.camera,t,r,o,1e6),this.lineEffects.set(l,o),this.renderableManager.addEffect(o))}for({line:s,hash:n}of d){let e=this.lineEffects.get(n);if(!e)throw new Error("Line hash should have been found");var c=s.source.position.worldPosition.clone(),h=s.target.getWorldCoords().clone(),u=new THREE.Color(s.source.owner.color.asHex());e.color.equals(u)||(e.color.copy(u),e.needsUpdate=!0),e.sourcePos.equals(c)||(e.sourcePos.copy(c),e.needsUpdate=!0),e.targetPos.equals(h)||(e.targetPos.copy(h),e.needsUpdate=!0)}}else this.lineEffects.forEach((e=>this.disposeLine(e)))}onRemove(){this.renderableManager=void 0,this.dispose()}dispose(){this.lineEffects.forEach((e=>this.disposeLine(e)))}disposeLine(e){e.remove(),e.dispose()}})}}})),System.register("engine/gfx/ImageUtils",["data/Bitmap","engine/gfx/CanvasUtils"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ImageUtils",class e{static async convertShpToPng(t,i){var s=e.convertShpToCanvas(t,i);return await r.CanvasUtils.canvasToBlob(s)}static convertShpToBitmap(e,t,r=!1){let s=0,n=0,a=e.width,o=e.height;a!==o&&r&&(s=a>o?0:Math.floor((o-a)/2),n=a>o?Math.floor((a-o)/2):0,a=o=Math.max(a,o));let l=new i.IndexedBitmap(e.numImages*a,o);for(let t=0;t<e.numImages;t++){var c=e.getImage(t),h=new i.IndexedBitmap(c.width,c.height,c.imageData);l.drawIndexedImage(h,t*a+c.x+s,c.y+n)}return l}static convertShpToCanvas(e,t,i=!1){var s=this.convertShpToBitmap(e,t,i);return r.CanvasUtils.canvasFromIndexedImageData(s.data,s.width,s.height,t)}})}}})),System.register("engine/renderable/fx/TrailerSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=1e3,e("TrailerSmokeFx",n=class e{constructor(e,t,i,r,s,n){this.pos=e,this.spawnDelayFrames=t,this.smokeArt=i,this.shpFile=r,this.palette=s,this.gameSpeed=n,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1,this.finishProcessed=!1}static clearTextureCache(){this.textureCache.forEach((e=>e.dispose())),this.textureCache.clear()}setContainer(e){this.container=e}create3DObject(){if(!this.particleGroup){let a=e.textureCache.get(this.shpFile);a||(n=r.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),a=new THREE.Texture(n),a.minFilter=THREE.NearestFilter,a.magFilter=THREE.NearestFilter,a.needsUpdate=!0,a.flipY=!0,e.textureCache.set(this.shpFile,a)),this.particleGroup=new SPE.Group({texture:{value:a,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:1e3,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_trailer_smoke",this.particleGroup.mesh.frustumCulled=!1;var t=new i.AnimProps(this.smokeArt.art,this.shpFile),n=(this.smokeArt.art.getBool("Normalized")?2:1)*t.rate/this.spawnDelayFrames;t=this.particleMaxAge=this.shpFile.numImages/t.rate,t=this.particleEmitter=new SPE.Emitter({particleCount:s,maxAge:{value:t},activeMultiplier:n/(s/t),position:{value:this.pos},acceleration:{value:new THREE.Vector3},velocity:{value:new THREE.Vector3},opacity:{value:this.smokeArt.translucent?[1,0]:1-this.smokeArt.translucency},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}});this.particleGroup.addEmitter(t)}}get3DObject(){return this.particleGroup?.mesh}update(e){var t;this.particleEmitter.position.value=this.pos,this.lastUpdateMillis?(t=e-this.lastUpdateMillis,this.particleGroup.tick(t/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=e,this.particleGroup.tick(0)),this.lastUpdateMillis=e,this.finishRequested&&(this.finishRequested=!1,this.finishProcessed||(this.finishProcessed=!0,t=(e-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=t+this.particleMaxAge),this.particleEmitter.alive&&this.particleEmitter.disable()),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}disable(){this.particleEmitter.disable()}enable(){this.particleEmitter.enable()}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),n.textureCache=new Map}}})),System.register("engine/renderable/entity/plugin/TrailerSmokePlugin",["engine/renderable/fx/TrailerSmokeFx"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TrailerSmokePlugin",class{constructor(e,t,i,r,s){this.gameObject=e,this.art=t,this.theater=i,this.imageFinder=r,this.gameSpeed=s}onCreate(e){this.initialPosition=this.gameObject.position.worldPosition.clone(),this.renderableManager=e}update(e){if(this.renderableManager&&!this.trailerFx&&!this.gameObject.position.worldPosition.equals(this.initialPosition)){if(this.gameObject.isAircraft()){let e;this.gameObject.rules.missileSpawn?e=this.art.getAnimation("V3TRAIL"):this.gameObject.isCrashing&&(e=this.art.getAnimation("SGRYSMK1")),e&&(r=this.imageFinder.findByObjectArt(e),s=this.theater.getPalette(e.paletteType),t=this.gameObject.art.spawnDelay,this.trailerFx=new i.TrailerSmokeFx(this.gameObject.position.worldPosition,t,e,r,s,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}var t,r,s,n;!this.gameObject.isProjectile()&&!this.gameObject.isDebris()||(n=this.gameObject.isProjectile()?this.gameObject.art.trailer:this.gameObject.rules.trailerAnim)&&(t=this.art.getAnimation(n),r=this.imageFinder.findByObjectArt(t),s=this.theater.getPalette(t.paletteType),n=this.gameObject.isProjectile()?this.gameObject.art.spawnDelay:this.gameObject.rules.trailerSeparation,this.trailerFx=new i.TrailerSmokeFx(this.gameObject.position.worldPosition,n,t,r,s,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx))}}onRemove(e){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}})),System.register("engine/renderable/fx/DamageSmokeFx",["engine/AnimProps","engine/gfx/ImageUtils"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=1e3,e("DamageSmokeFx",n=class e{constructor(e,t,i,r,s){this.gameObject=e,this.smokeArt=t,this.shpFile=i,this.palette=r,this.gameSpeed=s,this.lifetimeSeconds=Number.POSITIVE_INFINITY,this.finishRequested=!1}static clearTextureCache(){this.textureCache.forEach((e=>e.dispose())),this.textureCache.clear()}setContainer(e){this.container=e}create3DObject(){if(!this.particleGroup){let l=e.textureCache.get(this.shpFile);l||(a=r.ImageUtils.convertShpToCanvas(this.shpFile,this.palette,!0),l=new THREE.Texture(a),l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,l.flipY=!1,e.textureCache.set(this.shpFile,l)),this.particleGroup=new SPE.Group({texture:{value:l,frames:new THREE.Vector2(this.shpFile.numImages,1),frameCount:this.shpFile.numImages,loop:1},maxParticleCount:1e3,hasPerspective:!1,transparent:!0,alphaTest:0,blending:THREE.NormalBlending}),this.particleGroup.mesh.name="fx_damage_smoke",this.particleGroup.mesh.frustumCulled=!1;var t=new i.AnimProps(this.smokeArt.art,this.shpFile),n=(o=(this.smokeArt.art.getBool("Normalized")?2:1)*t.rate)/10,a=this.particleMaxAge=2*this.shpFile.numImages/t.rate,o=(t=9*o,.05*o);t=this.particleEmitter=new SPE.Emitter({particleCount:s,maxAge:{value:a},activeMultiplier:n/(s/a),position:{value:this.computeEmitterPosition()},acceleration:{value:new THREE.Vector3(0,-o,0),spread:new THREE.Vector3(2,0,2)},velocity:{value:new THREE.Vector3(0,t,0),spread:new THREE.Vector3(.1*t,0,.1*t)},opacity:{value:.5},size:{value:Math.max(this.shpFile.height,this.shpFile.width)}});this.particleGroup.addEmitter(t)}}computeEmitterPosition(){return this.gameObject.position.worldPosition.clone().add(this.gameObject.rules.damageSmokeOffset)}get3DObject(){return this.particleGroup?.mesh}update(e){var t;this.particleEmitter.position.value=this.computeEmitterPosition(),this.lastUpdateMillis?(t=e-this.lastUpdateMillis,this.particleGroup.tick(t/1e3*this.gameSpeed.value)):(this.firstUpdateMillis=e,this.particleGroup.tick(0)),this.lastUpdateMillis=e,this.finishRequested&&(this.finishRequested=!1,this.particleEmitter.alive&&(t=(e-this.firstUpdateMillis)/1e3*this.gameSpeed.value,this.lifetimeSeconds=t+this.particleMaxAge,this.particleEmitter.disable())),this.timeLeft=Math.max(0,1-(e-this.firstUpdateMillis)/(1e3*this.lifetimeSeconds/this.gameSpeed.value)),this.timeLeft||(this.container.remove(this),this.dispose())}finishAndRemove(){this.finishRequested=!0}dispose(){this.particleGroup?.mesh.geometry.dispose(),this.particleGroup?.mesh.material.dispose()}}),n.textureCache=new Map}}})),System.register("engine/renderable/entity/plugin/DamageSmokePlugin",["engine/renderable/fx/DamageSmokeFx"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("DamageSmokePlugin",class{constructor(e,t,i,r,s){this.gameObject=e,this.art=t,this.theater=i,this.imageFinder=r,this.gameSpeed=s}onCreate(e){this.renderableManager=e}update(e){var t,r,s;this.renderableManager&&((s=this.gameObject.healthTrait.health<50)===this.lastDamaged||this.gameObject.isDestroyed||((this.lastDamaged=s)?this.smokeFx||(this.smokeStartTime=e,(t=this.art.getAnimation("SGRYSMK1"))&&(r=this.imageFinder.findByObjectArt(t),s=this.theater.getPalette(t.paletteType),this.smokeFx=new i.DamageSmokeFx(this.gameObject,t,r,s,this.gameSpeed),this.renderableManager.addEffect(this.smokeFx))):this.disposeSmokeFx()),this.smokeFx&&this.smokeStartTime&&e-this.smokeStartTime>=8e4/this.gameSpeed.value&&this.disposeSmokeFx())}disposeSmokeFx(){this.smokeFx&&(this.smokeFx.finishAndRemove(),this.smokeFx=void 0)}onRemove(e){this.renderableManager=void 0,this.disposeSmokeFx()}dispose(){this.disposeSmokeFx()}})}}})),System.register("engine/renderable/entity/plugin/ShipWakeTrailPlugin",["game/Coords","engine/renderable/fx/TrailerSmokeFx","game/gameobject/unit/ZoneType","game/type/LandType","game/type/LocomotorType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("ShipWakeTrailPlugin",class{constructor(e,t,i,r,s,n){this.gameObject=e,this.rules=t,this.art=i,this.theater=r,this.imageFinder=s,this.gameSpeed=n,this.trailPos=new THREE.Vector3}onCreate(e){this.renderableManager=e}update(e){var t,o,l,c,h,u;this.renderableManager&&(this.trailPos.copy(this.gameObject.position.worldPosition),this.trailPos.y=i.Coords.tileHeightToWorld(this.gameObject.tile.z),this.gameObject.rules.locomotor===a.LocomotorType.Hover&&(l=this.rules.general.hover.height,this.trailPos.x-=l,this.trailPos.z-=l),t=(c=this.gameObject.moveTrait.isMoving())!==this.lastMoving,o=(h=this.gameObject.submergibleTrait?.isSubmerged())!==this.lastSubmerged,l=(u=this.gameObject.zone===s.ZoneType.Water&&this.gameObject.tile.landType===n.LandType.Water)!==this.lastInWater,(t||o||l)&&(this.lastMoving=c,this.lastSubmerged=h,this.lastInWater=u,c&&!h&&u?this.trailerFx?this.trailerFx.enable():(l=this.art.getAnimation(this.rules.audioVisual.wake))&&(c=this.imageFinder.findByObjectArt(l),h=this.theater.getPalette(l.paletteType),u=this.gameObject.art.spawnDelay,this.trailerFx=new r.TrailerSmokeFx(this.trailPos,u,l,c,h,this.gameSpeed),this.renderableManager.addEffect(this.trailerFx)):this.trailerFx?.disable()))}onRemove(e){this.renderableManager=void 0,this.trailerFx?.finishAndRemove()}dispose(){this.trailerFx?.finishAndRemove()}})}}})),System.register("engine/renderable/entity/plugin/ObjectCloakPlugin",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ObjectCloakPlugin",class{constructor(e,t,i,r){this.gameObject=e,this.localPlayer=t,this.alliances=i,this.renderable=r,this.lastCanSeeThroughCloak=!1}onCreate(){}update(e){var t=!!this.gameObject.cloakableTrait?.isCloaked()&&!this.gameObject.isDestroyed,i=t!==this.lastCloaked,r=t&&(!this.localPlayer||this.alliances.haveSharedIntel(this.localPlayer,this.gameObject.owner)),s=r!==this.lastCanSeeThroughCloak;(i||s)&&(this.lastCloaked=t,this.lastCanSeeThroughCloak=r,this.renderable.get3DObject().visible=!t||r)}onRemove(){}dispose(){}})}}})),System.register("engine/renderable/entity/Debris",["engine/renderable/WithPosition","engine/renderable/ShpRenderable","engine/renderable/MapSpriteTranslation","engine/Animation","engine/AnimProps","engine/animation/SimpleRunner","game/Coords","engine/renderable/ShadowRenderable"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("Debris",class{constructor(e,t,i,r,s,n,a,o,l,c,h){this.gameObject=e,this.rules=t,this.imageFinder=i,this.voxels=r,this.palette=n,this.camera=a,this.lighting=o,this.gameSpeed=l,this.vxlBuilderFactory=c,this.useSpriteBatching=h,this.plugins=[],this.objectRules=e.rules,this.objectArt=e.art,this.label="debris_"+this.objectRules.name,this.init()}init(){this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight=(new THREE.Vector3).copy(this.baseVxlExtraLight),this.shpExtraLight=(new THREE.Vector3).copy(this.baseShpExtraLight),this.withPosition=new i.WithPosition}registerPlugin(e){this.plugins.push(e)}updateLighting(){this.plugins.forEach((e=>e.updateLighting?.())),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight)}get3DObject(){return this.target}create3DObject(){let e=this.get3DObject();e||(e=new THREE.Object3D,e.name=this.label,this.target=e,e.matrixAutoUpdate=!1,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.createObjects(e),this.vxlBuilder?.setExtraLight(this.vxlExtraLight),this.shpRenderable?.setExtraLight(this.shpExtraLight))}setPosition(e){this.withPosition.setPosition(e.x,e.y,e.z)}getPosition(){return this.withPosition.getPosition()}update(e,t=0){this.plugins.forEach((t=>t.update(e)));var i=this.gameObject.tile.z+this.gameObject.tileElevation;if((void 0===this.lastElevation||this.lastElevation!==i)&&(this.lastElevation=i,this.baseVxlExtraLight=(new THREE.Vector3).addScalar(this.lighting.computeNoAmbient(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation)),this.baseShpExtraLight=this.lighting.compute(this.objectArt.lightingType,this.gameObject.tile,this.gameObject.tileElevation).addScalar(-1),this.vxlExtraLight.copy(this.baseVxlExtraLight),this.shpExtraLight.copy(this.baseShpExtraLight),this.shadowWrap&&(this.shadowWrap.position.y=-l.Coords.tileHeightToWorld(this.gameObject.tileElevation),this.shadowWrap.updateMatrix())),0<t){var r=this.gameObject.velocity.clone().multiplyScalar(t).add(this.gameObject.position.worldPosition);this.setPosition(r)}this.vxlBuilder?(({rotationAxis:i,angularVelocity:r}=this.gameObject),this.vxlRotObj.rotateOnAxis(i,THREE.Math.degToRad(r)),this.vxlRotObj.updateMatrix()):(this.shpAnimRunner.tick(e),this.shpRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()),this.shpShadowRenderable.setFrame(this.shpAnimRunner.animation.getCurrentFrame()))}createObjects(e){let t=this.vxlRotObj=new THREE.Object3D;t.matrixAutoUpdate=!1,t.rotation.order="YXZ";var i=this.createMainObject();t.add(i),e.add(t)}computeSpriteAnchorOffset(e){var t=this.objectArt.getDrawOffset();return{x:e.x+t.x,y:e.y+t.y}}createMainObject(){let e=new THREE.Object3D;if(e.matrixAutoUpdate=!1,this.rules.voxelAnimRules.has(this.gameObject.name)){var t=this.getVxlFileName(this.objectRules,this.objectArt);if(!(h=this.voxels.get(t)))throw new Error(`VXL missing for anim ${this.objectRules.name}. Vxl file ${t} not found. `);let r=this.vxlBuilderFactory.create(h,void 0,[this.palette],this.palette);this.vxlBuilder=r;var i=r.build();e.add(i)}else{let u=new s.MapSpriteTranslation(1,1);var{spriteOffset:l,anchorPointWorld:t}=u.compute(),h=this.computeSpriteAnchorOffset(l);i=this.imageFinder.findByObjectArt(this.objectArt);let d=this.shpRenderable=r.ShpRenderable.factory(i,this.palette,this.camera,h,!1);d.setBatched(this.useSpriteBatching),this.useSpriteBatching&&d.setBatchPalettes([this.palette]),d.create3DObject(),e.add(d.get3DObject()),l=c.ShadowRenderable.getOrCreateShadowPalette();let g=this.shpShadowRenderable=r.ShpRenderable.factory(i,l,this.camera,h,!1);g.setBatched(this.useSpriteBatching),this.useSpriteBatching&&g.setBatchPalettes([l]),g.setOpacity(.5),g.create3DObject();let p=this.shadowWrap=new THREE.Object3D;p.matrixAutoUpdate=!1,p.add(g.get3DObject()),e.add(p),e.position.x=t.x,e.position.z=t.y,e.updateMatrix(),d.setFlat(this.objectArt.flat),i=new a.AnimProps(this.objectArt.art,i),i=new n.Animation(i,this.gameSpeed),this.shpAnimRunner=new o.SimpleRunner,this.shpAnimRunner.animation=i}return e}getVxlFileName(e,t){let i=t.imageName;return e.shareSource&&(i=e.shareSource,e.shareTurretData?i+="tur":e.shareBarrelData&&(i+="barl")),i.toLowerCase()+".vxl"}onCreate(e){this.plugins.forEach((t=>t.onCreate(e)))}onRemove(e){var t;this.plugins.forEach((t=>t.onRemove(e))),this.gameObject.isDestroyed&&this.get3DObject()&&(t=this.gameObject.explodeAnim)&&e.createTransientAnim(t,(e=>e.setPosition(this.withPosition.getPosition())))}dispose(){this.plugins.forEach((e=>e.dispose())),this.shpRenderable?.dispose(),this.shpShadowRenderable?.dispose(),this.vxlBuilder?.dispose()}})}}})),System.register("engine/renderable/entity/RenderableFactory",["engine/renderable/entity/Building","engine/renderable/entity/Vehicle","engine/renderable/entity/Terrain","engine/renderable/entity/Overlay","engine/renderable/entity/Smudge","engine/renderable/entity/building/AnimationType","engine/renderable/entity/Infantry","engine/renderable/entity/PipOverlay","engine/renderable/entity/Aircraft","engine/renderable/entity/TransientAnim","engine/renderable/entity/Projectile","engine/type/ObjectType","engine/renderable/entity/plugin/HarvesterPlugin","engine/renderable/entity/Anim","engine/renderable/entity/plugin/MoveSoundFxPlugin","engine/renderable/entity/plugin/VehicleDisguisePlugin","engine/renderable/entity/plugin/ChronoSparkleFxPlugin","engine/renderable/entity/plugin/TntFxPlugin","engine/renderable/entity/plugin/MindControlLinkPlugin","engine/renderable/entity/plugin/InfantryDisguisePlugin","engine/renderable/entity/building/PsychicDetectPlugin","engine/renderable/entity/plugin/TrailerSmokePlugin","engine/renderable/entity/plugin/DamageSmokePlugin","game/type/LocomotorType","engine/renderable/entity/plugin/ShipWakeTrailPlugin","engine/renderable/entity/plugin/ObjectCloakPlugin","engine/renderable/entity/Debris","engine/renderable/builder/ShpAggregator"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e}],execute:function(){e("RenderableFactory",class{constructor(e,t,i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C=!1,E=!1){this.localPlayer=e,this.unitSelection=t,this.alliances=i,this.rules=r,this.art=s,this.mapRenderable=n,this.imageFinder=a,this.palettes=o,this.voxels=l,this.voxelAnims=c,this.theater=h,this.camera=u,this.lighting=d,this.lightingDirector=g,this.debugWireframes=p,this.debugText=m,this.gameSpeed=f,this.worldSound=y,this.strings=T,this.flyerHelperOpt=v,this.hiddenObjectsOpt=b,this.vxlBuilderFactory=S,this.buildingImageDataCache=w,this.useSpriteBatching=C,this.useMeshInstancing=E,this.bridgeImageCache=new Map}createTransientAnim(e,t){var i=this.art.getObject(e,g.ObjectType.Animation);return new u.TransientAnim(e,i,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,t,this.worldSound)}createAnim(e){var t=this.art.getObject(e,g.ObjectType.Animation);return new m.Anim(e,t,{x:0,y:0},this.imageFinder,this.theater,this.camera,this.debugWireframes,this.gameSpeed,this.useSpriteBatching,void 0,this.worldSound)}create(e){let t=this.theater.getPalette(e.art.paletteType,e.art.customPaletteName),u=[];if((e.isAircraft()||e.isProjectile()||e.isDebris())&&u.push(new C.TrailerSmokePlugin(e,this.art,this.theater,this.imageFinder,this.gameSpeed)),e.isTechno()){t=t.clone();var g=this.unitSelection.getOrCreateSelectionModel(e),m=new c.PipOverlay(this.rules.general.paradrop,this.rules.audioVisual,e,this.localPlayer,this.alliances,g,this.imageFinder,this.palettes.get("palette.pal"),this.camera,this.strings,this.flyerHelperOpt,this.hiddenObjectsOpt,this.debugText,(e=>this.createAnim(e)),this.useSpriteBatching,this.useMeshInstancing);let s;if(!e.isUnit()||(I=e.rules.moveSound)&&this.worldSound&&u.push(new f.MoveSoundFxPlugin(e,I,this.worldSound)),u.push(new T.ChronoSparkleFxPlugin(e,this.rules.audioVisual.chronoSparkle1)),e.mindControllerTrait&&u.push(new b.MindControlLinkPlugin(e,g,this.alliances,this.localPlayer)),e.isBuilding()){var P=this.theater.animPalette,I=this.theater.isoPalette;s=new i.Building(e,g,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,t,P,I,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching,new R.ShpAggregator,this.buildingImageDataCache,m,this.worldSound,o.AnimationType.BUILDUP),e.psychicDetectorTrait&&u.push(new w.PsychicDetectPlugin(e,e.psychicDetectorTrait,this.localPlayer,this.camera))}else if(e.isVehicle())s=new r.Vehicle(e,this.rules,this.art,this.imageFinder,this.theater,this.voxels,this.voxelAnims,t,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,g,this.vxlBuilderFactory,this.useSpriteBatching,m,this.worldSound),e.rules.damageParticleSystems.length&&u.push(new E.DamageSmokePlugin(e,this.art,this.theater,this.imageFinder,this.gameSpeed)),e.rules.locomotor!==x.LocomotorType.Ship&&e.rules.locomotor!==x.LocomotorType.Hover||u.push(new O.ShipWakeTrailPlugin(e,this.rules,this.art,this.theater,this.imageFinder,this.gameSpeed)),e.harvesterTrait&&this.mapRenderable&&u.push(new p.HarvesterPlugin(e,e.harvesterTrait)),e.disguiseTrait&&u.push(new y.VehicleDisguisePlugin(e,e.disguiseTrait,this.localPlayer,this.alliances,s,this.art,this.imageFinder,this.theater,this.camera,this.lighting,this.gameSpeed,this.useSpriteBatching));else if(e.isInfantry())s=new l.Infantry(e,this.rules,this.art,this.imageFinder,this.theater,t,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,g,this.useSpriteBatching,this.useMeshInstancing,m,this.worldSound),e.disguiseTrait&&u.push(new S.InfantryDisguisePlugin(e,e.disguiseTrait,this.localPlayer,this.alliances,s,this.art,this.gameSpeed));else{if(!e.isAircraft())throw new Error("Unhandled game object type "+e.type);s=new h.Aircraft(e,this.rules,this.voxels,this.voxelAnims,t,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,g,this.vxlBuilderFactory,this.useSpriteBatching,m)}return e.tntChargeTrait&&u.push(new v.TntFxPlugin(e,e.tntChargeTrait,this.rules.combatDamage.ivanIconFlickerRate,s,this.imageFinder,this.art,this.alliances,this.localPlayer,this.worldSound,(e=>this.createAnim(e)))),u.push(new A.ObjectCloakPlugin(e,this.localPlayer,this.alliances,s)),u.forEach((e=>s.registerPlugin(e))),s}if(e.isTerrain())return new s.Terrain(e,this.mapRenderable?.terrainLayer,this.imageFinder,t,this.camera,this.lighting,this.debugWireframes,this.gameSpeed,this.useSpriteBatching);if(e.isOverlay())return new n.Overlay(e,this.rules,this.art,this.imageFinder,t,this.camera,this.lighting,this.debugWireframes,this.bridgeImageCache,this.mapRenderable?.overlayLayer,this.useSpriteBatching);if(e.isProjectile()){let i=new d.Projectile(e,this.rules,this.imageFinder,this.voxels,this.voxelAnims,this.theater,t,this.palettes.get("palette.pal"),this.camera,this.gameSpeed,this.lighting,this.lightingDirector,this.vxlBuilderFactory,this.useSpriteBatching,this.useMeshInstancing);return u.forEach((e=>i.registerPlugin(e))),i}if(e.isSmudge())return new a.Smudge(e,this.imageFinder,t,this.camera,this.lighting,this.debugWireframes,this.mapRenderable?.smudgeLayer);if(e.isDebris()){let i=new M.Debris(e,this.rules,this.imageFinder,this.voxels,this.voxelAnims,t,this.camera,this.lighting,this.gameSpeed,this.vxlBuilderFactory,this.useSpriteBatching);return u.forEach((e=>i.registerPlugin(e))),i}throw new Error("Not implemented")}})}}})),System.register("engine/RenderableManager",["engine/gfx/OctreeContainer"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("RenderableManager",class{constructor(e,t,i,r){this.world=e,this.worldScene=t,this.camera=i,this.renderableFactory=r,this.renderablesByGameObject=new Map,this.renderablesById=new Map,this.positionListeners=new Map,this.onCameraUpdate=()=>{this.container.cullChildren()},this.onWorldObjectSpawned=e=>{var t=e.isTechno()&&e.rules.isLightpost;let i=this.createRenderable(e,t?this.worldScene:this.container);i.onCreate&&i.onCreate(this),t=({tileChanged:t})=>this.onObjectPositionChanged(e,t),this.positionListeners.set(e,t),e.position.onPositionChange.subscribe(t)},this.onWorldObjectRemoved=e=>{e.position.onPositionChange.unsubscribe(this.positionListeners.get(e)),this.positionListeners.delete(e);let t=this.renderablesByGameObject.get(e);if(t.onRemove){let i=t.onRemove(this);i?i.then((()=>this.removeAndDisposeRenderable(t,e))).catch((e=>console.error(e))):this.removeAndDisposeRenderable(t,e)}else this.removeAndDisposeRenderable(t,e)}}init(){let e=this.container=i.OctreeContainer.factory(this.camera);e.autoCull=!1,this.worldScene.add(e),this.worldScene.onCameraUpdate.subscribe(this.onCameraUpdate),this.world.getAllObjects().forEach((e=>this.onWorldObjectSpawned(e))),this.world.onObjectSpawned.subscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.subscribe(this.onWorldObjectRemoved)}getRenderableById(e){return this.renderablesById.get(e)}getRenderableByGameObject(e){return this.renderablesByGameObject.get(e)}getRenderableContainer(){return this.container}onObjectPositionChanged(e,t){let i=this.renderablesByGameObject.get(e);i.setPosition(e.position.worldPosition),e.isTechno()&&e.rules.isLightpost||this.container.updateChild(i)}removeAndDisposeRenderable(e,t){(t.isTechno()&&t.rules.isLightpost?this.worldScene:this.container).remove(e),e.dispose?.(),this.renderablesByGameObject.delete(t),this.renderablesById.delete(t.id)}createTransientAnim(e,t){var i=this.renderableFactory.createTransientAnim(e,this.container);return t?.(i),this.container.add(i),i}createAnim(e,t,i=!1){var r=this.renderableFactory.createAnim(e);return t?.(r),i||this.container.add(r),r}addEffect(e){e.setContainer(this.worldScene),this.worldScene.add(e)}dispose(){this.worldScene.remove(this.container),this.container=void 0,this.worldScene.onCameraUpdate.unsubscribe(this.onCameraUpdate),this.world.onObjectSpawned.unsubscribe(this.onWorldObjectSpawned),this.world.onObjectRemoved.unsubscribe(this.onWorldObjectRemoved),this.onWorldObjectRemoved=void 0,this.onWorldObjectSpawned=void 0,this.positionListeners.forEach(((e,t)=>t.position.onPositionChange.unsubscribe(e))),this.positionListeners.clear(),this.renderablesById.forEach((e=>e.dispose?.()))}createRenderable(e,t){let i=this.renderableFactory.create(e);return i.setPosition(e.position.worldPosition),t.add(i),this.renderablesByGameObject.set(e,i),this.renderablesById.set(e.id,i),i}updateLighting(){for(var e of this.renderablesById.values())e.updateLighting()}})}}})),System.register("engine/gfx/Renderable",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gfx/Scene",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gfx/RendererError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("RendererError",i)}}})),System.register("engine/gfx/Renderer",["stats.js","util/event","engine/gfx/RendererError"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("Renderer",class{constructor(e,t){this.isContextLost=!1,this._onFrame=new r.EventDispatcher,this.handleContextLost=e=>{e.preventDefault(),this.isContextLost=!0},this.handleContextRestored=()=>{var e=this.renderer.domElement;this.renderer.dispose(),this.renderer=this.createGlRenderer(e),this.isContextLost=!1},this.width=e,this.height=t,this.scenes=new Set}get onFrame(){return this._onFrame.asEvent()}getCanvas(){return this.renderer.domElement}getStats(){return this.stats}supportsInstancing(){if(!this.renderer)throw new Error("Renderer not yet initialized");return!!this.renderer.extensions.get("ANGLE_instanced_arrays")}initStats(e){this.stats||(this.stats=new i.default,this.stats.showPanel(0),this.stats.dom.style.top="auto",this.stats.dom.style.bottom="0px",this.stats.dom.classList.add("stats-layer"),e.appendChild(this.stats.dom))}destroyStats(){this.stats&&(this.stats.dom.parentNode.removeChild(this.stats.dom),this.stats=void 0)}init(e){let t=this.createGlRenderer();e.appendChild(t.domElement),t.domElement.addEventListener("contextmenu",(e=>{e.preventDefault()})),t.domElement.addEventListener("mousedown",(e=>{e.preventDefault()})),t.domElement.addEventListener("wheel",(e=>{e.stopPropagation()}),{passive:!0}),t.domElement.addEventListener("webglcontextlost",this.handleContextLost),t.domElement.addEventListener("webglcontextrestored",this.handleContextRestored),this.renderer=t}createGlRenderer(e){let t;try{t=new THREE.WebGLRenderer({canvas:e,preserveDrawingBuffer:!0,powerPreference:"high-performance"})}catch(e){throw new s.RendererError("Failed to initialize WebGL renderer",{cause:e})}return t.setSize(this.width,this.height),t.autoClear=!1,t.autoClearDepth=!1,t.shadowMap.enabled=!0,t.localClippingEnabled=!0,t.toneMapping=THREE.NoToneMapping,t}setViewportSize(e,t){this.width=e,this.height=t,this.renderer&&this.renderer.setSize(e,t)}addScene(e){this.scenes.add(e),e.create3DObject()}removeScene(e){this.scenes.delete(e)}getScenes(){return[...this.scenes]}update(e,t){this.scenes.forEach((i=>{i.update(e,t)})),this._onFrame.dispatch(this,e)}render(){this.isContextLost||(this.renderer.clear(),this.scenes.forEach((e=>{this.renderer.clearDepth(),this.renderer.setViewport(e.viewport.x,e.viewport.y,e.viewport.width,e.viewport.height),this.renderer.render(e.scene,e.camera)})))}flush(){this.renderer.renderLists.dispose()}destroy(){this.renderer.domElement.remove(),this.renderer.domElement.removeEventListener("webglcontextlost",this.handleContextLost),this.renderer.domElement.removeEventListener("webglcontextrestored",this.handleContextRestored),this.renderer.dispose(),this.destroyStats()}})}}})),System.register("gui/LazyHtmlElement",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("LazyHtmlElement",class{constructor(e){this.children=new Set,this.rendered=!1,e&&this.setElement(e)}setElement(e){this.element=e}getElement(){return this.element}getChildren(){return[...this.children]}isRendered(){return this.rendered}add(...e){for(var t of e)this.children.has(t)||(this.children.add(t),this.rendered&&this.renderChild(t))}remove(...e){for(var t of e)this.children.has(t)&&(this.children.delete(t),this.rendered&&this.unrenderChild(t))}removeAll(){this.remove(...this.children)}render(){if(!this.element)throw new Error("An HTML element must be passed in the constructor or using the setter.");this.children.forEach((e=>this.renderChild(e))),this.rendered=!0}renderChild(e){e.render();var t=e.getElement();t&&this.getElement().appendChild(t)}unrenderChild(e){var t=e.getElement();t&&(e.unrender(),t.parentElement===this.getElement()&&this.getElement().removeChild(t))}unrender(){this.isRendered()&&(this.children.forEach((e=>this.unrenderChild(e))),this.rendered=!1)}})}}})),System.register("gui/HtmlContainer",["gui/LazyHtmlElement"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.LazyHtmlElement{constructor(){super(...arguments),this.visible=!0,this.left=0,this.top=0,this.width=0,this.height=0,this.relativeMode=!1,this.translateMode=!1}render(){var e;this.isRendered()||((e=this.getElement())||(e=document.createElement("div"),this.setElement(e)),this.updateMode(),this.updatePosition(),this.updateVisibility(),this.updateSize()),super.render()}setRelativeMode(e){this.relativeMode=e,this.updateMode()}setTranslateMode(e){this.translateMode=e,this.updatePosition()}setPosition(e,t){this.left=e,this.top=t,this.updatePosition()}setSize(e,t){this.width=e,this.height=t,this.updateSize()}getSize(){return{width:this.width,height:this.height}}setVisible(e){e!==this.visible&&(this.visible=e,this.updateVisibility())}updateMode(){let e=this.getElement();e&&(this.relativeMode?e.style.position="relative":(e.style.overflow="visible",e.style.position="absolute"))}updatePosition(){let e=this.getElement();e&&(this.translateMode?(e.style.top=e.style.left="0",e.style.transform=`translate(${this.left}px, ${this.top}px)`):(e.style.left=this.left+"px",e.style.top=this.top+"px",e.style.transform=""))}updateSize(){let e=this.getElement();e&&(e.style.width="number"==typeof this.width?this.width+"px":this.width,e.style.height="number"==typeof this.height?this.height+"px":this.height)}hide(){this.setVisible(!1)}show(){this.setVisible(!0)}updateVisibility(){let e=this.getElement();e&&(e.style.display=this.visible?"block":"none")}},e("HtmlContainer",r)}}})),System.register("util/mouse",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("util/dom",[],(function(e,t){"use strict";return t&&t.id,e("getOffset",(function(e){let t=0,i=0;for(;t+=e.offsetTop||0,i+=e.offsetLeft||0,e=e.offsetParent;);return{top:t,left:i}})),e("contains",(function(e,t){do{if(t===e)return!0}while(t=t.parentElement);return!1})),{setters:[],execute:function(){}}})),System.register("gui/CanvasMetrics",["util/disposable/CompositeDisposable","util/dom"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("CanvasMetrics",class{constructor(e,t){this.canvas=e,this.window=t,this.x=0,this.y=0,this.width=0,this.height=0,this.disposables=new i.CompositeDisposable,this.updateCanvasBoxMetrics=()=>{var e=r.getOffset(this.canvas);this.x=e.left,this.y=e.top,this.width=this.canvas.width,this.height=this.canvas.height}}init(){this.updateCanvasBoxMetrics(),this.window.addEventListener("resize",this.updateCanvasBoxMetrics),this.disposables.add((()=>this.window.removeEventListener("resize",this.updateCanvasBoxMetrics)))}notifyViewportChange(){this.updateCanvasBoxMetrics()}dispose(){this.disposables.dispose()}})}}})),System.register("gui/PointerEvents",["util/disposable/CompositeDisposable","util/array","util/math"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=(e,t)=>!!e.visible&&(e===t||!!e.parent&&n(e.parent,t)),e("PointerEvents",class{constructor(e,t,s,n){this.renderer=e,this.lockModePointer=t,this.document=s,this.canvasMetrics=n,this.disposables=new i.CompositeDisposable,this.canvasContext={handlers:new Map},this.objectContexts=new Map,this.intersectionsEnabled=!0,this.clickPaths=new Map,this.touchFingers=0,this.onDblClick=e=>{0===e.button&&this.onMouseEvent("dblclick",e)},this.onMouseMove=e=>{let t=this.getPointerPosition(e);if(this.intersectionsEnabled){let o=this.currentHoverPath?[...this.currentHoverPath]:void 0;var i=o?.[0],s=this.findObjectUnderPointer(t);let l=s?.object;if(this.currentHoverPath=void 0,l&&(this.currentHoverPath=[l],l.traverseAncestors((e=>{this.currentHoverPath.push(e)}))),!r.equals(this.currentHoverPath??[],o??[])){if(o)for(var n of o)this.currentHoverPath&&this.currentHoverPath.includes(n)||this.notify("mouseleave",n,t,e,void 0,!1);if(this.currentHoverPath)for(var a of this.currentHoverPath)o&&o.includes(a)||this.notify("mouseenter",a,t,e,s,!1);i&&this.notify("mouseout",i,t,e),l&&this.notify("mouseover",l,t,e,s)}l?this.notify("mousemove",l,t,e,s):this.renderer.getScenes().forEach((i=>this.notify("mousemove",i.get3DObject(),t,e)))}this.notify("mousemove","canvas",t,e)},this.onMouseDown=e=>{this.onMouseEvent("mousedown",e)},this.onMouseUp=e=>{this.onMouseEvent("mouseup",e)},this.onMouseWheel=e=>{this.onMouseEvent("wheel",e)},this.onTouchMove=e=>{if(e.preventDefault(),this.initialTouchEvent?.touches){let i=this.initialTouchEvent.touches[0];var t=[...e.changedTouches].find((e=>i.identifier===e.identifier));t&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0),t=this.fakeMouseEventFromTouch(t,e),this.onMouseMove(t))}},this.onTouchStart=e=>{e.preventDefault();let t=e.touches;var i,r;1<t.length?0<this.touchFingers||2===t.length&&(this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.touchFingers=2,this.initialTouchEvent||(this.initialTouchEvent=e),i=this.initialTouchEvent.touches[0],r=this.fakeMouseEventFromTouch(i,e,2),this.onMouseEvent("mousedown",r)):(i=()=>{this.touchFingers=1;var i=this.fakeMouseEventFromTouch(t[0],e);this.onMouseEvent("mousedown",i)},r=setTimeout(i,50),this.touchStartBuffer={cb:i,timeoutId:r},this.initialTouchEvent=e)},this.onTouchEnd=e=>{if(e.preventDefault(),this.initialTouchEvent?.touches){let r=this.initialTouchEvent.touches[0];var t=[...e.changedTouches].find((e=>r.identifier===e.identifier));if(t){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer.cb(),this.touchStartBuffer=void 0);var i=2===this.touchFingers?2:0;let r=this.fakeMouseEventFromTouch(t,e,i);r.touchDuration=e.timeStamp-this.initialTouchEvent.timeStamp,this.touchFingers=0,this.initialTouchEvent=void 0,this.onMouseEvent("mouseup",r)}}};let a=e.getCanvas();a.addEventListener("dblclick",this.onDblClick,!1),a.addEventListener("mousemove",this.onMouseMove,!1),a.addEventListener("mousedown",this.onMouseDown,!1),a.addEventListener("mouseup",this.onMouseUp,!1),a.addEventListener("touchmove",this.onTouchMove,!1),a.addEventListener("touchstart",this.onTouchStart,!1),a.addEventListener("touchend",this.onTouchEnd,!1),a.addEventListener("wheel",this.onMouseWheel,{passive:!0}),this.disposables.add((()=>{a.removeEventListener("dblclick",this.onDblClick,!1),a.removeEventListener("mousemove",this.onMouseMove,!1),a.removeEventListener("mousedown",this.onMouseDown,!1),a.removeEventListener("mouseup",this.onMouseUp,!1),a.removeEventListener("touchmove",this.onTouchMove,!1),a.removeEventListener("touchstart",this.onTouchStart,!1),a.removeEventListener("touchend",this.onTouchEnd,!1),a.removeEventListener("wheel",this.onMouseWheel,!1)}))}addEventListener(e,t,i,r=!1){let s="canvas"===e?this.canvasContext:this.getOrCreateObjectContext(e),n=s.handlers.get(t);return n||(n=[],s.handlers.set(t,n)),n.push({callback:i,useCapture:r}),()=>this.removeEventListener(e,t,i,r)}removeEventListener(e,t,i,r=!1){let s="canvas"===e?this.canvasContext:this.objectContexts.get(e);if(s&&s.handlers.has(t)){let n=s.handlers.get(t);n=n.filter((e=>!(e.callback===i&&e.useCapture===r))),n.length?s.handlers.set(t,n):s.handlers.delete(t),s.handlers.size||"canvas"===e||this.objectContexts.delete(e)}}getOrCreateObjectContext(e){if(!e)throw new Error("Undefined Object3D instance.");let t=this.objectContexts.get(e);return t||(t={handlers:new Map},this.objectContexts.set(e,t)),t}fakeMouseEventFromTouch(e,t,i=0){var r=this.computeTouchPosition(e);return{offsetX:r.x,offsetY:r.y,button:i,isTouch:!0,detail:1,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp}}computeTouchPosition(e){let t={x:e.pageX-this.canvasMetrics.x,y:e.pageY-this.canvasMetrics.y};return t.x=s.clamp(t.x,0,this.canvasMetrics.width-1),t.y=s.clamp(t.y,0,this.canvasMetrics.height-1),t}onMouseEvent(e,t){let i=this.getPointerPosition(t);var r=this.findObjectUnderPointer(i);if(r?this.notify(e,r.object,i,t,r):this.renderer.getScenes().forEach((r=>this.notify(e,r.get3DObject(),i,t))),this.notify(e,"canvas",i,t),"mousedown"===e||"mouseup"===e){let n=r?.object,a=[];if(n&&(a=[n],n.traverseAncestors((e=>{a.push(e)}))),"mousedown"===e)this.clickPaths.set(t.button,a);else{let e=this.clickPaths.get(t.button);this.clickPaths.delete(t.button);let n=!1;for(var s of a)if(e?.includes(s)){this.notify("click",s,i,t,r),n=!0;break}n||this.renderer.getScenes().forEach((e=>this.notify("click",e.get3DObject(),i,t))),this.notify("click","canvas",i,t)}}}getPointerPosition(e){return this.document.pointerLockElement?this.lockModePointer:{x:e.offsetX,y:e.offsetY}}findObjectUnderPointer(e){let t=this.renderer.getScenes(),i=this.groupObjectsByScene();for(let s=t.length-1;0<=s;s--){let a=new THREE.Raycaster;var r=this.normalizePointer(e,t[s].viewport);a.setFromCamera(r,t[s].camera),r=i.get(t[s].scene).filter((e=>n(e,t[s].get3DObject())));let o=a.intersectObjects(r,!0);if(o.length){if(1===o.length)return o[0];let e=new Set(o.map((e=>e.object)));return o.forEach((t=>{e.has(t.object)&&t.object.traverseAncestors((t=>{e.has(t)&&e.delete(t)}))})),o.filter((t=>e.has(t.object)))[0]}}}normalizePointer(e,t){return{x:(e.x-t.x)/t.width*2-1,y:-(e.y-t.y)/t.height*2+1}}groupObjectsByScene(){let e=new Map;return this.renderer.getScenes().forEach((t=>e.set(t.get3DObject(),[]))),[...this.objectContexts.keys()].forEach((t=>{if("Scene"!==t.type){let i=t;for(;i.parent;)i=i.parent;"Scene"===i.type&&e.get(i).push(t)}})),e}notify(e,t,i,r,s,n=!0){let a="canvas"===t?this.canvasContext:this.objectContexts.get(t),o=a?.handlers.get(e);o&&o.length||"canvas"!==t&&t.parent&&n&&this.notify(e,t.parent,i,r,s),o?.forEach((a=>{let o=!0;a.callback({type:e,target:"canvas"!==t?t:void 0,pointer:{...i},intersection:s,button:r.button,isTouch:!!r.isTouch,touchDuration:r.touchDuration,clicks:r.detail,altKey:r.altKey,ctrlKey:r.ctrlKey,metaKey:r.metaKey,shiftKey:r.shiftKey,timeStamp:r.timeStamp,wheelDeltaY:r.deltaY??0,stopPropagation:()=>{o=!1}}),o&&"canvas"!==t&&!a.useCapture&&t.parent&&n&&this.notify(e,t.parent,i,r,s)}))}dispose(){this.touchStartBuffer&&(clearTimeout(this.touchStartBuffer.timeoutId),this.touchStartBuffer=void 0),this.disposables.dispose()}})}}})),System.register("gui/UiObject",["engine/renderable/WithPosition","engine/gfx/RenderableContainer","util/event","engine/renderable/WithVisibility"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("UiObject",class e{constructor(e,t){this.rendered=!1,this.eventHandlers=[],this._onFrame=new s.EventDispatcher,this._onDispose=new s.EventDispatcher,e&&this.set3DObject(e),t&&this.setHtmlContainer(t),this.withPosition=new i.WithPosition,this.withVisibility=new n.WithVisibility,this.container=new r.RenderableContainer}get onFrame(){return this._onFrame.asEvent()}get onDispose(){return this._onDispose.asEvent()}static zIndexToWorld(e){return-e}get3DObject(){return this.target}set3DObject(e){(this.target=e).matrixAutoUpdate=!1}getRenderableContainer(){return this.container}getHtmlContainer(){return this.htmlContainer}setHtmlContainer(e){this.htmlContainer=e}setPosition(e,t){var i=this.withPosition.getPosition().z||0;this.withPosition.setPosition(e,t,i),this.htmlContainer?.setPosition(e,t)}getPosition(){var{x:e,y:t}=this.withPosition.getPosition();return{x:e,y:t}}setZIndex(t){var i=this.withPosition.getPosition();this.withPosition.setPosition(i.x,i.y,e.zIndexToWorld(t))}setVisible(e){this.withVisibility.setVisible(e),this.htmlContainer?.setVisible(e)}isVisible(){return this.withVisibility.isVisible()}setTooltip(e){this.tooltip=e,this.updateTooltip()}updateTooltip(){let e=this.get3DObject();e&&(e.userData.tooltip=this.tooltip)}setPointerEvents(e){if(this.pointerEvents)throw new Error("A PointerEvents instance is already set");this.pointerEvents=e}addEventListener(e,t){return this.eventHandlers.push({eventName:e,handler:t}),this.rendered&&this.setupEventListener(e,t),()=>this.removeEventListener(e,t)}removeEventListener(e,t){var i=this.eventHandlers.findIndex((i=>e===i.eventName&&t===i.handler));-1!==i&&(this.eventHandlers[i].disposer?.(),this.eventHandlers.splice(i,1))}setupEventListener(e,t){if(!this.pointerEvents)throw new Error("A PointerEvents object must be provided prior to setting up an event listener");var i=this.pointerEvents.addEventListener(this.get3DObject(),e,t);let r=this.eventHandlers.find((i=>e===i.eventName&&t===i.handler));r&&(r.disposer=i)}create3DObject(){if(!this.get3DObject())throw new Error("Expecting a THREE.Object3D to have been set by now");this.rendered||(this.rendered=!0,this.withPosition.matrixUpdate=!0,this.withPosition.applyTo(this),this.withVisibility.applyTo(this),this.htmlContainer?.render(),this.htmlContainer?.setPosition(this.withPosition.getPosition().x,this.withPosition.getPosition().y),this.htmlContainer?.setVisible(this.withVisibility.isVisible()),this.container.set3DObject(this.get3DObject()),this.container.create3DObject(),this.updateTooltip(),this.eventHandlers.forEach((e=>this.setupEventListener(e.eventName,e.handler))))}update(e){this.container.update(e),this._onFrame.dispatch(this,e)}add(...e){this.container.add(...e),e.map((e=>e.getHtmlContainer())).forEach((e=>{if(e){if(!this.htmlContainer)throw new Error("Can't add an UiObject that defines an HTMLContainer to a parent that doesn't provide an HTML container.");this.htmlContainer.add(e)}}))}remove(...e){e.map((e=>e.getHtmlContainer())).forEach((e=>e&&this.htmlContainer?.remove(e))),this.container.remove(...e)}removeAll(){this.container.removeAll()}destroy(){this.container.getChildren().forEach((e=>e.destroy?.())),this.htmlContainer?.unrender(),this.eventHandlers.forEach((e=>e.disposer?.())),this.eventHandlers.length=0,this._onFrame=new s.EventDispatcher,this._onDispose.dispatch(),this._onDispose=new s.EventDispatcher}})}}})),System.register("gui/UiScene",["gui/UiObject","gui/HtmlContainer","engine/gfx/batch/MeshBatchManager"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class e extends i.UiObject{constructor(e,t,i,r){super(e,r),this.scene=e,this.camera=t,this.viewport=i}static factory(t){let i=new THREE.Scene;i.matrixAutoUpdate=!1;var s=e.createCamera(t),n=new r.HtmlContainer;return new e(i,s,t,n)}static createCamera(e){var t=e.height/2,i=e.width/e.height;let r=new THREE.OrthographicCamera(-t*i,t*i,t,-t,-1e3,1e3);return r.rotation.x=Math.PI,r.position.x=-e.x+e.width/2,r.position.y=-e.y+e.height/2,r.position.z=-1e3,r}setCamera(e){this.camera=e}setViewport(e){this.viewport=e}create3DObject(){var e;super.create3DObject(),this.meshBatchManager||(e=this.meshBatchManager=new s.MeshBatchManager(this.getRenderableContainer()),this.getRenderableContainer().add(e),this.scene.autoUpdate=!1)}update(e){super.update(e),this.meshBatchManager&&(this.scene.updateMatrixWorld(!1),this.meshBatchManager.updateMeshes())}get menuViewport(){return{x:Math.max(0,(this.viewport.width-800)/2),y:Math.max(0,(this.viewport.height-600)/2),width:800,height:600}}destroy(){super.destroy(),this.meshBatchManager?.dispose()}},e("UiScene",n)}}})),System.register("network/PlayerRankType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.None=0]="None",t[t.Private=1]="Private",t[t.Corporal=2]="Corporal",t[t.Sergeant=3]="Sergeant",t[t.Lieutenant=4]="Lieutenant",t[t.Major=5]="Major",t[t.Colonel=6]="Colonel",t[t.BrigGeneral=7]="BrigGeneral",t[t.General=8]="General",t[t.FiveStarGeneral=9]="FiveStarGeneral",t[t.CommanderInChief=10]="CommanderInChief",e("PlayerRankType",i)}}})),System.register("network/PlayerProfile",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/chat/SystemMessage",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gservConfig",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("API_VERSION",1),e("RECIPIENT_ALL","#all"),e("RECIPIENT_TEAM","#team"),e("TURN_TIMEOUT_MILLIS",3e4),e("LAG_STATE_THRESH_MILLIS",1e3),e("CON_INFO_THRESH_MILLIS",2e3),e("MAX_MAP_TRANSFER_BYTES",2097152)}}})),System.register("gui/chat/ChatMessageFormat",["react","network/chat/ChatMessage","network/gservConfig"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("ChatMessageFormat",class{constructor(e,t,i){this.strings=e,this.localUsername=t,this.userColors=i}formatPrefixPlain(e){let t;if(e.to.type===r.ChatRecipientType.Channel)t=e.to.name===s.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",e.from):this.strings.get("TS:ChatFrom",e.from);else if(e.to.type===r.ChatRecipientType.Page)t=this.strings.get("TS:PageFrom",e.from);else{if(e.to.type!==r.ChatRecipientType.Whisper)throw new Error("Unknown message type "+e.to.type);t=e.from===this.localUsername?this.strings.get("TS:To",e.to.name):this.strings.get("TXT_FROM",e.from)}return t}formatPrefixHtml(e,t){let n=e.to.type===r.ChatRecipientType.Whisper&&e.from===this.localUsername?e.to.name:e.from,a=n;var o,l="{user}";let c;if(e.to.type!==r.ChatRecipientType.Page&&(void 0!==(o=this.userColors?.get(e.from))&&(a=i.default.createElement("span",{style:{color:o}},a)),t&&(h=this.strings.get("TS:ChatUserLink",l).split(l),a=i.default.createElement("span",{className:"user-link",onClick:()=>t(n)},h[0],a,h[1]))),e.to.type===r.ChatRecipientType.Channel)c=e.to.name===s.RECIPIENT_TEAM?this.strings.get("TS:ChatFromAllies",l):this.strings.get("TS:ChatFrom",l);else if(e.to.type===r.ChatRecipientType.Page)c=this.strings.get("TS:PageFrom",l);else{if(e.to.type!==r.ChatRecipientType.Whisper)throw new Error("Unknown message type "+e.to.type);c=e.from===this.localUsername?this.strings.get("TS:To",l):this.strings.get("TXT_FROM",l)}var[h,l]=c.split(l);return i.default.createElement(i.default.Fragment,null,h,a,l)}})}}})),System.register("gui/chat/ChatHistory",["network/chat/ChatMessage","network/gservConfig","util/BoxedVar","util/event"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ChatHistory",class{constructor(){this.lastWhisperFrom=new s.BoxedVar(void 0),this.lastWhisperTo=new s.BoxedVar(void 0),this.lastComposeTarget=new s.BoxedVar({type:i.ChatRecipientType.Channel,name:r.RECIPIENT_ALL}),this.messages=[],this._onNewMessage=new n.EventDispatcher}get onNewMessage(){return this._onNewMessage.asEvent()}addChatMessage(e){this.messages.push(e),this._onNewMessage.dispatch(this,e)}getAll(){return this.messages}})}}})),System.register("gui/component/ChatInput",["react","network/chat/ChatMessage","network/gservConfig"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){"",n=({chatHistory:e,channels:t,strings:n,className:a,tooltip:o,forceColor:l,noCycleHint:c,submitEmpty:h,onKeyDown:u,onKeyUp:d,onBlur:g,onCancel:p,onSubmit:m},f)=>{const y=i.useRef(null),[T,v]=i.useState((()=>P())),[b,S]=i.useState((()=>{var i=e?.lastComposeTarget.value;return I(i)?i:{type:r.ChatRecipientType.Channel,name:t[0]??""}})),[w,C]=i.useState(),[E,x]=i.useState(),[O,A]=i.useState(!1),[M,R]=i.useState(!1);function P(){const i=(t.length?t:[""]).map((e=>({type:r.ChatRecipientType.Channel,name:e})));var s,n;return e&&(s=e.lastWhisperFrom.value,n=e.lastWhisperTo.value,s&&i.push({type:r.ChatRecipientType.Whisper,name:s}),n&&n!==s&&i.push({type:r.ChatRecipientType.Whisper,name:n})),i}function I(e){return e&&(e.type!==r.ChatRecipientType.Channel||t.includes(e.name))}function k(t){e&&(e.lastComposeTarget.value=t),S(t)}i.useEffect((()=>{y.current?.focus()}),[]),i.useEffect((()=>{if(e){let t=e=>{b!==e&&I(e)&&(S(e),y.current?.focus())},i=()=>{v(P())};return e.lastComposeTarget.onChange.subscribe(t),e.lastWhisperFrom.onChange.subscribe(i),e.lastWhisperTo.onChange.subscribe(i),()=>{e.lastComposeTarget.onChange.unsubscribe(t),e.lastWhisperFrom.onChange.unsubscribe(i),e.lastWhisperTo.onChange.unsubscribe(i)}}}),[b,e,t]),i.useImperativeHandle(f,(()=>({send(){let e=y.current;var t;!e||(t=e.value).length&&(m({recipient:b,value:t}),e.value="",e.focus(),x(t))}})),[b]);var B=function(e){if(e.type===r.ChatRecipientType.Channel)return e.name===s.RECIPIENT_TEAM?n.get("TS:ToAllies"):e.name===s.RECIPIENT_ALL?n.get("TS:ToAll"):"";if(e.type===r.ChatRecipientType.Whisper)return n.get("TS:To",e.name);throw new Error(`Recipient type ${e.type} not implemented`)}(b);let j=!c&&O&&!M&&(1<T.length||b.type===r.ChatRecipientType.Whisper)?n.get("TS:ChatCycleHint","Tab"):void 0;return i.default.createElement("div",{className:a},B&&i.default.createElement("label",{style:{color:l}},B),i.default.createElement("input",{type:"text",autoComplete:"off",spellCheck:!1,ref:y,maxLength:128,"data-r-tooltip":o,placeholder:j,style:{color:l},onKeyDown:e=>{"Tab"===e.key&&e.preventDefault(),e.repeat||C(e.key),u?.(e)},onKeyUp:e=>{let t=e.target;var i;"Enter"===e.key?"Enter"===w&&(((i=t.value).length||h)&&m({recipient:b,value:i}),i.length&&(t.value="",x(i))):"Tab"===e.key?"Tab"===w&&function(e){if(1!==T.length||T[0].name!==e.name){let i=T.findIndex((t=>t.type===e.type&&t.name===e.name));i=-1===i?0:(i+1)%T.length;var t=T[i];R(!0),k(t)}}(b):"ArrowUp"===e.key&&E?t.value=E:"Escape"===e.key&&"Process"!==w&&(p?.(0===t.value.length),t.value=""),d?.(e)},onChange:t=>{let i=t.target.value;var s=i.match(/^\/(?:page|whisper|w|msg|m) ([A-Za-z0-9-_']+) /i);s&&(k({type:r.ChatRecipientType.Whisper,name:s[1]}),t.target.value="");var n=i.match(/^\/r(eply)? /i);n&&(void 0!==e?.lastWhisperFrom.value&&k({type:r.ChatRecipientType.Whisper,name:e.lastWhisperFrom.value}),t.target.value=""),s||n||void 0===j||R(!0)},onFocus:()=>{A(!0)},onBlur:()=>{A(!1),g?.()}}))},e("ChatInput",i.forwardRef(n))}}})),System.register("gui/component/Chat",["react","classnames","network/chat/ChatMessage","gui/chat/ChatMessageFormat","gui/component/ChatInput"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=(new Map).set(s.ChatRecipientType.Channel,"type-channel").set(s.ChatRecipientType.Page,"type-page").set(s.ChatRecipientType.Whisper,"type-whisper"),l=class extends i.default.Component{constructor(){super(...arguments),this.prevMessageCount=0}render(){let{messages:e,tooltips:t,strings:r,chatHistory:s,channels:n}=this.props;return i.default.createElement("div",{className:"chat-wrapper"},i.default.createElement("div",{className:"messages",ref:e=>this.messageList=e,"data-r-tooltip":t?.output},e.map(((e,t)=>this.renderMessage(e,t)))),i.default.createElement("div",{className:"new-message-wrapper"},i.default.createElement(a.ChatInput,{ref:e=>this.textBox=e,chatHistory:s,channels:n,className:"new-message",tooltip:t?.input,strings:r,onSubmit:this.props.onSendMessage,onCancel:this.props.onCancelMessage}),i.default.createElement("button",{className:"icon-button send-message-button","data-r-tooltip":t?.button,onClick:()=>this.textBox.send()})))}componentDidUpdate(e,t){var i,r;this.props.messages[0]===this.prevOldestMessage&&this.props.messages.length===this.prevMessageCount||(this.prevMessageCount=this.props.messages.length,this.prevOldestMessage=this.props.messages[0],i=this.messageList.scrollHeight,r=this.messageList.clientHeight,i!==this.prevScrollHeight&&(!this.prevScrollHeight||Math.abs(this.messageList.scrollTop-(this.prevScrollHeight-r))<=1)&&(this.messageList.scrollTop=i-r),this.prevScrollHeight=i)}renderMessage(e,t){let a,l=["message"];return void 0!==e.from&&(a=new n.ChatMessageFormat(this.props.strings,this.props.localUsername,this.props.userColors).formatPrefixHtml(e,(t=>{this.props.chatHistory&&e.to&&e.to.type!==s.ChatRecipientType.Page&&(this.props.chatHistory.lastComposeTarget.value={type:s.ChatRecipientType.Whisper,name:t})})),l.push(o.get(e.to.type),{"operator-message":e.operator})),i.default.createElement("div",{key:t,className:r.default(l)},a?i.default.createElement(i.default.Fragment,null,i.default.createElement("span",null,a)," ",e.text):e.text)}},e("Chat",l)}}}));System.register("gui/screen/mainMenu/lobby/component/viewmodel/lobby",[],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[],execute:function(){var t,a;(t=i=i||{})[t.Singleplayer=0]="Singleplayer",t[t.MultiplayerHost=1]="MultiplayerHost",t[t.MultiplayerGuest=2]="MultiplayerGuest",e("LobbyType",i),(a=r=r||{})[a.Player=1]="Player",a[a.Ai=2]="Ai",a[a.Observer=3]="Observer",e("SlotType",r),(a=s=s||{})[a.Open=1]="Open",a[a.Closed=2]="Closed",a[a.Occupied=3]="Occupied",e("SlotOccupation",s),(a=n=n||{})[a.NotReady=1]="NotReady",a[a.Ready=2]="Ready",a[a.Host=3]="Host",e("PlayerStatus",n)}}})),System.register("gui/UiObjectSprite",["engine/renderable/builder/ShpBuilder","gui/UiObject"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends r.UiObject{constructor(e){super(),this.builder=e}static fromShpFile(e,t,r){let s=new i.ShpBuilder(e,t,r);return s.setBatched(!0),s.setBatchPalettes([t]),s.setOffset({x:Math.floor(e.width/2),y:Math.floor(e.height/2)}),new this(s)}setAnimationRunner(e){this.animationRunner=e}getAnimationRunner(){return this.animationRunner}update(e){super.update(e),this.animationRunner&&(this.animationRunner.tick(e),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.builder.getSize()}setFrame(e){this.builder.setFrame(e)}getFrame(){return this.builder.getFrame()}getFrameCount(){return this.builder.frameCount}setTransparent(e){this.get3DObject()?this.builder.setForceTransparent(e):this.initialTransparency=e}setOpacity(e){this.get3DObject()?this.builder.setOpacity(e):this.initialOpacity=e}setLightMult(e){this.get3DObject()?this.builder.setExtraLight((new THREE.Vector3).addScalar(-1+e)):this.initialLightMult=e}create3DObject(){this.set3DObject(this.builder.build()),super.create3DObject(),void 0!==this.initialTransparency&&this.builder.setForceTransparent(this.initialTransparency),void 0!==this.initialOpacity&&this.builder.setOpacity(this.initialOpacity),void 0!==this.initialLightMult&&this.builder.setExtraLight((new THREE.Vector3).addScalar(this.initialLightMult))}destroy(){super.destroy(),this.builder.dispose()}},e("UiObjectSprite",s)}}})),System.register("gui/jsx/UiComponent",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("UiComponent",class{constructor(e){this.props=e,this.uiObject=this.createUiObject(e)}getUiObject(){return this.uiObject}})}}})),System.register("gui/ShpSpriteBatch",["gui/UiObject","gui/HtmlContainer","data/ShpFile","engine/renderable/builder/BatchShpBuilder"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends i.UiObject{constructor(e,t,i,s){super(new THREE.Object3D,new r.HtmlContainer),this.spriteProps=e,this.getShpFile=t,this.getPalette=i,this.camera=s,this.textureCache=new Map,this.batchShpBuilders=[]}create3DObject(){super.create3DObject();var e=this.createAggregatedShpFile();this.createObjects(this.get3DObject(),e)}createAggregatedShpFile(){let e=new s.ShpFile;e.filename="agg_unnamed_spritebatch.shp";let t=new Map,i=0;for(var r of this.spriteProps){r=("string"==typeof r.image?this.getShpFile(r.image):r.image).getImage(r.frame??0),t.has(r)||(e.addImage(r),t.set(r,i),i++)}return{file:e,imageIndexes:t}}createObjects(e,t){let r=new Map;for(var s of this.spriteProps){var a=("string"==typeof s.palette?this.getPalette(s.palette):s.palette).hash;r.set(a,(r.get(a)??[]).concat(s))}for(var o of r.values()){var l,c="string"==typeof o[0].palette?this.getPalette(o[0].palette):o[0].palette;let r=[];for(l of o){let e="string"==typeof l.image?this.getShpFile(l.image):l.image;var h=t.imageIndexes.get(e.getImage(l.frame??0));if(void 0===h)throw new Error("Missing frame in aggregated sprite shp file");h={position:new THREE.Vector3(l.x??0,l.y??0,i.UiObject.zIndexToWorld(l.zIndex??0)),shpFile:e,depth:!1,flat:!1,frameNo:h,offset:{x:e.width/2,y:e.height/2}},r.push(h)}if(r.length){let i=new n.BatchShpBuilder(t.file,c,this.camera,this.textureCache,void 0,void 0,r.length);r.forEach((e=>i.add(e))),this.batchShpBuilders.push(i),e.add(i.build())}}}destroy(){super.destroy(),this.batchShpBuilders.forEach((e=>e.dispose())),[...this.textureCache.values()].forEach((e=>e.dispose())),this.textureCache.clear()}},e("ShpSpriteBatch",a)}}})),System.register("gui/jsx/jsx",[],(function(e,t){"use strict";return t&&t.id,e("createRef",(function(){return{current:void 0}})),e("jsx",(function(e,t,...i){let{ref:r,...s}=t=t||{};return{isJsxElement:!0,type:e,props:{...s,children:1<i.length?i:i[0]},ref:r}})),e("renderJsx",(function e(t,i){let r,s,n;return(t=Array.isArray(t)?t:[t]).map((t=>{if(null==t||!t.isJsxElement)return[];if("string"==typeof t.type)if(s=t.props.children,"fragment"===t.type)r=void 0;else{let e=i[t.type];if(!e)throw new Error(`No renderer defined for intrinsic JSX element "${t.type}"`);var a=e({ref:t.ref,...t.props});r=a.obj,r&&(n=r),a.children&&(s=a.children)}else{let e=new t.type(t.props);r=e.getUiObject(),s=e.defineChildren?.()||t.props.children,e.onRender&&r.onFrame.subscribeOnce((t=>e.onRender(t))),e.onFrame&&r.onFrame.subscribe((t=>e.onFrame(t))),e.onDispose&&r.onDispose.subscribe((()=>e.onDispose())),n=e}return a=s?(Array.isArray(s)?s:[s]).map((t=>e(t,i))).reduce(((e,t)=>[...e,...t]),[]):[],r&&r.add(...a),n&&t.ref&&("function"==typeof t.ref?t.ref?.(n):t.ref.current=n),r?[r]:null!==r?a:[]})).reduce(((e,t)=>[...e,...t]),[])})),{setters:[],execute:function(){}}})),System.register("gui/screen/mainMenu/component/viewmodel/MenuButtonConfig",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/mainMenu/component/MenuVideo",["react","util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=new Map([["mp4","video/mp4"],["webm","video/webm"]]),n=class extends i.default.Component{constructor(){super(...arguments),this.el=null,this.disposables=new r.CompositeDisposable,this.disposed=!1}render(){const e=this.props.src;let t,r;return"string"==typeof e?(r=e,t=s.get(e.split("?")[0].split(".").pop())??"video/webm"):(r=URL.createObjectURL(e),t=e.type,this.disposables.add((()=>{URL.revokeObjectURL(r)}))),i.default.createElement("div",{className:"video-wrapper",ref:e=>this.el=e,dangerouslySetInnerHTML:{__html:`\n            <video style="outline: none;" loop playsinline muted autoplay>\n                <source src="${r}" type="${t}" />\n            </video>\n            <div class="logo" style="opacity: 0;" />\n        `}})}componentDidMount(){const e=this.props.src;let t=this.el.querySelector("video"),i=this.el.querySelector("div");if(e instanceof File&&window.MediaSource){let i=async()=>{this.applyMediaSourceFallback(t,await e.arrayBuffer())};t.querySelector("source").addEventListener("error",i,{once:!0}),t.addEventListener("loadeddata",(()=>{t.querySelector("source").removeEventListener("error",i)}))}t.addEventListener("loadeddata",(()=>{i.style.opacity=""}))}async applyMediaSourceFallback(e,t){if(!this.disposed){let i=new MediaSource;i.addEventListener("sourceopen",(()=>{try{let r=i.addSourceBuffer('video/webm; codecs="vp8"');r.mode="sequence",r.appendBuffer(t),this.timeoutId=setTimeout((()=>this.processNextSegment(r,e,t)),1e3),this.disposables.add((()=>clearTimeout(this.timeoutId)))}catch(e){return void("NotSupportedError"!==e.name&&console.error(e))}}));let r=e.src=URL.createObjectURL(i);this.disposables.add((()=>{URL.revokeObjectURL(r),r=void 0}))}}processNextSegment(e,t,i){try{!e.updating&&0<e.buffered.length&&(e.buffered.end(e.buffered.length-1)-t.currentTime<10&&e.appendBuffer(i),t.paused&&t.play()?.catch((e=>console.error(e))))}catch(e){return void console.error(e)}this.timeoutId=setTimeout((()=>this.processNextSegment(e,t,i)),1e3)}componentWillUnmount(){this.disposables.dispose(),this.disposed=!0}},e("MenuVideo",n)}}})),System.register("gui/component/MenuButton",["react"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.default.Component{render(){var e=this.props.buttonConfig;return e?i.default.createElement("div",{className:this.getClassName(e),style:this.getStyle(),onMouseDown:e=>this.onMouseDown(e),onMouseUp:e=>this.onMouseUp(e),onClick:e=>this.onClick(e),"data-r-tooltip":e.tooltip},e.label):null}getClassName(e){let t=["menu-button"];return e.disabled&&t.push("disabled"),t.join(" ")}getStyle(){var e=this.props.box;return{position:"absolute",left:e.x,top:e.y,width:e.width,height:e.height,lineHeight:e.height+1+"px"}}onMouseDown(e){!this.props.buttonConfig.disabled&&this.props.onMouseDown&&this.props.onMouseDown(e)}onMouseUp(e){!this.props.buttonConfig.disabled&&this.props.onMouseUp&&this.props.onMouseUp(e)}onClick(e){!this.props.buttonConfig.disabled&&this.props.onClick&&this.props.onClick(e)}},e("MenuButton",r)}}})),System.register("gui/screen/mainMenu/component/MenuSlotAnimationRunner",["data/IniSection","data/ShpFile","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){var t;(t=l=l||{})[t.None=0]="None",t[t.SlideIn=1]="SlideIn",t[t.SlideOut=2]="SlideOut",e("AnimationType",l),(t=c=c||{})[t.Hidden=0]="Hidden",t[t.Unlit=1]="Unlit",t[t.Normal=2]="Normal",t[t.Active=3]="Active",e("MenuButtonState",c),e("MenuSlotAnimationRunner",class{constructor(e=0){this.delayFrames=e,this.buttonState=c.Hidden,this.collapsed=!0,this.currentAnimationType=l.None}slideIn(){this.currentAnimationType=l.SlideIn,this.initAnimation()}slideOut(){this.currentAnimationType=l.SlideOut,this.initAnimation()}initAnimation(){var e=new i.IniSection("");let t=new n.AnimProps(e,new r.ShpFile);t.loopEnd=5,e=new s.Animation(t,new o.BoxedVar(a.Engine.UI_ANIM_SPEED)),this.animation=e}tick(e){let t=this.animation;var i=this.currentAnimationType;if(t&&i!==l.None){switch(t.getState()){case s.AnimationState.STOPPED:break;case s.AnimationState.NOT_STARTED:t.start(e,this.delayFrames);case s.AnimationState.RUNNING:default:t.update(e)}t.getState()===s.AnimationState.STOPPED&&(this.collapsed=i===l.SlideOut,this.currentAnimationType=l.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===l.None}getCurrentFrame(){if(this.currentAnimationType!==l.None&&this.animation.getState()!==s.AnimationState.DELAYED){var e=this.currentAnimationType===l.SlideIn?-1:1;let t=this.buttonState!==c.Hidden?5:11;return-1==e&&(t+=5),t+e*this.animation.getCurrentFrame()}let t;if(this.collapsed)t=this.buttonState===c.Hidden?16:10;else if(this.buttonState===c.Hidden)t=0;else if(this.buttonState===c.Unlit)t=1;else if(this.buttonState===c.Normal)t=2;else{if(this.buttonState!==c.Active)throw new Error(`Unknown buttonState "${this.buttonState}"`);t=4}return t}})}}})),System.register("engine/renderable/builder/CanvasTextureAtlas",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CanvasTextureAtlas",class{getTexture(){if(!this.texture)throw new Error("Texture atlas not initialized");return this.texture}getImageRect(e){if(!this.imageRects)throw new Error("Texture atlas not initialized");var t=this.imageRects.get(e);if(!t)throw new Error("Image not found in atlas");return t}pack(e){let t=[];e.forEach((e=>{t.push({w:e.width,h:e.height,image:e})})),t.sort(((e,t)=>1e3*(t.w-e.w)+t.h-e.h));let i=new GrowingPacker;i.fit(t);var r=i.root.w,s=i.root.h;let n=document.createElement("canvas"),a=n.getContext("2d",{alpha:!0});n.width=r,n.height=s;let o=new Map;t.forEach((e=>{if(!e.fit)throw new Error("Couldn't fit all images in a single texture");var t=e.image,i=e.fit.x,r=e.fit.y;o.set(t,{x:i,y:r,width:e.w,height:e.h}),a.drawImage(t,i,r)}));let l=new THREE.Texture(n);l.minFilter=THREE.NearestFilter,l.magFilter=THREE.NearestFilter,l.needsUpdate=!0,this.texture=l,this.imageRects=o}})}}})),System.register("engine/renderable/builder/CanvasSpriteBuilder",["engine/gfx/SpriteUtils","engine/renderable/builder/CanvasTextureAtlas"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("CanvasSpriteBuilder",s=class e{constructor(e,t){this.images=e,this.camera=t,this.offset={x:0,y:0},this.align={x:0,y:0},this.opacity=1,this.forceTransparent=!1,this.frustumCulled=!1,this.frameGeometries=new Map,this.setFrame(0)}static clearCaches(){e.textureCache.clear()}setOffset(e){this.offset=e}setAlign(e,t){var r;this.align={x:e,y:t},this.mesh&&(this.frameGeometries.get(this.frameNo)?.dispose(),r=i.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(this.frameNo,r),this.mesh.geometry=r)}initTexture(){if(e.textureCache.has(this.images))this.atlas=e.textureCache.get(this.images);else{let t=new r.CanvasTextureAtlas;t.pack(this.images),e.textureCache.set(this.images,t),this.atlas=t}}getSpriteGeometryOptions(){var e=this.images[this.frameNo],t={x:-e.width/2-this.align.x*(e.width/2)+this.offset.x,y:-e.height/2-this.align.y*(e.height/2)+this.offset.y};return{texture:this.atlas.getTexture(),textureArea:this.atlas.getImageRect(e),align:{x:1,y:-1},offset:t,camera:this.camera}}setFrame(e){if(this.frameNo!==e&&(this.frameNo=e,this.mesh)){let t=this.frameGeometries.get(e);t||(t=i.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions()),this.frameGeometries.set(e,t)),this.mesh.geometry=t}}getFrame(){return this.frameNo}getSize(){return{width:this.images[this.frameNo].width,height:this.images[this.frameNo].height}}get frameCount(){return this.images.length}setOpacity(e){var t=this.opacity;t!==e&&(this.opacity=e,this.mesh&&(this.mesh.material.opacity=e),Math.floor(t)===Math.floor(e)||this.forceTransparent||this.updateTransparency())}setForceTransparent(e){this.forceTransparent!==e&&(this.forceTransparent=e,this.updateTransparency())}updateTransparency(){this.mesh&&(this.mesh.material.transparent=this.forceTransparent||this.opacity<1)}setExtraLight(e){throw new Error("Not implemented")}setFrustumCulled(e){this.frustumCulled=e,this.mesh&&(this.mesh.frustumCulled=e)}build(){if(this.mesh)return this.mesh;this.initTexture();var e=i.SpriteUtils.createSpriteGeometry(this.getSpriteGeometryOptions());this.frameGeometries.set(this.frameNo,e);var t=new THREE.MeshBasicMaterial({map:this.atlas.getTexture(),flatShading:!0,opacity:this.opacity,transparent:this.opacity<1||this.forceTransparent});let r=new THREE.Mesh(e,t);return r.matrixAutoUpdate=!1,r.frustumCulled=this.frustumCulled,this.mesh=r,r}dispose(){this.frameGeometries.forEach((e=>e.dispose())),this.mesh?.material?.dispose()}}),s.textureCache=new Map}}})),System.register("gui/jsx/JsxRenderer",["gui/jsx/jsx","gui/UiObjectSprite","gui/UiObject","gui/HtmlContainer","engine/renderable/builder/CanvasSpriteBuilder","gui/ShpSpriteBatch"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=e=>!!e.images,e("JsxRenderer",class{constructor(e,t,i,c){this.images=e,this.palettes=t,this.camera=i,this.jsxIntrinsicRenderers={sprite:e=>{let t;if(l(e)){let i=new a.CanvasSpriteBuilder(e.images,this.camera);i.setAlign(e.alignX??0,e.alignY??0),t=new r.UiObjectSprite(i)}else{var i="string"==typeof e.image?this.getImage(e.image):e.image,s="string"==typeof e.palette?this.getPalette(e.palette):e.palette;t=r.UiObjectSprite.fromShpFile(i,s,this.camera)}return c&&t.setPointerEvents(c),this.setupListeners(t,e),e.onFrame&&t.onFrame.subscribe(e.onFrame),t.setPosition(e.x||0,e.y||0),void 0!==e.frame&&t.setFrame(e.frame),e.animationRunner&&t.setAnimationRunner(e.animationRunner),e.hidden&&t.setVisible(!1),e.zIndex&&t.setZIndex(e.zIndex),void 0!==e.opacity&&t.setOpacity(e.opacity),void 0!==e.transparent&&t.setTransparent(e.transparent),void 0!==e.tooltip&&t.setTooltip(e.tooltip),{obj:t}},"sprite-batch":e=>{let t=[];t=e.children?Array.isArray(e.children)?e.children.flat():[e.children]:[];let i=[],r=[];for(var s of t)"sprite"===s.type&&s.props.static&&!l(s.props)?r.push(s.props):i.push(s);return{obj:new o.ShpSpriteBatch(r,(e=>this.getImage(e)),(e=>this.getPalette(e)),this.camera),children:[...i]}},container:e=>{let t=new s.UiObject(new THREE.Object3D,new n.HtmlContainer);return c&&t.setPointerEvents(c),this.setupListeners(t,e),e.onFrame&&t.onFrame.subscribe(e.onFrame),e.hidden&&t.setVisible(!1),e.zIndex&&t.setZIndex(e.zIndex),t.setPosition(e.x||0,e.y||0),t.getHtmlContainer()?.setSize(e.width||0,e.height||0),{obj:t}},mesh:e=>{let t=new s.UiObject(e.children);return c&&t.setPointerEvents(c),this.setupListeners(t,e),t.setPosition(e.x||0,e.y||0),e.zIndex&&t.setZIndex(e.zIndex),e.hidden&&t.setVisible(!1),{obj:t}}}}setupListeners(e,t){const i={click:"onClick",dblclick:"onDoubleClick",mousedown:"onMouseDown",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",mouseover:"onMouseOver",mouseup:"onMouseUp",mousemove:"onMouseMove",wheel:"onWheel"};Object.keys(i).forEach((r=>{var s=t[i[r]];s&&e.addEventListener(r,s)}))}setCamera(e){this.camera=e}getImage(e){var t=this.images.get(e);if(!t)throw new Error(`Missing image "${e}"`);return t}getPalette(e){var t=this.palettes.get(e);if(!t)throw new Error(`Missing palette "${e}"`);return t}render(e){return i.renderJsx(e,this.jsxIntrinsicRenderers)}})}}})),System.register("gui/HtmlReactElement",["react","react-dom","gui/HtmlContainer"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.HtmlContainer{constructor(e,t){super(),this.options=e,this.Component=t}static factory(e,t){return new this(t,e)}render(){var e;this.isRendered()||(e=document.createElement("div"),this.setElement(e),this.renderReactElement()),super.render()}renderReactElement(){r.default.render(i.default.createElement(this.Component,this.options),this.getElement())}applyOptions(e){e(this.options),this.refresh()}refresh(){this.isRendered()&&this.renderReactElement()}unrender(){var e=this.getElement();e&&this.isRendered()&&r.default.unmountComponentAtNode(e),super.unrender()}},e("HtmlReactElement",n)}}})),System.register("gui/jsx/HtmlView",["gui/jsx/UiComponent","gui/UiObject","gui/HtmlReactElement"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends i.UiComponent{createUiObject(e){let t=s.HtmlReactElement.factory(this.props.component,this.props.props);t.setSize(e.width||0,e.height||0);let i=new r.UiObject(new THREE.Object3D,t);return i.setPosition(e.x||0,e.y||0),e.hidden&&i.setVisible(!1),this.props.innerRef?.(t),i}getElement(){return this.getUiObject().getHtmlContainer()}},e("HtmlView",n)}}})),System.register("gui/screen/mainMenu/component/MenuMpSlotAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===i.AnimationType.None||this.animation.getState()===r.AnimationState.DELAYED)return this.collapsed?6:0;{var e=this.currentAnimationType===i.AnimationType.SlideIn?-1:1;let t=1;return-1==e&&(t+=5),t+e*this.animation.getCurrentFrame()}}},e("MenuMpSlotAnimRunner",s)}}})),System.register("gui/screen/mainMenu/component/MenuMpSlotText",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MenuMpSlotText",(({text:e})=>i.default.createElement("pre",{className:"menu-mp-slot-text"},e)))}}})),System.register("gui/screen/mainMenu/component/MenuSdTopAnimRunner",["gui/screen/mainMenu/component/MenuSlotAnimationRunner","engine/Animation"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.MenuSlotAnimationRunner{getCurrentFrame(){if(this.currentAnimationType===i.AnimationType.None||this.animation.getState()===r.AnimationState.DELAYED)return this.collapsed?5:0;{var e=this.currentAnimationType===i.AnimationType.SlideIn?-1:1;let t=0;return-1==e&&(t+=5),t+e*this.animation.getCurrentFrame()}}},e("MenuSdTopAnimRunner",s)}}})),System.register("gui/screen/mainMenu/component/SidebarTitle",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SidebarTitle",(({title:e})=>i.default.createElement("div",{className:"sidebar-title"},e)))}}})),System.register("gui/screen/mainMenu/component/SidebarPreview",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuSdTopAnimRunner","data/IniSection","engine/AnimProps","engine/Animation","engine/animation/SimpleRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/SidebarTitle","engine/Engine","util/BoxedVar"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class extends r.UiComponent{constructor(){super(...arguments),this.sidebarPreviewNeedsRefresh=!1,this.closed=this.props.closed,this.preview=this.props.preview,this.title=this.props.title}createUiObject(){let e=new s.UiObject(new THREE.Object3D,new n.HtmlContainer);return e.onFrame.subscribe((e=>this.handleFrame(e))),e}defineChildren(){var{sdtpImg:e,sdtpAnimImg:t}=this.props,r=this.closed;let s=this.preview;var n=this.title||"",m=new o.IniSection("");let f=new l.AnimProps(m,t);f.loopCount=-1,m=new c.Animation(f,new p.BoxedVar(g.Engine.UI_ANIM_SPEED));let y=new h.SimpleRunner;return y.animation=m,m=this.getPreviewSize(),i.jsx("fragment",null,i.jsx("sprite",{image:e,palette:"shell.pal",frame:r?0:1,ref:e=>this.sidebarTop=e}),i.jsx(u.HtmlView,{component:d.SidebarTitle,props:{title:n},innerRef:e=>this.titleView=e,x:25,y:3,width:118,height:this.closed?32:18}),i.jsx("sprite",{image:"sdwrntmp.shp",palette:"shell.pal",hidden:!0,ref:e=>this.sidebarTopPreviewAnim=e,animationRunner:new a.MenuSdTopAnimRunner}),i.jsx("sprite",{image:t,palette:"shell2.pal",x:38,y:48,hidden:!r,ref:e=>this.sidebarTopClosedAnim=e,animationRunner:y}),i.jsx("container",{hidden:!s||r,ref:e=>{this.previewContainer=e,s&&this.previewContainer.add(s)},x:12,y:40,width:m.width,height:m.height}))}getPreviewSize(){return{width:146,height:112}}toggleSidebarPreview(e){if(this.closed!==!e){let t=this.sidebarTopPreviewAnim.getAnimationRunner();e?t.slideIn():t.slideOut(),this.closed=!e,this.sidebarPreviewNeedsRefresh=!0,this.sidebarTopPreviewAnim.setVisible(!0),(e?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!1),this.titleView.setVisible(!1),this.updateTitleSize()}}setPreview(e){this.preview&&this.previewContainer.remove(this.preview),e&&this.previewContainer.add(e),this.preview=e}setTitle(e){this.title=e,this.titleView.applyOptions((t=>t.title=e)),this.updateTitleSize()}updateTitleSize(){this.titleView.setSize(this.titleView.getSize().width,this.closed?32:18)}handleFrame(e){if(this.sidebarPreviewNeedsRefresh){this.sidebarTopPreviewAnim.getAnimationRunner().isStopped()&&((this.closed?this.sidebarTopClosedAnim:this.previewContainer).setVisible(!0),this.sidebarTopPreviewAnim.setVisible(!1),this.sidebarTop.setFrame(this.closed?0:1),this.titleView.setVisible(!0),this.sidebarPreviewNeedsRefresh=!1)}}},e("SidebarPreview",m)}}})),System.register("gui/screen/mainMenu/component/MenuTooltip",["react","classnames"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("MenuTooltip",(({monitorContainer:e})=>{const[t,s]=i.useState(""),[n,a]=i.useState(!1);return i.useEffect((()=>{let t,i=e.getElement();const r=e=>{let r=e.target;if(r!==t){t=r;let e=r.getAttribute("data-r-tooltip");for(;r&&r!==i&&!e;)r=r.parentElement,e=r.getAttribute("data-r-tooltip");s(e||"")}};return i.addEventListener("mousemove",r),i.addEventListener("mouseleave",r),()=>{i.removeEventListener("mousemove",r),i.removeEventListener("mouseleave",r)}}),[]),i.useEffect((()=>{a(!1);const e=setTimeout((()=>a(!0)),10);return()=>clearTimeout(e)}),[t]),i.default.createElement("div",{className:r.default("menu-tooltip",{anim:n})},t)}))}}})),System.register("gui/screen/mainMenu/component/VersionString",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("VersionString",(({value:e})=>i.default.createElement("div",{className:"menu-version-string"},"v",e)))}}})),System.register("gui/screen/mainMenu/component/MainMenu",["gui/jsx/jsx","gui/UiObject","gui/HtmlContainer","gui/screen/mainMenu/component/MenuVideo","gui/component/MenuButton","util/event","gui/screen/mainMenu/component/MenuSlotAnimationRunner","gui/jsx/HtmlView","gui/screen/mainMenu/component/MenuMpSlotAnimRunner","gui/screen/mainMenu/component/MenuMpSlotText","gui/screen/mainMenu/component/SidebarPreview","gui/screen/mainMenu/component/MenuTooltip","gui/screen/mainMenu/component/VersionString"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class extends r.UiObject{constructor(e,t,i,r){super(new THREE.Object3D,new s.HtmlContainer),this.viewport=e,this.images=t,this.jsxRenderer=i,this.videoSrc=r,this.rootObjects=[],this.sidebarObjects=[],this.sidebarSlots=[],this.sidebarMpSlotEnabled=!1,this.sidebarButtons=[],this.sidebarButtonConfigs=[],this.sidebarCollapsed=!0,this._onSidebarToggle=new o.EventDispatcher,this.create3DObject()}get onSidebarToggle(){return this._onSidebarToggle}setViewport(e){this.viewport=e,this.setPosition(this.viewport.x,this.viewport.y);var t=this.getImage("lwscrnl.shp");this.statusBar.setPosition(0,this.viewport.height-t.height);var i=this.getImage("sdtp.shp");t=this.computeSidebarViewport(i);this.sidebarContainer.setPosition(t.x,t.y),this.sidebarContainer.remove(...this.sidebarObjects),this.sidebarObjects.forEach((e=>e.destroy())),this.createSidebarButtons(this.computeSidebarButtonsViewport(i)),this.updateButtons(this.sidebarButtonsRawConfigs??[]),this.sidebarCollapsed||this.showButtons()}setContentComponent(e){let t=this.mainContainer;this.contentComponent&&(t.remove(this.contentComponent),this.contentComponent.destroy(),this.contentComponent=void 0),e&&(t.add(e),this.contentComponent=e)}setSlots(e,t,i=!1){let r=this.sidebarSlots.length;if(!r)throw new Error("Cannot call setButtons prior to render");this.sidebarMpSlotContainer.setVisible(i),this.sidebarSlots[0].setVisible(!i),this.sidebarSlots.forEach(((s,n)=>{let a=s.getAnimationRunner();a.buttonState=n<e+(i?1:0)||n===r-1&&t?l.MenuButtonState.Unlit:l.MenuButtonState.Hidden}))}setButtons(e,t=!1){this.sidebarButtonsRawConfigs=e,this.sidebarMpSlotEnabled=t,this.updateButtons(e)}updateButtons(e){let t=this.sidebarMpSlotEnabled;var i=!!e.find((e=>!!e.isBottom));this.setSlots(e.length-(i?1:0),i,t),this.updateSidebarMpText(),this.sidebarButtons.forEach((e=>e.applyOptions((e=>e.buttonConfig=void 0)))),e.forEach(((e,i)=>{var r=e.isBottom?this.sidebarButtons.length-1:t?i+1:i;this.sidebarButtonConfigs[r]=e,this.sidebarButtons[r]?.applyOptions((t=>t.buttonConfig={label:e.label,tooltip:e.tooltip,disabled:!!e.disabled}))})),this.sidebarNeedsRefresh=!0}isSidebarCollapsed(){return this.sidebarCollapsed}showButtons(){this.sidebarCollapsed=!1,this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideIn(),this.sidebarSlots.forEach((e=>{e.getAnimationRunner().slideIn()}))}hideButtons(){this.sidebarCollapsed=!0,this.updateSidebarButtons(),this.sidebarNeedsRefresh=!0,this.sidebarMpSlot.getAnimationRunner().slideOut(),this.sidebarSlots.forEach((e=>{e.getAnimationRunner().slideOut()}))}setSidebarTitle(e){this.sidebarPreview.setTitle(e)}toggleSidebarPreview(e){this.sidebarPreview.toggleSidebarPreview(e)}setSidebarPreview(e){this.sidebarPreviewInner&&this.sidebarPreviewInner.destroy(),this.sidebarPreview.setPreview(e),this.sidebarPreviewInner=e}getSidebarPreviewSize(){return this.sidebarPreview.getPreviewSize()}toggleVideo(e){if(!this.menuVideo)throw new Error("Cannot call toggleVideo prior to render");this.menuVideo.getUiObject().setVisible(e)}showVersion(e){this.version.getUiObject().setVisible(!0),this.version.getElement().applyOptions((t=>t.value=e))}hideVersion(){this.version.getUiObject().setVisible(!1)}setSidebarMpText(e){this.sidebarMpSlotText=e,this.updateSidebarMpText()}updateSidebarMpText(){this.sidebarMpSlotTextEl.applyOptions((e=>e.text=this.sidebarMpSlotText))}getImage(e){var t=this.images.get(e);if(!t)throw new Error(`Missing image "${e}"`);return t}create3DObject(){var e,t,r,s,a;super.create3DObject(),this.rootObjects.length||(this.setPosition(this.viewport.x,this.viewport.y),e=this.getImage("mnscrnl.shp"),t=this.getImage("lwscrnl.shp"),r=this.getImage("sdtp.shp"),s=this.getImage("sdwrnanm.shp"),a=this.computeSidebarViewport(r),this.rootObjects=this.jsxRenderer.render(i.jsx("fragment",null,i.jsx("container",{width:e.width,height:e.height,ref:e=>this.mainContainer=e},i.jsx("sprite",{image:e,palette:"shell.pal"}),i.jsx(c.HtmlView,{component:n.MenuVideo,props:{src:this.videoSrc},hidden:!0,ref:e=>this.menuVideo=e})),i.jsx("container",{x:0,y:this.viewport.height-t.height,ref:e=>this.statusBar=e},i.jsx("sprite",{image:t,palette:"shell.pal"}),i.jsx(c.HtmlView,{component:g.MenuTooltip,props:{monitorContainer:this.getHtmlContainer()},width:t.width,height:t.height})),i.jsx("container",{x:a.x,y:a.y,ref:e=>this.sidebarContainer=e},i.jsx(d.SidebarPreview,{sdtpImg:r,sdtpAnimImg:s,closed:!0,ref:e=>this.sidebarPreview=e}),i.jsx(c.HtmlView,{component:p.VersionString,props:{value:""},width:a.width,y:a.height-20,ref:e=>this.version=e,hidden:!0})))),this.add(...this.rootObjects),this.createSidebarButtons(this.computeSidebarButtonsViewport(r)))}createSidebarButtons(e){let t=this.getImage("sdbtnbkgd.shp"),r=this.getImage("sdbtnanm.shp");var s=Math.floor(e.height/t.height);let n=this.getImage("sdbtm.shp");var o=e.height-t.height*s;o=n.clip(n.width,o);this.sidebarSlots=[],this.sidebarButtons=[],this.sidebarObjects=this.jsxRenderer.render(i.jsx("fragment",null,new Array(s).fill(0).map(((s,n)=>{let o=new l.MenuSlotAnimationRunner(n);return i.jsx("fragment",null,i.jsx("container",{x:e.x,y:e.y+t.height*n},i.jsx("sprite",{image:t,palette:"shell2.pal"}),n?[]:i.jsx("container",{zIndex:1,hidden:!0,ref:e=>this.sidebarMpSlotContainer=e,x:12,y:-t.height},i.jsx("sprite",{image:"sdmpbtn.shp",palette:"shell.pal",ref:e=>this.sidebarMpSlot=e,animationRunner:new h.MenuMpSlotAnimRunner}),i.jsx(c.HtmlView,{component:u.MenuMpSlotText,props:{text:""},width:146,height:2*t.height,innerRef:e=>this.sidebarMpSlotTextEl=e})),i.jsx("sprite",{image:r,palette:"sdbtnanm.pal",ref:e=>this.sidebarSlots.push(e),x:12,animationRunner:o}),i.jsx(c.HtmlView,{x:12,hidden:!0,innerRef:e=>this.sidebarButtons.push(e),component:a.MenuButton,props:{box:{x:0,y:0,width:146,height:r.height},onMouseDown:()=>{o.buttonState=l.MenuButtonState.Active;let e=()=>{o.buttonState=l.MenuButtonState.Normal,document.removeEventListener("mouseup",e)};document.addEventListener("mouseup",e)},onClick:()=>{this.onSidebarButtonClick(n)}}})))})),i.jsx("sprite",{image:o,palette:"shell.pal",x:e.x,y:e.y+t.height*s}))),this.sidebarContainer.add(...this.sidebarObjects)}computeSidebarViewport(e){return{x:this.viewport.width-e.width,y:0,width:e.width,height:this.viewport.height}}computeSidebarButtonsViewport(e){return{x:0,y:e.height,width:e.width,height:this.viewport.height-e.height}}update(e){if(super.update(e),this.sidebarNeedsRefresh){this.sidebarSlots[this.sidebarSlots.length-1].getAnimationRunner().isStopped()&&(this.updateSidebarButtons(),this._onSidebarToggle.dispatch(this,!this.sidebarCollapsed))}}updateSidebarButtons(){this.sidebarCollapsed?(this.sidebarButtons.forEach((e=>e.hide())),this.sidebarMpSlotTextEl.hide(),this.sidebarSlots.forEach((e=>{let t=e.getAnimationRunner();t.buttonState===l.MenuButtonState.Normal&&(t.buttonState=l.MenuButtonState.Unlit)}))):(this.sidebarButtons.forEach((e=>e.show())),this.sidebarMpSlotTextEl.show(),this.sidebarSlots.forEach((e=>{let t=e.getAnimationRunner();t.buttonState===l.MenuButtonState.Unlit&&(t.buttonState=l.MenuButtonState.Normal)}))),this.sidebarNeedsRefresh=!1}onSidebarButtonClick(e){const t=this.sidebarButtonConfigs[e].onClick;t&&t()}destroy(){this.sidebarButtons.length=0,this.remove(...this.rootObjects),this.rootObjects.forEach((e=>e.destroy())),this.rootObjects.length=0,super.destroy()}},e("MainMenu",m)}}})),System.register("gui/component/Slider",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Slider",(({getLabel:e,...t})=>{let[r,s]=i.useState((()=>t.value));return i.useEffect((()=>{r!==t.value&&s(t.value)}),[t.value]),i.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"}},i.default.createElement("input",{type:"range",...t,value:r,onChange:e=>{s(e.target.value),t.onChange?.(e)}}),i.default.createElement("input",{type:"text",disabled:!0,readOnly:!0,value:e?.(r)??r}))}))}}})),System.register("data/PcxFile",["pcx-js","engine/gfx/CanvasUtils"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("PcxFile",class{constructor(e){this.file=e;var t=this.file.stream;var r=new i.default(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)).decode();t=r.pixelArray;this.fixAlpha(t),this.width=r.width,this.height=r.height,this.data=t}async toPngBlob(){var e=this.toCanvas();return await r.CanvasUtils.canvasToBlob(e)}toDataUrl(){return this.toCanvas().toDataURL()}toCanvas(){return r.CanvasUtils.canvasFromRgbaImageData(this.data,this.width,this.height)}fixAlpha(e){for(let t=0,i=e.length;t<i;t+=4)255===e[t]&&0===e[t+1]&&255===e[t+2]&&(e[t+3]=0)}})}}})),System.register("gui/component/ImageContext",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("ImageContext",i=class{}),i.imageUrlCache=new Map}}})),System.register("gui/component/Image",["data/Palette","data/PcxFile","data/ShpFile","engine/gfx/ImageUtils","react","gui/component/ImageContext"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("Image",(e=>{const t=o.ImageContext,[l,c]=a.useState("");return a.useEffect((()=>{let a,o;if(t.imageUrlCache.has(e.src))a=t.imageUrlCache.get(e.src);else if(t.vfs?.fileExists(e.src)){var l=e.src.split(".").pop();if("shp"===l){var h,u,d=e.palette;a=t.vfs.fileExists(d)?(h=new s.ShpFile(t.vfs.openFile(e.src)),u=new i.Palette(t.vfs.openFile(d)),n.ImageUtils.convertShpToCanvas(h,u).toDataURL()):(console.warn(`Palette "${d}" not found in VFS"`),"")}else if("pcx"===l){let i=new r.PcxFile(t.vfs.openFile(e.src));a=i.toDataUrl()}else"png"===l?(d=t.vfs.openFile(e.src).stream,d=new Blob([new Uint8Array(d.buffer,d.byteOffset,d.byteLength)],{type:"image/png"}),a=URL.createObjectURL(d),o=()=>{URL.revokeObjectURL(a),t.imageUrlCache.delete(e.src)}):(console.warn(`Unknown image format "${l}"`),a="");t.imageUrlCache.set(e.src,a)}else a=t.cdnBaseUrl?t.cdnBaseUrl+e.src.substring(0,e.src.lastIndexOf("."))+".png":(console.warn(`Image "${e.src}" not found in VFS`),"");return c(a),o}),[e.src]),l?a.default.createElement("img",{src:l}):null}))}}})),System.register("gui/component/CountryIcon",["react","game/gameopts/constants","gui/component/Image"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=(new Map).set("Americans","usai.pcx").set("French","frai.pcx").set("Germans","geri.pcx").set("British","gbri.pcx").set("Russians","rusi.pcx").set("Confederation","lati.pcx").set("Africans","djbi.pcx").set("Arabs","arbi.pcx").set("Alliance","japi.pcx").set(r.RANDOM_COUNTRY_NAME,"rani.pcx").set(r.OBS_COUNTRY_NAME,"obsi.pcx"),a=class extends i.default.Component{render(){var e=n.get(this.props.country);return i.default.createElement("div",{className:"player-country-icon"},e&&i.default.createElement(s.Image,{src:e}))}},e("CountryIcon",a)}}})),System.register("gui/component/Option",["classnames","react"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Option",(({selected:e,disabled:t,label:s,style:n,labelStyle:a,className:o,tooltip:l,onClick:c})=>r.createElement("div",{className:i.default("option",{selected:e,disabled:t},o),style:n,onClick:t?void 0:c,"data-r-tooltip":l},r.createElement("div",{style:a},s))))}}})),System.register("gui/component/Select",["react","classnames","util/dom"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("Select",(({initialValue:e,disabled:t,tooltip:n,className:a,onSelect:o,labelStyle:l,children:c})=>{let[h,u]=i.useState((()=>e)),[d,g]=i.useState((()=>e)),[p,m]=i.useState(!1),f=i.useRef(null);var y,T;return i.useEffect((()=>{h!==e&&(u(e),g(h))}),[e]),i.useEffect((()=>{if(p){g(h);const e=e=>{s.contains(f.current,e.target)||m(!1)};return document.addEventListener("click",e),()=>{document.removeEventListener("click",e)}}}),[p]),i.default.createElement("div",{style:{display:"inline-block",verticalAlign:"middle"},className:a},i.default.createElement("div",{className:r.default("select",{disabled:t}),"data-r-tooltip":n,ref:f},i.default.createElement("div",{className:"select-value",onClick:()=>!t&&m(!p)},i.default.createElement("div",{style:l?.(h)},(y=h,(T=i.default.Children.toArray(c).find((e=>e.props.value===y)))?T.props.label:""))),p&&i.default.createElement("div",{className:"select-layer"},i.default.Children.map(c,(e=>{if(!e)return null;const t=e.props.value,r=e.props.disabled;return i.default.createElement("div",{onMouseEnter:()=>!r&&g(t)},i.default.cloneElement(e,{selected:t===d,labelStyle:l?.(t),onClick:()=>{var e;u(e=t),g(e),o(e),m(!1)}}))})))))}))}}})),System.register("gui/component/CountrySelect",["react","gui/component/CountryIcon","gui/component/Select","gui/component/Option"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("CountrySelect",(({country:e,availableCountries:t,onlyIcon:a,disabled:o,strings:l,countryUiNames:c,countryUiTooltips:h,onSelect:u})=>{let[d,g]=i.useState((()=>e));return i.useEffect((()=>{d!==e&&g(e)}),[e]),i.default.createElement("div",{className:"country-select"},i.default.createElement("div",{className:"player-country-icon","data-r-tooltip":l.get("STT:HostPictureFlag")},i.default.createElement(r.CountryIcon,{country:d})),a?null:i.default.createElement(s.Select,{className:"player-country-select",tooltip:l.get("STT:HostComboCountry"),initialValue:d,disabled:o,onSelect:e=>{g(e),u(e)}},(o?[d]:t).map((e=>{var t=l.get(c.get(e)||e),r=h.has(e)?l.get(h.get(e)):void 0;return i.default.createElement(n.Option,{key:e,value:e,label:t,tooltip:r})}))))}))}}})),System.register("gui/component/ColorSelect",["react","classnames","gui/component/Select","gui/component/Option"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ColorSelect",(({color:e,disabled:t,availableColors:a,onSelect:o,strings:l})=>{let[c,h]=i.useState((()=>e));return i.useEffect((()=>{c!==e&&h(e)}),[e]),i.default.createElement(s.Select,{className:r.default("player-color-select",{"bg-color":!!c}),tooltip:l.get("STT:HostComboColor"),initialValue:c||"random",disabled:t,labelStyle:e=>({backgroundColor:"random"!==e?e:"transparent"}),onSelect:e=>{"random"===e&&(e=""),h(e),o?.(e)}},(t?[c]:a).map((e=>i.default.createElement(n.Option,{key:e,value:e||"random",label:e?"":l.get("GUI:RandomAsSymbols"),className:r.default({"bg-color":!!e})}))))}))}}})),System.register("gui/component/PingIndicator",["react","gui/component/Image"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.Good=1]="Good",t[t.Average=2]="Average",t[t.Bad=3]="Bad",n=e=>e<=100?s.Good:e<=250?s.Average:s.Bad,a=(new Map).set(s.Bad,"pingr").set(s.Average,"pingy").set(s.Good,"pingg"),e("PingIndicator",(({ping:e,strings:t})=>{var s=void 0!==e?t.get("Msg:PingInfo",e):void 0;return i.default.createElement("div",{className:"ping-indicator","data-r-tooltip":s,title:s},void 0!==e?i.default.createElement(r.Image,{src:a.get(n(e))+".pcx"}):null)}))}}})),System.register("gui/component/StartPosSelect",["react","gui/component/Select","game/gameopts/constants","gui/component/Option"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("StartPosSelect",(({startPos:e,disabled:t,availableStartPositions:a,onSelect:o,strings:l})=>{let c=[...new Set([e,...a]).values()].sort();return i.default.createElement(r.Select,{className:"player-start-pos-select",initialValue:""+e,disabled:t,tooltip:l.get("STT:HostComboStart"),onSelect:e=>{o?.(Number(e))}},c.map((e=>i.default.createElement(n.Option,{key:e,value:""+e,label:e===s.RANDOM_START_POS?l.get("GUI:RandomAsSymbols"):""+(e+1)}))))}))}}})),System.register("gui/component/TeamSelect",["react","gui/component/Select","gui/component/Option","game/gameopts/constants"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=e=>String.fromCharCode("A".charCodeAt(0)+e),e("TeamSelect",(({teamId:e,required:t,disabled:o,maxTeams:l,onSelect:c,strings:h})=>{let u=new Array(l).fill(0).map(((e,t)=>t));return i.default.createElement(r.Select,{className:"player-team-select",initialValue:""+e,disabled:o,tooltip:h.get("STT:HostComboTeam"),onSelect:e=>{c?.(Number(e))}},!t&&i.default.createElement(s.Option,{value:""+n.NO_TEAM_ID,label:h.get("GUI:NoneAsSymbols")}),u.map((e=>i.default.createElement(s.Option,{key:e,value:""+e,label:a(e)}))))}))}}})),System.register("gui/screen/mainMenu/lobby/component/RankIndicator",["react","gui/component/Image","network/PlayerRankType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=(new Map).set(s.PlayerRankType.Private,"private").set(s.PlayerRankType.Corporal,"corporal").set(s.PlayerRankType.Sergeant,"sergeant").set(s.PlayerRankType.Lieutenant,"lieutena").set(s.PlayerRankType.Major,"major").set(s.PlayerRankType.Colonel,"colonel").set(s.PlayerRankType.BrigGeneral,"briggenr").set(s.PlayerRankType.General,"general").set(s.PlayerRankType.FiveStarGeneral,"stargen").set(s.PlayerRankType.CommanderInChief,"comchief"),a=(new Map).set(s.PlayerRankType.Private,"GUI:RankPrivate").set(s.PlayerRankType.Corporal,"GUI:RankCorporal").set(s.PlayerRankType.Sergeant,"GUI:RankSergeant").set(s.PlayerRankType.Lieutenant,"GUI:RankLieutenant").set(s.PlayerRankType.Major,"GUI:RankMajor").set(s.PlayerRankType.Colonel,"GUI:RankColonel").set(s.PlayerRankType.BrigGeneral,"GUI:RankBrigGeneral").set(s.PlayerRankType.General,"GUI:RankGeneral").set(s.PlayerRankType.FiveStarGeneral,"GUI:RankFiveStar").set(s.PlayerRankType.CommanderInChief,"GUI:RankCmdInChief"),e("RankIndicator",(({playerProfile:e,strings:t})=>{var s=e?.rankType,o=e?void 0!==e.rankType?`${e.name} : ${t.get("GUI:Rank")} ${e.rank} (${t.get(a.get(e.rankType))})`:e.name+" : "+t.get("TXT_UNRANKED"):void 0;return i.default.createElement("div",{className:"rank-indicator","data-r-tooltip":o},void 0!==s?i.default.createElement(r.Image,{src:n.get(s)+".pcx"}):null)}))}}})),System.register("gui/screen/mainMenu/lobby/component/LobbyForm",["react","classnames","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/component/Slider","gui/component/Chat","gui/component/CountrySelect","gui/component/ColorSelect","gui/component/PingIndicator","game/gameopts/GameOpts","gui/component/Image","gui/component/StartPosSelect","gui/component/TeamSelect","game/gameopts/constants","gui/component/Select","gui/component/Option","util/typeGuard","gui/screen/mainMenu/lobby/component/RankIndicator"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e}],execute:function(){v=class extends i.default.Component{constructor(){super(...arguments),this.onPlayerSelect=(e,t)=>{let i,r;e.match(/^\d+$/)?i=Number(e):(i=s.SlotOccupation.Occupied,r=h.AiDifficulty[e]),this.props.onSlotChange(i,t,r)}}render(){let{strings:e,lobbyType:t,mpDialogSettings:o}=this.props;var l=t===s.LobbyType.Singleplayer||t===s.LobbyType.MultiplayerHost,c=t===s.LobbyType.Singleplayer;let h=this.props;return i.default.createElement("div",{className:r.default("lobby-form",{"lobby-form-sp":c})},i.default.createElement("div",{className:"player-slots"},i.default.createElement("div",{className:"player-slot player-slot-header"},i.default.createElement("div",{className:"player-header-players"},e.get("GUI:Players")),i.default.createElement("div",{className:"player-header-side"},e.get("GUI:Side")),i.default.createElement("div",{className:"player-header-color"},e.get("GUI:Color")),i.default.createElement("div",{className:"player-header-position"},e.get("GUI:StartPosition")),i.default.createElement("div",{className:"player-header-team"},e.get("GUI:Team"))),h.playerSlots.map(((e,t)=>this.renderPlayerSlot(h,e,t)))),i.default.createElement("div",{className:"game-options"},i.default.createElement("div",{className:"game-options-left"},i.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxShortGame")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"shortGame",checked:h.shortGame,onChange:e=>this.props.onToggleShortGame(e.target.checked),disabled:!l})," ",i.default.createElement("span",null,e.get("GUI:ShortGame")))),i.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxRedeploys")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"mcvRepacks",checked:h.mcvRepacks,onChange:e=>this.props.onToggleMcvRepacks(e.target.checked),disabled:!l})," ",i.default.createElement("span",null,e.get("GUI:MCVRepacks")))),i.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxCrates")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"cratesAppear",checked:h.cratesAppear,onChange:e=>this.props.onToggleCratesAppear(e.target.checked),disabled:!l})," ",i.default.createElement("span",null,e.get("GUI:CratesAppear")))),i.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxSWAllowed")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"superWeapons",checked:h.superWeapons,onChange:e=>this.props.onToggleSuperWeapons(e.target.checked),disabled:!l})," ",i.default.createElement("span",null,e.get("GUI:SuperWeaponsAllowed")))),void 0!==h.hostTeams&&i.default.createElement("div",{"data-r-tooltip":e.get("STT:HostCBoxHostTeams")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"hostTeams",checked:h.hostTeams,onChange:e=>this.props.onToggleHostTeams?.(e.target.checked),disabled:!l})," ",i.default.createElement("span",null,e.get("GUI:HostTeams"))))),i.default.createElement("div",{className:"game-options-right"+(l?"":" all-disabled")},i.default.createElement("div",{className:"slider-item"},i.default.createElement("span",{className:"label"},e.get("GUI:GameSpeed")),i.default.createElement(n.Slider,{name:"gameSpeed",min:0,max:6,value:""+h.gameSpeed,disabled:!l,"data-r-tooltip":e.get("STT:HostSliderSpeed"),onChange:e=>this.props.onChangeGameSpeed(Number(e.target.value))})),i.default.createElement("div",{className:"slider-item"},i.default.createElement("span",{className:"label"},e.get("GUI:Credits")),i.default.createElement(n.Slider,{name:"credits",min:o.minMoney,max:o.maxMoney,step:o.moneyIncrement,value:""+h.credits,"data-r-tooltip":e.get("STT:HostSliderCredits"),onChange:e=>this.props.onChangeCredits(Number(e.target.value)),disabled:!l})),i.default.createElement("div",{className:"slider-item"},i.default.createElement("span",{className:"label"},e.get("GUI:UnitCount")),i.default.createElement(n.Slider,{name:"unitCount",min:o.minUnitCount,max:o.maxUnitCount,value:""+h.unitCount,"data-r-tooltip":e.get("STT:HostSliderUnit"),onChange:e=>this.props.onChangeUnitCount(Number(e.target.value)),disabled:!l})),i.default.createElement("div",{className:"checkbox-item","data-r-tooltip":e.get("STT:HostCBoxBuildOffAlly")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"buildOffAlly",checked:h.buildOffAlly,disabled:!l,onChange:e=>this.props.onToggleBuildOffAlly(e.target.checked)})," ",i.default.createElement("span",null,e.get("GUI:BuildOffAlly")))))),void 0!==this.props.messages&&void 0!==this.props.localUsername&&this.props.onSendMessage&&i.default.createElement(a.Chat,{messages:this.props.messages,localUsername:this.props.localUsername,channels:this.props.channels??[],chatHistory:this.props.chatHistory,onSendMessage:this.props.onSendMessage,tooltips:{button:e.get("STT:EmoteButton"),input:l?e.get("STT:HostEditInput"):e.get("STT:GuestEditInput"),output:l?e.get("STT:HostEditOutput"):e.get("STT:GuestEditOutput")},strings:e}))}renderPlayerSlot(e,t,r){const n=e.strings;var a=e.lobbyType===s.LobbyType.Singleplayer||e.lobbyType===s.LobbyType.MultiplayerHost;return t?i.default.createElement("div",{className:"player-slot",key:"playerslot"+r},t.type===s.SlotType.Player?i.default.createElement(T.RankIndicator,{playerProfile:t.playerProfile,strings:n}):i.default.createElement(T.RankIndicator,{playerProfile:void 0,strings:n}),i.default.createElement(c.PingIndicator,{ping:t.type===s.SlotType.Player?t.ping:void 0,strings:n}),i.default.createElement("div",{className:"player-status","data-r-tooltip":n.get("STT:HostPictureAcceptance")},this.renderPlayerStatus(t.status)),this.renderPlayerSelect(t,r,e.lobbyType),i.default.createElement(o.CountrySelect,{countryUiNames:e.countryUiNames,countryUiTooltips:e.countryUiTooltips,country:t.country,availableCountries:e.availablePlayerCountries,disabled:r!==e.activeSlotIndex&&(!a||t.type!==s.SlotType.Ai)||t.type===s.SlotType.Observer||t.status===s.PlayerStatus.Ready&&t.type!==s.SlotType.Ai,strings:e.strings,onSelect:e=>this.props.onCountrySelect(e,r)}),t.type!==s.SlotType.Observer?i.default.createElement(i.default.Fragment,null,i.default.createElement(l.ColorSelect,{color:t.color,availableColors:e.availablePlayerColors,disabled:r!==e.activeSlotIndex&&(!a||t.type!==s.SlotType.Ai)||t.status===s.PlayerStatus.Ready&&t.type!==s.SlotType.Ai,strings:e.strings,onSelect:e=>this.props.onColorSelect(e,r)}),i.default.createElement(d.StartPosSelect,{disabled:e.hostTeams?!a||t.occupation!==s.SlotOccupation.Occupied:r!==e.activeSlotIndex&&(!a||t.type!==s.SlotType.Ai)||t.status===s.PlayerStatus.Ready&&t.type!==s.SlotType.Ai,startPos:t.startPos,availableStartPositions:e.availableStartPositions,onSelect:e=>this.props.onStartPosSelect(e,r),strings:e.strings}),i.default.createElement(g.TeamSelect,{disabled:!e.teamsAllowed||(e.hostTeams?!a||t.occupation!==s.SlotOccupation.Occupied:r!==e.activeSlotIndex&&(!a||t.type!==s.SlotType.Ai)||t.status===s.PlayerStatus.Ready&&t.type!==s.SlotType.Ai),teamId:e.teamsAllowed?t.team:p.NO_TEAM_ID,required:e.teamsRequired,maxTeams:4,onSelect:e=>this.props.onTeamSelect(e,r),strings:e.strings})):null):i.default.createElement("div",{className:"player-slot",key:"playerslot"+r})}renderPlayerStatus(e){return e===s.PlayerStatus.Host?i.default.createElement(u.Image,{src:"wolhost.pcx"}):e===s.PlayerStatus.Ready?i.default.createElement(u.Image,{src:"wolacpt.pcx"}):null}renderPlayerSelect(e,t,r){let n=r===s.LobbyType.Singleplayer;var a=n||r===s.LobbyType.MultiplayerHost;if(t===this.props.activeSlotIndex||a&&0===t)return i.default.createElement("input",{type:"text",className:"player-name",value:e.name,readOnly:!0});let o=this.props.strings,l=(new Map).set(s.SlotOccupation.Occupied,e.name||"").set(s.SlotOccupation.Open,o.get(e.type===s.SlotType.Observer?"GUI:OpenObserver":"GUI:Open")).set(s.SlotOccupation.Closed,n?o.get("GUI:None"):o.get("GUI:Closed")),c=e.occupation;return e.occupation===s.SlotOccupation.Occupied&&e.type===s.SlotType.Ai&&(l.delete(s.SlotOccupation.Occupied),c=h.AiDifficulty[e.aiDifficulty]),e.type!==s.SlotType.Observer&&this.props.availableAiNames.forEach(((e,t)=>{l.set(h.AiDifficulty[t],o.get(e))})),i.default.createElement(m.Select,{initialValue:""+c,disabled:!a,onSelect:e=>this.onPlayerSelect(e,t),className:"player-name",tooltip:n?o.get("STT:SkirmishComboAiPlayer"):o.get("STT:HostComboPlayer")},[...l].map((([t,r])=>t===s.SlotOccupation.Occupied&&e.occupation!==s.SlotOccupation.Occupied||t===s.SlotOccupation.Open&&n?null:i.default.createElement(f.Option,{key:t,value:""+t,label:r,tooltip:n?(()=>{let e;return e=t===s.SlotOccupation.Closed?"STT:PlayerNone":p.aiUiTooltips.get(h.AiDifficulty[t]),e?o.get(e):void 0})():void 0}))).filter(y.isNotNullOrUndefined))}},e("LobbyForm",v)}}})),System.register("engine/UiAnimationLoop",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("UiAnimationLoop",class{constructor(e){this.renderer=e,this.isStarted=!1,this.doBackgroundFrame=e=>{this.isStarted&&this.paused&&this.renderer.update(e)},this.doFrame=e=>{if(this.isStarted&&!this.paused){let t=this.renderer.getStats();t&&t.begin(),this.renderer.update(e),this.renderer.render(),t&&t.end(),this.rafId=requestAnimationFrame(this.doFrame)}},this.handleVisibilityChange=()=>{var e=document.hidden;this.paused!==e&&(this.paused=e,this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval((()=>{var e=performance.now();this.doBackgroundFrame(e)}),1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)))}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}})),System.register("tools/LobbyFormTester",["engine/gfx/Renderer","engine/Engine","gui/UiScene","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/component/MainMenu","game/rules/Rules","gui/screen/mainMenu/lobby/component/LobbyForm","engine/UiAnimationLoop","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","game/gameopts/constants"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){e("LobbyFormTester",m=class{static main(e,t){let u=new i.Renderer(800,600);u.init(e),u.initStats(document.body),this.disposables.add(u);let m=s.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add(m);var f={x:Math.max(0,(m.viewport.width-800)/2),y:Math.max(0,(m.viewport.height-600)/2),width:800,height:600};let y=new h.JsxRenderer(r.Engine.getImages(),r.Engine.getPalettes(),m.camera,void 0),T=new a.MainMenu(f,r.Engine.getImages(),y,"dummy.webm");m.add(T);let v=new o.Rules(r.Engine.getRules());var[f]=y.render(d.jsx(g.HtmlView,{x:f.x,y:f.y,component:l.LobbyForm,props:{strings:t,countryUiNames:new Map([["Random","GUI:RandomEx"],["Observer","GUI:Observer"]].concat(v.getMultiplayerCountries().map((e=>[e.name,e.uiName])))),countryUiTooltips:new Map,availablePlayerCountries:["Random"].concat(v.getMultiplayerCountries().map((e=>e.name))),availablePlayerColors:[""].concat([...v.getMultiplayerColors().values()].map((e=>e.asHexString()))),availableAiNames:p.aiUiNames,availableStartPositions:new Array(8).fill(0).map(((e,t)=>t)),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,lobbyType:n.LobbyType.MultiplayerHost,playerSlots:[{name:"Player 1",type:n.SlotType.Player,occupation:n.SlotOccupation.Occupied,country:"French",color:"#2269d4",startPos:p.RANDOM_START_POS,team:p.NO_TEAM_ID,status:n.PlayerStatus.Host,ping:50,playerProfile:{name:"Player 1",rank:2,points:100}},{name:"Player 2",type:n.SlotType.Player,occupation:n.SlotOccupation.Occupied,country:"Russians",color:"#ff1818",startPos:1,team:0,status:n.PlayerStatus.Ready,ping:300},{name:"Open",type:n.SlotType.Player,occupation:n.SlotOccupation.Open,country:"Random",color:"",startPos:p.RANDOM_START_POS,team:p.NO_TEAM_ID,status:n.PlayerStatus.NotReady},{type:n.SlotType.Observer,occupation:n.SlotOccupation.Open,country:"Observer",color:"",startPos:p.RANDOM_START_POS,team:p.NO_TEAM_ID,status:n.PlayerStatus.NotReady}],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,gameSpeed:6,credits:1e4,unitCount:10,messages:[],mpDialogSettings:v.mpDialogSettings,onSendMessage:()=>{},onCountrySelect:e=>{console.log("selected country",e)},onColorSelect:e=>{console.log("selected color",e)},onStartPosSelect:e=>{console.log("selected start pos",e)},onTeamSelect:e=>{console.log("selected team",e)},onSlotChange:(e,t)=>{console.log("changed slot",e,t)},onToggleShortGame:e=>console.log(e),onToggleMcvRepacks:e=>console.log(e),onToggleCratesAppear:e=>console.log(e),onToggleSuperWeapons:e=>console.log(e),onToggleBuildOffAlly:e=>console.log(e),onChangeGameSpeed:e=>console.log(e),onChangeCredits:e=>console.log(e),onChangeUnitCount:e=>console.log(e)}}));T.add(f),u.addScene(m);let b=new c.UiAnimationLoop(u);b.start(),this.disposables.add(b),e.appendChild(m.getHtmlContainer().getElement()),this.disposables.add((()=>e.removeChild(m.getHtmlContainer().getElement())))}static destroy(){this.disposables.dispose()}}),m.disposables=new u.CompositeDisposable}}})),System.register("ConsoleVars",["util/BoxedVar"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ConsoleVars",class{constructor(){this.debugWireframes=new i.BoxedVar(!1),this.debugPaths=new i.BoxedVar(!1),this.debugText=new i.BoxedVar(!1),this.debugBotIndex=new i.BoxedVar(0),this.debugLogging=new i.BoxedVar(!1),this.forceResolution=new i.BoxedVar(void 0),this.freeCamera=new i.BoxedVar(!1),this.fps=new i.BoxedVar(!1),this.cheatsEnabled=new i.BoxedVar(!1)}})}}})),System.register("tools/CameraZoomControls",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CameraZoomControls",class{constructor(e,t){this.pointerEvents=e,this.cameraZoom=t,this.handleWheel=e=>{this.cameraZoom.applyStep(0<e.wheelDeltaY?-.1:.1)}}init(){this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel)}destroy(){this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel)}})}}})),System.register("tools/VxlTester",["data/Palette","data/VxlFile","engine/gfx/Renderer","engine/renderable/WorldScene","engine/renderable/builder/VxlNonBatchedBuilder","engine/UiAnimationLoop","gui/PointerEvents","util/disposable/CompositeDisposable","tools/CameraZoomControls","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=["1tnk.vxl","1tnkbarl.vxl","1tnktur.vxl","2tnk.vxl","2tnkbarl.vxl","2tnktur.vxl","3tnk.vxl","3tnkbarl.vxl","3tnktur.vxl","4tnk.vxl","4tnkbarl.vxl","4tnktur.vxl","aegis.vxl","apache.vxl","apc.vxl","apcw.vxl","art2.vxl","art2barl.vxl","art2tur.vxl","arty.vxl","artybarl.vxl","asw.vxl","axle.vxl","bana.vxl","beag.vxl","bggy.vxl","bike.vxl","bus.vxl","car.vxl","cargocar.vxl","carrier.vxl","cdest.vxl","cdestwo.vxl","cmin.vxl","cmon.vxl","cona.vxl","cop.vxl","cplane.vxl","cruise.vxl","dest.vxl","destwo.vxl","dmisl.vxl","dpod.vxl","dred.vxl","dredwo.vxl","dshp.vxl","euroc.vxl","falc.vxl","flak.vxl","flaktur.vxl","flata.vxl","fortress.vxl","ftnk.vxl","fv.vxl","fvtur.vxl","fvtur1.vxl","fvtur10.vxl","fvtur11.vxl","fvtur12.vxl","fvtur13.vxl","fvtur14.vxl","fvtur2.vxl","fvtur3.vxl","fvtur4.vxl","fvtur5.vxl","fvtur6.vxl","fvtur7.vxl","fvtur8.vxl","fvtur9.vxl","gastank.vxl","gtgcanbarl.vxl","gtgcantur.vxl","gtnk.vxl","gtnkbarl.vxl","gtnktur.vxl","harv.vxl","harvtur.vxl","heli.vxl","hind.vxl","hmec.vxl","hornet.vxl","horv.vxl","htk.vxl","htkbarl.vxl","htktur.vxl","htnk.vxl","htnkbarl.vxl","htnktur.vxl","hvr.vxl","hvrtur.vxl","hwtz.vxl","hyd.vxl","icbm.vxl","jeep.vxl","jeeptur.vxl","laser.vxl","lcrf.vxl","limo.vxl","lpst.vxl","ltnk.vxl","ltnkbarl.vxl","ltnktur.vxl","m113.vxl","m113tur.vxl","mcv.vxl","misl.vxl","mislchem.vxl","mislmlti.vxl","mislorca.vxl","mislsam.vxl","mlrs.vxl","mlrstur.vxl","mmchbarl.vxl","mnly.vxl","monocar.vxl","monoeng.vxl","mrj.vxl","mrjtur.vxl","mtnk.vxl","mtnkbarl.vxl","mtnktur.vxl","mtrb.vxl","mtrs.vxl","mtrt.vxl","orca.vxl","orcab.vxl","orcatran.vxl","outp.vxl","pdplane.vxl","phal.vxl","pick.vxl","piece.vxl","probe.vxl","propa.vxl","ptruck.vxl","pulscan.vxl","repair.vxl","rtnk.vxl","rtnkbarl.vxl","rtnktur.vxl","sam.vxl","sapc.vxl","scrin.vxl","shad.vxl","smcv.vxl","sonic.vxl","sonictur.vxl","sref.vxl","sreftur.vxl","sreftur1.vxl","sreftur2.vxl","sreftur3.vxl","stang.vxl","stnk.vxl","sub.vxl","subt.vxl","subtank.vxl","suvb.vxl","suvw.vxl","taxi.vxl","tire.vxl","tnkd.vxl","tractor.vxl","tran.vxl","trnsport.vxl","trs.vxl","truck2.vxl","trucka.vxl","truckb.vxl","truk.vxl","ttnk.vxl","ttnktur.vxl","tug.vxl","utnk.vxl","v3.vxl","v3rocket.vxl","v3wo.vxl","vlad.vxl","vladwo.vxl","weed.vxl","wini.vxl","wrmn.vxl","zbomb.vxl","zep.vxl"],y=class{constructor(e,t,i,r,s){this.builder=new a.VxlNonBatchedBuilder(e,t,i,r,s),this.wrapper=new THREE.Object3D}get3DObject(){return this.wrapper}create3DObject(){var e=this.builder.build();this.wrapper.add(e)}update(){this.wrapper.rotation.y-=.01}dispose(){this.builder.dispose()}},e("VxlTester",T=class e{static async main(e,t){let r=this.renderer=new s.Renderer(800,600);r.init(document.body),r.initStats(document.body),this.vfs=e,this.vxlGeometryPool=new d.VxlGeometryPool(new g.VxlGeometryCache),this.palette=new i.Palette(e.openFile("unittem.pal"));let a=this.worldScene=n.WorldScene.factory({x:0,y:0,width:800,height:600},new u.BoxedVar(!0),new u.BoxedVar(p.ShadowQuality.High));this.disposables.add(a),a.scene.background=new THREE.Color(14737632),a.camera.far+=1e3,a.camera.updateProjectionMatrix();let c=new m.CanvasMetrics(r.getCanvas(),window);c.init(),this.disposables.add(c);var f=new l.PointerEvents(r,{x:0,y:0},document,c);let y=new h.CameraZoomControls(f,a.cameraZoom);this.disposables.add(y,f),y.init(),this.createFloor(),this.buildBrowser(),r.addScene(a),(this.uiAnimationLoop=new o.UiAnimationLoop(r)).start()}static createFloor(){var e=new THREE.PlaneGeometry(1e4,1e4);let t=new THREE.ShadowMaterial;t.opacity=.5;let i=new THREE.Mesh(e,t);i.rotation.x=-Math.PI/2,i.position.y=-100,i.receiveShadow=!0,this.worldScene.scene.add(i)}static async selectVxl(t){e.currentVxl&&(e.worldScene.remove(e.currentVxl),e.currentVxl.dispose());var i=this.vfs.openFile(t),s=(new Date).getTime(),n=new r.VxlFile(i);i=(new Date).getTime();console.log("Parsing took "+(i-s)+"ms"),n=this.currentVxl=new y(n,void 0,this.palette,this.vxlGeometryPool,e.worldScene.camera),e.worldScene.add(n)}static buildBrowser(){let t=this.listEl=document.createElement("div");t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.height="600px",t.style.width="200px",t.style.overflowY="auto",t.appendChild(document.createTextNode("Vxl files:")),f.forEach((i=>{let r=document.createElement("a");r.style.display="block",r.textContent=i,r.setAttribute("href","javascript:;"),r.addEventListener("click",(()=>{console.log("Selected vxl",i),e.selectVxl(i)})),t.appendChild(r)})),document.body.appendChild(t),setTimeout((()=>{e.selectVxl("zep.vxl")}),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.disposables.dispose()}}),T.disposables=new c.CompositeDisposable}}})),System.register("gui/screen/game/component/hud/viewmodel/SidebarTab",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SidebarTab",class{constructor(e){this.items=[],this.needsUpdate=!0,this.flashing=!1,this.id=e}get disabled(){return!this.items.length}})}}})),System.register("network/gamestate/PlayerConnectionStatus",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NotConnected=0]="NotConnected",t[t.Connected=1]="Connected",e("PlayerConnectionStatus",i)}}})),System.register("network/gamestate/PlayerConnectionInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gameopt/Serializer",["data/DataStream","network/gameopt/SlotInfo","game/gameopts/GameOpts","network/gameopt/MapNameLegacyEncoder","network/gameopt/FileNameEncoder","util/Base64","util/string"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("Serializer",c=class e{serializeOptions(e,t=!1){let i=e.gameMode,r=t?(new n.MapNameLegacyEncoder).encode(e.mapTitle):o.Base64.encode(l.utf16ToBinaryString(e.mapTitle)),s=(new a.FileNameEncoder).encode(e.mapName);return["0","0",6-e.gameSpeed,e.credits,e.unitCount,Number(e.shortGame),Number(e.superWeapons),Number(e.buildOffAlly),Number(e.mcvRepacks),Number(e.cratesAppear),i,Number(e.hostTeams??!1),r,e.maxSlots,Number(e.mapOfficial),e.mapSizeBytes,s,e.mapDigest].join(",")+`:${e.humanPlayers.map((e=>e.name+`,${e.countryId},${e.colorId},${e.startPos},${e.teamId},0,0,0`)).join(",")}:@:${e.aiPlayers.map((e=>e?`${e.difficulty},${e.countryId},${e.colorId},${e.startPos},`+e.teamId:"0,-1,-1,-1,-1")).join(",")},`}serializePingData(e){return e.length+","+e.map((e=>e.playerName+","+e.ping)).join(",")}serializeSlotData(e){return e.map((e=>{if(e.type===r.SlotType.Closed)return"@Closed@";if(e.type===r.SlotType.Open)return"@Open@";if(e.type===r.SlotType.OpenObserver)return"@OpenObserver@";if(e.type===r.SlotType.Ai){if(e.difficulty===s.AiDifficulty.Easy)return"@EasyAI@";if(e.difficulty===s.AiDifficulty.Medium)return"@MediumAI@";if(e.difficulty===s.AiDifficulty.Brutal)return"@HardAI@"}else if(e.type===r.SlotType.Player)return e.name;throw new Error("Unexpected slot info with type "+r.SlotType[e.type])})).join(",")+","}serializeLoadInfo(e){return e.map((e=>[e.name,e.status,e.loadPercent,e.ping].join(","))).join(",")}serializePlayerActions(t){let r=new i.DataStream;for(var{id:s,params:n}of(r.writeUint8(t.length),t))if(r.writeUint8(s),r.writeUint16(n.byteLength),0<n.byteLength){if(n.byteLength>e.MAX_ACTION_PAYLOAD_SIZE-r.position)throw console.error(`Action #${s} payload exceeds max data size`,n),new RangeError("Maximum payload data size exceeded");r.writeUint8Array(n)}return r.toUint8Array()}serializeAllPlayerActions(t,i){for(var[r,s]of(t.writeUint8(i.size),i)){t.writeUint8(r);var n=this.serializePlayerActions(s);if(t.writeUint16(n.byteLength),0<n.byteLength){if(n.byteLength>e.MAX_ACTION_PAYLOAD_SIZE)throw console.error(`Player #${r} actions payload exceeds max data size`,s),new RangeError("Maximum payload data size exceeded");t.writeUint8Array(n)}}}serializeMapData(e){return l.binaryStringToUint8Array(e)}}),c.MAX_ACTION_PAYLOAD_SIZE=65536}}})),System.register("network/gamestate/replay/ReplayEventType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.TurnActions=0]="TurnActions",t[t.ChatMessage=1]="ChatMessage",t[t.Taunt=2]="Taunt",e("ReplayEventType",i)}}})),System.register("network/gamestate/replay/ReplayEvent",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ReplayEvent",class{constructor(e,t){this.type=e,this.tickNo=t}})}}})),System.register("network/gamestate/replay/ChatMessageReplayEvent",["util/Base64","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends s.ReplayEvent{constructor(e){super(n.ReplayEventType.ChatMessage,e)}serialize(){return this.payload.playerId+":"+i.Base64.encode(r.utf16ToBinaryString(this.payload.message))}unserialize(e){var[t,s]=e.split(":"),t=Number(t),s=r.binaryStringToUtf16(i.Base64.decode(s));this.payload={playerId:t,message:s}}},e("ChatMessageReplayEvent",a)}}})),System.register("network/gamestate/replay/TauntReplayEvent",["network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.ReplayEvent{constructor(e){super(r.ReplayEventType.Taunt,e)}serialize(){return this.payload.playerId+":"+this.payload.tauntNo}unserialize(e){var[t,i]=e.split(":"),t=Number(t),i=Number(i);this.payload={playerId:t,tauntNo:i}}},e("TauntReplayEvent",s)}}})),System.register("network/gamestate/replay/TurnActionsReplayEvent",["data/DataStream","util/string","network/gamestate/replay/ReplayEvent","network/gamestate/replay/ReplayEventType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends s.ReplayEvent{constructor(e,t,i){super(n.ReplayEventType.TurnActions,i),this.gameOptsParser=e,this.gameOptsSerializer=t}serialize(){let e=new i.DataStream;return this.gameOptsSerializer.serializeAllPlayerActions(e,new Map(this.payload)),r.uint8ArrayToBase64String(e.toUint8Array())}unserialize(e){var t=new i.DataStream(r.base64StringToUint8Array(e));t=this.gameOptsParser.parseAllPlayerActions(t);this.payload=[...t]}},e("TurnActionsReplayEvent",a)}}})),System.register("network/gamestate/replay/ReplayEventFactory",["network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/ReplayEventType","network/gamestate/replay/TauntReplayEvent","network/gamestate/replay/TurnActionsReplayEvent"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ReplayEventFactory",class{constructor(e,t){this.gameOptsParser=e,this.gameOptsSerializer=t}create(e,t){switch(e){case r.ReplayEventType.TurnActions:return new n.TurnActionsReplayEvent(this.gameOptsParser,this.gameOptsSerializer,t);case r.ReplayEventType.ChatMessage:return new i.ChatMessageReplayEvent(t);case r.ReplayEventType.Taunt:return new s.TauntReplayEvent(t);default:throw new Error(`Unsupported replay event type "${e}" at game tick "${t}"`)}}})}}})),System.register("util/stream",[],(function(e,t){"use strict";return t&&t.id,e("makeTextFileLineIterator",(async function*(e){const t=new TextDecoder("utf-8");let i=e.stream().getReader(),{value:r,done:s}=await i.read();r=r?t.decode(r,{stream:!0}):"";let n=/\r\n|\n|\r/gm,a=0;for(;;){var o=n.exec(r);if(o)yield r.substring(a,o.index),a=n.lastIndex;else{if(s)break;o=r.substr(a),({value:r,done:s}=await i.read()),r=o+(r?t.decode(r,{stream:!0}):""),a=n.lastIndex=0}}a<r.length&&(yield r.substr(a))})),{setters:[],execute:function(){}}})),System.register("network/gamestate/Replay",["network/gameopt/Serializer","network/gameopt/Parser","util/Base64","network/gamestate/replay/ReplayEventFactory","util/stream","util/string"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=[5,6],e("Replay",c=class e{constructor(){this.name="",this.events=[]}static sanitizeFileName(e,t="_"){return e.replace(/[\/\?<>\\:\*\|"]/g,t).replace(/[\x00-\x1f\x7f\x80-\x9f]/g,t).slice(0,this.maxNameLength)}init(t,i,r,s,n){this.gameId=t,this.gameTimestamp=i,this.gameOpts=r,this.engineVersion=s,this.modHash=n,this.name=e.sanitizeFileName(this.gameOpts.mapTitle+" "+(new Date).toISOString().replace(/(\.|,)\d+Z$/,"Z")),this.timestamp=Date.now()}writeEvent(...e){this.events.push(...e)}finish(e){this.endTick=e}getEvents(){return this.events}*flush(){if(!this.gameOpts)throw new Error("Game options must be set first");if(!this.engineVersion)throw new Error("Engine version is not set");if(void 0===this.modHash)throw new Error("Mod hash is not set");let e=new i.Serializer,t=this.getHeaderTag()+"\n";for(t+=`ENGINE ${this.engineVersion} ${this.modHash}\n`,t+=[this.gameId,this.gameTimestamp,e.serializeOptions(this.gameOpts)].join(" ")+"\n",yield t,t="";void 0===this.endTick||this.events.length;){for(var r of this.events)t+=r.tickNo+"="+r.type+"|"+r.serialize()+"\n";this.events.length=0,yield t,t=""}t+=this.getEndTag()+" "+this.endTick+"\n",this.debugInfo&&(t+=s.Base64.encode(o.utf16ToBinaryString(this.debugInfo))+"\n"),yield t}serialize(){if(void 0===this.endTick)throw new Error("Replay is not finished");let e="";var t,i=this.events.slice();for(t of this.flush())e+=t;return this.events=i,e}async parseHeader(t){let i,r,n,o,l,c,h=0;var u;for await(u of"string"==typeof t?t.split("\n"):a.makeTextFileLineIterator(t)){if(0===h)i=this.readReplayVersion(u);else if(1===h){if(!u.match(e.engineLineRegex))throw new Error("Missing or invalid game engine version line");var d;r=(d=u.split(" "))[1],n=Number(i<4?"0":d[2])}else{if(2!==h)break;if(!u.match(/^\d+ \d+ .*$/))throw new Error("Missing or invalid game id/time/opts line");var[g,p,d]=u.split(" ");o=Number(g),l=Number(p),c=i<6?s.Base64.decode(d):d}h++}if(h<3)throw new Error("Bad replay header");return{replayVersion:i,engineVersion:r,modHash:n,gameId:o,gameTimestamp:l,gameOptsSerialized:c}}unserialize(t,a){let c=t.split("\n");var h=this.readReplayVersion(c.shift()||"");if(!l.includes(h))throw new Error("Unsupported replay version "+h);let u=new r.Parser,d=c.shift();if(!d||!d.match(e.engineLineRegex))throw new Error("Missing or invalid game engine version line");var[,g,p]=d.split(" ");let m=c.shift();if(!m)throw new Error("Missing game id/time/opts line");var f=m.match(/^(\d+) (\d+) (.*)$/);if(!f)throw new Error("Invalid game id/time/opts line");let[,y,T,v]=f;h<6&&(v=s.Base64.decode(v)),h=u.parseOptions(v),this.init(Number(y),Number(T),h,g,Number(p)),this.name=a.name,this.timestamp=a.timestamp;let b,S=!1;for(;b=c.shift();){if(b.startsWith(this.getEndTag())){S=!0;break}var w;if(!(w=b.match(/^(\d+)=(\d+)\|(.+)$/)))throw new Error(`Invalid event line "${b}"`);var[,C,E,w]=w,C=Number(C),E=Number(E);let e=new n.ReplayEventFactory(u,new i.Serializer).create(E,C);e.unserialize(w),this.writeEvent(e)}if(!S)throw new Error("Incomplete replay data");if(!(p=b.match(new RegExp(`^${this.getEndTag()} (\\d+)$`))))throw new Error("Invalid end tag");this.endTick=Number(p[1]),1<=c.length&&(this.debugInfo=o.binaryStringToUtf16(s.Base64.decode(c[0])))}getHeaderTag(){return"RA2TSREPL_v6"}readReplayVersion(e){var t=e.match(/^RA2TSREPL_v(\d+)$/);if(!t||t.length<2)throw new Error("Unknown replay format");return Number(t[1])}getEndTag(){return"END"}}),c.extension=".rpl",c.maxNameLength=128,c.engineLineRegex=/^ENGINE \d+\.\d+( \d+)?$/}}})),System.register("gui/screen/game/component/hud/viewmodel/SidebarModel",["gui/screen/game/component/hud/viewmodel/SidebarTab","game/GameSpeed"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.Techno=0]="Techno",t[t.Special=1]="Special",e("SidebarItemTargetType",s),(t=n=n||{})[t.Idle=0]="Idle",t[t.InQueue=1]="InQueue",t[t.Started=2]="Started",t[t.OnHold=3]="OnHold",t[t.Ready=4]="Ready",e("SidebarItemStatus",n),(t=a=a||{})[t.Structures=0]="Structures",t[t.Armory=1]="Armory",t[t.Infantry=2]="Infantry",t[t.Vehicles=3]="Vehicles",e("SidebarCategory",a),e("SidebarModel",class{constructor(e,t){this.game=e,this.replay=t,this.powerDrained=0,this.powerGenerated=0,this.sellMode=!1,this.repairMode=!1,this.topTextLeftAlign=!1,this.tabs=[new i.SidebarTab(a.Structures),new i.SidebarTab(a.Armory),new i.SidebarTab(a.Infantry),new i.SidebarTab(a.Vehicles)],this.activeTabId=a.Structures}get activeTab(){return this.tabs[this.activeTabId]}get currentGameTime(){return Math.floor(this.game.currentTime/1e3)}get replayTime(){return this.replay?Math.floor(this.replay.endTick/r.GameSpeed.BASE_TICKS_PER_SECOND):void 0}selectTab(e){this.tabs[e].disabled||(this.activeTabId=e)}})}}})),System.register("gui/screen/game/component/hud/viewmodel/CombatantSidebarModel",["game/rules/TechnoRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/gameobject/trait/DockTrait","gui/screen/game/component/hud/viewmodel/SidebarModel","game/SuperWeapon"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=(new Map).set(o.SuperWeaponStatus.Charging,a.SidebarItemStatus.Started).set(o.SuperWeaponStatus.Paused,a.SidebarItemStatus.OnHold).set(o.SuperWeaponStatus.Ready,a.SidebarItemStatus.Ready),c=class extends a.SidebarModel{constructor(e,t){super(t),this.player=e,this.rules=t.rules}get credits(){return Math.floor(this.player.credits)}get radarEnabled(){return!(!this.player.radarTrait||this.player.radarTrait.isDisabled())}computePurchaseCost(e){return this.game.sellTrait.computePurchaseValue(e,this.player)}updateAvailableObjects(e){if(!this.player.production)throw new Error("Player is not a combatant");var t,i,r,s=this.sortAvailableObjects(this.player.production.getAvailableObjects());for(t of this.tabs)t.items.length=0,t.needsUpdate=!0;for(i of(this.updateSuperWeaponItems(),s)){var n=e.getObject(i.name,i.type);let t=this.tabs[this.getSidebarCategoryForQueueType(this.player.production.getQueueTypeForObject(i))];var o=this.player.production.getQueueForObject(i),l=this.player.production.getFactoryTypeForQueueType(o.type);n={target:{type:a.SidebarItemTargetType.Techno,rules:i},cameo:this.player.production.hasVeteranType(l)&&i.trainable?n.altCameo:n.cameo,disabled:!1,progress:0,quantity:0,status:a.SidebarItemStatus.Idle};t.items.push(n),this.updateSidebarTechnoItem(n,o,this.player.production)}for(r of this.tabs)this.updateTabFlashing(r);this.updateActiveTab()}updateActiveTab(){var e;0!==this.activeTab.items.length||void 0!==(e=this.tabs.find((e=>0<e.items.length))?.id)&&this.selectTab(e)}updateFromQueue(e){if(!this.player.production)throw new Error("Player is not a combatant");let t=this.tabs[this.getSidebarCategoryForQueueType(e.type)];for(var i of(t.needsUpdate=!0,t.items))i.target.type===a.SidebarItemTargetType.Techno&&this.player.production.getQueueForObject(i.target.rules)===e&&this.updateSidebarTechnoItem(i,e,this.player.production);this.updateTabFlashing(t)}updateSuperWeapons(){this.updateSuperWeaponItems(),this.updateActiveTab()}updateSuperWeaponItems(){let e=this.player.superWeaponsTrait?.getAll().slice().sort(((e,t)=>1e3*(e.rules.rechargeTime-t.rules.rechargeTime)+e.name.charCodeAt(0)-t.name.charCodeAt(0))),t=this.tabs[a.SidebarCategory.Armory];t.needsUpdate=!0;var i=t.items.findIndex((e=>e.target.type===a.SidebarItemTargetType.Techno));-1!==i?t.items.splice(0,i):t.items.length=0,i=e?.map((e=>{var t=l.get(e.status);if(void 0===t)throw new Error(`Unhandled super weapon status "${e.status}"`);return{target:{type:a.SidebarItemTargetType.Special,rules:e.rules},cameo:e.rules.sidebarImage,disabled:!1,progress:e.getChargeProgress(),quantity:1,status:t}})),i&&t.items.unshift(...i),this.updateTabFlashing(t)}updateTabFlashing(e){e.flashing=e.items.some((e=>e.status===a.SidebarItemStatus.Ready))}updateSidebarTechnoItem(e,t,r){if(e.target.type===a.SidebarItemTargetType.Special)throw new Error("Sidebar item must be of type Techno");let o=e.target.rules,l=[...this.player.buildings],c=Number.isFinite(o.buildLimit)&&(o.type===s.ObjectType.Building?l:this.player.getOwnedObjectsByType(o.type,!0)).filter((e=>e.name===o.name)).length>=o.buildLimit;this.rules.general.padAircraft.includes(o.name)&&(u=l.filter((e=>e.factoryTrait?.type===i.FactoryType.AircraftType&&e.helipadTrait)).reduce(((e,t)=>e+(t.traits.find(n.DockTrait)?.numberOfDocks??0)),0),c=c||[...this.player.getOwnedObjectsByType(s.ObjectType.Aircraft,!0)].filter((e=>this.rules.general.padAircraft.includes(e.name))).length>=u);let h=r.getFactoryTypeForQueueType(t.type);var u=l.filter((e=>e.factoryTrait?.type===h&&!e.warpedOutTrait.isActive()));let d=t.find(o);e.progress=d.length?d[0].progress:0,e.quantity=d.reduce(((e,t)=>e+t.quantity),0),e.status=this.computeStatus(t,d[0]),e.disabled=1===t.maxSize&&d[0]!==t.getFirst()||c||!u.length&&(!t.currentSize||d[0]!==t.getFirst())}getTabForQueueType(e){return this.tabs[this.getSidebarCategoryForQueueType(e)]}getSidebarCategoryForQueueType(e){switch(e){case r.QueueType.Structures:return a.SidebarCategory.Structures;case r.QueueType.Armory:return a.SidebarCategory.Armory;case r.QueueType.Infantry:return a.SidebarCategory.Infantry;case r.QueueType.Vehicles:case r.QueueType.Ships:case r.QueueType.Aircrafts:return a.SidebarCategory.Vehicles;default:throw new Error("Unhandled queueType "+r.QueueType[e])}}computeStatus(e,t){return t?e.getFirst()===t?e.status===r.QueueStatus.Ready?a.SidebarItemStatus.Ready:e.status===r.QueueStatus.OnHold?a.SidebarItemStatus.OnHold:a.SidebarItemStatus.Started:a.SidebarItemStatus.InQueue:a.SidebarItemStatus.Idle}sortAvailableObjects(e){return[...e].sort(((e,t)=>{var i=this.getObjectTypeSortValue(e),r=this.getObjectTypeSortValue(t);return i===r?e.aiBasePlanningSide===t.aiBasePlanningSide?e.techLevel===t.techLevel?e.prerequisite.length<t.prerequisite.length?-1:1:e.techLevel<t.techLevel?-1:1:(e.aiBasePlanningSide??-1)<(t.aiBasePlanningSide??-1)?-1:1:i-r}))}getObjectTypeSortValue(e){return e.type===s.ObjectType.Aircraft?1:e.type===s.ObjectType.Vehicle?e.naval?2:e.consideredAircraft?1:0:0}},e("CombatantSidebarModel",c)}}})),System.register("gui/screen/game/component/hud/SidebarCard",["gui/jsx/jsx","gui/screen/game/component/hud/viewmodel/SidebarModel","gui/UiObject","gui/jsx/UiComponent","engine/gfx/OverlayUtils","gui/HtmlContainer","util/math","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/art/ObjectArt"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){var t;(t=u=u||{})[t.Ready=0]="Ready",t[t.OnHold=1]="OnHold",d=class e extends n.UiComponent{constructor(){super(...arguments),this.slotContainers=[],this.slotObjects=[],this.progressOverlays=[],this.visible=!0,this.labelObjects=[],this.quantityObjects=[],this.justCreated=!0,this.lastItemCount=0,this.pagingOffset=0,this.handleWheel=e=>{this.scrollToOffset(this.pagingOffset+(0<e.wheelDeltaY?2:-2))}}createUiObject(){let t=new s.UiObject(new THREE.Object3D,new o.HtmlContainer);t.setPosition(this.props.x||0,this.props.y||0),t.onFrame.subscribe((()=>this.handleFrame())),this.slotOutline=new s.UiObject(this.createSlotOutline()),this.slotOutline.setVisible(!1),this.slotOutline.setZIndex((this.props.zIndex??0)+1),t.add(this.slotOutline);let i=e.labelImageCache.get(this.props.textColor);i||(i=this.createLabelImages(this.props.textColor),e.labelImageCache.set(this.props.textColor,i)),this.labelImages=i;let r=e.quantityImageCache.get(this.props.textColor);return r||(r=this.createQuantityImages(this.props.textColor),e.quantityImageCache.set(this.props.textColor,r)),this.quantityImages=r,t}defineChildren(){let{slots:e,cameoImages:t,cameoPalette:r,sidebarModel:s,onSlotClick:n,zIndex:a}=this.props;var o=this.getCameoSize();let l=[];for(let c=0;c<e;c++){let e={x:(3+o.width)*(c%2),y:(2+o.height)*Math.floor(c/2)};l.push(i.jsx("container",{x:e.x,y:e.y,zIndex:a,ref:e=>this.slotContainers.push(e),onWheel:this.handleWheel,onClick:e=>{var t=s.activeTab.items[this.getItemIndexAtSlot(c)];t&&!t.disabled&&n?.(this.createSlotClickEvent(t,e))},onMouseEnter:()=>{var t=s.activeTab.items[this.getItemIndexAtSlot(c)];t&&(t.disabled||this.slotOutline.setPosition(e.x,e.y),this.slotOutline.setVisible(!t.disabled),this.hoverSlotIndex=c)},onMouseLeave:()=>{this.hoverSlotIndex===c&&(this.slotOutline.setVisible(!1),this.hoverSlotIndex=void 0)}},i.jsx("sprite",{image:"gclock2.shp",palette:"sidebar.pal",zIndex:1,frame:0,opacity:.5,transparent:!0,ref:e=>this.progressOverlays.push(e)}),i.jsx("sprite",{images:this.labelImages,zIndex:2,x:o.width/2,transparent:!0,ref:e=>this.labelObjects.push(e)}),i.jsx("sprite",{images:this.quantityImages,zIndex:2,x:o.width,alignX:1,alignY:-1,transparent:!0,ref:e=>this.quantityObjects.push(e)}),i.jsx("sprite",{image:t,palette:r,ref:e=>this.slotObjects.push(e)})))}return l}createSlotClickEvent(e,t){return{target:e.target,button:t.button,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,isTouch:t.isTouch,touchDuration:t.touchDuration}}handleFrame(){let{sidebarModel:e,slots:t}=this.props;var i;this.getUiObject().get3DObject().visible=this.visible,(this.justCreated||e.activeTab.needsUpdate||this.lastActiveTab!==e.activeTab)&&(this.justCreated=!1,i=e.activeTab.items.length,this.lastActiveTab===e.activeTab&&this.lastItemCount===i||(this.lastItemCount>i&&(this.pagingOffset=0),this.lastItemCount=i),this.lastActiveTab=e.activeTab,e.activeTab.needsUpdate=!1,this.updateSlots(e.activeTab.items,t))}updateSlots(e,t){for(let r=0;r<t;r++){var i=e[this.getItemIndexAtSlot(r)];let t=this.slotObjects[r],s=this.progressOverlays[r],n=this.labelObjects[r],a=this.quantityObjects[r];e.length-this.pagingOffset<=r?(t.get3DObject().visible=!1,s.get3DObject().visible=!1,n.get3DObject().visible=!1,a.get3DObject().visible=!1):(this.updateCameo(i,t),this.updateProgressOverlay(i,s),this.updateStatusText(i,n),this.updateQuantities(i,a),this.updateTooltip(i,this.slotContainers[r]))}}updateCameo(e,t){let i=this.props.cameoNameToIdMap;var r;let s=e.cameo+".shp";if(void 0===i.get(s)&&(s=h.ObjectArt.MISSING_CAMEO+".shp"),void 0===(r=i.get(s)))throw new Error(`Missing cameo placeholder image "${h.ObjectArt.MISSING_CAMEO}.shp"`);t.setFrame(r),t.get3DObject().visible=!0,t.setLightMult(e.disabled?.5:1)}updateProgressOverlay(e,t){let i=0;var s;[r.SidebarItemStatus.Started,r.SidebarItemStatus.OnHold].includes(e.status)&&(s=t.getFrameCount(),i=Math.max(1,Math.ceil(e.progress*(s-1)))%s),t.setFrame(i),t.get3DObject().visible=0<i}updateStatusText(e,t){t.get3DObject().visible=[r.SidebarItemStatus.Ready,r.SidebarItemStatus.OnHold].includes(e.status),e.status===r.SidebarItemStatus.Ready?(t.setFrame(u.Ready),t.setPosition(this.getCameoSize().width/2,t.getPosition().y),t.builder.setAlign(0,-1)):e.status===r.SidebarItemStatus.OnHold&&(t.setFrame(u.OnHold),t.setPosition(1<e.quantity?0:this.getCameoSize().width/2,t.getPosition().y),t.builder.setAlign(1<e.quantity?-1:0,-1))}updateQuantities(t,i){t.quantity>(t.status===r.SidebarItemStatus.InQueue?0:1)?(i.setFrame(t.quantity>e.MAX_QUANTITY?e.MAX_QUANTITY:t.quantity-1),i.setVisible(!0)):i.setVisible(!1)}updateTooltip(e,t){let i;if(e.target.type===r.SidebarItemTargetType.Techno){let t=e.target.rules.cost;this.props.sidebarModel instanceof c.CombatantSidebarModel&&(t=this.props.sidebarModel.computePurchaseCost(e.target.rules)),i=this.props.strings.get(e.target.rules.uiName)+"\n$"+t}else{if(e.target.type!==r.SidebarItemTargetType.Special)throw new Error(`Type "${e.target.type}" not implemented`);i=this.props.strings.get(e.target.rules.uiName)}t.setTooltip(i)}getItemIndexAtSlot(e){return e+this.pagingOffset}getCameoSize(){return{width:this.props.cameoImages.width,height:this.props.cameoImages.height}}createSlotOutline(){var e=(t=this.getCameoSize()).width,t=t.height;let i=new THREE.Geometry;return i.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,t,0),new THREE.Vector3(e,t,0),new THREE.Vector3(e,0,0),new THREE.Vector3(0,0,0)),e=new THREE.LineBasicMaterial({color:this.props.textColor,transparent:!0,side:THREE.DoubleSide}),new THREE.Line(i,e)}hide(){this.visible=!1}show(){this.visible=!0}scrollToOffset(e){var t=this.pagingOffset,i=Math.max(0,this.props.sidebarModel.activeTab.items.length-this.props.slots);return this.pagingOffset=l.clamp(e,0,i),this.pagingOffset%2&&this.pagingOffset++,this.updateSlots(this.props.sidebarModel.activeTab.items,this.props.slots),t!==this.pagingOffset}pageDown(){return this.scrollToOffset(this.pagingOffset+this.props.slots)}pageUp(){return this.scrollToOffset(this.pagingOffset-this.props.slots)}createLabelImages(e){return[{text:this.props.strings.get("TXT_READY"),type:u.Ready},{text:this.props.strings.get("TXT_HOLD"),type:u.OnHold}].map((t=>this.createTextBox(t.text,e)))}createQuantityImages(t){let i={paddingRight:2},r=new Array(e.MAX_QUANTITY).fill(0).map(((e,r)=>this.createTextBox(""+(r+1),t,i)));return r.push(this.createTextBox("∞",t,i)),r}createTextBox(e,t,i){return a.OverlayUtils.createTextBox(e,{color:t,backgroundColor:"rgba(0, 0, 0, .5)",fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,...i})}},e("SidebarCard",d),d.MAX_QUANTITY=99,d.labelImageCache=new Map,d.quantityImageCache=new Map}}})),System.register("gui/screen/game/component/hud/SidebarTabs",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends s.UiComponent{constructor(){super(...arguments),this.tabObjects=[],this.flashing=!1}createUiObject(){let e=new r.UiObject(new THREE.Object3D);return e.setPosition(this.props.x||0,this.props.y||0),e}defineChildren(){let{aggregatedImageData:e,images:t,palette:r,tabSpacing:s,onTabClick:n,sidebarModel:a,strings:o}=this.props,l=[];for(let h=0;h<4;h++){var c=t[h];const u=this.props.aggregatedImageData.imageIndexes.get(c);if(void 0===u)throw new Error(`Tab ${h} image not found in aggregated file`);l.push(i.jsx("sprite",{image:e.file,palette:r,x:(s+c.width)*h,tooltip:o.get("Tip:Tab"+(h+1)),onClick:e=>{var t;0===e.button&&((t=a.tabs[h]).disabled||n?.(t))},onFrame:(e,t)=>this.handleFrame(e,t,a.tabs[h],u)}))}return l}handleFrame(e,t,i,r){let s;(!this.lastFlashUpdate||250<=e-this.lastFlashUpdate)&&(this.lastFlashUpdate=e,this.flashing=!this.flashing),s=i.disabled?2:this.props.sidebarModel.activeTab===i?1:0,i.flashing&&this.flashing&&(s=3),t.setFrame(r+s)}},e("SidebarTabs",n)}}})),System.register("gui/screen/game/component/hud/SidebarIconButton",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends r.UiComponent{constructor(){super(...arguments),this.toggle=this.props.toggle,this.disabled=!!this.props.disabled,this.handleMouseDown=()=>{this.disabled||(void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+1),document.addEventListener("mouseup",this.onDocumentMouseUp),document.addEventListener("touchend",this.onDocumentMouseUp),document.addEventListener("touchcancel",this.onDocumentMouseUp))},this.onDocumentMouseUp=()=>{void 0===this.toggle&&this.sprite.setFrame((this.props.imageFrameOffset??0)+0),document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}}createUiObject(){return new s.UiObject(new THREE.Object3D)}defineChildren(){let{image:e,imageFrameOffset:t,palette:r,x:s,y:n,onClick:a,tooltip:o}=this.props;return i.jsx("sprite",{image:e,palette:r,x:s,y:n,frame:this.getBaseFrameNo(t??0),onClick:e=>0===e.button&&!this.disabled&&a?.(),onMouseDown:this.handleMouseDown,tooltip:o,ref:e=>this.sprite=e})}getBaseFrameNo(e){return e+(this.disabled?2:this.toggle?1:0)}setToggleState(e){this.toggle!==e&&(this.toggle=e,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}setDisabled(e){e!==this.disabled&&(this.disabled=e,this.sprite.setFrame(this.getBaseFrameNo(this.props.imageFrameOffset??0)))}onDispose(){document.removeEventListener("mouseup",this.onDocumentMouseUp),document.removeEventListener("touchend",this.onDocumentMouseUp),document.removeEventListener("touchcancel",this.onDocumentMouseUp)}},e("SidebarIconButton",n)}}})),System.register("gui/screen/game/component/hud/SidebarMenu",["gui/jsx/jsx","gui/component/MenuButton","gui/UiObject","gui/HtmlContainer","gui/jsx/HtmlView","gui/jsx/UiComponent"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends o.UiComponent{createUiObject(){return new s.UiObject(new THREE.Object3D,new n.HtmlContainer)}defineChildren(){return this.props.buttons.map(((e,t)=>this.createButton(e,t)))}createButton(e,t){var s=this.props.buttonImg;let n={x:0,y:t*s.height};e.isBottom&&(n.y=this.props.menuHeight-s.height);var o={x:n.x,y:n.y,width:s.width,height:s.height};let l=i.createRef();return i.jsx("fragment",null,i.jsx("sprite",{image:s,palette:this.props.buttonPal,x:n.x,y:n.y,ref:l}),i.jsx(a.HtmlView,{component:r.MenuButton,props:{buttonConfig:{label:e.label,disabled:!!e.disabled},box:{x:o.x,y:o.y,width:o.width,height:o.height},onMouseDown:e=>{l.current.setFrame(1);let t=()=>{l.current.setFrame(0),document.removeEventListener("mouseup",t)};document.addEventListener("mouseup",t)},onClick:t=>{e.onClick&&e.onClick()}}}))}},e("SidebarMenu",l)}}})),System.register("gui/screen/game/component/hud/GameMenuContentArea",["gui/jsx/jsx","gui/jsx/UiComponent","gui/UiObject","gui/HtmlContainer","engine/gfx/SpriteUtils"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends r.UiComponent{createUiObject({viewport:e,hidden:t}){let i=new s.UiObject(new THREE.Object3D,new n.HtmlContainer);return i.setPosition(e.x,e.y),i.getHtmlContainer().setSize(e.width,e.height),i.setVisible(!t),i}defineChildren(){let{viewport:e,screenSize:t,images:r,innerRef:s}=this.props,n="lg";(t.width<1024||t.height<768)&&(n="md"),(t.width<800||t.height<600)&&(n="sm");var a=r.get(`bkgd${n}.shp`),o=a?(e.width-a.width)/2:0,l=a?(e.height-a.height)/2:0,c=(a||e).width,h=(a||e).height;return i.jsx("fragment",null,i.jsx("mesh",null,this.createMask(e)),i.jsx("container",{zIndex:1,x:o,y:l,width:c,height:h,ref:s},a&&i.jsx("sprite",{image:a,palette:"uibkgd.pal"})))}createMask(e){let t=a.SpriteUtils.createRectGeometry(e.width,e.height);t.translate(e.width/2,e.height/2,0);var i=new THREE.MeshBasicMaterial({color:0,opacity:.75,transparent:!0,side:THREE.DoubleSide});let r=new THREE.Mesh(t,i);return r.frustumCulled=!1,r}},e("GameMenuContentArea",o)}}})),System.register("gui/screen/game/component/hud/SidebarPower",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","data/Bitmap","engine/gfx/SpriteUtils","util/math","engine/gfx/TextureUtils","engine/renderable/entity/HighlightAnimRunner","util/BoxedVar","util/array","engine/gfx/material/PaletteBasicMaterial"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){var t;p=(e,t)=>e.green===t.green&&e.yellow===t.yellow&&e.red===t.red,(t=m=m||{})[t.None=0]="None",t[t.Green=1]="Green",t[t.Yellow=2]="Yellow",t[t.Red=3]="Red",t[t.Highlight=4]="Highlight",f=class extends s.UiComponent{constructor(){super(...arguments),this.visible=!0,this.pipHighlightAnimRunner=new h.HighlightAnimRunner(new u.BoxedVar(1),1,2,15)}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0),this.pips=this.createPips(this.props.powerImg);var t=this.props.powerImg.width,i=this.props.height;return this.textureBitmap=new a.IndexedBitmap(t,i),this.texture=this.createDataTexture(this.textureBitmap.data,t,i),this.mesh=this.createMesh(t,i),e}createPips(e){let t=[];for(let r=0;r<e.numImages;r++){var i=e.getImage(r);t.push(new a.IndexedBitmap(i.width,i.height,i.imageData))}return t}createDataTexture(e,t,i){let r=new THREE.DataTexture(e,t,i,THREE.AlphaFormat);return r.needsUpdate=!0,r.minFilter=THREE.NearestFilter,r.magFilter=THREE.NearestFilter,r}createMesh(e,t){let i=o.SpriteUtils.createRectGeometry(e,t);o.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new g.PaletteBasicMaterial({map:this.texture,palette:c.TextureUtils.textureFromPalette(this.props.palette),side:THREE.DoubleSide});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex,ref:e=>this.meshEvtTarget=e,onClick:()=>{}},this.mesh)}onFrame(e){this.getUiObject().get3DObject().visible=this.visible;var t=(i=this.props.sidebarModel).powerDrained,i=i.powerGenerated;let r=!1;this.lastPowerDrained===t&&this.lastPowerGenerated===i||(this.lastPowerDrained=t,this.lastPowerGenerated=i,this.meshEvtTarget.setTooltip(this.props.strings.get("TXT_POWER_DRAIN",i,t)),s=(c=Math.max(i,t))?Math.min(1,t/c):1,o=c?Math.min(1,l.clamp(i-t,0,100)/c):0,a=this.pips[0].height+1,n=c?this.computeHeightFromPowerLevel(Math.max(100,c)):1,this.targetPipCount={green:Math.floor((1-s-o)*n/a),yellow:Math.floor(o*n/a),red:c?Math.floor(s*n/a):1},this.pipHighlightAnimRunner.animation.stop(),r=!0);var s,n,a,o=this.targetPipCount,c=this.pipCount&&p(this.pipCount,o);this.lastPipUpdate&&!(50<=e-this.lastPipUpdate)||c||(this.lastPipUpdate=e,this.pipCount?(s=Math.sign(o.red-this.pipCount.red),n=Math.sign(o.yellow-this.pipCount.yellow),a=Math.sign(o.green-this.pipCount.green),s?0<s&&(this.pipCount.yellow>s?this.pipCount.yellow=Math.max(0,this.pipCount.yellow-s):this.pipCount.green=Math.max(0,this.pipCount.green-s)):(n?0<n&&(this.pipCount.green=Math.max(0,this.pipCount.green-n)):this.pipCount.green+=a,this.pipCount.yellow+=n),this.pipCount.red+=s):this.pipCount={red:1,yellow:0,green:0},this.updateTexture(this.pipCount,!0),p(this.pipCount,o)&&this.pipHighlightAnimRunner.animate(10)),c&&(r&&this.pipHighlightAnimRunner.animate(10),this.pipHighlightAnimRunner.shouldUpdate()&&(o=!!this.pipHighlightAnimRunner.getValue(),this.pipHighlightAnimRunner.tick(e),(c=!!this.pipHighlightAnimRunner.getValue())!=o&&this.updateTexture(this.pipCount,c)))}computeHeightFromPowerLevel(e){return l.clamp((Math.log10((e/100+5)/5e7)/(e/100+3)+2)/2,0,1)*this.props.height}updateTexture(e,t){var i,r=this.pips[0].height,s=this.props.height,n=r+1;let a=[[[m.None,Math.floor(s/r),r]],[[m.Red,e.red,n],[m.Yellow,e.yellow,n],[m.Green,e.green,n]]];if(t){let e=d.findReverse(a[1],(([,e])=>0<e));e&&e[1]--,a[1].push([m.Highlight,1,n])}for(i of a){let e=s-r;for(var[o,l,c]of i){var h=this.pips[o];for(let t=0;t<l;t++)this.textureBitmap.drawIndexedImage(h,0,e),e-=c}}this.texture.needsUpdate=!0}hide(){this.visible=!1}show(){this.visible=!0}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("SidebarPower",f)}}})),System.register("gui/component/UiText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends s.UiComponent{constructor(){super(...arguments),this.value=this.props.value,this.textAlign=this.props.textAlign}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let s=document.createElement("canvas");return s.width=t,s.height=i,this.ctx=s.getContext("2d",{alpha:!0}),this.texture=this.createTexture(s),this.updateTexture(this.value,this.textAlign,this.props.textColor),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=a.SpriteUtils.createRectGeometry(e,t);a.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex,onClick:this.props.onClick},this.mesh)}updateTexture(e,t,i){this.ctx.clearRect(0,0,this.props.width,this.props.height),o.CanvasUtils.drawText(this.ctx,e,0,0,{color:i,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,textAlign:t??"center",width:this.props.width,height:this.props.height}),this.texture.needsUpdate=!0}setValue(e){this.value!==e&&(this.value=e,this.updateTexture(e,this.textAlign,this.props.textColor))}setTextAlign(e){e!==this.textAlign&&(this.textAlign=e,this.updateTexture(this.value,e,this.props.textColor))}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("UiText",l)}}})),System.register("gui/screen/game/component/hud/SidebarCredits",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends s.UiComponent{createUiObject(){return new r.UiObject(new THREE.Object3D,new n.HtmlContainer)}defineChildren(){var{textColor:e,width:t,height:r,zIndex:s}=this.props;return i.jsx(a.UiText,{ref:e=>this.text=e,value:"",textColor:e,width:t,height:r,zIndex:s})}onFrame(e){var{sidebarModel:{credits:t,topTextLeftAlign:i}}=this.props;this.targetCredits!==t&&(this.targetCredits=t,s=Math.abs(t-(this.renderedCredits??0)),r=THREE.Math.lerp(300,2e3,Math.min(1,s/5e3)),this.tickSpeed=s/r);var r,s=this.tickSpeed;(!this.lastUpdate||50<=e-this.lastUpdate)&&(r=this.lastUpdate?e-this.lastUpdate:0,this.lastUpdate=e,this.renderedCredits!==t&&(void 0===this.renderedCredits?this.renderedCredits=0:(t-=this.renderedCredits,r*=s,this.renderedCredits+=Math.abs(t)>=r?Math.sign(t)*r:t,this.props.onTick(1===Math.sign(t)?"up":"down")),this.text.setValue(""+Math.floor(this.renderedCredits))),i!==this.lastLeftAligned&&(i?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=i))}},e("SidebarCredits",o)}}})),System.register("gui/screen/game/component/hud/SidebarRadarAnimRunner",["data/IniSection","engine/Animation","engine/AnimProps","engine/Engine","util/BoxedVar"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.None=0]="None",t[t.RadarOff=1]="RadarOff",t[t.RadarOn=2]="RadarOn",e("AnimationType",o),e("SidebarRadarAnimationRunner",class{constructor(e){this.shpFile=e,this.closed=!0,this.currentAnimationType=o.None}radarOff(){this.currentAnimationType=o.RadarOff,this.initAnimation()}radarOn(){this.currentAnimationType=o.RadarOn,this.initAnimation()}initAnimation(){var e=new i.IniSection("");e=new s.AnimProps(e,this.shpFile),e=new r.Animation(e,new a.BoxedVar(n.Engine.UI_ANIM_SPEED));this.animation=e}tick(e){let t=this.animation;var i=this.currentAnimationType;if(t&&i!==o.None){switch(t.getState()){case r.AnimationState.STOPPED:break;case r.AnimationState.NOT_STARTED:t.start(e);case r.AnimationState.RUNNING:default:t.update(e)}t.getState()===r.AnimationState.STOPPED&&(this.closed=i===o.RadarOff,this.currentAnimationType=o.None)}}shouldUpdate(){return!0}isStopped(){return this.currentAnimationType===o.None}getCurrentFrame(){if(!this.animation)return 0;let e=this.currentAnimationType===o.RadarOff?-1:1;this.currentAnimationType===o.None&&this.closed&&(e*=-1);let t=0;return-1===e&&(t=this.animation.props.end),t+e*this.animation.getCurrentFrame()}})}}})),System.register("engine/renderable/entity/map/MinimapModel",["game/map/MapShroud"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=new THREE.Color("rgb(173, 170, 132)"),s=new Map([["CAKRMW",new THREE.Color("rgb(107, 69, 49)")],["CAFNCW",new THREE.Color(16777215)],["CAFNCB",new THREE.Color(0)],["GASAND",new THREE.Color("rgb(82, 77, 57)")]]),n=new THREE.Color("rgb(90, 89, 82)"),a=new THREE.Color(0),o=new THREE.Color("rgb(173, 170, 132)"),l=new THREE.Color(0),e("MinimapModel",class{constructor(e,t,i,r,s,n){this.tiles=e,this.tileOccupation=t,this.shroud=i,this.localPlayer=r,this.alliances=s,this.paradropRules=n;var a=this.tiles.getMapSize();this.stride=a.width,this.tileColors=new Uint32Array(a.width*a.height),this.aboveShroudTiles=new Uint8Array(a.width*a.height),this.tileWithTechnos=new Uint8Array(a.width*a.height)}computeAllColors(){this.updateColors(this.tiles.getAll())}updateColors(e){for(var t of e){let e,h,u=-1;for(var i of this.tileOccupation.getObjectsOnTile(t)){var c;!((i.isTechno()||i.isOverlay()||i.isTerrain())&&!i.radarInvisible||i.isOverlay()&&i.isBridge()||i.isBuilding()&&!i.rules.invisibleInGame&&(!i.radarInvisible||i.rules.canBeOccupied&&i.owner.isCombatant()))||(c=4*Number(i.isTechno())+2*Number(i.isAircraft())+Number(i.name!==this.paradropRules.paradropPlane))>u&&(u=c,e=i)}if(e)if((e.isTechno()||e.isOverlay())&&e.rules.wall)h=s.get(e.name)??n;else if(e.isBuilding()&&e.isDestroyed&&e.rules.leaveRubble)h=a;else if(e.isTechno())if(e.cloakableTrait?.isCloaked()&&this.localPlayer&&!this.alliances.haveSharedIntel(this.localPlayer,e.owner))h=void 0;else{let t=(e.isInfantry()||e.isVehicle())&&e.disguiseTrait?.getDisguise();h=this.localPlayer&&t&&!this.alliances.haveSharedIntel(this.localPlayer,e.owner)&&!this.localPlayer.sharedDetectDisguiseTrait?.has(e)?t.owner?new THREE.Color(t.owner.color.asHex()):r:new THREE.Color(e.owner.color.asHex())}else if(e.isTerrain())h=r;else{if(!e.isOverlay())return;h=e.isTiberium()?o:l}h=h||this.tiles.getTileRadarColor(t),t=t.rx+t.ry*this.stride,this.tileColors[t]=h.getHex(),this.aboveShroudTiles[t]=e?.name===this.paradropRules.paradropPlane?1:0,this.tileWithTechnos[t]=e?.isTechno()?1:0}}getTileColor(e){var t=e.rx+e.ry*this.stride;if(this.shroud?.getShroudType(e)===i.ShroudType.Unexplored&&!this.aboveShroudTiles[t])return"#000000";let r=new THREE.Color(this.tileColors[t]);return this.shroud?.isFlagged(e,i.ShroudFlag.Darken)&&!this.tileWithTechnos[t]&&r.multiplyScalar(.35),"#"+r.getHexString()}})}}})),System.register("engine/renderable/entity/map/MinimapRenderer",["game/Coords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MinimapRenderer",class{constructor(e,t,i,r,s){this.map=e,this.minimapModel=t,this.borderColor=r,this.canvasRenderScale=s;var n=this.map.mapBounds.getRawLocalSize();this.dxySize={x:2*n.x,y:2*n.y+4,width:2*n.width,height:2*n.height+8},n=this.dxySize.height/this.dxySize.width,this.canvasSize=this.computeCanvasSize(i,n)}computeCanvasSize(e,t){var i=e.width,r=e.height;let s;return s=r/i<=t?{width:Math.floor(r/t),height:r}:{width:i,height:Math.floor(i*t)},s}renderFull(){if(this.canvas)this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvasRenderScale*this.canvasSize.width,this.canvasRenderScale*this.canvasSize.height);else{let e=this.canvas=document.createElement("canvas");e.width=this.canvasRenderScale*this.canvasSize.width,e.height=this.canvasRenderScale*this.canvasSize.height,(this.ctx=e.getContext("2d",{alpha:!1})).translate(.5,.5)}return this.renderTiles(this.map.tiles.getAll(),!0),this.canvas}renderIncremental(e){let t=new Set(e);for(var i of e){this.map.tiles.getAllNeighbourTiles(i).forEach((e=>t.add(e)))}this.renderTiles(t)}renderTiles(e,t=!1){var r,s=this.canvasSize.width/this.dxySize.width/i.Coords.COS_ISO_CAMERA_BETA;const n=this.ctx;if(!n)throw new Error("Must do a full render before re-rendering any individual tiles.");for(r of(n.imageSmoothingEnabled=!1,n.save(),n.rotate(i.Coords.ISO_CAMERA_BETA),n.scale(s,s),e)){var a,o=this.minimapModel.getTileColor(r);!o||t&&"#000000"===o||(n.fillStyle=o,({x:a,y:o}=this.tileToLocalRxyOrigin(r)),n.fillRect(this.canvasRenderScale*a,this.canvasRenderScale*o,this.canvasRenderScale+.5,this.canvasRenderScale+.5))}n.restore(),n.strokeStyle=this.borderColor,n.lineWidth=this.canvasRenderScale,n.strokeRect(0,0,n.canvas.width-this.canvasRenderScale,n.canvas.height-this.canvasRenderScale)}tileToLocalRxyOrigin(e){var t=this.dxyToLocalRxy(this.dxySize.x,this.dxySize.y);return{x:e.rx-t.x,y:e.ry-this.map.mapBounds.getFullSize().width/2-t.y}}dxyToLocalRxy(e,t){return{x:(e+t)/2,y:(t-e)/2}}dxyToCanvas(e,t){var i=this.canvasSize.width/this.dxySize.width;return{x:(e-this.dxySize.x)*i,y:(t-this.dxySize.y)*i}}canvasToDxy(e,t){var i=this.canvasSize.width/this.dxySize.width;return{x:e/i+this.dxySize.x,y:t/i+this.dxySize.y}}})}}})),System.register("gui/screen/game/component/MinimapPing",["gui/UiObject"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.UiObject{constructor(e,t,i){super(),this.radarRules=e,this.colorLerpFactor=0,this.hiColor=new THREE.Color(t),this.lowColor=new THREE.Color(i),this.matHiColor=this.hiColor.clone(),this.matLowColor=this.lowColor.clone();var r=e.eventMinRadius;let s=this.createPingRectLine(r,r,this.matHiColor,this.matLowColor);s.name="minimap_ping",s.scale.x=15,s.scale.y=15,this.set3DObject(s),this.get3DObject().matrixAutoUpdate=!0}createPingRectLine(e,t,i,r){let s=new THREE.Geometry,n=[new THREE.Vector3(-.5*e,-.5*t,0),new THREE.Vector3(-.5*e,.5*t,0),new THREE.Vector3(.5*e,.5*t,0),new THREE.Vector3(.5*e,-.5*t,0)],a=[i,r];n.forEach(((e,t)=>{s.vertices.push(e,n[(t+1)%n.length]),s.colors.push(a[t%2],a[(t+1)%2])}));var o=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,side:THREE.DoubleSide});return new THREE.LineSegments(s,o)}get3DObject(){return super.get3DObject()}update(e){super.update(e),this.lastUpdate||(this.lastUpdate=e);var t=(e-this.lastUpdate)/1e3*60;this.lastUpdate=e;let i=this.get3DObject();var r=this.radarRules.eventSpeed/this.radarRules.eventMinRadius;i.scale.x=Math.max(1,i.scale.x-r*t),i.scale.y=Math.max(1,i.scale.y-r*t),i.rotation.z=i.rotation.z+this.radarRules.eventRotationSpeed*t,1===i.scale.x&&(i.rotation.z=Math.min(i.rotation.z,Math.floor(i.rotation.z/(Math.PI/2))*Math.PI/2)),this.colorLerpFactor=(this.colorLerpFactor+this.radarRules.eventColorSpeed*t)%2,t=Math.min(1,this.colorLerpFactor)-Math.max(0,this.colorLerpFactor-1),this.matHiColor.copy(this.hiColor).lerp(this.lowColor,t),this.matLowColor.copy(this.lowColor).lerp(this.hiColor,t),i.geometry.colorsNeedUpdate=!0}destroy(){super.destroy(),this.get3DObject().material.dispose(),this.get3DObject().geometry.dispose()}},e("MinimapPing",r)}}})),System.register("gui/screen/game/component/Minimap",["gui/UiObject","engine/gfx/SpriteUtils","util/geometry","engine/renderable/entity/map/MinimapRenderer","engine/util/MapTileIntersectHelper","engine/IsoCoords","util/disposable/CompositeDisposable","util/event","game/event/EventType","gui/screen/game/component/MinimapPing","game/rules/general/RadarRules","engine/renderable/entity/map/MinimapModel","game/GameSpeed"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=new Map([[d.RadarEventType.EnemyObjectSensed,{high:16776960,low:8684544}],[d.RadarEventType.GenericNonCombat,{high:65535,low:33924}]]),f=class extends i.UiObject{constructor(e,t,i,r){super(new THREE.Object3D),this.game=e,this.localPlayer=t,this.borderColor=i,this.radarRules=r,this.disposables=new l.CompositeDisposable,this.tilesForRecalc=new Set,this.tilesForRedraw=new Set,this.needsFullRedraw=!1,this.pings=[],this._onClick=new c.EventDispatcher,this._onRightClick=new c.EventDispatcher,this._onMouseOver=new c.EventDispatcher,this._onMouseMove=new c.EventDispatcher,this._onMouseOut=new c.EventDispatcher,this.handleTileUpdate=({tiles:e})=>{e.forEach((e=>{this.tilesForRecalc.add(e),this.tilesForRedraw.add(e)}))},this.handleShroudUpdate=(e,t)=>{"incremental"===e.type?e.coords.forEach((e=>{var i;for(i of t.findTilesAtShroudCoords(e,this.map.tiles))this.tilesForRedraw.add(i)})):this.needsFullRedraw=!0},this.handleObjectChange=e=>{e.target.isSpawned&&this.map.tileOccupation.calculateTilesForGameObject(e.target.tile,e.target).forEach((e=>{this.tilesForRecalc.add(e),this.tilesForRedraw.add(e)}))},this.handleRadarEvent=e=>{if(e.target===this.localPlayer){var t=this.minimapRenderer.dxyToCanvas(e.tile.dx,e.tile.dy),i=m.get(e.radarEventType);let r=new u.MinimapPing(this.radarRules,i?.high??16711935,i?.low??8650884);r.setPosition(this.wrapperObj.position.x+t.x,this.wrapperObj.position.y+t.y),this.pings.push({obj:r,startTime:void 0,duration:this.radarRules.getEventVisibilityDuration(e.radarEventType)})}},this.minimapModel=new g.MinimapModel(e.map.tiles,e.map.tileOccupation,this.localPlayer&&e.mapShroudTrait.getPlayerShroud(this.localPlayer),this.localPlayer,this.game.alliances,this.game.rules.general.paradrop)}get onClick(){return this._onClick.asEvent()}get onRightClick(){return this._onRightClick.asEvent()}get onMouseOver(){return this._onMouseOver.asEvent()}get onMouseMove(){return this._onMouseMove.asEvent()}get onMouseOut(){return this._onMouseOut.asEvent()}get map(){return this.game.map}setFitSize(e){var t=this.fitSize;(this.fitSize=e).width===t?.width&&e.height===t?.height||this.forceRerender()}forceRerender(){var e,t,i,r;this.wrapperObj&&this.fitSize&&(this.get3DObject().remove(this.wrapperObj),this.destroyMesh(),({mesh:e,texture:t,wrapperObj:i,canvasLayoutSize:r}=this.renderMinimap(this.fitSize)),this.mesh=e,this.texture=t,this.wrapperObj=i,this.size=r,this.get3DObject().add(i),this.setupListeners(this.mesh),this.lastViewport=void 0)}initWorld(e){this.worldScene=e,this.mapTileIntersectHelper=new a.MapTileIntersectHelper(this.map,e)}create3DObject(){if(super.create3DObject(),!this.mesh){var e;if(!(e=this.fitSize))throw new Error("setFitSize must be called before first render");var{mesh:t,texture:i,wrapperObj:r,canvasLayoutSize:e}=this.renderMinimap(e);if(this.mesh=t,this.texture=i,this.wrapperObj=r,this.size=e,this.get3DObject().add(r),this.setupListeners(this.mesh),this.map.tileOccupation.onChange.subscribe(this.handleTileUpdate),this.disposables.add((()=>this.map.tileOccupation.onChange.unsubscribe(this.handleTileUpdate))),this.localPlayer){let e=this.game.mapShroudTrait.getPlayerShroud(this.localPlayer);e&&(e.onChange.subscribe(this.handleShroudUpdate),this.disposables.add((()=>e?.onChange.unsubscribe(this.handleShroudUpdate))))}this.disposables.add(this.game.events.subscribe(h.EventType.ObjectOwnerChange,this.handleObjectChange),this.game.events.subscribe(h.EventType.ObjectDisguiseChange,this.handleObjectChange),this.game.events.subscribe(h.EventType.ObjectDestroy,(e=>{var t;!e.target.isBuilding()||(t=e.target).rules.leaveRubble&&this.map.tileOccupation.calculateTilesForGameObject(t.tile,t).forEach((e=>{this.tilesForRecalc.add(e),this.tilesForRedraw.add(e)}))})),this.game.events.subscribe(h.EventType.RadarEvent,this.handleRadarEvent))}}renderMinimap(e){this.minimapRenderer=new n.MinimapRenderer(this.map,this.minimapModel,e,this.borderColor,2),this.minimapModel.computeAllColors();var t={width:.5*(s=this.minimapRenderer.renderFull()).width,height:.5*s.height},i=this.computeMinimapPosition(e,t),r=this.createTexture(s),s=this.createMesh(r,t.width,t.height);let a=new THREE.Object3D;return a.matrixAutoUpdate=!1,a.position.x=i.x,a.position.y=i.y,a.updateMatrix(),a.add(s),{mesh:s,texture:r,wrapperObj:a,canvasLayoutSize:t}}computeMinimapPosition(e,t){return{x:Math.floor((e.width-t.width)/2),y:Math.floor((e.height-t.height)/2)}}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t,i){let s=r.SpriteUtils.createRectGeometry(t,i);r.SpriteUtils.addRectUvs(s,{x:0,y:0,width:t,height:i},{width:t,height:i}),s.translate(t/2,i/2,0);var n=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});let a=new THREE.Mesh(s,n);return a.matrixAutoUpdate=!1,a.frustumCulled=!1,a}setupListeners(e){if(!this.pointerEvents)throw new Error("Must call setPointerEvents before rendering");this.disposables.add(this.pointerEvents.addEventListener(e,"click",(e=>{var t=this.computeIntersectionTile(e.intersection.uv);t&&(2===e.button||e.isTouch?this._onRightClick.dispatch(this,t):0===e.button&&this._onClick.dispatch(this,t))})),this.pointerEvents.addEventListener(e,"mouseover",(()=>this._onMouseOver.dispatch(this))),this.pointerEvents.addEventListener(e,"mousemove",(e=>this.queuedHoverUv=e.intersection.uv)),this.pointerEvents.addEventListener(e,"mouseout",(()=>this._onMouseOut.dispatch(this))))}computeIntersectionTile(e){return this.canvasCoordsToTile(e.x*this.size.width,e.y*this.size.height)}canvasCoordsToTile(e,t){let i=this.minimapRenderer.canvasToDxy(e,t);return i.x=Math.round(i.x),i.y=Math.round(i.y),this.map.tiles.getByDisplayCoords(i.x,i.y+(i.x%2-i.y%2))}update(e){if(super.update(e),!this.lastCanvasUpdate||e-this.lastCanvasUpdate>=1e3/30){if(this.tilesForRecalc.size&&(this.minimapModel.updateColors(this.tilesForRecalc),this.tilesForRecalc.clear()),this.needsFullRedraw&&(this.minimapRenderer.renderFull(),this.texture.needsUpdate=!0,this.needsFullRedraw=!1,this.tilesForRedraw.clear()),this.tilesForRedraw.size&&(this.lastCanvasUpdate=e,this.minimapRenderer.renderIncremental(this.tilesForRedraw),this.texture.needsUpdate=!0,this.tilesForRedraw.clear()),this.worldScene){var t=this.worldScene.cameraPan.getPan(),i=this.worldScene.viewport,r=!this.lastViewport||!s.rectEquals(i,this.lastViewport);if(!s.pointEquals(t,this.lastPan)||r){this.lastPan=t,this.lastViewport=i;var n=this.mapTileIntersectHelper.getTileAtScreenPoint({x:i.x+i.width/2,y:i.y+i.height/2});if(!n)return void console.warn("Current pan intersects no map tile");i=o.IsoCoords.screenToScreenTile(i.width/2,i.height/2),n={x:n.dx-i.x,y:n.dy-i.y,width:2*i.x,height:2*i.y},this.viewportOutline&&!r||(i=this.minimapRenderer.dxyToCanvas(n.x,n.y),i={width:(r=this.minimapRenderer.dxyToCanvas(n.x+n.width,n.y+n.height)).x-i.x,height:r.y-i.y},this.viewportOutline?this.updateOutlineSize(this.viewportOutline,i.width,i.height):(this.viewportOutline=this.createViewportOutline(i.width,i.height),this.viewportOutline.matrixAutoUpdate=!1,this.wrapperObj.add(this.viewportOutline))),n=this.minimapRenderer.dxyToCanvas(n.x,n.y),this.viewportOutline.position.x=Math.max(2,Math.floor(n.x)),this.viewportOutline.position.y=Math.max(1,Math.floor(n.y)),this.viewportOutline.updateMatrix()}}this.queuedHoverUv&&((n=this.computeIntersectionTile(this.queuedHoverUv))&&this._onMouseMove.dispatch(this,n),this.queuedHoverUv=void 0),this.pings.forEach((t=>{t.startTime?e-t.startTime>t.duration/(p.GameSpeed.BASE_TICKS_PER_SECOND/1e3*this.game.speed.value)&&(this.remove(t.obj),t.obj.destroy(),this.pings.splice(this.pings.indexOf(t),1)):(t.startTime=e,this.add(t.obj))}))}}createViewportOutline(e,t){let i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,t,0),new THREE.Vector3(e,t,0),new THREE.Vector3(e,0,0),new THREE.Vector3(0,0,0));var r=new THREE.LineBasicMaterial({color:this.borderColor,transparent:!0,side:THREE.DoubleSide});return new THREE.Line(i,r)}updateOutlineSize(e,t,i){let r=e.geometry;r.vertices[1].set(0,i,0),r.vertices[2].set(t,i,0),r.vertices[3].set(t,0,0),r.verticesNeedUpdate=!0}destroy(){super.destroy(),this.destroyMesh(),this.disposables.dispose()}destroyMesh(){this.mesh&&(this.mesh.geometry.dispose(),this.mesh.material.dispose()),this.texture?.dispose(),this.destroyViewportOutline()}destroyViewportOutline(){this.viewportOutline&&(this.wrapperObj?.remove(this.viewportOutline),this.viewportOutline.geometry.dispose(),this.viewportOutline.material.dispose(),this.viewportOutline=void 0)}},e("Minimap",f)}}})),System.register("gui/screen/game/component/hud/SidebarRadar",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/screen/game/component/hud/SidebarRadarAnimRunner"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends s.UiComponent{constructor(){super(...arguments),this.visible=!0,this.coverOpen=!1}createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);return e.setPosition(this.props.x||0,this.props.y||0),e}defineChildren(){return i.jsx("fragment",null,i.jsx("sprite",{image:this.props.image,palette:this.props.palette,zIndex:this.props.zIndex,ref:e=>this.cover=e,animationRunner:new a.SidebarRadarAnimationRunner(this.props.image)}),i.jsx("container",{ref:e=>this.minimapContainer=e,hidden:!0,x:13}))}onFrame(e){this.getUiObject().get3DObject().visible=this.visible;var t=this.props.sidebarModel;(t=t?.radarEnabled??!0)!==this.coverOpen&&(this.toggleCover(t),this.coverOpen=t),this.cover.getAnimationRunner().isStopped()&&this.minimapContainer.setVisible(this.coverOpen)}toggleCover(e){let t=this.cover.getAnimationRunner();e?t.radarOn():t.radarOff(),this.minimapContainer.setVisible(!1)}setMinimap(e){this.minimap&&this.minimapContainer.remove(this.minimap),(this.minimap=e)&&(e.setFitSize(this.getMinimapAvailSpace()),this.minimapContainer.add(e),e.setZIndex(this.props.zIndex+1))}getMinimapAvailSpace(){return{width:this.props.image.width-13-15,height:this.props.image.height}}hide(){this.visible=!1}show(){this.visible=!0}},e("SidebarRadar",o)}}})),System.register("gui/screen/game/component/hud/SidebarGameTime",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","gui/component/UiText","util/format"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends s.UiComponent{createUiObject(){return new r.UiObject(new THREE.Object3D,new n.HtmlContainer)}defineChildren(){var{textColor:e,width:t,height:r,zIndex:s}=this.props;return i.jsx(a.UiText,{ref:e=>this.text=e,value:"",textColor:e,width:t,height:r,zIndex:s})}onFrame(e){var{sidebarModel:{currentGameTime:t,replayTime:i,topTextLeftAlign:r}}=this.props;(!this.lastUpdate||50<=e-this.lastUpdate)&&(this.lastUpdate=e,this.lastGameTime!==t&&(this.text.setValue(o.formatTimeDuration(t)+(i?" / "+o.formatTimeDuration(i):"")),this.lastGameTime=t),r!==this.lastLeftAligned&&(r?(this.text.setTextAlign("left"),this.text.getUiObject().setPosition(15,0)):(this.text.setTextAlign("center"),this.text.getUiObject().setPosition(0,0)),this.lastLeftAligned=r))}},e("SidebarGameTime",l)}}})),System.register("gui/screen/game/component/hud/viewmodel/MessageList",["util/event"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MessageList",class{constructor(e,t,r){this.messageDurationSeconds=e,this.maxMessages=t,this.localPlayer=r,this.isComposing=!1,this.messages=[],this._onNewMessage=new i.EventDispatcher}get onNewMessage(){return this._onNewMessage.asEvent()}addUiFeedbackMessage(e){var t={text:e,color:this.localPlayer?.color.asHexString()??"grey",time:Date.now(),animate:!1};this.messages.push(t),this._onNewMessage.dispatch(this,t)}addSystemMessage(e,t,i){var r={text:e,color:"string"==typeof t?t:t.color.asHexString(),time:Date.now(),animate:!0,durationSeconds:i};this.messages.push(r),this._onNewMessage.dispatch(this,r)}addChatMessage(e,t){var i={text:e,color:t,time:Date.now(),animate:!0};this.messages.push(i),this._onNewMessage.dispatch(this,i)}prune(){let e=Date.now();this.messages=this.messages.filter((t=>t.time>=e-1e3*(t.durationSeconds??this.messageDurationSeconds))),this.messages.splice(0,this.messages.length-this.maxMessages)}getAll(){return this.messages}})}}})),System.register("gui/screen/game/component/hud/HudChat",["gui/component/ChatInput","network/gservConfig","react"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("HudChat",(({messageList:e,chatHistory:t,strings:n,onSubmit:a,onCancel:o})=>{if(!e.isComposing)return null;var l=e.localPlayer?.color.asHexString()??"white";return s.default.createElement(i.ChatInput,{chatHistory:t,channels:[r.RECIPIENT_ALL,r.RECIPIENT_TEAM],className:"game-chat-input",forceColor:l,noCycleHint:!0,submitEmpty:!0,strings:n,onKeyDown:e=>{"Escape"===e.key&&e.preventDefault(),e.stopPropagation(),e.nativeEvent.stopImmediatePropagation()},onKeyUp:e=>{e.stopPropagation(),e.nativeEvent.stopImmediatePropagation()},onSubmit:e=>{e.value.length?a(e):o()},onCancel:o,onBlur:o})}))}}})),System.register("gui/screen/game/component/hud/Messages",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","gui/jsx/HtmlView","gui/screen/game/component/hud/HudChat","network/chat/ChatMessage","network/gservConfig"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends s.UiComponent{createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let s=document.createElement("canvas");return s.width=t,s.height=i,this.ctx=s.getContext("2d",{alpha:!0}),this.texture=this.createTexture(s),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=a.SpriteUtils.createRectGeometry(e,t);a.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("fragment",null,i.jsx("container",{hidden:!0,ref:e=>this.inputContainer=e},i.jsx(l.HtmlView,{component:c.HudChat,props:{strings:this.props.strings,messageList:this.props.messages,chatHistory:this.props.chatHistory,onSubmit:this.props.onMessageSubmit,onCancel:this.props.onMessageCancel},innerRef:e=>this.inputComponent=e})),i.jsx("mesh",{zIndex:this.props.zIndex},this.mesh))}onFrame(e){var t,i,r,s,n;(!this.lastUpdate||e-this.lastUpdate>=1e3/30)&&(this.lastUpdate=e,this.props.messages.prune(),t=this.props.messages.getAll(),i=Date.now(),r=t[t.length-1]?.time,s=t.length,n=this.props.messages.isComposing,(this.lastComposing!==n||this.lastMessageTime!==r||s!==this.lastMessageCount||r&&i-r<=2e3)&&(this.lastMessageTime=r,this.lastMessageCount=s,this.lastComposing=n,this.drawMessages(n,t,i),this.inputContainer.setVisible(n),this.inputComponent.refresh()))}drawMessages(e,t,i){this.ctx.clearRect(0,0,this.props.width,this.props.height);var r=Math.floor(110*this.props.width/600);let s=!1;var n,a;let o=0;for(a of(e&&(o=20,(n=this.props.chatHistory.lastComposeTarget.value).type===h.ChatRecipientType.Channel&&n.name===u.RECIPIENT_ALL||(t=[{color:"gray",text:this.props.strings.get("TS:ChatCycleHint","Tab"),animate:!1,time:Date.now()},...t])),t)){var l,c=Math.min(1e3,10*a.text.length);c=a.animate?Math.min(1,(i-a.time)/c):1;let e=Math.round(c*a.text.length);for(l of(c<1&&(s=!0),this.wrapText(a.text,r)))l.length>e?(l=l.slice(0,e),e=0):e-=l.length,o+=this.drawLine(l,a.color,o)}this.texture.needsUpdate=!0,s&&this.props.onMessageTick?.()}drawLine(e,t,i){return o.CanvasUtils.drawText(this.ctx,e,0,i,{color:t,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:13,fontWeight:"500",paddingTop:5,height:20,backgroundColor:"rgba(0, 0, 0, .75)",paddingLeft:4,paddingRight:4}).height}wrapText(e,t){let i=[];for(;e.length>t;){let r=e.slice(0,t).search(/\s[^\s]*$/);-1!==r&&0!==r||(r=Math.min(e.length,t)),i.push(e.substr(0,r)),e=e.slice(r)}return e.length&&i.push(e),i}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("Messages",d)}}})),System.register("gui/screen/game/component/hud/SuperWeaponTimers",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils","game/GameSpeed","util/format"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class extends s.UiComponent{createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let s=document.createElement("canvas");return s.width=t,s.height=i,this.ctx=s.getContext("2d",{alpha:!0}),this.texture=this.createTexture(s),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=a.SpriteUtils.createRectGeometry(e,t);a.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(e){if(!this.lastUpdate||100<=e-this.lastUpdate){this.lastUpdate=e;let y=[];var t,i;this.props.stalemateDetectTrait?.isStale()&&(t=Math.floor(this.props.stalemateDetectTrait.getCountdownTicks()/l.GameSpeed.BASE_TICKS_PER_SECOND),t=this.props.strings.get("TS:StalemateTimer")+"   "+c.formatTimeDuration(t,!0),y.push({text:t,color:"red",flash:!0}));let T=this.props.countdownTimer;for(i of(T.isRunning()&&(g=T.getSeconds(),g=(void 0!==T.text?this.props.strings.get(T.text)+"   ":"")+c.formatTimeDuration(g,!0),y.push({text:g,color:this.props.localPlayer?.color.asHexString()??"white",flash:!1})),this.props.players))if(!i.defeated){var r=i.superWeaponsTrait?.getAll(),s=(i.powerTrait?.getBlackoutDuration()??0)/l.GameSpeed.BASE_TICKS_PER_SECOND;if(r?.length||s){var n,a,o=i.color.asHexString();let e=[];if(r)for(var h of r)h.rules.showTimer&&e.push({seconds:h.getTimerSeconds(),label:this.props.strings.get(h.rules.uiName)});for({seconds:n,label:a}of(s&&e.push({seconds:s,label:this.props.strings.get("MSG:BlackoutTimer")}),e)){var u=Math.floor(n),d=a+"   "+c.formatTimeDuration(u,!0);y.push({text:d,color:o,flash:0===u})}}}var g=!!y.length;if(g!==this.lastHasTimers||g){this.lastHasTimers=g,this.ctx.clearRect(0,0,this.props.width,this.props.height);let t=this.props.height-20;for(var{text:p,color:m,flash:f}of y)f&&(m=Math.floor(e/1e3)%2?m:"orange"),t-=this.drawLine(p,m,t);this.texture.needsUpdate=!0}}}drawLine(e,t,i){return o.CanvasUtils.drawText(this.ctx,e,0,i,{color:t,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:6,height:20,backgroundColor:"rgba(0, 0, 0, .75)",textAlign:"right",paddingLeft:4,paddingRight:4}).height}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("SuperWeaponTimers",h)}}})),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Separator=0]="Separator",t[t.BugReport=1]="BugReport",t[t.Beacon=2]="Beacon",t[t.Cheer=3]="Cheer",t[t.Deploy=4]="Deploy",t[t.Guard=5]="Guard",t[t.PlanningMode=6]="PlanningMode",t[t.Stop=7]="Stop",t[t.Team01=8]="Team01",t[t.Team02=9]="Team02",t[t.Team03=10]="Team03",t[t.TypeSelect=11]="TypeSelect",t[t.ReplayRewind=12]="ReplayRewind",t[t.ReplayPlay=13]="ReplayPlay",t[t.ReplayPause=14]="ReplayPause",t[t.ReplaySpeed=15]="ReplaySpeed",e("CommandBarButtonType",i)}}})),System.register("gui/screen/game/component/hud/commandBar/CommandButtonConfig",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/game/component/hud/commandBar/commandButtonConfigs",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("commandButtonConfigs",[{type:i.CommandBarButtonType.BugReport,icon:"reportbug.shp",tooltip:e=>e.get("ts:reportbug")},{type:i.CommandBarButtonType.Team01,icon:"button00.shp",tooltip:e=>e.get("tip:team01")},{type:i.CommandBarButtonType.Team02,icon:"button01.shp",tooltip:e=>e.get("tip:team02")},{type:i.CommandBarButtonType.Team03,icon:"button02.shp",tooltip:e=>e.get("tip:team03")},{type:i.CommandBarButtonType.TypeSelect,icon:"button03.shp",tooltip:e=>e.get("tip:typeselect")},{type:i.CommandBarButtonType.Deploy,icon:"button04.shp",tooltip:e=>e.get("tip:deploy")},{type:i.CommandBarButtonType.Guard,icon:"button06.shp",tooltip:e=>e.get("tip:guard")},{type:i.CommandBarButtonType.Beacon,icon:"button07.shp",tooltip:e=>e.get("tip:beacon")},{type:i.CommandBarButtonType.Stop,icon:"button08.shp",tooltip:e=>e.get("tip:stop")},{type:i.CommandBarButtonType.PlanningMode,icon:"button09.shp",tooltip:e=>e.get("tip:planningmode")},{type:i.CommandBarButtonType.Cheer,icon:"button10.shp",tooltip:e=>e.get("tip:cheer")},{type:i.CommandBarButtonType.ReplayRewind,icon:"rewind.shp",tooltip:e=>e.get("tip:replayrewind")},{type:i.CommandBarButtonType.ReplayPlay,icon:"play.shp",tooltip:e=>e.get("tip:play")},{type:i.CommandBarButtonType.ReplayPause,icon:"pause.shp",tooltip:e=>e.get("tip:pause")},{type:i.CommandBarButtonType.ReplaySpeed,icon:"ffwd.shp",tooltip:e=>e.get("tip:replayspeed")}])}}})),System.register("gui/screen/game/component/hud/DebugText",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends s.UiComponent{createUiObject(){let e=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);e.setPosition(this.props.x||0,this.props.y||0);var t=this.props.width,i=this.props.height;let s=document.createElement("canvas");return s.width=t,s.height=i,this.ctx=s.getContext("2d",{alpha:!0}),this.texture=this.createTexture(s),this.mesh=this.createMesh(t,i),e}createTexture(e){let t=new THREE.Texture(e);return t.needsUpdate=!0,t.flipY=!1,t.minFilter=THREE.NearestFilter,t.magFilter=THREE.NearestFilter,t}createMesh(e,t){let i=a.SpriteUtils.createRectGeometry(e,t);a.SpriteUtils.addRectUvs(i,{x:0,y:0,width:e,height:t},{width:e,height:t}),i.translate(e/2,t/2,0);var r=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!0});let s=new THREE.Mesh(i,r);return s.frustumCulled=!1,s}defineChildren(){return i.jsx("mesh",{zIndex:this.props.zIndex},this.mesh)}onFrame(e){if(!this.lastUpdate||e-this.lastUpdate>=1e3/30){this.lastUpdate=e;let i=this.props.text.value;var t;this.props.visible.value!==this.getUiObject().isVisible()&&this.getUiObject().setVisible(this.props.visible.value),this.lastText!==i&&(this.lastText=i,t=i.split(/\r?\n/g),this.drawLines(t))}}drawLines(e){this.ctx.clearRect(0,0,this.props.width,this.props.height);var t,i,r=Math.floor(110*this.props.width/600);let s=0;for(t of e)for(i of this.wrapText(t,r))s+=this.drawLine(i,this.props.color,s);this.texture.needsUpdate=!0}drawLine(e,t,i){var r=.5<.299*t.r+.587*t.g+.114*t.b?"black":"white";return o.CanvasUtils.drawText(this.ctx,e,0,i,{color:"#"+t.getHexString(),outlineColor:r,outlineWidth:2,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"400",paddingTop:6,height:20,paddingLeft:4,paddingRight:4}).height}wrapText(e,t){let i=[];for(;e.length>t;){let r=e.slice(0,t).search(/\s[^\s]*$/);-1!==r&&0!==r||(r=Math.min(e.length,t)),i.push(e.substr(0,r)),e=e.slice(r)}return e.length&&i.push(e),i}onDispose(){this.mesh.geometry.dispose(),this.mesh.material.dispose(),this.texture.dispose()}},e("DebugText",l)}}})),System.register("gui/screen/game/component/Hud",["gui/jsx/jsx","data/ShpFile","game/SideType","gui/screen/game/component/hud/SidebarCard","gui/screen/game/component/hud/SidebarTabs","gui/screen/game/component/hud/SidebarIconButton","gui/screen/game/component/hud/SidebarMenu","gui/UiObject","gui/HtmlContainer","util/event","gui/screen/game/component/hud/GameMenuContentArea","gui/screen/game/component/hud/SidebarPower","gui/screen/game/component/hud/SidebarCredits","gui/screen/game/component/hud/SidebarRadar","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/SidebarGameTime","gui/screen/game/component/hud/Messages","gui/screen/game/component/hud/SuperWeaponTimers","engine/renderable/builder/ShpAggregator","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/component/hud/commandBar/commandButtonConfigs","util/typeGuard","gui/screen/game/component/hud/DebugText"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e}],execute:function(){x=class extends c.UiObject{constructor(e,t,i,r,s,n,a,o,l,c,d,g,p,m,f,y,T){super(new THREE.Object3D,new h.HtmlContainer),this.sideType=e,this.viewport=t,this.images=i,this.palettes=r,this.cameoFilenames=s,this.sidebarModel=n,this.messageList=a,this.chatHistory=o,this.debugTextValue=l,this.debugTextEnabled=c,this.localPlayer=d,this.players=g,this.stalemateDetectTrait=p,this.countdownTimer=m,this.jsxRenderer=f,this.strings=y,this.commandBarButtonTypes=T,this._onDiploButtonClick=new u.EventDispatcher,this._onOptButtonClick=new u.EventDispatcher,this._onRepairButtonClick=new u.EventDispatcher,this._onSellButtonClick=new u.EventDispatcher,this._onSidebarSlotClick=new u.EventDispatcher,this._onSidebarTabClick=new u.EventDispatcher,this._onCreditsTick=new u.EventDispatcher,this._onMessagesTick=new u.EventDispatcher,this._onMessageSubmit=new u.EventDispatcher,this._onMessageCancel=new u.EventDispatcher,this._onScrollButtonClick=new u.EventDispatcher,this._onCommandBarButtonClick=new u.EventDispatcher,this.commandBarButtons=[],this.init()}get onDiploButtonClick(){return this._onDiploButtonClick.asEvent()}get onOptButtonClick(){return this._onOptButtonClick.asEvent()}get onRepairButtonClick(){return this._onRepairButtonClick.asEvent()}get onSellButtonClick(){return this._onSellButtonClick.asEvent()}get onSidebarSlotClick(){return this._onSidebarSlotClick.asEvent()}get onSidebarTabClick(){return this._onSidebarTabClick.asEvent()}get onCreditsTick(){return this._onCreditsTick.asEvent()}get onMessagesTick(){return this._onMessagesTick.asEvent()}get onMessageSubmit(){return this._onMessageSubmit.asEvent()}get onMessageCancel(){return this._onMessageCancel.asEvent()}get onScrollButtonClick(){return this._onScrollButtonClick.asEvent()}get onCommandBarButtonClick(){return this._onCommandBarButtonClick.asEvent()}getImage(e){var t=this.images.get(e);if(!t)throw new Error(`Missing image "${e}"`);return t}init(){const e=this.palettes.get("sidebar.pal");if(!e)throw new Error('Missing palette "sidebar.pal"');var t=this.getImage("credits.shp"),r=this.getImage("top.shp"),l=this.getImage("radar.shp"),c=this.getImage("side1.shp");let h=this.getImage("side2.shp"),u=this.getImage("side2b.shp");var S=this.getImage("side3.shp"),x=this.getImage("addon.shp");let O=this.getImage("tab00.shp"),A=this.getImage("tab01.shp"),M=this.getImage("tab02.shp"),R=this.getImage("tab03.shp"),P=this.getImage("diplobtn.shp"),I=this.getImage("optbtn.shp"),k=this.getImage("repair.shp"),B=this.getImage("sell.shp"),j=this.getImage("r-up.shp"),N=this.getImage("r-dn.shp");var L=[...new Set(this.commandBarButtonTypes.map((e=>w.commandButtonConfigs.find((t=>t.type===e))?.icon)))].map((e=>e?this.images.get(e):void 0)).filter(C.isNotNullOrUndefined);let D=(new b.ShpAggregator).aggregate([P,I,k,B,O,A,M,R,N,j,...L].map((e=>b.ShpAggregator.getShpFrameInfo(e,!1))),"agg_hud.shp");var F=this.sidebarWidth=t.width,_={x:this.viewport.width-F,y:0,width:F,height:this.viewport.height},U=t.height+r.height,H=U+l.height;let G=U+l.height+c.height;var V=this.repeaterCount=Math.floor((_.height-G-S.height)/h.height);let W=this.repeaterHeight=h.height;var z=U+l.height+c.height+W*V;let K=this.getImage("lendcap.shp");var q=this.actionBarHeight=K.height,$=this.viewport.y+this.viewport.height-q;let Q=this.getImage("bttnbkgd.shp");var Z=this.getImage("rendcap.shp"),Y=_.x-K.width-Z.width,X=Math.floor(Y/Q.width),J=Y%Q.width;let ee;J&&(ee=Q.clip(J,Q.height));let te={x:12,y:4};this.sideType===s.SideType.Nod&&(te={x:14,y:5});let ie={x:20,y:8};this.sideType===s.SideType.Nod&&(ie={x:34,y:7});let re=1,se={x:26,y:-3};this.sideType===s.SideType.Nod&&(re=0,se={x:20,y:-2});var ne=this.palettes.get("cameo.pal");if(!ne)throw new Error('Missing palette "cameo.pal"');L=this.buildCameoFile(),F=this.createCameoNameToIdMap();q=this.sideType===s.SideType.GDI?{x:5,y:2}:{x:0,y:0};Y=this.getImage("powerp.shp"),J=this.getTextColor(),this.add(...this.jsxRenderer.render(i.jsx("fragment",null,i.jsx("container",{x:_.x,y:_.y},i.jsx("sprite-batch",null,i.jsx("sprite",{static:!0,image:t,palette:e}),i.jsx("container",{ref:e=>this.sidebarTop=e,zIndex:1},this.sidebarModel instanceof f.CombatantSidebarModel?i.jsx(p.SidebarCredits,{sidebarModel:this.sidebarModel,height:t.height,width:t.width,textColor:J,onTick:e=>this._onCreditsTick.dispatch(this,e)}):i.jsx(y.SidebarGameTime,{sidebarModel:this.sidebarModel,height:t.height,width:t.width,textColor:J})),i.jsx("sprite",{static:!0,image:r,palette:e,y:t.height}),i.jsx("sprite",{static:!0,image:l,palette:e,y:U}),i.jsx(m.SidebarRadar,{image:l,palette:e,y:U,sidebarModel:this.sidebarModel instanceof f.CombatantSidebarModel?this.sidebarModel:void 0,zIndex:1,ref:e=>this.sidebarRadar=e}),i.jsx("sprite",{static:!0,image:c,palette:e,y:H}),new Array(V).fill(0).map(((t,r)=>i.jsx("sprite",{static:!0,image:u,palette:e,y:G+W*r}))),i.jsx("sprite-batch",{ref:e=>this.sideCameoRepeaters=e},new Array(V).fill(0).map(((t,r)=>i.jsx("sprite",{static:!0,image:h,palette:e,y:G+W*r,zIndex:1})))),i.jsx(g.SidebarPower,{sidebarModel:this.sidebarModel,powerImg:Y,palette:e,x:q.x,y:G,height:W*V+q.y,ref:e=>this.sidebarPower=e,zIndex:2,strings:this.strings}),i.jsx(n.SidebarCard,{cameoImages:L,cameoPalette:ne,cameoNameToIdMap:F,sidebarModel:this.sidebarModel,slots:2*V,onSlotClick:e=>this._onSidebarSlotClick.dispatch(this,e),x:22,y:G+1,strings:this.strings,textColor:J,ref:e=>this.sidebarCard=e,zIndex:2}),i.jsx("container",{ref:e=>this.sidebarMenuContainer=e,x:21,y:G+1,zIndex:2}),i.jsx("sprite",{static:!0,image:S,palette:e,y:z}),i.jsx("sprite",{static:!0,image:x,palette:e,y:z+S.height}))),i.jsx("container",{x:_.x,y:_.y,ref:e=>this.sidebarButtonsContainer=e,zIndex:2},i.jsx(o.SidebarIconButton,{image:D.file,palette:e,imageFrameOffset:D.imageIndexes.get(P),x:te.x,y:t.height+te.y,onClick:()=>this._onDiploButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:DiplomacyButton")}),i.jsx(o.SidebarIconButton,{image:D.file,palette:e,imageFrameOffset:D.imageIndexes.get(I),x:te.x+P.width,y:t.height+te.y,onClick:()=>this._onOptButtonClick.dispatch(this,void 0),tooltip:this.strings.get("Tip:OptionsButton")}),i.jsx(o.SidebarIconButton,{image:D.file,palette:e,imageFrameOffset:D.imageIndexes.get(k),x:ie.x,y:H+ie.y,toggle:this.sidebarModel.repairMode,ref:e=>this.repairButton=e,onClick:()=>this._onRepairButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_REPAIR_MODE")}),i.jsx(o.SidebarIconButton,{image:D.file,palette:e,imageFrameOffset:D.imageIndexes.get(B),x:ie.x+k.width,y:H+ie.y,toggle:this.sidebarModel.sellMode,ref:e=>this.sellButton=e,onClick:()=>this._onSellButtonClick.dispatch(this,void 0),tooltip:this.strings.get("TXT_SELL_MODE")}),i.jsx(a.SidebarTabs,{aggregatedImageData:D,images:[O,A,M,R],palette:e,sidebarModel:this.sidebarModel,tabSpacing:re,onTabClick:e=>{this.sidebarModel.selectTab(e.id),this._onSidebarTabClick.dispatch(this,e.id)},strings:this.strings,x:se.x,y:G-O.height+se.y}),i.jsx(o.SidebarIconButton,{image:D.file,palette:e,disabled:!0,imageFrameOffset:D.imageIndexes.get(N),x:38,y:z+7,ref:e=>this.pgDnButton=e,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageDown())}),i.jsx(o.SidebarIconButton,{image:D.file,palette:e,disabled:!0,imageFrameOffset:D.imageIndexes.get(j),x:38+N.width,y:z+7,ref:e=>this.pgUpButton=e,onClick:()=>this._onScrollButtonClick.dispatch(this,this.sidebarCard.pageUp())})),i.jsx("container",{x:this.viewport.x,y:$},i.jsx("container",{x:K.width,zIndex:1},this.renderCommandBarButtons(D,this.commandBarButtonTypes,Q.width,X)),i.jsx("sprite-batch",null,i.jsx("sprite",{static:!0,image:K,palette:e}),new Array(X).fill(0).map(((t,r)=>i.jsx("sprite",{static:!0,image:Q,palette:e,x:K.width+Q.width*r}))),ee?i.jsx("sprite",{static:!0,image:ee,palette:e,x:K.width+X*Q.width}):[],i.jsx("sprite",{static:!0,image:Z,palette:e,x:_.x-Z.width}))),i.jsx(T.Messages,{messages:this.messageList,chatHistory:this.chatHistory,width:_.x-10,height:200,ref:e=>this.messages=e,strings:this.strings,onMessageTick:()=>this._onMessagesTick.dispatch(this),onMessageSubmit:e=>this._onMessageSubmit.dispatch(this,e),onMessageCancel:()=>this._onMessageCancel.dispatch(this)}),i.jsx(E.DebugText,{text:this.debugTextValue,visible:this.debugTextEnabled,color:new THREE.Color(16777215),x:20,y:200,width:Math.floor(_.x/2),height:200,ref:e=>this.debugText=e}),i.jsx(v.SuperWeaponTimers,{localPlayer:this.localPlayer,players:this.players,stalemateDetectTrait:this.stalemateDetectTrait,countdownTimer:this.countdownTimer,strings:this.strings,width:200,height:500,x:_.x-200,y:$-500,ref:e=>this.superWeaponTimers=e}),i.jsx(d.GameMenuContentArea,{hidden:!0,screenSize:this.viewport,viewport:{x:this.viewport.x,y:this.viewport.y,width:_.x,height:$},images:this.images,ref:e=>this.menuContentContainer=e.getUiObject(),innerRef:e=>this.menuContentContainerInner=e}))))}getTextColor(){return this.sideType===s.SideType.GDI?"rgb(165,211,255)":"yellow"}createSidebarMenu(e){return this.jsxRenderer.render(i.jsx(l.SidebarMenu,{buttonImg:this.getImage("sidebttn.shp"),buttonPal:"sidebar.pal",menuHeight:this.repeaterHeight*this.repeaterCount-2,buttons:e}))[0]}showSidebarMenu(e){this.destroySidebarMenu(),this.sidebarMenu=this.createSidebarMenu(e),this.sidebarMenuContainer.add(this.sidebarMenu),this.sideCameoRepeaters.setVisible(!1),this.remove(this.sidebarButtonsContainer),this.sidebarCard.hide(),this.sidebarPower.hide(),this.sidebarTop?.setVisible(!1),this.sidebarRadar?.hide(),this.commandBarButtons?.forEach((e=>e.getUiObject().setVisible(!1))),this.messages.getUiObject().setVisible(!1),this.debugText.getUiObject().setVisible(!1),this.superWeaponTimers.getUiObject().setVisible(!1)}hideSidebarMenu(){this.sideCameoRepeaters.setVisible(!0),this.destroySidebarMenu(),this.add(this.sidebarButtonsContainer),this.sidebarCard.show(),this.sidebarPower.show(),this.sidebarTop?.setVisible(!0),this.sidebarRadar?.show(),this.commandBarButtons?.forEach((e=>e.getUiObject().setVisible(!0))),this.messages.getUiObject().setVisible(!0),this.debugText.getUiObject().setVisible(!0),this.superWeaponTimers.getUiObject().setVisible(!0)}setMenuContentComponent(e){let t=this.menuContentContainerInner;this.menuContent&&(t.remove(this.menuContent),this.menuContent.destroy(),this.menuContent=void 0),e&&(t.add(e),this.menuContent=e)}setMinimap(e){this.sidebarRadar.setMinimap(e)}toggleMenuContentVisibility(e){this.menuContentContainer.setVisible(e)}renderCommandBarButtons(e,t,r,s){let n=0,a=[];for(let h of t.slice(0,s))if(h!==S.CommandBarButtonType.Separator){let t=w.commandButtonConfigs.find((e=>e.type===h));var l,c;t?(l=this.images.get(t.icon))?(c=e.imageIndexes.get(l),a.push(i.jsx(o.SidebarIconButton,{image:void 0!==c?e.file:l,imageFrameOffset:c,palette:"sidebar.pal",tooltip:t.tooltip(this.strings),x:n,onClick:()=>{this._onCommandBarButtonClick.dispatch(this,h)},ref:e=>this.commandBarButtons.push(e)})),n+=l.width):console.warn(`Missing image for command bar button "${S.CommandBarButtonType[h]}"`):console.warn(`Unknown command bar button type "${h}"`)}else n+=r;return a}buildCameoFile(){let e=new r.ShpFile;return e.filename="agg_cameos.shp",this.cameoFilenames.forEach((t=>{let i=this.getImage(t);e.width||(e.width=i.width),e.height||(e.height=i.height),e.addImage(i.getImage(0))})),e}createCameoNameToIdMap(){let e=new Map;for(let t=0;t<this.cameoFilenames.length;++t)e.set(this.cameoFilenames[t],t);return e}destroySidebarMenu(){this.sidebarMenu&&(this.sidebarMenuContainer.remove(this.sidebarMenu),this.sidebarMenu.destroy())}update(e){super.update(e),this.repairButton?.setToggleState(this.sidebarModel.repairMode),this.sellButton?.setToggleState(this.sidebarModel.sellMode);var t=0<this.sidebarModel.activeTab.items.length-2*this.repeaterCount;this.pgUpButton?.setDisabled(!t),this.pgDnButton?.setDisabled(!t)}destroy(){this.sidebarButtonsContainer.destroy(),this.destroySidebarMenu(),this.sidebarRadar.setMinimap(void 0),super.destroy()}},e("Hud",x)}}})),System.register("util/PointerLock",["util/event","util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("PointerLock",class{constructor(e,t){this.element=e,this.document=t,this._onChange=new i.EventDispatcher,this.disposables=new r.CompositeDisposable,this.listening=!1}get onChange(){return this._onChange.asEvent()}async request(e){if(e?.unadjustedMovement)try{await this.requestInternal({unadjustedMovement:!0})}catch(e){if("NotSupportedError"!==e.name)throw e;await this.requestInternal()}else await this.requestInternal()}async requestInternal(e){if(!this.isActive()){if(!this.listening){this.listening=!0;const e=()=>{this._onChange.dispatch(this,this.isActive())};this.document.addEventListener("pointerlockchange",e,!1),this.disposables.add((()=>this.document.removeEventListener("pointerlockchange",e,!1)));let t=()=>{this.exit().catch((e=>console.error(e)))};this.document.addEventListener("touchstart",t,!1),this.disposables.add((()=>this.document.removeEventListener("touchstart",t,!1)))}return new Promise(((t,i)=>{const r=()=>{this.document.removeEventListener("pointerlockchange",r,!1),this.document.removeEventListener("pointerlockerror",s,!1),t()},s=e=>{this.document.removeEventListener("pointerlockchange",r,!1),this.document.removeEventListener("pointerlockerror",s,!1),i(e)};this.document.addEventListener("pointerlockerror",s,!1),this.document.addEventListener("pointerlockchange",r,!1),this.element.requestPointerLock(e)?.catch?.(i)}))}}async exit(){if(this.isActive())return new Promise(((e,t)=>{const i=()=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),e()},r=e=>{this.document.removeEventListener("pointerlockchange",i,!1),this.document.removeEventListener("pointerlockerror",r,!1),t(e)};this.document.addEventListener("pointerlockerror",r,!1),this.document.addEventListener("pointerlockchange",i,!1),this.document.exitPointerLock()}))}isActive(){return this.element===this.document.pointerLockElement}dispose(){this.disposables.dispose()}})}}})),System.register("gui/PointerSprite",["gui/UiObject","engine/gfx/ImageUtils","gui/HtmlContainer"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class e extends i.UiObject{constructor(e,t,i){super(new THREE.Object3D,new s.HtmlContainer),this.images=e,this.size=t,this.frameCount=i,this.currentFrame=0}static fromShpFile(e,t){return new this(r.ImageUtils.convertShpToCanvas(e,t),{width:e.width,height:e.height},e.numImages)}setAnimationRunner(e){this.animationRunner=e}getAnimationRunner(){return this.animationRunner}update(e){super.update(e),this.animationRunner&&(this.animationRunner.tick(e),this.animationRunner.shouldUpdate()&&this.setFrame(this.animationRunner.getCurrentFrame()))}getSize(){return this.size}setFrame(e){if(e!==this.currentFrame){if(e<0||this.frameCount<=e)throw new RangeError(`Pointer frame index out of bounds (index=${e}, length=${this.frameCount})`);this.currentFrame=e,this.drawFrame(e)}}drawFrame(e){this.targetContext&&(this.targetContext.clearRect(0,0,this.size.width,this.size.height),this.targetContext.drawImage(this.images,e*this.size.width,0,this.size.width,this.size.height,0,0,this.size.width,this.size.height))}getFrame(){return this.currentFrame}getFrameCount(){return this.frameCount}create3DObject(){if(super.create3DObject(),!this.targetContext){let i=document.createElement("canvas"),r=this.getHtmlContainer();r.setTranslateMode(!0);let s=r.getElement();s.appendChild(i),s.style.zIndex=""+e.HTML_ZINDEX;var t=i.getContext("2d",{alpha:!0});if(!t)throw new Error("Couldn't create pointer canvas context");this.targetContext=t,this.drawFrame(this.currentFrame)}}destroy(){super.destroy()}},e("PointerSprite",n),n.HTML_ZINDEX=100}}})),System.register("gui/Pointer",["util/PointerLock","util/math","util/disposable/CompositeDisposable","gui/PointerSprite","gui/PointerEvents","gui/PointerType","engine/animation/SimpleRunner","engine/Animation","engine/AnimProps","data/IniSection","util/BoxedVar"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){e("Pointer",class e{constructor(e,t,i,n,a,l){this.pointerLock=e,this.sprite=t,this.document=i,this.canvas=n,this.canvasMetrics=a,this.mouseAcceleration=l,this.userLockMode=!1,this.userPointerVisible=!0,this.userPermissionGranted=!1,this.position={x:0,y:0},this.disposables=new s.CompositeDisposable,this.pointerType=o.PointerType.Default,this.pointerSubFrame=0,this.onMouseMove=e=>{let t=this.position;this.pointerLock.isActive()?(t.x=t.x+e.movementX,t.y=t.y+e.movementY):(t.x=e.pageX-this.canvasMetrics.x,t.y=e.pageY-this.canvasMetrics.y),t.x=r.clamp(t.x,0,this.canvasMetrics.width-1),t.y=r.clamp(t.y,0,this.canvasMetrics.height-1),this.updateSpritePosition()}}static factory(t,r,s,o,l,c){let h=n.PointerSprite.fromShpFile(t,r);h.setVisible(!1);var u=s.getCanvas(),d=new i.PointerLock(u,o);let g=new e(d,h,o,u,l,c);return g.pointerEvents=new a.PointerEvents(s,g.getPosition(),o,l),g.disposables.add(g.pointerEvents),g}getPosition(){return this.position}getPointerLock(){return this.pointerLock}init(){this.listenForFirstCanvasClick(),this.pointerLock.onChange.subscribe((e=>{this.sprite.setVisible(this.userPointerVisible&&e);const t=()=>{this.userLockMode&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch((e=>{console.warn("Couldn't acquire pointer lock.",e),this.canvas.addEventListener("click",t,{once:!0})}))};e||(this.canvas.addEventListener("click",t,{once:!0}),this.disposables.add((()=>this.canvas.removeEventListener("click",t))))})),this.document.addEventListener("mousemove",this.onMouseMove,!0),this.disposables.add((()=>this.document.removeEventListener("mousemove",this.onMouseMove,!0)))}listenForFirstCanvasClick(){const e=async()=>{if(!this.userPermissionGranted)try{await this.pointerLock.request(),this.userLockMode||await this.pointerLock.exit(),this.userPermissionGranted=!0}catch(t){console.warn("Couldn't acquire initial pointer lock",t),this.canvas.addEventListener("click",e,{once:!0})}};this.canvas.addEventListener("click",e,{once:!0}),this.disposables.add((()=>this.canvas.removeEventListener("click",e)))}lock(){this.userLockMode=!0,this.userPermissionGranted&&this.pointerLock.request({unadjustedMovement:!this.mouseAcceleration.value}).catch((e=>{console.warn("Couldn't reacquire pointer lock. Will attempt to require lock on next click",e),this.userPermissionGranted=!1,this.listenForFirstCanvasClick()}))}unlock(){this.userLockMode=!1,this.pointerLock.exit().catch((e=>console.error("Couldn't release pointer lock. This should never happen",e)))}setVisible(e){this.userPointerVisible=e,this.sprite.setVisible(e&&this.pointerLock.isActive())}getUserLockMode(){return this.userLockMode}getSprite(){return this.sprite}setPointerType(e,t=0){if(this.pointerType!==e||this.pointerSubFrame!==t){if(this.pointerType=e,this.pointerSubFrame=t,this.sprite.setAnimationRunner(void 0),[o.PointerType.Scroll,o.PointerType.NoScroll,o.PointerType.Pan].includes(e))this.sprite.setFrame(e+t);else{var i=e,r=(Object.keys(o.PointerType).map(Number).find((t=>!Number.isNaN(t)&&e<t))??this.sprite.getFrameCount())-1;if(this.sprite.setFrame(i),i<r){let e=new l.SimpleRunner,t=new h.AnimProps(new u.IniSection("dummy"),this.sprite.getFrameCount());t.loopCount=-1,t.start=i,t.loopStart=i,t.loopEnd=r,r=new c.Animation(t,new d.BoxedVar(1.5)),e.animation=r,this.sprite.setAnimationRunner(e)}}this.updateSpritePosition()}}updateSpritePosition(){let e={...this.position};var t=this.sprite.getSize(),i=Math.floor(t.width/2),s=Math.floor(t.height/2);this.pointerType>o.PointerType.Mini&&(e.x-=i,e.y-=s),[o.PointerType.Scroll,o.PointerType.NoScroll,o.PointerType.Pan].includes(this.pointerType)&&(e.x=r.clamp(e.x,0,this.canvasMetrics.width-1-t.width),e.y=r.clamp(e.y,0,this.canvasMetrics.height-1-t.height)),this.sprite.setPosition(e.x,e.y)}dispose(){this.disposables.dispose()}})}}})),System.register("tools/ShpTester",["engine/gfx/Renderer","gui/UiScene","gui/screen/game/component/Hud","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","game/rules/Rules","game/art/Art","game/Country","game/Player","game/World","game/gameobject/ObjectFactory","game/art/ObjectArt","engine/type/ObjectType","engine/UiAnimationLoop","game/Game","gui/jsx/JsxRenderer","util/disposable/CompositeDisposable","game/Alliances","game/PlayerList","gui/Pointer","util/BoxedVar","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","game/gameobject/selection/UnitSelection","game/ini/GameModeType","util/math","engine/TheaterType","game/GameMap","game/player/trait/RadarTrait","gui/screen/game/component/Minimap","game/player/production/Production","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","gui/screen/game/component/hud/viewmodel/MessageList","game/trait/MapShroudTrait","game/trait/SellTrait","game/map/MapBounds","engine/mixDatabase","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/CanvasMetrics","game/trait/StalemateDetectTrait","game/CountdownTimer","data/IniSection","gui/chat/ChatHistory"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e}],execute:function(){e("ShpTester",K=class{static async main(e,t,T,K){let q=new i.Renderer(800,600);q.init(T),q.initStats(document.body),this.disposables.add(q);let $=r.UiScene.factory({x:0,y:0,width:800,height:600});this.disposables.add($),await e.addMixFile("sidec01.mix");var Q=_.mixDatabase.get("cameo.mix");if(!Q)throw new Error("Missing file list database for cameos");let Z=new o.Rules(n.Engine.getRules()),Y=new l.Art(Z,n.Engine.getArt());var X=await n.Engine.loadTheater(R.TheaterType.Temperate),J=new P.GameMap(t,X.tileSets,Z,M.getRandomInt),ee={superWeapons:!1,gameSpeed:5},te=c.Country.factory("Americans",Z);let ie=new h.Player("Player",te);ie.radarTrait=new I.RadarTrait,ie.production=new B.Production(ie,10,ee,Z,[...Z.buildingRules.values(),...Z.infantryRules.values()]),this.disposables.add(ie);var re=new u.World,se=new b.PlayerList,ne=new v.Alliances(se),ae=new O.UnitSelection,oe=new C.TileCollection([],null,Z.general,M.getRandomInt),le=new E.TileOccupation(oe);te=new F.MapBounds,X=new x.Bridges(X.tileSets,oe,le,te,Z),te=new w.BoxedVar(1);let ce=new d.ObjectFactory(oe,le,X,te),he=new f.Game(re,J,Z,Y,null,0,0,ee,A.GameModeType.Battle,se,ae,ne,te,ce,null);var ue;he.addPlayer(ie),he.mapShroudTrait=new L.MapShroudTrait(J,ne),he.traits.add(he.mapShroudTrait),he.sellTrait=new D.SellTrait(he,he.rules.general),he.traits.add(he.sellTrait),["GACNST","GAPOWR","GAREFN","GAPILE","GAAIRC","GAWEAP","GATECH","NACNST","NAPOWR"].forEach((e=>ie.addOwnedObject(ce.create(p.ObjectType.Building,e,Z,Y))));let de=new j.CombatantSidebarModel(ie,he);de.powerDrained=150,de.powerGenerated=300,ie.radarTrait.setDisabled(!1);let ge=setInterval((()=>{de.powerDrained=M.getRandomInt(0,300),de.powerGenerated=M.getRandomInt(200,1e3),console.log(`Set power = ${de.powerGenerated}, drain = `+de.powerDrained)}),5e3);this.disposables.add((()=>clearInterval(ge))),ie.credits=5e3;let pe=setInterval((()=>{ie.credits=M.clamp(ie.credits+M.getRandomInt(-1e3,1e3),0,1e6),console.log("Set credits",ie.credits)}),5e3);for(ue of(this.disposables.add((()=>clearInterval(pe))),ie.production.getAvailableObjects())){var me=g.ObjectArt.factory(ue.type,ue,n.Engine.getArt(),n.Engine.getArt().getSection(ue.imageName)??new W.IniSection(ue.imageName));let e=de.getTabForQueueType(ie.production.getQueueTypeForObject(ue));e.items.push({target:{type:a.SidebarItemTargetType.Techno,rules:ue},cameo:me.cameo,disabled:e.id===a.SidebarCategory.Structures,progress:0,quantity:0,status:a.SidebarItemStatus.Idle})}let fe=de.activeTab.items[1];fe.disabled=!1,fe.progress=.75,fe.quantity=2,fe.status=a.SidebarItemStatus.OnHold;let ye=de.tabs[a.SidebarCategory.Infantry].items[0];ye.quantity=5,ye.progress=1,ye.status=a.SidebarItemStatus.Ready;let Te=new H.CanvasMetrics(q.getCanvas(),window);Te.init(),this.disposables.add(Te);let ve=S.Pointer.factory(n.Engine.getImages().get("mouse.shp"),n.Engine.getPalettes().get("mousepal.pal"),q,document,Te,new w.BoxedVar(!1));ve.init(),ve.lock(),this.disposables.add(ve),$.add(ve.getSprite()),ne=new y.JsxRenderer(n.Engine.getImages(),n.Engine.getPalettes(),$.camera,ve.pointerEvents);let be,Se=new N.MessageList(he.rules.audioVisual.messageDuration,6,ie),we=["txt_low_power","txt_space_cant_save","txt_receiving_scenario","txt_bad_chankey"],Ce=()=>{var e=K.get(we[M.getRandomInt(0,we.length-1)]);console.log("Add system message:",e),Se.addSystemMessage(e,"#"+new THREE.Color(Math.random(),Math.random(),Math.random()).getHexString()),be=setTimeout(Ce,5e3*Math.random())};be=setTimeout(Ce,5e3*Math.random()),this.disposables.add((()=>clearTimeout(be)));let Ee=new s.Hud(ie.country.side,$.viewport,n.Engine.getImages(),n.Engine.getPalettes(),Q,de,Se,new z.ChatHistory,new w.BoxedVar(""),new w.BoxedVar(!1),void 0,[],new G.StalemateDetectTrait,new V.CountdownTimer,ne,K,Object.values(U.CommandBarButtonType).filter((e=>"number"==typeof e))),xe=new k.Minimap(he,ie,Ee.getTextColor(),Z.general.radar);xe.setPointerEvents(ve.pointerEvents),Ee.setMinimap(xe),this.disposables.add(xe),$.add(Ee),Ee.onSidebarSlotClick.subscribe((e=>{console.log("clicked",e)})),Ee.onOptButtonClick.subscribe((()=>{ve.unlock(),Ee.showSidebarMenu([{label:"Button 1",onClick(){console.log("button 1 clicked")}},{label:"Button 2",disabled:!0,onClick(){console.error("button 2 should not trigger onClick")}},{label:"Exit",isBottom:!0,onClick(){ve.lock(),Ee.hideSidebarMenu()}}])})),Ee.onRepairButtonClick.subscribe((()=>{ie.radarTrait.setDisabled(!ie.radarTrait.isDisabled())})),Ee.onCommandBarButtonClick.subscribe((e=>{console.log("Clicked command bar -> "+U.CommandBarButtonType[e])})),Q=(new Date).getTime(),q.addScene($);let Oe=new m.UiAnimationLoop(q);this.disposables.add(Oe),Oe.start(),ne=(new Date).getTime(),console.log("Rendering took "+(ne-Q)+"ms"),T.appendChild($.getHtmlContainer().getElement()),this.disposables.add((()=>{T.removeChild($.getHtmlContainer().getElement())}))}static destroy(){this.disposables.dispose()}}),K.disposables=new T.CompositeDisposable}}})),System.register("engine/renderable/entity/map/MapGrid",["game/Coords","engine/IsoCoords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("MapGrid",class{constructor(e){this.size=e,this._build()}_build(){var e=this.size,t=i.Coords.getWorldTileSize(),s=r.IsoCoords.screenTileToWorld(0,0),n=r.IsoCoords.screenTileToWorld(e.width,e.height),a=r.IsoCoords.screenTileToWorld(0,e.height);e=r.IsoCoords.screenTileToWorld(e.width,0),s=n.x-s.x,a=a.y-e.y,e=new THREE.PlaneGeometry(s,a,s/t,a/t),t=new THREE.MeshBasicMaterial({color:9474192,wireframe:!0,side:THREE.DoubleSide});let o=new THREE.Mesh(e,t);o.matrixAutoUpdate=!1,o.rotation.x=Math.PI/2,o.updateMatrix();let l=new THREE.Object3D;l.matrixAutoUpdate=!1,l.add(o),l.position.x=s/2,l.position.z=a/2,l.position.y=-1*i.Coords.ISO_WORLD_SCALE,l.updateMatrix(),this.target=l}get3DObject(){return this.target}create3DObject(){}update(){}})}}})),System.register("tools/BuildingTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","engine/TheaterType","game/Player","engine/renderable/entity/building/DamageType","engine/renderable/entity/building/AnimationType","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","util/Color","game/gameobject/selection/SelectionLevel","game/Alliances","game/PlayerList","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","game/gameobject/Infantry","engine/Lighting","game/map/TileCollection","game/map/TileOccupation","game/map/Bridges","data/Strings","game/gameobject/trait/AutoRepairTrait","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e}],execute:function(){e("BuildingTester",z=class e{static async main(e){let t=this.renderer=new i.Renderer(800,600);t.init(document.body),t.initStats(document.body);let a=c.WorldScene.factory({x:0,y:0,width:800,height:600},new d.BoxedVar(!0),new d.BoxedVar(G.ShadowQuality.High));this.disposables.add(a),a.scene.background=new THREE.Color(12632256),s.IsoCoords.init({x:0,y:0}),this.theater=await r.Engine.loadTheater(n.TheaterType.Snow);var o=new h.Rules(r.Engine.getRules());this.buildBrowser(o.buildingRules),this.rules=o,this.art=new m.Art(o,r.Engine.getArt()),this.images=r.Engine.getImages(),this.voxels=r.Engine.getVoxels(),this.voxelAnims=r.Engine.getVoxelAnims();let l=new V.CanvasMetrics(t.getCanvas(),window);l.init(),this.disposables.add(l),o=new C.PointerEvents(t,{x:0,y:0},document,l);let u=new O.CameraZoomControls(o,a.cameraZoom);this.disposables.add(u,o),u.init(),t.addScene(a),(this.uiAnimationLoop=new g.UiAnimationLoop(t)).start(),this.worldScene=a,this.vxlGeometryPool=new U.VxlGeometryPool(new H.VxlGeometryCache),this.addGrid()}static addGrid(){var e=new u.MapGrid({width:10,height:10}).get3DObject();let t=new THREE.Object3D;t.add(e),this.worldScene.scene.add(t)}static selectBuilding(e){this.currentRenderable&&!this.currentBuilding.isDisposed&&(this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose());var t=this.rules.getBuilding(e);let i=new a.Player("Player");this.disposables.add(i),i.color=-1!==t.techLevel||t.constructionYard?this.rules.getMultiplayerColors().get("DarkRed"):new y.Color(255,255,255);let s=new b.PlayerList;s.addPlayer(i);var n=new v.Alliances(s),o=new x.UnitSelection,l=new M.Lighting;this.disposables.add(l),t=new f.RenderableFactory(i,o,n,this.rules,this.art,void 0,new p.ImageFinder(this.images,this.theater),r.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,l,new L.LightingDirector(l,this.renderer,new d.BoxedVar(1)),new d.BoxedVar(!1),new d.BoxedVar(!1),new d.BoxedVar(2),void 0,new k.Strings({TXT_PRIMARY:"Primary"}),new d.BoxedVar(N.FlyerHelperMode.Selected),new d.BoxedVar(!1),new _.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map),o=new R.TileCollection([],null,this.rules.general,W.getRandomInt),n=new P.TileOccupation(o),l=new j.MapBounds,l=new I.Bridges(this.theater.tileSets,o,n,l,this.rules);let c=this.currentBuilding=new S.ObjectFactory(o,n,l,new d.BoxedVar(1)).create(w.ObjectType.Building,e,this.rules,this.art);c.owner=i,c.position.tile={rx:1,ry:1,z:0,rampType:0},c.position.setCenterOffset(c.getFoundationCenterOffset());let h=this.world=new D.World,u=new F.RenderableManager(h,this.worldScene,this.worldScene.camera,t);u.init(),this.disposables.add(u),h.spawnObject(c),(this.currentRenderable=u.getRenderableByGameObject(c)).selectionModel.setSelectionLevel(T.SelectionLevel.Selected),this.currentRenderable.selectionModel.setControlGroupNumber(3),setTimeout((()=>{this.buildBuildingControls(),this.createAnimButtons(),this.createOccupiedButtons()}),50)}static selectAnimation(e){this.currentRenderable&&this.currentRenderable.setAnimation(e,performance.now())}static stopCurrentAnimation(){this.currentRenderable&&this.currentRenderable.endCurrentAnimation()}static setDamageType(t){this.currentBuilding.healthTrait.health=t?100*(t===o.DamageType.CONDITION_YELLOW?e.rules.audioVisual.conditionYellow:e.rules.audioVisual.conditionRed):100}static setActiveState(e){this.currentRenderable&&this.currentRenderable.setPowered(e)}static createAnimButtons(){let e=this.animButtonsWrap;e.innerHTML="";for(let i of[l.AnimationType.IDLE,l.AnimationType.PRODUCTION,l.AnimationType.BUILDUP,l.AnimationType.UNBUILD,l.AnimationType.SUPER_CHARGE_START,l.AnimationType.SPECIAL_REPAIR_START,l.AnimationType.SPECIAL_SHOOT,l.AnimationType.SPECIAL_DOCKING,l.AnimationType.FACTORY_DEPLOYING,l.AnimationType.FACTORY_ROOF_DEPLOYING]){let r=document.createElement("button");if(r.innerHTML=l.AnimationType[i],r.style.display="block",r.addEventListener("click",(()=>this.selectAnimation(i))),!this.currentRenderable)throw new Error("Must build anim buttons after a building is selected");var t=!this.currentRenderable.hasAnimation(i);r.disabled=t,r.style.opacity=t?".5":"1",e.appendChild(r)}}static createOccupiedButtons(){let e=this.occupiedButtonsWrap;e.innerHTML="";let t=document.createElement("select");t.disabled=!this.currentBuilding.garrisonTrait,t.style.display="block",t.addEventListener("change",(()=>{this.currentBuilding.garrisonTrait.units=new Array(Number(t.value)).fill(0).map((()=>new A.Infantry("dummy",this.rules.getObject("E1",w.ObjectType.Infantry),null)))}));for(let e=0;e<this.currentBuilding.rules.maxNumberOccupants+1;e++){let i=document.createElement("option");i.innerHTML=String(e),i.value=String(e),i.selected=0===e,t.appendChild(i)}e.appendChild(t)}static buildBuildingControls(){this.controlsElement&&document.body.removeChild(this.controlsElement);let e=this.controlsElement=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="220px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=new Map(this.rules.getMultiplayerColors());t.set("None",new y.Color(255,255,255));let i=document.createElement("select");i.style.display="block",i.addEventListener("change",(()=>{this.currentBuilding.owner.color=t.get(i.value)})),e.appendChild(i),t.forEach(((e,t)=>{let r=document.createElement("option");r.innerHTML=t,r.value=t,r.selected=e.asHex()===this.currentBuilding.owner.color.asHex(),i.appendChild(r)})),e.appendChild(document.createTextNode("Selection level:"));let r=document.createElement("div");e.appendChild(r),[T.SelectionLevel.None,T.SelectionLevel.Hover,T.SelectionLevel.Selected].forEach((e=>{let t=document.createElement("button");t.innerHTML=T.SelectionLevel[e],t.disabled=e===T.SelectionLevel.Selected&&!this.currentBuilding.rules.selectable,t.addEventListener("click",(()=>this.currentRenderable.selectionModel.setSelectionLevel(e))),r.appendChild(t)})),e.appendChild(document.createTextNode("Animation type:"));var s=this.animButtonsWrap=document.createElement("div");e.appendChild(s);let n=document.createElement("button");n.innerHTML="Stop current",n.style.display="block",n.addEventListener("click",(()=>this.stopCurrentAnimation())),e.appendChild(n),e.appendChild(document.createTextNode("Occupants:")),s=this.occupiedButtonsWrap=document.createElement("div"),e.appendChild(s),e.appendChild(document.createTextNode("Damage type:"));let a=document.createElement("button");a.innerHTML="NORMAL",a.style.display="block",a.addEventListener("click",(()=>this.setDamageType(o.DamageType.NORMAL))),e.appendChild(a);let l=document.createElement("button");l.innerHTML="YELLOW",l.style.display="block",l.addEventListener("click",(()=>this.setDamageType(o.DamageType.CONDITION_YELLOW))),e.appendChild(l);let c=document.createElement("button");c.innerHTML="RED",c.style.display="block",c.addEventListener("click",(()=>this.setDamageType(o.DamageType.CONDITION_RED))),e.appendChild(c);let h=document.createElement("button");h.innerHTML="DESTROYED",h.style.display="block",h.addEventListener("click",(async()=>{this.currentBuilding.isDestroyed=!0,this.currentBuilding.healthTrait.health=0,this.world.removeObject(this.currentBuilding),this.currentBuilding.dispose(),document.body.removeChild(this.controlsElement),this.controlsElement=void 0})),e.appendChild(h);let u=document.createElement("button");u.innerHTML="Toggle repair",u.style.display="block",u.addEventListener("click",(()=>{let e=this.currentBuilding.traits.get(B.AutoRepairTrait);e.setDisabled(!e.isDisabled())})),e.appendChild(u),e.appendChild(document.createTextNode("Powered state:"));let d=document.createElement("button");d.innerHTML="INACTIVE",d.style.display="block",d.addEventListener("click",(()=>this.setActiveState(!1))),e.appendChild(d);let g=document.createElement("button");g.innerHTML="ACTIVE",g.style.display="block",g.addEventListener("click",(()=>this.setActiveState(!0))),e.appendChild(g),e.appendChild(document.createTextNode("Warped out:"));let p=document.createElement("input");p.type="checkbox",p.style.display="block",p.addEventListener("change",(e=>{this.currentBuilding.warpedOutTrait.debugSetActive(e.target.checked)})),e.appendChild(p),document.body.appendChild(e)}static buildBrowser(e){let t=this.listEl=document.createElement("div");t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.height="600px",t.style.width="200px",t.style.overflowY="auto",t.style.padding="5px",t.style.background="rgba(255, 255, 255, 0.5)",t.style.border="1px black solid",t.appendChild(document.createTextNode("Building types:"));let i=[];e.forEach(((e,t)=>{-1!==["AMMOCRAT","GADUMY","GAGREEN","CAARMR"].indexOf(t)||/^CASIN/.exec(t)||/^CITY/.exec(t)||i.push(t)})),i.sort(),i.forEach((e=>{let i=document.createElement("a");i.style.display="block",i.textContent=e,i.setAttribute("href","javascript:;"),i.addEventListener("click",(()=>{console.log("Selected building",e),this.selectBuilding(e)})),t.appendChild(i)})),document.body.appendChild(t),setTimeout((()=>{this.selectBuilding(i[0])}),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsElement&&(this.controlsElement.remove(),this.controlsElement=void 0),this.disposables.dispose()}}),z.disposables=new E.CompositeDisposable}}})),System.register("network/HttpRequest",["@puzzl/core/lib/async/cancellation"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("HttpRequest",class{async fetchText(e,t,i){return await this.fetchAndParse({url:e,type:"text"},t,i)}async fetchBinary(e,t,i){return await this.fetchAndParse({url:e,type:"binary"},t,i)}async fetchJson(e,t,i){return await this.fetchAndParse({url:e,type:"json"},t,i)}async fetchHtml(e,t,i){return await this.fetchAndParse({url:e,type:"text"},t,{...i,allowHtmlMimeType:!0})}async fetchAndParse(e,t,i){var r=await this.fetchRaw(e.url,t,i);return this.parseResult(e.type,r)}async fetchRaw(e,t,s){let n,a=new AbortController;t?.register((()=>{try{a.abort()}catch(e){}}));try{n=await fetch(e,{signal:a.signal,body:s?.body,method:s?.method})}catch(e){if("AbortError"===e.name)throw new i.OperationCanceledError(t);throw console.error(e),new r(`Fetch failed with error: ${e.name}:`+e.message)}if(!n.ok)throw new r(`Fetch failed with status ${n.status}:`+n.statusText);if("text/html"===n.headers.get("Content-Type")&&!s?.allowHtmlMimeType)throw new r(`Fetch failed with invalid mime type "text/html" (HTTP status ${n.status})`);let o=n.body.getReader(),l=0,c=[];for(;;)try{var{done:h,value:u}=await o.read();if(h)break;c.push(u),l+=u.length,s?.onProgress?.(u.length)}catch(e){if("AbortError"===e.name)throw new i.OperationCanceledError(t);throw console.error(e),new r(e.message)}let d=new Uint8Array(l),g=0;for(var p of c)d.set(p,g),g+=p.length;return d}parseResult(e,t){if("binary"===e)return t;var i=new TextDecoder("utf-8").decode(t);return"json"===e?JSON.parse(i):i}}),r=class extends Error{},e("DownloadError",r)}}})),System.register("engine/resourceConfigs",["engine/TheaterType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.IsoSnow=0]="IsoSnow",t[t.IsoTemp=1]="IsoTemp",t[t.IsoUrb=2]="IsoUrb",t[t.BuildGen=3]="BuildGen",t[t.TheaterSnow=4]="TheaterSnow",t[t.TheaterTemp=5]="TheaterTemp",t[t.TheaterUrb=6]="TheaterUrb",t[t.TheaterSnow2=7]="TheaterSnow2",t[t.TheaterTemp2=8]="TheaterTemp2",t[t.TheaterUrb2=9]="TheaterUrb2",t[t.Ui=10]="Ui",t[t.UiAlly=11]="UiAlly",t[t.UiSov=12]="UiSov",t[t.Anims=13]="Anims",t[t.Vxl=14]="Vxl",t[t.Cameo=15]="Cameo",t[t.Ini=16]="Ini",t[t.Strings=17]="Strings",t[t.EvaAlly=18]="EvaAlly",t[t.EvaSov=19]="EvaSov",t[t.Sounds=20]="Sounds",t[t.HalloweenMix=21]="HalloweenMix",t[t.XmasMix=22]="XmasMix",e("ResourceType",r),e("resourceConfigs",(new Map).set(r.IsoSnow,{id:"isoSnow",src:"isosnow.mix",type:"binary",sizeHint:28758698}).set(r.IsoTemp,{id:"isoTemp",src:"isotemp.mix",type:"binary",sizeHint:29171410}).set(r.IsoUrb,{id:"isoUrb",src:"isourb.mix",type:"binary",sizeHint:31811402}).set(r.BuildGen,{id:"buildGen",src:"build-gen.mix",type:"binary",sizeHint:27801690}).set(r.TheaterSnow,{id:"theater.snow",src:"snow.mix",type:"binary",sizeHint:18421274}).set(r.TheaterTemp,{id:"theater.temp",src:"temperat.mix",type:"binary",sizeHint:2728266}).set(r.TheaterUrb,{id:"theater.urb",src:"urban.mix",type:"binary",sizeHint:2726218}).set(r.TheaterSnow2,{id:"theater.snow2",src:"sno.mix",type:"binary",sizeHint:10898}).set(r.TheaterTemp2,{id:"theater.temp2",src:"tem.mix",type:"binary",sizeHint:10850}).set(r.TheaterUrb2,{id:"theater.urb2",src:"urb.mix",type:"binary",sizeHint:10850}).set(r.UiAlly,{id:"uially",src:"sidec01.mix",type:"binary",sizeHint:2099412}).set(r.UiSov,{id:"uisov",src:"sidec02.mix",type:"binary",sizeHint:2102564}).set(r.Anims,{id:"anims",src:"anims.mix",type:"binary",sizeHint:15867898}).set(r.Vxl,{id:"vxl",src:"vxl.mix",type:"binary",sizeHint:5271701}).set(r.Cameo,{id:"cameo",src:"cameo.mix",type:"binary",sizeHint:608120}).set(r.Ini,{id:"ini",src:"ini.mix",type:"binary",sizeHint:1000842}).set(r.Ui,{id:"ui",src:"ui.mix",type:"binary",sizeHint:4424093}).set(r.Strings,{id:"strings",src:"strings.mix",type:"binary",sizeHint:485818}).set(r.EvaAlly,{id:"evaally",src:"eva-ally.mix",type:"binary",sizeHint:1835436}).set(r.EvaSov,{id:"evasov",src:"eva-sov.mix",type:"binary",sizeHint:2021760}).set(r.Sounds,{id:"sounds",src:"sounds.mix",type:"binary",sizeHint:17684750}).set(r.HalloweenMix,{id:"halloweenmix",src:"expandspawn09.mix",type:"binary",sizeHint:20312}).set(r.XmasMix,{id:"xmasmix",src:"expandspawn10.mix",type:"binary",sizeHint:10318})),e("resourcesForPrefetch",[r.BuildGen,r.Sounds,r.Anims,r.Vxl,r.IsoUrb,r.TheaterUrb,r.TheaterUrb2,r.IsoTemp,r.TheaterTemp,r.TheaterTemp2,r.IsoSnow,r.TheaterSnow,r.TheaterSnow2]),e("theaterSpecificResources",new Map([[i.TheaterType.Snow,[r.TheaterSnow,r.TheaterSnow2,r.IsoSnow]],[i.TheaterType.Temperate,[r.TheaterTemp,r.TheaterTemp2,r.IsoTemp]],[i.TheaterType.Urban,[r.TheaterUrb,r.TheaterUrb2,r.IsoUrb]]]))}}})),System.register("engine/ResourceLoader",["@puzzl/core/lib/async/cancellation","network/HttpRequest","engine/resourceConfigs"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(t){e({DownloadError:(r=t).DownloadError})},function(e){s=e}],execute:function(){e("ResourceLoader",class{constructor(e){this.resourceBaseUrl=e,this.httpRequest=new r.HttpRequest}async prefetchResource(e,t){let r=this.getResourceUrl(e);const s=document.createElement("link");s.rel="prefetch",s.as="fetch",s.href=r,s.crossOrigin="anonymous",await new Promise(((e,n)=>{t?.register((()=>{s.parentNode&&(document.head.removeChild(s),n(new i.OperationCanceledError(t)))})),"onload"in s&&(s.onload=()=>{document.head.removeChild(s),e()}),"onerror"in s&&(s.onerror=()=>{document.head.removeChild(s),n(new Error(`Couldn't prefetch URL "${r}"`))}),document.head.appendChild(s),"onload"in s||(document.head.removeChild(s),e())}))}getResourceUrl(e){var t="object"==typeof e?e:s.resourceConfigs.get(e);if(!t)throw new Error("Missing resourceConfig for resType "+s.ResourceType[e]);return this.resourceBaseUrl+t.src}getResourceFileName(e){return this.getResourceUrl(e).split("?")[0].split("/").pop()}buildResourceManifest(e){return e.map((e=>{if("object"==typeof e)return e;if(!s.resourceConfigs.has(e))throw new Error("Missing resourceConfig for resType "+s.ResourceType[e]);return s.resourceConfigs.get(e)})).map((e=>({id:e.id,src:e.src.match(/^https?:\/\//)?e.src:this.resourceBaseUrl+e.src,type:e.type,sizeHint:e.sizeHint})))}async loadText(e,t,i){return await this.loadResource({src:e,type:"text"},t,i)}async loadBinary(e,t,i){return await this.loadResource({src:e,type:"binary"},t,i)}async loadJson(e,t,i){return await this.loadResource({src:e,type:"json"},t,i)}async loadResource(e,t,i){var r=await this.fetchResource(this.resourceBaseUrl+e.src,t,i);return this.httpRequest.parseResult(e.type,r)}async loadResources(e,t,i){let r=this.buildResourceManifest(e),s=new Map;var a,o=r.length;let l=0,c=r.reduce(((e,{sizeHint:t})=>e+(t??0)),0),h=0;for(a of r){var u=await this.fetchResource(a.src,t,{onProgress:e=>{h+=e,c&&i?.(Math.floor(100*Math.min(1,h/c)))}});s.set(a.id,u),l++,c||i?.(Math.floor(l/o*100))}return new n(s)}async fetchResource(e,t,i){return await this.httpRequest.fetchRaw(e,t,i)}}),e("LoaderResult",n=class{constructor(e){this.items=e}pop(e){let t;if("string"==typeof e)t=e;else{if(!s.resourceConfigs.has(e))throw new Error(`Missing resourceConfig for resource type "${s.ResourceType[e]}"`);if(t=s.resourceConfigs.get(e).id,!t)throw new Error("Undefined resourceId for resourceType "+e)}var i=this.items.get(t);if(!i)throw new Error(`Resource type "${e}" not found in result.`);return this.items.delete(t),i}})}}})),System.register("tools/DevToolsApi",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("DevToolsApi",i=class{static getPublicNamespace(){return window.r=window.r||Object.create(null)}static registerCommand(e,t){var i=this.getPublicNamespace();i[e]?console.error(`Command ${e} is already registered`):(this.cmdHandlers.set(e,t),Object.defineProperty(i,e,{configurable:!0,get:()=>this.cmdHandlers.get(e)()}))}static unregisterCommand(e){if(this.cmdHandlers.has(e)){this.cmdHandlers.delete(e),delete this.getPublicNamespace()[e]}else console.error(`Command ${e} is not registered`)}static registerVar(e,t){var i=this.getPublicNamespace();i[e]?console.error(`Runtime variable ${e} is already registered`):(this.runtimeVars.set(e,t),Object.defineProperty(i,e,{configurable:!0,get:()=>this.runtimeVars.get(e).value,set:t=>{this.runtimeVars.get(e).value=t}}))}static unregisterVar(e){if(this.runtimeVars.has(e)){this.runtimeVars.delete(e),delete this.getPublicNamespace()[e]}else console.error(`Runtime variable ${e} is not registered`)}static listVars(){return this.runtimeVars.keys()}static listCommands(){return this.cmdHandlers.keys()}}),i.cmdHandlers=new Map,i.runtimeVars=new Map}}})),System.register("tools/VehicleTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/theater/rampHeights","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","game/gameobject/ObjectFactory","engine/type/ObjectType","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/map/TileCollection","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math","game/gameobject/trait/interface/NotifyTileChange"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e}],execute:function(){e("VehicleTester",z=class{static async main(e){let t=this.renderer=new i.Renderer(800,600);t.init(document.body),t.initStats(document.body);let n=a.WorldScene.factory({x:0,y:0,width:800,height:600},new c.BoxedVar(!0),new c.BoxedVar(U.ShadowQuality.High));this.disposables.add(n),n.scene.background=new THREE.Color(12632256),s.IsoCoords.init({x:0,y:0}),this.theater=await r.Engine.loadTheater(p.TheaterType.Temperate);var l=new o.Rules(r.Engine.getRules());this.rules=l,this.art=new d.Art(l,r.Engine.getArt()),this.images=r.Engine.getImages(),this.voxels=r.Engine.getVoxels(),this.voxelAnims=r.Engine.getVoxelAnims(),this.buildBrowser(l.vehicleRules);let u=new H.CanvasMetrics(t.getCanvas(),window);u.init(),this.disposables.add(u),l=new w.PointerEvents(t,{x:0,y:0},document,u);let g=new x.CameraZoomControls(l,n.cameraZoom);this.disposables.add(g,l),g.init(),t.addScene(n),(this.uiAnimationLoop=new h.UiAnimationLoop(t)).start(),this.worldScene=n,this.vxlGeometryPool=new F.VxlGeometryPool(new _.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){var e=new l.MapGrid({width:10,height:10}).get3DObject();let t=new THREE.Object3D;t.add(e),this.worldScene.scene.add(t)}static createFloor(){var e=new THREE.PlaneGeometry(1e4,1e4);let t=new THREE.ShadowMaterial;t.opacity=.5;let i=new THREE.Mesh(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.renderOrder=2e5,i.position.y=1,this.worldScene.scene.add(i)}static selectVehicle(e){this.currentVehicle&&!this.currentVehicle.isDisposed&&(this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose());let t=new n.Player("Player");this.disposables.add(t),t.color=this.rules.getMultiplayerColors().get("DarkRed");var i=new f.Alliances(new y.PlayerList),s=new E.UnitSelection,a=new O.Lighting;this.disposables.add(a);var o=new g.RenderableFactory(t,s,i,this.rules,this.art,void 0,new u.ImageFinder(this.images,this.theater),r.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,a,new j.LightingDirector(a,this.renderer,new c.BoxedVar(1)),new c.BoxedVar(!1),new c.BoxedVar(!1),new c.BoxedVar(2),void 0,new I.Strings,new c.BoxedVar(B.FlyerHelperMode.Selected),new c.BoxedVar(!1),new D.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map);s=new A.TileCollection([],null,this.rules.general,V.getRandomInt),i=new R.TileOccupation(s),a=new k.MapBounds,a=new P.Bridges(this.theater.tileSets,s,i,a,this.rules);let l=new b.ObjectFactory(s,i,a,new c.BoxedVar(1)),h=this.currentVehicle=l.create(S.ObjectType.Vehicle,e,this.rules,this.art);h.owner=t,h.position.tile=this.tile,h.harvesterTrait?(h.harvesterTrait.ore=5,h.harvesterTrait.gems=10):h.transportTrait&&h.transportTrait.units.push(l.create(S.ObjectType.Vehicle,"FV",this.rules,this.art),l.create(S.ObjectType.Infantry,"E1",this.rules,this.art),l.create(S.ObjectType.Infantry,"CLEG",this.rules,this.art)),h.tilterTrait?.[W.NotifyTileChange.onTileChange](h);let d=this.world=new N.World,p=new L.RenderableManager(d,this.worldScene,this.worldScene.camera,o);p.init(),this.disposables.add(p),d.spawnObject(h);let m=this.currentRenderable=p.getRenderableByGameObject(h);m.selectionModel.setSelectionLevel(T.SelectionLevel.Selected),m.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let e=this.controlsEl=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="200px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=this.rules.getMultiplayerColors(),i=document.createElement("select");i.style.display="block",i.addEventListener("change",(()=>{this.currentVehicle.owner.color=t.get(i.value)})),e.appendChild(i),t.forEach(((e,t)=>{let r=document.createElement("option");r.innerHTML=t,r.value=t,r.selected=e.asHex()===this.currentVehicle.owner.color.asHex(),i.appendChild(r)})),e.appendChild(document.createTextNode("Selection level:"));let r=document.createElement("div");e.appendChild(r),[T.SelectionLevel.None,T.SelectionLevel.Hover,T.SelectionLevel.Selected].forEach((e=>{let t=document.createElement("button");t.innerHTML=T.SelectionLevel[e],t.addEventListener("click",(()=>this.currentRenderable.selectionModel.setSelectionLevel(e))),r.appendChild(t)})),e.appendChild(document.createTextNode("Veteran level:"));let s=document.createElement("div");e.appendChild(s),this.currentVehicle.veteranTrait&&[v.VeteranLevel.None,v.VeteranLevel.Veteran,v.VeteranLevel.Elite].forEach((e=>{let t=document.createElement("button");t.innerHTML=v.VeteranLevel[e],t.addEventListener("click",(()=>this.currentVehicle.veteranTrait.veteranLevel=e)),s.appendChild(t)})),e.appendChild(document.createTextNode("Ramp type:"));let n=document.createElement("select");n.style.display="block",n.addEventListener("change",(()=>{this.tile.rampType=Number(n.value),this.currentVehicle.tilterTrait?.[W.NotifyTileChange.onTileChange](this.currentVehicle)})),e.appendChild(n);for(let e=0;e<m.rampHeights.length;++e){let t=document.createElement("option");t.innerHTML=""+e,t.value=""+e,n.appendChild(t)}e.appendChild(document.createTextNode("Turret #:"));let a=document.createElement("select");a.style.display="block",a.disabled=!this.currentVehicle.rules.turret,a.addEventListener("change",(()=>{this.currentVehicle.turretNo=Number(a.value)})),e.appendChild(a);for(let e=0;e<this.currentVehicle.rules.turretCount;++e){let t=document.createElement("option");t.innerHTML=""+e,t.value=""+e,a.appendChild(t)}e.appendChild(document.createTextNode("isMoving:"));let o=document.createElement("input");o.type="checkbox",o.style.display="block",o.addEventListener("change",(e=>{var t=e.target.checked;this.currentVehicle.moveTrait.moveState=t?M.MoveState.Moving:M.MoveState.Idle,this.currentVehicle.rules.consideredAircraft&&t?this.currentVehicle.zone=G.ZoneType.Air:this.currentVehicle.zone=this.currentVehicle.rules.naval?G.ZoneType.Water:G.ZoneType.Ground})),e.appendChild(o),e.appendChild(document.createTextNode("isFiring:"));let l=document.createElement("input");l.type="checkbox",l.style.display="block",l.addEventListener("change",(e=>{this.currentVehicle.isFiring=e.target.checked})),e.appendChild(l),e.appendChild(document.createTextNode("isRocking:"));let c=document.createElement("input");if(c.type="checkbox",c.style.display="block",c.addEventListener("change",(e=>{e.target.checked?this.currentVehicle.applyRocking(360*Math.random(),1):this.currentVehicle.rocking=void 0})),e.appendChild(c),this.currentVehicle.airSpawnTrait){e.appendChild(document.createTextNode("hasSpawns:"));let t=document.createElement("input");t.type="checkbox",t.style.display="block",t.checked=!!this.currentVehicle.airSpawnTrait.availableSpawns,t.addEventListener("change",(e=>{var t=e.target.checked?1:0;this.currentVehicle.airSpawnTrait.debugSetStorage(null,t)})),e.appendChild(t)}e.appendChild(document.createTextNode("Warped out:"));let h=document.createElement("input");h.type="checkbox",h.style.display="block",h.addEventListener("change",(e=>{this.currentVehicle.warpedOutTrait.debugSetActive(e.target.checked)})),e.appendChild(h),e.appendChild(document.createTextNode("Direction:"));let u=document.createElement("div");e.appendChild(u);let d=document.createElement("input");d.type="range",d.min="-180",d.max="180",d.value="0",d.disabled=void 0===this.fixedDirection,d.style.verticalAlign="middle",d.addEventListener("input",(()=>{this.fixedDirection=Number(d.value)})),u.appendChild(d);let g=document.createElement("button");g.innerHTML="Reset",g.disabled=void 0===this.fixedDirection,g.style.verticalAlign="middle",g.addEventListener("click",(()=>{void 0!==this.fixedDirection&&(this.fixedDirection=0,d.value="0")})),u.appendChild(g);let p=document.createElement("input");p.type="checkbox",p.checked=void 0===this.fixedDirection,p.addEventListener("change",(e=>{this.fixedDirection=e.target.checked?void 0:0,d.disabled=g.disabled=void 0===this.fixedDirection,d.value="0"})),e.appendChild(p);let f=document.createElement("label");f.innerHTML="Auto rotate",e.appendChild(f);let y=document.createElement("button");y.style.display="block",y.style.color="red",y.innerHTML="DESTROY",y.addEventListener("click",(async()=>{this.currentVehicle.isDestroyed=!0,this.world.removeObject(this.currentVehicle),this.currentVehicle.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0})),e.appendChild(y),document.body.appendChild(e)}static buildBrowser(e){let t=this.listEl=document.createElement("div");t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.height="600px",t.style.width="200px",t.style.overflowY="auto",t.style.padding="5px",t.style.background="rgba(255, 255, 255, 0.5)",t.style.border="1px black solid",t.appendChild(document.createTextNode("Vehicle types:"));let i=[...e.keys()].filter((e=>this.art.hasObject(e,S.ObjectType.Vehicle))).sort();i.forEach((e=>{let i=document.createElement("a");i.style.display="block",i.textContent=e,i.setAttribute("href","javascript:;"),i.addEventListener("click",(()=>{console.log("Selected vehicle",e),this.selectVehicle(e)})),t.appendChild(i)})),document.body.appendChild(t),setTimeout((()=>{this.selectVehicle(i[0]),this.animateVehicle()}),50)}static animateVehicle(){this.currentVehicle.direction=this.fixedDirection??(this.currentVehicle.direction+1)%360,this.currentVehicle.turretTrait&&(this.currentVehicle.turretTrait.facing=this.fixedDirection??(this.currentVehicle.turretTrait.facing+2)%360),setTimeout((()=>this.animateVehicle()),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),z.tile={rx:1,ry:1,rampType:0,z:0},z.disposables=new C.CompositeDisposable}}})),System.register("tools/InfantryTester",["engine/gfx/Renderer","engine/Engine","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/gameobject/unit/ZoneType","game/type/SpeedType","game/gameobject/infantry/StanceType","game/gameobject/infantry/InfDeathType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","game/World","engine/RenderableManager","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e}],execute:function(){e("InfantryTester",K=class{static async main(e){let t=this.renderer=new i.Renderer(800,600);t.init(document.body),t.initStats(document.body);let n=a.WorldScene.factory({x:0,y:0,width:800,height:600},new c.BoxedVar(!0),new c.BoxedVar(V.ShadowQuality.High));this.disposables.add(n),n.scene.background=new THREE.Color(12632256),s.IsoCoords.init({x:0,y:0}),this.theater=await r.Engine.loadTheater(p.TheaterType.Snow);var l=new o.Rules(r.Engine.getRules());this.rules=l,this.art=new d.Art(l,r.Engine.getArt()),this.images=r.Engine.getImages(),this.buildBrowser(l.infantryRules);let u=new W.CanvasMetrics(t.getCanvas(),window);u.init(),this.disposables.add(u),l=new C.PointerEvents(t,{x:0,y:0},document,u);let g=new O.CameraZoomControls(l,n.cameraZoom);this.disposables.add(g,l),g.init(),t.addScene(n),(this.uiAnimationLoop=new h.UiAnimationLoop(t)).start(),this.worldScene=n,this.addGrid()}static addGrid(){var e=new l.MapGrid({width:10,height:10}).get3DObject();let t=new THREE.Object3D;t.add(e),this.worldScene.scene.add(t)}static selectInfantry(e){this.currentInfantry&&!this.currentInfantry.isDisposed&&(this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose());let t=new n.Player("Player");this.disposables.add(t),t.color=this.rules.getMultiplayerColors().get("DarkRed");var i=new v.Alliances(new b.PlayerList),s=new x.UnitSelection,a=new A.Lighting;this.disposables.add(a);var o=new g.RenderableFactory(t,s,i,this.rules,this.art,void 0,new u.ImageFinder(this.images,this.theater),r.Engine.getPalettes(),null,null,this.theater,this.worldScene.camera,a,new D.LightingDirector(a,this.renderer,new c.BoxedVar(1)),new c.BoxedVar(!1),new c.BoxedVar(!1),new c.BoxedVar(2),void 0,new j.Strings,new c.BoxedVar(L.FlyerHelperMode.Selected),new c.BoxedVar(!1),new U.VxlBuilderFactory(new H.VxlGeometryPool(new G.VxlGeometryCache),!1,this.worldScene.camera),new Map);s=new R.TileCollection([],null,this.rules.general,z.getRandomInt),i=new k.TileOccupation(s),a=new N.MapBounds,a=new B.Bridges(this.theater.tileSets,s,i,a,this.rules);let l=this.currentInfantry=new M.ObjectFactory(s,i,a,new c.BoxedVar(1)).create(P.ObjectType.Infantry,e,this.rules,this.art);l.owner=t,l.position.tile={rx:1,ry:1,z:0,rampType:0};let h=this.world=new F.World,d=new _.RenderableManager(h,this.worldScene,this.worldScene.camera,o);d.init(),this.disposables.add(d),h.spawnObject(l);let p=this.currentRenderable=d.getRenderableByGameObject(l);p.selectionModel.setSelectionLevel(S.SelectionLevel.Selected),p.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let e=this.controlsEl=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="200px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=new Map(this.rules.getMultiplayerColors()),i=document.createElement("select");i.style.display="block",i.addEventListener("change",(()=>{this.currentInfantry.owner.color=t.get(i.value)})),e.appendChild(i),t.forEach(((e,t)=>{let r=document.createElement("option");r.innerHTML=t,r.value=t,r.selected=e.asHex()===this.currentInfantry.owner.color.asHex(),i.appendChild(r)})),e.appendChild(document.createTextNode("Selection level:"));let r=document.createElement("div");e.appendChild(r),[S.SelectionLevel.None,S.SelectionLevel.Hover,S.SelectionLevel.Selected].forEach((e=>{let t=document.createElement("button");t.innerHTML=S.SelectionLevel[e],t.addEventListener("click",(()=>this.currentRenderable.selectionModel.setSelectionLevel(e))),r.appendChild(t)})),e.appendChild(document.createTextNode("Veteran level:"));let s=document.createElement("div");e.appendChild(s),this.currentInfantry.veteranTrait&&[w.VeteranLevel.None,w.VeteranLevel.Veteran,w.VeteranLevel.Elite].forEach((e=>{let t=document.createElement("button");t.innerHTML=w.VeteranLevel[e],t.addEventListener("click",(()=>this.currentInfantry.veteranTrait.veteranLevel=e)),s.appendChild(t)})),e.appendChild(document.createTextNode("SubCell:"));let n=document.createElement("select");n.style.display="block",n.addEventListener("change",(()=>{this.currentInfantry.position.subCell=Number(n.value)})),e.appendChild(n);for(let e=0;e<5;++e){let t=document.createElement("option");t.innerHTML=""+e,t.value=""+e,n.appendChild(t)}e.appendChild(document.createTextNode("Zone:")),this.createZoneSelect(e),e.appendChild(document.createTextNode("Stance:")),this.createStanceSelect(e),e.appendChild(document.createTextNode("isMoving:"));let a=document.createElement("input");a.type="checkbox",a.style.display="block",a.addEventListener("change",(e=>{this.currentInfantry.moveTrait.moveState=e.target.checked?I.MoveState.Moving:I.MoveState.Idle})),e.appendChild(a),e.appendChild(document.createTextNode("isFiring:"));let o=document.createElement("input");o.type="checkbox",o.disabled=!this.currentInfantry.rules.primary,o.style.display="block",o.addEventListener("change",(e=>{this.currentInfantry.isFiring=e.target.checked})),e.appendChild(o),e.appendChild(document.createTextNode("isPanicked:"));let l=document.createElement("input");l.type="checkbox",l.disabled=!this.currentInfantry.rules.fraidycat,l.style.display="block",l.addEventListener("change",(e=>{this.currentInfantry.isPanicked=e.target.checked})),e.appendChild(l),e.appendChild(document.createTextNode("Warped out:"));let c=document.createElement("input");c.type="checkbox",c.style.display="block",c.addEventListener("change",(e=>{this.currentInfantry.warpedOutTrait.debugSetActive(e.target.checked)})),e.appendChild(c),this.createDeathSelect(e),document.body.appendChild(e)}static createZoneSelect(e){let t=document.createElement("select");t.style.display="block",t.addEventListener("change",(()=>{this.currentInfantry.zone=Number(t.value)})),e.appendChild(t);let i=document.createElement("option");if(i.value=""+m.ZoneType.Ground,i.innerHTML=m.ZoneType[m.ZoneType.Ground],t.appendChild(i),this.currentInfantry.rules.consideredAircraft){let e=document.createElement("option");e.value=""+m.ZoneType.Air,e.innerHTML=m.ZoneType[m.ZoneType.Air],t.appendChild(e)}if(this.currentInfantry.rules.speedType===f.SpeedType.Amphibious){let e=document.createElement("option");e.value=""+m.ZoneType.Water,e.innerHTML=m.ZoneType[m.ZoneType.Water],t.appendChild(e)}}static createStanceSelect(e){let t=document.createElement("select");t.style.display="block",t.addEventListener("change",(()=>{this.currentInfantry.stance=Number(t.value)})),e.appendChild(t);let i=document.createElement("option");i.value=""+y.StanceType.None,i.innerHTML=y.StanceType[y.StanceType.None],t.appendChild(i);let r=document.createElement("option");r.value=""+y.StanceType.Guard,r.innerHTML=y.StanceType[y.StanceType.Guard],t.appendChild(r);let s=document.createElement("option");s.value=""+y.StanceType.Paradrop,s.innerHTML=y.StanceType[y.StanceType.Paradrop],t.appendChild(s);let n=document.createElement("option");if(n.value=""+y.StanceType.Cheer,n.innerHTML=y.StanceType[y.StanceType.Cheer],t.appendChild(n),this.currentInfantry.rules.proneWhenAttacked){let e=document.createElement("option");e.value=""+y.StanceType.Prone,e.innerHTML=y.StanceType[y.StanceType.Prone],t.appendChild(e)}if(this.currentInfantry.rules.deployer){let e=document.createElement("option");e.value=""+y.StanceType.Deployed,e.innerHTML=y.StanceType[y.StanceType.Deployed],t.appendChild(e)}}static createDeathSelect(e){e.appendChild(document.createTextNode("Death"));let t=document.createElement("select"),i=1,r=T.InfDeathType[i];for(;void 0!==r;){let e=document.createElement("option");e.innerHTML=r,e.value=""+i,e.disabled=!this.currentInfantry.rules.isHuman&&![T.InfDeathType.Gunfire,T.InfDeathType.Explode].includes(i),t.appendChild(e),r=T.InfDeathType[++i]}e.appendChild(t);let s=document.createElement("button");s.style.display="block",s.style.color="red",s.innerHTML="KILL",s.addEventListener("click",(async()=>{this.currentInfantry.isDestroyed=!0,this.currentInfantry.infDeathType=Number(t.value),this.world.removeObject(this.currentInfantry),this.currentInfantry.dispose(),document.body.removeChild(this.controlsEl),this.controlsEl=void 0})),e.appendChild(s)}static buildBrowser(e){let t=this.listEl=document.createElement("div");t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.height="600px",t.style.width="200px",t.style.overflowY="auto",t.style.padding="5px",t.style.width="200px",t.style.background="rgba(255, 255, 255, 0.5)",t.style.border="1px black solid",t.appendChild(document.createTextNode("Infantry types:"));let i=[...e.keys()].filter((e=>this.art.hasObject(e,P.ObjectType.Infantry))).sort();i.forEach((e=>{let i=document.createElement("a");i.style.display="block",i.textContent=e,i.setAttribute("href","javascript:;"),i.addEventListener("click",(()=>{console.log("Selected infantry",e),this.selectInfantry(e)})),t.appendChild(i)})),document.body.appendChild(t),setTimeout((()=>{this.selectInfantry(i[0]),this.animateInfantry()}),50)}static animateInfantry(){this.currentInfantry.isDisposed||(this.currentInfantry.direction=(this.currentInfantry.direction+1)%360),setTimeout((()=>this.animateInfantry()),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),K.disposables=new E.CompositeDisposable}}})),System.register("tools/AircraftTester",["engine/gfx/Renderer","engine/Engine","game/Coords","engine/IsoCoords","game/Player","engine/renderable/WorldScene","game/rules/Rules","engine/renderable/entity/map/MapGrid","util/BoxedVar","engine/UiAnimationLoop","engine/ImageFinder","game/art/Art","engine/renderable/entity/RenderableFactory","engine/TheaterType","game/Alliances","game/PlayerList","game/gameobject/selection/SelectionLevel","game/gameobject/unit/VeteranLevel","gui/PointerEvents","util/disposable/CompositeDisposable","game/gameobject/selection/UnitSelection","tools/CameraZoomControls","engine/Lighting","game/gameobject/ObjectFactory","game/map/TileCollection","engine/type/ObjectType","game/gameobject/trait/MoveTrait","game/map/TileOccupation","game/map/Bridges","engine/RenderableManager","game/World","data/Strings","game/map/MapBounds","engine/renderable/entity/unit/FlyerHelperMode","engine/gfx/lighting/LightingDirector","engine/renderable/builder/VxlBuilderFactory","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/renderable/entity/unit/ShadowQuality","gui/CanvasMetrics","game/gameobject/unit/ZoneType","util/math"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e}],execute:function(){e("AircraftTester",W=class{static async main(e){let t=this.renderer=new i.Renderer(800,600);t.init(document.body),t.initStats(document.body);let s=o.WorldScene.factory({x:0,y:0,width:800,height:600},new h.BoxedVar(!0),new h.BoxedVar(U.ShadowQuality.High));this.disposables.add(s),s.scene.background=new THREE.Color(12632256),n.IsoCoords.init({x:0,y:0}),this.theater=await r.Engine.loadTheater(m.TheaterType.Temperate);var a=new l.Rules(r.Engine.getRules());this.rules=a,this.art=new g.Art(a,r.Engine.getArt()),this.images=r.Engine.getImages(),this.voxels=r.Engine.getVoxels(),this.voxelAnims=r.Engine.getVoxelAnims(),this.buildBrowser(a.aircraftRules);let c=new H.CanvasMetrics(t.getCanvas(),window);c.init(),this.disposables.add(c),a=new b.PointerEvents(t,{x:0,y:0},document,c);let d=new C.CameraZoomControls(a,s.cameraZoom);d.init(),this.disposables.add(a,d),t.addScene(s),(this.uiAnimationLoop=new u.UiAnimationLoop(t)).start(),this.worldScene=s,this.vxlGeometryPool=new F.VxlGeometryPool(new _.VxlGeometryCache),this.addGrid(),this.createFloor()}static addGrid(){var e=new c.MapGrid({width:10,height:10}).get3DObject();let t=new THREE.Object3D;t.add(e),this.worldScene.scene.add(t)}static createFloor(){var e=new THREE.PlaneGeometry(1e4,1e4);let t=new THREE.ShadowMaterial;t.opacity=.5;let i=new THREE.Mesh(e,t);i.rotation.x=-Math.PI/2,i.receiveShadow=!0,i.renderOrder=2e5,this.worldScene.scene.add(i)}static selectAircraft(e){this.currentAircraft&&(this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose());let t=new a.Player("Player");this.disposables.add(t),t.color=this.rules.getMultiplayerColors().get("DarkRed");var i=new f.Alliances(new y.PlayerList),s=new w.UnitSelection,n=new E.Lighting;this.disposables.add(n);var o=new p.RenderableFactory(t,s,i,this.rules,this.art,void 0,new d.ImageFinder(this.images,this.theater),r.Engine.getPalettes(),this.voxels,this.voxelAnims,this.theater,this.worldScene.camera,n,new L.LightingDirector(n,this.renderer,new h.BoxedVar(1)),new h.BoxedVar(!1),new h.BoxedVar(!1),new h.BoxedVar(2),void 0,new B.Strings,new h.BoxedVar(N.FlyerHelperMode.Selected),new h.BoxedVar(!1),new D.VxlBuilderFactory(this.vxlGeometryPool,!1,this.worldScene.camera),new Map);s=new O.TileCollection([],null,this.rules.general,V.getRandomInt),i=new R.TileOccupation(s),n=new j.MapBounds,n=new P.Bridges(this.theater.tileSets,s,i,n,this.rules);let l=this.currentAircraft=new x.ObjectFactory(s,i,n,new h.BoxedVar(0)).create(A.ObjectType.Aircraft,e,this.rules,this.art);l.owner=t,l.position.tile={rx:1,ry:1,z:0,rampType:0};let c=this.world=new k.World,u=new I.RenderableManager(c,this.worldScene,this.worldScene.camera,o);u.init(),this.disposables.add(u),c.spawnObject(l);let g=this.currentRenderable=u.getRenderableByGameObject(l);g.selectionModel.setSelectionLevel(T.SelectionLevel.None),g.selectionModel.setControlGroupNumber(3),this.buildControls()}static buildControls(){this.controlsEl&&document.body.removeChild(this.controlsEl);let e=this.controlsEl=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="200px",e.style.padding="5px",e.style.background="rgba(255, 255, 255, 0.5)",e.style.border="1px black solid",e.appendChild(document.createTextNode("Remap color:"));let t=this.rules.getMultiplayerColors(),i=document.createElement("select");i.style.display="block",i.addEventListener("change",(()=>{this.currentAircraft.owner.color=t.get(i.value)})),e.appendChild(i),t.forEach(((e,t)=>{let r=document.createElement("option");r.innerHTML=t,r.value=t,r.selected=e.asHex()===this.currentAircraft.owner.color.asHex(),i.appendChild(r)})),e.appendChild(document.createTextNode("Selection level:"));let r=document.createElement("div");e.appendChild(r),[T.SelectionLevel.None,T.SelectionLevel.Hover,T.SelectionLevel.Selected].forEach((e=>{let t=document.createElement("button");t.innerHTML=T.SelectionLevel[e],t.disabled=!this.currentAircraft.rules.selectable,t.addEventListener("click",(()=>this.currentRenderable.selectionModel.setSelectionLevel(e))),r.appendChild(t)})),e.appendChild(document.createTextNode("Veteran level:"));let n=document.createElement("div");e.appendChild(n),this.currentAircraft.veteranTrait&&[v.VeteranLevel.None,v.VeteranLevel.Veteran,v.VeteranLevel.Elite].forEach((e=>{let t=document.createElement("button");t.innerHTML=v.VeteranLevel[e],t.addEventListener("click",(()=>this.currentAircraft.veteranTrait.veteranLevel=e)),n.appendChild(t)})),e.appendChild(document.createTextNode("Rudder:"));let a=document.createElement("input");a.style.display="block",a.type="range",a.min="-180",a.max="180",a.value="0",a.addEventListener("input",(()=>{this.currentAircraft.yaw=Number(a.value)})),e.appendChild(a);let o=document.createElement("input");o.style.display="block",o.type="range",o.min="-180",o.max="180",o.value="0",o.addEventListener("input",(()=>{this.currentAircraft.pitch=Number(o.value)})),e.appendChild(o);let l=document.createElement("input");l.style.display="block",l.type="range",l.min="-180",l.max="180",l.value="0",l.addEventListener("input",(()=>{this.currentAircraft.roll=Number(l.value)})),e.appendChild(l),e.appendChild(document.createTextNode("Height:"));let c=document.createElement("input");c.type="range",c.min="0",c.max="2560",c.value="0",c.style.display="block",c.addEventListener("input",(()=>{this.currentAircraft.position.tileElevation=s.Coords.worldToTileHeight(Number(c.value))})),e.appendChild(c),e.appendChild(document.createTextNode("isMoving:"));let h=document.createElement("input");h.type="checkbox",h.style.display="block",h.addEventListener("change",(e=>{var t=e.target.checked;this.currentAircraft.moveTrait.moveState=t?M.MoveState.Moving:M.MoveState.Idle,this.currentAircraft.zone=t?G.ZoneType.Air:G.ZoneType.Ground})),e.appendChild(h),e.appendChild(document.createTextNode("Warped out:"));let u=document.createElement("input");u.type="checkbox",u.style.display="block",u.addEventListener("change",(e=>{this.currentAircraft.warpedOutTrait.debugSetActive(e.target.checked)})),e.appendChild(u);let d=document.createElement("button");d.style.display="block",d.style.color="red",d.innerHTML="DESTROY",d.addEventListener("click",(async()=>{this.currentAircraft.isDestroyed=!0,this.world.removeObject(this.currentAircraft),this.currentAircraft.dispose(),this.currentAircraft=void 0,document.body.removeChild(this.controlsEl),this.controlsEl=void 0})),e.appendChild(d),document.body.appendChild(e)}static buildBrowser(e){let t=this.listEl=document.createElement("div");t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.height="600px",t.style.width="200px",t.style.overflowY="auto",t.style.padding="5px",t.style.background="rgba(255, 255, 255, 0.5)",t.style.border="1px black solid",t.appendChild(document.createTextNode("Aircraft types:"));let i=[...e.keys()].filter((e=>this.art.hasObject(e,A.ObjectType.Aircraft))).sort();i.forEach((e=>{let i=document.createElement("a");i.style.display="block",i.textContent=e,i.setAttribute("href","javascript:;"),i.addEventListener("click",(()=>{console.log("Selected aircraft",e),this.selectAircraft(e)})),t.appendChild(i)})),document.body.appendChild(t),setTimeout((()=>{this.selectAircraft(i[0])}),50)}static destroy(){this.renderer.destroy(),this.uiAnimationLoop.destroy(),this.listEl.remove(),this.controlsEl&&(this.controlsEl.remove(),this.controlsEl=void 0),this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=void 0),this.disposables.dispose()}}),W.disposables=new S.CompositeDisposable}}})),System.register("tools/SoundTester",["util/disposable/CompositeDisposable","data/AudioBagFile","data/IdxFile","engine/Engine"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("SoundTester",a=class e{static async main(e,t){this.sounds=n.Engine.getSounds(),this.audioBag=new r.AudioBagFile;var i=e.openFile("audio.bag"),a=e.openFile("audio.idx");this.audioBag.fromVirtualFile(i,new s.IdxFile(a.stream)),e.addArchive(this.audioBag,"audio.bag"),this.buildBrowser()}static selectSound(e){let t=new AudioContext,i=t.createGain();i.gain.value=.5;var r=new Uint8Array(this.sounds.get(e).getData()).buffer;t.decodeAudioData(r,(e=>{let r=t.createBufferSource();r.buffer=e,r.connect(i).connect(t.destination),r.start(0)}),(e=>console.log(e)))}static buildBrowser(){let t=this.listEl=document.createElement("div");t.style.position="absolute",t.style.right="0",t.style.top="0",t.style.height="600px",t.style.width="200px",t.style.overflowY="auto",t.style.padding="5px",t.style.background="rgba(255, 255, 255, 0.5)",t.style.border="1px black solid",t.appendChild(document.createTextNode("Sound files:")),this.audioBag.getFileList().forEach((i=>{let r=document.createElement("a");r.style.display="block",r.textContent=i,r.setAttribute("href","javascript:;"),r.addEventListener("click",(()=>{e.selectSound(i)})),t.appendChild(r)})),document.body.appendChild(t)}static destroy(){this.listEl.remove(),this.disposables.dispose()}}),a.disposables=new i.CompositeDisposable}}})),System.register("LocalPrefs",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{}).GameRes="_r_gameRes",t.Options="_r_opts_v3",t.Mixer="_r_mixer_v3",t.MusicOpts="_r_opts_music",t.LastGpuTier="_r_last_gpu",t.LastMap="_r_lastMap",t.LastMode="_r_lastMode",t.LastSortMap="_r_lastSortMap",t.LastPlayerCountry="_r_lastCountry",t.LastPlayerColor="_r_lastColor",t.PreferredGameOpts="_r_hostOpts",t.LastConnection="_r_lastCon",t.PreferredServerRegion="_r_region",t.TauntsEnabled="_r_taunts",t.DonateBoxState="_r_donateBoxState",e("StorageKey",i),e("LocalPrefs",class{constructor(e){this.storage=e}getItem(e){try{return this.storage?.getItem(e)??void 0}catch(t){return void console.warn(`Unable to read key ${e} from localStorage.`,t)}}setItem(e,t){try{return this.storage?.setItem(e,t),!0}catch(t){return console.warn(`Unable to write key ${e} to localStorage.`,t),!1}}removeItem(e){try{this.storage?.removeItem(e)}catch(t){console.warn(`Unable to remove key ${e} from localStorage.`,t)}}listItems(){return this.storage?Object.keys(this.storage):[]}})}}})),System.register("util/fullScreen",[],(function(e,t){"use strict";return t&&t.id,e("setupFullScreenChangeListener",(function(e,t){if(e.fullscreenEnabled){let i=!0;const r=()=>{var r=!!e.fullscreenElement;r?i=!1:setTimeout((()=>i=!0),100),t(r)},s=async t=>{if(122===t.keyCode&&i&&!e.fullscreenElement)try{await e.documentElement.requestFullscreen()}catch(t){console.warn("Full screen permission denied by user.")}};return e.addEventListener("fullscreenchange",r),e.addEventListener("keyup",s),()=>{e.removeEventListener("fullscreenchange",r),e.removeEventListener("keyup",s)}}console.warn("Browser fullscreen API not available.")})),{setters:[],execute:function(){}}})),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommandType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{}).CenterView="CenterView",t.Options="Options",t.CenterOnRadarEvent="CenterOnRadarEvent",t.RightSidebarUp="RightSidebarUp",t.RightSidebarDown="RightSidebarDown",t.LeftSidebarDown="LeftSidebarDown",t.LeftSidebarUp="LeftSidebarUp",t.Delete="Delete",t.TeamSelect_10="TeamSelect_10",t.TeamSelect_1="TeamSelect_1",t.TeamSelect_2="TeamSelect_2",t.TeamSelect_3="TeamSelect_3",t.TeamSelect_4="TeamSelect_4",t.TeamSelect_5="TeamSelect_5",t.TeamSelect_6="TeamSelect_6",t.TeamSelect_7="TeamSelect_7",t.TeamSelect_8="TeamSelect_8",t.TeamSelect_9="TeamSelect_9",t.ToggleAlliance="ToggleAlliance",t.PlaceBeacon="PlaceBeacon",t.AllToCheer="AllToCheer",t.DeployObject="DeployObject",t.InfantryTab="InfantryTab",t.Follow="Follow",t.GuardObject="GuardObject",t.CenterBase="CenterBase",t.ToggleRepair="ToggleRepair",t.ToggleSell="ToggleSell",t.PreviousObject="PreviousObject",t.NextObject="NextObject",t.CombatantSelect="CombatantSelect",t.StructureTab="StructureTab",t.UnitTab="UnitTab",t.StopObject="StopObject",t.TypeSelect="TypeSelect",t.PageUser="PageUser",t.DefenseTab="DefenseTab",t.ScatterObject="ScatterObject",t.HealthNav="HealthNav",t.VeterancyNav="VeterancyNav",t.PlanningMode="PlanningMode",t.View1="View1",t.View2="View2",t.View3="View3",t.View4="View4",t.Taunt_1="Taunt_1",t.Taunt_2="Taunt_2",t.Taunt_3="Taunt_3",t.Taunt_4="Taunt_4",t.Taunt_5="Taunt_5",t.Taunt_6="Taunt_6",t.Taunt_7="Taunt_7",t.Taunt_8="Taunt_8",t.RaiseCell="RaiseCell",t.LowerCell="LowerCell",t.DeleteObject="DeleteObject",t.TeamAddSelect_10="TeamAddSelect_10",t.TeamAddSelect_1="TeamAddSelect_1",t.TeamAddSelect_2="TeamAddSelect_2",t.TeamAddSelect_3="TeamAddSelect_3",t.TeamAddSelect_4="TeamAddSelect_4",t.TeamAddSelect_5="TeamAddSelect_5",t.TeamAddSelect_6="TeamAddSelect_6",t.TeamAddSelect_7="TeamAddSelect_7",t.TeamAddSelect_8="TeamAddSelect_8",t.TeamAddSelect_9="TeamAddSelect_9",t.IonStorm="IonStorm",t.TeamCreate_10="TeamCreate_10",t.TeamCreate_1="TeamCreate_1",t.TeamCreate_2="TeamCreate_2",t.TeamCreate_3="TeamCreate_3",t.TeamCreate_4="TeamCreate_4",t.TeamCreate_5="TeamCreate_5",t.TeamCreate_6="TeamCreate_6",t.TeamCreate_7="TeamCreate_7",t.TeamCreate_8="TeamCreate_8",t.TeamCreate_9="TeamCreate_9",t.ScreenCapture="ScreenCapture",t.ToggleElite="ToggleElite",t.FreeMoney="FreeMoney",t.IonBlast="IonBlast",t.LightningBolt="LightningBolt",t.ToggleMono="ToggleMono",t.NukeExplosion="NukeExplosion",t.BuildCheat="BuildCheat",t.ToggleShroud="ToggleShroud",t.ToggleThreatPrint="ToggleThreatPrint",t.SpecialWeapons="SpecialWeapons",t.ToggleAttackFriendlies="ToggleAttackFriendlies",t.SetView1="SetView1",t.SetView2="SetView2",t.SetView3="SetView3",t.SetView4="SetView4",t.Explosion="Explosion",t.PrevMonoPage="PrevMonoPage",t.NextMonoPage="NextMonoPage",t.TeamCenter_10="TeamCenter_10",t.TeamCenter_1="TeamCenter_1",t.TeamCenter_2="TeamCenter_2",t.TeamCenter_3="TeamCenter_3",t.TeamCenter_4="TeamCenter_4",t.TeamCenter_5="TeamCenter_5",t.TeamCenter_6="TeamCenter_6",t.TeamCenter_7="TeamCenter_7",t.TeamCenter_8="TeamCenter_8",t.TeamCenter_9="TeamCenter_9",t.ToggleMarbleMadness="ToggleMarbleMadness",t.ForceWin="ForceWin",t.BailOut="BailOut",t.SuperExplosion="SuperExplosion",t.SidebarPageUp="SidebarPageUp",t.SidebarUp="SidebarUp",t.SidebarPageDown="SidebarPageDown",t.SidebarDown="SidebarDown",t.ToggleFps="ToggleFps",t.Scoreboard="Scoreboard",e("KeyCommandType",i)}}})),System.register("gui/screen/game/worldInteraction/keyboard/KeyBinds",["data/DataStream","data/IniFile","data/vfs/VirtualFile","gui/screen/game/worldInteraction/keyboard/KeyCommandType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=new Map([[98,40],[100,37],[102,39],[104,38]]),e("KeyBinds",o=class e{constructor(e,t,i){this.configDir=e,this.persistFileName=t,this.defaultIni=i,this.hotKeys=new Map}async load(){this.hotKeys.clear();let e,t=!0;try{this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&(e=new r.IniFile(await this.configDir.openFile(this.persistFileName)),this.loadHotKeys(e),t=!1)}catch(t){console.log(`Failed to load hotkeys from local file "${this.persistFileName}"`,t)}if(t){var i,s;for([i,s]of(e=this.defaultIni,new Map([[n.KeyCommandType.PreviousObject,"M".charCodeAt(0)],[n.KeyCommandType.VeterancyNav,"Y".charCodeAt(0)],[n.KeyCommandType.HealthNav,"U".charCodeAt(0)],[n.KeyCommandType.FreeMoney,582],[n.KeyCommandType.BuildCheat,593],[n.KeyCommandType.ToggleFps,512+"R".charCodeAt(0)],[n.KeyCommandType.ToggleShroud,1024+"S".charCodeAt(0)]])))this.addHotKey(i,s);this.loadHotKeys(e)}this.addHotKey(n.KeyCommandType.Scoreboard,9)}async saveIni(e){await(this.configDir?.writeFile(new s.VirtualFile((new i.DataStream).writeString(e.toString()),this.persistFileName)))}async resetAndReload(){this.configDir&&await this.configDir.containsEntry(this.persistFileName)&&await this.configDir.deleteFile(this.persistFileName),await this.load()}loadHotKeys(t){let i=t.getSection(e.iniSection);if(!i)throw new Error(`Missing [${e.iniSection}] ini section`);let r=Object.keys(n.KeyCommandType);for(var s of i.entries.keys()){var a;r.includes(s)?(a=i.getNumber(s),this.changeHotKey(s,a)):console.warn("Unknown keyboard command "+s)}return this}async save(){let t=new r.IniFile,i=t.getOrCreateSection(e.iniSection);for(var[s,n]of this.hotKeys)i.set(n,""+s);await this.saveIni(t)}addHotKey(e,t){this.hotKeys.set("number"==typeof t?t:this.getHotKeyCode(t),e)}changeHotKey(e,t){var i;for(i of[...this.hotKeys.entries()].filter((([,t])=>t===e)).map((([e])=>e)))this.hotKeys.delete(i);t&&this.addHotKey(e,t)}getCommandType(e){if(!(255<e.keyCode)){var t=this.getHotKeyCode(e);return this.hotKeys.get(t)}}getHotKeyCode(e){let t=(Number(e.metaKey)<<12)+(Number(e.altKey)<<10)+(Number(e.ctrlKey)<<9)+(Number(e.shiftKey)<<8)+e.keyCode;var i=a.get(e.keyCode);return i&&(t+=2048-e.keyCode+i),t}getHotKey(e){var t,i=[...this.hotKeys.entries()].find((([,t])=>t===e))?.[0];if(void 0!==i){let e=255&i;return 2048&i&&((t=[...a].find((([,t])=>t===e))?.[0])?e=t:console.error(`Expected an numpad arrow key code but got ${e} (${i}) instead`)),{keyCode:e,shiftKey:Boolean(256&i),ctrlKey:Boolean(512&i),altKey:Boolean(1024&i),metaKey:Boolean(4096&i)}}}}),o.iniSection="Hotkey"}}})),System.register("gui/FullScreen",["util/disposable/CompositeDisposable","util/fullScreen","util/event"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("FullScreen",n=class e{constructor(e){this.document=e,this.disposables=new i.CompositeDisposable,this._onChange=new s.EventDispatcher,this.handleFullScreenChange=e=>{this._onChange.dispatch(this,e)}}static isFullScreenHotKey(e){return e.keyCode===this.hotKey.keyCode&&e.altKey===this.hotKey.altKey&&e.shiftKey===this.hotKey.shiftKey&&e.ctrlKey===this.hotKey.ctrlKey&&e.metaKey===this.hotKey.metaKey}get onChange(){return this._onChange.asEvent()}init(){const t=t=>{e.isFullScreenHotKey(t)&&(t.preventDefault(),t.stopPropagation(),this.toggle())};this.document.addEventListener("keydown",t),this.disposables.add((()=>this.document.removeEventListener("keydown",t)));var i=r.setupFullScreenChangeListener(this.document,this.handleFullScreenChange);i&&this.disposables.add(i)}toggle(){this.toggleAsync().catch((e=>console.error(e)))}isFullScreen(){return!!this.document.fullscreenElement}async toggleAsync(){this.document.fullscreenElement?await this.document.exitFullscreen():await this.document.documentElement.requestFullscreen()}dispose(){this.disposables.dispose()}}),n.hotKey={altKey:!0,shiftKey:!1,ctrlKey:!1,metaKey:!1,keyCode:"F".charCodeAt(0)}}}})),System.register("network/ServerRegions",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ServerRegions",class{constructor(){this.regions=new Map}load(e){for(var t of(this.regions.clear(),e.getOrderedSections()))this.regions.set(t.name,{id:t.name,label:t.getString("label"),available:t.getBool("available",!0),gameVersion:this.normalizeVersion(t.getString("gameVersion")||void 0),gservUrl:t.getString("gservUrl"),wolUrl:t.getString("wolUrl"),wladderUrl:t.getString("wladderUrl")||void 0,wgameresUrl:t.getString("wgameresUrl")||void 0,wolv2Ascii:t.getBool("wolv2Ascii"),wolKeepAliveInGame:t.getBool("wolKeepAliveInGame")})}normalizeVersion(e){return void 0!==e&&e.match(/^\d+\.\d+$/)&&(e+=".0"),e}get(e){if(!this.regions.has(e))throw new Error("Unknown region id "+e);return this.regions.get(e)}has(e){return this.regions.has(e)}isAvailable(e){return this.regions.has(e)&&this.regions.get(e).available}getAll(){return[...this.regions.values()]}getFirstAvailable(){return this.getAll().filter((e=>e.available))[0]}getSize(){return this.regions.size}setSelectedRegion(e){this.selectedRegion=this.get(e)}getSelectedRegion(){if(!this.selectedRegion)throw new Error("No server region selected");return this.selectedRegion}})}}})),System.register("gui/screen/options/GraphicsOptions",["engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","util/BoxedVar"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("GraphicsOptions",class{constructor(){this.resolution=new s.BoxedVar(void 0),this.models=new s.BoxedVar(i.ModelQuality.High),this.shadows=new s.BoxedVar(r.ShadowQuality.High)}unserialize(e){let[t,i,r]=e.split(",");var s;return this.models.value=Number(t),this.shadows.value=Number(i),void 0!==r&&(s=r.length?r.split("x").map((e=>Number(e))):void 0,this.resolution.value=s?{width:s[0],height:s[1]}:void 0),this}serialize(){return[this.models.value,this.shadows.value,this.resolution.value?[this.resolution.value.width,this.resolution.value.height].join("x"):""].join(",")}applyLowPreset(){this.models.value=i.ModelQuality.Low,this.shadows.value=r.ShadowQuality.Low}applyHighPreset(){this.models.value=i.ModelQuality.High,this.shadows.value=r.ShadowQuality.High}})}}})),System.register("gui/screen/options/GeneralOptions",["engine/renderable/entity/unit/FlyerHelperMode","util/Base64","util/BoxedVar","gui/screen/options/GraphicsOptions"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("SCROLL_BASE_FACTOR",3),e("GeneralOptions",class{constructor(){this.scrollRate=new s.BoxedVar(12),this.flyerHelper=new s.BoxedVar(i.FlyerHelperMode.Selected),this.hiddenObjects=new s.BoxedVar(!0),this.targetLines=new s.BoxedVar(!0),this.rightClickMove=new s.BoxedVar(!1),this.rightClickScroll=new s.BoxedVar(!0),this.mouseAcceleration=new s.BoxedVar(!0),this.graphics=new n.GraphicsOptions}unserialize(e){var[t,i,s,n,a,o,l,c]=e.split(",");return this.scrollRate.value=Number(t),void 0!==i&&(this.flyerHelper.value=Number(i)),void 0!==s&&this.graphics.unserialize(r.Base64.decode(s)),void 0!==n&&(this.hiddenObjects.value=Boolean(Number(n))),void 0!==a&&(this.rightClickMove.value=Boolean(Number(a))),void 0!==o&&(this.rightClickScroll.value=Boolean(Number(o))),void 0!==l&&(this.targetLines.value=Boolean(Number(l))),void 0!==c&&(this.mouseAcceleration.value=Boolean(Number(c))),this}serialize(){return[this.scrollRate.value,this.flyerHelper.value,r.Base64.encode(this.graphics.serialize()),Number(this.hiddenObjects.value),Number(this.rightClickMove.value),Number(this.rightClickScroll.value),Number(this.targetLines.value),Number(this.mouseAcceleration.value)].join(",")}})}}})),System.register("engine/gameRes/GameResConfig",["engine/gameRes/GameResSource"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("GameResConfig",class{constructor(e){this.defaultCdnBaseUrl=e}unserialize(e){var[t,r]=e.split(","),t=Number(t);if(!i.GameResSource[t])throw new Error(`Unknown game res source "${t}"`);this.source=t,this.cdnUrl=r?decodeURI(r):void 0}serialize(){return this.source+(this.cdnUrl?","+encodeURI(this.cdnUrl):"")}isCdn(){return this.source===i.GameResSource.Cdn}getCdnBaseUrl(){return this.cdnUrl??this.defaultCdnBaseUrl}})}}})),System.register("gui/component/Dialog",["react"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.default.Component{render(){return this.props.hidden?null:i.default.createElement("div",{style:this.getWrapperStyle()},i.default.createElement("div",{className:"message-box "+this.props.className},i.default.createElement("div",{className:"message-box-content"},this.props.children),i.default.createElement("div",{className:"message-box-footer"},this.props.buttons.map(((e,t)=>this.renderButton(e,t))))))}renderButton(e,t){return i.default.createElement("button",{key:t,className:"dialog-button",onClick:e.onClick},e.label)}getWrapperStyle(){var e=this.props.viewport;return{position:"absolute",top:e.x,left:e.y,width:e.width,height:e.height,zIndex:this.props.zIndex}}},e("Dialog",r)}}})),System.register("gui/component/BasicErrorBoxApi",["gui/HtmlReactElement","util/disposable/CompositeDisposable","gui/component/Dialog","react"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("BasicErrorBoxApi",class{constructor(e,t,i){this.viewport=e,this.strings=t,this.rootEl=i,this.disposables=new r.CompositeDisposable}async show(e,t=!1){return new Promise((r=>{let a=this.component=i.HtmlReactElement.factory(s.Dialog,{children:e.split(/\n/g).map(((e,t)=>t?n.default.createElement(n.default.Fragment,{key:t},n.default.createElement("br",null),e):e)),className:"basic-error-box",viewport:this.viewport.value,buttons:t?[]:[{label:this.strings.get("GUI:Ok"),onClick:()=>{this.destroy(),r()}}]}),o=e=>{this.component.setSize(e.width,e.height),this.component.applyOptions((t=>t.viewport=e))};this.viewport.onChange.subscribe(o),a.setSize(this.viewport.value.width,this.viewport.value.height),a.render(),this.rootEl.appendChild(a.getElement()),this.disposables.add((()=>this.viewport.onChange.unsubscribe(o)),(()=>this.rootEl.removeChild(this.component.getElement())),(()=>this.component.unrender()),(()=>this.component=void 0))}))}destroy(){this.disposables.dispose()}})}}})),System.register("engine/gameRes/importError/ChecksumError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{constructor(e,t){super(e),this.file=t}},e("ChecksumError",i)}}})),System.register("engine/gameRes/importError/FileNotFoundError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{constructor(e){super(`File "${e}" not found.`),this.file=e}},e("FileNotFoundError",i)}}})),System.register("engine/gameRes/importError/NoStorageError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("NoStorageError",i)}}})),System.register("gui/component/GameResForm",["react","classnames"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("GameResForm",(({closable:e,strings:t,archiveUrl:s,onBrowseFolder:n,onBrowseArchive:a,onDrop:o,onClose:l})=>{let[c,h]=i.default.useState();var u=i.default.useCallback((e=>{e.target===c&&h(void 0)}),[c]);return i.default.useEffect((()=>{let e=e=>e.preventDefault();return globalThis.addEventListener("drop",e),globalThis.addEventListener("dragover",e),()=>{globalThis.removeEventListener("drop",e),globalThis.removeEventListener("dragover",e)}}),[]),i.default.createElement("div",null,e&&i.default.createElement("div",{className:"close-button",onClick:l}),i.default.createElement("div",{className:"title"},t.get("ts:gameres_locate_title")),i.default.createElement("div",{className:"browse-container"},i.default.createElement("p",null,t.get("ts:gameres_import_desc"),s&&" "+t.get("ts:gameres_download_desc")),s&&i.default.createElement(i.default.Fragment,null,i.default.createElement("div",{className:"link-container"},i.default.createElement("p",null,i.default.createElement("a",{rel:"nofollow noopener noreferrer",target:"_blank",href:s},s)),i.default.createElement("p",null,i.default.createElement("em",null,t.get("ts:gameres_download_hint"),i.default.createElement("br",null),t.get("ts:gameres_download_size",200))))),i.default.createElement("div",{className:r.default("drop-container",{"dropzone-active":!!c}),onDragOver:e=>e.preventDefault(),onDragLeave:u,onDragEnter:e=>{[...e.dataTransfer.items].every((e=>"file"===e.kind))&&h(e.target)},onDrop:e=>{e.preventDefault(),[...e.dataTransfer.items].every((e=>"file"===e.kind))&&o(e.dataTransfer)}},i.default.createElement("p",{className:"drop-figures"},i.default.createElement("img",{src:"res/img/drag-archive.png",width:"98",height:"133",alt:"Red-Alert-2-Multiplayer.exe"}),t.get("ts:gameres_or"),i.default.createElement("img",{src:"res/img/drag-folder.png",width:"99",height:"153",alt:"Command and Conquer Red Alert II"})),i.default.createElement("p",{className:"desc"},t.get("ts:gameres_drop_desc"),i.default.createElement("br",null),t.get("ts:gameres_or")),i.default.createElement("p",{className:"browse-buttons"},i.default.createElement("button",{className:"dialog-button",onClick:n},t.get("ts:gameres_browse_folder")),i.default.createElement("button",{className:"dialog-button",onClick:a},t.get("ts:gameres_browse_archive"))),i.default.createElement("p",{className:"archive-formats"},i.default.createElement("em",null,t.get("ts:gameres_supported_archive_formats"))))))}))}}})),System.register("engine/gameRes/FileSystemAccessLib",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gameRes/FileSystemUtil",["data/vfs/FileNotFoundError","data/vfs/IOError"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("FileSystemUtil",class{static async getDirContents(e){let t=[];try{for await(var s of e.values())t.push(s)}catch(t){if("NotFoundError"===t.name)throw new i.FileNotFoundError(`Directory "${e.name}" not found`,{cause:t});if(t instanceof DOMException)throw new r.IOError(`Directory "${e.name}" could not be read (${t.name})`,{cause:t});throw t}return t}static async listDir(e){let t=[];try{for await(var s of e.keys())t.push(s)}catch(t){if("NotFoundError"===t.name)throw new i.FileNotFoundError(`Directory "${e.name}" not found`,{cause:t});if(t instanceof DOMException)throw new r.IOError(`Directory "${e.name}" could not be read (${t.name})`,{cause:t});throw t}return t}static async showArchivePicker(e){var t=await e.showOpenFilePicker({types:[{description:"Archive",accept:{"application/vnd.rar":[".rar"],"application/zip":[".zip"],"application/x-tar":[".tar"],"application/gzip":[".gz"],"application/x-bzip":[".bz"],"application/x-bzip2":[".bz2"],"application/x-xz":[".xz"],"application/x-7z-compressed":[".7z"],"application/octet-stream":[".exe"]}}]});return Array.isArray(t)?t[0]:t}static polyfillGetFile(){const e=FileSystemFileHandle.prototype.getFile;FileSystemFileHandle.prototype.getFile=function(){return e.call(this).then((e=>new File([e],this.name,{type:e.type,lastModified:e.lastModified})))}}})}}})),System.register("gui/component/GameResBoxApi",["react","classnames","gui/HtmlReactElement","gui/component/Dialog","gui/component/GameResForm","engine/gameRes/FileSystemUtil"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("GameResBoxApi",class{constructor(e,t,i,r){this.viewport=e,this.strings=t,this.rootEl=i,this.fsAccessLib=r}async promptForGameRes(e,t){return await this.fsAccessLib.polyfillDataTransferItem(),await new Promise((l=>{let c=s.HtmlReactElement.factory(n.Dialog,{className:r.default("game-res-box",{"game-res-box-no-dl":!e}),buttons:[],children:i.default.createElement(a.GameResForm,{archiveUrl:e,closable:t,strings:this.strings,onDrop:async e=>{if(e.items.length)try{var t=await e.items[0].getAsFileSystemHandle();if(!t)return;u(),l(t)}catch(e){console.error(e)}},onBrowseFolder:async()=>{try{var e=await this.fsAccessLib.showDirectoryPicker({_preferPolyfill:!0});u(),l(e)}catch(e){console.error(e)}},onBrowseArchive:async()=>{try{var e=await o.FileSystemUtil.showArchivePicker(this.fsAccessLib);u(),l(e)}catch(e){console.error(e)}},onClose:()=>{u(),l(void 0)}}),viewport:this.viewport.value}),h=e=>{c.setSize(e.width,e.height),c.applyOptions((t=>t.viewport=e))};this.viewport.onChange.subscribe(h);const u=()=>{this.viewport.onChange.unsubscribe(h),h=void 0,this.rootEl.removeChild(c.getElement()),c.unrender(),c=void 0};c.setSize(this.viewport.value.width,this.viewport.value.height),c.render(),this.rootEl.appendChild(c.getElement())}))}})}}})),System.register("engine/gameRes/CdnManifest",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("engine/gameRes/CdnResourceLoader",["data/DataStream","data/Crc32","data/vfs/VirtualFile","engine/ResourceLoader"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class e extends n.ResourceLoader{constructor(e,t,i){super(e),this.cdnManifest=t,this.cacheDir=i}static async clearCache(t){for await(var i of t.getEntries())i.startsWith(e.cachePrefix)&&await t.deleteFile(i)}getFileNameFromUrl(e){return e.split("?")[0].split("/").pop()}async fetchResource(t,a,o){let l=this.getFileNameFromUrl(t);var c=e.cachePrefix+l,h=this.cdnManifest.checksums[l];try{if(l.endsWith(".mix")&&void 0!==h&&this.cacheDir&&await this.cacheDir.containsEntry(c)){let e=await this.cacheDir.getRawFile(c);var u=new Uint8Array(await e.arrayBuffer());if(r.Crc32.calculateCrc(u)===h)return o?.onProgress?.(u.length),u;try{await this.cacheDir.deleteFile(c)}catch(t){console.error("Couldn't delete file from local CDN cache",t)}}}catch(t){console.error(`Couldn't read file "${c}" from local CDN cache`,t)}if(void 0!==h&&(t+=(t.includes("?")?"&":"?")+"h="+h),u=await super.fetchResource(t,a,o),r.Crc32.calculateCrc(u)!==h)throw new n.DownloadError(`Checksum mismatch for URL "${t}"`);try{await(this.cacheDir?.writeFile(s.VirtualFile.factory(new i.DataStream(u),c)))}catch(t){console.error("Couldn't write file to local CDN cache",t)}return u}},e("CdnResourceLoader",a),a.cachePrefix="cdncache_"}}})),System.register("engine/gameRes/importError/ArchiveExtractionError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("ArchiveExtractionError",i)}}})),System.register("engine/gameRes/VideoConverter",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("VideoConverter",class{async convertBinkVideo(e,t,i="webm"){var r=t.filename,s=t.filename.replace(/\.\w+$/,"")+"."+i;e.FS("writeFile",r,new Uint8Array(t.stream.buffer,t.stream.byteOffset,t.stream.byteLength)),"webm"===i?await e.run("-i",r,"-vcodec","libvpx","-crf","10","-b:v","2M","-deadline","realtime","-speed","2","-an",s):await e.run("-i",r,"-vcodec","libx264","-crf","25","-b:v","2M","-an",s);var n=e.FS("readFile",s);return e.FS("unlink",r),e.FS("unlink",s),n}})}}})),System.register("engine/gameRes/importError/InvalidArchiveError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("InvalidArchiveError",i)}}})),System.register("engine/gameRes/importError/NoWebAssemblyError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("NoWebAssemblyError",i)}}})),System.register("engine/gameRes/GameResImporter",["data/MixFile","engine/Engine","util/time","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/ArchiveExtractionError","data/vfs/VirtualFile","engine/mixDatabase","data/Palette","data/ShpFile","engine/gfx/ImageUtils","util/string","engine/gameRes/VideoConverter","engine/gameRes/importError/InvalidArchiveError","data/vfs/FileNotFoundError","data/vfs/IOError","data/vfs/RealFileSystemDir","engine/gameRes/importError/NoWebAssemblyError"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){e("GameResImporter",class{constructor(e){this.strings=e}async import(e,t,i){var n=["ra2.mix","language.mix","multi.mix","theme.mix"];let l=new Set(["theme.mix"]),c=r.Engine.rfsSettings.tauntsDir,h=this.strings;if(i(h.get("ts:import_preparing_for_import")),"file"===e.kind){if(!window.WebAssembly)throw new v.NoWebAssemblyError("WebAssembly is not available");let r,f,T=await SystemJS.import("7z-wasm"),w=await T({quit:(e,t)=>{r=e,f=t}});i(h.get("ts:import_loading_archive")),w.FS.chdir("/tmp");var u=e.name;try{let t=await e.getFile();var d=await t.arrayBuffer(),p=w.FS.open(u,"w+");w.FS.write(p,new Uint8Array(d),0,d.byteLength,0,!0),w.FS.close(p)}catch(e){if(e instanceof DOMException)throw new y.IOError(`File "${u}" could not be read (${e.name})`,{cause:e});throw e}if(i(h.get("ts:import_extracting_archive")),await s.sleep(100),p=[...n,c],w.callMain(["x","-ssc-",u,...p]),r)throw 1===r?new o.ArchiveExtractionError("Archive extraction failed with code "+r,{cause:f}):new m.InvalidArchiveError("7-Zip exited with code "+r,{cause:f});w.FS.unlink(u);u=w.FS.lookupPath(w.FS.cwd()).node;let C=Object.keys(u.contents);for(let e of n){var b=C.find((t=>g.equalsIgnoreCase(t,e)))??e;let r;i(h.get("ts:import_importing",e));try{r=this.readFileFromEmFs(w.FS,b)}catch(t){if("ENOENT"!==t.code)throw t;if(l.has(e)){console.warn(`Mix file "${e}" not found. Skipping.`);continue}throw new a.FileNotFoundError(e)}await this.importMixArchive(r,t,i,h),w.FS.unlink(b)}let E=C.find((e=>g.equalsIgnoreCase(e,c)));if(E){u=w.FS.lookupPath(E).node,u=Object.keys(u.contents).map((e=>E+"/"+e));try{let e=await t.getOrCreateDirectory(c);for(var S of u){i(h.get("ts:import_importing",S));let t=this.readFileFromEmFs(w.FS,S);await e.writeFile(t,t.name.toLowerCase()),w.FS.unlink(S)}}catch(e){if(!(e instanceof DOMException||e instanceof y.IOError))throw e;console.warn("Failed to copy taunts folder. Skipping.",[e])}}else console.warn("Taunts folder not found in archive. Skipping.")}else{let r,s=new T.RealFileSystemDir(e,!0),o=await s.listEntries();for(let e of n){i(h.get("ts:import_importing",e));var w=o.find((t=>g.equalsIgnoreCase(t,e)))??e;let r;try{r=await s.getRawFile(w)}catch(t){if(t instanceof f.FileNotFoundError){if(l.has(e)){console.warn(`Mix file "${e}" not found. Skipping.`);continue}throw new a.FileNotFoundError(e)}throw t}await this.importMixArchive(r,t,i,h)}n=o.find((e=>g.equalsIgnoreCase(e,c)))??c;try{r=await s.getDirectory(n)}catch(e){if(!(e instanceof f.FileNotFoundError||e instanceof y.IOError))throw e;console.warn(`Directory "${n}" not found (${e.name}). Skipping.`,e)}if(r)try{let e=await t.getOrCreateDirectory(c,!0);for await(var C of r.getRawFiles())i(h.get("ts:import_importing",e.name+"/"+C.name)),await e.writeFile(C,C.name.toLowerCase())}catch(e){if(!(e instanceof y.IOError))throw e;console.warn("Failed to copy taunts folder. Skipping.",[e])}}}readFileFromEmFs(e,t){try{e.chmod(t,448)}catch(e){if(44!==e.errno)throw e}var i=e.readFile(t);let r=e.stat(t);return i=new Blob([i],{type:"application/octet-stream"}),new File([i],t.slice(t.lastIndexOf("/")+1),{lastModified:r.mtime.getTime()})}async importMixArchive(e,t,i,s){let a=e.name.toLowerCase();var o,l=a.match(/^theme[^.]*\.mix$/);if(!e.size){if(l)return void console.warn(`Mix file ${e.name} is empty. Skipping.`);throw new n.ChecksumError(`Mix file "${a}" is empty`,a)}l||await t.writeFile(e,a),l?(o=r.Engine.rfsSettings.musicDir,o=await t.getOrCreateDirectory(o,!0),await this.importMusic(e,o,(e=>i(s.get("ts:import_importing_pg",a,e))))):a.match(/language\.mix/)?(i(s.get("ts:import_importing_long",a)),await this.importVideo(e,t)):a.match(/ra2\.mix/)&&(o=await this.importSplashImage(e,t),i(void 0,o))}async importMusic(e,t,r){var s=await l.VirtualFile.fromRealFile(e);let n=new i.MixFile(s.stream);if(s=c.mixDatabase.get(e.name.toLowerCase())){var a,o=s.length;let i=o;for(a of s){if(r(Math.floor((o-i)/o*100)),i--,!a.match(/\.wav$/))throw new Error(`Music file "${a}" is not a WAV file`);var h=a.replace(".wav",".mp3");if(n.containsFile(a)){var u=n.openFile(a);if(u.stream.byteLength){let i;try{let e=await this.createFFMpeg();e.FS("writeFile",a,new Uint8Array(u.stream.buffer,u.stream.byteOffset,u.stream.byteLength)),await e.run("-i",a,"-vn","-ar","22050","-b:a","96k",h),i=e.FS("readFile",h),e.FS("unlink",a),e.FS("unlink",h)}catch(e){console.warn(`Failed to convert music file "${a}". Skipping.`),console.error(e);continue}u=new Blob([i],{type:"application/octet-stream"});try{await t.writeFile(new File([u],h))}catch(e){console.warn(`Failed to write music file "${h}". Skipping.`),console.error(e);continue}}else console.warn(`Music file "${a}" is empty in the mix archive. Skipping.`)}else console.warn(`Music file "${a} was not found in mix archive. Skipping.`)}}else console.warn(`File "${e.name} not found in mix database. Skipping music import.`)}async importVideo(e,t){var s=await this.createFFMpeg();let n=new i.MixFile((await l.VirtualFile.fromRealFile(e)).stream);var o="ra2ts_l.bik",c=r.Engine.rfsSettings.menuVideoFileName;if(!n.containsFile(o))throw new a.FileNotFoundError(o);o=n.openFile(o),o=await(new p.VideoConverter).convertBinkVideo(s,o),o=new Blob([o],{type:"video/webm"}),await t.writeFile(new File([o],c,{type:"video/webm"}))}async createFFMpeg(){let e=(0,(await SystemJS.import("@ffmpeg/ffmpeg")).createFFmpeg)({corePath:"lib/ffmpeg-core.js",log:!0});var t=window.define;return window.define=void 0,await e.load(),window.define=t,e}async importSplashImage(e,t){let s=new i.MixFile((await l.VirtualFile.fromRealFile(e)).stream);if(!s.containsFile("local.mix"))throw new a.FileNotFoundError("local.mix");let n=new i.MixFile(s.openFile("local.mix").stream);if(!n.containsFile("glsl.shp"))throw new a.FileNotFoundError("glsl.shp");var o=new u.ShpFile(n.openFile("glsl.shp"));if(!n.containsFile("gls.pal"))throw new a.FileNotFoundError("gls.pal");var c=new h.Palette(n.openFile("gls.pal"));o=await d.ImageUtils.convertShpToPng(o,c),c=r.Engine.rfsSettings.splashImgFileName;return await t.writeFile(new File([o],c,{type:o.type})),o}})}}})),System.register("util/ScriptLoader",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ScriptLoader",class{constructor(e){this.document=e}load(e,t={}){return new Promise(((i,r)=>{let s=this.document.head,n=this.document.createElement("script");n.type=t.type||"text/javascript",n.charset=t.charset||"utf8",n.async=void 0===t.async||t.async,n.src=e;const a=t.attrs;a&&Object.keys(a).forEach((e=>n.setAttribute(e,a[e]))),t.text&&(n.text=t.text),n.onload=()=>{i()};let o=new Error(`Failed to load script "${e}"`);n.onerror=()=>{r(o)},s.appendChild(n)}))}})}}})),System.register("util/Sentry",["util/ScriptLoader"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Sentry",class{async init(e,t){await new i.ScriptLoader(document).load(`https://js.sentry-cdn.com/${e.dsn}.min.js`);let r=this.sdk=window.Sentry,s=new Date;r.init({environment:e.env,release:t,denyUrls:[/^file:/],ignoreErrors:[/init message from worker/,/The object can not be found here/,/itemsclipboard/],initialScope:e=>e.setTags({locale:navigator.language}).setExtra("initTime",s),...e.defaultIntegrations?{}:{defaultIntegrations:!1}}),r.onLoad((()=>{this.sdk=window.Sentry})),e.lazyLoad||r.forceLoad()}captureException(e,t){this.sdk?.captureException(e,t)}configureScope(e){this.sdk?.configureScope(e)}addBreadcrumb(e){this.sdk?.addBreadcrumb(e)}})}}})),System.register("engine/gameRes/GameRes",["data/DataStream","data/MixFile","engine/Engine","engine/ResourceLoader","util/Logger","engine/gameRes/GameResConfig","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/NoStorageError","data/Crc32","data/Palette","data/ShpFile","data/PcxFile","engine/gfx/ImageUtils","data/Bitmap","engine/gfx/CanvasUtils","gui/component/GameResBoxApi","engine/gameRes/GameResSource","data/vfs/RealFileSystem","engine/resourceConfigs","engine/gameRes/CdnResourceLoader","LocalPrefs","engine/gameRes/FileSystemUtil","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","data/vfs/IOError","engine/gameRes/GameResImporter"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e}],execute:function(){e("GameRes",class{constructor(e,t,i,r,s,n,a,o,l,c,h){this.appVersion=e,this.modName=t,this.fsAccessLib=i,this.localPrefs=r,this.strings=s,this.rootEl=n,this.splashScreen=a,this.viewport=o,this.appConfig=l,this.appResPath=c,this.sentry=h}async init(e,t,i){let r,n,a,l,c,u,d=!1,g=!1,p=(e,t)=>{if(e&&this.splashScreen.setLoadingText(e),t){let e;e="string"==typeof t?t:r=URL.createObjectURL(t),this.splashScreen.setBackgroundImage(e)}};try{n=await this.getBrowserFsHandle("native")}catch(n){if(!(n instanceof h.NoStorageError))throw n}try{a=!!n&&await this.migrateStorageToNative(n,p)}catch(n){console.warn("Storage migration to native failed",n),this.sentry?.captureException(new Error("Failed to migrate files to native file system",{cause:n})),a=!1}finally{p(this.strings.get("GUI:LoadingEx"))}try{var m=a?n:await this.getBrowserFsHandle("fallback");m&&(l=await s.Engine.initRfs(m))}catch(n){if(!(n instanceof h.NoStorageError))throw n;console.warn("No storage adapters available.")}if(!e&&l&&await this.lookForGameFiles(l.getRootDirectory())&&((e=new o.GameResConfig("")).source=v.GameResSource.Local,g=!0),l&&(f=await s.Engine.getModDir(),c=await this.loadMod(l,f)),l&&l.addDirectory(await s.Engine.getMapDir()),e){var f=await this.loadSplashScreenBackground(l?.getRootDirectory(),c,e);"string"==typeof f?this.splashScreen.setBackgroundImage(f):f&&(r=URL.createObjectURL(f),this.splashScreen.setBackgroundImage(r));try{u=await this.loadResources(l,e,p),d=!0}catch(n){console.error("Failed to load initial game resources"),console.error(n),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await t(n,this.strings)}}let y=new T.GameResBoxApi(this.viewport,this.strings,this.rootEl,this.fsAccessLib);for(;!d;){this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),r&&(URL.revokeObjectURL(r),r=void 0);var b=await y.promptForGameRes(this.appConfig.gameResArchiveUrl,!!this.appConfig.gameresBaseUrl&&!this.modName);let s;if(e=new o.GameResConfig(this.appConfig.gameresBaseUrl??""),g=!0,b)if("file"===b.kind)s=v.GameResSource.Archive;else{if("directory"!==b.kind)throw new Error("Unexpected FileSystemHandle type "+b.kind);s=v.GameResSource.Local}else s=v.GameResSource.Cdn;if(e.source=s,s!==v.GameResSource.Cdn)try{if(!l)throw new h.NoStorageError("No storage adapters available");await new M.GameResImporter(this.strings).import(b,l.getRootDirectory(),((e,t)=>{p(e,t),e&&console.info(e)})),console.info("Game assets successfully imported.")}catch(n){console.error("Failed to import game assets"),console.error(n),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await i(n,this.strings);continue}finally{this.splashScreen.setLoadingText("")}try{this.splashScreen.setLoadingText(this.strings.get("GUI:LoadingEx")),u=await this.loadResources(l,e,p),d=!0}catch(n){console.error("Failed to load game assets"),console.error(n),this.splashScreen.setLoadingText(""),this.splashScreen.setBackgroundImage(""),await t(n,this.strings)}}return r&&URL.revokeObjectURL(r),{configToPersist:g?e:void 0,cdnResLoader:u}}async loadMod(e,t){let i,r=this.modName;return r&&(await t.containsEntry(r)?(console.info(`Loading mod "${r}"...`),i=await t.getDirectory(r),e.addDirectory(i),s.Engine.setActiveMod(r)):(console.info(`Mod "${r}" not found. Ignoring.`),r=this.modName=void 0)),i}async lookForGameFiles(e){let t=await e.listEntries();return["language.mix","multi.mix","ra2.mix"].every((e=>t.includes(e)))}async migrateStorageToNative(e,t){var i="_storage_migration_pending";if(this.localPrefs.getItem(i)){for await(var r of e.keys())await e.removeEntry(r,{recursive:!0});this.localPrefs.removeItem(i)}else if((await e.keys().next()).value)return!0;if(void 0===this.localPrefs.getItem(C.StorageKey.LastGpuTier))return!0;let n;console.info("Migrating to new storage...");try{n=await this.getBrowserFsHandle("fallback")}catch(t){if(t instanceof h.NoStorageError)return console.info("No existing storage found. Migration skipped."),!1;throw t}if(navigator.storage?.estimate){var a=await navigator.storage.estimate();if(void 0===a.usage||void 0===a.quota)return!1;if(a.usage>(a.quota-5242880)/2)return console.info("Migration to native storage skipped because of insufficient space."),!1}(await E.FileSystemUtil.listDir(n)).includes(s.Engine.rfsSettings.cacheDir)&&await n.removeEntry(s.Engine.rfsSettings.cacheDir,{recursive:!0}),this.localPrefs.setItem(i,"1");try{await this.migrateDir(n,e,t)}catch(t){for await(var o of e.keys())await e.removeEntry(o,{recursive:!0});throw t}finally{this.localPrefs.removeItem(i)}try{indexedDB.deleteDatabase("fileSystem"),this.fsAccessLib.support.adapter.cache&&await(globalThis.caches?.delete("sandboxed-fs"))}catch(t){console.warn(t)}return console.info("Migration done."),!0}async migrateDir(e,t,i){var r;for(r of await E.FileSystemUtil.getDirContents(e))try{if("directory"===r.kind){var s=await t.getDirectoryHandle(r.name,{create:!0});await this.migrateDir(r,s,i)}else{var n=r.name.replace(/\u200f/g,"");i(this.strings.get("TS:storage_migrating_file",t.name+"/"+r.name));let e=await t.getFileHandle(n,{create:!0});var a=await e.createWritable();let s=await r.getFile();await s.stream().pipeTo(a)}}catch(e){if("QuotaExceededError"===e.name)throw new x.StorageQuotaError({cause:e});throw new Error(`Failed migrating "${r.name}"`,{cause:e})}}async loadResources(e,t,i){let r;if(s.Engine.initGameResSource(t.source),t.isCdn()){var o=t.getCdnBaseUrl();let i=new n.ResourceLoader(o);var l=await i.loadJson("manifest.json");if(2!==l.version)throw new Error("Unknown manifest version "+l.version);if("mix"!==l.format)throw new Error("Unsupported CDN resource format "+l.format);e=e||new b.RealFileSystem,r=new w.CdnResourceLoader(o,l,await s.Engine.getCacheDir())}else{if(!e)throw new h.NoStorageError("No available storage adapters");console.info("Checking integrity of mix files..."),await this.checkMixesIntegrity(e.getRootDirectory()),console.info("Mixes are valid.")}const c=a.AppLogger.get("vfs");c.info("Initializing virtual filesystem...");let u=await s.Engine.initVfs(e,c);return await u.loadStandaloneFiles({exclude:["keyboard.ini","theme.ini"].map((e=>s.Engine.getFileNameVariant(e)))}),await u.loadExtraMixFiles(s.Engine.getActiveEngine()),await this.loadCustomMix(u),await this.loadMixes(t,r,u,i),await s.Engine.loadMapList(),await this.initUiCssVariables(this.rootEl),r}async checkMixesIntegrity(e){let t=new Map([["ra2.mix",["E7BA3BE","5DC70844"]],["multi.mix",["984EFDB6","3CDB648F"]]]);for(var[i,r]of t.entries()){let s,n;try{s=await e.getRawFile(i,!0),n=await s.arrayBuffer()}catch(t){if(t instanceof O.FileNotFoundError)throw new c.FileNotFoundError(i);if(t instanceof DOMException)throw new A.IOError(`Failed to read file (${t.name})`,{cause:t});throw t}let a=u.Crc32.calculateCrc(new Uint8Array(n));if(!r.includes(a.toString(16).toUpperCase()))throw new l.ChecksumError(`Checksum mismatch for "${i}" (size: ${s.size}). Checksum "${a}" doesn't match known values`,i)}}async loadCustomMix(e){let t=new n.ResourceLoader(this.appResPath);var s=await t.loadBinary("ra2cd.mix?v="+this.appVersion);s=new r.MixFile(new i.DataStream(s));e.addArchive(s,"ra2cd.mix")}async loadMixes(e,t,n,a){if(e.isCdn()){var o=e.getCdnBaseUrl();a(this.strings.get("TS:Downloading"),o+s.Engine.rfsSettings.splashImgFileName);var l;o=[S.ResourceType.Ini,S.ResourceType.Ui,S.ResourceType.Strings];let u=await t.loadResources(o,void 0,(e=>{a(this.strings.get("TS:DownloadingPg",e))}));for(l of(a(this.strings.get("GUI:LoadingEx")),o)){var c=t.getResourceFileName(l),h=new r.MixFile(new i.DataStream(u.pop(l)));n.addArchive(h,c)}}else if(await n.loadImplicitMixFiles(s.Engine.getActiveEngine()),o=await s.Engine.getCacheDir())try{await w.CdnResourceLoader.clearCache(o)}catch(e){if(!(e instanceof x.StorageQuotaError))throw e}}async initUiCssVariables(e){let t,i=await this.convertImagesToPng(s.Engine.vfs,[["pudlgbgn.shp","dialog.pal"],["mnbttn.shp","mainbttn.pal"],["cue_i.pcx"],["cce_i.pcx"],["cce_il.pcx"],["cce_ir.pcx"]]);i.set("menulogo.png",s.Engine.vfs.openFile("menulogo.png").asFile("image/png")),i.set("icons24.pcx",await this.generateIconSprite(s.Engine.vfs));var r,n={"--res-menu-logo":"menulogo.png","--res-icons-24":"icons24.pcx","--res-dlg-bgn":"pudlgbgn.shp","--res-mnbttn":"mnbttn.shp","--res-cue-i":"cue_i.pcx","--res-cce-i":"cce_i.pcx","--res-cce-il":"cce_il.pcx","--res-cce-ir":"cce_ir.pcx"};for(r of(t={},Object.keys(n))){var a=i.get(n[r]);a?(a=URL.createObjectURL(a),t[r]=`url("${a}")`):console.warn(`Image "${n[r]}" not found in browser FS`)}Object.keys(t).forEach((i=>{e.style.setProperty(i,t[i])}))}async loadSplashScreenBackground(e,t,i){var r=s.Engine.rfsSettings.splashImgFileName;if(i.isCdn())return i.getCdnBaseUrl()+r;{let s;if(t)try{s=await t.getRawFile(r,!1,"image/png")}catch(i){i instanceof O.FileNotFoundError||console.warn("Failed to load splash image",i)}if(e&&!s)try{s=await e.getRawFile(r,!1,"image/png")}catch(i){console.warn("Failed to load splash image",i)}return s}}async getBrowserFsHandle(e){let t=[];var i;for("fallback"!==e&&this.fsAccessLib.support.adapter.native&&t.push({name:"native",module:void 0}),"native"!==e&&(t.push({name:"indexeddb",module:this.fsAccessLib.adapters.indexeddb}),this.fsAccessLib.support.adapter.cache&&t.push({name:"cache",module:this.fsAccessLib.adapters.cache}));i=t.shift();)try{console.info(`Loading storage adapter "${i.name}"...`);let t=await this.fsAccessLib.getOriginPrivateDirectory(i.module);try{let e=await t.getFileHandle("browsercheck",{create:!0});if("function"!=typeof e.createWritable)throw new Error("createWritable not supported");(await e.getFile()).name!==e.name&&E.FileSystemUtil.polyfillGetFile()}catch(e){if("NotFoundError"===e.name&&"indexeddb"===i.name&&await new Promise((()=>{indexedDB.deleteDatabase("fileSystem"),this.localPrefs.removeItem(C.StorageKey.GameRes),location.reload()})),"QuotaExceededError"!==e.name)throw e}finally{try{await t.removeEntry("browsercheck")}catch(e){}}return console.info(`Storage adapter "${i.name}" loaded successfully.`),t}catch(e){console.warn("Couldn't load FS adapter "+i.name,[e])}throw new h.NoStorageError("No available FS adapters.")}async convertImagesToPng(e,t){let i=new Map;for(var[r,s]of t){let t;if(r.endsWith(".shp")){var n=new g.ShpFile(e.openFile(r));if(!s)throw new Error(`No palette specified for image "${r}"`);s=new d.Palette(e.openFile(s)),t=await m.ImageUtils.convertShpToPng(n,s)}else{if(!r.endsWith(".pcx")){console.warn(`Unknown image type "${r}"`);continue}{let i=new p.PcxFile(e.openFile(r));t=await i.toPngBlob()}}i.set(r,t)}return i}async generateIconSprite(e){let t=["wouref.pcx","wodref.pcx","wouact.pcx","wodact.pcx","dnarrowr.pcx","dnarrowp.pcx","uparrowr.pcx","uparrowp.pcx","sbgript.pcx","sbgripm.pcx","sbgripb.pcx","trakgrip.pcx"];var i=t.map((t=>new p.PcxFile(e.openFile(t))));let r=new f.RgbaBitmap(24*t.length,24);for(let e=0;e<i.length;e++){var s=new f.RgbaBitmap(i[e].width,i[e].height,i[e].data);r.drawRgbaImage(s,24*e,0)}var n=y.CanvasUtils.canvasFromRgbaImageData(r.data,r.width,r.height);return await y.CanvasUtils.canvasToBlob(n)}})}}})),System.register("gui/replay/ReplayMeta",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/replay/ReplayStorage",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/replay/ReplayStorageError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("ReplayStorageError",i)}}})),System.register("gui/replay/ReplayStorageFileSystem",["data/vfs/VirtualFile","data/DataStream","data/vfs/StorageQuotaError","network/gamestate/Replay","gui/replay/ReplayStorageError"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("ReplayStorageFileSystem",o=class e{constructor(e,t){this.dir=e,this.sentry=t}async getManifest(t=!1){if(t)return await this.rebuildManifest();if(!await this.dir.containsEntry(e.manifestFileName))return[];let i=(await this.dir.openFile(e.manifestFileName)).readAsString("utf-8");if(!i.length)return[];try{return JSON.parse(i)}catch(t){return console.error("Replay manifest is corrupt",t),this.sentry?.captureException(t,(t=>(t.addAttachment({filename:e.manifestFileName,data:i}),t))),await this.deleteManifest(),await this.rebuildManifest()}}async saveManifest(t){let n=new r.DataStream;n.writeString(JSON.stringify(t),"utf-8");var o=new i.VirtualFile(n,e.manifestFileName);try{await this.dir.writeFile(o)}catch(t){if(t instanceof s.StorageQuotaError)throw t;throw new a.ReplayStorageError(`Failed to save manifest (${t.message})`,{cause:t})}}async deleteManifest(){await this.dir.deleteFile(e.manifestFileName)}async rebuildManifest(){var t,i,r,a=await this.getManifest();let o=0;for await(t of this.dir.getEntries())t.endsWith(n.Replay.extension)&&o++;if(o===a.length)return a;console.info("Rebuilding replay index...");let l=new Map;for await(i of this.dir.getRawFiles())i.name.endsWith(n.Replay.extension)&&l.set(i.name,i);let c=[];for(r of a){var h=this.getReplayFileName(r);l.has(h)&&(c.push(r),l.delete(h))}if(0<a.length-c.length&&console.info(`Removed ${a.length-c.length} orphaned entries from index`),l.size){for(var u of l.values()){var d=u.lastModified;c.unshift({id:THREE.Math.generateUUID(),name:u.name.replace(e.unsavedReplayPrefix,"").replace(n.Replay.extension,""),keep:!u.name.startsWith(e.unsavedReplayPrefix),timestamp:d})}c.sort(((e,t)=>e.timestamp===t.timestamp?e.name.localeCompare(t.name):t.timestamp-e.timestamp)),console.info(`Added ${l.size} new entries to replay index`)}try{await this.saveManifest(c)}catch(t){if(!(t instanceof s.StorageQuotaError))throw t;console.error("Failed to save rebuilt manifest because storage is full",t)}return console.info("Rebuild finished."),c}async deleteAllReplays(){for await(var e of this.dir.getEntries())e.endsWith(n.Replay.extension)&&await this.dir.deleteFile(e);await this.deleteManifest()}async getReplayData(e){var t=this.getReplayFileName(e);if(!await this.dir.containsEntry(t))throw new Error(`Replay file "${t}" not found.`);return await this.dir.getRawFile(t)}async hasReplayData(e){var t=this.getReplayFileName(e);return await this.dir.containsEntry(t)}async saveReplayData(e,t){let n=new r.DataStream;n.writeString(t,"utf-8");var o=this.getReplayFileName(e),l=new i.VirtualFile(n,o);try{await this.dir.writeFile(l)}catch(e){if(e instanceof s.StorageQuotaError)throw e;if(e instanceof TypeError)throw new a.ReplayStorageError(`Failed to save replay file "${o}" (${e.message})`,{cause:e});throw new a.ReplayStorageError(`Failed to save replay file (${e.message})`,{cause:e})}}async deleteReplayData(e){await this.dir.deleteFile(this.getReplayFileName(e))}getReplayFileName(t){return(t.keep?"":e.unsavedReplayPrefix)+t.name+n.Replay.extension}}),o.manifestFileName="_index.json",o.unsavedReplayPrefix="Unsaved_"}}})),System.register("gui/replay/ReplayStorageMigration",["network/gamestate/Replay","gui/replay/ReplayStorageFileSystem"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ReplayStorageMigration",s=class e{constructor(e,t,i,r,s){this.splashScreen=e,this.strings=t,this.replayDir=i,this.localPrefs=r,this.storageFileSystem=s}async migrate(){4!==Number(this.localPrefs.getItem(e.migratedMarker)||0)&&(console.info("Running replay storage migrations..."),await this.runMigrationTo4(),this.localPrefs.setItem(e.migratedMarker,"4"),console.info("Migrations finished."))}async runMigrationTo4(){for(var e of(this.localPrefs.removeItem("_r_replayList"),this.localPrefs.listItems()))e.startsWith("_r_replay_")&&this.localPrefs.removeItem(e);let t=this.replayDir;var s="replays.json";if(await t.containsEntry(s))if(await t.containsEntry(r.ReplayStorageFileSystem.manifestFileName))await t.deleteFile(s);else{var n=(await t.openFile(s)).readAsString("utf-8");let r=[];try{r=JSON.parse(n)}catch(e){}if(r.length){this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",0));let n=[],d=new Set;for await(var a of t.getEntries())a.endsWith(i.Replay.extension)&&d.add(a);let g=new Map,p=new Set;for(var o of r){var l="replay_"+o.id+i.Replay.extension;if(d.has(l)){let e={id:THREE.Math.generateUUID(),name:i.Replay.sanitizeFileName(o.name),keep:o.keep,timestamp:o.timestamp};n.push(e);let t=this.storageFileSystem.getReplayFileName(e),r=1;for(;p.has(t.toLowerCase());)t=t.replace(i.Replay.extension,""),1<r&&(t=t.replace(/ \(\d+\)$/,"")),t+=` (${++r})`+i.Replay.extension;1<r&&(e.name+=` (${r})`),g.set(l,t),p.add(t.toLowerCase())}}await t.deleteFile(s);try{let e=0;var c,h,u=g.size;for([c,h]of g){let i=await t.openFile(c);i.filename=h,await t.writeFile(i),await t.deleteFile(c),this.splashScreen.setLoadingText(this.strings.get("ts:replay_storage_migrating",Math.floor(++e/u*100)))}await this.storageFileSystem.saveManifest(n)}catch(e){console.error(e)}}else await t.deleteFile(s)}}}),s.migratedMarker="_r_replays_migrated"}}})),System.register("engine/sound/MusicSpecs",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MusicSpecs",class{constructor(e){this.ini=e,this.specs=new Map,this.parse()}parse(){let e=this.ini.getSection("Themes");if(e){for(var t of e.entries.values())if(t){let e=this.ini.getSection(t);var i;e?(i={name:e.getString("Name"),sound:e.getString("Sound"),normal:e.getBool("Normal",!0),repeat:e.getBool("Repeat")},this.specs.set(t,i)):console.warn(`Music section [${t}] not found. Skipping.`)}}else console.warn("[Themes] section missing. Music will not be played.")}getSpec(e){return this.specs.get(e)}getAll(){return[...this.specs.values()]}})}}})),System.register("engine/sound/Music",["engine/sound/ChannelType","util/math"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){var t;(t=s=s||{})[t.Normal=0]="Normal",t[t.NormalShuffle=1]="NormalShuffle",t.Intro="INTRO",t.Score="SCORE",t.Loading="LOADING",t.Credits="CREDITS",t.Options="RA2Options",e("MusicType",s),e("Music",class{constructor(e,t,i){this.audioSystem=e,this.audioFiles=t,this.musicSpecs=i,this.playlist=[],this.currentPlaylistIdx=-1,this.shuffle=!1,this.repeat=!1}unserializeOptions(e){var[t,i,r]=e.split(",");this.shuffle=Boolean(Number(t)),this.repeat=Boolean(Number(i)),this.initialRepeatName=r}serializeOptions(){return[Number(this.shuffle),Number(this.repeat),this.repeat&&-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx].name:void 0].join(",")}getShuffleMode(){return this.shuffle}getRepeatMode(){return this.repeat}getPlaylist(){return this.buildPlaylist(!1)}getCurrentPlaylistItem(){if(-1!==this.currentPlaylistIdx)return this.playlist[this.currentPlaylistIdx]}dispose(){this.stopPlaying()}getMusicSpec(e){var t=this.musicSpecs.getSpec(e);if(t)return t;console.warn(`Music "${e}" is not defined`)}async play(e){var t,i;this.currentMusicType!==e&&(e===s.Normal||e===s.NormalShuffle?(t=this.shuffle||e===s.NormalShuffle,this.playlist=this.buildPlaylist(t),this.currentPlaylistIdx=0,!this.initialRepeatName||-1!==(i=this.playlist.findIndex((e=>e.name===this.initialRepeatName)))&&(this.currentPlaylistIdx=i),await this.playSpec(this.playlist[this.currentPlaylistIdx],(()=>this.advancePlaylist()))&&(this.currentMusicType=e)):(i=this.getMusicSpec(e))?await this.playSpec(i)&&(this.currentMusicType=e):console.warn(`No music spec found for type "${e}"`))}stopPlaying(){this.playbackHandle&&(this.playbackHandle.stop(),this.playbackHandle=void 0),this.currentMusicType=void 0}setShuffleMode(e){if(e!==this.shuffle){this.shuffle=e;let t=-1!==this.currentPlaylistIdx?this.playlist[this.currentPlaylistIdx]:void 0;this.playlist=this.buildPlaylist(this.shuffle),this.currentPlaylistIdx=t?this.playlist.findIndex((e=>e===t)):-1}}setRepeatMode(e){this.repeat=e}async playSpec(e,t){var r=i.ChannelType.Music;this.playbackHandle&&(this.playbackHandle.stop(),this.playbackHandle=void 0);var s=await this.getMp3File(e.sound);if(s)return this.playbackHandle=await this.audioSystem.playMp3File(s,r,1,0,e.repeat,t),this.playbackHandle}async getMp3File(e){var t=e.toLowerCase()+".mp3";let i;try{i=await this.audioFiles.get(t)}catch(e){return void console.error("Failed to fetch audio file",e)}if(i)return i;console.warn(`Audio file "${t}" not found.`)}buildPlaylist(e){let t=this.musicSpecs.getAll().filter((e=>e.normal));return e&&(t=this.shufflePlaylist(t)),t}shufflePlaylist(e){let t=[];for(e=[...e];e.length;)t.push(...e.splice(r.getRandomInt(0,e.length-1),1));return t}async advancePlaylist(){this.currentPlaylistIdx=this.repeat?this.currentPlaylistIdx:(this.currentPlaylistIdx+1)%this.playlist.length,await this.playSpec(this.playlist[this.currentPlaylistIdx],(()=>this.advancePlaylist()))}async selectPlaylistItem(e){var t=this.playlist?.findIndex((t=>t===e));-1!==t&&(this.currentPlaylistIdx=t,this.stopPlaying(),await this.playSpec(this.playlist[this.currentPlaylistIdx],(()=>this.advancePlaylist())))}})}}})),System.register("gui/screen/Screen",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/Controller",["util/event"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Controller",class{constructor(){this.screens=new Map,this.screenStack=[],this._onScreenChange=new i.EventDispatcher}get onScreenChange(){return this._onScreenChange.asEvent()}addScreen(e,t){this.screens.set(e,t),t.setController(this)}hasScreen(e){return this.screens.has(e)}async leaveCurrentScreen(){await this.popScreen()}async goToScreenBlocking(e,t){for(;this.screenStack.length;)await this.leaveCurrentScreen();await this.pushScreen(e,t)}goToScreen(e,t){this.goToScreenBlocking(e,t)}async pushScreen(e,t){let i=this.screens.get(e);if(!i)throw new Error("Invalid screen type "+e);this.screenStack.length&&await(this.screenStack[this.screenStack.length-1].onStack?.()),this.screenStack.push(i),this._onScreenChange.dispatch(this,e),i.onEnter(t)}async popScreen(e){this.screenStack.length&&(await this.screenStack.pop().onLeave(),this._onScreenChange.dispatch(this,void 0)),this.screenStack.length&&this.screenStack[this.screenStack.length-1].onUnstack?.(e)}rerenderCurrentScreen(){this.screenStack.length&&this.screenStack[this.screenStack.length-1].onViewportChange?.()}getCurrentScreen(){return this.screenStack.length?this.screenStack[this.screenStack.length-1]:void 0}destroy(){for(var e of this.screens.values())e.setController(void 0);this.screens.clear(),this.screenStack.length=0}})}}})),System.register("gui/screen/ScreenType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.MainMenuRoot=0]="MainMenuRoot",t[t.Game=1]="Game",t[t.Replay=2]="Replay",e("ScreenType",i)}}})),System.register("data/zip/ZipUtils",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ZipUtils",class{static createByteArray(e){var t=e.reduce(((e,t)=>e+(t.size||t.data.length)),0);const i=new Uint8Array(t),r=new DataView(i.buffer);let s=0;return e.forEach((e=>{if(void 0!==e.data.length)i.set(e.data,s),s+=e.data.length;else{switch(e.size){case 1:r.setInt8(s,parseInt(e.data));break;case 2:r.setInt16(s,parseInt(e.data),!0);break;case 4:r.setInt32(s,parseInt(e.data),!0);break;case 8:r.setBigInt64(s,BigInt(e.data),!0);break;default:throw new Error("createByteArray: No handler defined for data size "+e.size+" of entry data "+JSON.stringify(e.data))}s+=e.size}})),i}static getTimeStruct(e){return(e.getHours()<<6|e.getMinutes())<<5|e.getSeconds()/2}static getDateStruct(e){return(e.getFullYear()-1980<<4|e.getMonth()+1)<<5|e.getDate()}})}}})),System.register("data/zip/Zip",["data/Crc32","data/zip/ZipUtils"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("Zip",class{constructor(e=!1){this.zip64=e,console.info("Started zip with zip64: "+this.zip64),this.fileRecord=[],this.finished=!1,this.byteCounterBig=BigInt(0),this.outputStream=new ReadableStream({start:e=>{console.info("OutputStream has started!"),this.outputController=e},cancel:()=>{console.info("OutputStream has been canceled!")}})}enqueue(e){this.outputController.enqueue(e)}close(){this.outputController.close()}getZip64ExtraField(e,t){return r.ZipUtils.createByteArray([{data:1,size:2},{data:28,size:2},{data:e,size:8},{data:e,size:8},{data:t,size:8},{data:0,size:4}])}isWritingFile(){return 0<this.fileRecord.length&&!1===this.fileRecord[this.fileRecord.length-1].done}startFile(e,t){if(this.isWritingFile()||this.finished)throw new Error("Tried adding file while adding other file or while zip has finished");console.info("Start file: "+e);var s=new Date(t);this.fileRecord=[...this.fileRecord,{name:e,sizeBig:BigInt(0),crc:new i.Crc32,done:!1,date:s,headerOffsetBig:this.byteCounterBig}];var n=(new TextEncoder).encode(e);n=r.ZipUtils.createByteArray([{data:67324752,size:4},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:r.ZipUtils.getTimeStruct(s),size:2},{data:r.ZipUtils.getDateStruct(s),size:2},{data:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:this.zip64?4294967295:0,size:4},{data:n.length,size:2},{data:this.zip64?32:0,size:2},{data:n},{data:this.zip64?this.getZip64ExtraField(BigInt(0),this.byteCounterBig):[]}]);this.enqueue(n),this.byteCounterBig+=BigInt(n.length)}appendData(e){if(!this.isWritingFile()||this.finished)throw new Error("Tried to append file data, but there is no open file!");this.enqueue(e),this.byteCounterBig+=BigInt(e.length),this.fileRecord[this.fileRecord.length-1].crc.append(e),this.fileRecord[this.fileRecord.length-1].sizeBig+=BigInt(e.length)}endFile(){if(!this.isWritingFile()||this.finished)throw new Error("Tried to end file, but there is no open file!");{const t=this.fileRecord[this.fileRecord.length-1];console.info("End file: "+t.name);var e=r.ZipUtils.createByteArray([{data:t.crc.get(),size:4},{data:t.sizeBig,size:this.zip64?8:4},{data:t.sizeBig,size:this.zip64?8:4}]);this.enqueue(e),this.byteCounterBig+=BigInt(e.length),this.fileRecord[this.fileRecord.length-1].done=!0}}finish(){if(this.isWritingFile()||this.finished)throw new Error("Empty zip, or there is still a file open");{console.info("Finishing zip");let s=BigInt(0);var e,t,i=this.byteCounterBig;this.fileRecord.forEach((e=>{const{date:t,crc:i,sizeBig:n,name:a,headerOffsetBig:o}=e;var l=(new TextEncoder).encode(a);l=r.ZipUtils.createByteArray([{data:33639248,size:4},{data:45,size:2},{data:45,size:2},{data:2056,size:2},{data:0,size:2},{data:r.ZipUtils.getTimeStruct(t),size:2},{data:r.ZipUtils.getDateStruct(t),size:2},{data:i.get(),size:4},{data:this.zip64?4294967295:n,size:4},{data:this.zip64?4294967295:n,size:4},{data:l.length,size:2},{data:this.zip64?32:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:2},{data:0,size:4},{data:this.zip64?4294967295:o,size:4},{data:l},{data:this.zip64?this.getZip64ExtraField(n,o):[]}]);this.enqueue(l),this.byteCounterBig+=BigInt(l.length),s+=BigInt(l.length)})),this.zip64&&(t=this.byteCounterBig,e=r.ZipUtils.createByteArray([{data:101075792,size:4},{data:44,size:8},{data:45,size:2},{data:45,size:2},{data:0,size:4},{data:0,size:4},{data:this.fileRecord.length,size:8},{data:this.fileRecord.length,size:8},{data:s,size:8},{data:i,size:8}]),this.enqueue(e),this.byteCounterBig+=BigInt(e.length),t=r.ZipUtils.createByteArray([{data:117853008,size:4},{data:0,size:4},{data:t,size:8},{data:1,size:4}]),this.enqueue(t),this.byteCounterBig+=BigInt(t.length)),i=r.ZipUtils.createByteArray([{data:101010256,size:4},{data:0,size:2},{data:0,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?65535:this.fileRecord.length,size:2},{data:this.zip64?4294967295:s,size:4},{data:this.zip64?4294967295:i,size:4},{data:0,size:2}]),this.enqueue(i),this.close(),this.byteCounterBig+=BigInt(i.length),this.finished=!0,console.info(`Done writing zip file. Wrote ${this.fileRecord.length} files and a total of ${this.byteCounterBig} bytes.`)}}})}}})),System.register("gui/component/PromptDialog",["react","gui/component/Dialog"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("PromptDialog",(({viewport:e,promptText:t,submitLabel:s,cancelLabel:n,inputProps:a,onSubmit:o,onDismiss:l})=>{let c=i.useRef(null),[h,u]=i.useState(!1);i.useEffect((()=>{setTimeout((()=>{c.current?.focus()}),50)}),[]);var d=e=>{e&&e.preventDefault(),u(!0),o(c.current.value)};return i.default.createElement(r.Dialog,{className:"prompt-box",hidden:h,viewport:e,zIndex:100,buttons:[{label:s,onClick:d},{label:n,onClick:()=>{u(!0),l?.()}}]},i.default.createElement("form",{onSubmit:d,autoComplete:"off"},i.default.createElement("div",{className:"field"},i.default.createElement("label",null,t.split(/\r?\n/).map(((e,t)=>i.default.createElement(i.default.Fragment,{key:t},t?i.default.createElement("br",null):null,e)))),i.default.createElement("input",{name:"promptvalue",type:"text",autoComplete:"off","data-lpignore":"true",ref:c,...a})),i.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))}))}}})),System.register("gui/component/MessageBoxApi",["react","gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Dialog","gui/component/PromptDialog"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("MessageBoxApi",class{constructor(e,t,i){this.viewport=e,this.uiScene=t,this.jsxRenderer=i,this.disposables=new n.CompositeDisposable}show(e,t,i){this.destroy();let[n]=this.jsxRenderer.render(r.jsx(s.HtmlView,{innerRef:e=>this.component=e,component:a.Dialog,props:{children:"string"!=typeof e?e:this.splitNewLines(e),viewport:this.viewport,zIndex:101,buttons:"string"==typeof t?[{label:t,onClick:()=>{this.disposables.dispose(),i?.()}}]:(t??[]).map((e=>({label:e.label,onClick:()=>{this.disposables.dispose(),e.onClick?.()}})))}}));this.uiScene.add(n),this.disposables.add(n,(()=>this.uiScene.remove(n)),(()=>this.component=void 0))}splitNewLines(e){return e.split(/\n/g).map(((e,t)=>t?i.createElement(i.Fragment,{key:t},i.createElement("br",null),e):e))}async confirm(e,t,i){return await new Promise((r=>{this.show(e,[{label:t,onClick:()=>r(!0)},{label:i,onClick:()=>r(!1)}])}))}async alert(e,t){await new Promise((i=>this.show(e,t,i)))}async prompt(e,t,i,n){return this.destroy(),await new Promise((a=>{let[l]=this.jsxRenderer.render(r.jsx(s.HtmlView,{innerRef:e=>this.component=e,component:o.PromptDialog,props:{promptText:e,submitLabel:t,cancelLabel:i,inputProps:n,onSubmit:e=>{a(e),l.destroy()},onDismiss:()=>{a(void 0),l.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(l),this.disposables.add(l,(()=>this.uiScene.remove(l)),(()=>this.component=void 0))}))}updateViewport(e){this.viewport=e,this.component&&this.component.applyOptions((t=>t.viewport=e))}updateText(e){this.component&&this.component.applyOptions((t=>{t.promptText?t.promptText=e:t.children="string"!=typeof e?e:this.splitNewLines(e)}))}destroy(){this.disposables.dispose()}})}}})),System.register("RouteHelper",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){e("RouteHelper",i=class{}),i.modQueryStringName="mod"}}})),System.register("gui/screen/mainMenu/modSel/ModMeta",["gui/screen/mainMenu/modSel/ModManager"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ModMeta",class e{constructor(){this.supported=!1,this.manualDownload=!1}fromIniFile(e){var t=e.getSection("General");if(!t)throw new Error("Mod meta missing [General] section");return this.fromIniSection(t),this}fromIniSection(e){let t=e.getString("ID");var r=e.getString("Name");if(!t)throw new Error("Mod meta missing ID");if(!t.match(i.ModManager.modIdRegex))throw new Error(`Mod meta has invalid ID "${t}". ID must contain only alphanumeric characters, dash (-) or underscore (_)`);if(!r)throw new Error("Mod meta missing Name");this.id=t,this.name=r,this.supported=!0,this.description=e.getString("Description")||void 0,(r=e.get("Author"))&&(this.authors=Array.isArray(r)?r:[r]);let s=e.getString("Website");return s&&(s.match(/^https?:\/\//)?this.website=s:console.warn(`Invalid mod meta website "${s}"`)),this.version=e.getString("Version")||void 0,this.download=e.getString("Download")||void 0,this.downloadSize=e.getNumber("DownloadSize")||void 0,this.manualDownload=e.getBool("ManualDownload"),this}clone(){let t=new e;return t.id=this.id,t.name=this.name,t.supported=this.supported,t.description=this.description,t.authors=this.authors?.slice(),t.website=this.website,t.version=this.version,t.download=this.download,t.downloadSize=this.downloadSize,t.manualDownload=this.manualDownload,t}})}}})),System.register("gui/screen/mainMenu/modSel/ModStatus",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.NotInstalled=0]="NotInstalled",t[t.Installed=1]="Installed",t[t.UpdateAvailable=2]="UpdateAvailable",e("ModStatus",i)}}})),System.register("gui/screen/mainMenu/modSel/Mod",["gui/screen/mainMenu/modSel/ModStatus"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Mod",class{constructor(e,t){if(e)t&&t.version!==e.version?(this.status=i.ModStatus.UpdateAvailable,this.meta=e.clone(),this.meta.download=t.download,this.meta.downloadSize=t.downloadSize,this.meta.manualDownload=t.manualDownload,this.latestVersion=t.version):(this.status=i.ModStatus.Installed,this.meta=e,this.latestVersion=e.version);else{if(this.status=i.ModStatus.NotInstalled,!t)throw new Error("At least a local or remote meta must be specified");this.meta=t,this.latestVersion=t.version}}get id(){return this.meta.id}get name(){return this.meta.name}get supported(){return this.meta.supported}isInstalled(){return this.status!==i.ModStatus.NotInstalled}})}}})),System.register("gui/screen/mainMenu/modSel/ModManager",["data/IniFile","RouteHelper","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModMeta"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ModManager",a=class e{constructor(e,t,i){this.location=e,this.modDir=t,this.appResourceLoader=i}getModDir(){return this.modDir}async buildModList(e,t){let i=[];t=[...t??[]];for(let n of e){var r=t.findIndex((e=>e.id===n.id));r=-1!==r?t.splice(r,1)[0]:void 0;i.push(new s.Mod(n,r))}for(var n of t)i.push(new s.Mod(void 0,n));return i}async listRemote(){var t,r=await this.appResourceLoader.loadText(e.remoteListFileName);let s=new i.IniFile(r),a=s.getSection("General");if(!a)throw new Error(e.remoteListFileName+" is missing the [General] section");let o=[];for(t of a.entries.values()){var l=s.getSection(t);l?(l=(new n.ModMeta).fromIniSection(l),o.push(l)):console.warn(`Mod "${t}" has no INI section`)}return o}async listLocal(){let e=[];if(this.modDir)for await(var t of this.modDir.getEntries())t=await this.loadModMeta(t),e.push(t);return e.sort(((e,t)=>e.name.localeCompare(t.name))),e}async loadModMeta(t){let r=new n.ModMeta;r.id=t,r.name=t;try{let s=await this.modDir.getDirectory(t,!0),n=await s.containsEntry(e.modMetaFileName)?await s.getRawFile(e.modMetaFileName):void 0;if(n){try{r.fromIniFile(new i.IniFile(await n.text()))}catch(e){console.warn(`Couldn't parse meta file in mod folder "${t}"`),r.name=t}r.id=t}}catch(e){console.warn(e)}return r}async deleteModFiles(e){await(this.modDir?.containsEntry(e))&&await this.modDir.deleteDirectory(e,!0)}loadMod(e){let t=new URL(this.location.href);e?t.searchParams.set(r.RouteHelper.modQueryStringName,e):t.searchParams.delete(r.RouteHelper.modQueryStringName),this.location.href=t.href}}),a.remoteListFileName="mods.ini",a.modMetaFileName="modcd.ini",a.modIdRegex=/^[a-z0-9-_]+$/i}}})),System.register("util/CssLoader",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CssLoader",class{constructor(e){this.document=e}async load(e){return new Promise(((t,i)=>{let r=document.createElement("link");r.rel="stylesheet",r.type="text/css",r.href=e,"onload"in r&&(r.onload=()=>t()),"onerror"in r&&(r.onerror=()=>i(new Error(`Couldn't load CSS at "${e}"`))),this.document.head.appendChild(r),"onload"in r||t()}))}})}}})),System.register("gui/screen/options/component/StorageExplorer",["@puzzl/core/lib/regexp","data/vfs/RealFileSystemDir","data/zip/Zip","engine/Engine","gui/replay/ReplayStorageFileSystem","gui/screen/mainMenu/modSel/ModManager","network/gamestate/Replay","react","util/CssLoader","util/ScriptLoader","util/time"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e}],execute:function(){var t;g=e=>v.some((t=>"string"==typeof t?e.toLowerCase()===t.toLowerCase():t.test(e))),p=async(e,t)=>{let i=[];for await(var[r,s]of e.entries())i.push({id:r,name:r,type:"directory"===s.kind?"folder":"file",hash:r,attrs:"directory"!==s.kind||g(("/"!==t?t:"")+"/"+r)?void 0:{canmodify:!1},..."file"===s.kind?{size:(await s.getFile()).size}:{}});return i},m=async(e,t,i=!1)=>{let r=t;for(var s of e.slice(1))r=await r.getDirectoryHandle(s,{create:i});return r},f=["/keyboard.ini",/^\/(language|multi|ra2)\.mix$/i,"/"+n.Engine.rfsSettings.menuVideoFileName,"/"+n.Engine.rfsSettings.splashImgFileName,new RegExp(`^/${n.Engine.rfsSettings.musicDir}/([^/]+).mp3$`,"i"),new RegExp(`^/${n.Engine.rfsSettings.replayDir}/(([^/]+)${i.escape(l.Replay.extension)})|(${i.escape(a.ReplayStorageFileSystem.manifestFileName)})$`,"i"),new RegExp(`^/${n.Engine.rfsSettings.tauntsDir}/tau([^/]+).wav$`,"i"),new RegExp(`^/${n.Engine.rfsSettings.modDir}/[^/]+/`,"i"),new RegExp(`^/${n.Engine.rfsSettings.mapDir}/[^/]+.(${n.Engine.supportedMapTypes.join("|")})$`,"i")],y=["/keyboard.ini",/^\/[^/]+\.mix$/i,new RegExp(`^/${n.Engine.rfsSettings.musicDir}/`,"i"),new RegExp(`^/${n.Engine.rfsSettings.tauntsDir}/`,"i")],T=[/^\/([^/]+)\.mix$/i,"/"+n.Engine.rfsSettings.menuVideoFileName,"/"+n.Engine.rfsSettings.splashImgFileName,"/"+n.Engine.rfsSettings.musicDir,"/"+n.Engine.rfsSettings.tauntsDir,"/"+n.Engine.rfsSettings.replayDir+"/"+a.ReplayStorageFileSystem.manifestFileName],v=["/","/"+n.Engine.rfsSettings.replayDir,new RegExp(`^/${n.Engine.rfsSettings.modDir}(/.*)?`),new RegExp(`^/${n.Engine.rfsSettings.mapDir}(/.*)?`)],b=[n.Engine.rfsSettings.modDir],(t=S=S||{})[t.None=0]="None",t[t.OverwriteAll=1]="OverwriteAll",t[t.SkipAll=2]="SkipAll",e("StorageExplorer",(({messageBoxApi:e,storageDirHandle:t,startIn:i,strings:n,onFileSystemChange:a})=>{const l=c.useRef(null);return c.useEffect((()=>{let c,v,w=!1,C=S.None,E=0,x=!1;const O=async()=>{var e,t,i;c&&navigator.storage?.estimate&&(({usage:e,quota:t}=await navigator.storage.estimate()),e&&t&&(i=n.get("GUI:StorageUsed",c.GetDisplayFilesize(e),c.GetDisplayFilesize(t)),c.SetNamedStatusBarText("quota",t<=e?"<font color='red'>"+i+"</font>":i)))},A=async(e,i)=>{if(b.includes(i.GetPathIDs().pop())){let s=prompt(n.get("GUI:NewFolderPrompt"));if(s?.match(o.ModManager.modIdRegex)){try{let a=await m(i.GetPathIDs(),t);if(await new r.RealFileSystemDir(a).containsEntry(s))return void e(n.get("GUI:NewFolderExists"));s=(await a.getDirectoryHandle(s,{create:!0})).name}catch(t){return console.error(t),void e(!1)}e({type:"folder",name:s,id:s,hash:s})}else e(n.get("GUI:NewFolderInvalidName"))}else e(n.get("GUI:NewFolderNotAllowed"))},M=async(i,r,s)=>{let o=[],l=[];var h,u=s.length;for(h of s){let e=[...r.GetPathIDs(),h].join("/");(T.some((t=>"string"==typeof t?e.toLowerCase()===t.toLowerCase():t.test(e)))?o:l).push(e)}if(!l.length||await e.confirm(1===u?n.get("GUI:ConfirmDeleteFile"):n.get("GUI:ConfirmDeleteFiles",u),n.get("GUI:Yes"),n.get("GUI:No"))){if(o.length)for(var d of o)await e.confirm(n.get("GUI:ConfirmDeleteSystemFile",d),n.get("GUI:Yes"),n.get("GUI:No"))&&l.push(d);if(l.length){let e;try{for(var g of l){console.log(`Deleting "${g}"...`);var p=g.substring(0,g.lastIndexOf("/")).split("/");let e=await m(p,t);await e.removeEntry(g.split("/").pop(),{recursive:!0}),console.log(`Deleted "${g}".`)}}catch(i){console.error(i),e=i}i(!!e&&e.message),c?.RefreshFolders(!0),x||(x=!0,a())}else i(!1)}else i(!1)},R=async(i,s)=>{let o=s.folder.GetPathIDs().join("/")+s.fullPath,l=o.substring(0,o.lastIndexOf("/")).split("/"),h=!1;v&&(clearTimeout(v),v=void 0),E++;let u,d=!1;try{if(f.some((e=>"string"==typeof e?o.toLowerCase()===e.toLowerCase():e.test(o)))){for await(var g of(u=await m(l,t,!0),u.keys()))if(g.toLowerCase()===s.file.name.toLowerCase()){var p;C===S.None?(2===(p=await new Promise((t=>{e.show(n.get("GUI:ConfirmOverwriteFile",l.join("/")||"/",s.file.name),[{label:n.get("GUI:Yes"),onClick:()=>t(1)},{label:n.get("GUI:YesToAll"),onClick:()=>t(2)},{label:n.get("GUI:No"),onClick:()=>t(0)},{label:n.get("GUI:Cancel"),onClick:()=>t(-1)}])})))?C=S.OverwriteAll:-1===p&&(C=S.SkipAll),p<=0&&(d=!0)):C===S.SkipAll&&(d=!0);break}}else d=!0;if(d)console.log("File skipped: "+o);else{console.log("Uploading file: "+o),c?.SetNamedStatusBarText("message",n.get("GUI:Uploading",o));let e=s.file.name;y.some((e=>"string"==typeof e?o.toLowerCase()===e.toLowerCase():e.test(o)))&&(e=e.toLowerCase()),await new r.RealFileSystemDir(u).writeFile(s.file,e),h=!0,console.log("File uploaded: "+o)}}catch(i){console.error(i);var T="QuotaExceededError"===i.name?n.get("GUI:UploadFailedQuota"):n.get("GUI:UploadFailed");c?.SetNamedStatusBarText("message","<font color='red'>"+T+"</font>",1e4)}E--,E||(v=setTimeout((()=>{C=S.None,c?.SetNamedStatusBarText("message",n.get("GUI:UploadFinished"),2e3)}),1e3)),i(!1),c&&h&&(c.RefreshFolders(!0),await O(),x||(x=!0,a()))},P=(i,r,a,o)=>{1!==o.length||"file"!==o[0].type?(async()=>{let i=await SystemJS.import("file-system-access"),a=await i.showSaveFilePicker({suggestedName:"cdexport.zip"}),l=await m(r.GetPathIDs(),t),h=new s.Zip;const u=async(e,t,i)=>{for await(var r of e.values())"directory"===r.kind?await u(r,t+"/"+r.name,i):await i(await r.getFile(),t+"/"+r.name)};let g=new AbortController,p=c.CreateProgressTracker((()=>{try{g.abort()}catch(e){}}));p.queueditems=o.length,p.showbyterate=!0;const f=async(e,t)=>{h.startFile(t,e.lastModified);const i=e.stream().getReader();for(;;){var{done:r,value:s}=await i.read();if(r)break;h.appendData(s),await d.sleep(0)}h.endFile(),p.totalbytes+=e.size};var y=setTimeout((()=>{e.show(n.get("GUI:CreatingArchive"),n.get("GUI:Cancel"),(()=>{try{p.cancelcallback()}catch(e){console.error(e)}}))}),1e3);try{await Promise.all([(async()=>{for(var{id:e,type:t}of o){if("folder"===t){var i=await l.getDirectoryHandle(e);await u(i,e,(async(e,t)=>{await f(e,t)}))}else{let t=await l.getFileHandle(e);i=await t.getFile(),await f(i,e)}p.itemsdone++}h.finish()})(),(async()=>{var e=await a.createWritable();await h.outputStream.pipeTo(e,{signal:g.signal})})()]),console.log("ZIP file saved successfully."),c?.RemoveProgressTracker(p,n.get("GUI:DownloadFinished"))}catch(i){clearTimeout(y),"AbortError"!==i.name?(console.error(i),c?.RemoveProgressTracker(p,n.get("GUI:DownloadFailed")),await e.alert(n.get("GUI:DownloadFailed"),n.get("GUI:OK"))):c?.RemoveProgressTracker(p,n.get("GUI:DownloadAborted"))}finally{clearTimeout(y),e.destroy()}})().catch((e=>{"AbortError"!==e.name&&console.error(e)})):c.OpenSelectedItems()},I=(e,i)=>{(async()=>{let r=await m(e.GetPathIDs(),t),s=await r.getFileHandle(i.id);var n=await s.getFile();let a=await SystemJS.import("file-system-access"),o=await a.showSaveFilePicker({suggestedName:n.name}),l=await o.createWritable();try{await l.write(n),await l.close()}catch(r){throw await l.abort(),r}})().catch((e=>{"AbortError"!==e.name&&console.error(e)}))},k=(e,i)=>{(async()=>{var i=await m(e.GetPathIDs(),t);i=await p(i,e.GetPathIDs().join("/"));c?.IsDestroyed()||e.SetEntries(i)})().catch((e=>{console.error(e)}))};return(async()=>{e.show(n.get("GUI:LoadingEx"));try{if(await Promise.all([new u.ScriptLoader(document).load("lib/file-explorer/file-explorer.js"),new h.CssLoader(document).load("lib/file-explorer/file-explorer.css")]),w)return;let e=[["","/",{canmodify:g("/")}]];if(i){let r="";for(var t of i.split("/"))r+="/"+t,e.push([t,t,{canmodify:g(r)}])}c=new window.FileExplorer(l.current,{initpath:e,onrefresh:k,onopenfile:I,concurrentuploads:1,oninitupload:R,oninitdownload:P,onnewfolder:A,ondelete:M}),await O()}finally{e.destroy()}})().catch((e=>console.error(e))),()=>{w=!0,c?.Destroy(),c=void 0,v&&clearTimeout(v)}}),[]),c.default.createElement("div",{ref:l,className:"storage-explorer"})}))}}})),System.register("gui/screen/mainMenu/ScreenType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Home=0]="Home",t[t.Skirmish=1]="Skirmish",t[t.QuickGame=2]="QuickGame",t[t.CustomGame=3]="CustomGame",t[t.Login=4]="Login",t[t.NewAccount=5]="NewAccount",t[t.Lobby=6]="Lobby",t[t.MapSelection=7]="MapSelection",t[t.Ladder=8]="Ladder",t[t.LadderRules=9]="LadderRules",t[t.ReplaySelection=10]="ReplaySelection",t[t.ModSelection=11]="ModSelection",t[t.Score=12]="Score",t[t.InfoAndCredits=13]="InfoAndCredits",t[t.PatchNotes=14]="PatchNotes",t[t.Credits=15]="Credits",t[t.Options=16]="Options",t[t.OptionsSound=17]="OptionsSound",t[t.OptionsKeyboard=18]="OptionsKeyboard",t[t.OptionsStorage=19]="OptionsStorage",e("ScreenType",i)}}})),System.register("gui/screen/mainMenu/MainMenuController",["gui/screen/Controller","engine/sound/SoundKey","engine/sound/ChannelType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends i.Controller{constructor(e,t,i){super(),this.mainMenu=e,this.sound=t,this.music=i}async goToScreenBlocking(...e){var[t,i]=e;return super.goToScreenBlocking(t,i)}goToScreen(...e){var[t,i]=e;return super.goToScreen(t,i)}async pushScreen(...e){var[t,i]=e;this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.pushScreen(t,i),(t=this.screens.get(t)).title&&this.mainMenu.setSidebarTitle(t.title),void 0!==t.musicType&&await(this.music?.play(t.musicType))}async popScreen(e){this.setMainComponent(),this.mainMenu.setSidebarTitle(""),await super.popScreen(e);var t=this.getCurrentScreen();t?.title&&this.mainMenu.setSidebarTitle(t.title)}setSidebarButtons(e,t=!1){this.mainMenu.setButtons(e,t)}showSidebarButtons(){this.mainMenu.isSidebarCollapsed()&&(this.sound.play(r.SoundKey.GUIMoveInSound,s.ChannelType.Ui),this.mainMenu.showButtons())}setSidebarMpText(e){this.mainMenu.setSidebarMpText(e)}hideSidebarButtons(){if(!this.mainMenu.isSidebarCollapsed())return this.sound.play(r.SoundKey.GUIMoveOutSound,s.ChannelType.Ui),new Promise((e=>{let t=()=>{this.mainMenu.onSidebarToggle.unsubscribe(t),e()};this.mainMenu.onSidebarToggle.subscribe(t),this.mainMenu.hideButtons()}))}toggleSidebarPreview(e){this.mainMenu.toggleSidebarPreview(e)}setSidebarPreview(e){this.mainMenu.setSidebarPreview(e)}getSidebarPreviewSize(){return this.mainMenu.getSidebarPreviewSize()}toggleMainVideo(e){this.mainMenu.toggleVideo(e)}showVersion(e){this.mainMenu.showVersion(e)}hideVersion(){this.mainMenu.hideVersion()}setMainComponent(e){this.mainMenu.setContentComponent(e)}destroy(){this.setMainComponent(void 0),super.destroy()}},e("MainMenuController",n)}}})),System.register("gui/screen/mainMenu/MainMenuScreen",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MainMenuScreen",class{setController(e){this.controller=e}})}}})),System.register("gui/screen/options/StorageScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/StorageExplorer","gui/screen/mainMenu/MainMenuScreen"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends n.MainMenuScreen{constructor(e,t,i,r){super(),this.strings=e,this.jsxRenderer=t,this.messageBoxApi=i,this.rfs=r,this.title=this.strings.get("GUI:Storage")}onEnter(e){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[t]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.StorageExplorer,props:{strings:this.strings,messageBoxApi:this.messageBoxApi,storageDirHandle:this.rfs.getRootDirectoryHandle(),startIn:e?.startIn,onFileSystemChange:()=>{this.controller?.setSidebarButtons([{label:this.strings.get("GUI:ExitAndReload"),isBottom:!0,onClick:()=>{location.reload()}}])}}}));this.controller.setMainComponent(t)}async onLeave(){await this.controller.hideSidebarButtons()}},e("StorageScreen",a)}}})),System.register("gui/screen/mainMenu/customGame/component/viewmodel/gameBrowser",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/component/List",["react","classnames"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("List",(({children:e,className:t,title:s,innerRef:n,tooltip:a})=>i.default.createElement(i.default.Fragment,null,s&&i.default.createElement("div",{className:"list-title"},s),i.default.createElement("div",{ref:n,className:r.default("list",t),"data-r-tooltip":a},e)))),e("ListItem",(({children:e,selected:t,disabled:s,tooltip:n,className:a,innerRef:o,...l})=>i.default.createElement("div",{ref:o,className:r.default("list-item",{selected:t,disabled:s},a),"data-r-tooltip":n,...l},e))),e("ListHeader",(({children:e,tooltip:t,className:s,innerRef:n,...a})=>i.default.createElement("div",{ref:n,className:r.default("list-header",s),"data-r-tooltip":t,...a},e)))}}})),System.register("gui/component/ChannelOpIndicator",["react","gui/component/Image"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ChannelOpIndicator",(({operator:e})=>i.default.createElement("div",{className:"channel-op-indicator"},e?i.default.createElement(r.Image,{src:"woloper.pcx"}):null)))}}})),System.register("gui/component/ChannelUser",["classnames","gui/screen/mainMenu/lobby/component/RankIndicator","react","gui/component/ChannelOpIndicator"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ChannelUser",(({user:e,playerProfile:t,strings:a,onClick:o})=>{var l=t?.rank;let c=e.name;return e.operator&&(c+=" : "+a.get("TXT_OPER")),c+=void 0!==l?` : ${a.get("GUI:Rank")} `+l:" : "+a.get("TXT_UNRANKED"),s.default.createElement("div",{className:i.default("player",{operator:e.operator}),"data-r-tooltip":c,onClick:o},s.default.createElement(n.ChannelOpIndicator,{operator:e.operator}),s.default.createElement(r.RankIndicator,{playerProfile:t,strings:a}),e.name)}))}}})),System.register("gui/screen/mainMenu/customGame/component/GameBrowser",["react","gui/component/Chat","gui/component/List","gui/component/Image","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/ChannelUser","network/chat/ChatMessage"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("GameBrowser",(e=>{const[t,n]=i.useState(void 0);i.useEffect((()=>{t&&!e.games.find((e=>e.name===t.name))&&a(void 0)}),[e.games]);const a=t=>{n(t),e.onSelectGame(t)};let h=e.strings;return i.default.createElement("div",{className:"gamebrowser-wrapper"},i.default.createElement("div",{className:"gamebrowser-top"},i.default.createElement("div",{className:"games"},i.default.createElement("div",{className:"games-header"},i.default.createElement("button",{className:"icon-button refresh-button",onClick:e.onRefreshClick,"data-r-tooltip":h.get("STT:WOLLobbyRefreshChannels")}),i.default.createElement("span",{className:"games-label"},h.get("GUI:OpenGames"))),i.default.createElement(c,{games:e.games,selectedGame:t,mapList:e.mapList,onClickGame:a,onDoubleClickGame:t=>{a(t),e.onDoubleClickGame(t)},tooltip:h.get("STT:LobbyListGames"),strings:h,pings:e.pings,playerProfiles:e.playerProfiles}))),i.default.createElement("div",{className:"gamebrowser-bottom"},i.default.createElement(r.Chat,{strings:h,messages:e.messages,channels:e.channels??[],chatHistory:e.chatHistory,localUsername:e.localUsername,onSendMessage:e.onSendMessage,tooltips:{input:h.get("STT:LobbyEditInput"),output:h.get("STT:LobbyEditOutput"),button:h.get("STT:EmoteButton")}}),i.default.createElement(s.List,{className:"players-list",tooltip:h.get("STT:LobbyListUsers")},e.users.map((t=>{var r=e.playerProfiles.get(t.name);return i.default.createElement(o.ChannelUser,{key:t.name,user:t,playerProfile:r,strings:h,onClick:()=>{e.chatHistory.lastComposeTarget.value={type:l.ChatRecipientType.Whisper,name:t.name}}})})))))})),c=({games:e,selectedGame:t,onClickGame:r,onDoubleClickGame:n,tooltip:a,strings:o,pings:l,playerProfiles:c,mapList:u})=>i.default.createElement(i.default.Fragment,null,i.default.createElement(s.ListHeader,{className:"game game-list-header"},i.default.createElement("span",{className:"game-flags"},i.default.createElement("span",{className:"game-type"}),i.default.createElement("span",{className:"game-pass-locked"}),i.default.createElement("span",{className:"game-obs"})),i.default.createElement("span",{className:"game-map"},o.get("GUI:Map")),i.default.createElement("span",{className:"game-name"},o.get("GUI:RoomDesc")),i.default.createElement("span",{className:"game-players"},"👤"),i.default.createElement("span",{className:"game-host"},o.get("GUI:HostName")),i.default.createElement("span",{className:"game-ping"},o.get("GUI:Ping"))),i.default.createElement(s.List,{className:"games-list",tooltip:a},e.map(((e,s)=>{var a=e.hostPing??l.get(e.hostName)??void 0,d=c.get(e.hostName),g=d?.rank;let p=u.getByName(e.mapName);var m=p?.getFullMapTitle(o)||e.mapName;return i.default.createElement(h,{key:e.name,game:e,uiMapName:m,customMap:!p?.official,ping:a,hostProfile:d,tooltip:[...e.modName?[""+o.get("GUI:GameMod",e.modName)]:[],o.get("TXT_MAP",m),a?o.get("WOL:GamePing",a):o.get("TXT_UNKNOWN_PING"),...void 0!==g?[o.get("TXT_HOST_RANK")+" "+g]:[]].join(", "),selected:e.name===t?.name,strings:o,onClick:r,onDoubleClick:n})})))),h=({game:e,uiMapName:t,customMap:r,selected:o,tooltip:l,ping:c,hostProfile:h,strings:u,onClick:d,onDoubleClick:g})=>i.default.createElement(s.ListItem,{key:e.name,className:"game",selected:o,tooltip:l,onClick:()=>d(e),onDoubleClick:()=>g(e)},i.default.createElement("span",{className:"game-flags"},i.default.createElement("span",{className:"game-type",title:e.modName||!r?""+u.get("GUI:GameMod",e.modName||u.get("GUI:Official")):""+u.get("GUI:CustomMap")},e.modName||r?i.default.createElement(n.Image,{src:"settings.png"}):i.default.createElement(n.Image,{src:e.tournament?"woltrny.pcx":"gt18.pcx"})),i.default.createElement("span",{className:"game-pass-locked"},e.passLocked?i.default.createElement(n.Image,{src:"wolpriv.pcx"}):null),i.default.createElement("span",{className:"game-obs"},e.observable?i.default.createElement(n.Image,{src:"wolob.pcx"}):null)),i.default.createElement("span",{className:"game-map",title:t},t),i.default.createElement("span",{className:"game-name",title:e.description},e.description),i.default.createElement("span",{className:"game-players"},e.maxPlayers?e.humanPlayers+e.aiPlayers+"/"+(e.maxPlayers-(e.observable?1:0)):"?/?"),i.default.createElement("span",{className:"game-host"},e.hostName,void 0!==h&&i.default.createElement(a.RankIndicator,{playerProfile:h,strings:u})),i.default.createElement("span",{className:"game-ping"},c?i.default.createElement("meter",{value:c,max:300,low:100,high:250,optimum:0,title:c+"ms"}):null))}}})),System.register("gui/screen/mainMenu/lobby/component/PasswordBox",["react","gui/component/Dialog"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("PasswordBox",(({strings:e,viewport:t,onSubmit:s,onDismiss:n})=>{let a=i.useRef(null),[o,l]=i.useState(!1);i.useEffect((()=>{setTimeout((()=>{a.current?.focus()}),50)}),[]);var c=e=>{e&&e.preventDefault(),l(!0),s(a.current.value)};return i.default.createElement(r.Dialog,{className:"login-box password-box",hidden:o,viewport:t,zIndex:100,buttons:[{label:e.get("GUI:Ok"),onClick:c},{label:e.get("GUI:Cancel"),onClick:()=>{l(!0),n?.()}}]},i.default.createElement("form",{onSubmit:c,autoComplete:"off"},i.default.createElement("div",{className:"field"},i.default.createElement("label",null,e.get("GUI:Password")),i.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:a})),i.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))}))}}})),System.register("gui/screen/mainMenu/lobby/component/CreateGameBox",["react","gui/component/Dialog","network/WolConnection"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("CreateGameBox",(({strings:e,viewport:t,onSubmit:n,onDismiss:a})=>{let[o,l]=i.useState(!1),[c,h]=i.useState(""),u=i.useRef(null),d=i.useRef(null),[g,p]=i.useState(!1),m=i.useRef(null);return i.default.createElement(r.Dialog,{className:"login-box create-game-box",hidden:o,viewport:t,buttons:[{label:e.get("GUI:Ok"),onClick:()=>d.current?.click()},{label:e.get("GUI:Cancel"),onClick:()=>{l(!0),a?.()}}],zIndex:100},i.default.createElement("form",{onSubmit:e=>{e.preventDefault(),l(!0),n(c,g?u.current.value:"",m.current.checked)},autoComplete:"off"},i.default.createElement("div",{className:"field"},i.default.createElement("label",null,e.get("GUI:RoomDesc")),i.default.createElement("input",{name:"roomname",type:"text",value:c,maxLength:s.WolConnection.MAX_ROOM_DESC_LEN,onChange:e=>{h(e.target.value)}})),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,e.get("GUI:Password")),i.default.createElement("input",{name:"enablepass",type:"checkbox",checked:g,onChange:()=>{p(!g)}}),i.default.createElement("input",{name:"lobbypass",type:"password",autoComplete:"off","data-lpignore":"true",ref:u,disabled:!g,required:g})),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,e.get("GUI:Observe")),i.default.createElement("input",{type:"checkbox",name:"test",ref:m})),i.default.createElement("button",{type:"submit",ref:d,style:{visibility:"hidden"}})))}))}}})),System.register("ErrorHandler",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ErrorHandler",class{constructor(e,t){this.messageBoxApi=e,this.strings=t}handle(e,t,i){this.isErrorState||this.messageBoxApi.show(t,this.strings.get("GUI:Ok"),(()=>{this.isErrorState=!1,i()})),console.error("Handled error:",e),this.isErrorState=!0}})}}})),System.register("gui/screen/mainMenu/lobby/MapPreviewRenderer",["engine/gfx/CanvasUtils","gui/HtmlContainer","gui/UiObject","gui/screen/mainMenu/lobby/component/viewmodel/lobby","game/Coords","engine/IsoCoords"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=new Map([[n.LobbyType.Singleplayer,"STT:SkirmishMapThumbnail"],[n.LobbyType.MultiplayerHost,"STT:HostMapThumbnail"],[n.LobbyType.MultiplayerGuest,"STT:GuestMapThumbnail"]]),e("MapPreviewRenderer",class{constructor(e){this.strings=e}render(e,t,n){let a;try{a=e.decodePreviewImage()}catch(e){console.error("Failed to decode map preview data",e)}if(a){var{data:o,width:c,height:h}=a;let u=i.CanvasUtils.canvasFromRgbImageData(o,c,h),d=1;h=u.width<n.width/2||u.height<n.height/2?4:2;let g=document.createElement("canvas");g.width=h*u.width,g.height=h*u.height;let p=g.getContext("2d");p&&(d=h,p.scale(d,d),p.drawImage(u,0,0),u=g),this.drawStartLocations(u,e,n,d);let m=new r.HtmlContainer;return h=new s.UiObject(new THREE.Object3D,m),m.setSize("100%","100%"),m.render(),u.style.objectFit="contain",u.style.width="100%",u.style.height="100%",u.setAttribute("data-r-tooltip",this.strings.get(l.get(t))),m.getElement().appendChild(u),h}}drawStartLocations(e,t,r,s){var n=e.getContext("2d");if(n){o.IsoCoords.init({x:0,y:t.fullSize.width*a.Coords.getWorldTileSize()/2});var l,c,h=o.IsoCoords.worldToScreen(0,0),u=o.IsoCoords.screenToScreenTile(h.x,h.y),d=13*(h=e.width>e.height?e.width/r.width/s:e.height/r.height/s),g=2*h;for([l,c]of t.startingLocations.entries()){var p=c;p=o.IsoCoords.tileToScreen(p.x,p.y);let r=o.IsoCoords.screenToScreenTile(p.x,p.y);r.x+=u.x,r.y+=u.y;let a=this.dxyToCanvas(r.x,r.y,e,t.localSize);a.x/=s,a.y/=s,i.CanvasUtils.drawText(n,String(l+1),a.x-d/4,a.y-d/2,{fontSize:d,color:"yellow",outlineColor:"black",outlineWidth:g})}}}dxyToCanvas(e,t,i,r){var s=i.width/(2*r.width),n=i.height/r.height/2;return{x:(e-2*r.x)*s,y:(t-2*r.y)*n}}})}}})),System.register("gui/screen/mainMenu/lobby/PreferredHostOpts",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("PreferredHostOpts",class{constructor(){this.gameSpeed=6,this.credits=1e4,this.unitCount=10,this.shortGame=!0,this.superWeapons=!1,this.buildOffAlly=!0,this.mcvRepacks=!0,this.cratesAppear=!1,this.hostTeams=!1,this.slotsClosed=new Set}serialize(){return[this.gameSpeed,this.credits,this.unitCount,Number(this.shortGame),Number(this.superWeapons),Number(this.buildOffAlly),Number(this.mcvRepacks),Number(this.cratesAppear),[...this.slotsClosed].join(","),Number(this.hostTeams)].join(";")}unserialize(e){let[t,i,r,s,n,a,o,l,c,h]=e.split(";");return this.gameSpeed=Number(t),this.credits=Number(i),this.unitCount=Number(r),this.shortGame=Boolean(Number(s)),this.superWeapons=Boolean(Number(n)),this.buildOffAlly=Boolean(Number(a)),this.mcvRepacks=Boolean(Number(o)),this.cratesAppear=Boolean(Number(l)),this.hostTeams=Boolean(Number(h)),this.slotsClosed=new Set(c?c.split(",").map((e=>Number(e))):[]),this}applyGameOpts(e){return this.gameSpeed=e.gameSpeed,this.credits=e.credits,this.unitCount=e.unitCount,this.shortGame=e.shortGame,this.superWeapons=e.superWeapons,this.buildOffAlly=e.buildOffAlly,this.mcvRepacks=e.mcvRepacks,this.cratesAppear=e.cratesAppear,this.hostTeams=!!e.hostTeams,this}applyMpDialogSettings(e){return this.gameSpeed=6-e.gameSpeed,this.credits=e.money,this.unitCount=e.unitCount,this.shortGame=e.shortGame,this.mcvRepacks=e.mcvRedeploys,this.cratesAppear=e.crates,this.superWeapons=e.superWeapons,this}})}}})),System.register("gui/screen/mainMenu/lobby/SelectMapParams",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("game/gameopts/GameOptSanitizer",["util/math"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("GameOptSanitizer",class{static sanitize(e,t){var r=t.mpDialogSettings;e.credits=Math.floor(i.clamp(e.credits,r.minMoney,r.maxMoney)),e.gameSpeed=Math.floor(i.clamp(e.gameSpeed,0,6)),e.unitCount=Math.floor(i.clamp(e.unitCount,r.minUnitCount,r.maxUnitCount))}})}}})),System.register("gui/screen/game/MapFileLoader",["data/vfs/FileNotFoundError","data/vfs/VirtualFile"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("MapFileLoader",class{constructor(e,t){this.resourceLoader=e,this.vfs=t}async load(e,t){let s;if(this.vfs)try{s=await this.vfs.openFileWithRfs(e)}catch(e){e instanceof i.FileNotFoundError||console.error(e)}return s=s||r.VirtualFile.fromBytes(await this.resourceLoader.loadBinary(e,t),e),s}})}}})),System.register("engine/MapDigest",["data/Crc32"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MapDigest",class{static compute(e){return i.Crc32.calculateCrc(e.getBytes()).toString(16)}})}}})),System.register("network/WolConfig",[],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[],execute:function(){var t;"zotclot9","matchbot",(t=i=i||{})[t.Cdral2=0]="Cdral2",t[t.Yuri=1]="Yuri",e("ClientType",i),e("WolConfig",r=class e{constructor(e,t){this.clientType=e,this.clientSettings=t}static factory(t){return new this(t,e.allClientSettings.get(t))}getWolV2Compat(){return this.clientSettings.wolV2Compat}getClientSku(){return this.clientSettings.sku}getClientChannelType(){return this.clientSettings.channelType}getGlobalChannelPass(){return"zotclot9"}getQuickMatchBotName(){return"matchbot"}getQuickMatchChannelId(e){var t=e?this.clientSettings.rankedSoloChanId:this.clientSettings.unrankedSoloChanId;if(void 0===t)throw new Error(`Client type ${this.clientType} doesn't have a configured channel for ladder=`+e);return t}hasUnrankedQuickMatch(){return void 0!==this.clientSettings.unrankedSoloChanId}}),r.allClientSettings=(new Map).set(i.Cdral2,{sku:16640,wolV2Compat:!1,channelType:45,rankedSoloChanId:50,unrankedSoloChanId:51}).set(i.Yuri,{sku:10496,wolV2Compat:!0,channelType:41,rankedSoloChanId:40})}}})),System.register("network/wladderConfig",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CURRENT_SEASON","current"),e("PREV_SEASON","prev")}}})),System.register("network/PlayerRankHelper",["network/PlayerRankType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=[{type:i.PlayerRankType.Private,minPoints:0},{type:i.PlayerRankType.Corporal,minPoints:32},{type:i.PlayerRankType.Sergeant,minPoints:61},{type:i.PlayerRankType.Lieutenant,minPoints:81},{type:i.PlayerRankType.Major,minPoints:151},{type:i.PlayerRankType.Colonel,minPoints:251},{type:i.PlayerRankType.BrigGeneral,minPoints:501},{type:i.PlayerRankType.General,minPoints:1001},{type:i.PlayerRankType.FiveStarGeneral,minPoints:1501},{type:i.PlayerRankType.CommanderInChief,minPoints:2001}],e("PlayerRankHelper",class{static getRankType(e){let t=-1;for(var{minPoints:i}of r){if(e<i)break;t++}return r[t].type}})}}})),System.register("network/WLadderTransport",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/WLadderConnection",["network/PlayerRankHelper"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WLadderConnection",r=class e{constructor(e){this.transport=e}async listSearch(t,r){return r=r.slice(0,e.MAX_LIST_SEARCH_COUNT),(await this.transport.sendCommand(`listsearch ${t} -1 0 0 0 :${r.join(":")}:`)).map(((e,t)=>{if("NOTFOUND"===e)return{name:r[t]};let s=e.split(/\s+/);var[n,,a,o,l,c,h]=s.map(Number);return{name:s[1],wins:o,losses:l,disconnects:h,rank:n,rankType:i.PlayerRankHelper.getRankType(a),...c?{prevRank:c}:void 0,points:a}}))}async rungSearch(t,r,s){return s=Math.min(s,e.MAX_LIST_SEARCH_COUNT),(await this.transport.sendCommand(`rungsearch ${r} ${s} 0 `+t)).map((e=>{let t=e.split(/\s+/);var[r,,s,n,a,o,l]=t.map(Number);return{name:t[1],wins:n,losses:a,disconnects:l,rank:r,rankType:i.PlayerRankHelper.getRankType(s),...o?{prevRank:o}:void 0,points:s}}))}}),r.MAX_LIST_SEARCH_COUNT=50}}})),System.register("network/WLadderTransportWebSocket",["network/IrcConnection"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WLadderTransportWebSocket",class{constructor(e,t){this.con=e,this.serverUrl=t}static factory(e,t){return new this(new i.IrcConnection({mode:"binary"},t),e)}async sendCommand(e){try{return await this.con.connect(this.serverUrl),(await this.con.sendCommand(e,{replyRawText:!0})).map((e=>e.raw.trim())).filter((e=>0<e.length))}finally{this.con.close()}}})}}})),System.register("network/WLadderService",["network/wladderConfig","network/WLadderConnection","network/HttpRequest","network/WLadderTransportWebSocket"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("WLadderService",a=class e{constructor(e,t){this.wolConfig=e,this.logger=t}setUrl(e){this.url=e}getUrl(){return this.url}async getSeasons(t="1v1",i){if(!this.url)throw new Error("No ladder URL is set");var r=this.url.match(/^wss?:\/\//i),n=this.wolConfig.getClientSku();return r?[e.CURRENT_SEASON]:await(new s.HttpRequest).fetchJson(this.url+`/${n}/`+t,i)}async listSearch(t,i,r="1v1",n=e.CURRENT_SEASON){if(!this.url)throw new Error("No ladder URL is set");var a=this.url.match(/^wss?:\/\//i),o=this.wolConfig.getClientSku();if(!a)return await(new s.HttpRequest).fetchJson(this.url+`/${o}/${r}/${n}/listsearch`,i,{method:"POST",body:JSON.stringify({players:t})});if(n!==e.CURRENT_SEASON)throw new Error("Legacy wladder doesn't support season parameter");if("1v1"!==r)throw new Error("Legacy wladder only supports 1v1");let l=this.createWebSocketConnection(this.url);return await l.listSearch(o,t)}async rungSearch(t,i,r,n="1v1",a=e.CURRENT_SEASON){if(!this.url)throw new Error("No ladder URL is set");var o=this.url.match(/^wss?:\/\//i),l=this.wolConfig.getClientSku();if(!o)return await(new s.HttpRequest).fetchJson(this.url+`/${l}/${n}/${a}/rungsearch`,r,{method:"POST",body:JSON.stringify({start:t,count:i})});if(a!==e.CURRENT_SEASON)throw new Error("Legacy wladder doesn't support season parameter");if("1v1"!==n)throw new Error("Legacy wladder only supports 1v1");let c=this.createWebSocketConnection(this.url);return await c.rungSearch(l,t,i)}createWebSocketConnection(e){return new r.WLadderConnection(n.WLadderTransportWebSocket.factory(e,this.logger))}}),a.CURRENT_SEASON=i.CURRENT_SEASON,a.PREV_SEASON=i.PREV_SEASON}}})),System.register("network/WolConnectOptions",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/chat/Message",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/WolService",["util/event","engine/ResourceLoader","data/IniFile","network/WolError"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("WolService",a=class e{constructor(t,r,s){this.wolConfig=t,this.wolCon=r,this.clientVersion=s,this.ignoreLastWolClose=!1,this._onWolConnectionLost=new i.EventDispatcher,this.autoReconnect=!1,this.pendingReconnect=!1,this.onWolClose=t=>{this.connectOpts&&!this.ignoreLastWolClose&&(this.autoReconnect&&(this.reconnectTimeout=setTimeout((()=>this.tryReconnect(e.MIN_RECONNECT_MILLIS)),0)),this._onWolConnectionLost.dispatch(this,t)),this.ignoreLastWolClose=!1}}get onWolConnectionLost(){return this._onWolConnectionLost.asEvent()}init(){this.wolCon.onClose.subscribe(this.onWolClose)}getConfig(){return this.wolConfig}getConnection(){return this.wolCon}isConnected(){return this.wolCon.isOpen()}shouldKeepAliveInGame(){return this.connectOpts?.keepAliveInGame}getCredentials(){return this.connectOpts?{user:this.connectOpts.user,pass:this.connectOpts.pass}:void 0}async connectAndLogin(e){var{url:t,wolv2Ascii:i,user:r,pass:s}=e;this.cancelReconnect(),this.wolCon.isOpen()&&JSON.stringify(this.connectOpts)!==JSON.stringify(e)&&this.closeWolConnection(),this.connectOpts=e,this.ignoreLastWolClose=!0;try{return await this.wolCon.connect(t,this.wolConfig.getWolV2Compat(),i),this.wolCon.cvers(this.wolConfig.getClientSku()),(await this.wolCon.login(r,s)).map((e=>({text:e})))}finally{this.ignoreLastWolClose=!1}}async loadServerList(e,t){let i=new r.ResourceLoader("");var n=await i.loadText(e,t);return(new s.IniFile).fromString(n)}async validateGameVersion(e){if(e.gameVersion&&!this.matchVersions(this.clientVersion,e.gameVersion))throw new n.WolError(`Game version mismatch: client version is ${this.clientVersion}, but expected `+e.gameVersion,n.WolError.Code.OutdatedClient)}matchVersions(e,t){let[i,r,s]=e.split(".");var[n,a,o]=t.split(".");return i===n&&r===a&&Number(s.split("-")[0])>=Number(o)}async tryReconnect(t){if(this.connectOpts)try{this.pendingReconnect=!0,await this.connectAndLogin(this.connectOpts),await this.wolCon.rejoinLastChannel()}catch(i){if(i instanceof n.WolError)console.error("Failed to reconnect to WoL service",i);else{let i=Math.min(e.MAX_RECONNECT_MILLIS,2*t);this.reconnectTimeout=setTimeout((()=>this.tryReconnect(i)),t)}}finally{this.pendingReconnect=!1}}setAutoReconnect(e){e!==this.autoReconnect&&((this.autoReconnect=e)||this.cancelReconnect())}async forceReconnect(){var e;this.cancelReconnect(),this.wolCon.isOpen()&&(e=this.connectOpts,this.closeWolConnection(),e&&await this.connectAndLogin(e))}closeWolConnection(){this.cancelReconnect(),this.wolCon.isOpen()&&(this.connectOpts=void 0,this.ignoreLastWolClose=!0,this.wolCon.leaveAllChannels(),this.wolCon.close())}dispose(){this.cancelReconnect(),this.wolCon.onClose.unsubscribe(this.onWolClose)}cancelReconnect(){this.pendingReconnect&&this.wolCon.close(),this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=void 0)}}),a.MIN_RECONNECT_MILLIS=5e3,a.MAX_RECONNECT_MILLIS=6e4}}})),System.register("gui/screen/mainMenu/lobby/LobbyScreen",["@puzzl/core/lib/async/Task","network/WolConnection","network/WolError","network/gameopt/SlotInfo","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/lobby/component/PasswordBox","gui/screen/mainMenu/lobby/component/CreateGameBox","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","engine/sound/SoundKey","engine/sound/ChannelType","LocalPrefs","gui/screen/mainMenu/lobby/PreferredHostOpts","util/typeGuard","game/gameopts/GameOptSanitizer","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","network/gservConfig","gui/screen/mainMenu/MainMenuRoute","@puzzl/core/lib/async/sleep","network/chat/ChatMessage","gui/chat/ChatHistory"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e}],execute:function(){B=class extends x.MainMenuScreen{constructor(e,t,s,a,o,l,c,h,g,p,m,y,T,S,w,E,x,O,A){super(),this.engineModHash=e,this.activeModMeta=t,this.rootController=s,this.errorHandler=a,this.messageBoxApi=o,this.strings=l,this.uiScene=c,this.wolCon=h,this.wolService=g,this.wladderService=p,this.rules=m,this.gameOptParser=y,this.gameOptSerializer=T,this.jsxRenderer=S,this.mapFileLoader=w,this.mapList=E,this.gameModes=x,this.sound=O,this.localPrefs=A,this.messages=[],this.playerReadyStatus=new Map,this.playerHasMapStatus=new Map,this.playerProfiles=new Map,this.disposables=new d.CompositeDisposable,this.updatePings=()=>{if(this.wolCon.isOpen()){if(this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName))if(this.wolv2Compat)this.requestedInternalPing=!0,this.wolCon.privmsg([this.gameChannelName],"/ping");else{this.pingsUpdateTask?.cancel();let e=this.pingsUpdateTask=new i.Task((async e=>{var t=await this.wolCon.listUsers(this.gameChannelName);if(!e.isCancelled()){for(var i of t)this.updatePlayerPing(i.name,i.ping);this.sendPingData()}}));e.start().catch((e=>{e instanceof f.OperationCanceledError||console.error(e)}))}}else this.onWolClose()},this.updateRanks=()=>{if(this.wladderService.getUrl()&&this.slotsInfo){this.ranksUpdateTask?.cancel();let e=this.ranksUpdateTask=new i.Task((async e=>{await P.sleep(5e3,e);var t=this.slotsInfo.map((e=>e.type===n.SlotType.Player?e.name:void 0)).filter(C.isNotNullOrUndefined);t=await this.wladderService.listSearch(t,e);if(!e.isCancelled()){for(var i of t)this.playerProfiles.set(i.name,i);this.updateFormModel()}}));e.start().catch((e=>{e instanceof f.OperationCanceledError||console.error(e)}))}},this.onChannelLeave=e=>{e.channel===this.gameChannelName&&(this.hostMode?e.user.name!==this.wolCon.getCurrentUser()&&this.handlePlayerJoinLeave(e):e.user.name!==this.hostPlayerName&&e.user.name!==this.wolCon.getCurrentUser()||(e.user.name===this.hostPlayerName&&this.wolCon.isOpen()&&this.wolCon.leaveChannel(e.channel),this.controller?.goToScreen(u.ScreenType.CustomGame,{})))},this.onChannelJoin=e=>{e.user.name!==this.wolCon.getCurrentUser()&&(this.sound.play("join"===e.type?v.SoundKey.PlayerJoined:v.SoundKey.PlayerLeft,b.ChannelType.Ui),this.hostMode?this.handlePlayerJoinLeave(e):this.wolCon.sendPlayerReady(!1),this.wolv2Compat||"join"===e.type&&(this.updatePlayerPing(e.user.name,e.user.ping),this.hostMode&&this.sendPingData()),this.playerProfiles.has(e.user.name)||this.updateRanks())},this.onChannelMessage=e=>{if(this.lobbyForm){if(this.wolv2Compat&&this.requestedInternalPing){if(e.to.type===I.ChatRecipientType.Page&&e.from===this.wolCon.getServerName()&&e.text.match(/^[^ ]+ [^:]+:\s+\d+/))return void this.handlePlayerPing(e.text);if("/ping"===e.text)return}e.to.type!==I.ChatRecipientType.Page&&e.to.type!==I.ChatRecipientType.Whisper||this.sound.play(v.SoundKey.IncomingMessage,b.ChannelType.Ui),this.messages.push(e),this.lobbyForm.refresh()}e.to.type===I.ChatRecipientType.Whisper&&e.to.name!==this.wolCon.getServerName()&&e.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=e.from)},this.handleGameStart=e=>{var t,i=this.wolCon.getCurrentUser(),s=new R.MainMenuRoute(u.ScreenType.Login,{afterLogin:e=>new R.MainMenuRoute(u.ScreenType.CustomGame,{messages:e})});this.hostMode?(t=[...this.playerHasMapStatus.values()].includes(r.WolHasMapStatus.MapTransfer),this.rootController.createGame(e.gameId,e.timestamp,i,this.gameOpts,!1,this.isTournament,t,s)):(t=this.playerHasMapStatus.get(i)===r.WolHasMapStatus.MapTransfer,this.rootController.joinGame(e.gameId,e.timestamp,i,this.isTournament,t,s))},this.handleGameOpt=e=>{let t=e.opt,i=t[0];if(this.hostMode){if(e.user!==this.hostPlayerName)if("A"===i)this.handleGameOptReady(e.user,t[1]);else if("R"===i)this.handlePlayerOptsChange(e.user,t);else{if("K"!==i)throw new Error("Unknown GAMEOPT string "+t);this.handleGameOptHasMap(e.user,t[1])}}else if("L"===i)this.handleGameOptSlots(t),this.slotsInfo.some((e=>e.type===n.SlotType.Player&&!this.playerProfiles.has(e.name)))&&this.updateRanks();else if("P"===i)this.handleGameOptPing(t.slice(1));else if("O"===i)this.handleGameOptObserver(t[1]);else if("A"===i)this.handleGameOptReady(e.user,t[1]);else if("K"===i)this.handleGameOptHasMap(e.user,t[1]);else{if("R"===i)return;if("G"===i)return void(this.playerReadyStatus.get(this.wolCon.getCurrentUser())||this.addSystemMessage(this.strings.get("GUI:HostGameStartJoiner")));if(!i.match(/^-|\d+/))throw new Error("Unknown GAMEOPT string "+t);this.handleGameOptOptions(t)}this.updateFormModel()},this.onWolClose=()=>{this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId)},this.onWolConLost=e=>{this.errorHandler.handle(e,this.strings.get("TXT_YOURE_DISCON"),(()=>{this.controller?.goToScreen(u.ScreenType.Home)}))},this.wolv2Compat=this.wolService.getConfig().getWolV2Compat()}async onEnter(e){var t,i;this.wolCon.getCurrentUser()?(this.gameChannelName=void 0,this.lobbyForm=void 0,this.chatHistory=new k.ChatHistory,this.initFormModel(),this.wolCon.onGameOpt.subscribe(this.handleGameOpt),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.wolCon.onLeaveChannel.subscribe(this.onChannelLeave),this.wolCon.onJoinChannel.subscribe(this.onChannelJoin),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.hostMode=e.create,this.hostMode?(this.title=this.strings.get("GUI:HostScreen"),this.createGame()):(this.title=this.strings.get("GUI:JoinScreen"),({game:t,observe:i}=e),this.joinGame(t,i))):this.messageBoxApi.show(this.strings.get("TXT_YOURE_DISCON"),this.strings.get("GUI:Ok"),(()=>{this.controller?.goToScreen(u.ScreenType.Home)}))}async joinGame(e,t,i){if(i||!e.passLocked){var r,n,o,l=e.name;try{this.hostPlayerName=await this.wolCon.joinGame(l,i),this.gameChannelName=l,this.isTournament=e.tournament,this.formModel.channels=[this.gameChannelName],t?this.sendPlayerInfo(a.OBS_COUNTRY_ID,a.RANDOM_COLOR_ID,a.RANDOM_START_POS,a.NO_TEAM_ID):(r=this.localPrefs.getItem(S.StorageKey.LastPlayerCountry),n=this.localPrefs.getItem(S.StorageKey.LastPlayerColor),o=void 0!==r&&Number(r)<this.getAvailablePlayerCountries().length?Number(r):a.RANDOM_COUNTRY_ID,c=void 0!==n&&Number(n)<this.getAvailablePlayerColors().length&&this.getSelectablePlayerColors().includes(this.getColorNameById(Number(n)))?Number(n):a.RANDOM_COLOR_ID,o===a.RANDOM_COUNTRY_ID&&c===a.RANDOM_COLOR_ID||this.sendPlayerInfo(o,c,a.RANDOM_START_POS,a.NO_TEAM_ID)),this.observerSlotIndex=8}catch(e){if(e instanceof s.WolError){var c=(new Map).set(s.WolError.Code.BadGamePass,"TXT_BADPASS").set(s.WolError.Code.GameHasClosed,"TXT_GAME_CLOSED").set(s.WolError.Code.ChannelFull,"TXT_CHANNEL_FULL").set(s.WolError.Code.BannedFromChannel,"TXT_JOINBAN").get(e.code);if(c)return void this.messageBoxApi.show(this.strings.get(c),this.strings.get("GUI:Ok"),(()=>{this.controller?.goToScreen(u.ScreenType.CustomGame,{})}))}return void this.handleError(e,this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showPasswordBox((i=>{this.joinGame(e,t,i)}),(()=>{this.controller?.goToScreen(u.ScreenType.CustomGame,{})}))}async createGame(e){if(e){try{var{roomDesc:t,tournament:i,observe:r,pass:s}=e;this.gameChannelName=await this.wolCon.createGame(1,9,this.wolService.getConfig().getClientChannelType(),i,s),this.hostPlayerName=this.wolCon.getCurrentUser(),this.hostRoomDesc=t,this.isTournament=i,this.observerSlotIndex=r?0:8,this.formModel.lobbyType=l.LobbyType.MultiplayerHost,this.formModel.activeSlotIndex=r?-1:0,this.formModel.channels=[this.gameChannelName],await this.initHostOptions(r),this.updateMapPreview(this.currentMapFile),this.updateFormModel(),this.updatePings(),this.updateRanks(),this.sendGameOpts(),this.sendModeMaxSlots(),this.hostOptsIntervalId=setInterval((()=>{this.wolCon.isOpen()&&(this.sendGameOpts(),this.updatePings())}),5e3)}catch(e){return void this.handleError(e,e instanceof m.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchBadParameters"))}this.controller.toggleSidebarPreview(!0),this.initView()}else this.showCreateGameBox(((e,t,i)=>{this.createGame({roomDesc:e,observe:i,pass:t,tournament:!1})}),(()=>{this.controller?.goToScreen(u.ScreenType.CustomGame,{})}))}onViewportChange(){this.createGameBox&&this.createGameBox.applyOptions((e=>e.viewport=this.uiScene.viewport)),this.passBox&&this.passBox.applyOptions((e=>e.viewport=this.uiScene.viewport))}onUnstack(e){if(this.wolCon.isOpen()){if(e){let l=e.gameMode.id!==this.gameOpts.gameMode;var t=e.mapName!==this.gameOpts.mapName;this.gameOpts.gameMode=e.gameMode.id;let c=this.mapList.getByName(e.mapName),h=e.changedMapFile??this.currentMapFile;this.currentMapFile=h;var i=T.findIndexReverse(this.slotsInfo,((e,t)=>e.type===n.SlotType.Ai||e.type===n.SlotType.Player&&(this.observerSlotIndex!==t||0===t)||e.type===n.SlotType.Open)),r=Math.min(9,c.maxSlots+(0===this.observerSlotIndex?1:0)),s=Math.max(0,i+1-r);for(let e=0;e<s;e++){let t=this.slotsInfo[i-e];t.type===n.SlotType.Player?this.kickPlayer(t.name,"Bye"):t.type===n.SlotType.Ai&&(this.gameOpts.aiPlayers[i-e]=void 0),t.type=n.SlotType.Closed}for(let e=i+1;e<r;e++)this.slotsInfo[e].type=this.preferredHostOpts.slotsClosed.has(e)?n.SlotType.Closed:this.observerSlotIndex===e?n.SlotType.OpenObserver:n.SlotType.Open;let u=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;if([...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach((e=>{e&&(e.startPos>c.maxSlots-1&&(e.startPos=a.RANDOM_START_POS),l&&(e.teamId=u.alliesAllowed&&u.mustAlly?0:a.NO_TEAM_ID))})),t){for(var o of this.playerReadyStatus.keys())this.playerReadyStatus.set(o,!1);this.playerHasMapStatus.clear()}this.sendGameSlotInfo(),this.sendModeMaxSlots(),this.applyGameOption((e=>{e.mapName=c.fileName,e.mapDigest=A.MapDigest.compute(h),e.mapSizeBytes=h.getSize(),e.mapTitle=c.getFullMapTitle(this.strings),e.maxSlots=c.maxSlots,e.mapOfficial=c.official})),this.localPrefs.setItem(S.StorageKey.LastMap,c.fileName),this.localPrefs.setItem(S.StorageKey.LastMode,String(e.gameMode.id))}this.updateMapPreview(this.currentMapFile),this.initView()}else this.onWolClose()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons()}async initHostOptions(e){var t=this.localPrefs.getItem(S.StorageKey.PreferredGameOpts),i=this.localPrefs.getItem(S.StorageKey.LastPlayerCountry),r=this.localPrefs.getItem(S.StorageKey.LastPlayerColor),s=this.localPrefs.getItem(S.StorageKey.LastMap),o=this.localPrefs.getItem(S.StorageKey.LastMode);let l,c=s?this.mapList.getByName(s):void 0,h=c&&o&&this.gameModes.hasId(Number(o))?Number(o):1,u=this.gameModes.getById(h);l=c?.gameModes.find((e=>e.mapFilter===u.mapFilter))?c:(h=1,u=this.gameModes.getById(h),this.mapList.getAll().find((e=>e.gameModes.find((e=>u.mapFilter===e.mapFilter)))));let d=this.currentMapFile=await this.mapFileLoader.load(l.fileName),g=this.preferredHostOpts=new w.PreferredHostOpts;t?g.unserialize(t):g.applyMpDialogSettings(this.rules.mpDialogSettings),t=this.gameModes.getById(h).mpDialogSettings,this.gameOpts={gameMode:h,shortGame:g.shortGame,mcvRepacks:g.mcvRepacks,cratesAppear:g.cratesAppear,superWeapons:g.superWeapons,gameSpeed:g.gameSpeed,credits:g.credits,unitCount:g.unitCount,buildOffAlly:g.buildOffAlly,hostTeams:g.hostTeams,humanPlayers:[{name:this.hostPlayerName,countryId:e?a.OBS_COUNTRY_ID:void 0!==i&&Number(i)<this.getAvailablePlayerCountries().length?Number(i):a.RANDOM_COUNTRY_ID,colorId:!e&&void 0!==r&&Number(r)<this.getAvailablePlayerColors().length?Number(r):a.RANDOM_COLOR_ID,startPos:a.RANDOM_START_POS,teamId:t.mustAlly?0:a.NO_TEAM_ID}],aiPlayers:new Array(8).fill(void 0),mapName:l.fileName,mapDigest:A.MapDigest.compute(d),mapSizeBytes:d.getSize(),mapTitle:l.getFullMapTitle(this.strings),maxSlots:l.maxSlots,mapOfficial:l.official},this.slotsInfo=[{type:n.SlotType.Player,name:this.hostPlayerName}];for(let t=1;t<9;++t)this.slotsInfo.push({type:g.slotsClosed.has(t)?n.SlotType.Closed:this.observerSlotIndex===t?n.SlotType.OpenObserver:t<l.maxSlots+(e?1:0)?n.SlotType.Open:n.SlotType.Closed});this.playerPings=[],this.playerProfiles.clear(),this.requestedInternalPing=!1}handleError(e,t){this.errorHandler.handle(e,t,(()=>{this.controller?.goToScreen(u.ScreenType.CustomGame,{})})),this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId)}showPasswordBox(e,t){let[i]=this.jsxRenderer.render(g.jsx(p.HtmlView,{innerRef:e=>this.passBox=e,component:c.PasswordBox,props:{strings:this.strings,onSubmit:t=>{e(t),i.destroy()},onDismiss:()=>{t(),i.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(i),this.disposables.add(i,(()=>this.uiScene.remove(i)),(()=>this.passBox=void 0))}showCreateGameBox(e,t){let[i]=this.jsxRenderer.render(g.jsx(p.HtmlView,{component:h.CreateGameBox,innerRef:e=>this.createGameBox=e,props:{strings:this.strings,onSubmit:(t,r,s)=>{i.destroy(),e(t,r,s)},onDismiss:()=>{i.destroy(),t()},viewport:this.uiScene.viewport}}));this.uiScene.add(i),this.disposables.add(i,(()=>this.uiScene.remove(i)),(()=>this.createGameBox=void 0))}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map((e=>e.name))}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map((e=>e.asHexString()))}getAvailableStartPositions(){return new Array(this.gameOpts?.maxSlots??8).fill(0).map(((e,t)=>t))}getSelectablePlayerColors(){let e=[];this.formModel&&this.formModel.playerSlots.forEach((t=>{t&&e.push(t.color)}));let t=this.getAvailablePlayerColors();return[a.RANDOM_COLOR_NAME].concat(t.filter((t=>t&&-1===e.indexOf(t))))}getSelectableStartPositions(){let e=[];this.formModel&&this.formModel.playerSlots.forEach((t=>{t&&e.push(t.startPos)}));let t=this.getAvailableStartPositions();return[a.RANDOM_START_POS].concat(t.filter((t=>!e.includes(t))))}initFormModel(){var e=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[a.RANDOM_COUNTRY_NAME,a.RANDOM_COUNTRY_UI_NAME],[a.OBS_COUNTRY_NAME,a.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map((e=>[e.name,e.uiName])))),countryUiTooltips:new Map([[a.RANDOM_COUNTRY_NAME,a.RANDOM_COUNTRY_UI_TOOLTIP],[a.OBS_COUNTRY_NAME,a.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter((e=>e.uiTooltip)).map((e=>[e.name,e.uiTooltip])))),availablePlayerCountries:[a.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:this.getSelectablePlayerColors(),availableAiNames:new Map,availableStartPositions:this.getSelectableStartPositions(),lobbyType:l.LobbyType.MultiplayerGuest,messages:this.messages,chatHistory:this.chatHistory,channels:[],localUsername:this.wolCon.getCurrentUser(),mpDialogSettings:e,onSendMessage:e=>{e.value.length?(this.wolv2Compat&&"/ping"===e.value&&(this.requestedInternalPing=!1),this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(e.value,e.recipient),e.recipient.type===I.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=e.recipient.name))):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onCountrySelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(e),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel())},onColorSelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(e),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel())},onStartPosSelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),e,this.formModel.playerSlots[t].team,t),this.updateFormModel())},onTeamSelect:(e,t)=>{this.wolCon.isOpen()&&(this.sendPlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,e,t),this.updateFormModel())},onSlotChange:(e,t,i)=>{this.wolCon.isOpen()&&this.changeSlotType(e,t,i)},onToggleShortGame:e=>this.applyGameOption((t=>t.shortGame=e)),onToggleMcvRepacks:e=>this.applyGameOption((t=>t.mcvRepacks=e)),onToggleCratesAppear:e=>this.applyGameOption((t=>t.cratesAppear=e)),onToggleSuperWeapons:e=>this.applyGameOption((t=>t.superWeapons=e)),onToggleBuildOffAlly:e=>this.applyGameOption((t=>t.buildOffAlly=e)),onToggleHostTeams:e=>this.applyGameOption((t=>t.hostTeams=e)),onChangeGameSpeed:e=>this.applyGameOption((t=>t.gameSpeed=e)),onChangeCredits:e=>this.applyGameOption((t=>t.credits=e)),onChangeUnitCount:e=>this.applyGameOption((t=>t.unitCount=e)),activeSlotIndex:-1,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,hostTeams:!1,gameSpeed:6,credits:e.money,unitCount:e.unitCount},this.playerReadyStatus.clear(),this.playerHasMapStatus.clear(),this.messages.length=0}applyGameOption(e){if(!this.hostMode)throw new Error("Can't change options when not a host");this.wolCon.isOpen()?(e(this.gameOpts),E.GameOptSanitizer.sanitize(this.gameOpts,this.rules),this.updateFormModel(),this.sendGameOpts(),this.localPrefs.setItem(S.StorageKey.PreferredGameOpts,this.preferredHostOpts.applyGameOpts(this.gameOpts).serialize())):this.onWolClose()}changeSlotType(e,t,i){if(!this.hostMode)throw new Error("Only host can change slot type");if(0===t)throw new Error("Change slot type of host");var r=this.formModel.playerSlots[t];let s=this.slotsInfo[t];r.occupation===e&&s.type===n.SlotType.Player||(r.occupation===l.SlotOccupation.Occupied&&(s.type===n.SlotType.Player?this.kickPlayer(s.name,"Bye"):this.gameOpts.aiPlayers[t]=void 0),r=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings,e===l.SlotOccupation.Closed?(s.type=n.SlotType.Closed,this.preferredHostOpts.slotsClosed.add(t)):e===l.SlotOccupation.Open?(s.type=t===this.observerSlotIndex?n.SlotType.OpenObserver:n.SlotType.Open,this.preferredHostOpts.slotsClosed.delete(t)):e===l.SlotOccupation.Occupied&&void 0!==i&&(s.type=n.SlotType.Ai,s.difficulty=i,this.gameOpts.aiPlayers[t]={difficulty:i,countryId:a.RANDOM_COUNTRY_ID,colorId:a.RANDOM_COLOR_ID,startPos:a.RANDOM_START_POS,teamId:r.mustAlly?0:a.NO_TEAM_ID},this.preferredHostOpts.slotsClosed.delete(t)),this.updateFormModel(),this.sendGameSlotInfo(),this.sendGameOpts(),this.sendModeMaxSlots(),this.localPrefs.setItem(S.StorageKey.PreferredGameOpts,this.preferredHostOpts.serialize()))}getCountryNameById(e){let t;return t=e===a.RANDOM_COUNTRY_ID?a.RANDOM_COUNTRY_NAME:e===a.OBS_COUNTRY_ID?a.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[e],t}getCountryIdByName(e){let t;if(e===a.RANDOM_COUNTRY_NAME)t=a.RANDOM_COUNTRY_ID;else if(e===a.OBS_COUNTRY_NAME)t=a.OBS_COUNTRY_ID;else{t=this.getAvailablePlayerCountries().indexOf(e)}return t}getColorNameById(e){let t;return t=e===a.RANDOM_COLOR_ID?a.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[e],t}getColorIdByName(e){let t;if(e===a.RANDOM_COLOR_NAME)t=a.RANDOM_COLOR_ID;else{if(t=this.getAvailablePlayerColors().indexOf(e),-1===t)throw new Error(`Color ${e} not found in available player colors`)}return t}sendPlayerInfo(e,t,i,r,s){if(!this.hostPlayerName)throw new Error("Host player name not yet set.");if(this.hostMode){if(void 0!==s&&s!==this.formModel.activeSlotIndex){const a=this.slotsInfo[s];if(a.type!==n.SlotType.Ai&&!this.gameOpts.hostTeams)throw new Error("Can't change country and color for a non-AI slot");let o=this.gameOpts.aiPlayers[s];if(!o){if(!this.gameOpts.hostTeams)throw new Error("No AI found in slot "+s);if(a.type!==n.SlotType.Player)return void console.warn(`Can't change player info for ${n.SlotType[a.type]} slot at `+s);o=this.gameOpts.humanPlayers.find((e=>e.name===a.name))}if(!o)throw new Error("No human player found in slot "+s);o.countryId=e,o.colorId=t,o.startPos=i,o.teamId=r}else this.updatePlayerInfo(this.hostPlayerName,e,t,i,r);this.updateFormModel(),this.sendGameOpts()}else this.wolCon.sendPlayerOpts(this.hostPlayerName,e,t,i,r);void 0!==s&&s!==this.formModel.activeSlotIndex||e!==a.OBS_COUNTRY_ID&&(e!==a.RANDOM_COUNTRY_ID?this.localPrefs.setItem(S.StorageKey.LastPlayerCountry,String(e)):this.localPrefs.removeItem(S.StorageKey.LastPlayerCountry),t!==a.RANDOM_COLOR_ID?this.localPrefs.setItem(S.StorageKey.LastPlayerColor,String(t)):this.localPrefs.removeItem(S.StorageKey.LastPlayerColor))}updatePlayerInfo(e,t,i,r,s,n=!1){if(!this.hostMode)throw new Error("Method should only be used in host mode");let a=this.gameOpts.humanPlayers.find((t=>t.name===e));a?(a.countryId=t,a.colorId=i,n||(a.startPos=r,a.teamId=s)):console.error("Can't set country/color for non-existent player "+e)}updateFormModel(){var e=this.gameOpts;if(e&&(this.formModel.gameSpeed=e.gameSpeed,this.formModel.credits=e.credits,this.formModel.unitCount=e.unitCount,this.formModel.shortGame=e.shortGame,this.formModel.superWeapons=e.superWeapons,this.formModel.buildOffAlly=e.buildOffAlly,this.formModel.hostTeams=e.hostTeams,this.formModel.mcvRepacks=e.mcvRepacks,this.formModel.cratesAppear=e.cratesAppear),this.gameOpts&&this.slotsInfo){let t=e.maxSlots;this.slotsInfo.forEach(((e,i)=>{i!==this.observerSlotIndex?t?(t--,this.formModel.playerSlots[i]={country:a.RANDOM_COUNTRY_NAME,color:a.RANDOM_COLOR_NAME,startPos:a.RANDOM_START_POS,team:a.NO_TEAM_ID}):this.formModel.playerSlots[i]=void 0:this.formModel.playerSlots[i]={country:a.RANDOM_COUNTRY_NAME,color:a.RANDOM_COLOR_NAME,startPos:a.RANDOM_START_POS,team:a.NO_TEAM_ID}})),this.slotsInfo.forEach(((e,t)=>{if(this.formModel.playerSlots[t]){let i=this.formModel.playerSlots[t];e.type===n.SlotType.Closed?i.occupation=l.SlotOccupation.Closed:e.type===n.SlotType.Open||e.type===n.SlotType.OpenObserver?i.occupation=l.SlotOccupation.Open:i.occupation=l.SlotOccupation.Occupied,e.type===n.SlotType.OpenObserver||t===this.observerSlotIndex?i.type=l.SlotType.Observer:e.type===n.SlotType.Ai?i.type=l.SlotType.Ai:i.type=l.SlotType.Player,e.type===n.SlotType.Ai?(i.aiDifficulty=e.difficulty,i.status=l.PlayerStatus.Ready):e.type===n.SlotType.Player&&(i.name=e.name,e.name===this.hostPlayerName?i.status=l.PlayerStatus.Host:i.status=this.playerReadyStatus.get(e.name)?l.PlayerStatus.Ready:l.PlayerStatus.NotReady)}}))}let t=this.gameOpts?this.gameOpts.humanPlayers:[],i=this.gameOpts?this.gameOpts.aiPlayers:[],r=this.gameOpts?this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings:void 0;this.formModel.playerSlots.forEach(((e,s)=>{var n,o;e&&t.length&&(e.occupation===l.SlotOccupation.Occupied?((n=t.find((t=>t.name===e.name)))?(e.country=this.getCountryNameById(n.countryId),e.color=this.getColorNameById(n.colorId),e.startPos=n.startPos,e.team=n.teamId):(o=i[s])&&(e.country=this.getCountryNameById(o.countryId),e.color=this.getColorNameById(o.colorId),e.startPos=o.startPos,e.team=o.teamId),!this.playerPings||(o=this.playerPings.find((t=>!!e.name&&t.playerName.toLowerCase()===e.name.toLowerCase())))&&(e.ping=0<o.ping?o.ping:void 0),this.playerProfiles&&e.type===l.SlotType.Player&&(e.playerProfile=this.playerProfiles.get(e.name))):s===this.observerSlotIndex?e.country=a.OBS_COUNTRY_NAME:(e.country=a.RANDOM_COUNTRY_NAME,r&&(e.team=r.mustAlly?0:a.NO_TEAM_ID)))})),this.hostMode||(this.formModel.activeSlotIndex=this.slotsInfo?this.slotsInfo.findIndex((e=>e.type===n.SlotType.Player&&e.name===this.wolCon.getCurrentUser())):-1),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(),this.formModel.availableStartPositions=this.getSelectableStartPositions(),this.gameOpts&&(this.formModel.teamsAllowed=this.gameModes.getById(e.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(e.gameMode).mpDialogSettings.mustAlly),this.lobbyForm&&t.length&&this.lobbyForm.refresh()}addSystemMessage(e){this.lobbyForm&&(this.messages.push({text:e}),this.lobbyForm.refresh())}sendGameOpts(){if(!this.hostMode)throw new Error("Should only be used in host mode");var e,t,i;this.gameOpts&&this.wolCon.isOpen()&&(this.gameOpts.humanPlayers.forEach((e=>{-1===e.colorId&&(e.colorId=a.RANDOM_COLOR_ID)})),i=this.gameOptSerializer.serializeOptions(this.gameOpts),this.wolCon.sendGameOpts(i),e=this.slotsInfo.filter((e=>e.type===n.SlotType.Ai||e.type===n.SlotType.Player||e.type===n.SlotType.Open||e.type===n.SlotType.OpenObserver)).length,t=this.slotsInfo.filter((e=>e.type===n.SlotType.Player)).length,i=this.activeModMeta?this.activeModMeta.name+(void 0!==this.activeModMeta.version?` (${this.activeModMeta.version})`:""):void 0,this.wolCon.sendGameTopic(t,e,this.gameOpts.aiPlayers.filter((e=>!!e)).length,Number(this.slotsInfo[this.observerSlotIndex].type===n.SlotType.Player),this.slotsInfo[this.observerSlotIndex].type===n.SlotType.OpenObserver,this.gameOpts.mapName,this.engineModHash,this.hostRoomDesc,i),this.sendPingData())}handlePlayerJoinLeave(e){if(!this.hostMode)throw new Error("Should only be used in host mode");if(this.slotsInfo){if("join"===e.type){let r=this.slotsInfo.findIndex((e=>e.type===n.SlotType.Open)),s=!1;if(-1===r&&(r=this.slotsInfo.findIndex((e=>e.type===n.SlotType.OpenObserver)),s=!0,-1===r))return void this.kickPlayer(e.user.name,"Bye");this.slotsInfo[r]={type:n.SlotType.Player,name:e.user.name};var t,i=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;for(t of(this.gameOpts.humanPlayers.push({name:e.user.name,countryId:s?a.OBS_COUNTRY_ID:a.RANDOM_COUNTRY_ID,colorId:s?a.OBS_COLOR_ID:a.RANDOM_COLOR_ID,startPos:a.RANDOM_START_POS,teamId:i.mustAlly?0:a.NO_TEAM_ID}),this.playerReadyStatus.set(e.user.name,!1),this.playerReadyStatus.keys()))this.playerReadyStatus.set(t,!1)}else this.removeHumanPlayer(e.user.name);this.sendGameSlotInfo(),this.sendObserverSlotInfo(),this.sendGameOpts()}}removeHumanPlayer(e){var t=this.slotsInfo.findIndex((t=>t.type===n.SlotType.Player&&t.name===e));if(-1!==t){let e=this.slotsInfo[t];t===this.observerSlotIndex?e.type=n.SlotType.OpenObserver:e.type=n.SlotType.Open}t=this.gameOpts.humanPlayers.findIndex((t=>t.name===e)),-1!==t&&this.gameOpts.humanPlayers.splice(t,1),this.playerReadyStatus.delete(e),this.playerHasMapStatus.delete(e),t=this.playerPings.findIndex((t=>t.playerName===e)),-1!==t&&this.playerPings.splice(t,1)}kickPlayer(e,t){this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(this.wolCon.kick([e],this.gameChannelName,t),this.removeHumanPlayer(e))}sendObserverSlotInfo(){this.wolCon.sendObserverSlot(this.observerSlotIndex)}sendGameSlotInfo(){var e=this.gameOptSerializer.serializeSlotData(this.slotsInfo);this.wolCon.sendGameSlotsInfo(e)}sendPingData(){var e;this.playerPings.length&&(e=this.gameOptSerializer.serializePingData(this.playerPings),this.wolCon.sendPingData(e))}sendModeMaxSlots(){if(!this.hostMode)throw new Error("Must be in host mode");if(!this.slotsInfo)throw new Error("Slots info should be set by now");var e=this.gameChannelName;if(!e||!this.wolCon.isInChannel(e))throw new Error("Must be in a game channel");var t=this.slotsInfo.filter((e=>e.type!==n.SlotType.Closed&&e.type!==n.SlotType.Ai)).length;this.wolCon.sendModeChannelMax(e,t)}handlePlayerPing(e){var t,i=e.match(/^([A-Za-z0-9-_]+) [^:]+:\s+(\d+)/);i?([,t,i]=i,this.updatePlayerPing(t,Number(i)),this.sendPingData()):console.error("Unexpected ping response "+e)}updatePlayerPing(e,t){let i=this.playerPings.find((t=>t.playerName===e));i?i.ping=t:this.playerPings.push({ping:t,playerName:e})}handlePlayerOptsChange(e,t){var i=this.slotsInfo.findIndex((t=>t.type===n.SlotType.Player&&t.name===e));if(-1===i)throw new Error("Missing slot info for player "+e);let[r,s,o,l]=t.slice(1).split(",").map(Number);s=this.getSelectablePlayerColors().includes(this.getColorNameById(s))?s:this.gameOpts.humanPlayers.find((t=>t.name===e)).colorId,o=this.getSelectableStartPositions().includes(o)?o:this.gameOpts.humanPlayers.find((t=>t.name===e)).startPos;var c=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;l=!c.alliesAllowed||l===a.NO_TEAM_ID&&c.mustAlly?c.mustAlly?0:a.NO_TEAM_ID:l,r===a.OBS_COUNTRY_ID||i!==this.observerSlotIndex?(this.updatePlayerInfo(e,r,s,o,l,this.gameOpts.hostTeams),this.sendGameOpts(),r===a.OBS_COUNTRY_ID&&((c=this.slotsInfo[this.observerSlotIndex]).type!==n.SlotType.OpenObserver?c.type===n.SlotType.Player&&c.name===e||(console.warn(`Player ${e} tried to move to an unavailable observer slot`),this.kickPlayer(e,"Bye")):(this.slotsInfo[this.observerSlotIndex]=this.slotsInfo[i],this.slotsInfo[i]={type:n.SlotType.Open},this.sendGameSlotInfo()))):this.kickPlayer(e,"Bye")}handleGameOptReady(e,t){if(this.slotsInfo&&-1===this.slotsInfo.findIndex((t=>t.type===n.SlotType.Player&&t.name===e)))throw new Error("Missing slot info for player "+e);this.playerReadyStatus.set(e,Boolean(Number(t))),this.hostMode||e!==this.wolCon.getCurrentUser()||this.refreshSidebarButtons(),this.hostMode&&![...this.playerReadyStatus.values()].filter((e=>!1===e)).length&&this.sound.play(v.SoundKey.OptionsChanged,b.ChannelType.Ui)}handleGameOptHasMap(e,t){if(this.slotsInfo&&-1===this.slotsInfo.findIndex((t=>t.type===n.SlotType.Player&&t.name===e)))throw new Error("Missing slot info for player "+e);let i=Number(t);Object.values(r.WolHasMapStatus).includes(i)||(i=r.WolHasMapStatus.NoMap),this.playerHasMapStatus.set(e,i),this.hostMode||e!==this.wolCon.getCurrentUser()?i!==r.WolHasMapStatus.HasMap&&this.gameOpts&&this.messages.push({text:i===r.WolHasMapStatus.MapTransfer?this.strings.get("GUI:HostMapTransfer",e,`"${this.gameOpts.mapTitle}"`):this.strings.get("GUI:HostNoMap",e,`"${this.gameOpts.mapTitle}"`)}):this.refreshSidebarButtons()}handleGameOptObserver(e){this.observerSlotIndex=Number(e)}handleGameOptSlots(e){this.slotsInfo=this.gameOptParser.parseSlotData(e)}handleGameOptPing(e){this.playerPings=this.gameOptParser.parsePingData(e)}handleGameOptOptions(e){var t,i;this.gameChannelName&&this.wolCon.isInChannel(this.gameChannelName)&&(i=(t=this.gameOptParser.parseOptions(e)).mapName!==this.gameOpts?.mapName||t.mapDigest!==this.gameOpts?.mapDigest,E.GameOptSanitizer.sanitize(t,this.rules),this.gameOpts=t,this.refreshSidebarMpText(),i&&this.wolCon.isOpen()&&(i=this.wolCon.getCurrentUser(),this.playerReadyStatus.set(i,!1),this.playerHasMapStatus.set(i,r.WolHasMapStatus.NoMap),this.refreshSidebarButtons(),this.wolCon.sendPlayerReady(!1),this.guestUpdateMapDeferred(t)))}guestUpdateMapDeferred(e){this.mapLoadTask?.cancel(),this.mapLoadTask=new i.Task((async t=>{this.controller.setSidebarPreview(),this.currentMapFile=void 0;var i,s,n=this.currentMapFile=await this.loadAndCheckMap(e);!t.isCancelled()&&this.wolCon.isOpen()&&(i=!n&&!e.mapOfficial&&e.mapSizeBytes<=M.MAX_MAP_TRANSFER_BYTES,s=n?r.WolHasMapStatus.HasMap:i?r.WolHasMapStatus.MapTransfer:r.WolHasMapStatus.NoMap,this.wolCon.sendPlayerHasMap(s),n?this.updateMapPreview(n):this.addSystemMessage(i?this.strings.get("GUI:JoinerMapTransfer",`"${e.mapTitle}"`):this.strings.get("GUI:JoinerNoMap",`"${e.mapTitle}"`)))})),this.mapLoadTask.start().catch((e=>{e instanceof f.OperationCanceledError||this.handleError(e,this.strings.get("TXT_DOWNLOAD_FAILED"))}))}updateMapPreview(e){try{var t=new y.MapPreviewRenderer(this.strings).render(new O.MapFile(e),this.hostMode?l.LobbyType.MultiplayerHost:l.LobbyType.MultiplayerGuest,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(t)}catch(e){console.error("Failed to render map preview"),console.error(e),this.controller.setSidebarPreview()}}async loadAndCheckMap(e){if(this.mapList.getByName(e.mapName)){let t=await this.mapFileLoader.load(e.mapName);return A.MapDigest.compute(t)===e.mapDigest&&t.getSize()===e.mapSizeBytes?t:void 0}}initLobbyForm(){var[e]=this.jsxRenderer.render(g.jsx(p.HtmlView,{innerRef:e=>this.lobbyForm=e,component:o.LobbyForm,props:this.formModel}));this.controller.setMainComponent(e)}refreshSidebarButtons(){let e=this.strings,t=this.playerReadyStatus.get(this.wolCon.getCurrentUser());var i=this.playerHasMapStatus.get(this.wolCon.getCurrentUser())??r.WolHasMapStatus.NoMap;i=[this.hostMode?{label:e.get("GUI:StartGame"),tooltip:e.get("STT:HostButtonGo"),disabled:!1,onClick:()=>{var e;this.wolCon.isOpen()&&(void 0!==(e=[...this.playerHasMapStatus].find((([,e])=>e===r.WolHasMapStatus.NoMap))?.[0])?this.addSystemMessage(this.strings.get("GUI:HostNoMap",e,`"${this.gameOpts.mapTitle}"`)):this.gameOpts.humanPlayers.filter((e=>e.countryId!==a.OBS_COUNTRY_ID)).length<2?this.addSystemMessage(this.strings.get("TXT_ONLY_ONE")):this.meetsMinimumTeams()?[...this.playerReadyStatus.values()].filter((e=>!1===e)).length?(this.addSystemMessage(this.strings.get("GUI:HostGameStartHost")),this.wolCon.sendGameStartRequest()):this.wolCon.startGame(this.gameOpts.humanPlayers.map((e=>e.name))):this.addSystemMessage(this.strings.get("TXT_CANNOT_ALLY")))}}:{label:t?e.get("GUI:NotReady"):e.get("GUI:Accept"),tooltip:t?e.get("STT:NotReady"):e.get("STT:GuestButtonAccept"),disabled:i===r.WolHasMapStatus.NoMap,onClick:()=>{this.wolCon.isOpen()&&(this.playerReadyStatus.set(this.wolCon.getCurrentUser(),!t),this.wolCon.sendPlayerReady(!t))}},...this.hostMode?[{label:e.get("GUI:ChooseMap"),tooltip:e.get("STT:HostButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(u.ScreenType.MapSelection,{lobbyType:this.hostMode?l.LobbyType.MultiplayerHost:l.LobbyType.MultiplayerGuest,gameOpts:this.gameOpts,usedSlots:()=>1+T.findIndexReverse(this.slotsInfo,((e,t)=>e.type===n.SlotType.Ai||e.type===n.SlotType.Player&&this.observerSlotIndex!==t))-(0===this.observerSlotIndex?1:0)})}}]:[],{label:e.get("GUI:Back"),tooltip:this.hostMode?e.get("STT:HostButtonBack"):e.get("STT:GuestButtonBack"),isBottom:!0,onClick:()=>{this.hostMode&&this.wolCon.isOpen()&&this.gameChannelName&&this.wolCon.leaveChannel(this.gameChannelName),this.controller?.goToScreen(u.ScreenType.CustomGame,{})}}];this.controller.setSidebarButtons(i,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let e=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(C.isNotNullOrUndefined).filter((e=>e.countryId!==a.OBS_COUNTRY_ID)),t=e[0].teamId;return t===a.NO_TEAM_ID||e.some((e=>e.teamId!==t))}refreshSidebarMpText(){this.controller.setSidebarMpText(this.gameOpts?this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+this.gameOpts.mapTitle:"")}async onLeave(){this.disposables.dispose(),this.mapLoadTask?.cancel(),this.mapLoadTask=void 0,this.ranksUpdateTask?.cancel(),this.ranksUpdateTask=void 0,this.pingsUpdateTask?.cancel(),this.pingsUpdateTask=void 0,this.currentMapFile=void 0,this.gameChannelName=void 0,this.hostPlayerName=void 0,this.hostRoomDesc="",this.gameOpts=void 0,this.preferredHostOpts=void 0,this.playerPings=this.slotsInfo=void 0,this.playerProfiles.clear(),this.hostOptsIntervalId&&clearInterval(this.hostOptsIntervalId),this.wolCon.onGameOpt.unsubscribe(this.handleGameOpt),this.wolCon.onGameStart.unsubscribe(this.handleGameStart),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelLeave),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoin),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},e("LobbyScreen",B)}}})),System.register("gui/screen/mainMenu/customGame/CustomGameScreen",["gui/screen/mainMenu/customGame/component/GameBrowser","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/SoundKey","engine/sound/ChannelType","engine/sound/Music","network/IrcConnection","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError","network/WLadderConnection","gui/screen/mainMenu/MainMenuRoute","network/chat/ChatMessage","gui/chat/ChatHistory"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){T=class extends u.MainMenuScreen{constructor(e,t,i,r,n,a,h,u,d,g){super(),this.engineModHash=e,this.strings=t,this.wolCon=i,this.wolService=r,this.wladderService=n,this.jsxRenderer=a,this.sound=h,this.serverRegions=u,this.mapList=d,this.errorHandler=g,this.title=this.strings.get("GUI:CustomMatch"),this.musicType=c.MusicType.NormalShuffle,this.pings=new Map,this.playerProfiles=new Map,this.ignoreCmdReplies=!1,this.needsOperatorsRefresh=!1,this.operatorStatuses=new Map,this.disposables=new s.CompositeDisposable,this.onChannelJoinLeave=e=>{let t=e.channel,i=t.match(/#Lob \d+ (\d)/i);if(i&&([,r]=i.map(Number),t=this.strings.get("TXT_LOB_"+(r+1))),e.user.name===this.wolCon.getCurrentUser())this.addSystemMessage(this.strings.get("join"===e.type?"TXT_JOINED_S":"TXT_YOULEFT",t));else if(e.channel===this.channelName){if("join"===e.type){let t;this.wolV2Compat?(t=!1,this.operatorStatuses.has(e.user.name)?t=this.operatorStatuses.get(e.user.name):this.needsOperatorsRefresh=!0):t=e.user.operator,this.users.push({name:e.user.name,operator:t}),this.users.sort(((e,t)=>Number(t.operator)-Number(e.operator)))}else{var r=this.users.findIndex((t=>t.name===e.user.name));-1!==r&&(this.users.splice(r,1),this.pings.delete(e.user.name))}this.gameBrowser?.refresh()}},this.onChannelMessage=e=>{if(this.wolV2Compat){if(this.ignoreCmdReplies&&"/con"===e.text)return;if(this.ignoreCmdReplies&&e.to.type===f.ChatRecipientType.Page&&e.from===this.wolCon.getServerName()&&e.text.match(/^[^:]+:$|^\s*-\w+\s+-\w+\s+-----|^\s*wol|^\s*UNKNOW/))return void this.handleUserPingUpdate(e.text)}e.to.type!==f.ChatRecipientType.Page&&e.to.type!==f.ChatRecipientType.Whisper||this.sound.play(o.SoundKey.IncomingMessage,l.ChannelType.Ui);var t={...e,operator:this.users.find((t=>t.name===e.from))?.operator};this.messages.push(t),this.gameBrowser?.refresh(),e.to.type===f.ChatRecipientType.Whisper&&e.to.name!==this.wolCon.getServerName()&&e.from!==this.wolCon.getCurrentUser()&&(this.chatHistory.lastWhisperFrom.value=e.from)},this.onWolClose=()=>{clearInterval(this.refreshTimeoutId)},this.onWolConLost=e=>{this.handleError(e,this.strings.get("TXT_YOURE_DISCON"))},this.wolV2Compat=this.wolService.getConfig().getWolV2Compat()}addSystemMessage(e){this.messages.push({text:e}),this.gameBrowser?.refresh()}handleUserPingUpdate(e){var t,i=e.match(/^\s+wol\s+\w+\s+"?([^\s"]+)"?\s+(\d+)/);i&&(t=i[1],i=Number(i[2]),this.pings.set(t,i),this.gameBrowser?.applyOptions((e=>e.pings=this.pings)))}async refreshGames(){if(this.wolCon.isOpen()){if(this.channelName&&this.wolCon.isInChannel(this.channelName)&&this.wolCon.getCurrentUser()){let t;this.wolV2Compat&&(this.ignoreCmdReplies=!0,this.wolCon.privmsg([this.channelName],"/con"));try{var e=this.wolService.getConfig().getClientChannelType();t=await this.wolCon.listGames(e,e)}catch(e){if(e instanceof h.IrcConnection.SocketError)return;if(e instanceof h.IrcConnection.NoReplyError)return;throw e}t.sort(((e,t)=>Number(e.passLocked)-Number(t.passLocked))),this.games=t;const i=this.selectedGame;i&&this.onGameSelectionChange(t.find((e=>e.name===i.name))),this.gameBrowser?.applyOptions((e=>e.games=t)),this.refreshPlayerRanks(),this.refreshOperatorStatuses()}}else this.onWolClose()}refreshPlayerRanks(){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let e=this.ranksUpdateTask=new d.Task((async e=>{let t=[...new Set([...this.users.map((e=>e.name)),...this.games.map((e=>e.hostName))])].filter((e=>!this.playerProfiles.has(e)));if(t.length){for(;0<t.length;){var i,r=t.splice(0,p.WLadderConnection.MAX_LIST_SEARCH_COUNT);r=await this.wladderService.listSearch(r,e);if(e.isCancelled())return;for(i of r)this.playerProfiles.set(i.name,i)}this.gameBrowser?.refresh()}}));e.start().catch((e=>{e instanceof g.OperationCanceledError||console.error(e)}))}}refreshOperatorStatuses(){this.needsOperatorsRefresh&&(this.needsOperatorsRefresh=!1,this.operatorsUpdateTask?.cancel(),this.operatorsUpdateTask=new d.Task((async e=>{if(this.channelName&&this.wolCon.isInChannel(this.channelName)){var t=await this.wolCon.listUsers(this.channelName);if(!e.isCancelled()){for(let e of t){let t=this.users.find((t=>t.name===e.name));if(t){var i=t.operator!==e.operator;if(t.operator=e.operator,i)for(var r of this.messages)r.from===t.name&&(r.operator=e.operator)}this.operatorStatuses.set(e.name,e.operator)}this.gameBrowser?.refresh()}}})),this.operatorsUpdateTask.start().catch((e=>{e instanceof g.OperationCanceledError||console.error(e)})))}onGameSelectionChange(e){this.selectedGame=e,this.refreshSidebarButtons()}gameIsFull(e){return e.humanPlayers+e.aiPlayers===e.maxPlayers-(e.observable?1:0)}refreshSidebarButtons(){let e=this.selectedGame;var t=[{label:this.strings.get("GUI:CreateGame"),tooltip:this.strings.get("STT:LobbyButtonNew"),onClick:()=>this.createGame()},{label:this.strings.get("GUI:JoinGame"),tooltip:this.strings.get("STT:LobbyButtonJoin"),disabled:!e||this.gameIsFull(e),onClick:()=>this.joinGame(e)},{label:this.strings.get("GUI:Observe"),tooltip:this.strings.get("STT:LobbyButtonObserve"),disabled:!e||!e.observable||!!e.observers,onClick:()=>{this.observeGame(e)}},...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(r.ScreenType.Login,{clearCredentials:!0,afterLogin:e=>new m.MainMenuRoute(r.ScreenType.CustomGame,{messages:e})})}}]:[],{label:this.strings.get("GUI:Back"),tooltip:this.strings.get("STT:LobbyButtonBack"),isBottom:!0,onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(r.ScreenType.Home)}}];this.controller.setSidebarButtons(t)}initView(){var[e]=this.jsxRenderer.render(n.jsx(a.HtmlView,{innerRef:e=>this.gameBrowser=e,component:i.GameBrowser,props:{strings:this.strings,messages:this.messages,chatHistory:this.chatHistory,channels:[this.channelName],localUsername:this.wolCon.getCurrentUser(),users:this.users,games:this.games,pings:this.pings,playerProfiles:this.playerProfiles,mapList:this.mapList,onSendMessage:e=>{e.value.length?(this.wolV2Compat&&e.value.startsWith("/")&&(this.ignoreCmdReplies=!1),this.wolCon.isOpen()&&(this.wolCon.sendChatMessage(e.value,e.recipient),e.recipient.type===f.ChatRecipientType.Whisper&&(this.chatHistory.lastWhisperTo.value=e.recipient.name))):this.addSystemMessage(this.strings.get("TXT_ENTER_MESSAGE"))},onRefreshClick:()=>this.refreshGames(),onSelectGame:e=>this.onGameSelectionChange(e),onDoubleClickGame:e=>{this.gameIsFull(e)||this.joinGame(e)}}}));this.controller.setMainComponent(e),this.refreshSidebarButtons(),this.controller.showSidebarButtons()}async onEnter(e){this.messages=e?.messages??[],this.chatHistory=new y.ChatHistory,this.controller.toggleMainVideo(!1),this.wolCon.getCurrentUser()?await this.loadChannel():this.controller.goToScreen(r.ScreenType.Login,{afterLogin:e=>new m.MainMenuRoute(r.ScreenType.CustomGame,{messages:e})})}async loadChannel(){this.channelName=void 0,this.users=[],this.games=[],this.selectedGame=void 0,this.wolCon.onJoinChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.subscribe(this.onChannelJoinLeave),this.wolCon.onChatMessage.subscribe(this.onChannelMessage),this.wolCon.onClose.subscribe(this.onWolClose),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost);try{let t=this.wolService.getConfig();var e=`#Lob ${t.getClientChannelType()} 0`;this.users=await this.wolCon.joinChannel(e,t.getGlobalChannelPass()),this.channelName=e,this.wolV2Compat&&(this.operatorStatuses.clear(),this.users.forEach((e=>this.operatorStatuses.set(e.name,e.operator)))),this.pings.clear(),this.playerProfiles.clear(),this.initView(),this.gameBrowser?.applyOptions((e=>e.users=this.users)),this.refreshGames(),this.refreshTimeoutId=setInterval((()=>this.refreshGames()),5e3)}catch(e){return void this.handleError(e,this.strings.get("WOL:MatchBadParameters"))}}async onLeave(){this.disposables.dispose(),this.refreshTimeoutId&&clearInterval(this.refreshTimeoutId),this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),this.operatorsUpdateTask&&(this.operatorsUpdateTask.cancel(),this.operatorsUpdateTask=void 0),this.wolCon.isOpen()&&this.channelName&&this.wolCon.leaveChannel(this.channelName),this.wolCon.onJoinChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onLeaveChannel.unsubscribe(this.onChannelJoinLeave),this.wolCon.onChatMessage.unsubscribe(this.onChannelMessage),this.wolCon.onClose.unsubscribe(this.onWolClose),this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost),await this.controller.hideSidebarButtons(),this.channelName=void 0,this.gameBrowser=void 0,this.messages=[],this.users=[],this.pings.clear(),this.playerProfiles.clear(),this.operatorStatuses.clear(),this.needsOperatorsRefresh=!1,this.games=[],this.selectedGame=void 0}async createGame(){this.controller.goToScreen(r.ScreenType.Lobby,{create:!0})}async joinGame(e){this.joinRoom(e,!1)}observeGame(e){this.joinRoom(e,!0)}joinRoom(e,t){e.modHash===this.engineModHash?this.controller.goToScreen(r.ScreenType.Lobby,{game:e,observe:t}):void 0!==e.modHash&&this.addSystemMessage(this.strings.get("TXT_MISMATCH"))}handleError(e,t){this.errorHandler.handle(e,t,(()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(r.ScreenType.Home)})),clearInterval(this.refreshTimeoutId)}},e("CustomGameScreen",T)}}})),System.register("gui/screen/mainMenu/ladder/component/Ladder",["react","classnames","gui/screen/mainMenu/lobby/component/RankIndicator","gui/component/Select","gui/component/Option"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("Ladder",(({players:e,highlightPlayer:t,hasPrevPage:o,hasNextPage:l,seasons:c,selectedSeason:h,disabled:u,strings:d,onFirstPageClick:g,onPrevPageClick:p,onNextPageClick:m,onPlayerSearch:f,onSeasonSelect:y})=>{if(!e)return i.createElement("div",{className:"ladder"},d.get("GUI:LoadingEx"));const T=i.useRef(null);return i.createElement("div",{className:"ladder"},i.createElement("table",null,i.createElement("thead",null,i.createElement("tr",null,i.createElement("th",{className:"player-rank"},"#"),i.createElement("th",{className:"player-rank-icon"},d.get("GUI:Rank")),i.createElement("th",{className:"player-name"},d.get("GUI:Name")),i.createElement("th",{className:"player-points"},d.get("GUI:Points")),i.createElement("th",{className:"player-wins"},d.get("GUI:NumberWins")),i.createElement("th",{className:"player-losses"},d.get("GUI:NumberLosses")))),i.createElement("tbody",null,e.map((e=>i.createElement("tr",{key:e.name,className:r.default({selected:t?.toLowerCase()===e.name.toLowerCase(),disabled:!(e.points||e.wins||e.losses||e.disconnects)})},i.createElement("td",{className:"player-rank"},e.rank),i.createElement("td",{className:"player-rank-icon"},i.createElement(s.RankIndicator,{playerProfile:e,strings:d})),i.createElement("td",{className:"player-name"},e.name),i.createElement("td",{className:"player-points"},e.points),i.createElement("td",{className:"player-wins"},e.wins),i.createElement("td",{className:"player-losses"},(e.losses??0)+(e.disconnects??0))))))),i.createElement("div",{className:"pagination"},c?.length&&i.createElement(n.Select,{disabled:u,initialValue:h??c[0].value,onSelect:y,className:"ladder-select"},c.map((e=>i.createElement(a.Option,{key:e.value,label:e.label,value:e.value})))),i.createElement("button",{className:"first-page",disabled:!o||u,onClick:g},"<<"),i.createElement("button",{className:"prev-page",disabled:!o||u,onClick:p},"<"),i.createElement("button",{className:"next-page",disabled:!l||u,onClick:m},">"),i.createElement("form",{className:"player-search",onSubmit:e=>{e.preventDefault(),T.current?.value&&(f(T.current.value),T.current.value="")}},i.createElement("input",{className:"player",type:"text",disabled:u,ref:T,placeholder:d.get("GUI:Player")}),i.createElement("button",{type:"submit",disabled:u},d.get("GUI:Search")))))}))}}})),System.register("gui/screen/mainMenu/ladder/LadderScreen",["@puzzl/core/lib/async/cancellation","@puzzl/core/lib/async/Task","gui/jsx/HtmlView","gui/jsx/jsx","network/WLadderService","util/disposable/CompositeDisposable","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ladder/component/Ladder"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class e extends l.MainMenuScreen{constructor(e,t,i,r){super(),this.wladderService=e,this.jsxRenderer=t,this.errorHandler=i,this.strings=r,this.title=this.strings.get("GUI:Ladder"),this.disposables=new o.CompositeDisposable}async onEnter(e){this.params=e,this.ladder=void 0,this.isBusy=!1,this.season=a.WLadderService.CURRENT_SEASON,this.highlightPlayer=e.highlightPlayer?.name,this.startIndex=this.computePageStartIndex(e.highlightPlayer),this.initSidebar(),this.initView();try{await this.fetchInitial(e.ladderType,this.season,this.startIndex)}catch(e){e instanceof i.OperationCanceledError||this.handleError(e,this.strings.get("TS:DownloadFailed"),{fatal:!0})}}computePageStartIndex(t){let i=1;return void 0!==t?.rank&&(i+=Math.floor((t.rank-1)/e.PLAYERS_PER_PAGE)*e.PLAYERS_PER_PAGE),i}initSidebar(){this.controller?.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}]),this.controller?.showSidebarButtons()}async fetchInitial(t,i,r){await this.runTaskAsync((async s=>{let n=await this.wladderService.getSeasons(t,s);var o=await this.wladderService.rungSearch(r,e.PLAYERS_PER_PAGE+1,s,t,i);s.isCancelled()||(this.updateView(o,r),1<n.length&&this.ladder?.applyOptions((e=>{e.seasons=n.map((e=>({value:e,label:e===a.WLadderService.CURRENT_SEASON?this.strings.get("GUI:LadderCurrent"):e===a.WLadderService.PREV_SEASON?this.strings.get("GUI:LadderPrev"):this.strings.get("GUI:LadderSeason",e)})))})))}))}fetchLadder(t){this.runTaskAsync((async i=>{var r=await this.wladderService.rungSearch(t,e.PLAYERS_PER_PAGE+1,i,this.params.ladderType,this.season);i.isCancelled()||this.updateView(r,t)})).catch((e=>{e instanceof i.OperationCanceledError||this.handleError(e,this.strings.get("TS:DownloadFailed"))}))}async runTaskAsync(e){this.asyncTask?.cancel();let t=this.asyncTask=new r.Task(e);try{this.isBusy=!0,this.ladder?.applyOptions((e=>e.disabled=!0)),await t.start()}finally{this.isBusy=!1,this.ladder?.applyOptions((e=>e.disabled=!1))}return t}searchPlayer(t){this.runTaskAsync((async i=>{var[r]=await this.wladderService.listSearch([t],i,this.params.ladderType,this.season);r&&!i.isCancelled()&&(this.startIndex=this.computePageStartIndex(r),r=await this.wladderService.rungSearch(this.startIndex,e.PLAYERS_PER_PAGE+1,i,this.params.ladderType,this.season),i.isCancelled()||this.updateView(r,this.startIndex,t))})).catch((e=>{e instanceof i.OperationCanceledError||this.handleError(e,this.strings.get("TS:DownloadFailed"))}))}initView(){var[t]=this.jsxRenderer.render(n.jsx(s.HtmlView,{component:c.Ladder,innerRef:e=>this.ladder=e,props:{players:void 0,highlightPlayer:this.params.highlightPlayer?.name,hasPrevPage:!1,hasNextPage:!1,seasons:void 0,selectedSeason:this.season,strings:this.strings,disabled:this.isBusy,onFirstPageClick:()=>{this.ladder&&this.fetchLadder(1)},onPrevPageClick:()=>{this.ladder&&this.fetchLadder(Math.max(1,this.startIndex-e.PLAYERS_PER_PAGE))},onNextPageClick:()=>{this.ladder&&this.fetchLadder(this.startIndex+e.PLAYERS_PER_PAGE)},onPlayerSearch:e=>{this.ladder&&this.searchPlayer(e)},onSeasonSelect:e=>{this.season=e,this.ladder&&(this.highlightPlayer?this.searchPlayer(this.highlightPlayer):this.fetchLadder(1))}}}));this.controller?.setMainComponent(t)}updateView(t,i,r){this.startIndex=i,this.highlightPlayer=r,this.ladder?.applyOptions((s=>{r&&(s.highlightPlayer=r),s.players=t.slice(0,e.PLAYERS_PER_PAGE),s.hasPrevPage=1<i,s.hasNextPage=t.length>e.PLAYERS_PER_PAGE}))}handleError(e,t,{fatal:i}={}){this.errorHandler.handle(e,t,(()=>{i&&this.controller?.popScreen()}))}async onLeave(){this.disposables.dispose(),this.ladder=void 0,this.asyncTask&&(this.asyncTask.cancel(),this.asyncTask=void 0),await(this.controller?.hideSidebarButtons())}},e("LadderScreen",h),h.PLAYERS_PER_PAGE=20}}})),System.register("gui/screen/mainMenu/login/ServerPingIndicator",["react","classnames","gui/component/Image"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){var t;(t=n=n||{})[t.Good=1]="Good",t[t.Average=2]="Average",t[t.Bad=3]="Bad",a=e=>e<=100?n.Good:e<=250?n.Average:n.Bad,o=(new Map).set(n.Bad,"pingr").set(n.Average,"pingy").set(n.Good,"pingg"),l=(new Map).set(n.Bad,"ping-bad").set(n.Average,"ping-avg").set(n.Good,"ping-good"),e("ServerPingIndicator",(({ping:e,strings:t})=>{var n=a(e);return i.default.createElement("div",{className:"server-ping"},i.default.createElement("span",{className:r.default("ping-text",l.get(n))},t.get("TS:PingValue",e)),i.default.createElement(s.Image,{src:o.get(n)+".pcx"}))}))}}})),System.register("gui/screen/mainMenu/login/ServerList",["gui/component/List","react","gui/screen/mainMenu/login/ServerPingIndicator"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("ServerList",(({regionId:e,regions:t,pings:n,strings:a,onChange:o})=>r.default.createElement(i.List,{className:"server-list"},t.map((t=>{var l=n.get(t);let c=!t.available||n.has(t)&&void 0===l;return r.default.createElement(i.ListItem,{key:t.id,selected:t.id===e&&!c,disabled:c,onClick:()=>!c&&o(t.id)},r.default.createElement("span",{className:"label"},t.label),r.default.createElement("span",{className:"ping"},c?r.default.createElement("span",{className:"offline-text"},a.get("TS:ServerOffline")):void 0!==l&&r.default.createElement(s.ServerPingIndicator,{ping:l,strings:a})))})))))}}})),System.register("gui/screen/mainMenu/login/LoginBox",["react","gui/screen/mainMenu/login/ServerList","@puzzl/core/lib/async/Task","network/HttpRequest"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=({regions:e,selectedRegion:t,selectedUser:a,pings:o,breakingNewsUrl:l,strings:c,onRegionChange:h,onRequestRegionRefresh:u,onSubmit:d},g)=>{let p=i.useRef(null),m=i.useRef(null),[f,y]=i.useState();return i.useEffect((()=>{setTimeout((()=>p.current?.focus()),50)}),[]),i.useEffect((()=>{if(l){let e=new s.Task((async e=>{let t=await(new n.HttpRequest).fetchHtml(l,e);t=t.trim(),t.length&&y(t)}));return e.start().catch((e=>console.error(e))),()=>e.cancel()}}),[l]),i.useImperativeHandle(g,(()=>({getValues:()=>({user:p.current.value,pass:m.current.value})}))),i.default.createElement("div",{className:"login-wrapper"},i.default.createElement("div",{className:"title"},c.get("GUI:Login")),i.default.createElement("form",{onSubmit:e=>{e.preventDefault(),d()},className:"login-form login-box"},i.default.createElement("div",{className:"field"},i.default.createElement("label",null,c.get("TS:ServerLabel")),a&&t?i.default.createElement("input",{type:"text",value:t.label,readOnly:!0}):i.default.createElement(i.default.Fragment,null,i.default.createElement(r.ServerList,{regionId:t?.id,regions:e,pings:o,strings:c,onChange:e=>{h(e)}}),i.default.createElement("button",{type:"button",className:"icon-button refresh-button",onClick:u}))),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,c.get("GUI:Nickname")),i.default.createElement("input",{name:"user",type:"text",maxLength:15,ref:p,value:a,readOnly:!!a})),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,c.get("GUI:Password")),i.default.createElement("input",{name:"pass",type:"password",maxLength:8,ref:m})),i.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})),f&&i.default.createElement("fieldset",{className:"news"},i.default.createElement("legend",null,c.get("GUI:BreakingNews")),i.default.createElement("div",{dangerouslySetInnerHTML:{__html:f}})))},e("LoginBox",i.forwardRef(a))}}})),System.register("gui/screen/mainMenu/login/ServerPings",["network/WolConnection"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ServerPings",r=class e{constructor(e,t,i){this.regions=e,this.wolConfig=t,this.netLogger=i,this.pings=new Map}async update(t,r){await Promise.all(this.regions.getAll().filter((e=>e.available)).map((async s=>{let n,a=i.WolConnection.factory(this.netLogger),o=setTimeout((()=>a.close()),e.CONNECT_TIMEOUT);r?.register((()=>{clearTimeout(o),a.close()}));try{if(await a.connect(s.wolUrl,this.wolConfig.getWolV2Compat(),s.wolv2Ascii),r?.isCancelled())return}catch(o){return console.error(o),a.close(),r?.isCancelled()||this.pings.set(s,void 0),void t?.()}finally{clearTimeout(o)}try{n=await a.ping(5)}catch(o){console.error(o)}finally{a.close()}r?.isCancelled()||(this.pings.set(s,n),t?.())})))}}),r.CONNECT_TIMEOUT=5e3}}})),System.register("network/gservCodes",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RPL_CVERS_OK",10),e("RPL_CVERS_OUTDATED",11),e("RPL_CVERS_MISSING",12),e("RPL_LOGGED_IN",100),e("RPL_ALREADY_LOGGED_IN",101),e("RPL_NOT_LOGGED_IN",102),e("RPL_BAD_LOGIN",103),e("RPL_TOO_MANY_LOGIN_ATTEMPTS",104),e("RPL_INSTANCE_CREATED",200),e("RPL_INSTANCE_EXISTS",201),e("RPL_INSTANCE_TOO_MANY",202),e("RPL_NOT_ENOUGH_PARAMS",300),e("RPL_INVALID_PARAMS",301),e("RPL_RATE_LIMIT_EXCEEDED",302),e("RPL_INSTANCE_CONNECTED",400),e("RPL_INSTANCE_NONEXISTENT",401),e("RPL_INSTANCE_NOT_ALLOWED",402),e("RPL_INSTANCE_ALREADY_STARTED",403),e("RPL_NO_INSTANCE",404),e("RPL_INSTANCE_NOT_RUNNING",405),e("RPL_INSTANCE_VERS_MISMATCH",406),e("RPL_GAME_OPTS",500),e("RPL_LOAD_INFO",600),e("RPL_MAP_TOO_BIG",602),e("RPL_MAP_ALREADY_SENT",603),e("RPL_GAME_START",700),e("RPL_GAME_DESYNC",801),e("RPL_NET_RATE",802),e("RPL_TAUNT",803),e("RPL_PLAYER_DISCONNECT",804),e("RPL_BIN_PREFIX",2),e("RPL_BIN_GAME_ACTIONS",1),e("RPL_BIN_MAP_DATA",2),e("REQ_BIN_PREFIX",2),e("REQ_BIN_GAME_ACTIONS",1),e("REQ_BIN_GAME_STATE_HASH",2),e("REQ_BIN_PUT_MAP",3),e("REQ_BIN_GET_MAP",4)}}})),System.register("network/GservError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;i=class extends Error{constructor(e,t){super(e),this.code=t}},e("GservError",i),(t=(t=i=i||{}).Code||(t.Code={}))[t.Unknown=0]="Unknown",t[t.OutdatedClient=1]="OutdatedClient",t[t.BadLogin=2]="BadLogin",t[t.TooManyLoginAttempts=3]="TooManyLoginAttempts",t[t.AlreadyLoggedIn=4]="AlreadyLoggedIn",t[t.InstanceNonExistent=5]="InstanceNonExistent",t[t.InstanceAlreadyExists=6]="InstanceAlreadyExists",t[t.InstanceNotAllowed=7]="InstanceNotAllowed",t[t.InstanceAlreadyStarted=8]="InstanceAlreadyStarted",t[t.InstanceVersMismatch=9]="InstanceVersMismatch",t[t.CreatedTooManyInstances=10]="CreatedTooManyInstances",e("GservError",i)}}})),System.register("network/GservConnection",["util/event","data/DataStream","network/IrcConnection","network/gservCodes","network/GservError","network/gservConfig","network/gameopt/Parser","network/gameopt/Serializer","network/Apgar","network/chat/ChatMessage"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=new Map([[n.RPL_BAD_LOGIN,a.GservError.Code.BadLogin],[n.RPL_TOO_MANY_LOGIN_ATTEMPTS,a.GservError.Code.TooManyLoginAttempts],[n.RPL_ALREADY_LOGGED_IN,a.GservError.Code.AlreadyLoggedIn],[n.RPL_INSTANCE_EXISTS,a.GservError.Code.InstanceAlreadyExists],[n.RPL_INSTANCE_TOO_MANY,a.GservError.Code.CreatedTooManyInstances],[n.RPL_INSTANCE_NONEXISTENT,a.GservError.Code.InstanceNonExistent],[n.RPL_INSTANCE_NOT_ALLOWED,a.GservError.Code.InstanceNotAllowed],[n.RPL_INSTANCE_ALREADY_STARTED,a.GservError.Code.InstanceAlreadyStarted],[n.RPL_INSTANCE_VERS_MISMATCH,a.GservError.Code.InstanceVersMismatch]]),e("GservConnection",class{constructor(e){this._onLoadInfo=new i.EventDispatcher,this._onGameStart=new i.EventDispatcher,this._onGameActions=new i.EventDispatcher,this._onGameDesync=new i.EventDispatcher,this._onRateChange=new i.EventDispatcher,this._onChatMessage=new i.EventDispatcher,this._onTaunt=new i.EventDispatcher,this._onPlayerDisconnect=new i.EventDispatcher,this.handleMessage=e=>{if("string"==typeof e){let r=e.split(" ");var t,i;"ping"===r[0]?this.isOpen()&&this.con.sendMessage("pong"+(r[1]?" "+r[1]:"")):"privmsg"===r[1].toLowerCase()?this.handlePrivMsg(e):r[1]===""+n.RPL_LOAD_INFO?this.handleLoadInfo(r[3]):r[1]===""+n.RPL_GAME_START?this.handleGameStart():r[1]===""+n.RPL_GAME_DESYNC?this._onGameDesync.dispatch(this):r[1]===""+n.RPL_NET_RATE?([t,i]=r[3].slice(1).split(","),this._onRateChange.dispatch(this,{rate:Number(t),turnNo:Number(i)})):r[1]===""+n.RPL_TAUNT?this._onTaunt.dispatch(this,{from:r[0].replace(/^:/,""),tauntNo:Number(r[3].replace(/^:/,""))}):r[1]===""+n.RPL_PLAYER_DISCONNECT&&this._onPlayerDisconnect.dispatch(this,r[3].replace(/^:/,""))}else e[0]===n.RPL_BIN_GAME_ACTIONS&&this.handlePlayerActions(e.slice(1))},this.con=e}get onError(){return this.con.onError}get onClose(){return this.con.onClose}get onLoadInfo(){return this._onLoadInfo.asEvent()}get onGameStart(){return this._onGameStart.asEvent()}get onGameActions(){return this._onGameActions.asEvent()}get onGameDesync(){return this._onGameDesync.asEvent()}get onRateChange(){return this._onRateChange.asEvent()}get onChatMessage(){return this._onChatMessage.asEvent()}get onTaunt(){return this._onTaunt.asEvent()}get onPlayerDisconnect(){return this._onPlayerDisconnect.asEvent()}static factory(e){return new this(new s.IrcConnection({mode:"text",binaryRplPrefix:n.RPL_BIN_PREFIX,binaryReqPrefix:n.REQ_BIN_PREFIX},e))}getCurrentUser(){return this.currentUser}getServerName(){return this.serverName}async connect(e){return this.con.onMessage.subscribe(this.handleMessage),await this.con.connect(e)}close(){this.con.onMessage.unsubscribe(this.handleMessage),this.con.close(),this.currentUser=void 0}isOpen(){return this.con.isOpen()}async cvers(e){let t=await this.con.sendCommand(`cvers ${e} `+o.API_VERSION,{replyCodes:[n.RPL_CVERS_OK,n.RPL_CVERS_OUTDATED]});if(t[0].code===n.RPL_CVERS_OUTDATED){var i=t[0].params?t[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new a.GservError("Cvers error: "+i,a.GservError.Code.OutdatedClient)}}async login(e,t){let i=await this.con.sendCommand(`user ${e} `+h.Apgar.encode(t),{replyCodes:[n.RPL_LOGGED_IN,n.RPL_BAD_LOGIN,n.RPL_TOO_MANY_LOGIN_ATTEMPTS,n.RPL_ALREADY_LOGGED_IN]});if(i[0].code!==n.RPL_LOGGED_IN){var r=d.get(i[0].code)??a.GservError.Code.Unknown,s=i[0].params?i[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new a.GservError("Login error: "+s,r)}this.currentUser=e,this.serverName=i[0].raw.match(/^:([^\s]+)/)?.[1]||""}async createGame(e,t,i,r,s){if(i.includes(" "))throw new Error("Game opts string cannot include spaces");let o=await this.con.sendCommand(`create ${e} ${t} ${i} ${r} `+s,{replyCodes:[n.RPL_INSTANCE_CREATED,n.RPL_INSTANCE_EXISTS,n.RPL_INSTANCE_TOO_MANY,n.RPL_INSTANCE_NOT_ALLOWED]});if(o[0].code!==n.RPL_INSTANCE_CREATED){var l=d.get(o[0].code)??a.GservError.Code.Unknown,c=o[0].params?o[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new a.GservError("Create error: "+c,l)}}async joinGame(e,t,i){let r=await this.con.sendCommand(`join ${e} ${t} `+i,{replyCodes:[n.RPL_INSTANCE_CONNECTED,n.RPL_INSTANCE_NONEXISTENT,n.RPL_INSTANCE_NOT_ALLOWED,n.RPL_INSTANCE_ALREADY_STARTED,n.RPL_INSTANCE_VERS_MISMATCH]});if(r[0].code!==n.RPL_INSTANCE_CONNECTED){var s=d.get(r[0].code)??a.GservError.Code.Unknown,o=r[0].params?r[0].params.splice(1).join(" ").replace(/^:/,""):"unknown";throw new a.GservError("Join error: "+o,s)}}async gameOpts(){let e=await this.con.sendCommand("gameopts",{replyCodes:[n.RPL_GAME_OPTS]});if(!e[0].params)throw new Error("Unexpected server reply for getopts command. Missing params.");return e[0].params.splice(1).join(" ").replace(/^:/,"")}sendLoadedPercent(e){this.con.sendMessage("loaded "+e)}requestLoadInfo(){this.con.sendMessage("loadinfo")}sendGameStateHash(e,t){let i=new r.DataStream(10);i.dynamicSize=!1,i.writeUint8(n.REQ_BIN_PREFIX),i.writeUint8(n.REQ_BIN_GAME_STATE_HASH),i.writeUint32(e),i.writeUint32(t),this.con.sendMessage(i.toUint8Array())}sendPlayerActive(e){this.con.sendMessage("active "+(e?1:0))}sendTaunt(e){this.con.sendMessage("taunt "+e)}async ping(e){return await this.con.ping(e)}sendPlayerActions(e,t){let i=new r.DataStream(6);i.writeUint8(n.REQ_BIN_PREFIX),i.writeUint8(n.REQ_BIN_GAME_ACTIONS),i.writeUint32(e),i.writeUint8Array(t),this.con.sendMessage(i.toUint8Array())}sendMap(e){let t=new r.DataStream(2);t.writeUint8(n.REQ_BIN_PREFIX),t.writeUint8(n.REQ_BIN_PUT_MAP),t.writeUint8Array((new c.Serializer).serializeMapData(e)),this.con.sendMessage(t.toUint8Array())}async getMap(){let e=new r.DataStream(2);e.dynamicSize=!1,e.writeUint8(n.REQ_BIN_PREFIX),e.writeUint8(n.REQ_BIN_GET_MAP);var t=await this.con.sendBinCommand(e.toUint8Array(),{replyCodes:[n.RPL_BIN_MAP_DATA],timeout:15});return(new l.Parser).parseMapData(t.data)}handleLoadInfo(e){this._onLoadInfo.dispatch(this,e.replace(/^:/,""))}handleGameStart(){this._onGameStart.dispatch(this,void 0)}handlePlayerActions(e){this._onGameActions.dispatch(this,e)}sayChannel(e){this.privmsg([o.RECIPIENT_ALL],e)}privmsg(e,t){if(!this.currentUser)throw new Error("Must login before sending messages");var i;t.length&&(i=e.join(","),this.con.sendMessage(`privmsg ${i} :`+t))}handlePrivMsg(e){var t;if(!(t=e.match(/^:([A-Za-z0-9-_]+) PRIVMSG ([A-Za-z0-9-_#']+) :(.*)/i)))throw new Error(`Unexpected PRIVMSG message format "${e}"`);var[,i,r,t]=t;let s;r===o.RECIPIENT_ALL?s={from:i,to:{type:u.ChatRecipientType.Channel,name:r},text:t}:r===this.currentUser&&(s={from:i,to:i===this.getServerName()?{type:u.ChatRecipientType.Page,name:r}:{type:u.ChatRecipientType.Channel,name:o.RECIPIENT_TEAM},text:t}),s&&this._onChatMessage.dispatch(this,s)}})}}})),System.register("game/action/NoAction",["game/action/Action","game/action/ActionType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.Action{constructor(){super(r.ActionType.NoAction)}process(){}},e("NoAction",s)}}})),System.register("network/gamestate/ActionSerializer",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ActionSerializer",class{getActionPayload(e){return{id:e.actionType,params:e.serialize()}}})}}})),System.register("game/GameTurnManager",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gamestate/ReplayRecorder",["game/action/ActionType","network/gamestate/replay/TurnActionsReplayEvent","network/gameopt/Parser","network/gameopt/Serializer","network/gamestate/replay/ChatMessageReplayEvent","network/gamestate/replay/TauntReplayEvent"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("ReplayRecorder",class{constructor(e,t,i,r){this.replay=e,this.playerId=t,this.humanPlayers=i,this.actionSerializer=r}recordActions(e,t){if(Array.isArray(t)){let i=new r.TurnActionsReplayEvent(new s.Parser,new n.Serializer,e);i.payload=[[this.playerId,t.map((e=>this.actionSerializer.getActionPayload(e)))]],this.replay.writeEvent(i)}else if(this.hasActualActions(t)){let i=new r.TurnActionsReplayEvent(new s.Parser,new n.Serializer,e);i.payload=[...t].map((([e,t])=>[e,t])),this.replay.writeEvent(i)}}recordChatMessage(e,t,i){let r=new a.ChatMessageReplayEvent(e);r.payload={playerId:this.humanPlayers.findIndex((e=>e.name===t)),message:i},this.replay.writeEvent(r)}recordTaunt(e,t,i){let r=new o.TauntReplayEvent(e);r.payload={playerId:this.humanPlayers.findIndex((e=>e.name===t)),tauntNo:i},this.replay.writeEvent(r)}hasActualActions(e){return!![...e.values()].find((e=>e.find((e=>e.id!==i.ActionType.NoAction))))}})}}})),System.register("network/gamestate/lockstepUtil",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("computeNetworkTurnMillis",((e,t)=>Math.max(1,Math.ceil(e/t))*t))}}})),System.register("network/gamestate/LockstepManager",["data/DataStream","game/action/NoAction","game/Game","util/event","network/gservConfig","game/GameSpeed","network/gamestate/lockstepUtil"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("LockstepManager",c=class e{constructor(e,t,r,s,a,o,l,c,h,u,d,g){this.game=e,this.gservCon=t,this.gameoptParser=r,this.gameoptSerializer=s,this.actionSerializer=a,this.actionFactory=o,this.inputActions=l,this.onDesync=c,this.actionLogger=h,this.debugLogger=u,this.replayRecorder=d,this.debugGameState=g,this.debugGameStateHistory=[],this.queuedRateChanges=[],this.errorState=!1,this.passiveMode=!1,this.receivedActions=new Map,this.receivedNetworkTurn=0,this.lagState=!1,this._onLagStateChange=new n.EventDispatcher,this._onActionsSent=new n.EventDispatcher,this._onActionsProcessed=new n.EventDispatcher,this._onActionsReceived=new n.EventDispatcher,this.receiveActions=e=>{let t=new i.DataStream(e);var r=t.readUint32(),s=this.gameoptParser.parseAllPlayerActions(t);this.receivedNetworkTurn=r,this.receivedActions.set(r,s),this._onActionsReceived.dispatch(void 0,r)},this.handleGameDesync=()=>{this.setErrorState(),this.onDesync()}}get onLagStateChange(){return this._onLagStateChange.asEvent()}get onActionsSent(){return this._onActionsSent.asEvent()}get onActionsProcessed(){return this._onActionsProcessed.asEvent()}get onActionsReceived(){return this._onActionsReceived.asEvent()}init(){this.gameTurnMillis=1e3/(this.game.desiredSpeed.value*o.GameSpeed.BASE_TICKS_PER_SECOND),this.currentNetworkTurn=0,this.currentSubTurn=0,this.gservCon.onGameActions.subscribe(this.receiveActions),this.gservCon.onGameDesync.subscribe(this.handleGameDesync),this.debug("Init: gameTurnMillis = "+this.gameTurnMillis)}canAdvanceNetworkTurn(){return this.currentNetworkTurn<2||this.receivedActions.has(this.currentNetworkTurn-2)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}setRate(e){if(this.debug(`Recv rate: ${e.rate} (turn ${e.turnNo})`),0===this.currentSubTurn&&0===this.currentNetworkTurn&&0===e.turnNo)this.updateRate(e.rate);else{if(e.turnNo<this.currentNetworkTurn-2)throw new Error("Rate change has turn number more than two turns in the past.");this.queuedRateChanges.push(e)}}updateRate(t){this.networkTurnMillis=l.computeNetworkTurnMillis(t,this.gameTurnMillis),this.hashCheckTurnInterval=Math.ceil(e.PREFERRED_HASH_CHECK_MILLIS/this.networkTurnMillis),console.log(`Rate set to ${t} (${this.networkTurnMillis}ms) @ `+this.currentNetworkTurn)}setPassiveMode(e){this.debug("Send passive: "+e),this.passiveMode=e,this.gservCon.sendPlayerActive(!e)}getTurnMillis(){return this.gameTurnMillis}doGameTurn(e){if(!this.errorState){if(!this.networkTurnMillis)throw new Error("Network turn rate should be set by now.");if(this.game.status!==s.GameStatus.Ended){if(0===this.currentSubTurn){var t=this.queuedRateChanges[0];if(t&&t.turnNo+2===this.currentNetworkTurn&&(this.debug(`Process rate ${t.rate} (turn ${t.turnNo})`),this.updateRate(t.rate),this.queuedRateChanges.shift()),!this.canAdvanceNetworkTurn())return this.handleCommsLag(!0,e),this.debug("Lag state: "+this.lagState),!1;this.debug("Advance turn"),this.commsLagStartTime&&0<e-this.commsLagStartTime&&console.log(`Waited ${Math.round(e-this.commsLagStartTime)}ms for other clients to catch up.`),this.handleCommsLag(!1,e),!this.passiveMode&&this.currentNetworkTurn>=this.receivedNetworkTurn&&this.sendActions(),2<=this.currentNetworkTurn&&(i=this.receivedActions.get(this.currentNetworkTurn-2),this.replayRecorder.recordActions(this.game.currentTick,i),this.processActions(i),this.receivedActions.delete(this.currentNetworkTurn-2),this._onActionsProcessed.dispatch(void 0,this.currentNetworkTurn-2)),this.game.update(),this.passiveMode||this.currentNetworkTurn%this.hashCheckTurnInterval!=0||this.gservCon.sendGameStateHash(this.currentNetworkTurn,this.game.getHash()),this.networkTurnMillis>this.gameTurnMillis?this.currentSubTurn++:this.currentNetworkTurn++}else this.debug("Update"),this.game.update(),this.currentSubTurn++,this.currentSubTurn>=this.networkTurnMillis/this.gameTurnMillis&&(this.currentSubTurn=0,this.currentNetworkTurn++);var i;this.debugGameState&&(i=this.networkTurnMillis/this.gameTurnMillis*this.hashCheckTurnInterval,this.debugGameStateHistory.length>i&&this.debugGameStateHistory.shift(),this.debugGameStateHistory.push(this.game.debugGetState()))}else this.game.update()}}handleCommsLag(e,t){e?(this.commsLagStartTime||(this.commsLagStartTime=t),t-this.commsLagStartTime>a.LAG_STATE_THRESH_MILLIS&&this.updateLagState(!0)):(this.commsLagStartTime=void 0,this.updateLagState(!1))}updateLagState(e){e!==this.lagState&&(this.lagState=e,this._onLagStateChange.dispatch(void 0,e))}sendActions(){let e=this.inputActions.dequeueAll();e.length||e.push(new r.NoAction);var t=this.gameoptSerializer.serializePlayerActions(e.map((e=>this.actionSerializer.getActionPayload(e))));this.debug("Send actions: "+t),this.gservCon.sendPlayerActions(this.currentNetworkTurn,t),this._onActionsSent.dispatch(void 0,this.currentNetworkTurn)}processActions(e){[...e].forEach((([e,t])=>t.forEach((t=>{let i=this.actionFactory.create(t.id);i.player=this.game.getPlayer(e),i.unserialize(t.params),i.process();var r=i.print();r&&this.actionLogger?.debug(`(${i.player.name})@${this.game.currentTick}: `+r)}))))}debug(e){this.debugLogger?.(`${this.currentNetworkTurn}-${this.currentSubTurn}-${this.game.currentTick}: `+e)}dispose(){this.setErrorState(),this.gservCon.onGameActions.unsubscribe(this.receiveActions),this.gservCon.onGameDesync.unsubscribe(this.handleGameDesync)}}),c.PREFERRED_HASH_CHECK_MILLIS=1e3}}})),System.register("engine/GameAnimationLoop",["network/IrcConnection"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("GameAnimationLoop",class{constructor(e,t,r,s,n={}){this.localPlayer=e,this.renderer=t,this.sound=r,this.gameTurnMgr=s,this.options=n,this.isStarted=!1,this.rendererErrorState=!1,this.doBackgroundFrame=e=>{if(this.isStarted&&this.paused){let t=this.updateDeltaGameFrames(e);for(this.turnMgrIsWaiting&&(t=1);0<t;)this.turnMgrIsWaiting=!1===this.tickGame(e),t--}},this.doFrame=e=>{if(this.isStarted&&!this.paused){let r=this.updateDeltaGameFrames(e);(this.turnMgrIsWaiting||!this.options.skipFrames&&1<r)&&(r=1);let s=this.renderer.getStats();if(s&&s.begin(),this.options.skipBudgetMillis){let i=this.options.skipBudgetMillis;for(;0<r;){var t=performance.now();if(this.turnMgrIsWaiting=!1===this.tickGame(e),r--,t=performance.now()-t,i=Math.max(0,i-t),i<=0)break}}else for(;0<r;)this.turnMgrIsWaiting=!1===this.tickGame(e),r--;var i=this.gameTurnMgr.getTurnMillis();i=Math.max(0,(e-(this.startTime+this.lastGameFrame*i))/i);this.updateRenderer(e,i),this.renderer.render(),s&&s.end(),this.rafId=requestAnimationFrame(this.doFrame)}},this.handleVisibilityChange=()=>{var e=document.hidden;if(this.paused!==e){if(this.localPlayer&&!this.localPlayer.isObserver&&this.paused&&this.doBackgroundFrame(performance.now()),(this.paused=e)||(this.startTime=void 0,this.lastGameFrame=0),this.localPlayer&&!this.localPlayer.isObserver)try{this.gameTurnMgr.setPassiveMode?.(this.paused)}catch(e){if(!(e instanceof i.IrcConnection.SocketError))throw e}this.paused?(this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId=setInterval((()=>{var e=performance.now();this.doBackgroundFrame(e)}),1e3)):(this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),this.rafId=requestAnimationFrame(this.doFrame)),this.sound.audioSystem.setMuted(this.paused)}}}start(){this.isStarted||(this.isStarted=!0,this.paused=!1,this.startTime=void 0,this.lastGameFrame=0,document.hidden?this.handleVisibilityChange():this.rafId=requestAnimationFrame(this.doFrame),document.addEventListener("visibilitychange",this.handleVisibilityChange))}updateDeltaGameFrames(e){var t=this.gameTurnMgr.getTurnMillis(),i=t!==this.lastGameTurnMillis;this.lastGameTurnMillis=t,i&&(this.lastGameFrame=0,this.startTime=e);let r=0;return this.startTime?(i=e-this.startTime,r=(t=Math.round(i/t))-this.lastGameFrame,this.lastGameFrame=t):this.startTime=e,r}tickGame(e){if(!this.options.onError)return this.gameTurnMgr.doGameTurn(e);try{return this.gameTurnMgr.doGameTurn(e)}catch(e){return this.gameTurnMgr.setErrorState(),void this.options.onError(e)}}updateRenderer(e,t){if(this.options.onError){if(!this.rendererErrorState)try{this.renderer.update(e,t)}catch(e){return this.gameTurnMgr.setErrorState(),this.rendererErrorState=!0,void this.options.onError(e)}}else this.renderer.update(e,t)}stop(){this.isStarted&&(this.isStarted=!1,this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=void 0),this.backgroundIntervalId&&(clearInterval(this.backgroundIntervalId),this.backgroundIntervalId=void 0),document.removeEventListener("visibilitychange",this.handleVisibilityChange))}destroy(){this.stop(),this.renderer.flush()}})}}})),System.register("gui/screen/game/component/GameResultPopup",["gui/jsx/jsx","gui/UiObject","gui/jsx/UiComponent","gui/HtmlContainer"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){var t;(t=a=a||{})[t.SpVictory=0]="SpVictory",t[t.SpDefeat=1]="SpDefeat",t[t.MpVictory=2]="MpVictory",t[t.MpDefeat=3]="MpDefeat",e("GameResultType",a),o=class extends s.UiComponent{createUiObject({viewport:e}){let t=new r.UiObject(new THREE.Object3D,new n.HtmlContainer);return t.setPosition(e.x,e.y),t.getHtmlContainer().setSize(e.width,e.height),t}defineChildren(){let{viewport:e,type:t}=this.props;return i.jsx("sprite",{image:"grfxtxt.shp",palette:"grfxtxt.pal",ref:t=>{var i=t.getSize();t.setPosition((e.width-i.width)/2,(e.height-i.height)/2)},frame:t})}},e("GameResultPopup",o)}}})),System.register("gui/screen/game/loadingScreen/LoadingScreenApi",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gamestate/SoloPlayTurnManager",["game/action/NoAction","game/Game","game/GameSpeed"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("SoloPlayTurnManager",class{constructor(e,t,i,r,s){this.game=e,this.currentPlayer=t,this.inputActions=i,this.actionLogger=r,this.replayRecorder=s,this.errorState=!1,this.gameSpeedChanged=!1,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value)}computeGameTurn(e){this.gameTurnMillis=1e3/(e*s.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(e){if(!this.errorState){if(this.game.status!==r.GameStatus.Ended){let e=this.inputActions.dequeueAll();e.length?this.replayRecorder.recordActions(this.game.currentTick,e):e.push(new i.NoAction),this.processActions(e)}this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1)}}processActions(e){e.forEach((e=>{e.player=this.currentPlayer,e.process();var t=e.print();t&&this.actionLogger?.debug(`(${e.player.name})@${this.game.currentTick}: `+t)}))}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}})),System.register("engine/util/RaycastHelper",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RaycastHelper",class{constructor(e){this.scene=e}intersect(e,t,i=!1){let r=new THREE.Raycaster;var s=this.normalizePointer(e,this.scene.viewport);return r.setFromCamera(s,this.scene.camera),r.intersectObjects(t,i)}normalizePointer(e,t){return{x:(e.x-t.x)/t.width*2-1,y:-(e.y-t.y)/t.height*2+1}}})}}})),System.register("engine/util/EntityIntersectHelper",["util/geometry"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("EntityIntersectHelper",class{constructor(e,t,i,r,s,n){this.map=e,this.renderableManager=t,this.mapTileIntersectHelper=i,this.raycastHelper=r,this.scene=s,this.worldViewportHelper=n}getEntitiesAtScreenBox(e){let t=this.renderableManager.getRenderableContainer();if(!t)return[];let i=this.collectIntersectTargets(t.get3DObject()),r=new Set;return i.forEach((e=>r.add(this.renderableManager.getRenderableById(this.findRenderableId(e))))),[...r].filter((t=>this.worldViewportHelper.intersectsScreenBox(t.gameObject.position.worldPosition,e)))}getEntityAtScreenPoint(e){var t=this.scene.viewport;if(i.rectContainsPoint(t,e)){let i=this.renderableManager.getRenderableContainer();if(i){var r=this.collectIntersectTargets(i.get3DObject());let s=this.raycastHelper.intersect(e,r,!1);if(s.length){let i=s.map((e=>({renderable:this.renderableManager.getRenderableById(this.findRenderableId(e.object)),point:e.point})));if(t=i.find((e=>e.renderable.gameObject.isUnit())),t)return t;if(r=i.find((e=>e.renderable.gameObject.isBuilding()&&e.renderable.getIntersectTarget?.())),!r)return i[0];if((t=this.mapTileIntersectHelper.getTileAtScreenPoint(e))&&(t=this.map.getObjectsOnTile(t).find((e=>{if(!e.isBuilding())return!1;let t=this.renderableManager.getRenderableByGameObject(e);return void 0!==t.getIntersectTarget?.()})),t))return{renderable:this.renderableManager.getRenderableByGameObject(t),point:r.point}}}}}collectIntersectTargets(e){let t=[];if(!e.visible)return t;if(void 0!==e.userData.id){let r=this.renderableManager.getRenderableById(e.userData.id);if(!r)throw new Error(`Entity not found (id = "${e.userData.id}")`);var i;r.gameObject.isDestroyed||r.gameObject.isCrashing||(i=r.getIntersectTarget?.(),Array.isArray(i)?t.push(...i):i&&t.push(i))}return e.children.forEach((e=>{e.visible&&t.push(...this.collectIntersectTargets(e))})),t}findRenderableId(e){let t;for(;t=e.userData.id,e=e.parent,void 0===t&&e.parent;);if(void 0===t)throw new Error("No attached renderable ID found for Object3D.");return t}})}}})),System.register("gui/screen/game/worldInteraction/UnitSelectionHandler",["util/geometry","util/math","util/event","util/array","game/gameobject/unit/HealthLevel"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.None=0]="None",t[t.OnScreen=1]="OnScreen",t[t.OnMap=2]="OnMap",t[t.Veteran=3]="Veteran",t[t.Health=4]="Health",e("QueryType",o),e("UnitSelectionHandler",class{constructor(e,t,i,r,n,a){this.worldScene=e,this.uiScene=t,this.player=i,this.unitSelection=r,this.entityIntersectHelper=n,this.veteranCap=a,this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1,this._onUserSelectionChange=new s.EventDispatcher,this._onUserSelectionUpdate=new s.EventDispatcher,this._onUserSelectionChange.subscribe((()=>{this.shouldSelectByTypeOnMap=!1,this.shouldSelectCombatantsOnMap=!1})),this._onUserSelectionUpdate.subscribe((()=>{this.selectVeteranState=void 0,this.selectHealthState=void 0}))}get onUserSelectionChange(){return this._onUserSelectionChange.asEvent()}get onUserSelectionUpdate(){return this._onUserSelectionUpdate.asEvent()}addToSelection(e){if(e.rules.selectable){let t=this.unitSelection.getSelectedUnits();t.length&&(e.owner===this.player&&!t.find((t=>t.owner!==e.owner))||this.unitSelection.deselectAll()),this.unitSelection.addToSelection(e)}}selectSingleUnit(e){var t,i,r;e.rules.selectable&&((t=this.unitSelection.getSelectedUnits()).length&&this.unitSelection.deselectAll(),this.unitSelection.addToSelection(e),r={selection:i=this.unitSelection.getSelectedUnits()},i.length===t.length&&i[0]===t[0]||this._onUserSelectionChange.dispatch(this,r),this._onUserSelectionUpdate.dispatch(this,r))}toggleSelection(e){var t;e.rules.selectable&&(this.unitSelection.isSelected(e)?this.unitSelection.removeFromSelection([e]):this.addToSelection(e),t={selection:this.unitSelection.getSelectedUnits()},this._onUserSelectionChange.dispatch(this,t),this._onUserSelectionUpdate.dispatch(this,t))}deselectAll(){var e={selection:[]};this.unitSelection.getSelectedUnits().length&&(this.unitSelection.deselectAll(),this._onUserSelectionChange.dispatch(this,e)),this._onUserSelectionUpdate.dispatch(this,e)}selectMultipleUnits(e,{queryType:t,veteranLevel:i,healthLevel:r},s=!0){var a=this.unitSelection.getSelectedUnits();s&&this.unitSelection.deselectAll(),e.forEach((e=>this.addToSelection(e)));var o=this.unitSelection.getSelectedUnits(),l={selection:o,queryType:t,veteranLevel:i,healthLevel:r};n.equals(a,o)||this._onUserSelectionChange.dispatch(this,l),this._onUserSelectionUpdate.dispatch(this,l)}getSelectedUnits(){return this.unitSelection.getSelectedUnits()}startBoxSelect(e){this.boxSelectOrigin=e,this.selectBox=this.createSelectBox(new THREE.Box2),this.uiScene.get3DObject().add(this.selectBox)}updateBoxSelect(e){var t;this.boxSelectOrigin&&(e=this.clampPointerToWorldViewport(e),t=(new THREE.Box2).setFromPoints([new THREE.Vector2(this.boxSelectOrigin.x,this.boxSelectOrigin.y),new THREE.Vector2(e.x,e.y)]),this.selectBox.geometry.dispose(),this.selectBox.geometry=this.createBoxGeometry(t))}finishBoxSelect(e,t){if(!this.boxSelectOrigin)return!1;var r=this.boxSelectOrigin;if(this.boxSelectOrigin=void 0,this.disposeBoxSelect(),i.pointEquals(e,r))return!1;e=this.clampPointerToWorldViewport(e),r=(new THREE.Box2).setFromPoints([new THREE.Vector2(r.x,r.y),new THREE.Vector2(e.x,e.y)]);let s,n=this.entityIntersectHelper.getEntitiesAtScreenBox(r)?.map((e=>e.gameObject)).filter((e=>e.isTechno()&&e.rules.selectable&&e.owner===this.player));return!!n.length&&(s=1===n.length?[n[0]]:n.filter((e=>!e.isBuilding())),!!s.length&&(this.selectMultipleUnits(s,{queryType:o.None},t),!0))}cancelBoxSelect(){this.boxSelectOrigin=void 0,this.disposeBoxSelect()}createGroup(e){var t=this.unitSelection.getSelectedUnits();1===t.length&&t[0].owner!==this.player||this.unitSelection.createGroup(e)}getGroupUnits(e){return this.unitSelection.getGroupUnits(e)}addGroupToSelection(e){var t=this.getSelectedUnits();this.unitSelection.addGroupToSelection(e);var i=this.getSelectedUnits(),r={selection:i};n.equals(i,t)||this._onUserSelectionChange.dispatch(this,r),this._onUserSelectionUpdate.dispatch(this,r)}selectGroup(e){var t=this.getSelectedUnits();this.unitSelection.selectGroup(e);var i=this.getSelectedUnits(),r={selection:i};n.equals(i,t)||this._onUserSelectionChange.dispatch(this,r),this._onUserSelectionUpdate.dispatch(this,r)}selectByType(){let e=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(e){let r=[];r=this.shouldSelectByTypeOnMap?e.getOwnedObjects():this.getOwnedObjectsOnScreen(e);let s=this.getSelectedUnits().reduce(((e,t)=>e.add(t.name)),new Set);var t=r.filter((e=>s.has(e.name))),i=this.shouldSelectByTypeOnMap?o.OnMap:o.OnScreen;t.length?this.selectMultipleUnits(t,{queryType:i},!1):s.size||this.selectMultipleUnits([],{queryType:i}),this.shouldSelectByTypeOnMap=!0}}selectCombatants(){let e=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(e){let r=[];r=this.shouldSelectCombatantsOnMap?e.getOwnedObjects():this.getOwnedObjectsOnScreen(e);var t,i=r.filter((e=>e.isUnit()&&e.rules.selectable&&e.rules.isSelectableCombatant&&e.attackTrait&&!e.rules.harvester));i.length?(t=this.shouldSelectCombatantsOnMap?o.OnMap:o.OnScreen,this.selectMultipleUnits(i,{queryType:t})):this.shouldSelectCombatantsOnMap?this.selectMultipleUnits([],{queryType:o.OnMap}):(this.shouldSelectCombatantsOnMap=!0,this.selectCombatants()),this.shouldSelectCombatantsOnMap=!0}}selectByVeterancy(){let e=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(e){let i;void 0===this.selectVeteranState?(i=this.veteranCap,this.vetNavSelectionSet=this.unitSelection.getSelectedUnits(),this.vetNavSelectionSet.length||(this.vetNavSelectionSet=this.getOwnedObjectsOnScreen(e).filter((e=>e.isUnit())))):(t=this.veteranCap+1,i=(this.selectVeteranState-1+t)%t);let r=this.vetNavSelectionSet.filter((t=>t.rules.selectable&&!t.isDestroyed&&!t.isCrashing&&!t.limboData&&t.owner===e));var t=r.filter((e=>e.veteranLevel===i));this.selectMultipleUnits(t,{queryType:o.Veteran,veteranLevel:r.length?i:void 0}),this.selectVeteranState=i}}selectByHealth(){let e=this.player??this.unitSelection.getSelectedUnits()[0]?.owner;if(e){let i;var t=Object.keys(a.HealthLevel).filter((e=>!isNaN(Number(e)))).length;void 0===this.selectHealthState?(i=t-1,this.healthNavSelectionSet=this.unitSelection.getSelectedUnits(),this.healthNavSelectionSet.length||(this.healthNavSelectionSet=this.getOwnedObjectsOnScreen(e).filter((e=>e.isUnit())))):i=(this.selectHealthState-1+t)%t;let r=this.healthNavSelectionSet.filter((t=>t.rules.selectable&&!t.isDestroyed&&!t.isCrashing&&!t.limboData&&t.owner===e));t=r.filter((e=>e.healthTrait.level===i)),this.selectMultipleUnits(t,{queryType:o.Health,healthLevel:r.length?i:void 0}),this.selectHealthState=i}}getOwnedObjectsOnScreen(e){var t=this.worldScene.viewport;t=new THREE.Box2(new THREE.Vector2(t.x,t.y),new THREE.Vector2(t.x+t.width-1,t.x+t.height-1));return this.entityIntersectHelper.getEntitiesAtScreenBox(t)?.map((e=>e.gameObject)).filter((t=>t.isTechno()&&t.owner===e))}disposeBoxSelect(){this.selectBox&&(this.uiScene.get3DObject().remove(this.selectBox),this.selectBox.geometry.dispose(),this.selectBox.material.dispose(),this.selectBox=void 0)}clampPointerToWorldViewport(e){var t=this.worldScene.viewport;return{x:r.clamp(e.x,t.x,t.x+t.width-1),y:r.clamp(e.y,t.y,t.y+t.height-1)}}getHash(){return this.unitSelection.getHash()}dispose(){this.cancelBoxSelect(),this._onUserSelectionChange=new s.EventDispatcher,this._onUserSelectionUpdate=new s.EventDispatcher}createSelectBox(e){var t=new THREE.LineBasicMaterial({color:16777215,transparent:!0,depthTest:!1,depthWrite:!1}),i=this.createBoxGeometry(e);return new THREE.Line(i,t)}createBoxGeometry(e){var t={x:e.min.x,y:e.min.y},i={x:e.max.x,y:e.max.y},r={x:e.max.x,y:e.min.y},s={x:e.min.x,y:e.max.y};let n=new THREE.Geometry;return n.vertices.push(new THREE.Vector3(t.x,t.y,0),new THREE.Vector3(s.x,s.y,0),new THREE.Vector3(i.x,i.y,0),new THREE.Vector3(r.x,r.y,0),new THREE.Vector3(t.x,t.y,0)),n}})}}})),System.register("engine/sound/EvaSpecs",["game/SideType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){var t;(t=r=r||{})[t.Low=0]="Low",t[t.Normal=1]="Normal",t[t.Important=2]="Important",t[t.Critical=3]="Critical",e("EvaPriority",r),e("EvaSpecs",class{constructor(e){this.sideType=e,this.specs=new Map}readIni(e){let t=e.getSection("DialogList");if(!t)throw new Error("Missing eva.ini [DialogList] section");var s,n,a=new Set(t.entries.values()),o=this.sideType===i.SideType.GDI?"Allied":"Russian";for(s of a)if(s){let t=e.getSection(s);t?(n={text:t.getString("Text"),sound:t.getString(o),priority:t.getEnum("Priority",r,r.Normal,!0),queue:"queue"===t.getString("Type").trim().toLowerCase()},this.specs.set(s,n)):console.warn(`Missing eva section [${s}]`)}return this}getSpec(e){return this.specs.get(e)}})}}})),System.register("engine/sound/Eva",["engine/sound/ChannelType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Eva",class{constructor(e,t,r){this.evaSpecs=e,this.sound=t,this.renderer=r,this.evaWaitingList=[],this.lastEvaEventBySpec=new Map,this.handleFrame=e=>{var t,r;this.currentEvaPlaying?.isPlaying()?this.evaWaitingList=this.evaWaitingList.filter((e=>e.queue)):(this.currentEvaPlaying=void 0,this.evaWaitingList.sort(((e,t)=>t.priority-e.priority)),this.evaWaitingList=this.evaWaitingList.filter((t=>5e3<=e-(this.lastEvaEventBySpec.get(t)||0))),this.evaWaitingList.length&&(t=this.evaWaitingList.shift(),(r=this.sound.getWavFile(t.sound))&&(this.currentEvaPlaying=this.sound.audioSystem.playWavFile(r,i.ChannelType.Voice),this.lastEvaEventBySpec.set(t,e),this.evaWaitingList.splice(1))))}}init(){this.renderer.onFrame.subscribe(this.handleFrame)}dispose(){this.renderer.onFrame.unsubscribe(this.handleFrame),this.currentEvaPlaying?.stop()}play(e,t=!1){let i=this.evaSpecs.getSpec(e);i?(t&&(i={...i,queue:!0}),this.evaWaitingList.push(i)):console.warn(`No EVA with name ${e} was found. Skipping.`)}})}}})),System.register("game/event/InsufficientFundsEvent",["game/event/EventType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("InsufficientFundsEvent",class{constructor(e){this.target=e,this.type=i.EventType.InsufficientFunds}})}}})),System.register("gui/screen/game/SoundHandler",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","util/disposable/CompositeDisposable","game/event/EventType","util/math","gui/screen/game/worldInteraction/UnitSelectionHandler","util/typeGuard","game/gameobject/Building","game/rules/TechnoRules","util/array","game/rules/general/RadarRules","game/player/production/ProductionQueue","engine/type/ObjectType","game/Coords","game/event/AllianceChangeEvent","game/gameobject/unit/VeteranLevel","game/order/OrderFeedbackType","game/gameopts/constants","game/gameobject/common/DeathType","game/WeaponType","game/gameobject/unit/ZoneType","game/type/SuperWeaponType","game/gameobject/infantry/StanceType","game/type/PowerupType","game/gameobject/unit/HealthLevel","game/trait/StalemateDetectTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e}],execute:function(){R=(new Map).set(E.SuperWeaponType.MultiMissile,"EVA_NuclearSiloDetected").set(E.SuperWeaponType.IronCurtain,"EVA_IronCurtainDetected").set(E.SuperWeaponType.ChronoSphere,"EVA_ChronosphereDetected").set(E.SuperWeaponType.LightningStorm,"EVA_WeatherDeviceReady"),P=(new Map).set(E.SuperWeaponType.MultiMissile,"EVA_NuclearMissileReady").set(E.SuperWeaponType.IronCurtain,"EVA_IronCurtainReady").set(E.SuperWeaponType.ChronoSphere,"EVA_ChronosphereReady").set(E.SuperWeaponType.LightningStorm,"EVA_LightningStormReady").set(E.SuperWeaponType.ParaDrop,"EVA_ReinforcementsReady").set(E.SuperWeaponType.AmerParaDrop,"EVA_ReinforcementsReady"),I=(new Map).set(E.SuperWeaponType.MultiMissile,"EVA_NuclearMissileLaunched").set(E.SuperWeaponType.IronCurtain,"EVA_IronCurtainActivated").set(E.SuperWeaponType.ChronoSphere,"EVA_ChronosphereActivated").set(E.SuperWeaponType.LightningStorm,"EVA_LightningStormCreated"),k=(new Map).set(E.SuperWeaponType.MultiMissile,r.SoundKey.DigSound),B=(new Map).set(E.SuperWeaponType.LightningStorm,"TXT_LIGHTNING_STORM_APPROACHING"),j=new Map([[O.PowerupType.Veteran,r.SoundKey.CratePromoteSound],[O.PowerupType.Money,r.SoundKey.CrateMoneySound],[O.PowerupType.Reveal,r.SoundKey.CrateRevealSound],[O.PowerupType.Firepower,r.SoundKey.CrateFireSound],[O.PowerupType.Armor,r.SoundKey.CrateArmourSound],[O.PowerupType.Speed,r.SoundKey.CrateSpeedSound],[O.PowerupType.Unit,r.SoundKey.CrateUnitSound]]),N=new Map([[O.PowerupType.Armor,"EVA_UnitArmorUpgraded"],[O.PowerupType.Firepower,"EVA_UnitFirePowerUpgraded"],[O.PowerupType.Speed,"EVA_UnitSpeedUpgraded"]]),e("SoundHandler",class{constructor(e,t,i,r,s,a,o,l){this.game=e,this.worldSound=t,this.eva=i,this.sound=r,this.gameEvents=s,this.messageList=a,this.strings=o,this.player=l,this.lastAvailableObjectNames=[],this.lastQueueStatuses=new Map,this.triggerSoundHandles=new Map,this.disposables=new n.CompositeDisposable}init(){this.disposables.add(this.gameEvents.subscribe((e=>this.handleGameEvent(e))))}dispose(){this.disposables.dispose()}handleGameEvent(e){switch(e.type){case a.EventType.Cheer:this.sound.play(r.SoundKey.CheerSound,s.ChannelType.Effect);break;case a.EventType.UnitDeployUndeploy:var t="undeploy"===e.deployType,i=e.unit;(t=t?i.rules.undeploySound:i.rules.deploySound)&&this.worldSound.playEffect(t,i,i.owner);break;case a.EventType.ObjectTeleport:(t=e).isChronoshift&&(t.target.rules.chronoInSound&&this.worldSound.playEffect(t.target.rules.chronoInSound,t.target,t.target.owner),t.target.rules.chronoOutSound&&(i=f.Coords.tile3dToWorld(t.prevTile.rx+.5,t.prevTile.ry+.5,t.prevTile.z),this.worldSound.playEffect(t.target.rules.chronoOutSound,i,t.target.owner)));break;case a.EventType.WeaponFire:var n=e.weapon,l=e.gameObject;if(n.type===w.WeaponType.DeathWeapon&&l.isCrashing)break;(c=n.rules.report).length&&(d=e.weapon.warhead.rules.electricAssault?.25:1,this.worldSound.playEffect(c[o.getRandomInt(0,c.length-1)],l.position.worldPosition,l.owner,d));break;case a.EventType.InflictDamage:{let t=e;if((n=t.target.healthTrait.health)&&t.target.isTechno())if(t.target.isBuilding()){if(t.target.wallTrait)break;var c=t.damageHitPoints/t.target.healthTrait.maxHitPoints*100,d=100*(l=this.game.rules.audioVisual).conditionRed;(n<=(l=100*l.conditionYellow)&&l<n+c||n<=d&&d<n+c)&&this.worldSound.playEffect(r.SoundKey.BuildingDamageSound,t.target,t.target.owner)}else{var p=t.target.rules.voiceFeedback;t.target.owner===this.player&&p&&.9<Math.random()&&this.worldSound.playEffect(p,t.target,t.target.owner)}}break;case a.EventType.RadarEvent:if((p=e).radarEventType===g.RadarEventType.BaseUnderAttack)p.target===this.player?(this.eva.play("EVA_OurBaseIsUnderAttack"),this.sound.play(r.SoundKey.BaseUnderAttackSound,s.ChannelType.Effect)):this.player&&this.game.alliances.areAllied(this.player,p.target)&&(this.eva.play("EVA_OurAllyIsUnderAttack"),this.sound.play(r.SoundKey.BaseUnderAttackSound,s.ChannelType.Effect));else if(p.radarEventType===g.RadarEventType.HarvesterUnderAttack)p.target===this.player&&this.eva.play("EVA_OreMinerUnderAttack");else if(p.radarEventType===g.RadarEventType.EnemyObjectSensed&&p.target===this.player){let e=this.game.map.getGroundObjectsOnTile(p.tile).find((e=>e.isBuilding()&&e.superWeaponTrait));e&&(void 0===(E=e.superWeaponTrait?.getSuperWeapon(e)?.rules.type)||(A=R.get(E))&&this.eva.play(A))}break;case a.EventType.SuperWeaponReady:var m=e.target;m.owner!==this.player||(v=void 0!==m.rules.type?P.get(m.rules.type):void 0)&&this.eva.play(v);break;case a.EventType.SuperWeaponActivate:var v,E=e.target,A=e.owner;e.noSfxWarning||((m=I.get(E))&&this.eva.play(m,!0),(v=k.get(E))&&(m=e.atTile,this.worldSound.playEffect(v,f.Coords.tile3dToWorld(m.rx,m.ry,m.z),A))),(E=B.get(E))&&this.messageList.addSystemMessage(this.strings.get(E),this.player??"grey");break;case a.EventType.LightningStormManifest:this.messageList.addSystemMessage(this.strings.get("TXT_LIGHTNING_STORM"),this.player??"grey");var L=e.target;this.worldSound.playEffect(r.SoundKey.StormSound,f.Coords.tile3dToWorld(L.rx,L.ry,L.z));break;case a.EventType.WarheadDetonate:e.isLightningStrike&&this.worldSound.playEffect(r.SoundKey.LightningSounds,e.position);break;case a.EventType.ObjectLiftOff:(L=(D=e.gameObject).rules.auxSound1)&&this.worldSound.playEffect(L,D,D.owner);break;case a.EventType.ObjectLand:var D;(D=(F=e.gameObject).rules.auxSound2)&&this.worldSound.playEffect(D,F,F.owner);break;case a.EventType.ObjectCrashing:var F,_=e.gameObject;(F=_.rules.crashingSound)&&this.worldSound.playEffect(F,_.position.worldPosition,_.owner),_.owner!==this.player||(F=_.rules.voiceCrashing)&&this.worldSound.playEffect(F,_.position.worldPosition,_.owner);break;case a.EventType.ObjectDestroy:{let t,i=e.target;if(i.isUnit()&&!i.isInfantry()&&i.isCrashing?t=i.zone===C.ZoneType.Water?this.game.rules.audioVisual.impactWaterSound:i.rules.impactLandSound??this.game.rules.audioVisual.impactLandSound:i.deathType===S.DeathType.Temporal||i.deathType===S.DeathType.None?t=void 0:i.deathType===S.DeathType.Crush?t=i.rules.crushSound:i.isVehicle()&&i.zone===C.ZoneType.Water&&i.isSinker?t=r.SoundKey.SinkingSound:i.isTechno()?(t=i.rules.dieSound,!t&&i.isBuilding()&&(t=r.SoundKey.BuildingDieSound)):i.isProjectile()&&(i.fromWeapon.warhead.rules.ivanBomb?t=r.SoundKey.BombAttachSound:i.fromWeapon.warhead.rules.mindControl&&(t=r.SoundKey.YuriMindControlSound)),t){let e;i.isTechno()?e=i.owner:i.isProjectile()&&(e=i.fromPlayer),this.worldSound.playEffect(t,i.position.worldPosition,e)}i.isUnit()&&!i.rules.spawned&&i.owner===this.player&&this.eva.play("EVA_UnitLost")}break;case a.EventType.ObjectSpawn:{let t=e.gameObject;t.isTechno()&&t.rules.createSound&&this.worldSound.playEffect(t.rules.createSound,t,t.owner),t.isInfantry()&&t.stance===x.StanceType.Paradrop&&this.worldSound.playEffect(r.SoundKey.ChuteSound,t,t.owner)}break;case a.EventType.ObjectUnspawn:{let t=e.gameObject;t.isBuilding()&&t.rules.spySat&&this.worldSound.playEffect(r.SoundKey.SpySatDeactivationSound,t,t.owner)}break;case a.EventType.ObjectMorph:let se=e.to;se.isBuilding()&&this.worldSound.playEffect(r.SoundKey.BuildingDrop,se,se.owner);break;case a.EventType.ShipSubmergeChange:this.worldSound.playEffect(r.SoundKey.CloakSound,e.target,e.target.owner);break;case a.EventType.BridgeRepair:e.source===this.player&&this.eva.play("EVA_BridgeRepaired");break;case a.EventType.BuildStatusChange:var U=e.target;e.status===h.BuildStatus.BuildDown&&(this.worldSound.playEffect(r.SoundKey.SellSound,U.position.worldPosition,U.owner),!U.poweredTrait||(_=U.rules.notWorkingSound)&&this.worldSound.playEffect(_,U,U.owner));break;case a.EventType.BuildingPlace:U=e.target,this.worldSound.playEffect(r.SoundKey.BuildingSlam,U,U.owner),U.rules.spySat&&this.worldSound.playEffect(r.SoundKey.SpySatActivationSound,U,U.owner);break;case a.EventType.BuildingFailedPlace:this.player===e.player&&this.eva.play("EVA_CannotDeployHere");break;case a.EventType.BuildingSell:(H=e.target).rules.wall&&this.worldSound.playEffect(r.SoundKey.SellSound,H.position.worldPosition,H.owner),this.player===H.owner&&this.eva.play("EVA_StructureSold");break;case a.EventType.BuildingRepairFull:var H=e.target,G=e.source;G===this.player&&this.worldSound.playEffect(r.SoundKey.BuildingRepairedSound,H,G);break;case a.EventType.BuildingCapture:var V=e.target;V.owner===this.player&&this.eva.play(V.rules.needsEngineer?"EVA_TechBuildingCaptured":"EVA_BuildingCaptured");break;case a.EventType.BuildingInfiltration:if(G=e.source,V=e.target,!this.player||this.player.isObserver||V.owner===this.player||G.owner===this.player){let e;G=V.owner===this.player,V.rules.radar||G||this.eva.play("EVA_BuildingInfiltrated"),V.rules.radar&&(e=G?"EVA_RadarSabotaged":"EVA_BuildingInfRadarSabotaged"),0<V.rules.power&&(e=G?"EVA_PowerSabotaged":"EVA_EnemyBasePoweredDown"),V.rules.storage&&(e=G?"EVA_CashStolen":"EVA_BuildingInfCashStolen"),(this.game.rules.ai.buildTech.includes(V.name)||[u.FactoryType.InfantryType,u.FactoryType.UnitType].includes(V.factoryTrait?.type))&&(e=G?"EVA_TechnologyStolen":"EVA_NewTechnologyAcquired"),e&&this.eva.play(e)}break;case a.EventType.BuildingGarrison:var W=e.target;this.worldSound.playEffect(r.SoundKey.BuildingGarrisonedSound,W,W.owner),W.owner===this.player&&this.eva.play("EVA_StructureGarrisoned");break;case a.EventType.BuildingEvacuate:e.player===this.player&&this.eva.play("EVA_StructureAbandoned");break;case a.EventType.BuildingRepairStart:case a.EventType.UnitRepairStart:e.target.owner===this.player&&this.eva.play("EVA_Repairing");break;case a.EventType.UnitRepairFinish:(W=e.target).owner===this.player&&(this.eva.play("EVA_UnitRepaired"),e.from.rules.hospital&&this.worldSound.playEffect(this.game.rules.crateRules.healCrateSound,W,W.owner));break;case a.EventType.PlayerDefeated:(K=e.target)===this.player||K.resigned||(z=K.isAi?this.strings.get(b.aiUiNames.get(K.aiDifficulty)):K.name,this.eva.play("EVA_PlayerDefeated"),this.messageList.addSystemMessage(this.strings.get("TXT_PLAYER_DEFEATED",z),K));break;case a.EventType.PlayerResigned:this.eva.play("EVA_PlayerResigned");var z=e.target,K=z.isAi?this.strings.get(b.aiUiNames.get(z.aiDifficulty)):z.name;this.messageList.addSystemMessage(z.isObserver?this.strings.get("TXT_PLAYER_DEFEATED",K):this.strings.get("TXT_LEFT_GAME",K),z);break;case a.EventType.PlayerDropped:var q=e.target;this.messageList.addSystemMessage(this.strings.get("TXT_CONNECTION_LOST",q.name),"grey");break;case a.EventType.DeployNotAllowed:e.target.owner===this.player&&this.eva.play("EVA_CannotDeployHere");case a.EventType.PowerLow:e.target===this.player&&(this.eva.play("EVA_LowPower"),this.messageList.addSystemMessage(this.strings.get("TXT_LOW_POWER"),this.player));break;case a.EventType.RadarOnOff:e.target===this.player&&($=e.radarEnabled,this.sound.play($?r.SoundKey.RadarOn:r.SoundKey.RadarOff,s.ChannelType.Effect));break;case a.EventType.InsufficientFunds:e.target===this.player&&this.eva.play("EVA_InsufficientFunds");break;case a.EventType.RallyPointChange:e.target.owner===this.player&&this.eva.play("EVA_NewRallyPointEstablished");break;case a.EventType.PrimaryFactoryChange:e.target.owner===this.player&&this.eva.play("EVA_PrimaryBuildingSelected");break;case a.EventType.AllianceChange:{let t=e.alliance;q=e.changeType;var $=e.from;q===y.AllianceEventType.Formed?(!this.player||this.player.isObserver||t.players.has(this.player)||this.game.alliances.areAllied(this.player,t.players.first)&&this.game.alliances.areAllied(this.player,t.players.second)?this.eva.play("EVA_AllianceFormed"):this.eva.play("EVA_EnemyAllianceFormed"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",t.players.second.name,t.players.first.name),"white")):q===y.AllianceEventType.Requested?(this.player===t.players.first?this.eva.play("EVA_RequestingAlliance"):this.player===t.players.second&&this.eva.play("EVA_AllianceRequested"),this.messageList.addSystemMessage(this.strings.get("TXT_HAS_ALLIED",t.players.first.name,t.players.second.name),"lightgrey")):q===y.AllianceEventType.Broken&&(this.eva.play("EVA_AllianceBroken"),this.messageList.addSystemMessage(this.strings.get("TXT_AT_WAR",$.name,($===t.players.first?t.players.second:t.players.first).name),"white"))}break;case a.EventType.UnitPromote:e.target.owner===this.player&&(this.sound.play(e.target.veteranLevel===T.VeteranLevel.Elite?r.SoundKey.UpgradeEliteSound:r.SoundKey.UpgradeVeteranSound,s.ChannelType.Effect),this.eva.play("EVA_UnitPromoted",!0));break;case a.EventType.EnterTransport:var Q=e.target,Z=Q.rules.enterTransportSound;Z&&this.worldSound.playEffect(Z,Q,Q.owner);break;case a.EventType.LeaveTransport:(Q=(Z=e.target).rules.leaveTransportSound)&&this.worldSound.playEffect(Q,Z,Z.owner);break;case a.EventType.UnitRecycle:var Y=e.target,X=Y.rules.dieSound;X&&this.worldSound.playEffect(X,Y.position.worldPosition,Y.owner);break;case a.EventType.CratePickup:{X=e;let t=j.get(X.target.type);t||X.target.type!==O.PowerupType.HealBase||(t=this.game.rules.crateRules.healCrateSound);var J=N.get(X.target.type);this.player&&!this.player.isObserver&&X.player!==this.player&&!this.game.alliances.areAllied(X.player,this.player)||(t&&(Y=f.Coords.tile3dToWorld(X.tile.rx,X.tile.ry,X.tile.z),this.worldSound.playEffect(t,Y,X.player)),J&&this.eva.play(J))}break;case a.EventType.StalemateDetect:var ee=Math.floor(M.StalemateDetectTrait.graceMinutes);this.messageList.addSystemMessage(this.strings.get("TS:StalemateWarning",ee),"white",20),this.eva.play(1<ee?`EVA_${ee}MinutesRemaining`:"EVA_1MinuteRemaining");break;case a.EventType.TriggerSoundFx:if(J=(te=e).tile){if(ee=this.worldSound.playEffect(te.soundId,f.Coords.tile3dToWorld(J.rx,J.ry,J.z))){let e=this.triggerSoundHandles.get(J);e||(e=[],this.triggerSoundHandles.set(J,e)),e.push(ee)}}else this.sound.play(te.soundId,s.ChannelType.Effect);break;case a.EventType.TriggerStopSoundFx:var te,ie=e.tile;if(te=this.triggerSoundHandles.get(ie)){for(var re of te)re.isPlaying()&&re.stop();this.triggerSoundHandles.delete(ie)}break;case a.EventType.TriggerEva:this.eva.play(e.soundId);break;case a.EventType.TriggerText:ie=e.label,this.messageList.addSystemMessage(this.strings.get(ie),this.player??"grey")}}handleOrderPushed(e,t,n){var a=Date.now();if(!this.lastFeedbackTime||250<=a-this.lastFeedbackTime){let o;if(t===i.OrderType.Stop)o=r.SoundKey.StopSound;else if(t===i.OrderType.Guard)o=r.SoundKey.GuardSound;else if(t===i.OrderType.Scatter)o=r.SoundKey.ScatterSound;else switch(n){case v.OrderFeedbackType.Attack:o=e.rules.voiceAttack;break;case v.OrderFeedbackType.Move:o=e.rules.voiceMove;break;case v.OrderFeedbackType.Capture:o=e.rules.voiceCapture||e.rules.voiceSpecialAttack;break;case v.OrderFeedbackType.SpecialAttack:o=e.rules.voiceSpecialAttack;break;case v.OrderFeedbackType.Enter:o=e.rules.voiceEnter??e.rules.voiceMove;case v.OrderFeedbackType.None:}o&&(this.sound.play(o,s.ChannelType.Effect),this.lastFeedbackTime=a)}}handleSelectionChangeEvent({selection:e,queryType:t,veteranLevel:i,healthLevel:r}){if(!e.length||e[0].owner===this.player){var n,a=Date.now(),o=!this.lastFeedbackTime||250<=a-this.lastFeedbackTime;if(o&&(this.lastFeedbackTime=a),t){if(o){let t=e.map((e=>e.rules.voiceSelect)).filter(c.isNotNullOrUndefined),i=new Map;t.forEach((e=>i.set(e,(i.get(e)??0)+1))),i.forEach(((e,t)=>{var i=this.sound.getSoundSpec(t);if(i){var r=Math.min(i.limit,e);for(let e=0;e<r;e++)this.sound.play(t,s.ChannelType.Effect)}}))}if(e.length||[l.QueryType.Veteran,l.QueryType.Health].includes(t)){let s;switch(t){case l.QueryType.OnScreen:s=this.strings.get("Msg:SelAcrossScreen");break;case l.QueryType.OnMap:s=this.strings.get("Msg:SelAcrossMap");break;case l.QueryType.Veteran:case l.QueryType.Health:if(!e.length&&(t===l.QueryType.Veteran&&void 0===i||t===l.QueryType.Health&&void 0===r)){s=this.strings.get("Msg:NavEmpty");break}let a;if(t===l.QueryType.Veteran)switch(i){case T.VeteranLevel.Elite:a=this.strings.get("Msg:Elite");break;case T.VeteranLevel.Veteran:a=this.strings.get("Msg:Veteran");break;case T.VeteranLevel.None:a=this.strings.get("Msg:LittleExperience")}else if(t===l.QueryType.Health)switch(r){case A.HealthLevel.Green:a=this.strings.get("Msg:Healthy");break;case A.HealthLevel.Yellow:a=this.strings.get("Msg:HeavilyDamaged");break;case A.HealthLevel.Red:a=this.strings.get("Msg:Critical")}void 0!==a&&(a=a.toUpperCase(),s=e.length?(n=e.reduce(((e,t)=>e+t.rules.cost),0),this.strings.get("Msg:UnitsWorth",e.length,a,n)):this.strings.get("Msg:NoUnitsSel",a))}s&&this.messageList.addUiFeedbackMessage(s)}else this.messageList.addUiFeedbackMessage(this.strings.get("Msg:NothingSelected"))}else!o||(o=e.find((e=>e.rules.voiceSelect))?.rules.voiceSelect)&&this.sound.play(o,s.ChannelType.Effect)}}handleAvailableObjectsUpdate(e){var t=e.map((e=>e.name));!d.equals(this.lastAvailableObjectNames,t)&&t.length>this.lastAvailableObjectNames.length&&(this.lastAvailableObjectNames=t,this.eva.play("EVA_NewConstructionOptions"))}handleProductionQueueUpdate(e){var t=this.lastQueueStatuses.get(e.type);if(void 0===t||e.status!==t)switch(this.lastQueueStatuses.set(e.type,e.status),e.status){case p.QueueStatus.Ready:e.getFirst().rules.type===m.ObjectType.Building?this.eva.play("EVA_ConstructionComplete"):this.eva.play("EVA_UnitReady");break;case p.QueueStatus.Active:e.getFirst().rules.type===m.ObjectType.Building?this.eva.play("EVA_Building"):t===p.QueueStatus.Idle&&this.eva.play("EVA_Training");break;case p.QueueStatus.OnHold:this.eva.play("EVA_OnHold")}}})}}})),System.register("gui/screen/game/worldInteraction/MapHoverHandler",["util/event","game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("MapHoverHandler",class{constructor(e,t,r,s,n){this.entityIntersectHelper=e,this.mapTileIntersectHelper=t,this.map=r,this.shroud=s,this.renderer=n,this._onHoverChange=new i.EventDispatcher,this.isActive=!1,this.needsUpdate=!1,this.onFrame=e=>{this.isActive&&(this.needsUpdate||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.needsUpdate=!1,this.lastUpdate=e,this.doUpdate())}}get onHoverChange(){return this._onHoverChange.asEvent()}getCurrentHover(){if(this.currentHoverTile)return this.currentHoverEntity?.gameObject.isDestroyed||this.currentHoverEntity?.gameObject.isCrashing?{entity:void 0,gameObject:void 0,tile:this.currentHoverTile}:{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}}update(e,t=!1){this.lastPointerPos=e,t?this.doUpdate():this.isActive||(this.isActive=!0,this.needsUpdate=!0,this.renderer.onFrame.subscribe(this.onFrame))}doUpdate(){let e=this.currentHoverEntity;var t=this.currentHoverTile,i=this.entityIntersectHelper.getEntityAtScreenPoint(this.lastPointerPos);if(i){this.currentHoverEntity=i.renderable;let e,t=i.renderable.gameObject;var s=t.getFoundation();t.isBuilding()&&(1<s.width||1<s.height)?e=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos):t.isTechno()&&!t.art.isVoxel?e=t.tile:(n=new THREE.Vector2(i.point.x,i.point.z).multiplyScalar(1/r.Coords.LEPTONS_PER_TILE).floor(),e=this.map.tiles.getByMapCoords(n.x,n.y),e||console.warn(`No tile exists at rx,ry="${JSON.stringify(n)}". Falling back to obj location.`)),e=e||t.tile;var n=this.map.tileOccupation.getBridgeOnTile(e);this.currentHoverEntity.gameObject.isOverlay()&&this.currentHoverEntity.gameObject.isBridge()&&!n&&(this.currentHoverEntity=void 0),this.currentHoverTile=e}else this.currentHoverEntity=void 0,n=this.mapTileIntersectHelper.getTileAtScreenPoint(this.lastPointerPos),this.currentHoverTile=n;this.shroud&&this.currentHoverTile&&this.shroud.isShrouded(this.currentHoverTile,this.currentHoverEntity?.gameObject.tileElevation)&&(this.currentHoverEntity=void 0),this.currentHoverEntity===e&&this.currentHoverTile===t||(e?.selectionModel?.setHover(!1),this.currentHoverEntity?.selectionModel?.setHover(!0),this.currentHoverTile&&this._onHoverChange.dispatch(this,{entity:this.currentHoverEntity,gameObject:this.currentHoverEntity?.gameObject,tile:this.currentHoverTile}))}finish(){this.currentHoverEntity?.selectionModel?.setHover(!1),this.currentHoverEntity=void 0,this.currentHoverTile=void 0,this.isActive&&(this.renderer.onFrame.unsubscribe(this.onFrame),this.isActive=!1,this.needsUpdate=!1)}dispose(){this.finish()}})}}})),System.register("gui/screen/game/worldInteraction/DefaultActionHandler",["gui/PointerType","game/Coords","util/typeGuard","util/event","game/order/MoveOrder","game/order/orderPriorities","game/order/OrderFactory","game/order/AttackOrder","game/Target","game/order/AttackMoveOrder","game/order/OrderFeedbackType","game/order/GuardAreaOrder"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){var t;p=class{constructor(e,t,r,s=!1){this.game=e,this.unitSelectionHandler=t,this.currentPlayer=r,this.toggleSelect=s,this.force=!1,this.allowTypeSelect=!1,this.getPointerType=()=>i.PointerType.Select,this.isAllowed=()=>!0}setForce(e){return this.force=e,this}setTypeSelect(e){return this.allowTypeSelect=e,this}isValidTarget(e){if(!e?.isTechno())return!1;if(this.currentPlayer&&(e.isInfantry()||e.isVehicle())&&e.disguiseTrait?.hasTerrainDisguise()&&!this.game.alliances.haveSharedIntel(this.currentPlayer,e.owner))return!1;let t=this.unitSelectionHandler.getSelectedUnits();return!(!this.toggleSelect&&t.some((e=>e.isUnit()))&&this.currentPlayer&&!this.currentPlayer.isObserver&&e.isTechno()&&!this.game.areFriendly(e,t[0])&&t[0].owner===this.currentPlayer)&&e.rules.selectable&&(this.toggleSelect||this.force||this.allowTypeSelect&&1===t.length&&t[0]===e||!t.includes(e))}execute(e){if(this.allowTypeSelect){var t=this.unitSelectionHandler.getSelectedUnits();if(1===t.length&&t[0]===e)return void this.unitSelectionHandler.selectByType()}this.toggleSelect?this.unitSelectionHandler.toggleSelection(e):this.unitSelectionHandler.selectSingleUnit(e)}},(t=m=m||{})[t.All=0]="All",t[t.SelectOnly=1]="SelectOnly",t[t.NoSelect=2]="NoSelect",e("ActionFilter",m),e("DefaultActionHandler",class{constructor(e,t,i,r){this.renderableManager=e,this.currentPlayer=t,this.audioVisualRules=i,this.tileOccupation=r,this._onOrder=new n.EventDispatcher}get onOrder(){return this._onOrder.asEvent()}static factory(e,t,i,r,s,n,h){let d=new this(e,r,h,s.tileOccupation);var m=new p(n,i,r);return d.selectAction=m,r&&!r.isObserver?(d.defaultActions=[...o.orderPriorities.map((e=>new l.OrderFactory(n,s).create(e,t))),m,new a.MoveOrder(n,s,t)],d.selectToggleAction=new p(n,i,r,!0),d.forceMoveAction=new a.MoveOrder(n,s,t,!0),d.forceAttackAction=new c.AttackOrder(n,{forceAttack:!0}),d.attackMoveAction=new u.AttackMoveOrder(n,s),d.guardAreaAction=new g.GuardAreaOrder(n,!0),d.specialActions=[d.selectToggleAction,d.forceMoveAction,d.forceAttackAction,d.attackMoveAction,d.guardAreaAction]):(d.defaultActions=[m],d.specialActions=[]),d}createOrderTarget(e){return new h.Target(e.gameObject,e.tile,this.tileOccupation)}getDefaultAction(e,t,i,r,s,n,a,o,l){var c=i.gameObject;let h=this.selectAction;if(h.setForce(n).setTypeSelect(!1),!e||e.owner!==this.currentPlayer||e.rules.spawned)return!l&&s!==m.NoSelect&&h.isValidTarget(c)?h:void 0;if(s!==m.NoSelect&&!l&&o?.shiftKey&&!o?.ctrlKey&&this.selectToggleAction?.isValidTarget(c))return this.selectToggleAction;if(s===m.SelectOnly)return!l&&h.setTypeSelect(a).isValidTarget(c)?h:void 0;var u,d=t.every((e=>e.warpedOutTrait.isActive()));if(o?.ctrlKey&&!d)if(o.shiftKey){if(this.attackMoveAction?.set(e,r).isValid())return this.attackMoveAction}else if(o.altKey){if(this.guardAreaAction?.set(e,r).isValid())return this.guardAreaAction}else if(this.forceAttackAction?.set(e,r).isValid())return this.forceAttackAction;if(o?.altKey&&!d&&this.forceMoveAction?.set(e,r).isValid())return this.forceMoveAction;for(u of this.defaultActions.values())if(u instanceof p){if(s!==m.NoSelect&&!l&&u.setForce(n).setTypeSelect(!1).isValidTarget(c))return u}else if(!d&&(!l||u.minimapAllowed)&&!(u.singleSelectionRequired&&1<t.length)&&u.set(e,r).isValid())return u;return l&&!d&&this.forceMoveAction?.set(e,r).isValid()?this.forceMoveAction:void 0}updateMostSignificantAction(e,t,i,r,n,a,o,l){if(!e.length)return this.getDefaultAction(void 0,e,t,i,r,n,a,o,l);let c=e.map((s=>{var c=this.getDefaultAction(s,e,t,i,r,n,a,o,l);if(c)return{unit:s,action:c}})).filter(s.isNotNullOrUndefined),h=[...this.specialActions.values()];return c.length?c.reduce(((e,t)=>!e||h.includes(t.action)||this.defaultActions.indexOf(t.action)<this.defaultActions.indexOf(e)||!(e instanceof p)&&e.sourceObject.rules.leadershipRating<t.unit.rules.leadershipRating&&this.defaultActions.indexOf(t.action)===this.defaultActions.indexOf(e)?t.action instanceof p?t.action:t.action.set(t.unit,i):e),void 0):void 0}getPointerType(e){if(this.mostSignificantAction instanceof p)return this.mostSignificantAction.getPointerType();if(!this.currentSelected||!this.mostSignificantAction)return e?i.PointerType.Mini:i.PointerType.Default;if(!this.mostSignificantAction.isAllowed()){var t,r=this.mostSignificantAction.sourceObject;for(t of this.currentSelected)if(this.mostSignificantAction.set(t,this.currentTarget),this.mostSignificantAction.isValid()&&this.mostSignificantAction.isAllowed())return this.mostSignificantAction.getPointerType(e,this.currentSelected);this.mostSignificantAction.set(r,this.currentTarget)}return this.mostSignificantAction.getPointerType(e,this.currentSelected)}update(e,t,i,r,s=!1){var n=this.currentTarget=this.createOrderTarget(e);this.currentSelected=t,this.mostSignificantAction=this.updateMostSignificantAction(t,e,n,m.All,i,!1,r,s)}execute(e,t,i,s,n,o,l=!1){let c=this.currentTarget=this.createOrderTarget(e);if(this.currentSelected=t,this.mostSignificantAction=this.updateMostSignificantAction(t,e,c,i,s,n,o,l),this.mostSignificantAction){var h=this.mostSignificantAction.isAllowed();return h&&(this.mostSignificantAction instanceof a.MoveOrder||this.mostSignificantAction instanceof u.AttackMoveOrder&&!c.obj?.isTechno()||this.mostSignificantAction instanceof g.GuardAreaOrder?this.renderableManager.createTransientAnim(this.audioVisualRules.moveFlash,(e=>{e.setPosition(r.Coords.tile3dToWorld(c.tile.rx+.5,c.tile.ry+.5,c.tile.z+(c.getBridge()?.tileElevation??0)))})):this.mostSignificantAction instanceof p||t.includes(e.gameObject)||e.entity?.highlight?.()),this.mostSignificantAction instanceof p?this.mostSignificantAction.execute(e.gameObject):this._onOrder.dispatch(this,{orderType:this.mostSignificantAction.orderType,terminal:this.mostSignificantAction.terminal,feedbackType:h?this.mostSignificantAction.feedbackType:d.OrderFeedbackType.None,feedbackUnit:h?this.mostSignificantAction.sourceObject:void 0,target:c}),!0}return!1}})}}})),System.register("gui/screen/game/worldInteraction/CameraPanHandler",["util/geometry","gui/PointerType","util/math"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("CameraPanHandler",class{constructor(e,t,n,a,o){this.cameraPan=e,this.pointer=t,this.panRate=n,this.freeCamera=a,this.worldScene=o,this.isPanning=!1,this.paused=!1,this.stickyMode=!1,this.onFrame=e=>{if(!this.paused&&this.isPanning&&(!this.lastUpdate||e-this.lastUpdate>=1e3/60))if(this.lastUpdate=e,this.panVector.x||this.panVector.y){var t=this.stickyMode?this.initialPan:this.cameraPan.getPan(),n=this.cameraPan.getPanLimits();let e={x:s.clamp(t.x+this.panVector.x,n.x,n.x+n.width),y:s.clamp(t.y+this.panVector.y,n.y,n.y+n.height)};this.freeCamera.value&&(e={x:t.x+this.panVector.x,y:t.y+this.panVector.y});var a=!i.pointEquals(e,t);n=this.panVector.x&&e.x===t.x,t=this.panVector.y&&e.y===t.y;let o=0;if(n||t){let e=new THREE.Vector2(n?Math.sign(this.panVector.x):0,t?Math.sign(this.panVector.y):0);o=1+(THREE.Math.radToDeg(e.angle())+90)%360/45}this.pointer.setPointerType(r.PointerType.Pan,o),a&&this.cameraPan.setPan({x:e.x,y:e.y}),this.isPanning=a}else this.pointer.setPointerType(r.PointerType.Pan)}}start(e){this.startPos=e,this.isPanning=!1,this.panVector=new THREE.Vector2(0,0),this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame)}update(e,t){var i;t?(this.initialPan||(this.initialPan=this.cameraPan.getPan()),this.panVector.x=this.startPos.x-e.x,this.panVector.y=this.startPos.y-e.y):(i=this.panRate.value/5*50,this.panVector.x=Math.floor(i*s.clamp(e.x-this.startPos.x,-300,300)/300),this.panVector.y=Math.floor(i*s.clamp(e.y-this.startPos.y,-300,300)/300)),this.isPanning=!0,this.stickyMode=t}finish(){this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.pointer.setPointerType(r.PointerType.Default),this.initialPan=void 0}setPaused(e){this.paused=e}dispose(){this.finish()}})}}})),System.register("gui/screen/game/worldInteraction/InteractionMode",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/game/worldInteraction/MapScrollHandler",["util/geometry","util/math","gui/PointerType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("MapScrollHandler",class{constructor(e,t,n,a,o){this.canvas=e,this.cameraPan=t,this.pointer=n,this.scrollRate=a,this.worldScene=o,this.isActive=!1,this.paused=!1,this.forceScrollCancelRequested=!1,this.onFrame=e=>{if(!this.paused&&this.isActive&&(!this.lastUpdate||e-this.lastUpdate>=1e3/60)){this.lastUpdate=e;var t=this.cameraPan.getPan(),n=this.cameraPan.getPanLimits();let o,l=!1;(this.panDirection?.x||this.panDirection?.y)&&(a=this.scrollRate.value/5*20,o={x:r.clamp(t.x+this.panDirection.x*a,n.x,n.x+n.width),y:r.clamp(t.y+this.panDirection.y*a,n.y,n.y+n.height)},a=!i.pointEquals(o,t),this.pointer.setPointerType(a?s.PointerType.Scroll:s.PointerType.NoScroll,this.pointerFrameNo),a&&(l=!0));var a=this.forceScrollDirection;let c=!1;a&&(o={x:r.clamp(t.x+20*a.x,n.x,n.x+n.width),y:r.clamp(t.y+20*a.y,n.y,n.y+n.height)},i.pointEquals(o,t)||(c=!0)),this.isActive=l||c,o&&this.cameraPan.setPan({x:o.x,y:o.y}),this.isActive||this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.forceScrollCancelRequested&&(this.forceScrollCancelRequested=!1,this.forceScrollDirection=void 0)}}}isScrolling(){return!(!this.panDirection||!this.panDirection.x&&!this.panDirection.y)}requestForceScroll(e){this.forceScrollDirection=e,this.forceScrollCancelRequested=!1,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancelForceScroll(){this.forceScrollCancelRequested=!0}update(e){var t=this.canvas.height,i=this.canvas.width;let r=e.x<3?-1:e.x>i-1-3?1:0,s=e.y<3?-1:e.y>t-1-3?1:0;r?e.y<Math.min(300,t/3)?s=-1:e.y>Math.max(t-300,2*t/3)&&(s=1):s&&(e.x<Math.min(300,i/3)?r=-1:e.x>Math.max(i-300,2*i/3)&&(r=1)),this.panDirection=new THREE.Vector2(r,s),this.pointerFrameNo=(THREE.Math.radToDeg(this.panDirection.angle())+90)%360/45,this.isActive||(this.isActive=!0,this.worldScene.onBeforeCameraUpdate.subscribe(this.onFrame))}cancel(){this.cancelForceScroll(),this.isActive&&(this.worldScene.onBeforeCameraUpdate.unsubscribe(this.onFrame),this.isActive=!1)}setPaused(e){this.paused=e}dispose(){this.cancel()}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/KeyCommand",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.KeyDown=0]="KeyDown",t[t.KeyUp=1]="KeyUp",t[t.KeyDownUp=2]="KeyDownUp",e("TriggerMode",i)}}})),System.register("gui/screen/game/worldInteraction/keyboard/KeyboardHandler",["gui/screen/game/worldInteraction/keyboard/KeyCommandType","gui/screen/game/worldInteraction/keyboard/KeyCommand"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("KeyboardHandler",s=class e{constructor(e,t){this.keyBinds=e,this.devMode=t,this.commands=new Map,this.isPaused=!1}registerCommand(e,t){if(this.commands.has(e))throw new Error("Duplicate command "+e);this.commands.set(e,t)}unregisterCommand(e){this.commands.delete(e)}handleKeyDown(e){if("Backspace"===e.key&&(e.preventDefault(),e.stopPropagation()),!(e.repeat||["F5","F12"].includes(e.key)&&this.devMode)){let t=this.keyBinds.getCommandType(e);if(void 0===t&&(t=this.getNoModCmdType(e.keyCode)),void 0!==t){e.preventDefault(),e.stopPropagation();let i=this.commands.get(t);i&&!this.isPaused&&("function"==typeof i?i():i.triggerMode!==r.TriggerMode.KeyUp&&i.execute(!1))}}}handleKeyUp(e){if("Alt"===e.key)e.preventDefault(),e.stopPropagation();else if(!this.isPaused){let t=this.keyBinds.getCommandType(e);if(void 0===t&&(t=this.getNoModCmdType(e.keyCode)),void 0!==t){let e=this.commands.get(t);!e||"function"==typeof e||e.triggerMode!==r.TriggerMode.KeyUp&&e.triggerMode!==r.TriggerMode.KeyDownUp||e.execute(!0)}}}getNoModCmdType(t){var i=this.keyBinds.getCommandType({keyCode:t,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(i){var r=this.commands.get(i);if(r&&"function"!=typeof r&&e.anyModifierCommands.includes(i))return i}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}dispose(){this.commands.clear()}}),s.anyModifierCommands=[i.KeyCommandType.PlanningMode]}}})),System.register("engine/renderable/entity/TargetLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","game/gameobject/unit/ZoneType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("TargetLines",class{constructor(e,t,r,s,n){this.currentPlayer=e,this.unitSelection=t,this.camera=r,this.debugPaths=s,this.enabled=n,this.unitPaths=new Map,this.unitLines=new Map,this.lineHeadGeometry=new THREE.PlaneGeometry(3*i.Coords.ISO_WORLD_SCALE,3*i.Coords.ISO_WORLD_SCALE)}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="target_lines",this.obj.matrixAutoUpdate=!1,this.attackLineMaterial=new THREE.LineBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineMaterial=new THREE.LineBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}),this.attackLineHeadMaterial=new THREE.MeshBasicMaterial({color:11337728,transparent:!0,depthTest:!1,depthWrite:!1}),this.moveLineHeadMaterial=new THREE.MeshBasicMaterial({color:43520,transparent:!0,depthTest:!1,depthWrite:!1}))}get3DObject(){return this.obj}forceShow(){this.selectionHash=void 0}update(e){if(this.obj.visible=this.enabled.value,this.enabled.value){var t=this.unitSelection.getHash();if(void 0===this.selectionHash||this.selectionHash!==t)return this.selectionHash=t,this.hideAllLines(),this.unitPaths.clear(),this.disposeUnitLines(),void this.unitSelection.getSelectedUnits().forEach((t=>{!t.isUnit()||this.currentPlayer&&t.owner!==this.currentPlayer||(this.unitPaths.set(t,r.cloneConfig(t.unitOrderTrait.targetLinesConfig)),this.updateLines(t),t.zone!==s.ZoneType.Air&&!r.configHasTarget(t.unitOrderTrait.targetLinesConfig)||this.showLines(t,e))}));{let t=!1;if(this.unitSelection.getSelectedUnits().forEach((i=>{if(i.isUnit()&&(!this.currentPlayer||i.owner===this.currentPlayer)){this.unitPaths.has(i)&&r.configsAreEqual(this.unitPaths.get(i),i.unitOrderTrait.targetLinesConfig)||i.unitOrderTrait.targetLinesConfig?.isRecalc||(this.unitPaths.set(i,r.cloneConfig(i.unitOrderTrait.targetLinesConfig)),t=!0,this.updateLines(i),r.configHasTarget(i.unitOrderTrait.targetLinesConfig)&&this.showLines(i,e));let a=this.unitLines.get(i),o=i.position.worldPosition;if(a){var s=!o.equals(a.srcLineHead.position),n=i.unitOrderTrait.targetLinesConfig?.target;let e=n?n.position.worldPosition:void 0;if(n=e&&!e.equals(a.destLineHead.position),s||n){let t=a.line.geometry;t.verticesNeedUpdate=!0,s&&(t.vertices[t.vertices.length-1].copy(o),a.srcLineHead.position.copy(o),a.srcLineHead.updateMatrix()),e&&n&&(t.vertices[0].copy(e),a.destLineHead.position.copy(e),a.destLineHead.updateMatrix())}}}})),t)return}void 0!==this.showStart&&1e3<=e-this.showStart&&this.hideAllLines()}}showLines(e,t){this.showStart=t,this.unitLines.get(e).root.visible=!0}hideAllLines(){this.showStart=void 0,this.unitLines.forEach((e=>e.root.visible=!1))}updateLines(e){let t=e.unitOrderTrait.targetLinesConfig;if(!t||!r.configHasTarget(t)){if(e.zone!==s.ZoneType.Air)return void(this.unitLines.has(e)&&(o=this.unitLines.get(e),this.obj?.remove(o.root),this.disposeLineObjects(o),this.unitLines.delete(e)));t={pathNodes:[{tile:e.tile,onBridge:void 0},{tile:e.tile,onBridge:void 0}]}}let n=new THREE.Geometry,a=t.pathNodes;a.length?(this.debugPaths.value||(a=[a[0],a[a.length-1]]),a.forEach((e=>{var t=i.Coords.tile3dToWorld(e.tile.rx+.5,e.tile.ry+.5,e.tile.z+(e.onBridge?.tileElevation??0));n.vertices.push(t)})),n.vertices[n.vertices.length-1].copy(e.position.worldPosition)):(l=t.target,n.vertices.push(l.position.worldPosition,e.position.worldPosition));var o=!!t.isAttack,l=o?this.attackLineMaterial:this.moveLineMaterial;let c=new THREE.Line(n,l);c.matrixAutoUpdate=!1;let h=this.createLineHead(o);h.position.copy(n.vertices[n.vertices.length-1]),h.matrixAutoUpdate=!1,h.updateMatrix();let u=this.createLineHead(o);u.position.copy(n.vertices[0]),u.matrixAutoUpdate=!1,u.updateMatrix(),c.renderOrder=h.renderOrder=u.renderOrder=1e6;let d=new THREE.Object3D;d.matrixAutoUpdate=!1,d.visible=!1,d.add(c),d.add(h),d.add(u),this.unitLines.has(e)&&(o=this.unitLines.get(e),this.obj?.remove(o.root),this.disposeLineObjects(o)),this.unitLines.set(e,{root:d,line:c,srcLineHead:h,destLineHead:u}),this.obj?.add(d)}createLineHead(e){let t=new THREE.Mesh(this.lineHeadGeometry,e?this.attackLineHeadMaterial:this.moveLineHeadMaterial);var i=(new THREE.Quaternion).setFromEuler(this.camera.rotation);return t.setRotationFromQuaternion(i),t}disposeUnitLines(){[...this.unitLines.values()].forEach((e=>this.disposeLineObjects(e))),this.unitLines.clear()}disposeLineObjects(e){e.line.geometry.dispose()}dispose(){this.disposeUnitLines(),this.attackLineMaterial?.dispose(),this.attackLineHeadMaterial?.dispose(),this.moveLineMaterial?.dispose(),this.moveLineHeadMaterial?.dispose(),this.lineHeadGeometry.dispose()}})}}})),System.register("engine/util/MapPanningHelper",["engine/IsoCoords"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("MapPanningHelper",class{constructor(e){this.map=e}computeCameraPanFromTile(e,t){var r=this.map.tiles.getByMapCoords(e,t)??this.map.tiles.getPlaceholderTile(e,t);r=i.IsoCoords.tile3dToScreen(e+.5,t+.5,r.z);return this.computeCameraPanFromScreen(r)}computeCameraPanFromWorld(e){var t=i.IsoCoords.vecWorldToScreen(e);return this.computeCameraPanFromScreen(t)}computeCameraPanFromScreen(e){var t=this.getScreenPanOrigin();return{x:Math.floor(e.x-t.x),y:Math.floor(e.y-t.y)}}getScreenPanOrigin(){return i.IsoCoords.worldToScreen(0,0)}computeCameraPanLimits(e,t){var i=this.getScreenPanOrigin();return{x:Math.ceil(t.x-i.x+e.width/2),y:Math.ceil(t.y-i.y+e.height/2-1),width:t.width-e.width-1,height:t.height-e.height-1}}})}}})),System.register("gui/screen/game/worldInteraction/MinimapHandler",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MinimapHandler",class{constructor(e,t,i,r,s){this.minimap=e,this.map=t,this.shroud=i,this.worldScene=r,this.mapPanningHelper=s}panToTile(e){this.worldScene.cameraPan.setPan(this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry))}getHover(e){return{entity:void 0,gameObject:this.shroud?.isShrouded(e)?void 0:this.map.getObjectsOnTile(e).sort(((e,t)=>Number(e.isTechno())-Number(t.isTechno()))).shift(),tile:e}}})}}})),System.register("gui/screen/game/worldInteraction/ArrowScrollHandler",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ArrowScrollHandler",class{constructor(e){this.mapScrollHandler=e,this.isPaused=!1,this.scrollDir=new THREE.Vector2,this.pressedKeys=new Set,O9p||(O9p={}),O9p.joy&&O9p.joy.destroy(),G9A(window.navigator).any&&this.handleInitJoy()}handleInitJoy(){var e=this;this.joy=nipplejs.create({mode:"static",position:{left:"100px",bottom:"125px"},color:"red",zone:document.getElementById("joystick-container")}),O9p.joy=this.joy,this.joy.on("start move end",(function(t,i){var r,s,n;let a=(i?.position?.x||0)-(i?.instance?.position?.x||0),o=(i?.position?.y||0)-(i?.instance?.position?.y||0),l=0,c=0;switch(i?.instance?.options?.size&&(l=a/(i.instance.options.size/2),c=o/(i.instance.options.size/2)),null===(r=e.scrollDir)||void 0===r||r.set(0,0),t.type){case"start":joystickInTouch=!0,messageElement.style.display="block",e.scrollDir.x+=1.3*l,e.scrollDir.y-=1.3*-c;break;case"move":messageElement.style.display="block",joystickInTouch=!0,e.scrollDir.x+=1.3*l,e.scrollDir.y-=1.3*-c;break;case"end":messageElement.style.display="none",joystickInTouch=!1,null===(s=e.scrollDir)||void 0===s||s.set(0,0)}null===(n=e.mapScrollHandler)||void 0===n||n.requestForceScroll(e.scrollDir)}))}handleKeyDown(e){!this.isPaused&&["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&(e.preventDefault(),e.stopPropagation(),e.repeat||(this.pressedKeys.add(e.key),this.updateScrollDir(),this.mapScrollHandler.requestForceScroll(this.scrollDir)))}handleKeyUp(e){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&(e.preventDefault(),e.stopPropagation(),this.pressedKeys.delete(e.key),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll())}cancel(){this.pressedKeys.clear(),this.updateScrollDir(),this.scrollDir.length()||this.mapScrollHandler.cancelForceScroll()}updateScrollDir(){for(var e of(this.scrollDir.set(0,0),this.pressedKeys))switch(e){case"ArrowUp":--this.scrollDir.y;break;case"ArrowDown":this.scrollDir.y+=1;break;case"ArrowLeft":--this.scrollDir.x;break;case"ArrowRight":this.scrollDir.x+=1;break;default:throw new Error("Should never reach this line")}}pause(){this.isPaused=!0}unpause(){this.isPaused=!1}dispose(){var e;null===(e=this.joy)||void 0===e||e.destroy()}})}}})),System.register("gui/screen/game/ChatTypingHandler",["network/chat/ChatMessage","network/gservConfig"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ChatTypingHandler",class{constructor(e,t,i,r){this.keyboardHandler=e,this.arrowScrollHandler=t,this.messageList=i,this.chatHistory=r,this.isTyping=!1}startTyping(){this.isTyping||(this.keyboardHandler.pause(),this.arrowScrollHandler.pause(),this.messageList.isComposing=!0,this.isTyping=!0)}endTyping(){this.isTyping&&(this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1,this.isTyping=!1)}handleKeyDown(e){this.isTyping||("Enter"===e.key?this.startTyping():"Backspace"===e.key&&(this.chatHistory.lastComposeTarget.value={type:i.ChatRecipientType.Channel,name:r.RECIPIENT_TEAM},this.startTyping()))}handleKeyUp(e){}dispose(){this.keyboardHandler.unpause(),this.arrowScrollHandler.unpause(),this.messageList.isComposing=!1}})}}})),System.register("gui/screen/game/worldInteraction/Tooltip",["gui/UiObject","engine/gfx/SpriteUtils","engine/gfx/CanvasUtils"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends i.UiObject{constructor(e,t,i,r){super(new THREE.Object3D),this.text=e,this.color=t,this.pointer=i,this.viewport=r}create3DObject(){if(!this.mesh){let i=this.get3DObject();var e=this.texture=this.createTexture(this.text,this.color),t={width:e.image.width,height:e.image.height};let r=this.mesh=this.createMesh(e,t.width,t.height);t=this.computePosition(this.pointer,this.viewport,t),r.position.x=t.x,r.position.y=t.y,i.add(r),r.updateMatrix()}super.create3DObject()}createMesh(e,t,i){let s=r.SpriteUtils.createRectGeometry(t,i);r.SpriteUtils.addRectUvs(s,{x:0,y:0,width:t,height:i},{width:t,height:i}),s.translate(t/2,i/2,0);var n=new THREE.MeshBasicMaterial({map:e,side:THREE.DoubleSide});let a=new THREE.Mesh(s,n);return a.matrixAutoUpdate=!1,a.frustumCulled=!1,a}createTexture(e,t){let i=document.createElement("canvas");i.width=i.height=0;let r=i.getContext("2d"),n=0;for(var a of e.split("\n"))n+=(a=s.CanvasUtils.drawText(r,a,0,n,{color:t,fontFamily:"'Fira Sans Condensed', Arial, sans-serif",fontSize:12,fontWeight:"500",paddingTop:5,paddingBottom:5,paddingLeft:2,paddingRight:4,autoEnlargeCanvas:!0})).height;var o=i.width,l=i.height;l=r.getImageData(0,0,o,l);i.width+=1,i.height+=1,r.putImageData(l,1,1),r.globalCompositeOperation="destination-over",r.fillStyle="black",r.fillRect(0,0,i.width,i.height),r.globalCompositeOperation="source-over",r.strokeStyle=t,r.strokeRect(.5,.5,i.width-1,i.height-1);let c=new THREE.Texture(i);return c.minFilter=THREE.NearestFilter,c.magFilter=THREE.NearestFilter,c.needsUpdate=!0,c.flipY=!1,c}computePosition(e,t,i){let r={...e.getPosition()};return r.x+20+i.width>t.x+t.width?r.x-=20+i.width:r.x+=20,r.y+20+i.height>t.x+t.height?r.y-=20+i.height:r.y+=20,r}destroy(){super.destroy(),this.texture?.dispose(),this.mesh&&(this.mesh.material.dispose(),this.mesh.geometry.dispose())}},e("Tooltip",n)}}})),System.register("gui/screen/game/worldInteraction/TooltipHandler",["util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/Tooltip"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class{equals(e){return(this.entity??this.uiObject)===(e.entity??e.uiObject)}copy(e){this.entity=e.entity,this.uiObject=e.uiObject}},e("TooltipHandler",n=class e{constructor(t,n,a,o,l,c){this.mapHoverHandler=t,this.textColor=n,this.pointer=a,this.uiScene=o,this.renderer=l,this.strings=c,this.disposables=new i.CompositeDisposable,this.currentHover=new s,this.lastHover=new s,this.isTouch=!1,this.needsHoverTimeReset=!1,this.paused=!1,this.handleUiMouseMove=e=>{var t=e.intersection?.object;let i=t;for(;void 0===i?.userData.tooltip&&(i=i?.parent,i););this.currentHover.uiObject=i??t,this.hoverStartTime&&(this.needsHoverTimeReset=!0),this.isTouch=e.isTouch},this.handleMouseDown=()=>{this.paused=!0,this.reset()},this.handleMouseUp=e=>{this.paused=!1,this.isTouch=e.isTouch},this.handleMouseWheel=()=>{this.reset()},this.onFrame=t=>{var i;(!this.lastUpdate||t-this.lastUpdate>=1e3/15)&&(this.lastUpdate=t,i=this.mapHoverHandler.getCurrentHover()?.entity,this.currentHover.entity=i,this.paused||(this.currentHover.equals(this.lastHover)?(this.needsHoverTimeReset&&(this.needsHoverTimeReset=!1,this.hoverStartTime=t),i=this.currentHover.entity?800:400,this.hoverStartTime&&t-this.hoverStartTime>i&&(!(i=this.getTooltipText(this.currentHover))||this.tooltip||this.isTouch||(this.tooltip=new r.Tooltip(i,this.textColor,this.pointer,this.uiScene.viewport),this.tooltip.setZIndex(e.ZINDEX),this.uiScene.add(this.tooltip)))):(this.lastHover.copy(this.currentHover),this.hoverStartTime=void 0,this.destroyTooltip(),void 0!==this.getTooltipText(this.currentHover)&&(this.hoverStartTime=t))))}}init(){this.disposables.add(this.pointer.pointerEvents.addEventListener(this.uiScene.get3DObject(),"mousemove",this.handleUiMouseMove)),this.disposables.add(this.pointer.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointer.pointerEvents.addEventListener("canvas","wheel",this.handleMouseWheel),this.pointer.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp)),this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add((()=>this.renderer.onFrame.unsubscribe(this.onFrame)))}reset(){this.destroyTooltip(),this.hoverStartTime&&(this.needsHoverTimeReset=!0)}getTooltipText(e){let t;if(e.entity){let i=e.entity.getUiName?.();void 0!==i&&""!==i&&(-1!==i.indexOf("{")?t=i.replace(/\{([^}]+)\}/g,((e,t)=>this.strings.get(t))):this.strings.has(i)&&(t=this.strings.get(i)))}else e.uiObject&&(t=e.uiObject.userData.tooltip);return t}destroyTooltip(){this.tooltip&&(this.uiScene.remove(this.tooltip),this.tooltip?.destroy(),this.tooltip=void 0)}dispose(){this.disposables.dispose(),this.destroyTooltip()}}),n.ZINDEX=100}}})),System.register("util/userAgent",[],(function(e,t){"use strict";function i(){return navigator.platform.includes("Mac")}return t&&t.id,e("isIpad",(function(){return/iPad/i.test(navigator.userAgent)||/MacIntel/i.test(navigator.platform)&&!!navigator.maxTouchPoints})),e("isMac",i),e("isMacFirefox",(function(){return i()&&-1!==navigator.userAgent.toLowerCase().indexOf("firefox")})),{setters:[],execute:function(){}}})),System.register("gui/screen/game/worldInteraction/WorldInteraction",["util/geometry","gui/PointerType","gui/screen/game/worldInteraction/DefaultActionHandler","util/userAgent"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("WorldInteraction",class{constructor(e,t,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b){this.worldScene=e,this.pointer=t,this.pointerEvents=n,this.cameraPanHandler=a,this.mapScrollHandler=o,this.mapHoverHandler=l,this.tooltipHandler=c,this.unitSelectionHandler=h,this.defaultActionHandler=u,this.keyboardHandler=d,this.arrowScrollHandler=g,this.minimapHandler=p,this.cameraZoom=m,this.document=f,this.renderer=y,this.targetLines=T,this.rightClickMove=v,this.rightClickScroll=b,this.initialized=!1,this.enabled=!0,this.clickOrigin={x:0,y:0},this.maybePan=!1,this.hasDragged=!1,this.isMinimapHover=!1,this.clearModeOnSelectionChange=!1,this.handleSelectionChange=()=>{this.clearModeOnSelectionChange&&this.setMode(void 0)},this.handleKeyDown=e=>{this.handleKeyModifierChange(e),this.keyboardHandler.handleKeyDown(e),this.arrowScrollHandler.handleKeyDown(e),this.chatTypingHandler?.handleKeyDown(e)},this.handleKeyUp=e=>{this.handleKeyModifierChange(e),this.keyboardHandler.handleKeyUp(e),this.arrowScrollHandler.handleKeyUp(e),this.chatTypingHandler?.handleKeyUp(e),this.tooltipHandler.reset()},this.handleKeyModifierChange=e=>{var t=this.lastKeyboardEvent;this.lastKeyboardEvent=e,this.currentMode||this.maybePan&&this.hasDragged||this.mapScrollHandler.isScrolling()||e.repeat||e.shiftKey===t?.shiftKey&&e.ctrlKey===t?.ctrlKey&&e.altKey===t?.altKey||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),e)},this.handleMapHoverChange=e=>{this.currentMode?.hover(e,this.isMinimapHover),this.isMinimapHover||this.currentMode||this.updateDefaultAction(e,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyboardEvent)},this.handleMouseMove=e=>{this.queuedMouseMoveEvent=e},this.handleFrame=e=>{this.lastFrameTime=e;let t=!1;var i=this.unitSelectionHandler.getHash();i===this.lastSelectionHash||this.currentMode||(this.lastSelectionHash=i,t=!0),(i=this.queuedMouseMoveEvent)&&(this.queuedMouseMoveEvent=void 0,this.processMouseMove(i)),(!this.lastDefaultActionUpdate||e-this.lastDefaultActionUpdate>=1e3/15)&&(this.lastDefaultActionUpdate=e,this.currentMode||this.mapScrollHandler.isScrolling()||this.hasDragged&&this.maybePan||(t=!0)),t&&this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),this.lastKeyboardEvent)},this.handleMouseDown=e=>{joystickInTouch||i.rectContainsPoint(this.worldScene.viewport,e.pointer)&&void 0===this.mousePressed&&(this.hasFaultyCtrlLeftClick&&e.ctrlKey&&2===e.button&&(e.button=0),this.mapScrollHandler.cancel(),this.pointerEvents.intersectionsEnabled=!1,this.clickOrigin=e.pointer,this.mousePressed=e.button,this.lastMouseDownEvent=e,this.hasDragged=!1,(2===e.button&&this.isRightClickPanAllowed()||1===e.button)&&(this.maybePan=!0,this.cameraPanHandler.start(e.pointer)),2===e.button&&(this.isRightClickPanAllowed()||this.isRightClickMove()||this.unitSelectionHandler.deselectAll(),this.chatTypingHandler?.endTyping()))},this.handleMouseUp=e=>{if(this.hasFaultyCtrlLeftClick&&e.ctrlKey&&2===e.button&&(e.button=0),this.mousePressed===e.button){this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0;var t=this.maybePan;if(this.maybePan=!1,t&&this.cameraPanHandler.finish(),t&&this.hasDragged)return this.mapHoverHandler.update(e.pointer,!0),void this.currentMode?.hover(this.getCurrentHover(),this.isMinimapHover);if(this.currentMode)0===e.button?(this.mapHoverHandler.update(e.pointer,!0),!1!==this.currentMode.execute(this.getCurrentHover(),this.isMinimapHover)&&(this.currentMode=void 0)):2===e.button&&this.isClickRange(e.pointer)&&(this.currentMode.cancel?.(),this.currentMode=void 0,this.pointer.setPointerType(r.PointerType.Default));else{let r=!1;if(0===e.button&&this.hasDragged&&(r=this.unitSelectionHandler.finishBoxSelect(e.pointer,!e.shiftKey),r||this.mapHoverHandler.update(e.pointer,!0)),0===e.button||2===e.button){var i=this.isRightClickMove(),s=e.button===(i?2:0),n=this.isClickRange(e.pointer);let c=!1;var a=n&&e.isTouch&&500<=e.timeStamp-this.lastMouseDownEvent.timeStamp;e.isTouch&&this.mapHoverHandler.update(e.pointer,!0);var o,l=this.mapHoverHandler.getCurrentHover();if(n&&(o=this.lastDefaultModeClickDetails,t={mouseUpEvent:e,hoverObject:l?.gameObject,selectionHash:this.unitSelectionHandler.getHash(),time:Date.now()},o&&(c=t.mouseUpEvent.button===o.mouseUpEvent.button&&t.hoverObject===o.hoverObject&&t.selectionHash===o.selectionHash&&t.time-o.time<500),this.lastDefaultModeClickDetails=c?void 0:t),!s&&(!i||!e.shiftKey||e.ctrlKey)&&(!i||!c)){if(!n)return;this.unitSelectionHandler.deselectAll()}r||!i&&!s||this.handleDefaultClickAction(i,s,c,a,e,l),this.lastDefaultModeClickDetails&&(this.lastDefaultModeClickDetails.selectionHash=this.unitSelectionHandler.getHash())}}}},this.handleWheel=e=>{this.cameraZoom.applyStep(0<e.wheelDeltaY?-.1:.1)},this.handleMinimapClick=e=>{let t=!1;var i,r=this.minimapHandler.getHover(e);this.currentMode?!1!==this.currentMode.execute(r,!0)&&(this.currentMode=void 0,t=!0):(i=this.unitSelectionHandler.getSelectedUnits(),t=this.defaultActionHandler.execute(r,i,s.ActionFilter.All,!1,!1,this.lastKeyboardEvent,!0)),t||this.minimapHandler.panToTile(e)},this.handleMinimapRightClick=e=>{this.minimapHandler.panToTile(e)},this.handleMinimapMouseOver=()=>{this.isMinimapHover=!0},this.handleMinimapMouseMove=e=>{this.minimapHoverTile=e;var t=this.minimapHandler.getHover(e);this.currentMode?this.currentMode.hover(t,!0):this.updateDefaultAction(t,this.unitSelectionHandler.getSelectedUnits(),this.lastKeyboardEvent)},this.handleMinimapMouseOut=()=>{this.pointer.setPointerType(r.PointerType.Default),this.isMinimapHover=!1,this.minimapHoverTile=void 0}}init(){this.initialized||(this.setupHandlers(),this.worldScene.add(this.targetLines),this.initialized=!0,this.hasFaultyCtrlLeftClick=n.isMacFirefox())}setupHandlers(){this.pointerEvents.addEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.addEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.addEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.addEventListener("canvas","wheel",this.handleWheel),this.document.addEventListener("keydown",this.handleKeyDown),this.document.addEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.subscribe(this.handleMapHoverChange),this.renderer.onFrame.subscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.subscribe(this.handleSelectionChange),this.minimapHandler.minimap.onClick.subscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.subscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.subscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.subscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.subscribe(this.handleMinimapMouseOut),this.tooltipHandler.init()}teardownHandlers(){this.pointerEvents.removeEventListener("canvas","mousemove",this.handleMouseMove),this.pointerEvents.removeEventListener("canvas","mousedown",this.handleMouseDown),this.pointerEvents.removeEventListener("canvas","mouseup",this.handleMouseUp),this.pointerEvents.removeEventListener("canvas","wheel",this.handleWheel),this.document.removeEventListener("keydown",this.handleKeyDown),this.document.removeEventListener("keyup",this.handleKeyUp),this.mapHoverHandler.onHoverChange.unsubscribe(this.handleMapHoverChange),this.renderer.onFrame.unsubscribe(this.handleFrame),this.unitSelectionHandler.onUserSelectionChange.unsubscribe(this.handleSelectionChange),this.unitSelectionHandler.cancelBoxSelect(),this.minimapHandler.minimap.onClick.unsubscribe(this.handleMinimapClick),this.minimapHandler.minimap.onRightClick.unsubscribe(this.handleMinimapRightClick),this.minimapHandler.minimap.onMouseOver.unsubscribe(this.handleMinimapMouseOver),this.minimapHandler.minimap.onMouseMove.unsubscribe(this.handleMinimapMouseMove),this.minimapHandler.minimap.onMouseOut.unsubscribe(this.handleMinimapMouseOut),this.tooltipHandler.dispose(),this.mapScrollHandler.cancel(),this.arrowScrollHandler.cancel()}dispose(){this.initialized&&this.enabled&&(this.teardownHandlers(),this.pointer.setPointerType(r.PointerType.Default)),this.currentMode?.dispose(),this.mapScrollHandler.dispose(),this.cameraPanHandler.dispose(),this.mapHoverHandler.dispose(),this.unitSelectionHandler.dispose(),this.chatTypingHandler?.dispose(),this.keyboardHandler.dispose(),this.worldScene.remove(this.targetLines),this.targetLines.dispose(),this.tooltipHandler.dispose(),this.arrowScrollHandler.dispose()}setEnabled(e){this.enabled!==e&&((this.enabled=e)?this.setupHandlers():(this.teardownHandlers(),this.cancelMouseUp(),this.cancelKeyUp(),this.pointer.setPointerType(r.PointerType.Default),this.chatTypingHandler?.endTyping()))}isEnabled(){return this.enabled}pausePanning(){this.cameraPanHandler.setPaused(!0),this.mapScrollHandler.setPaused(!0)}unpausePanning(){this.cameraPanHandler.setPaused(!1),this.mapScrollHandler.setPaused(!1)}setMode(e){var t;this.currentMode!==e&&(this.currentMode?.cancel?.(),this.pointer.setPointerType(r.PointerType.Default)),this.currentMode=e,this.clearModeOnSelectionChange=!1,e&&(this.unitSelectionHandler.deselectAll(),this.clearModeOnSelectionChange=!0,e.enter(),this.mapHoverHandler.update(this.pointer.getPosition(),!0),(t=this.getCurrentHover())&&e.hover(t,this.isMinimapHover))}getMode(){return this.currentMode}registerKeyCommand(e,t){return this.keyboardHandler.registerCommand(e,t),this}unregisterKeyCommand(e){return this.keyboardHandler.unregisterCommand(e),this}updateDefaultAction(e,t,i){var s=this.mapScrollHandler.isScrolling();e?(this.defaultActionHandler.update(e,t,this.isRightClickMove(),i,this.isMinimapHover),s||this.pointer.setPointerType(this.defaultActionHandler.getPointerType(this.isMinimapHover))):s||this.pointer.setPointerType(this.isMinimapHover?r.PointerType.Mini:r.PointerType.Default),this.lastDefaultActionUpdate=this.lastFrameTime}processMouseMove(e){var t=this.mapScrollHandler.isScrolling();void 0===this.mousePressed?e.isTouch||this.mapScrollHandler.update(e.pointer):this.hasDragged||this.isClickRange(e.pointer)||(this.hasDragged=!0,this.currentMode||0!==this.mousePressed||this.unitSelectionHandler.startBoxSelect(this.clickOrigin)),!this.currentMode||this.mapScrollHandler.isScrolling()||this.maybePan&&this.hasDragged||(!this.isMinimapHover&&t&&this.pointer.setPointerType(r.PointerType.Default),this.mapHoverHandler.update(e.pointer),this.currentMode.hover(this.getCurrentHover(),this.isMinimapHover)),void 0===this.mousePressed?this.mapScrollHandler.isScrolling()||(this.mapHoverHandler.update(e.pointer),this.currentMode||this.updateDefaultAction(this.getCurrentHover(),this.unitSelectionHandler.getSelectedUnits(),e)):(!this.hasDragged||(this.currentMode||this.isRightClickMove()&&2===this.mousePressed)&&!this.maybePan?this.mapHoverHandler.update(e.pointer):this.mapHoverHandler.finish(),this.hasDragged&&(this.maybePan?this.cameraPanHandler.update(e.pointer,e.isTouch):this.currentMode||this.isRightClickMove()&&2===this.mousePressed||(this.pointer.setPointerType(r.PointerType.Default),this.unitSelectionHandler.updateBoxSelect(e.pointer))))}handleDefaultClickAction(e,t,i,r,n,a){var o,l;a&&(o=this.unitSelectionHandler.getSelectedUnits(),l=e?t?s.ActionFilter.NoSelect:s.ActionFilter.SelectOnly:s.ActionFilter.All,this.defaultActionHandler.execute(a,o,l,e&&!t,i,r?{...n,ctrlKey:!0}:n))}cancelMouseUp(){void 0!==this.mousePressed&&(this.pointerEvents.intersectionsEnabled=!0,this.mousePressed=void 0,this.maybePan&&(this.maybePan=!1,this.cameraPanHandler.finish()),this.currentMode&&(this.currentMode.cancel?.(),this.currentMode=void 0),this.unitSelectionHandler.cancelBoxSelect())}cancelKeyUp(){var e;"keydown"===this.lastKeyboardEvent?.type&&(e=new KeyboardEvent("keyup",{key:this.lastKeyboardEvent.key,keyCode:this.lastKeyboardEvent.keyCode,ctrlKey:this.lastKeyboardEvent.ctrlKey,altKey:this.lastKeyboardEvent.altKey,shiftKey:this.lastKeyboardEvent.shiftKey,metaKey:this.lastKeyboardEvent.metaKey}),this.handleKeyUp(e))}isClickRange(e){return Math.abs(e.x-this.clickOrigin.x)<=10&&Math.abs(e.y-this.clickOrigin.y)<=10}isRightClickPanAllowed(){return this.rightClickScroll.value}isRightClickMove(){return this.rightClickMove.value}getCurrentHover(){return this.isMinimapHover?this.minimapHoverTile?this.minimapHandler.getHover(this.minimapHoverTile):void 0:this.mapHoverHandler.getCurrentHover()}})}}})),System.register("gui/screen/game/worldInteraction/WorldInteractionFactory",["engine/util/MapTileIntersectHelper","engine/util/EntityIntersectHelper","gui/screen/game/worldInteraction/UnitSelectionHandler","gui/screen/game/worldInteraction/DefaultActionHandler","gui/screen/game/worldInteraction/WorldInteraction","gui/screen/game/worldInteraction/CameraPanHandler","gui/screen/game/worldInteraction/MapScrollHandler","gui/screen/game/worldInteraction/MapHoverHandler","gui/screen/game/worldInteraction/keyboard/KeyboardHandler","engine/util/RaycastHelper","engine/util/WorldViewportHelper","engine/renderable/entity/TargetLines","gui/screen/game/worldInteraction/MinimapHandler","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/TooltipHandler","gui/screen/game/worldInteraction/ArrowScrollHandler"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){e("WorldInteractionFactory",class{constructor(e,t,i,r,s,n,a,o,l,c,h,u,d,g,p,m,f){this.player=e,this.game=t,this.unitSelection=i,this.renderableManager=r,this.uiScene=s,this.worldScene=n,this.pointer=a,this.renderer=o,this.keyBinds=l,this.generalOptions=c,this.freeCamera=h,this.debugPaths=u,this.devMode=d,this.document=g,this.minimap=p,this.strings=m,this.tooltipTextColor=f}create(){var e=this.game.map,t=this.worldScene,T=this.pointer;let v=this.renderer;var b=new i.MapTileIntersectHelper(e,t),S=new u.RaycastHelper(t),w=new d.WorldViewportHelper(t),C=new r.EntityIntersectHelper(e,this.renderableManager,b,S,t,w),E=new s.UnitSelectionHandler(t,this.uiScene,this.player,this.unitSelection,C,this.game.rules.general.veteran.veteranCap),x=n.DefaultActionHandler.factory(this.renderableManager,this.unitSelection,E,this.player,e,this.game,this.game.rules.audioVisual);S=this.player?this.game.mapShroudTrait.getPlayerShroud(this.player):void 0,w=new h.KeyboardHandler(this.keyBinds,this.devMode),C=new c.MapHoverHandler(C,b,e,S,v),b=new l.MapScrollHandler(v.getCanvas(),t.cameraPan,T,this.generalOptions.scrollRate,t);return new a.WorldInteraction(t,T,T.pointerEvents,new o.CameraPanHandler(t.cameraPan,T,this.generalOptions.scrollRate,this.freeCamera,t),b,C,new f.TooltipHandler(C,this.tooltipTextColor,T,this.uiScene,this.renderer,this.strings),E,x,w,new y.ArrowScrollHandler(b),new p.MinimapHandler(this.minimap,e,S,t,new m.MapPanningHelper(e)),t.cameraZoom,this.document,v,new g.TargetLines(this.player,this.unitSelection,t.camera,this.debugPaths,this.generalOptions.targetLines),this.generalOptions.rightClickMove,this.generalOptions.rightClickScroll)}})}}})),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGridModel",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/game/worldInteraction/placementMode/PlacementGrid",["game/Coords","game/theater/rampHeights","engine/gfx/OverlayUtils","util/geometry","engine/gfx/SpriteUtils","engine/IsoCoords"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){l=e}],execute:function(){o=THREE.Math.ceilPowerOfTwo,e("PlacementGrid",class{constructor(e,t,i){this.viewModel=e,this.camera=t,this.mapTiles=i,this.tileOverlays=new Map}get3DObject(){return this.target}create3DObject(){let e=new THREE.Object3D;e.name="placement_grid",this.target=e,this.createTileOverlays()}update(){if(this.refreshRangeCircle(),this.viewModel.visible||!this.tilesObject){let i=new THREE.Object3D;for(var e of(i.visible=!0,this.viewModel.tiles)){var t=this.mapTiles.getByMapCoords(e.rx,e.ry);if(!t)throw new Error(`Map tile not found for coords (${e.rx}, ${e.ry})`);let r=this.tileOverlays.get(t.rampType);if(!r)throw new Error("Missing overlay mesh for rampType "+t.rampType);let s=r.clone();s.material=s.material.clone(),e=e.buildable?this.viewModel.showBusy?16776960:65280:16711680,s.material.color.set(e),t=this.getTilePosition(t),s.position.copy(t),i.add(s)}let r=this.get3DObject();r.remove(this.tilesObject),this.tilesObject=i,r.add(i)}else this.tilesObject.visible=!1}refreshRangeCircle(){if(this.viewModel.visible||!this.rangeObject){this.rangeObject&&(this.rangeObject.visible=!0);let o=this.get3DObject();var e=this.viewModel.rangeIndicator;if(e){if(this.lastRangeCircle&&e.radius===this.lastRangeCircle.radius||(a=s.OverlayUtils.createGroundCircle(e.radius*i.Coords.getWorldTileSize(),this.viewModel.rangeIndicatorColor),this.rangeObject&&o.remove(this.rangeObject),o.add(a),this.rangeObject=a),!this.lastRangeCircle||!n.pointEquals(e.center,this.lastRangeCircle.center)){var t=Math.floor(e.center.x),r=Math.floor(e.center.y),a=this.mapTiles.getByMapCoords(t,r);if(!a)throw new Error(`Map tile not found for coords (${t}, ${r})`);let s=this.getTilePosition(a);s.x+=e.center.x%1*i.Coords.getWorldTileSize(),s.z+=e.center.y%1*i.Coords.getWorldTileSize(),this.rangeObject.position.copy(s)}this.lastRangeCircle=e}else this.rangeObject&&(o.remove(this.rangeObject),this.rangeObject=void 0,this.lastRangeCircle=void 0)}else this.rangeObject.visible=!1}createTileOverlays(){for(let e=0;e<r.rampHeights.length;++e)this.tileOverlays.set(e,this.createTileOverlay(e))}createTileOverlay(e){var t=l.IsoCoords.getScreenTileSize();let r=a.SpriteUtils.createSpriteGeometry({texture:this.getTileOverlayTexture(),textureArea:{x:0,y:2*e*t.height,width:t.width,height:2*t.height},align:{x:0,y:-1},camera:this.camera,scale:i.Coords.ISO_WORLD_SCALE});r.applyMatrix((new THREE.Matrix4).makeTranslation(0,i.Coords.tileHeightToWorld(1),0)),t=new THREE.MeshBasicMaterial({map:this.getTileOverlayTexture(),alphaTest:.5,transparent:!0,opacity:.7,flatShading:!0,depthTest:!1,depthWrite:!1});let s=new THREE.Mesh(r,t);return s.renderOrder=1e6,s.frustumCulled=!1,s}getTilePosition(e){return i.Coords.tile3dToWorld(e.rx,e.ry,e.z)}getTileOverlayTexture(){let e=this.textureCache;if(!e){var t=l.IsoCoords.getScreenTileSize();let u=document.createElement("canvas"),d=u.getContext("2d");if(!d)throw new Error("Couldn't acquire canvas 2d context");u.width=o(t.width),u.height=o(2*t.height*r.rampHeights.length);let g=l.IsoCoords.tileToScreen(0,0);g.x+=-t.width/2;var s=i.Coords.ISO_TILE_SIZE/2;for(let e=0;e<r.rampHeights.length;++e){var n=r.rampHeights[e],a=[[0,1],[0,0],[1,0],[1,1]];d.beginPath();var c=l.IsoCoords.tileToScreen(a[0][0],a[0][1]);d.moveTo(-g.x+c.x,-g.y+c.y+(1-n[0])*s+2*e*t.height);for(let i=1;i<a.length;++i){var h=l.IsoCoords.tileToScreen(a[i][0],a[i][1]);d.lineTo(-g.x+h.x,-g.y+h.y+(1-n[i])*s+2*e*t.height)}d.closePath(),d.lineWidth=1,d.fillStyle="#"+16777215..toString(16),d.fill(),d.strokeStyle="#"+(0).toString(16),d.stroke()}e=new THREE.Texture(u),e.needsUpdate=!0,this.textureCache=e}return e}dispose(){this.tileOverlays.forEach((e=>{e.material.dispose(),e.geometry.dispose()}))}})}}})),System.register("gui/screen/game/worldInteraction/PlacementMode",["gui/screen/game/worldInteraction/placementMode/PlacementGrid","util/geometry","util/event","engine/type/ObjectType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("PlacementMode",class{constructor(e,t,i,r,n,a,o){this.game=e,this.player=t,this.constrWorker=i,this.renderer=r,this.eva=n,this.placementGrid=a,this.worldScene=o,this.defenseMode=!1,this.buildingRanges=new Map,this._onBuildingPlaceRequest=new s.EventDispatcher,this.onFrame=e=>{(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,this.currentBuilding&&this.updateGridModel(this.currentBuilding.name))}}get onBuildingPlaceRequest(){return this._onBuildingPlaceRequest}static factory(e,t,r,s,n){var a=e.getConstructionWorker(t),o={tiles:[],visible:!1,rangeIndicator:void 0,rangeIndicatorColor:void 0};let l=new this(e,t,a,r,n,new i.PlacementGrid(o,s.camera,e.map.tiles),s);return l.placementGridModel=o,l}init(){this.worldScene.add(this.placementGrid)}dispose(){this.worldScene.remove(this.placementGrid),this.placementGrid.dispose(),this.endConstrMode()}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}setBuilding(e){(this.currentBuilding=e).primary||e.hasRadialIndicator?(this.defenseMode=!0,this.prepareBuildingRanges(e)):this.defenseMode=!1}getBuilding(){return this.currentBuilding}hover(e,t){var i;t||(i=e?.tile)!==this.currentTile&&(this.currentTile=i)}updateGridModel(e){var t,i=this.currentTile;i?(t=this.constrWorker.getPlacementPreview(e,i),this.placementGridModel.tiles=t,this.placementGridModel.visible=!0,this.defenseMode?(this.showBuildingRangeOverlays(i,e),this.placementGridModel.rangeIndicator=this.getBuildingRangeCircle(i,e),this.placementGridModel.rangeIndicatorColor=this.player.color.asHex()):this.placementGridModel.rangeIndicator=void 0):this.placementGridModel.visible=!1}execute(e,t){if(!this.currentBuilding||t)return!1;var i=e?.tile;if(!i)return!1;if(this.player.production.isAvailableForProduction(this.currentBuilding)){if(!this.constrWorker.canPlaceAt(this.currentBuilding.name,i))return this.eva.play("EVA_CannotDeployHere"),!1;this._onBuildingPlaceRequest.dispatch(this,{rules:this.currentBuilding,tile:this.constrWorker.normalizePlacementTile(this.currentBuilding.name,i)}),this.endConstrMode()}else this.endConstrMode()}cancel(){this.endConstrMode()}endConstrMode(){this.defenseMode=!1,this.placementGridModel.visible=!1,this.hideBuildingRangeOverlays(),this.buildingRanges.clear(),this.currentBuilding=void 0,this.renderer.onFrame.unsubscribe(this.onFrame)}hideBuildingRangeOverlays(){this.buildingRanges.forEach(((e,t)=>{t.showWeaponRange=!1}))}showBuildingRangeOverlays(e,t){let i=this.getBuildingRangeCircle(e,t);this.buildingRanges.forEach(((e,t)=>{t.showWeaponRange=r.circleIntersect(i,e)}))}getBuildingRangeCircle(e,t){var i=this.game.art.getObject(t,n.ObjectType.Building).foundation;return{center:{x:e.rx+(i.width%2!=0?.5:0),y:e.ry+(i.height%2!=0?.5:0)},radius:this.currentRangeCircleRadius}}prepareBuildingRanges(e){let t=[...this.player.buildings].filter((t=>t.name===e.name));var i;e.psychicDetectionRadius?this.currentRangeCircleRadius=e.psychicDetectionRadius:e.gapGenerator?this.currentRangeCircleRadius=e.gapRadiusInCells:(i=e.primary)&&(this.currentRangeCircleRadius=this.game.rules.getWeapon(i).range),this.buildingRanges.clear(),t.forEach((e=>{var t=e.tile,i=this.game.art.getObject(e.name,n.ObjectType.Building).foundation;t={x:t.rx+i.width/2,y:t.ry+i.height/2};(i=e.psychicDetectorTrait?.radiusTiles??e.gapGeneratorTrait?.radiusTiles??e.primaryWeapon?.range)&&this.buildingRanges.set(e,{center:t,radius:i})}))}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SelectGroupCmd",class{constructor(e,t,i,r,s){this.groupNum=e,this.unitSelectionHandler=t,this.targetLines=i,this.mapPanningHelper=r,this.cameraPan=s}execute(){this.unitSelectionHandler.selectGroup(this.groupNum),this.targetLines.forceShow();var e=performance.now();let t=!0;(!this.lastSelectTime||400<e-this.lastSelectTime)&&(t=!1,this.lastSelectTime=e),!t||(e=this.unitSelectionHandler.getSelectedUnits()).length&&(e=this.computePanTile(e),e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}computePanTile(e){return{rx:Math.floor(e.reduce(((e,t)=>e+t.tile.rx),0)/e.length),ry:Math.floor(e.reduce(((e,t)=>e+t.tile.ry),0)/e.length)}}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CenterGroupCmd",class{constructor(e,t,i,r){this.groupNum=e,this.unitSelectionHandler=t,this.mapPanningHelper=i,this.cameraPan=r}execute(){var e=this.unitSelectionHandler.getGroupUnits(this.groupNum);e.length&&(e=this.computePanTile(e),e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}computePanTile(e){return{rx:Math.floor(e.reduce(((e,t)=>e+t.tile.rx),0)/e.length),ry:Math.floor(e.reduce(((e,t)=>e+t.tile.ry),0)/e.length)}}})}}})),System.register("gui/screen/game/PlayerUi",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/game/gameMenu/ScreenType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.Home=0]="Home",t[t.Diplo=1]="Diplo",t[t.ConnectionInfo=2]="ConnectionInfo",t[t.QuitConfirm=3]="QuitConfirm",t[t.Options=4]="Options",t[t.OptionsSound=5]="OptionsSound",t[t.OptionsKeyboard=6]="OptionsKeyboard",e("ScreenType",i)}}})),System.register("gui/screen/game/gameMenu/ConInfoForm",["react","gui/component/CountryIcon","game/gameopts/constants","network/gamestate/PlayerConnectionStatus","network/gservConfig","gui/component/Chat"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("ConInfoForm",(({strings:e,conInfos:t,players:l,localPlayer:c,messages:h,chatHistory:u,onSendMessage:d})=>{let[g,p]=i.useState((()=>Math.floor((a.TURN_TIMEOUT_MILLIS-a.LAG_STATE_THRESH_MILLIS-a.CON_INFO_THRESH_MILLIS)/1e3)));return i.useEffect((()=>{let e=setInterval((()=>p(Math.max(0,g-1))),1e3);return()=>clearInterval(e)}),[g]),i.default.createElement("div",{className:"con-info-form"},i.default.createElement("div",{className:"con-info-form-content"},i.default.createElement("table",null,i.default.createElement("tbody",null,l.filter((e=>!e.isAi)).map((e=>{var a=t?.find((t=>t.name===e.name));return i.default.createElement("tr",{key:e.name,style:{color:e.color.asHexString(),opacity:a&&a.status!==n.PlayerConnectionStatus.Connected?.5:1}},i.default.createElement("td",null,i.default.createElement(r.CountryIcon,{country:e.country?e.country.name:s.OBS_COUNTRY_NAME})),i.default.createElement("td",{className:"player-name"},e.name),i.default.createElement("td",{className:"player-ping"},i.default.createElement("meter",{value:a?.ping??1e3,max:1e3,low:150,high:500,optimum:0})))}))))),i.default.createElement("div",{className:"con-info-form-footer"},i.default.createElement("div",{className:"time-allowed"},e.get("TXT_TIME_ALLOWED",g)),i.default.createElement("div",{className:"chat"},i.default.createElement(o.Chat,{strings:e,messages:h,channels:[a.RECIPIENT_ALL,a.RECIPIENT_TEAM],chatHistory:u,userColors:new Map(l.map((e=>[e.name,e.color.asHexString()]))),localUsername:c.name,onSendMessage:d}))))}))}}})),System.register("gui/screen/game/GameMenuScreen",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("GameMenuScreen",class{setController(e){this.controller=e}})}}})),System.register("network/gameopt/LoadInfoParser",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("LoadInfoParser",class{parse(e){let t=[];var i=e.split(",");for(let e=0;e<i.length/4;++e){var r={name:i[4*e],status:Number(i[4*e+1]),loadPercent:Number(i[4*e+2]),ping:Number(i[4*e+3])};t.push(r)}return t}})}}})),System.register("gui/screen/game/ChatNetHandler",["util/disposable/CompositeDisposable","network/chat/ChatMessage","network/gservConfig"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=["/ignore","/squelch","/unignore","/unsquelch"],e("ChatNetHandler",class{constructor(e,t,n,a,o,l,c,h,u){this.gservCon=e,this.wolCon=t,this.messageList=n,this.chatHistory=a,this.chatMessageFormat=o,this.localPlayer=l,this.game=c,this.replayRecorder=h,this.mutedPlayers=u,this.disposables=new i.CompositeDisposable,this.handleMessage=e=>{if(e.from===this.localPlayer.name&&e.to.type===r.ChatRecipientType.Whisper)return this.messageList.addChatMessage(this.chatMessageFormat.formatPrefixPlain(e)+" "+e.text,"mediumpurple"),void this.chatHistory.addChatMessage(e);if(!e.text.startsWith("/")){var t=this.chatMessageFormat.formatPrefixPlain(e);let i;if(e.to.type!==r.ChatRecipientType.Page||e.from!==this.gservCon.getServerName()&&e.from!==this.wolCon.getServerName()){let t=this.game.getPlayerByName(e.from);if(this.mutedPlayers.has(t.name))return;i=e.to.type===r.ChatRecipientType.Whisper?"mediumpurple":t.color.asHexString()}else i="yellow";e.to.type===r.ChatRecipientType.Channel&&e.to.name===s.RECIPIENT_ALL&&this.replayRecorder.recordChatMessage(this.game.currentTick,e.from,e.text),this.messageList.addChatMessage(t+" "+e.text,i),this.chatHistory.addChatMessage(e),e.to.type===r.ChatRecipientType.Whisper&&e.to.name!==this.wolCon.getServerName()&&e.to.name!==this.gservCon.getServerName()&&(this.chatHistory.lastWhisperFrom.value=e.from)}}}init(){this.wolCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add((()=>this.wolCon.onChatMessage.unsubscribe(this.handleMessage))),this.gservCon.onChatMessage.subscribe(this.handleMessage),this.disposables.add((()=>this.gservCon.onChatMessage.unsubscribe(this.handleMessage)))}submitMessage(e,t){var i;this.gservCon.isOpen()?t.type===r.ChatRecipientType.Channel&&t.name===s.RECIPIENT_ALL?e.startsWith("/")?(i=this.wolCon.getCurrentChannels(),this.wolCon.isOpen()&&i.length&&n.some((t=>e.startsWith(t)))&&this.wolCon.privmsg([i[0]],e)):this.gservCon.sayChannel(e):t.type===r.ChatRecipientType.Channel&&t.name===s.RECIPIENT_TEAM?(i=this.game.alliances.getAllies(this.localPlayer).filter((e=>!e.isAi)).map((e=>e.name)),this.gservCon.privmsg([...i,this.localPlayer.name],e)):t.type===r.ChatRecipientType.Whisper&&this.wolCon.isOpen()&&(this.wolCon.privmsg([t.name],e),this.chatHistory.lastWhisperTo.value=t.name):console.warn("Can't send chat message. Network connection is already closed.")}dispose(){this.disposables.dispose()}})}}})),System.register("gui/screen/game/gameMenu/ConnectionInfoScreen",["gui/jsx/jsx","gui/screen/game/gameMenu/ScreenType","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/screen/game/gameMenu/ConInfoForm","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){c=class extends o.GameMenuScreen{constructor(e,t){super(),this.strings=e,this.jsxRenderer=t,this.messages=[],this.disposables=new n.CompositeDisposable,this.handleChatMessage=e=>{this.messages.push(e),this.form.refresh()},this.handleConInfoUpdate=e=>{this.form.applyOptions((t=>{t.conInfos=(new l.LoadInfoParser).parse(e)}))}}onEnter(e){if(this.params=e,this.controller.toggleContentAreaVisibility(!0),this.initView(e),e.gservCon.isOpen()){e.gservCon.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add((()=>e.gservCon.onLoadInfo.unsubscribe(this.handleConInfoUpdate))),e.gservCon.requestLoadInfo();let t=setInterval((()=>{e.gservCon.isOpen()?e.gservCon.requestLoadInfo():this.disposables.dispose()}),1e3);this.disposables.add((()=>clearInterval(t))),e.chatHistory.onNewMessage.subscribe(this.handleChatMessage),this.disposables.add((()=>{this.messages.length=0,e.chatHistory.onNewMessage.unsubscribe(this.handleChatMessage)}))}this.messages.push({text:this.strings.get("GUI:ConnectingToPlayers")+"...\n"+this.strings.get("TXT_RECONNECT_HELP2")+" "+this.strings.get("TXT_RECONNECT_HELP2B")})}initView(e){var t=[{label:this.strings.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(r.ScreenType.QuitConfirm,{onQuit:e.onQuit,onCancel:()=>{this.controller?.popScreen()}})}}];this.controller.setSidebarButtons(t),this.controller.showSidebarButtons();var[t]=this.jsxRenderer.render(i.jsx(s.HtmlView,{width:"100%",height:"100%",component:a.ConInfoForm,innerRef:e=>this.form=e,props:{players:e.players,localPlayer:e.localPlayer,strings:this.strings,messages:this.messages,chatHistory:e.chatHistory,onSendMessage:t=>{e.chatNetHandler.submitMessage(t.value,t.recipient)}}}));this.controller.setMainComponent(t),this.disposables.add((()=>this.form=void 0))}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},e("ConnectionInfoScreen",c)}}})),System.register("gui/screen/game/gameMenu/DiploForm",["react","game/Alliances","game/gameopts/constants","gui/component/CountryIcon","gui/component/Chat","network/gservConfig","gui/component/PingIndicator","network/gamestate/PlayerConnectionStatus"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("DiploForm",(({strings:e,playerInfos:t,localPlayer:h,taunts:u,singlePlayer:d,alliancesAllowed:g,gameModes:p,gameOpts:m,mapName:f,messages:y,chatHistory:T,conInfos:v,onToggleTaunts:b,onToggleAlliance:S,onToggleChat:w,onSendMessage:C,onCancelMessage:E})=>{var x,O=e.get(p.getById(m.gameMode).label),A=t=>t?e.get("TXT_ON"):e.get("TXT_OFF");return i.default.createElement("div",{className:"diplo-form"},i.default.createElement("div",{className:"players"},i.default.createElement("table",null,i.default.createElement("thead",null,i.default.createElement("tr",null,i.default.createElement("th",{className:"player-country"}),i.default.createElement("th",{className:"player-ping"}),i.default.createElement("th",{className:"player-name"},e.get("GUI:Player")),i.default.createElement("th",null,e.get("GUI:Allies")),!d&&i.default.createElement("th",null,e.get("GUI:Chat")),i.default.createElement("th",null,e.get("GUI:Kills")))),i.default.createElement("tbody",null,h&&i.default.createElement("tr",{style:{color:h.color.asHexString()}},i.default.createElement("td",{className:"player-country"},i.default.createElement(n.CountryIcon,{country:h.country?h.country.name:s.OBS_COUNTRY_NAME})),i.default.createElement("td",{className:"player-ping"},void 0!==(x=v?.find((e=>e.name===h.name))?.ping)&&i.default.createElement(l.PingIndicator,{ping:x,strings:e})),i.default.createElement("td",{className:"player-name"},h.name),i.default.createElement("td",null),!d&&i.default.createElement("td",null),i.default.createElement("td",null,!h.isObserver||h.defeated?h.getUnitsKilled():void 0)),t.map(((t,a)=>i.default.createElement("tr",{key:a,style:{color:t.player.defeated?"grey":t.player.color.asHexString()}},i.default.createElement("td",{className:"player-country"},i.default.createElement(n.CountryIcon,{country:t.player.country?t.player.country.name:s.OBS_COUNTRY_NAME})),i.default.createElement("td",{className:"player-ping"},(()=>{var r=v?.find((e=>e.name===t.player.name));return void 0!==(r=r?.status===c.PlayerConnectionStatus.Connected?r?.ping:void 0)&&i.default.createElement(l.PingIndicator,{ping:r,strings:e})})()),i.default.createElement("td",{className:"player-name"},t.player.isAi?e.get(s.aiUiNames.get(t.player.aiDifficulty)):t.player.name),i.default.createElement("td",null,(!h?.isObserver||h.defeated)&&i.default.createElement("input",{type:"checkbox",name:"alliance",className:t.alliance?.status===r.AllianceStatus.Requested?t.alliance.players.first===h?"semi-checked-left":"semi-checked-right":void 0,disabled:!g||!t.allianceToggleable||!t.player.isCombatant(),checked:t.alliance?.status===r.AllianceStatus.Formed,onChange:()=>S(t.player,!(t.alliance?.status===r.AllianceStatus.Formed||t.alliance?.status===r.AllianceStatus.Requested&&t.alliance.players.first===h))})),!d&&i.default.createElement("td",null,i.default.createElement("input",{type:"checkbox",name:"mute",checked:!t.muted,onChange:e=>w(t.player,e.target.checked)})),i.default.createElement("td",null,!t.player.isObserver||t.player.defeated?t.player.getUnitsKilled():void 0))))))),i.default.createElement("div",{className:"diplo-form-footer"},i.default.createElement("div",{className:"game-settings"},i.default.createElement("div",null,e.get("TXT_MAP",f)),i.default.createElement("div",null,[e.get("GUI:GameType")+": "+O,e.get("GUI:ShortGame")+": "+A(m.shortGame),e.get("GUI:CratesAppear")+": "+A(m.cratesAppear),e.get("GUI:SuperWeaponsAllowed")+": "+A(m.superWeapons)].join(", "))),!d&&i.default.createElement("div",{"data-r-tooltip":e.get("STT:TauntsOn")},i.default.createElement("label",null,i.default.createElement("input",{type:"checkbox",name:"taunts",checked:!!u,disabled:void 0===u,onChange:e=>b(e.target.checked)})," ",i.default.createElement("span",null,e.get("GUI:TauntsOn")))),!d&&y&&T&&h&&i.default.createElement("div",{className:"chat"},i.default.createElement(a.Chat,{localUsername:h.name,messages:y,chatHistory:T,channels:[o.RECIPIENT_ALL,o.RECIPIENT_TEAM],strings:e,userColors:new Map([h,...t.map((e=>e.player))].map((e=>[e.name,e.color.asHexString()]))),onSendMessage:C,onCancelMessage:E}))))}))}}})),System.register("gui/screen/game/gameMenu/DiploScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/game/gameMenu/DiploForm","util/disposable/CompositeDisposable","gui/screen/game/GameMenuScreen","network/gameopt/LoadInfoParser"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends a.GameMenuScreen{constructor(e,t,i,r,s,a){super(),this.strings=e,this.jsxRenderer=t,this.renderer=i,this.gameModes=r,this.taunts=s,this.mutedPlayers=a,this.disposables=new n.CompositeDisposable,this.onFrame=e=>{(!this.lastUpdate||500<e-this.lastUpdate)&&(this.lastUpdate=e,this.updateForm())},this.handleConInfoUpdate=e=>{this.form.applyOptions((t=>{t.conInfos=(new o.LoadInfoParser).parse(e)}))},this.updateForm=()=>{this.form.applyOptions((e=>{this.params&&(e.playerInfos=this.buildPlayerInfos(this.params.game,this.params.localPlayer),e.taunts=this.taunts.value,e.messages=this.params.chatHistory?.getAll())}))}}onEnter(e){this.controller.toggleContentAreaVisibility(!0),this.initView(e),this.params=e,this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add((()=>this.renderer.onFrame.unsubscribe(this.onFrame)));const t=e.chatHistory;t&&(t.onNewMessage.subscribe(this.updateForm),this.disposables.add((()=>t.onNewMessage.unsubscribe(this.updateForm))));const i=e.gservCon;if(i?.isOpen()){i.onLoadInfo.subscribe(this.handleConInfoUpdate),this.disposables.add((()=>i.onLoadInfo.unsubscribe(this.handleConInfoUpdate))),i.requestLoadInfo();let e=setInterval((()=>{i.isOpen()?i.requestLoadInfo():this.disposables.dispose()}),1e4);this.disposables.add((()=>clearInterval(e)))}}initView(e){var t=[{label:this.strings.get("GUI:ResumeMission"),isBottom:!0,onClick:e.onCancel}];this.controller.setSidebarButtons(t),this.controller.showSidebarButtons();var{localPlayer:n,isSinglePlayer:a,game:t}=e,[t]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.DiploForm,innerRef:e=>this.form=e,props:{playerInfos:this.buildPlayerInfos(t,n),localPlayer:n,gameOpts:t.gameOpts,gameModes:this.gameModes,taunts:a?void 0:this.taunts.value,singlePlayer:a,alliancesAllowed:!a&&t.rules.mpDialogSettings.alliesAllowed&&t.rules.mpDialogSettings.allyChangeAllowed,mapName:t.gameOpts.mapTitle,messages:e.chatHistory?.getAll(),chatHistory:e.chatHistory,onToggleTaunts:e=>this.taunts.value=e,onToggleAlliance:e.onToggleAlliance,onToggleChat:(e,t)=>{t?this.mutedPlayers.delete(e.name):this.mutedPlayers.add(e.name)},onSendMessage:e.onSendMessage,onCancelMessage:t=>t&&e.onCancel(),strings:this.strings}}));this.controller.setMainComponent(t),this.disposables.add((()=>this.form=void 0))}buildPlayerInfos(e,t){let i=t?e.alliances.filterByPlayer(t):void 0;return e.getNonNeutralPlayers().filter((e=>e!==t)).map((r=>({player:r,muted:this.mutedPlayers.has(r.name),allianceToggleable:!!t&&e.alliances.canRequestAlliance(r)&&e.alliances.canFormAlliance(t,r),alliance:i?.find((e=>e.players.first===r||e.players.second===r))})))}async onLeave(){this.params=void 0,this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1),this.disposables.dispose()}},e("DiploScreen",l)}}})),System.register("util/keyNames",[],(function(e,t){"use strict";var i;return t&&t.id,e("getKeyName",(function(e){var t=i.get(e);return void 0!==t?t:String.fromCharCode(e)})),{setters:[],execute:function(){i=new Map([[8,"Backspace"],[9,"Tab"],[12,"Clear"],[13,"Enter"],[19,"Pause/Break"],[20,"CapsLock"],[27,"Esc"],[32,"Space"],[33,"PageUp"],[34,"PageDown"],[35,"End"],[36,"Home"],[37,"ArrowLeft"],[38,"ArrowUp"],[39,"ArrowRight"],[40,"ArrowDown"],[44,"PrintScreen"],[45,"Insert"],[46,"Delete"],[91,"LeftWin/⌘"],[92,"RightWin/⌘"],...new Array(10).fill(0).map(((e,t)=>[96+t,"Num"+t])),[106,"Num*"],[107,"Num+"],[109,"Num-"],[110,"NumDel"],[111,"Num/"],...new Array(32).fill(0).map(((e,t)=>[111+t+1,"F"+(t+1)])),[144,"NumLock"],[145,"ScrollLock"],[186,";"],[187,"="],[188,","],[189,"-"],[190,"."],[191,"/"],[192,"`"],[219,"["],[220,"\\"],[221,"]"],[222,"'"]])}}})),System.register("gui/screen/options/component/getHumanReadableKey",["util/keyNames","util/userAgent"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("getHumanReadableKey",(e=>{var t=r.isMac()||r.isIpad();let s=[];return e.ctrlKey&&s.push("Ctrl"),e.altKey&&s.push(t?"⌥":"Alt"),e.shiftKey&&s.push("Shift"),e.metaKey&&s.push(t?"⌘":"Win"),void 0!==e.keyCode?(s.push(i.getKeyName(e.keyCode)),s.join("+")):s.join("+")+"+"}))}}})),System.register("gui/screen/game/gameMenu/GameMenuHomeScreen",["gui/screen/game/gameMenu/ScreenType","gui/FullScreen","gui/screen/options/component/getHumanReadableKey","gui/screen/game/GameMenuScreen"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends n.GameMenuScreen{constructor(e,t){super(),this.strings=e,this.fullScreen=t}onEnter(e){this.params=e,this.controller.toggleContentAreaVisibility(!0),this.initView(e)}initView(e){let t=this.strings;var n=[{label:t.get("GUI:Options"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.Options)}},{label:t.get("GUI:Fullscreen",s.getHumanReadableKey(r.FullScreen.hotKey)),tooltip:t.get("STT:Fullscreen"),onClick:()=>this.fullScreen.toggle()},{label:t.get("GUI:AbortMission"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.QuitConfirm,this.params)}},{label:t.get("GUI:ResumeMission"),isBottom:!0,onClick:e.onCancel}];this.controller.setSidebarButtons(n),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons(),this.controller.toggleContentAreaVisibility(!1)}async onStack(){this.controller.hideSidebarButtons()}onUnstack(){this.initView(this.params)}},e("GameMenuHomeScreen",a)}}})),System.register("gui/screen/game/gameMenu/QuitConfirmScreen",["gui/screen/game/GameMenuScreen"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.GameMenuScreen{constructor(e){super(),this.strings=e}onEnter(e){this.initView(e)}initView(e){let t=this.strings;var i=[{label:t.get("GUI:Quit"),onClick:e.onQuit},...e.observeAllowed?[{label:t.get("GUI:Observe"),onClick:e.onObserve}]:[],{label:t.get("GUI:ResumeMission"),isBottom:!0,onClick:e.onCancel}];this.controller.setSidebarButtons(i),this.controller.showSidebarButtons()}async onLeave(){this.controller.hideSidebarButtons()}},e("QuitConfirmScreen",r)}}})),System.register("gui/screen/game/gameMenu/ScreenParamsMap",["gui/screen/game/gameMenu/ScreenType"],(function(e,t){"use strict";return t&&t.id,{setters:[function(e){}],execute:function(){}}})),System.register("gui/screen/game/gameMenu/GameMenuController",["gui/screen/Controller"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.Controller{constructor(e){super(),this.hud=e,this.contentAreaVisible=!1}async goToScreenBlocking(...e){var[t,i]=e;return super.goToScreenBlocking(t,i)}goToScreen(...e){var[t,i]=e;return super.goToScreen(t,i)}async pushScreen(...e){var[t,i]=e;this.setMainComponent(),await super.pushScreen(t,i)}async popScreen(e){this.setMainComponent(),await super.popScreen(e)}async close(){for(;this.screenStack.length;)await this.popScreen()}setHud(e){this.hud=e}setSidebarButtons(e){this.sidebarButtons=e}showSidebarButtons(){if(void 0===this.sidebarButtons)throw new Error("Sidebar buttons should be set first");this.hud.showSidebarMenu(this.sidebarButtons)}hideSidebarButtons(){this.sidebarButtons=void 0,this.hud.hideSidebarMenu()}setMainComponent(e){this.mainContentComponent=e,this.hud.setMenuContentComponent(this.mainContentComponent)}toggleContentAreaVisibility(e){this.contentAreaVisible=e,this.hud.toggleMenuContentVisibility(e)}rerenderCurrentScreen(){super.rerenderCurrentScreen(),this.sidebarButtons&&this.hud.showSidebarMenu(this.sidebarButtons),this.hud.setMenuContentComponent(this.mainContentComponent),this.hud.toggleMenuContentVisibility(this.contentAreaVisible)}destroy(){super.destroy(),this.setMainComponent(void 0)}},e("GameMenuController",r)}}})),System.register("gui/screen/game/GameMenu",["util/disposable/CompositeDisposable","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","util/event"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("GameMenu",class{constructor(e,t,r,s,a,o,l=!1){this.subScreens=e,this.game=t,this.localPlayer=r,this.chatHistory=s,this.gservCon=a,this.isSinglePlayer=o,this.isTournament=l,this.disposables=new i.CompositeDisposable,this._onOpen=new n.EventDispatcher,this._onQuit=new n.EventDispatcher,this._onObserve=new n.EventDispatcher,this._onCancel=new n.EventDispatcher,this._onToggleAlliance=new n.EventDispatcher,this._onSendMessage=new n.EventDispatcher}get onOpen(){return this._onOpen.asEvent()}get onQuit(){return this._onQuit.asEvent()}get onObserve(){return this._onObserve.asEvent()}get onCancel(){return this._onCancel.asEvent()}get onToggleAlliance(){return this._onToggleAlliance.asEvent()}get onSendMessage(){return this._onSendMessage.asEvent()}init(e){let t=new r.GameMenuController(e);for(var[i,s]of this.subScreens)t.addScreen(i,s);this.controller=t,this.disposables.add(t,(()=>this.controller=void 0)),this.bindHudEvents(e)}handleHudChange(e){this.controller&&(this.controller.setHud(e),this.bindHudEvents(e),this.controller.rerenderCurrentScreen())}bindHudEvents(e){e.onOptButtonClick.subscribe((()=>this.open())),e.onDiploButtonClick.subscribe((()=>this.openDiplo()))}open(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(s.ScreenType.Home,{observeAllowed:!(this.isTournament||this.isSinglePlayer||void 0===this.localPlayer||this.localPlayer.isObserver||this.localPlayer.defeated),onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)},onObserve:()=>{this.controller.close(),this._onObserve.dispatch(this)},onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openDiplo(){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(s.ScreenType.Diplo,{game:this.game,localPlayer:this.localPlayer,isSinglePlayer:this.isSinglePlayer,chatHistory:this.chatHistory,gservCon:this.gservCon,onToggleAlliance:(e,t)=>{this._onToggleAlliance.dispatch(e,t)},onSendMessage:e=>this._onSendMessage.dispatch(this,e),onCancel:()=>{this.controller.close(),this._onCancel.dispatch(this)}})):console.warn("Menu not initialized")}openConnectionInfo(e,t,i){this.controller?(this._onOpen.dispatch(this),this.controller.goToScreen(s.ScreenType.ConnectionInfo,{players:e,localPlayer:this.localPlayer,chatHistory:this.chatHistory,chatNetHandler:i,gservCon:t,onQuit:async()=>{this.controller.close(),this._onQuit.dispatch(this)}})):console.warn("Menu not initialized")}close(){this.controller?this.controller.getCurrentScreen()&&(this.controller.close(),this._onCancel.dispatch(this)):console.warn("Menu not initialized")}getCurrentScreen(){return this.controller?.getCurrentScreen()}dispose(){this.disposables.dispose()}})}}})),System.register("gui/screen/game/worldInteraction/SellMode",["gui/PointerType","util/event","game/gameobject/Building"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("SellMode",class{constructor(e,t,s,n,a){this.game=e,this.player=t,this.sidebarModel=s,this.pointer=n,this.renderer=a,this._onExecute=new r.EventDispatcher,this.onFrame=e=>{var t,r;(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,r=!(!(t=this.currentTile)||!this.findRefundableBuilding(t)),this.pointer.setPointerType(t?r?i.PointerType.Sell:i.PointerType.NoSell:i.PointerType.Default))}}get onExecute(){return this._onExecute.asEvent()}static factory(e,t,i,r,s){return new this(e,t,i,r,s)}enter(){this.sidebarModel.sellMode=!0,this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(e,t){t||(this.currentTile=e?.tile)}findRefundableBuilding(e){return this.game.map.getObjectsOnTile(e).find((e=>e.isBuilding()&&e.owner===this.player&&!e.rules.unsellable&&e.buildStatus===s.BuildStatus.Ready&&!e.warpedOutTrait.isActive()&&0<this.game.sellTrait.computeRefundValue(e)))}execute(e,t){if(t)return!1;var i=e?.tile;return!!i&&((i=this.findRefundableBuilding(i))&&this._onExecute.dispatch(this,i),!1)}cancel(){this.end()}end(){this.sidebarModel.sellMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd",["game/event/EventType","game/type/SuperWeaponType"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("LastRadarEventCmd",class{constructor(e,t,i){this.player=e,this.mapPanningHelper=t,this.cameraPan=i,this.eventHistory=[],this.eventPointer=-1}execute(){var e,t;this.eventHistory.length&&(this.lastRun?(t=(e=Date.now())-this.lastRun,this.lastRun=e,400<t?this.eventPointer=this.eventHistory.length-1:(this.eventPointer--,this.eventPointer<0&&(this.eventPointer=this.eventHistory.length-1))):this.lastRun=Date.now(),(t=this.eventHistory[this.eventPointer])&&(t=this.mapPanningHelper.computeCameraPanFromTile(t.rx,t.ry),this.cameraPan.setPan(t)))}recordEvent(e){this.eventHistory.push(e),this.eventHistory=this.eventHistory.slice(-8),this.eventPointer=this.eventHistory.length-1}handleGameEvent(e){switch(e.type){case i.EventType.RadarEvent:e.target===this.player&&this.recordEvent(e.tile);break;case i.EventType.BridgeRepair:e.source===this.player&&this.recordEvent(e.tile);break;case i.EventType.ObjectDestroy:{let t=e.target;t.isUnit()&&t.owner===this.player&&this.recordEvent(t.tile),t.isProjectile()&&t.isNuke&&this.recordEvent(t.tile)}break;case i.EventType.FactoryProduceUnit:var t=e.target;t.owner===this.player&&this.recordEvent(t.tile);break;case i.EventType.SuperWeaponActivate:t=e,[r.SuperWeaponType.IronCurtain,r.SuperWeaponType.ChronoSphere].includes(t.target)&&this.recordEvent(t.atTile2??t.atTile);break;case i.EventType.LightningStormManifest:this.recordEvent(e.target)}}})}}})),System.register("gui/screen/game/worldInteraction/RepairMode",["gui/PointerType","util/event"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("RepairMode",class{constructor(e,t,s,n,a){this.game=e,this.player=t,this.sidebarModel=s,this.pointer=n,this.renderer=a,this._onExecute=new r.EventDispatcher,this.onFrame=e=>{var t,r;(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,r=!(!(t=this.currentTile)||!this.findRepairableBuilding(t)),this.pointer.setPointerType(t?r?i.PointerType.SideRepair:i.PointerType.NoRepair:i.PointerType.Default))}}get onExecute(){return this._onExecute.asEvent()}static factory(e,t,i,r,s){return new this(e,t,i,r,s)}enter(){this.sidebarModel.repairMode=!0,this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(e,t){t||(this.currentTile=e?.tile)}findRepairableBuilding(e){return this.game.map.getObjectsOnTile(e).find((e=>e.isBuilding()&&e.owner===this.player&&e.healthTrait.health<100&&e.rules.repairable&&e.rules.clickRepairable))}execute(e,t){if(t)return!1;var i=e?.tile;return!!i&&((i=this.findRepairableBuilding(i))&&this._onExecute.dispatch(this,i),!1)}cancel(){this.end()}end(){this.sidebarModel.repairMode=!1,this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}})),System.register("engine/renderable/entity/WaypointLine",["three.meshline","game/Coords"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("WaypointLine",class{constructor(e,t){this.linePath=e,this.camera=t,this.lastColor=this.linePath.color,this.lastBgColor=this.linePath.bgColor,this.lineHeadMaterial=new THREE.PointsMaterial({size:6,sizeAttenuation:!1,color:e.color,depthTest:!1,depthWrite:!1,transparent:!0}),this.lineHeadBgMaterial=new THREE.PointsMaterial({size:8,sizeAttenuation:!1,color:e.bgColor,depthTest:!1,depthWrite:!1,transparent:!0})}get3DObject(){return this.wrapper}create3DObject(){if(!this.wrapper){this.wrapper=new THREE.Object3D,this.wrapper.name="waypoint_line";let e=this.meshLine=new i.MeshLine,t=this.linePath.vertices.filter((e=>e.enabled)).map((e=>e.position));this.lastLineVertexCount=t.length,e.setGeometry(t.map((e=>[e.x,e.y,e.z])).flat()),this.fgLineMesh=new THREE.Mesh(e.geometry,this.createFgLineMaterial(new THREE.Color(this.linePath.color),this.computeLineLength(t))),this.fgLineMesh.renderOrder=1000002,this.wrapper.add(this.fgLineMesh),this.bgLineMesh=new THREE.Mesh(e.geometry,this.createBgLineMaterial(new THREE.Color(this.linePath.bgColor))),this.bgLineMesh.renderOrder=1000001,this.wrapper.add(this.bgLineMesh),this.lineHeadMeshes=this.createLineHeads(this.linePath.vertices.filter((e=>e.enabled&&e.lineHead)).map((e=>e.position))),this.lineHeadMeshes.forEach((e=>this.wrapper.add(e)))}}update(e){this.lastUpdateMillis||(this.lastUpdateMillis=e);let t=(e-this.lastUpdateMillis)/(1e3/120);this.lastUpdateMillis=e;var i=this.camera.top+"_"+this.camera.right;if(i!==this.cameraHash&&(this.cameraHash=i,[this.fgLineMesh,this.bgLineMesh].forEach((e=>{e.material.uniforms.resolution.value.copy(this.computeResolution(this.camera))}))),this.linePath.verticesNeedUpdate){this.linePath.verticesNeedUpdate=!1;let e=this.linePath.vertices.filter((e=>e.enabled)).map((e=>e.position));this.lastLineVertexCount!==e.length&&(this.lastLineVertexCount=e.length,this.meshLine.attributes=void 0),this.meshLine.setGeometry(e.map((e=>[e.x,e.y,e.z])).flat());let t=this.computeLineLength(e);[this.fgLineMesh].forEach((e=>{e.material.uniforms.dashArray.value=this.computeDashArray(t)})),this.updateLineHeads(this.linePath.vertices.filter((e=>e.enabled&&e.lineHead)).map((e=>e.position)))}this.linePath.color!==this.lastColor&&(this.lastColor=this.linePath.color,this.fgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.color),this.lineHeadMaterial.color.set(this.linePath.color)),this.linePath.bgColor!==this.lastBgColor&&(this.lastBgColor=this.linePath.bgColor,this.bgLineMesh.material.uniforms.color.value=new THREE.Color(this.linePath.bgColor),this.lineHeadBgMaterial.color.set(this.linePath.bgColor)),[this.fgLineMesh].forEach((e=>{let i=e.material;i.uniforms.dashOffset.value-=i.uniforms.dashArray.value/50*t}))}computeLineLength(e){let t=0;for(let i=1,r=e.length;i<r;i++)t+=e[i].distanceTo(e[i-1]);return t}createFgLineMaterial(e,t){return new i.MeshLineMaterial({color:e,lineWidth:2,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,dashArray:this.computeDashArray(t),depthTest:!1})}createBgLineMaterial(e){return new i.MeshLineMaterial({color:e,lineWidth:4,resolution:this.computeResolution(this.camera),transparent:!0,sizeAttenuation:0,depthTest:!1})}computeDashArray(e){return Math.min(1,5/e)*r.Coords.ISO_WORLD_SCALE}computeResolution(e){var t=e.top,i=e.right/e.top,s=2*t/Math.cos(e.rotation.y);return new THREE.Vector2(s*i,s).multiplyScalar(t*Math.cos(this.camera.rotation.x)/r.Coords.ISO_WORLD_SCALE)}createLineHeads(e){let t=new THREE.BufferGeometry;t.addAttribute("position",new THREE.BufferAttribute(new Float32Array(e.map((e=>[e.x,e.y,e.z])).flat()),3));let i=new THREE.Points(t,this.lineHeadMaterial);i.renderOrder=1000004;let r=new THREE.Points(t,this.lineHeadBgMaterial);return r.renderOrder=1000003,[i,r]}updateLineHeads(e){var t=e.map((e=>[e.x,e.y,e.z])).flat();let i=this.lineHeadMeshes[0].geometry,r=i.getAttribute("position");if(r.array.length!==t.length)i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(t),3));else{let e=r.array;for(let i=0,r=e.length;i<r;i++)e[i]=t[i];r.needsUpdate=!0}}dispose(){[this.fgLineMesh,this.bgLineMesh].forEach((e=>{e&&(e.geometry.dispose(),e.material.dispose())})),this.lineHeadMeshes?.forEach((e=>e.geometry.dispose())),this.lineHeadMaterial.dispose(),this.lineHeadBgMaterial.dispose()}})}}})),System.register("engine/renderable/entity/WaypointLines",["game/Coords","game/gameobject/task/system/TargetLinesConfig","util/array","engine/renderable/entity/WaypointLine"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){var t;(t=a=a||{})[t.Source=0]="Source",t[t.InitialTarget=1]="InitialTarget",t[t.Waypoint=2]="Waypoint",e("WaypointLines",class{constructor(e,t,i,r,s){this.unitSelection=e,this.currentPlayer=t,this.selectedPaths=i,this.paths=r,this.camera=s,this.lastPathWaypoints=new Map,this.sourceLinePaths=new Map,this.waypointLinePaths=new Map}create3DObject(){this.obj||(this.obj=new THREE.Object3D,this.obj.name="waypoint_lines",this.obj.matrixAutoUpdate=!1)}get3DObject(){return this.obj}update(e){var t=this.unitSelection.getHash(),i=void 0===this.selectionHash||this.selectionHash!==t;i&&(this.selectionHash=t);let r=!this.lastPaths||!s.equals(this.lastPaths,this.paths);if(r)this.lastPaths=[...this.paths];else for(var a of this.paths){var o=this.lastPathWaypoints.get(a);if(!o||!s.equals(a.waypoints,o)){r=!0,this.lastPathWaypoints.set(a,[...a.waypoints]);break}}if(i||r){let t=[],i=this.unitSelection.getSelectedUnits();1===i.length&&i[0].owner!==this.currentPlayer&&(i=[]),t=this.paths.length?[...new Set([...this.paths.map((e=>[...e.units])).flat(),...i])]:i,t=t.filter((e=>e.isSpawned)),[...this.sourceLinePaths.values(),...this.waypointLinePaths.values()].forEach((e=>{let t=e.lineObj;t&&(this.obj.remove(t.get3DObject()),t.dispose())})),this.sourceLinePaths.clear(),this.waypointLinePaths.clear();for(let i of t)if(i.isUnit()){let t=this.createSourceLinePath(i,this.paths.find((e=>e.units.has(i))));this.sourceLinePaths.set(i,t),t.lineObj=new n.WaypointLine(t,this.camera),t.lineObj.create3DObject(),this.obj.add(t.lineObj.get3DObject()),t.lineObj.update(e)}for(var l of this.paths){let t=this.createWaypointLinePath(l,this.selectedPaths.includes(l));this.waypointLinePaths.set(l,t),t.lineObj=new n.WaypointLine(t,this.camera),t.lineObj.create3DObject(),this.obj.add(t.lineObj.get3DObject()),t.lineObj.update(e)}}else this.sourceLinePaths.forEach(((t,i)=>{this.updateSourceLinePath(t,i,this.paths.find((e=>e.units.has(i)))),t.lineObj.update(e)})),this.waypointLinePaths.forEach((t=>{this.updateWaypointLinePath(t),t.lineObj.update(e)}))}createSourceLinePath(e,t){var i=!!e.unitOrderTrait.targetLinesConfig&&r.configHasTarget(e.unitOrderTrait.targetLinesConfig);let s=e.unitOrderTrait.waypointPath?t?.waypoints.find((t=>t.original===(e.unitOrderTrait.currentWaypoint??e.unitOrderTrait.waypointPath.waypoints[0]))):t?.waypoints.find((e=>e.draft)),n={vertices:[],verticesNeedUpdate:!1,color:10867711,bgColor:this.unitSelection.isSelected(e)?16777215:0};var o={type:a.Source,enabled:i||!!s,lineHead:!0,obj:e,position:e.position.worldPosition.clone()};i={type:a.InitialTarget,enabled:i&&(!e.unitOrderTrait.waypointPath||!e.unitOrderTrait.currentWaypoint),lineHead:!0,obj:e,position:i?this.computeInitialTargetPosition(e.unitOrderTrait.targetLinesConfig).clone():new THREE.Vector3};return n.vertices.push(o,i),s&&(i={type:a.Waypoint,enabled:!0,lineHead:!1,waypoint:s,position:s.target.getWorldCoords().clone()},n.vertices.push(i)),n}updateSourceLinePath(e,t,i){var s,n=t.unitOrderTrait.waypointPath?i?.waypoints.find((e=>e.original===(t.unitOrderTrait.currentWaypoint??t.unitOrderTrait.waypointPath.waypoints[0]))):i?.waypoints.find((e=>e.draft)),o=!!n,l=!!t.unitOrderTrait.targetLinesConfig&&r.configHasTarget(t.unitOrderTrait.targetLinesConfig);for(s of e.vertices){let i,r;s.type===a.Source?(i=o||l,r=t.position.worldPosition):s.type===a.InitialTarget?(i=l&&(!t.unitOrderTrait.waypointPath||!t.unitOrderTrait.currentWaypoint),l&&(r=this.computeInitialTargetPosition(s.obj.unitOrderTrait.targetLinesConfig))):(i=o,n&&(s.waypoint=n),r=s.waypoint.target.getWorldCoords()),r&&!r.equals(s.position)&&(e.verticesNeedUpdate=!0,s.position.copy(r)),void 0!==i&&i!==s.enabled&&(e.verticesNeedUpdate=!0,s.enabled=i)}}createWaypointLinePath(e,t){return{vertices:e.waypoints.map((e=>({type:a.Waypoint,enabled:!0,lineHead:!0,waypoint:e,position:e.target.getWorldCoords().clone()}))),verticesNeedUpdate:!1,color:10867711,bgColor:t?16777215:0}}updateWaypointLinePath(e){for(var t of e.vertices){let i=t.waypoint.target.getWorldCoords();i.equals(t.position)||(t.position.copy(i),e.verticesNeedUpdate=!0)}}computeInitialTargetPosition(e){if(e.pathNodes.length){var t=e.pathNodes[0];return i.Coords.tile3dToWorld(t.tile.rx+.5,t.tile.ry+.5,t.tile.z+(t.onBridge?.tileElevation??0))}if(e.target)return e.target.position.worldPosition;throw new Error("No target and no pathNodes found")}dispose(){this.sourceLinePaths.forEach((e=>e.lineObj?.dispose())),this.waypointLinePaths.forEach((e=>e.lineObj?.dispose()))}})}}})),System.register("gui/screen/game/worldInteraction/PlanningMode",["game/order/OrderType","engine/sound/SoundKey","engine/sound/ChannelType","engine/type/ObjectType","util/typeGuard","engine/renderable/entity/WaypointLines","game/action/OrderUnitsAction"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("PlanningMode",class{constructor(e,t,i,r,s,n,a,o,l,c){this.player=e,this.messageList=t,this.sound=i,this.strings=r,this.worldScene=s,this.unitSelection=n,this.unitSelectionHandler=a,this.renderer=o,this.targetLines=l,this.maxWaypointPathLength=c,this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits=new Set,this.onFrame=e=>{(!this.lastUpdate||e-this.lastUpdate>1e3/15)&&(this.lastUpdate=e,this.updatePaths())}}isActive(){return this.active}enter(){var e;this.active||(this.active=!0,this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!1),this.renderer.onFrame.subscribe(this.onFrame),e=new Set([...this.player.getOwnedObjectsByType(n.ObjectType.Infantry),...this.player.getOwnedObjectsByType(n.ObjectType.Vehicle)].map((e=>e.unitOrderTrait.waypointPath)).filter(a.isNotNullOrUndefined)),this.paths=[...e].map((e=>{let t={original:e,units:new Set(e.units),waypoints:[]};return e.waypoints.forEach((e=>{var i={orderType:e.orderType,target:e.target,next:void 0,draft:!1,terminal:e.terminal,original:e};t.waypoints.length&&(t.waypoints[t.waypoints.length-1].next=i),t.waypoints.push(i)})),t})),e=this.waypointLines=new o.WaypointLines(this.unitSelection,this.player,this.selectedPaths,this.paths,this.worldScene.camera),this.worldScene.add(e))}pushOrder(e,t,n){if(e!==i.OrderType.Deploy)if(1<this.selectedPaths.length)this.handleInvalidCommand(this.strings.get("MSG:PlanningModeHeteroSel"));else if(this.selectedUnits.size>l.ORDER_UNIT_LIMIT)this.handleInvalidCommand(this.strings.get("MSG:PlannerMaximum"));else{for(var a of this.selectedUnits){if(a.isBuilding())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoBuildings"));if(a.isAircraft())return void this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoAircraft"))}let i=this.selectedPaths[0];var o;!i&&this.selectedUnits.size&&(i={original:void 0,units:new Set(this.selectedUnits),waypoints:[]},this.paths.push(i),this.selectedPaths.push(i)),i&&(i.waypoints.length!==this.maxWaypointPathLength?i.waypoints.find((e=>e.target.equals(t)))?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeInvalidNodeX")):i.waypoints.length&&i.waypoints.slice(i.waypoints[0].draft?0:1).find((e=>e.terminal))?this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")):(o={orderType:e,target:t,terminal:n,next:void 0,draft:!0,original:void 0},i.waypoints.length&&(i.waypoints[i.waypoints.length-1].next=o),i.waypoints.push(o),n?(this.handleInvalidCommand(this.strings.get("MSG:PostTerminatingCommand")),this.unitSelectionHandler.deselectAll()):this.sound.play(r.SoundKey.AddPlanningModeCommandSound,s.ChannelType.Ui)):this.handleInvalidCommand(this.strings.get("MSG:NodeMaximum")))}else this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy"))}exit(){let e=this.paths;for(var t of(this.active&&(this.targetLines.get3DObject()&&(this.targetLines.get3DObject().visible=!0),this.renderer.onFrame.unsubscribe(this.onFrame),this.active=!1,this.paths=[],this.selectedPaths=[],this.selectedUnits.clear(),this.waypointLines&&(this.worldScene.remove(this.waypointLines),this.waypointLines.dispose(),this.waypointLines=void 0)),e))t.waypoints=t.waypoints.filter((e=>e.draft));return e.filter((e=>e.waypoints.length))}updatePaths(){for(let t of this.paths){var e;t.original&&(t.original.units.length===t.units.size||t.waypoints.find((e=>e.draft))||(t.units=new Set(t.original.units)),0===t.original.units.length?t.waypoints=t.waypoints.filter((e=>e.draft)):t.waypoints=t.waypoints.filter((e=>e.draft||t.original.waypoints.includes(e.original))),t.waypoints.length||(this.paths.splice(this.paths.indexOf(t),1),-1!==(e=this.selectedPaths.indexOf(t))&&this.selectedPaths.splice(e,1)))}}updateSelection(e){this.updatePaths();let t=[...e],i=new Set;for(var r of e)for(var s of this.paths)s.units.has(r)&&(i.add(s),t.push(...s.units));this.selectedPaths.length=0,this.selectedPaths.push(...i);var n=new Set(t);if((this.selectedUnits=n).size!==e.length)return[...this.selectedUnits]}handleInvalidCommand(e){this.sound.play(r.SoundKey.ScoldSound,s.ChannelType.Ui),this.messageList.addUiFeedbackMessage(e)}dispose(){this.exit()}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd",["util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SelectNextUnitCmd",class{constructor(e,t,r,s,n){this.unitSelectionHandler=e,this.mapPanningHelper=t,this.cameraPan=r,this.player=s,this.world=n,this.reverse=!1,this.unitList=[],this.disposables=new i.CompositeDisposable;const a=e=>{e.isTechno()&&e.owner===s&&this.unitList.push(e)};this.world.onObjectSpawned.subscribe(a),this.disposables.add((()=>this.world.onObjectSpawned.unsubscribe(a)))}getNextUnit(){return this.generator||(this.generator=this.generate()),this.generator.next().value}*generate(){for(;;){var e=this.unitList=this.player.getOwnedObjects().filter((e=>e.isUnit())).sort(((e,t)=>e.tile.dx+1e3*e.tile.dy-(t.tile.dx+1e3*t.tile.dy)+.1*(t.position.subCell-e.position.subCell)));if(e.length){let i=this.reverse?e.length:-1;for(;this.reverse?0<=--i:++i<e.length;){if(this.unitSelectionHandler.getHash()!==this.lastSelectionHash){this.lastSelectionHash=this.unitSelectionHandler.getHash();break}var t=e[i];t.owner===this.player&&t.isSpawned&&(yield t)}}else yield}}setReverse(e){this.reverse=e}execute(){var e=this.getNextUnit();e&&(this.unitSelectionHandler.selectSingleUnit(e),this.lastSelectionHash=this.unitSelectionHandler.getHash(),e=e.tile,e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}dispose(){this.disposables.dispose()}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("SetCameraLocationCmd",class{constructor(e,t,i){this.cameraPan=e,this.cameraLocations=t,this.idx=i}execute(){this.cameraLocations.set(this.idx,this.cameraPan.getPan())}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("GoToCameraLocationCmd",class{constructor(e,t,i,r){this.cameraPan=e,this.cameraLocations=t,this.idx=i,this.defaultLocation=r}execute(){var e=this.cameraLocations.get(this.idx)||this.defaultLocation;e&&this.cameraPan.setPan(e)}})}}})),System.register("gui/screen/game/TauntPlayback",["engine/sound/ChannelType","util/string"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=(new Map).set("Americans","am").set("French","fr").set("Germans","ge").set("British","br").set("Russians","ru").set("Confederation","cu").set("Africans","li").set("Arabs","ir").set("Alliance","ko"),e("TauntPlayback",class{constructor(e,t){this.audioSystem=e,this.taunts=t}async playTaunt(e,t){var r=this.getTauntFileName(e.country.name,t),s=await this.taunts.get(r);s?this.audioSystem.playWavFile(s,i.ChannelType.Voice):console.warn(`Taunt file "${r}" not found.`)}getTauntFileName(e,t){return`tau${s.get(e)}${r.pad(t,"00")}.wav`}})}}})),System.register("gui/screen/game/TauntHandler",["util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("TauntHandler",class{constructor(e,t,r,s,n,a,o){this.gservCon=e,this.localPlayer=t,this.game=r,this.replayRecorder=s,this.tauntsEnabled=n,this.tauntPlayback=a,this.mutedPlayers=o,this.lastTauntTimeByPlayer=new Map,this.disposables=new i.CompositeDisposable,this.handleMessage=e=>{var t;!this.tauntsEnabled.value||(t=this.game.getPlayerByName(e.from)).country&&(this.mutedPlayers.has(t.name)||this.checkAndUpdateLastTauntTime(t.name)&&(this.recordReplayEvent(t,e.tauntNo),this.tauntPlayback.playTaunt(t,e.tauntNo).catch((e=>console.error(e)))))}}init(){this.gservCon.onTaunt.subscribe(this.handleMessage),this.disposables.add((()=>this.gservCon.onTaunt.unsubscribe(this.handleMessage)))}sendTaunt(e){this.checkAndUpdateLastTauntTime(this.localPlayer.name)&&this.gservCon.isOpen()&&(this.gservCon.sendTaunt(e),this.recordReplayEvent(this.localPlayer,e),this.tauntPlayback.playTaunt(this.localPlayer,e).catch((e=>console.error(e))))}checkAndUpdateLastTauntTime(e){var t=Date.now(),i=this.lastTauntTimeByPlayer.get(e);return!(i&&t-i<=5e3||(this.lastTauntTimeByPlayer.set(e,t),0))}recordReplayEvent(e,t){this.replayRecorder.recordTaunt(this.game.currentTick,e.name,t)}dispose(){this.disposables.dispose()}})}}})),System.register("engine/gfx/lighting/LightningStormFx",["engine/gfx/lighting/LightingFx"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=class extends i.LightingFx{constructor(e,t){super(),this.durationGameSeconds=e,this.ionLighting=t,this.cloudAnims=[]}waitForCloudAnim(e){this.cloudAnims.push(e)}update(e,t){let i=!1,r=!1;return e===this.startTime&&(this.mapLighting.copy(this.ionLighting),i=!0),(e-this.startTime)/1e3*t>this.durationGameSeconds&&!this.cloudAnims.some((e=>!e.isAnimFinished()))&&(r=!0),{done:r,updated:i}}},e("LightningStormFx",r)}}})),System.register("engine/renderable/fx/handler/SuperWeaponFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","util/math","engine/gfx/lighting/LightningStormFx","game/GameSpeed","game/type/SuperWeaponType","game/Coords"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e}],execute:function(){e("SuperWeaponFxHandler",class{constructor(e,t,i){this.game=e,this.renderableManager=t,this.lightingDirector=i,this.disposables=new r.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(i.EventType.LightningStormCloud,(e=>{var t=(t=this.game.rules.audioVisual.weatherConClouds)[s.getRandomInt(0,t.length-1)];t=this.renderableManager.createTransientAnim(t,(t=>{t.setPosition(e.position)}));this.lightingFx?.waitForCloudAnim(t)})),this.game.events.subscribe(i.EventType.LightningStormManifest,(()=>{var e=this.lightingFx=new n.LightningStormFx(this.game.rules.general.lightningStorm.duration/a.GameSpeed.BASE_TICKS_PER_SECOND,this.game.map.getIonLighting());this.lightingDirector.addEffect(e)})),this.game.events.subscribe(i.EventType.SuperWeaponActivate,(e=>{var t=e.target;if(t===o.SuperWeaponType.IronCurtain)this.renderableManager.createTransientAnim(this.game.rules.audioVisual.ironCurtainInvokeAnim,(t=>{var i=l.Coords.tile3dToWorld(e.atTile.rx+.5,e.atTile.ry+.5,e.atTile.z);t.setPosition(i)}));else if(t===o.SuperWeaponType.ChronoSphere){this.disposeChronoSphereAnim();var i=this.game.map.tileOccupation.getBridgeOnTile(e.atTile)?.tileElevation??0;let r=l.Coords.tile3dToWorld(e.atTile.rx+.5,e.atTile.ry+.5,e.atTile.z+i);t=e.atTile2,i=this.game.map.tileOccupation.getBridgeOnTile(t)?.tileElevation??0;let s=l.Coords.tile3dToWorld(t.rx+.5,t.ry+.5,t.z+i);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlast,(e=>{e.setPosition(r)})),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.chronoBlastDest,(e=>{e.setPosition(s)}))}})))}createChronoSphereAnim(e){this.chronoSphereAnim=this.renderableManager.createAnim(this.game.rules.audioVisual.chronoPlacement,(t=>{var i=this.game.map.tileOccupation.getBridgeOnTile(e)?.tileElevation??0;i=l.Coords.tile3dToWorld(e.rx+.5,e.ry+.5,e.z+i);t.setPosition(i)}))}disposeChronoSphereAnim(){let e=this.chronoSphereAnim;e&&(this.renderableManager.getRenderableContainer()?.remove(e),e.dispose())}dispose(){this.lightingFx=void 0,this.disposeChronoSphereAnim(),this.disposables.dispose()}})}}})),System.register("gui/screen/game/worldInteraction/SpecialActionMode",["gui/PointerType","util/event","game/type/SuperWeaponType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=(new Map).set(s.SuperWeaponType.MultiMissile,i.PointerType.Nuke).set(s.SuperWeaponType.LightningStorm,i.PointerType.Storm).set(s.SuperWeaponType.IronCurtain,i.PointerType.Iron).set(s.SuperWeaponType.ChronoSphere,i.PointerType.Chrono).set(s.SuperWeaponType.ChronoWarp,i.PointerType.Chrono).set(s.SuperWeaponType.AmerParaDrop,i.PointerType.Para).set(s.SuperWeaponType.ParaDrop,i.PointerType.Para),e("SpecialActionMode",class{constructor(e,t,i,s,n){this.allSuperWeaponRules=e,this.superWeaponRules=t,this.superWeaponFxHandler=i,this.pointer=s,this.eva=n,this._onExecute=new r.EventDispatcher,this.isPostClick=!1,this.pointerSwType=this.superWeaponRules.type}get onExecute(){return this._onExecute.asEvent()}get superWeaponType(){return this.superWeaponRules.type}static factory(e,t,i,r,s){return new this(e,t,i,r,s)}enter(){this.eva.play("EVA_SelectTarget")}hover(e){var t=e?.tile,r=n.get(this.pointerSwType);this.pointer.setPointerType(t&&void 0!==r?r:i.PointerType.Default)}execute(e){var t=e?.tile;if(!t)return!1;if(this.superWeaponRules.type!==s.SuperWeaponType.ChronoSphere||this.isPostClick||this.superWeaponFxHandler.createChronoSphereAnim(t),this.superWeaponRules.preClick&&!this.isPostClick){this.isPostClick=!0,this.preTile=t;var i=[...this.allSuperWeaponRules.values()].find((e=>e.postClick&&e.preDependent===this.superWeaponRules.type))?.type;if(void 0===i)throw new Error('No super weapon section found with PostClick=yes and PreDependent="'+s.SuperWeaponType[this.superWeaponRules.type]);return this.pointerSwType=i,!1}this._onExecute.dispatch(this,this.isPostClick?{tile:this.preTile,tile2:t}:{tile:t,tile2:void 0})}cancel(){this.end()}end(){this.superWeaponRules.type===s.SuperWeaponType.ChronoSphere&&this.isPostClick&&this.superWeaponFxHandler.disposeChronoSphereAnim()}dispose(){this.end()}})}}})),System.register("game/action/PingLocationAction",["game/action/Action","data/DataStream","game/action/ActionType","game/event/PingLocationEvent","game/event/RadarEvent","game/rules/general/RadarRules"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends i.Action{constructor(e){super(s.ActionType.PingLocation),this.game=e}unserialize(e){let t=new r.DataStream(e);this.tile={x:t.readUint16(),y:t.readUint16()}}serialize(){let e=new r.DataStream(4);return e.writeUint16(this.tile.x),e.writeUint16(this.tile.y),e.toUint8Array()}print(){return`Ping location at tile (${this.tile.x}, ${this.tile.y})`}process(){var e=this.player,t=this.game.map.tiles.getByMapCoords(this.tile.x,this.tile.y);if(t)for(var i of(this.game.events.dispatch(new n.PingLocationEvent(t,e)),[e,...this.game.alliances.getAllies(e)]))this.game.events.dispatch(new a.RadarEvent(i,o.RadarEventType.GenericNonCombat,t));else console.warn(`Tile ${this.tile.x},${this.tile.y} doesn't exist`)}},e("PingLocationAction",l)}}})),System.register("engine/renderable/fx/handler/BeaconFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","engine/sound/SoundKey"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("BeaconFxHandler",class{constructor(e,t,i,a,o){this.game=e,this.localPlayer=t,this.renderableManager=i,this.renderer=a,this.worldSound=o,this.disposables=new r.CompositeDisposable,this.beacons=new Map,this.handlePingEvent=e=>{if((!this.localPlayer||this.localPlayer.isObserver||e.player===this.localPlayer||this.game.alliances.areAllied(e.player,this.localPlayer))&&this.canPingLocation(e.player,e.tile)){let i=this.beacons.get(e.player);i||(i=[],this.beacons.set(e.player,i));let r=i.find((t=>t.tile===e.tile));var t=e.tile.onBridgeLandType?this.game.map.tileOccupation.getBridgeOnTile(e.tile):void 0;let a=s.Coords.tile3dToWorld(e.tile.rx+.5,e.tile.ry+.5,e.tile.z+(t?.tileElevation??0));this.worldSound.playEffect(n.SoundKey.PlaceBeaconSound,a,e.player),r?r.startTime=this.now:(t=this.renderableManager.createTransientAnim("PBEACON",(t=>{t.setPosition(a),t.setRenderOrder(1e6),t.remapColor(e.player.color),t.create3DObject()})),i.push({tile:e.tile,anim:t,startTime:this.now}))}},this.handleFrame=e=>{for(var t of(this.now=e,this.beacons.values()))for(var i of t.slice())if(void 0===i.startTime)i.startTime=e;else if(e>i.startTime+7e3){if(i.anim.endAnimationLoop(),-1===(i=t.indexOf(i)))throw new Error("Beacon not found in array");t.splice(i,1)}}}init(){this.disposables.add(this.game.events.subscribe(i.EventType.PingLocation,this.handlePingEvent)),this.renderer.onFrame.subscribe(this.handleFrame),this.disposables.add((()=>this.renderer.onFrame.unsubscribe(this.handleFrame)))}canPingLocation(e,t){let i=this.beacons.get(e)??[];var r=i.reduce(((e,t)=>Math.max(e,t.startTime??0)),0);return(i.length<3||i.some((e=>e.tile===t)))&&(!this.now||this.now-r>=1e3/3)}dispose(){this.disposables.dispose()}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("CenterViewCmd",class{constructor(e,t,i){this.unitSelectionHandler=e,this.mapPanningHelper=t,this.cameraPan=i}execute(){var e=this.unitSelectionHandler.getSelectedUnits();e.length&&(e=this.computePanTile(e),e=this.mapPanningHelper.computeCameraPanFromTile(e.rx,e.ry),this.cameraPan.setPan(e))}computePanTile(e){return{rx:Math.floor(e.reduce(((e,t)=>e+t.tile.rx),0)/e.length),ry:Math.floor(e.reduce(((e,t)=>e+t.tile.ry),0)/e.length)}}})}}})),System.register("gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd",["util/disposable/CompositeDisposable"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("FollowUnitCmd",class{constructor(e,t,r,s,n,a){this.unitSelectionHandler=e,this.renderableManager=t,this.worldInteraction=r,this.mapPanningHelper=s,this.cameraPan=n,this.worldScene=a,this.disposables=new i.CompositeDisposable,this.handleUserSelectionChange=()=>{this.updateUnit(void 0)},this.handleFrame=()=>{let e=this.unitSelectionHandler.getSelectedUnits();this.unit&&!e.includes(this.unit)&&this.updateUnit(void 0),this.unit&&this.updatePan(this.unit)}}init(){this.unitSelectionHandler.onUserSelectionUpdate.subscribe(this.handleUserSelectionChange),this.disposables.add((()=>this.unitSelectionHandler.onUserSelectionUpdate.unsubscribe(this.handleUserSelectionChange))),this.worldScene.onBeforeCameraUpdate.subscribe(this.handleFrame),this.disposables.add((()=>this.worldScene.onBeforeCameraUpdate.unsubscribe(this.handleFrame)))}execute(){let e=this.unitSelectionHandler.getSelectedUnits();this.unit&&!e.includes(this.unit)&&this.updateUnit(void 0),this.updateUnit(this.unit?void 0:e[0]),this.unit&&this.updatePan(this.unit)}updateUnit(e){(this.unit=e)?this.worldInteraction.pausePanning():this.worldInteraction.unpausePanning()}updatePan(e){let t=this.renderableManager.getRenderableByGameObject(e);var i;t&&(i=this.mapPanningHelper.computeCameraPanFromWorld(t.getPosition()),this.cameraPan.setPan(i))}dispose(){this.disposables.dispose()}})}}})),System.register("gui/screen/game/worldInteraction/PendingPlacementHandler",["game/event/EventType","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/placementMode/PlacementGrid"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("PendingPlacementHandler",class{constructor(e,t,i,s){this.game=e,this.constructionWorker=t,this.renderer=i,this.worldScene=s,this.placements=[],this.gridModels=new Map,this.grids=new Map,this.disposables=new r.CompositeDisposable,this.onFrame=()=>{for(var e of this.placements){let i=this.gridModels.get(e);var t;i&&(t=e.rules.name,i.tiles=this.constructionWorker.getPlacementPreview(t,e.tile,{normalizedTile:!0}))}}}static factory(e,t,i,r){var s=e.getConstructionWorker(t);return new this(e,s,i,r)}pushPlacementInfo(e){this.placements.push(e),this.addGrid(e)}init(){this.renderer.onFrame.subscribe(this.onFrame),this.disposables.add((()=>this.renderer.onFrame.unsubscribe(this.onFrame))),this.disposables.add(this.game.events.subscribe(i.EventType.BuildingPlace,(e=>{this.removePendingPlacement(e.target.tile)})),this.game.events.subscribe(i.EventType.BuildingFailedPlace,(e=>{this.removePendingPlacement(e.tile)})))}removePendingPlacement(e){var t=this.placements.findIndex((t=>t.tile===e)),i=this.placements[t];-1!==t&&(this.placements.splice(t,1),this.removeGrid(i))}addGrid(e){var t={tiles:this.constructionWorker.getPlacementPreview(e.rules.name,e.tile,{normalizedTile:!0}),visible:!0,rangeIndicator:void 0,rangeIndicatorColor:void 0,showBusy:!0},i=new s.PlacementGrid(t,this.worldScene.camera,this.game.map.tiles);this.worldScene.add(i),this.gridModels.set(e,t),this.grids.set(e,i)}removeGrid(e){let t=this.grids.get(e);t&&(this.worldScene.remove(t),t.dispose(),this.gridModels.delete(e))}dispose(){for(var e of this.placements)this.removeGrid(e);this.disposables.dispose()}})}}})),System.register("gui/screen/game/worldInteraction/BeaconMode",["gui/PointerType","util/event"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("BeaconMode",class{constructor(e,t){this.pointer=e,this.renderer=t,this._onExecute=new r.EventDispatcher,this.onFrame=e=>{var t;(this.lastTile!==this.currentTile||!this.lastUpdate||e-this.lastUpdate>=1e3/15)&&(this.lastTile=this.currentTile,this.lastUpdate=e,t=this.currentTile,this.pointer.setPointerType(t?i.PointerType.Beacon:i.PointerType.Default))}}get onExecute(){return this._onExecute.asEvent()}static factory(e,t){return new this(e,t)}enter(){this.currentTile=void 0,this.lastTile=void 0,this.lastUpdate=void 0,this.renderer.onFrame.subscribe(this.onFrame)}hover(e,t){t||(this.currentTile=e?.tile)}execute(e,t){if(t)return!1;var i=e?.tile;if(!i)return!1;this._onExecute.dispatch(this,i),this.end()}cancel(){this.end()}end(){this.renderer.onFrame.unsubscribe(this.onFrame)}dispose(){this.end()}})}}})),System.register("gui/screen/mainMenu/main/ReportBug",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ReportBug",(({strings:e,discordUrl:t})=>i.createElement("div",null,e.get("TS:ReportBugDesc"),i.createElement("br",null),i.createElement("br",null),i.createElement("a",{target:"_blank",href:t},t))))}}})),System.register("gui/screen/game/CombatantUi",["react","gui/screen/game/worldInteraction/PlacementMode","game/action/ActionType","util/disposable/CompositeDisposable","engine/sound/SoundKey","engine/sound/ChannelType","game/order/OrderType","game/action/OrderUnitsAction","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/keyboard/command/SelectGroupCmd","gui/screen/game/worldInteraction/keyboard/command/CenterGroupCmd","gui/screen/game/component/hud/viewmodel/SidebarModel","game/event/EventType","gui/screen/game/worldInteraction/SellMode","gui/screen/game/worldInteraction/keyboard/command/LastRadarEventCmd","game/player/production/ProductionQueue","engine/type/ObjectType","game/action/UpdateQueueAction","gui/screen/game/worldInteraction/RepairMode","gui/screen/game/worldInteraction/keyboard/KeyCommand","gui/screen/game/worldInteraction/PlanningMode","game/order/OrderFeedbackType","game/rules/TechnoRules","gui/screen/game/worldInteraction/keyboard/command/SelectNextUnitCmd","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","gui/screen/game/worldInteraction/SpecialActionMode","game/SuperWeapon","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/worldInteraction/PendingPlacementHandler","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/game/worldInteraction/BeaconMode","gui/screen/mainMenu/main/ReportBug"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e}],execute:function(){e("CombatantUi",class{constructor(e,t,i,r,s,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E){this.game=e,this.player=t,this.isSinglePlayer=i,this.actionQueue=r,this.actionFactory=s,this.sidebarModel=a,this.renderer=o,this.worldScene=l,this.soundHandler=c,this.messageList=h,this.sound=u,this.eva=d,this.worldInteractionFactory=g,this.gameMenu=p,this.pointer=m,this.runtimeVars=f,this.speedCheat=y,this.strings=T,this.tauntHandler=v,this.renderableManager=b,this.superWeaponFxHandler=S,this.beaconFxHandler=w,this.messageBoxApi=C,this.discordUrl=E,this.disposables=new n.CompositeDisposable}init(e){let t=this.game.getUnitSelection(),i=r.PlacementMode.factory(this.game,this.player,this.renderer,this.worldScene,this.eva);this.placementMode=i,this.disposables.add(i);let n=B.PendingPlacementHandler.factory(this.game,this.player,this.renderer,this.worldScene);n.init(),this.disposables.add(n),i.onBuildingPlaceRequest.subscribe((({rules:e,tile:t})=>{n.pushPlacementInfo({rules:e,tile:t}),this.pushAction(s.ActionType.PlaceBuilding,(i=>{i.buildingRules=e,i.tile={x:t.rx,y:t.ry}}))}));let l=f.SellMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.sellMode=l,this.disposables.add(l),l.onExecute.subscribe((e=>{this.pushAction(s.ActionType.SellBuilding,(t=>{t.buildingId=e.id}))}));let c=S.RepairMode.factory(this.game,this.player,this.sidebarModel,this.pointer,this.renderer);this.repairMode=c,this.disposables.add(c);let h=N.BeaconMode.factory(this.pointer,this.renderer);this.beaconMode=h,this.disposables.add(h),c.onExecute.subscribe((e=>{this.pushAction(s.ActionType.ToggleRepair,(t=>{t.buildingId=e.id})),this.sound.play(a.SoundKey.GenericClick,o.ChannelType.Ui)})),h.onExecute.subscribe((e=>this.handleBeacon(e)));let u=this.worldInteractionFactory.create();this.worldInteraction=u,u.init(),this.disposables.add(u);let d=new C.PlanningMode(this.player,this.messageList,this.sound,this.strings,this.worldScene,t,u.unitSelectionHandler,this.renderer,u.targetLines,this.game.rules.general.maxWaypointPathLength);this.planningMode=d,this.disposables.add(d),this.disposables.add((()=>this.specialMode?.dispose())),i.init(),this.initKeyboardCommands(u),this.initGameEventListeners(),this.initGameMenuListeners(),this.initHudEventListeners(e,l,c,h,u),this.lastSelectionHash=t.getHash(),u.unitSelectionHandler.onUserSelectionChange.subscribe((e=>{if(d.isActive()){var i=d.updateSelection(e.selection);if(i)for(var r of i)t.addToSelection(r)}this.lastSelectionHash=t.getHash(),this.pushAction(s.ActionType.SelectUnits,(e=>{e.unitIds=t.getSelectedUnits().map((e=>e.id))}))})),u.unitSelectionHandler.onUserSelectionUpdate.subscribe((e=>this.soundHandler.handleSelectionChangeEvent(e))),u.defaultActionHandler.onOrder.subscribe((({orderType:e,terminal:t,feedbackType:i,feedbackUnit:r,target:s})=>{d.isActive()?d.pushOrder(e,s,t):this.pushOrder(e,s,i,r)}))}handleHudChange(e){this.worldInteraction&&this.initHudEventListeners(e,this.sellMode,this.repairMode,this.beaconMode,this.worldInteraction)}dispose(){this.disposables.dispose()}initGameEventListeners(){let e=e=>{e.isTechno()&&e.owner===this.player&&(e.isBuilding()||Number.isFinite(e.rules.buildLimit)||e.isVehicle()&&e.transportTrait||this.game.rules.general.padAircraft.includes(e.name))&&(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))},t=this.game.getWorld();this.sidebarModel.updateAvailableObjects(this.game.art),t.onObjectSpawned.subscribe(e),t.onObjectRemoved.subscribe(e),this.disposables.add((()=>t.onObjectSpawned.unsubscribe(e)),(()=>t.onObjectRemoved.unsubscribe(e))),this.disposables.add(this.game.events.subscribe(m.EventType.BuildingInfiltration,(e=>{e.source.owner===this.player&&this.sidebarModel.updateAvailableObjects(this.game.art)}))),this.disposables.add(this.game.events.subscribe(m.EventType.ObjectOwnerChange,(e=>{!e.target.isBuilding()||e.prevOwner!==this.player&&e.target.owner!==this.player||(this.sidebarModel.updateAvailableObjects(this.game.art),this.soundHandler.handleAvailableObjectsUpdate(this.player.production.getAvailableObjects()))}))),this.player.production.onQueueUpdate.subscribe((e=>{this.sidebarModel.updateFromQueue(e);var t=this.placementMode.getBuilding();t&&!this.player.production.getQueueForObject(t).find(t).length&&this.worldInteraction.setMode(void 0),this.soundHandler.handleProductionQueueUpdate(e)}));let i=()=>{this.sidebarModel.updateSuperWeapons(),this.specialMode&&this.worldInteraction.getMode()===this.specialMode&&!this.player.superWeaponsTrait.getAll().find((e=>e.rules.type===this.specialMode.superWeaponType))&&(this.worldInteraction.setMode(void 0),this.specialMode.dispose(),this.specialMode=void 0)};this.renderer.onFrame.subscribe(i),this.disposables.add((()=>this.renderer.onFrame.unsubscribe(i))),this.disposables.add(this.game.events.subscribe((e=>{e.type===m.EventType.PowerChange&&e.target===this.player&&(this.sidebarModel.powerGenerated=e.power,this.sidebarModel.powerDrained=e.drain)})))}initGameMenuListeners(){const e=(e,t)=>{this.pushAction(s.ActionType.ToggleAlliance,(i=>{i.toPlayer=t,i.toggle=e}))};this.gameMenu.onToggleAlliance.subscribe(e),this.disposables.add((()=>this.gameMenu.onToggleAlliance.unsubscribe(e)))}initHudEventListeners(e,t,r,s,n){e.onSidebarSlotClick.subscribe((e=>this.handleSidebarSlotClick(e))),e.onSidebarTabClick.subscribe((()=>{this.sound.play(a.SoundKey.GUITabSound,o.ChannelType.Ui)})),e.onRepairButtonClick.subscribe((()=>{n.isEnabled()&&(this.sidebarModel.repairMode?n.setMode(void 0):n.setMode(r),this.sound.play(a.SoundKey.GenericClick,o.ChannelType.Ui))})),e.onSellButtonClick.subscribe((()=>{n.isEnabled()&&(this.sidebarModel.sellMode?n.setMode(void 0):n.setMode(t),this.sound.play(a.SoundKey.GenericClick,o.ChannelType.Ui))}));let c=this.game.rules.audioVisual.creditTicks;e.onCreditsTick.subscribe((e=>{this.sound.play("up"===e?c[0]:c[1],o.ChannelType.CreditTicks)})),e.onMessagesTick.subscribe((()=>{this.sound.play(a.SoundKey.MessageCharTyped,o.ChannelType.Ui)})),e.onScrollButtonClick.subscribe((e=>{this.sound.play(e?a.SoundKey.GenericClick:a.SoundKey.ScoldSound,o.ChannelType.Ui)}));let h=!1,u=n.unitSelectionHandler;e.onCommandBarButtonClick.subscribe((e=>{switch(e){case j.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(i.createElement(L.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"));break;case j.CommandBarButtonType.Beacon:n.getMode()!==s&&n.setMode(s);break;case j.CommandBarButtonType.Cheer:this.pushOrder(l.OrderType.Cheer,void 0);break;case j.CommandBarButtonType.Deploy:this.handleDeploy();break;case j.CommandBarButtonType.Guard:this.handleGuard();break;case j.CommandBarButtonType.PlanningMode:var t;this.planningMode.isActive()?(t=this.planningMode.exit(),this.sound.play(a.SoundKey.EndPlanningModeSound,o.ChannelType.Ui),this.queueOrders(t),h||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),h=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(n.unitSelectionHandler.getSelectedUnits()),this.sound.play(a.SoundKey.StartPlanningModeSound,o.ChannelType.Ui),h||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Button")));break;case j.CommandBarButtonType.Stop:this.handleStop();break;case j.CommandBarButtonType.Team01:this.handleCommandBarTeam(1,u);break;case j.CommandBarButtonType.Team02:this.handleCommandBarTeam(2,u);break;case j.CommandBarButtonType.Team03:this.handleCommandBarTeam(3,u);break;case j.CommandBarButtonType.TypeSelect:u.selectByType();break;default:console.warn("Unhandled command type "+e)}}))}handleSidebarSlotClick(e){if(this.worldInteraction.isEnabled())if((e=e.isTouch&&0===e.button&&e.touchDuration&&300<e.touchDuration?{...e,shiftKey:!0,button:2}:e).target.type!==p.SidebarItemTargetType.Special){const r=e.target.rules;let n=this.player.production.getQueueForObject(r),l=n.find(r);var t=l.reduce(((e,t)=>e+t.quantity),0);let c=!1;if(0===e.button)if(n.status===T.QueueStatus.Ready&&r.type===v.ObjectType.Building)l[0]===n.getFirst()?(this.placementMode.setBuilding(r),this.worldInteraction.setMode(this.placementMode)):this.eva.play("EVA_UnableToComply");else if(n.status===T.QueueStatus.OnHold&&l[0]===n.getFirst())this.pushAction(s.ActionType.UpdateQueue,(e=>{e.queueType=n.type,e.updateType=b.UpdateType.Resume}));else{var i=Math.min(n.maxSize-n.currentSize,n.maxItemQuantity-t);let l=Math.min(e.shiftKey?5:1,i);l<=0?r.type===v.ObjectType.Building?this.eva.play("EVA_UnableToComply"):(c=!0,this.sound.play(a.SoundKey.ScoldSound,o.ChannelType.Ui)):this.pushAction(s.ActionType.UpdateQueue,(e=>{e.queueType=n.type,e.updateType=b.UpdateType.Add,e.item=r,e.quantity=l}))}else{if(2!==e.button)return;if(n.status===T.QueueStatus.Active&&l[0]===n.getFirst())this.pushAction(s.ActionType.UpdateQueue,(e=>{e.queueType=n.type,e.updateType=b.UpdateType.Pause}));else if(l.length&&[T.QueueStatus.Ready,T.QueueStatus.OnHold,T.QueueStatus.Active].includes(n.status)){let i=Math.min(t,e.shiftKey?Number.POSITIVE_INFINITY:1);0<i&&(this.pushAction(s.ActionType.UpdateQueue,(e=>{e.queueType=n.type,e.updateType=b.UpdateType.Cancel,e.item=r,e.quantity=i})),this.eva.play("EVA_Canceled"))}else c=!0}c||this.sound.play(a.SoundKey.GenericClick,o.ChannelType.Ui)}else if(0===e.button){if(this.sound.play(a.SoundKey.GenericClick,o.ChannelType.Ui),this.player.superWeaponsTrait?.getAll().find((t=>t.rules===e.target.rules))?.status!==P.SuperWeaponStatus.Ready)return;void 0!==e.target.rules.type&&this.activateSpecialMode(e.target.rules)}}pushOrder(e,t,i=E.OrderFeedbackType.None,r=void 0){let n=this.game.getUnitSelection();var a=n.getHash();let o=n.getSelectedUnits(),l=this.actionQueue.getLast();if(l&&l instanceof c.OrderUnitsAction&&l.orderType===e&&!l.queue&&a===this.lastSelectionHash){if(!l.target||!t||l.target.equals(t))return;this.actionQueue.dequeueLast()}a!==this.lastSelectionHash&&(this.lastSelectionHash=a,this.pushAction(s.ActionType.SelectUnits,(e=>{e.unitIds=o.map((e=>e.id))}))),this.pushAction(s.ActionType.OrderUnits,(i=>{i.orderType=e,i.target=t})),this.soundHandler.handleOrderPushed(r||o[0],e,i)}queueOrders(e){if(e.length){for(let t of e){this.pushAction(s.ActionType.SelectUnits,(e=>{e.unitIds=[...t.units].map((e=>e.id))}));for(let e of t.waypoints)this.pushAction(s.ActionType.OrderUnits,(t=>{t.orderType=e.orderType,t.target=e.target,t.queue=!0}))}this.pushAction(s.ActionType.SelectUnits,(e=>{e.unitIds=this.worldInteraction.unitSelectionHandler.getSelectedUnits().map((e=>e.id))}))}}pushAction(e,t){var i=this.actionFactory.create(e);t?.(i),this.actionQueue.push(i)}activateSpecialMode(e){this.specialMode?.dispose();let t=this.specialMode=R.SpecialActionMode.factory(this.game.rules.superWeaponRules,e,this.superWeaponFxHandler,this.pointer,this.eva);t.onExecute.subscribe((({tile:t,tile2:i})=>{this.pushAction(s.ActionType.ActivateSuperWeapon,(r=>{r.superWeaponType=e.type,r.tile={x:t.rx,y:t.ry},i&&(r.tile2={x:i.rx,y:i.ry})}))})),this.worldInteraction.setMode(t)}initKeyboardCommands(e){let t=e.unitSelectionHandler;e.registerKeyCommand(h.KeyCommandType.Options,(()=>this.gameMenu.open())).registerKeyCommand(h.KeyCommandType.Scoreboard,(()=>this.gameMenu.openDiplo())).registerKeyCommand(h.KeyCommandType.DeployObject,(()=>this.handleDeploy())).registerKeyCommand(h.KeyCommandType.StopObject,(()=>this.handleStop())).registerKeyCommand(h.KeyCommandType.GuardObject,(()=>this.handleGuard())).registerKeyCommand(h.KeyCommandType.AllToCheer,(()=>this.pushOrder(l.OrderType.Cheer,void 0))).registerKeyCommand(h.KeyCommandType.TypeSelect,(()=>t.selectByType())).registerKeyCommand(h.KeyCommandType.CombatantSelect,(()=>t.selectCombatants())).registerKeyCommand(h.KeyCommandType.VeterancyNav,(()=>t.selectByVeterancy())).registerKeyCommand(h.KeyCommandType.HealthNav,(()=>t.selectByHealth())),[h.KeyCommandType.TeamCreate_1,h.KeyCommandType.TeamCreate_2,h.KeyCommandType.TeamCreate_3,h.KeyCommandType.TeamCreate_4,h.KeyCommandType.TeamCreate_5,h.KeyCommandType.TeamCreate_6,h.KeyCommandType.TeamCreate_7,h.KeyCommandType.TeamCreate_8,h.KeyCommandType.TeamCreate_9,h.KeyCommandType.TeamCreate_10].forEach(((i,r)=>e.registerKeyCommand(i,(()=>t.createGroup((r+1)%10))))),[h.KeyCommandType.TeamAddSelect_1,h.KeyCommandType.TeamAddSelect_2,h.KeyCommandType.TeamAddSelect_3,h.KeyCommandType.TeamAddSelect_4,h.KeyCommandType.TeamAddSelect_5,h.KeyCommandType.TeamAddSelect_6,h.KeyCommandType.TeamAddSelect_7,h.KeyCommandType.TeamAddSelect_8,h.KeyCommandType.TeamAddSelect_9,h.KeyCommandType.TeamAddSelect_10].forEach(((i,r)=>e.registerKeyCommand(i,(()=>t.addGroupToSelection((r+1)%10)))));let i=new u.MapPanningHelper(this.game.map);[h.KeyCommandType.TeamSelect_1,h.KeyCommandType.TeamSelect_2,h.KeyCommandType.TeamSelect_3,h.KeyCommandType.TeamSelect_4,h.KeyCommandType.TeamSelect_5,h.KeyCommandType.TeamSelect_6,h.KeyCommandType.TeamSelect_7,h.KeyCommandType.TeamSelect_8,h.KeyCommandType.TeamSelect_9,h.KeyCommandType.TeamSelect_10].forEach(((r,s)=>e.registerKeyCommand(r,new d.SelectGroupCmd((s+1)%10,t,e.targetLines,i,this.worldScene.cameraPan)))),[h.KeyCommandType.TeamCenter_1,h.KeyCommandType.TeamCenter_2,h.KeyCommandType.TeamCenter_3,h.KeyCommandType.TeamCenter_4,h.KeyCommandType.TeamCenter_5,h.KeyCommandType.TeamCenter_6,h.KeyCommandType.TeamCenter_7,h.KeyCommandType.TeamCenter_8,h.KeyCommandType.TeamCenter_9,h.KeyCommandType.TeamCenter_10].forEach(((r,s)=>e.registerKeyCommand(r,new g.CenterGroupCmd((s+1)%10,t,i,this.worldScene.cameraPan)))),new Map([[h.KeyCommandType.StructureTab,p.SidebarCategory.Structures],[h.KeyCommandType.DefenseTab,p.SidebarCategory.Armory],[h.KeyCommandType.InfantryTab,p.SidebarCategory.Infantry],[h.KeyCommandType.UnitTab,p.SidebarCategory.Vehicles]]).forEach(((t,i)=>{e.registerKeyCommand(i,(()=>{var i;for(i of(this.sidebarModel.selectTab(t),this.player.production.getAllQueues().filter((e=>e.status===T.QueueStatus.Ready)))){var r=this.sidebarModel.getTabForQueueType(i.type);if(t===r.id&&i.getFirst().rules.type===v.ObjectType.Building){this.placementMode.setBuilding(i.getFirst().rules),e.setMode(this.placementMode);break}}}))})),e.registerKeyCommand(h.KeyCommandType.CenterBase,(()=>{let e;var t=this.player.production.getPrimaryFactory(x.FactoryType.BuildingType);t?e=t.centerTile:(t=this.player.getOwnedObjectsByType(v.ObjectType.Vehicle).find((e=>this.game.rules.general.baseUnit.includes(e.name))))&&(e=t.tile),e&&this.worldScene.cameraPan.setPan(i.computeCameraPanFromTile(e.rx,e.ry))})),e.registerKeyCommand(h.KeyCommandType.ToggleSell,(()=>{this.sidebarModel.sellMode?e.setMode(void 0):e.setMode(this.sellMode)})),e.registerKeyCommand(h.KeyCommandType.ToggleRepair,(()=>{this.sidebarModel.repairMode?e.setMode(void 0):e.setMode(this.repairMode)}));let r=new y.LastRadarEventCmd(this.player,i,this.worldScene.cameraPan);e.registerKeyCommand(h.KeyCommandType.CenterOnRadarEvent,r),this.disposables.add(this.game.events.subscribe((e=>r.handleGameEvent(e))));let n=()=>{this.runtimeVars.cheatsEnabled.value?e.registerKeyCommand(h.KeyCommandType.BuildCheat,(()=>this.speedCheat.value=!this.speedCheat.value)).registerKeyCommand(h.KeyCommandType.FreeMoney,(()=>this.player.credits+=1e4)).registerKeyCommand(h.KeyCommandType.ToggleShroud,(()=>this.game.mapShroudTrait.revealMap(this.player,this.game))):(e.unregisterKeyCommand(h.KeyCommandType.BuildCheat).unregisterKeyCommand(h.KeyCommandType.FreeMoney).unregisterKeyCommand(h.KeyCommandType.ToggleShroud),this.speedCheat.value=!1)};n(),this.runtimeVars.cheatsEnabled.onChange.subscribe(n),this.disposables.add((()=>this.runtimeVars.cheatsEnabled.onChange.unsubscribe(n))),e.registerKeyCommand(h.KeyCommandType.ToggleFps,(()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value)),e.registerKeyCommand(h.KeyCommandType.ToggleAlliance,(()=>{var e=this.game.rules.mpDialogSettings;if(e.alliesAllowed&&e.allyChangeAllowed){let e=t.getSelectedUnits()[0]?.owner;e&&e!==this.player&&this.game.alliances.canRequestAlliance(e)&&this.pushAction(s.ActionType.ToggleAlliance,(t=>{t.toPlayer=e,t.toggle=!this.game.alliances.areAllied(this.player,e)}))}}));let c=!1;e.registerKeyCommand(h.KeyCommandType.PlanningMode,{triggerMode:w.TriggerMode.KeyDownUp,execute:t=>{var i;t?(i=this.planningMode.exit(),this.sound.play(a.SoundKey.EndPlanningModeSound,o.ChannelType.Ui),this.queueOrders(i),c||(this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro3")),c=!0)):(this.planningMode.enter(),this.planningMode.updateSelection(e.unitSelectionHandler.getSelectedUnits()),this.sound.play(a.SoundKey.StartPlanningModeSound,o.ChannelType.Ui),c||this.messageList.addUiFeedbackMessage(this.strings.get("MSG:PlanningModeIntro1Key")))}}),e.registerKeyCommand(h.KeyCommandType.ScatterObject,(()=>{this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoScatter")):this.pushOrder(l.OrderType.Scatter,void 0)}));let m=new O.SelectNextUnitCmd(t,i,this.worldScene.cameraPan,this.player,this.game.getWorld());e.registerKeyCommand(h.KeyCommandType.NextObject,(()=>{m.setReverse(!1),m.execute()})),e.registerKeyCommand(h.KeyCommandType.PreviousObject,(()=>{m.setReverse(!0),m.execute()})),this.disposables.add(m);var f=this.game.map.startingLocations[this.player.startLocation];f=this.game.map.tiles.getByMapCoords(f.x,f.y);let b=i.computeCameraPanFromTile(f.rx,f.ry),S=new Map;[h.KeyCommandType.SetView1,h.KeyCommandType.SetView2,h.KeyCommandType.SetView3,h.KeyCommandType.SetView4].forEach(((t,i)=>{e.registerKeyCommand(t,new A.SetCameraLocationCmd(this.worldScene.cameraPan,S,i-1))})),[h.KeyCommandType.View1,h.KeyCommandType.View2,h.KeyCommandType.View3,h.KeyCommandType.View4].forEach(((t,i)=>{e.registerKeyCommand(t,new M.GoToCameraLocationCmd(this.worldScene.cameraPan,S,i-1,b))})),[h.KeyCommandType.Taunt_1,h.KeyCommandType.Taunt_2,h.KeyCommandType.Taunt_3,h.KeyCommandType.Taunt_4,h.KeyCommandType.Taunt_5,h.KeyCommandType.Taunt_6,h.KeyCommandType.Taunt_7,h.KeyCommandType.Taunt_8].forEach(((t,i)=>{e.registerKeyCommand(t,(()=>this.tauntHandler?.sendTaunt(i+1)))})),e.registerKeyCommand(h.KeyCommandType.PlaceBeacon,(()=>{e.getMode()!==this.beaconMode&&e.setMode(this.beaconMode)})),f=new I.CenterViewCmd(t,i,this.worldScene.cameraPan),e.registerKeyCommand(h.KeyCommandType.CenterView,f);let C=new k.FollowUnitCmd(t,this.renderableManager,e,i,this.worldScene.cameraPan,this.worldScene);C.init(),this.disposables.add(C),e.registerKeyCommand(h.KeyCommandType.Follow,C);let E=()=>this.sound.play(a.SoundKey.SystemError,o.ChannelType.Ui);[h.KeyCommandType.PageUser,h.KeyCommandType.ScreenCapture].forEach((t=>e.registerKeyCommand(t,E)))}handleDeploy(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoDeploy")):this.pushOrder(l.OrderType.DeploySelected,void 0)}handleStop(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoStop")):this.pushOrder(l.OrderType.Stop,void 0)}handleGuard(){this.planningMode.isActive()?this.handleInvalidCommand(this.strings.get("MSG:PlanningModeNoGuardArea")):this.pushOrder(l.OrderType.Guard,void 0)}handleBeacon(e){this.isSinglePlayer||this.beaconFxHandler.canPingLocation(this.player,e)&&this.pushAction(s.ActionType.PingLocation,(t=>{t.tile={x:e.rx,y:e.ry}}))}handleCommandBarTeam(e,t){let i=t.getGroupUnits(e);if(i.length)if(t.getSelectedUnits().some((e=>i.includes(e)))){new g.CenterGroupCmd(e,t,new u.MapPanningHelper(this.game.map),this.worldScene.cameraPan).execute()}else t.selectGroup(e);else t.createGroup(e)}handleInvalidCommand(e){this.sound.play(a.SoundKey.ScoldSound,o.ChannelType.Ui),this.messageList.addUiFeedbackMessage(e)}})}}})),System.register("gui/screen/game/ObserverUi",["react","util/disposable/CompositeDisposable","gui/screen/game/worldInteraction/keyboard/KeyCommandType","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/worldInteraction/keyboard/command/SetCameraLocationCmd","gui/screen/game/worldInteraction/keyboard/command/GoToCameraLocationCmd","engine/util/MapPanningHelper","gui/screen/game/worldInteraction/keyboard/command/CenterViewCmd","gui/screen/game/worldInteraction/keyboard/command/FollowUnitCmd","gui/screen/game/component/hud/commandBar/CommandBarButtonType","gui/screen/mainMenu/main/ReportBug"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){e("ObserverUi",class{constructor(e,t,i,s,n,a,o,l,c,h,u){this.game=e,this.worldInteractionFactory=t,this.cameraPan=i,this.renderableManager=s,this.worldScene=n,this.runtimeVars=a,this.gameMenu=o,this.sound=l,this.strings=c,this.messageBoxApi=h,this.discordUrl=u,this.disposables=new r.CompositeDisposable}init(e){let t=this.worldInteraction=this.worldInteractionFactory.create();t.init(),this.disposables.add(t),this.initHudEventListeners(e),t.registerKeyCommand(s.KeyCommandType.Options,(()=>this.gameMenu.open())),t.registerKeyCommand(s.KeyCommandType.Scoreboard,(()=>this.gameMenu.openDiplo())),t.registerKeyCommand(s.KeyCommandType.ToggleFps,(()=>this.runtimeVars.fps.value=!this.runtimeVars.fps.value));let i=new Map;[s.KeyCommandType.SetView1,s.KeyCommandType.SetView2,s.KeyCommandType.SetView3,s.KeyCommandType.SetView4].forEach(((e,r)=>{t.registerKeyCommand(e,new o.SetCameraLocationCmd(this.cameraPan,i,r-1))})),[s.KeyCommandType.View1,s.KeyCommandType.View2,s.KeyCommandType.View3,s.KeyCommandType.View4].forEach(((e,r)=>{t.registerKeyCommand(e,new l.GoToCameraLocationCmd(this.cameraPan,i,r-1))}));var r=new c.MapPanningHelper(this.game.map),d=new h.CenterViewCmd(t.unitSelectionHandler,r,this.cameraPan);t.registerKeyCommand(s.KeyCommandType.CenterView,d);let g=new u.FollowUnitCmd(t.unitSelectionHandler,this.renderableManager,t,r,this.cameraPan,this.worldScene);g.init(),this.disposables.add(g),t.registerKeyCommand(s.KeyCommandType.Follow,g);let p=()=>this.sound.play(n.SoundKey.SystemError,a.ChannelType.Ui);[s.KeyCommandType.PageUser,s.KeyCommandType.ScreenCapture].forEach((e=>t.registerKeyCommand(e,p)))}handleHudChange(e){this.initHudEventListeners(e)}initHudEventListeners(e){e.onCommandBarButtonClick.subscribe((e=>{switch(e){case d.CommandBarButtonType.BugReport:if(!this.discordUrl)break;this.gameMenu.open(),this.messageBoxApi.show(i.createElement(g.ReportBug,{discordUrl:this.discordUrl,strings:this.strings}),this.strings.get("GUI:OK"))}}))}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/fx/handler/ChronoFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","game/gameobject/common/DeathType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ChronoFxHandler",class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new r.CompositeDisposable,this.handleObjectTeleport=e=>{if(e.isChronoshift){let t=e.target.position.getTileOffset().multiplyScalar(1/s.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,(i=>{i.setPosition(s.Coords.tile3dToWorld(e.prevTile.rx+t.x,e.prevTile.ry+t.y,e.prevTile.z))})),this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpOut,(i=>{var r=e.target.tile;i.setPosition(s.Coords.tile3dToWorld(r.rx+t.x,r.ry+t.y,r.z))}))}},this.handleObjectDestroy=e=>{if(e.target.deathType===n.DeathType.Temporal){let t=e.target.isBuilding()?e.target.centerTile:e.target.tile,i=e.target.isBuilding()?new THREE.Vector2(.5,.5):e.target.position.getTileOffset().multiplyScalar(1/s.Coords.LEPTONS_PER_TILE);this.renderableManager.createTransientAnim(this.game.rules.audioVisual.warpAway,(e=>{e.setPosition(s.Coords.tile3dToWorld(t.rx+i.x,t.ry+i.y,t.z))}))}}}init(){this.disposables.add(this.game.events.subscribe(i.EventType.ObjectTeleport,this.handleObjectTeleport),this.game.events.subscribe(i.EventType.ObjectDestroy,this.handleObjectDestroy))}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/fx/handler/WarheadDetonateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords","util/math"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("WarheadDetonateFxHandler",class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new r.CompositeDisposable,this.handleWarheadDetonation=e=>{var t=e.explodeAnim;t&&this.renderableManager.createTransientAnim(t,(t=>{let i=e.position.clone();var r;e.target.rules.bullets&&(r=s.Coords.getWorldTileSize()/8,i=new THREE.Vector3(n.getRandomInt(-r,r),0,n.getRandomInt(-r,r)).add(i)),t.setPosition(i)})),e.isLightningStrike&&(t=(t=this.game.rules.audioVisual.weatherConBolts)[n.getRandomInt(0,t.length-1)],this.renderableManager.createTransientAnim(t,(t=>{t.setPosition(e.position)})))}}init(){this.disposables.add(this.game.events.subscribe(i.EventType.WarheadDetonate,this.handleWarheadDetonation))}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/fx/handler/CrateFxHandler",["game/event/EventType","util/disposable/CompositeDisposable","game/Coords"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("CrateFxHandler",class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new r.CompositeDisposable}init(){this.disposables.add(this.game.events.subscribe(i.EventType.CratePickup,(e=>{var t=e.target.animName;t&&this.renderableManager.createTransientAnim(t,(t=>{t.setPosition(s.Coords.tile3dToWorld(e.tile.rx,e.tile.ry,e.tile.z+1)),t.setRenderOrder(1e6)}))})))}dispose(){this.disposables.dispose()}})}}})),System.register("engine/renderable/fx/handler/TriggerActionFxHandler",["util/disposable/CompositeDisposable","game/Coords","game/event/EventType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("TriggerActionFxHandler",class{constructor(e,t){this.game=e,this.renderableManager=t,this.disposables=new i.CompositeDisposable,this.handleEvent=e=>{switch(e.type){case s.EventType.TriggerAnim:{let i=e;var t=i.name;this.renderableManager.createTransientAnim(t,(e=>{var t=r.Coords.tile3dToWorld(i.tile.rx+.5,i.tile.ry+.5,i.tile.z);e.setPosition(t)}));break}}}}init(){this.disposables.add(this.game.events.subscribe(this.handleEvent))}dispose(){this.disposables.dispose()}})}}})),System.register("gui/screen/game/WorldView",["util/disposable/CompositeDisposable","engine/renderable/WorldScene","engine/util/WorldViewportHelper","engine/util/MapTileIntersectHelper","engine/sound/WorldSound","engine/Engine","engine/util/MapPanningHelper","engine/IsoCoords","engine/ImageFinder","engine/renderable/entity/map/MapRenderable","engine/renderable/entity/RenderableFactory","engine/RenderableManager","engine/renderable/fx/handler/ChronoFxHandler","engine/Lighting","engine/gfx/lighting/LightingDirector","engine/renderable/fx/handler/WarheadDetonateFxHandler","engine/renderable/fx/handler/SuperWeaponFxHandler","engine/renderable/fx/handler/CrateFxHandler","engine/renderable/fx/handler/BeaconFxHandler","engine/renderable/builder/VxlBuilderFactory","engine/renderable/fx/handler/TriggerActionFxHandler"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){e("WorldView",class{constructor(e,t,r,s,n,a,o,l,c,h){this.hudGutterSize=e,this.game=t,this.sound=r,this.renderer=s,this.runtimeVars=n,this.minimap=a,this.strings=o,this.generalOptions=l,this.vxlGeometryPool=c,this.buildingImageDataCache=h,this.disposables=new i.CompositeDisposable}init(e,t,i){let r=this.game,o=r.map;var l=this.computeMapScreenBounds(o.mapBounds.getLocalSize()),c=this.computeWorldViewport(t,l);let h=this.initWorldView(e,c,r,o);this.worldScene=h;var u=new s.WorldViewportHelper(h),d=new n.MapTileIntersectHelper(o,h);l=r.getWorld(),c=e?this.game.mapShroudTrait.getPlayerShroud(e):void 0;let g=new a.WorldSound(this.sound,e,c,u,d,l,h,this.renderer);g.init(),this.disposables.add(g);let p=new m.Lighting(r.mapLightingTrait);this.disposables.add(p),h.applyLighting(p);let y=new f.LightingDirector(p,this.renderer,r.speed);y.init(),this.disposables.add(y),l=r.getUnitSelection();let{renderableManager:T,mapRenderable:v,superWeaponFxHandler:b,beaconFxHandler:S}=this.initRenderables(r,e,h,i,l,g,p,y),w=e=>{h.applyLighting(p),T.updateLighting(),v.updateLighting(e)};p.onChange.subscribe(w),this.disposables.add((()=>p.onChange.unsubscribe(w))),this.minimap.initWorld(h);let C=()=>{this.handleMapBoundsOrViewportChange(t),this.minimap.forceRerender()};return o.mapBounds.onLocalResize.subscribe(C),this.disposables.add((()=>o.mapBounds.onLocalResize.unsubscribe(C))),{worldScene:h,worldSound:g,renderableManager:T,superWeaponFxHandler:b,beaconFxHandler:S}}handleViewportChange(e){this.handleMapBoundsOrViewportChange(e)}handleMapBoundsOrViewportChange(e){var t;this.worldScene&&(t=this.computeMapScreenBounds(this.game.map.mapBounds.getLocalSize()),t=this.computeWorldViewport(e,t),this.worldScene.updateViewport(t),this.updatePanLimits(this.game.map,this.worldScene.cameraPan,t))}initWorldView(e,t,i,s){let n=r.WorldScene.factory(t,this.runtimeVars.freeCamera,this.generalOptions.graphics.shadows);this.disposables.add(n),this.updatePanLimits(s,n.cameraPan,t);var a=(!e||e.isObserver?i.getCombatants()[0]:e).startLocation;a=s.startingLocations[a];let o=new l.MapPanningHelper(s);return n.cameraPan.setPan(o.computeCameraPanFromTile(a.x,a.y)),a=s.mapBounds.getFullSize(),a=c.IsoCoords.screenTileToWorld(a.width/2,a.height/2),n.setLightFocusPoint(a.x,a.y),n}initRenderables(e,t,i,r,s,n,a,l){var c=o.Engine.getImages(),m=o.Engine.getVoxels(),f=o.Engine.getVoxelAnims(),C=new h.ImageFinder(c,r),E=o.Engine.getPalettes(),x=t?e.mapShroudTrait.getPlayerShroud(t):void 0;c=new u.MapRenderable(e.map,x,e.mapRadiationTrait,a,r,e.rules,e.art,C,i.camera,this.runtimeVars.debugWireframes,e.speed,n,!0);i.add(c),this.disposables.add(c),x=this.renderer.supportsInstancing(),x=new d.RenderableFactory(t,s,e.alliances,e.rules,e.art,c,C,E,m,f,r,i.camera,a,l,this.runtimeVars.debugWireframes,this.runtimeVars.debugText,e.speed,n,this.strings,this.generalOptions.flyerHelper,this.generalOptions.hiddenObjects,new S.VxlBuilderFactory(this.vxlGeometryPool,x,i.camera),this.buildingImageDataCache,!0,x);let O=new g.RenderableManager(e.getWorld(),i,i.camera,x);O.init(),this.disposables.add(O);let A=new p.ChronoFxHandler(e,O);A.init(),this.disposables.add(A);let M=new y.WarheadDetonateFxHandler(e,O);M.init(),this.disposables.add(M);let R=new T.SuperWeaponFxHandler(e,O,l);R.init(),this.disposables.add(R);let P=new v.CrateFxHandler(e,O);P.init(),this.disposables.add(P);let I=new b.BeaconFxHandler(e,t,O,this.renderer,n);I.init(),this.disposables.add(I);let k=new w.TriggerActionFxHandler(e,O);return k.init(),this.disposables.add(k),{renderableManager:O,mapRenderable:c,superWeaponFxHandler:R,beaconFxHandler:I}}computeWorldViewport(e,t){return{x:e.x,y:e.y,width:Math.min(t.width,e.width-this.hudGutterSize.width),height:Math.min(t.height,e.height-this.hudGutterSize.height)}}updatePanLimits(e,t,i){let r=new l.MapPanningHelper(e);var s=this.computeMapScreenBounds(e.mapBounds.getLocalSize());t.setPanLimits(r.computeCameraPanLimits(i,s))}computeMapScreenBounds(e){var t=c.IsoCoords.screenTileToScreen(e.x,e.y),i=c.IsoCoords.screenTileToScreen(e.x+e.width,e.y+e.height-1);return{x:t.x,y:t.y,width:i.x-t.x,height:i.y-t.y}}dispose(){this.worldScene&&this.renderer.removeScene(this.worldScene),this.disposables.dispose()}})}}})),System.register("gui/screen/game/NetStats",["stats.js","util/disposable/CompositeDisposable","network/IrcConnection"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("NetStats",class{constructor(e,t,i,s){this.lockstep=e,this.player=t,this.renderer=i,this.gservCon=s,this.disposables=new r.CompositeDisposable}init(){let e,t=this.renderer.getStats(),r=new i.default.Panel("ms RTT","#ff8","#221"),n=async()=>{if(e=void 0,!this.lockstep.getErrorState()&&this.gservCon.isOpen()){let t;try{t=await this.gservCon.ping(5)}catch(e){e instanceof s.IrcConnection.NoReplyError||console.error(e),t=5e3}e=setTimeout(n,1e3),requestAnimationFrame((()=>r.update(t,250)))}};if(n(),this.disposables.add((()=>{e&&clearTimeout(e);let t=this.renderer.getStats();t&&t.dom.removeChild(r.dom)})),t.addPanel(r),!this.player.isObserver){let e=new i.default.Panel("ms LAT","#f8f","#212"),r=new Map;this.lockstep.onActionsSent.subscribe((e=>{r.set(e,performance.now())})),this.lockstep.onActionsReceived.subscribe((t=>{if(r.has(t)){let i=performance.now()-r.get(t);r.delete(t),requestAnimationFrame((()=>e.update(i,1e3)))}})),t.addPanel(e),this.disposables.add((()=>{let t=this.renderer.getStats();t&&t.dom.removeChild(e.dom)}))}}dispose(){this.disposables.dispose()}})}}})),System.register("game/player/PlayerFactory",["game/Player","game/Country","game/player/trait/PowerTrait","game/player/trait/RadarTrait","game/player/production/Production","game/SideType","game/player/trait/SuperWeaponsTrait","game/player/trait/SharedDetectDisguiseTrait"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("PlayerFactory",class{constructor(e,t,i){this.rules=e,this.gameOpts=t,this.allAvailableObjects=i}createCombatant(e,t,r,o,h,u){let d=new i.Player(e,t,r,o);return d.isAi=h,d.aiDifficulty=u,d.powerTrait=new s.PowerTrait(d),d.traits.add(d.powerTrait),d.radarTrait=new n.RadarTrait,d.traits.add(d.radarTrait),d.superWeaponsTrait=new l.SuperWeaponsTrait,d.traits.add(d.superWeaponsTrait),d.production=a.Production.factory(d,this.rules,this.gameOpts,this.allAvailableObjects),d.sharedDetectDisguiseTrait=new c.SharedDetectDisguiseTrait,d}createObserver(e,t){let r=new i.Player(e,void 0,void 0,t.colors.get("LightGrey"));return r.radarTrait=new n.RadarTrait,r.traits.add(r.radarTrait),r.radarTrait.setDisabled(!1),r}createNeutral(e,t){var n=[...e.countryRules.values()].find((e=>e.side===o.SideType.Civilian));if(!n)throw new Error("Missing neutral country. No country found in rules with Civilian side");n=new r.Country(n);let a=new i.Player(t,n,void 0,e.colors.get("LightGrey"));return a.powerTrait=new s.PowerTrait(a),a.traits.add(a.powerTrait),a}})}}})),System.register("game/trait/PowerTrait",["game/trait/interface/NotifySpawn","game/trait/interface/NotifyHealthChange","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifyWarpChange","game/trait/interface/NotifyTick"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class{[i.NotifySpawn.onSpawn](e,t){e.isTechno()&&e.rules.power&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,"add",t)}[s.NotifyUnspawn.onUnspawn](e,t){e.isTechno()&&e.rules.power&&!e.warpedOutTrait.isActive()&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,"remove",t)}[r.NotifyHealthChange.onChange](e,t){e.isTechno()&&e.rules.power&&!e.warpedOutTrait.isActive()&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,"update",t)}[n.NotifyOwnerChange.onChange](e,t,i){e.rules.power&&!e.warpedOutTrait.isActive()&&(this.isCapturablePower(e,t)||t.powerTrait?.updateFrom(e,"remove",i),this.isCapturablePower(e,e.owner)||e.owner.powerTrait?.updateFrom(e,"add",i))}[a.NotifyWarpChange.onChange](e,t,i){e.rules.power&&!this.isCapturablePower(e,e.owner)&&e.owner.powerTrait?.updateFrom(e,i?"remove":"add",t)}[o.NotifyTick.onTick](e){for(var t of e.getCombatants())t.powerTrait.updateBlackout(e)}isCapturablePower(e,t){return 0<e.rules.power&&t.isNeutral&&e.rules.needsEngineer}},e("PowerTrait",l)}}})),System.register("game/trait/ProductionTrait",["game/trait/interface/NotifyTick","game/trait/interface/NotifyUnspawn","game/trait/interface/NotifyOwnerChange","game/player/production/ProductionQueue","game/event/InsufficientFundsEvent","game/rules/TechnoRules","game/trait/interface/NotifySpawn","game/trait/interface/NotifyPower","game/player/trait/PowerTrait","util/math","game/GameSpeed","engine/type/ObjectType","game/math/GameMath"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e}],execute:function(){m=class{constructor(e,t){this.rules=e,this.speedCheat=t,this.availableObjectRules=new Set;var i=60*e.general.buildSpeed*d.GameSpeed.BASE_TICKS_PER_SECOND;this.baseBuildSpeed=1/(i/1e3),[...e.buildingRules.values(),...e.infantryRules.values(),...e.vehicleRules.values(),...e.aircraftRules.values()].forEach((e=>{e.owner.length&&this.availableObjectRules.add(e)}))}[i.NotifyTick.onTick](e){for(var t of e.getCombatants())for(var i of t.production.getAllQueues())this.tickQueue(i,t,e)}[l.NotifySpawn.onSpawn](e,t){var i;e.isBuilding()&&e.owner.production?(i=e.rules.factory)&&(e.owner.production.getPrimaryFactory(i)||e.owner.production.setPrimaryFactory(e),e.owner.production.incrementFactoryCount(i),i===o.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(e.owner,t)):e.isAircraft()&&e.owner.production&&this.rules.general.padAircraft.includes(e.name)&&this.updateAircraftQueueMaxSize(e.owner,t)}[r.NotifyUnspawn.onUnspawn](e,t){var i;e.isBuilding()&&e.owner.production?(this.ensurePrerequisites(e.owner),(i=e.rules.factory)&&(e.owner.production.getPrimaryFactory(i)===e&&e.owner.production.crownPrimaryFactoryHeir(i),e.owner.production.decrementFactoryCount(i),i===o.FactoryType.AircraftType&&this.updateAircraftQueueMaxSize(e.owner,t))):e.isAircraft()&&e.owner.production&&this.rules.general.padAircraft.includes(e.name)&&this.updateAircraftQueueMaxSize(e.owner,t)}[s.NotifyOwnerChange.onChange](e,t,i){var r;e.isBuilding()?(this.ensurePrerequisites(t),(r=e.rules.factory)&&(t.production?.getPrimaryFactory(r)===e&&t.production.crownPrimaryFactoryHeir(r),e.owner.production&&!e.owner.production.getPrimaryFactory(r)&&e.owner.production.setPrimaryFactory(e),t.production?.decrementFactoryCount(r),e.owner.production?.incrementFactoryCount(r),r===o.FactoryType.AircraftType&&(this.updateAircraftQueueMaxSize(e.owner,i),this.updateAircraftQueueMaxSize(t,i)))):e.isAircraft()&&this.rules.general.padAircraft.includes(e.name)&&(this.updateAircraftQueueMaxSize(e.owner,i),this.updateAircraftQueueMaxSize(t,i))}[c.NotifyPower.onPowerLow](e){e.production&&(e.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(e.powerTrait.power,e.powerTrait.drain))}[c.NotifyPower.onPowerRestore](e){e.production&&(e.production.buildSpeedModifier=1)}[c.NotifyPower.onPowerChange](e){e.powerTrait?.level===h.PowerLevel.Low&&e.production&&(e.production.buildSpeedModifier=this.computeLowPowerBuildSpeedModifier(e.powerTrait.power,e.powerTrait.drain))}computeLowPowerBuildSpeedModifier(e,t){var i=1-Math.min(1,e/t),r=this.rules.general;i=.3*r.lowPowerPenaltyModifier*i/.15;return u.clamp(1-i,r.minLowPowerProductionSpeed,r.maxLowPowerProductionSpeed)}updateAircraftQueueMaxSize(e,t){e.production&&t.afterTick((()=>{var i=[...e.buildings].filter((e=>e.helipadTrait)).reduce(((e,t)=>e+t.dockTrait.numberOfDocks),0),r=e.getOwnedObjectsByType(g.ObjectType.Aircraft,!0).filter((e=>t.rules.general.padAircraft.includes(e.name))).length;e.production.getQueueForFactory(o.FactoryType.AircraftType).maxSize=Math.max(0,i-r)}))}tickQueue(e,t,i){if(e.status===n.QueueStatus.Active){let h=!1,d=e.getFirst();var r,s=t.production.getFactoryTypeForQueueType(e.type),o=t.production.getFactoryCount(s),l=t.production.buildSpeedModifier,c=1/p.GameMath.pow(this.rules.general.multipleFactory,o-1);s=d.rules.wall?1/this.rules.general.wallBuildSpeedCoefficient:1,o=this.baseBuildSpeed*l*c*s,c=(l=d.creditsEach)&&!this.speedCheat.value?u.floorTo(l/o,54):54,c=Math.max(54,c),s=t.credits,o=d.creditsEach-d.creditsSpent;0<(o=Math.min(t.credits,l/c+d.creditsSpentLeftover,o))?(r=Math.floor(o),d.creditsSpentLeftover=o-r,r&&(d.creditsSpent+=r,d.progress=d.creditsSpent/d.creditsEach,t.credits-=r,h=!0)):d.creditsEach||(r=d.progress*c,d.progress=Math.min(1,(1+r)/c),h=!0),h&&1===d.progress&&(e.status=n.QueueStatus.Ready),0<s&&!t.credits&&i.events.dispatch(new a.InsufficientFundsEvent(t)),h&&e.notifyUpdated()}}ensurePrerequisites(e){if(e.production)for(var t of e.production.getAllQueues()){var i;for(i of t.getAll().map((e=>({rules:e.rules,quantity:e.quantity,creditsSpent:e.creditsSpent}))))e.production.isAvailableForProduction(i.rules)||(t.pop(i.rules,i.quantity),e.credits+=i.creditsSpent)}}getAvailableObjects(){return[...this.availableObjectRules]}},e("ProductionTrait",m)}}})),System.register("game/action/factories/NoActionFactory",["game/action/NoAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("NoActionFactory",class{create(){return new i.NoAction}})}}})),System.register("game/action/factories/PlaceBuildingActionFactory",["game/action/PlaceBuildingAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PlaceBuildingActionFactory",class{constructor(e){this.game=e}create(){return new i.PlaceBuildingAction(this.game)}})}}})),System.register("game/action/factories/SellBuildingActionFactory",["game/action/SellBuildingAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SellBuildingActionFactory",class{constructor(e){this.game=e}create(){return new i.SellBuildingAction(this.game)}})}}})),System.register("game/action/factories/SelectUnitsActionFactory",["game/action/SelectUnitsAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("SelectUnitsActionFactory",class{constructor(e,t){this.game=e,this.orderActionContext=t}create(){return new i.SelectUnitsAction(this.game,this.orderActionContext)}})}}})),System.register("game/action/factories/OrderUnitsActionFactory",["game/action/OrderUnitsAction","game/order/OrderFactory"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("OrderUnitsActionFactory",class{constructor(e,t,i){this.game=e,this.map=t,this.orderActionContext=i}create(){return new i.OrderUnitsAction(this.game,this.map,this.orderActionContext,new r.OrderFactory(this.game,this.map))}})}}})),System.register("game/action/factories/UpdateQueueActionFactory",["game/action/UpdateQueueAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("UpdateQueueActionFactory",class{constructor(e){this.game=e}create(){return new i.UpdateQueueAction(this.game)}})}}})),System.register("game/action/DropPlayerAction",["game/action/Action","game/action/ActionType","game/event/PlayerDisconnectedEvent"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=class extends i.Action{constructor(e,t){super(r.ActionType.DropPlayer),this.game=e,this.localPlayerName=t}process(){if(this.localPlayerName!==this.player.name){let e=this.player;e.defeated||(this.game.removeAllPlayerAssets(e),e.dropped=!0,this.game.events.dispatch(new s.PlayerDroppedEvent(e)))}}},e("DropPlayerAction",n)}}})),System.register("game/action/factories/DropPlayerActionFactory",["game/action/DropPlayerAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("DropPlayerActionFactory",class{constructor(e,t){this.game=e,this.localPlayerName=t}create(){return new i.DropPlayerAction(this.game,this.localPlayerName)}})}}})),System.register("game/action/factories/ToggleRepairActionFactory",["game/action/ToggleRepairAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ToggleRepairActionFactory",class{constructor(e){this.game=e}create(){return new i.ToggleRepairAction(this.game)}})}}})),System.register("game/action/factories/ToggleAllianceFactory",["game/action/ToggleAllianceAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ToggleAllianceActionFactory",class{constructor(e){this.game=e}create(){return new i.ToggleAllianceAction(this.game)}})}}})),System.register("game/action/factories/ActivateSuperWeaponActionFactory",["game/action/ActivateSuperWeaponAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ActivateSuperWeaponActionFactory",class{constructor(e){this.game=e}create(){return new i.ActivateSuperWeaponAction(this.game)}})}}})),System.register("game/action/factories/PingLocationActionFactory",["game/action/PingLocationAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PingLocationActionFactory",class{constructor(e){this.game=e}create(){return new i.PingLocationAction(this.game)}})}}})),System.register("game/action/ObserveGameAction",["game/action/Action","game/event/PlayerResignedEvent","game/action/ActionType","game/event/PlayerDefeatedEvent","game/event/RadarOnOffEvent"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends i.Action{constructor(e){super(s.ActionType.ObserveGame),this.game=e}process(){let e=this.player;var t;this.game.removeAllPlayerAssets(e),!e.isCombatant()||e.defeated||e.isObserver||(e.resigned=!0,e.defeated=!0,e.isObserver=!0,this.game.events.dispatch(new r.PlayerResignedEvent(e)),this.game.events.dispatch(new n.PlayerDefeatedEvent(e)),this.game.mapShroudTrait.getPlayerShroud(e)?.revealAll(),t=e.radarTrait.isDisabled(),e.radarTrait.setDisabled(!1),t&&this.game.events.dispatch(new a.RadarOnOffEvent(e,!0)))}},e("ObserveGameAction",o)}}})),System.register("game/action/factories/ObserveGameActionFactory",["game/action/ObserveGameAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ObserveGameActionFactory",class{constructor(e){this.game=e}create(){return new i.ObserveGameAction(this.game)}})}}})),System.register("game/action/factories/ResignGameActionFactory",["game/action/ResignGameAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ResignGameActionFactory",class{constructor(e,t){this.game=e,this.localPlayerName=t}create(){return new i.ResignGameAction(this.game,this.localPlayerName)}})}}})),System.register("game/action/factories/DebugActionFactory",["game/action/DebugAction"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("DebugActionFactory",class{constructor(e){this.game=e}create(){return new i.DebugAction(this.game)}})}}})),System.register("game/action/ActionFactoryReg",["game/action/OrderActionContext","game/action/ActionType","game/action/factories/NoActionFactory","game/action/factories/PlaceBuildingActionFactory","game/action/factories/SellBuildingActionFactory","game/action/factories/SelectUnitsActionFactory","game/action/factories/OrderUnitsActionFactory","game/action/factories/UpdateQueueActionFactory","game/action/factories/DropPlayerActionFactory","game/action/factories/ToggleRepairActionFactory","game/action/factories/ToggleAllianceFactory","game/action/factories/ActivateSuperWeaponActionFactory","game/action/factories/PingLocationActionFactory","game/action/factories/ObserveGameActionFactory","game/action/factories/ResignGameActionFactory","game/action/factories/DebugActionFactory"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e}],execute:function(){e("ActionFactoryReg",class{register(e,t,T){var v=new i.OrderActionContext;e.registerFactory(r.ActionType.NoAction,new s.NoActionFactory),e.registerFactory(r.ActionType.PlaceBuilding,new n.PlaceBuildingActionFactory(t)),e.registerFactory(r.ActionType.SellBuilding,new a.SellBuildingActionFactory(t)),e.registerFactory(r.ActionType.ToggleRepair,new u.ToggleRepairActionFactory(t)),e.registerFactory(r.ActionType.SelectUnits,new o.SelectUnitsActionFactory(t,v)),e.registerFactory(r.ActionType.OrderUnits,new l.OrderUnitsActionFactory(t,t.map,v)),e.registerFactory(r.ActionType.UpdateQueue,new c.UpdateQueueActionFactory(t)),e.registerFactory(r.ActionType.ToggleAlliance,new d.ToggleAllianceActionFactory(t)),e.registerFactory(r.ActionType.ActivateSuperWeapon,new g.ActivateSuperWeaponActionFactory(t)),e.registerFactory(r.ActionType.PingLocation,new p.PingLocationActionFactory(t)),e.registerFactory(r.ActionType.DropPlayer,new h.DropPlayerActionFactory(t,T)),e.registerFactory(r.ActionType.ObserveGame,new m.ObserveGameActionFactory(t)),e.registerFactory(r.ActionType.ResignGame,new f.ResignGameActionFactory(t,T)),e.registerFactory(r.ActionType.DebugCommand,new y.DebugActionFactory(t))}})}}})),System.register("game/trait/SharedDetectDisguiseTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/math/Vector2","game/math/Box2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=class{constructor(){this.detectors=new Set}[r.NotifySpawn.onSpawn](e,t){this.isGlobalDetector(e)&&(this.detectors.add(e),this.updateAroundDetector(e,t)),this.isDisguisable(e)&&this.detect(e,t)}[n.NotifyUnspawn.onUnspawn](e,t){e.isTechno()&&(this.isGlobalDetector(e)&&(this.detectors.delete(e),this.updateAroundDetector(e,t)),this.isDisguisable(e)&&this.undetect(e,t))}[i.NotifyOwnerChange.onChange](e,t,i){this.isGlobalDetector(e)&&this.updateAroundDetector(e,i),this.isDisguisable(e)&&(this.undetect(e,i),this.detect(e,i))}[s.NotifyTileChange.onTileChange](e,t,i){this.isGlobalDetector(e)&&(this.updateAroundDetector(e,t,i),this.updateAroundDetector(e,t)),this.isDisguisable(e)&&(this.undetect(e,t),this.detect(e,t))}[o.NotifyPower.onPowerLow](e,t){var i=[...this.detectors].filter((t=>t.owner===e&&t.isBuilding()&&t.poweredTrait&&!t.poweredTrait.isPoweredOn()));this.updateAroundDetectors(i,t)}[o.NotifyPower.onPowerRestore](e,t){var i=[...this.detectors].filter((t=>t.owner===e&&t.isBuilding()&&t.poweredTrait));this.updateAroundDetectors(i,t)}[o.NotifyPower.onPowerChange](e,t){}updateAroundDetectors(e,t){let i=new Set;for(var r of e)for(var s of this.findTechnosAroundDetector(r,t,r.tile))i.add(s);for(var n of i)this.isDisguisable(n)&&(this.undetect(n,t),this.detect(n,t))}updateAroundDetector(e,t,i=e.tile){var r;for(r of this.findTechnosAroundDetector(e,t,i))this.isDisguisable(r)&&(this.undetect(r,t),this.detect(r,t))}findTechnosAroundDetector(e,t,i){var r=e.getFoundation(),s=Math.max(r.width,r.height);r=e.rules.detectDisguiseRange+s,s=new l.Vector2(i.rx,i.ry).addScalar(-r),r=new l.Vector2(i.rx,i.ry).addScalar(r);return t.map.technosByTile.queryRange(new c.Box2(s,r))}detect(e,t){let i=new Set,r=new a.RangeHelper(t.map.tileOccupation);for(var s of this.detectors)if(!t.areFriendly(s,e)){var n=s.owner,o=s.rules.detectDisguiseRange;if(!i.has(n)&&(!s.isBuilding()||!s.poweredTrait||s.poweredTrait.isPoweredOn())&&r.tileDistance(e,s.tile)<=o)for(var l of[n,...t.alliances.getAllies(n)])i.add(l)}for(var c of i)c.sharedDetectDisguiseTrait?.add(e)}undetect(e,t){for(var i of t.getCombatants())i.sharedDetectDisguiseTrait?.delete(e)}isGlobalDetector(e){return!(!e.isTechno()||!e.rules.detectDisguiseRange)}isDisguisable(e){return!(!e.isInfantry()&&!e.isVehicle()||!e.disguiseTrait)}},e("SharedDetectDisguiseTrait",h)}}})),System.register("game/trait/SharedDetectCloakTrait",["game/trait/interface/NotifyOwnerChange","game/trait/interface/NotifySpawn","game/trait/interface/NotifyTileChange","game/trait/interface/NotifyUnspawn","game/gameobject/unit/RangeHelper","game/trait/interface/NotifyPower","game/trait/interface/NotifyTick","game/trait/RadarTrait","game/rules/general/RadarRules","game/trait/interface/NotifyObjectTraitAdd","game/gameobject/trait/CloakableTrait","game/gameobject/trait/SensorsTrait","game/math/Vector2","game/math/Box2"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e}],execute:function(){f=class{constructor(){this.detectors=new Set}[r.NotifySpawn.onSpawn](e,t){this.isGlobalDetector(e)&&(this.detectors.add(e),this.updateAroundDetector(e,t)),this.isCloakable(e)&&this.detect(e,t)}[n.NotifyUnspawn.onUnspawn](e,t){e.isTechno()&&this.isGlobalDetector(e)&&this.detectors.delete(e)}[i.NotifyOwnerChange.onChange](e,t,i){this.isGlobalDetector(e)&&this.updateAroundDetector(e,i),this.isCloakable(e)&&this.detect(e,i)}[s.NotifyTileChange.onTileChange](e,t,i){this.isGlobalDetector(e)&&this.updateAroundDetector(e,t),this.isCloakable(e)&&this.detect(e,t)}[u.NotifyObjectTraitAdd.onAdd](e,t,i){e.isTechno()&&(t instanceof d.CloakableTrait?this.isCloakable(e)&&this.detect(e,i):t instanceof g.SensorsTrait&&this.isGlobalDetector(e)&&this.updateAroundDetector(e,i))}[o.NotifyPower.onPowerLow](e,t){}[o.NotifyPower.onPowerRestore](e,t){var i=[...this.detectors].filter((t=>t.owner===e&&t.isBuilding()&&t.poweredTrait));this.updateAroundDetectors(i,t)}[o.NotifyPower.onPowerChange](e,t){}[l.NotifyTick.onTick](e){for(var t of e.getCombatants()){var i;for(i of t.getOwnedObjects())i.cloakableTrait&&!i.cloakableTrait.isCloaked()&&this.detect(i,e)}}updateAroundDetectors(e,t){let i=new Set;for(var r of e)for(var s of this.findTechnosAroundDetector(r,t))i.add(s);for(var n of i)this.isCloakable(n)&&this.detect(n,t)}updateAroundDetector(e,t){var i;for(i of this.findTechnosAroundDetector(e,t))this.isCloakable(i)&&this.detect(i,t)}findTechnosAroundDetector(e,t){var i=e.getFoundation(),r=Math.max(i.width,i.height);i=e.rules.sensorsSight+r,r=new p.Vector2(e.tile.rx,e.tile.ry).addScalar(-i),i=new p.Vector2(e.tile.rx,e.tile.ry).addScalar(i);return t.map.technosByTile.queryRange(new m.Box2(r,i))}detect(e,t){let i=new a.RangeHelper(t.map.tileOccupation);for(var r of this.detectors)if(!t.areFriendly(r,e)){var s=r.rules.sensorsSight;if((!r.isBuilding()||!r.poweredTrait||r.poweredTrait.isPoweredOn())&&i.tileDistance(e,r.tile)<=s){if(s=e.cloakableTrait?.isCloaked(),e.cloakableTrait.uncloak(t),s)for(var n of[r.owner,...t.alliances.getAllies(r.owner)])t.traits.get(c.RadarTrait).addEventForPlayer(h.RadarEventType.GenericNonCombat,n,e.tile,t);break}}}isGlobalDetector(e){return!(!e.isTechno()||!e.sensorsTrait&&!e.rules.sensorArray||!e.rules.sensorsSight)}isCloakable(e){return e.isTechno()&&!!e.cloakableTrait}},e("SharedDetectCloakTrait",f)}}})),System.register("game/gameopts/GameOptRandomGen",["game/math/Vector2","game/Prng","game/rules/mpAllowedColors","util/typeGuard","game/gameopts/constants"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("GameOptRandomGen",class{constructor(e){this.prng=e}static factory(e,t){return new this(new r.Prng(Number(e+""+t)))}generateColors(e){let t=[...e.humanPlayers,...e.aiPlayers].filter(n.isNotNullOrUndefined),i=t.map((e=>e.colorId)).filter((e=>e!==a.RANDOM_COLOR_ID));var r=s.mpAllowedColors.length;let o=new Array(r).fill(0).map(((e,t)=>t)).filter((e=>!i.includes(e))),l=new Map;return t.forEach((e=>{if(e.countryId!==a.OBS_COUNTRY_ID&&e.colorId===a.RANDOM_COLOR_ID){if(o.length<1)throw new Error("Out of available colors to choose from");var t=this.prng.generateRandomInt(0,o.length-1);l.set(e,o[t]),o.splice(t,1)}})),l}generateCountries(e,t){let i=t.getMultiplayerCountries().length,r=[...e.humanPlayers,...e.aiPlayers].filter(n.isNotNullOrUndefined),s=new Map;return r.forEach((e=>{e.countryId===a.RANDOM_COUNTRY_ID&&s.set(e,this.prng.generateRandomInt(0,i-1))})),s}generateStartLocations(e,t){let i=[...e.humanPlayers,...e.aiPlayers].filter(n.isNotNullOrUndefined),r=i.filter((e=>e.startPos!==a.RANDOM_START_POS)).map((e=>e.startPos)),s=[...t.keys()].filter((e=>!r.includes(e))),o=[];for(;s.length;){var l=s.length?this.prng.generateRandomInt(0,s.length-1):0;o.push(...s.splice(l,1))}if(o.unshift(...r),3<=o.length)for(var c of[1,2])if(!(r.length-1>=c)){let e=o.map((e=>t[e])),i=this.findFarthestPointFrom(e.slice(0,c),e.slice(c));var h=e.findIndex((e=>e.x===i.x&&e.y===i.y));o.splice(c,0,...o.splice(h,1))}if(4<=o.length&&r.length-1<3){let e=o.map((e=>t[e])),i=this.findFarthestPointFrom(e.slice(2,3),e.slice(3));var u=e.findIndex((e=>e.x===i.x&&e.y===i.y));o.splice(3,0,...o.splice(u,1))}o.splice(0,r.length);let d=new Map,g=-1;return i.forEach((e=>{if(e.countryId!==a.OBS_COUNTRY_ID&&e.startPos===a.RANDOM_START_POS){if(g>=o.length-1)throw new RangeError("Map has fewer starting locations than players");d.set(e,o[++g])}})),d}findFarthestPointFrom(e,t){let r,s=e.map((e=>new i.Vector2(e.x,e.y))),n=0;if(!t.length)throw new Error("Search array must have at least one element");for(var a of t){let e=new i.Vector2(a.x,a.y);var o=s.reduce(((t,i)=>t+e.distanceTo(i)),0);o>=n&&(r=a,n=o)}return r}})}}})),System.register("game/GameFactory",["game/rules/Rules","game/art/Art","game/Country","game/gameobject/ObjectFactory","game/World","game/GameMap","game/gameopts/GameOpts","game/gameopts/constants","util/typeGuard","game/Alliances","game/PlayerList","game/gameobject/selection/UnitSelection","util/BoxedVar","game/player/PlayerFactory","game/trait/PowerTrait","game/trait/SellTrait","game/trait/RadarTrait","game/trait/ProductionTrait","game/trait/MapShroudTrait","game/Game","game/trait/MapRadiationTrait","game/action/ActionFactory","game/action/ActionFactoryReg","game/trait/SuperWeaponsTrait","game/trait/SharedDetectDisguiseTrait","game/trait/SharedDetectCloakTrait","game/trait/CrateGeneratorTrait","game/trait/StalemateDetectTrait","game/gameopts/GameOptSanitizer","game/gameopts/GameOptRandomGen","game/trait/MapLightingTrait","game/Prng","game/ai/Ai","game/bot/BotFactory","game/BotManager"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e}],execute:function(){e("GameFactory",class{static create(e,t,D,F,_,U,H,G,V,W,z,K,q,$,Q,Z){var Y=D.clone().mergeWith(U).mergeWith(e);let X=new i.Rules(Y,q);var J=new r.Art(X,F,e,q),ee=new j.Ai(_);X.applySpecialFlags(e.specialFlags),P.GameOptSanitizer.sanitize(V,X);let te=new i.Rules(D),ie=te.getMultiplayerCountries(),re=[...te.getMultiplayerColors().values()],se=new B.Prng(Number(H+""+G)),ne=new o.GameMap(e,t,X,se.generateRandomInt.bind(se));var ae=new a.World,oe=W.getById(V.gameMode).type,le=new d.PlayerList,ce=new u.Alliances(le),he=new g.UnitSelection,ue=new p.BoxedVar(1),de=new n.ObjectFactory(ne.tiles,ne.tileOccupation,ne.bridges,ue),ge=new C.ActionFactory;Y=new N.BotFactory(K),Y=L.BotManager.factory(ge,Y,Q,Z);let pe=new S.Game(ae,ne,X,J,ee,H,G,V,oe,le,he,ce,ue,de,Y);(new E.ActionFactoryReg).register(ge,pe,void 0),pe.traits.add(new f.PowerTrait),pe.sellTrait=new y.SellTrait(pe,X.general),pe.traits.add(pe.sellTrait),pe.traits.add(new T.RadarTrait);let me=new v.ProductionTrait(X,$);pe.traits.add(me),pe.mapShroudTrait=new b.MapShroudTrait(ne,ce),pe.traits.add(pe.mapShroudTrait),pe.mapRadiationTrait=new w.MapRadiationTrait(ne),pe.traits.add(pe.mapRadiationTrait),pe.mapLightingTrait=new k.MapLightingTrait(X.audioVisual,ne.getLighting()),pe.traits.add(pe.mapLightingTrait),pe.traits.add(new x.SuperWeaponsTrait),pe.traits.add(new O.SharedDetectDisguiseTrait),pe.traits.add(new A.SharedDetectCloakTrait),pe.crateGeneratorTrait=new M.CrateGeneratorTrait(V.cratesAppear),pe.traits.add(pe.crateGeneratorTrait),z||(pe.stalemateDetectTrait=new R.StalemateDetectTrait,pe.traits.add(pe.stalemateDetectTrait));let fe=new m.PlayerFactory(X,V,me.getAvailableObjects()),ye=I.GameOptRandomGen.factory(H,G),Te=ye.generateColors(V),ve=ye.generateCountries(V,te),be=ye.generateStartLocations(V,ne.startingLocations);return[...V.humanPlayers,...V.aiPlayers].filter(h.isNotNullOrUndefined).forEach((e=>{let t,i,r;if(l.isHumanPlayerInfo(e)?(t=e.name,i=!1):(t=pe.getAiPlayerName(e),i=!0,r=e.difficulty),e.countryId!==c.OBS_COUNTRY_ID){var n=ve.get(e)??e.countryId,a=Te.get(e)??e.colorId,o=be.get(e)??e.startPos;if(n===c.RANDOM_COUNTRY_ID)throw new Error("Random country should have been resolved by now");if(a===c.RANDOM_COLOR_ID)throw new Error("Random color should have been resolved by now");if(o===c.RANDOM_START_POS)throw new Error("Random start location should have been resolved by now");n=ie[n].name,n=s.Country.factory(n,X),a=re[a],pe.addPlayer(fe.createCombatant(t,n,o,a,i,r))}else pe.addPlayer(fe.createObserver(t,X))})),pe.addPlayer(fe.createNeutral(X,"@@NEUTRAL@@")),pe}})}}})),System.register("worker/WorkerApi",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("gui/screen/game/GameLoader",["data/DataStream","@puzzl/core/lib/async/cancellation","engine/ResourceLoader","engine/resourceConfigs","engine/Engine","engine/TheaterType","util/time","game/SideType","game/Coords","engine/IsoCoords","engine/type/ObjectType","engine/ImageFinder","engine/renderable/builder/ShpBuilder","engine/renderable/entity/PipOverlay","engine/renderable/builder/CanvasSpriteBuilder","game/theater/TileSets","game/GameFactory","engine/renderable/fx/TrailerSmokeFx","engine/renderable/builder/ShpAggregator","engine/renderable/entity/building/BuildingShpHelper","engine/renderable/entity/building/BuildingAnimArtProps","util/math","data/MixFile","util/userAgent","game/gameopts/GameOptRandomGen","engine/renderable/DebugRenderable"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e}],execute:function(){e("GameLoader",class{constructor(e,t,i,r,s,n,a,o,l,c,h,u,d,g){this.workerHostApi=e,this.cdnResourceLoader=t,this.appResourceLoader=i,this.rules=r,this.gameModes=s,this.sound=n,this.iniLogger=a,this.actionLogger=o,this.speedCheat=l,this.gameResConfig=c,this.vxlGeometryPool=h,this.buildingImageDataCache=u,this.botsEnabled=d,this.debugBotIndex=g}async load(e,t,i,r,s,n,a,o){var l=this.resolveLoadingPlayerInfos(e,t,i);a.start(l,i.mapTitle,s);try{return this.workerHostApi.warmUpPool(),await this.doLoad(e,t,i,r,s,n,a,o)}finally{this.workerHostApi.dispose()}}resolveLoadingPlayerInfos(e,t,i){let r=O.GameOptRandomGen.factory(e,t),s=r.generateColors(i),n=r.generateCountries(i,this.rules);return i.humanPlayers.map((e=>({...e,colorId:s.get(e)??e.colorId,countryId:n.get(e)??e.countryId})))}async doLoad(e,t,s,o,d,p,m,f){if(!a.Engine.vfs)throw new Error("Virtual File System not initialized");this.clearStaticCaches(),this.buildingImageDataCache.clear();try{a.Engine.getActiveMod()||await this.loadFestiveAssets(f)}catch(e){if(e instanceof r.OperationCanceledError)throw e;console.error("Couldn't load festive assets",e)}await this.loadTheater(o.theaterType,f,(e=>m.onLoadProgress(e/100*30))),await l.sleep(1);var y=p&&this.botsEnabled?await this.loadBotsLib():{};let T,{game:v,theater:b}=await this.createGame(e,t,s,o,p,y),S=c.SideType.GDI;d&&(T=v.getPlayerByName(d),T.isObserver||(S=T.country.side));let w=this.gameResConfig.isCdn()?await this.cdnResourceLoader.loadResources([n.ResourceType.Sounds,...S===c.SideType.GDI?[n.ResourceType.EvaAlly,n.ResourceType.UiAlly]:[n.ResourceType.EvaSov,n.ResourceType.UiSov],n.ResourceType.Cameo],f,(e=>m.onLoadProgress(30+e/100*15))):void 0;w&&a.Engine.vfs.addArchive(new E.MixFile(new i.DataStream(w.pop(n.ResourceType.Cameo))),this.cdnResourceLoader.getResourceFileName(n.ResourceType.Cameo));var C,O=this.collectCameoFileNames(v);if(await this.loadHudSideImages(w,S),m.onLoadProgress(40),await l.sleep(1),w){for(C of[n.ResourceType.Sounds,S===c.SideType.GDI?n.ResourceType.EvaAlly:n.ResourceType.EvaSov])a.Engine.vfs.addArchive(new E.MixFile(new i.DataStream(w.pop(C))),this.cdnResourceLoader.getResourceFileName(C));await a.Engine.vfs.addBagFile("audio.bag")}return m.onLoadProgress(45),await l.sleep(1),(y=/iPhone|Android|CrOS|Windows Phone|webOS/i.test(navigator.userAgent)||x.isIpad())||(console.time("Load sounds"),await this.prepareSounds(f,(e=>m.onLoadProgress(45+e/100*15))),console.timeEnd("Load sounds")),m.onLoadProgress(60),await l.sleep(1),y||(y=a.Engine.getImages(),y=new g.ImageFinder(y,b),console.time("Load textures"),await this.prepareTextures(v.rules,v.art,o,y,f,(e=>m.onLoadProgress(60+e/100*10))),console.timeEnd("Load textures")),m.onLoadProgress(70),await l.sleep(1),console.time("Load voxels"),await this.prepareVxlGeometries(v.rules,v.art,v.map,a.Engine.getVoxels(),f,(e=>m.onLoadProgress(70+e/100*20))),console.timeEnd("Load voxels"),await l.sleep(1),f?.throwIfCancelled(),u.IsoCoords.init({x:0,y:v.map.mapBounds.getFullSize().width*h.Coords.getWorldTileSize()/2}),v.init(T),f?.throwIfCancelled(),m.onLoadProgress(95),await l.sleep(1),{game:v,theater:b,hudSide:S,cameoFilenames:O}}collectCameoFileNames(e){let t=[],i=[...e.rules.buildingRules.values(),...e.rules.infantryRules.values(),...e.rules.vehicleRules.values(),...e.rules.aircraftRules.values()];for(var r of i.values())e.art.hasObject(r.name,r.type)&&(r=e.art.getObject(r.name,r.type),t.push(r.cameo+".shp"),t.push(r.altCameo+".shp"));for(var s of e.rules.superWeaponRules.values())s.sidebarImage.length&&t.push(s.sidebarImage+".shp");return t=t.filter((e=>a.Engine.getImages().has(e))),[...new Set(t)]}async prepareSounds(e,t){let i=new Set;for(var s of this.sound.soundSpecs.getAll())for(var n of s.sounds){const e=this.sound.getWavFile(n);e&&e.isRawImaAdpcm()&&i.add(e)}let a=0,o=i.size;if(o){let s=[...i].sort(((e,t)=>e.getRawData().length-t.getRawData().length));var l=this.workerHostApi.concurrency;try{for(let i=0;i<l;i++)this.workerHostApi.queueTask((async i=>{for(;s.length&&!e?.isCancelled();){let e=s.pop();var r=e.getRawData();r=await i.decodeWav(r);e.setData(r),a++,r=a/o*100,Math.floor(r)%10==0&&t(a/o*100)}})),await Promise.resolve();await this.workerHostApi.waitForTasks(),e?.throwIfCancelled()}catch(i){if(i instanceof r.OperationCanceledError)throw i;console.error(i)}}}async loadTheater(e,t,r){if(this.gameResConfig.isCdn()){if(!(l=n.theaterSpecificResources.get(e)))throw new Error("Unhandled theater type "+o.TheaterType[e]);var s,l=[n.ResourceType.BuildGen,n.ResourceType.Anims,n.ResourceType.Vxl,...l];let c=await this.cdnResourceLoader.loadResources(l,t,(e=>r(e/100*60)));for(s of l)a.Engine.vfs.addArchive(new E.MixFile(new i.DataStream(c.pop(s))),this.cdnResourceLoader.getResourceFileName(s))}else r(100)}async createGame(e,t,i,r,s,n){var o=a.Engine.getIni(this.gameModes.getById(i.gameMode).rulesOverride),l=await a.Engine.loadTheater(r.theaterType),c=a.Engine.getActiveEngine(),h=a.Engine.getTheaterSettings(c,r.theaterType);c=a.Engine.getTheaterIni(c,r.theaterType);let u=new y.TileSets(c);return u.loadTileData(a.Engine.getTileData(),h.Extension),{game:T.GameFactory.create(r,u,a.Engine.getRules(),a.Engine.getArt(),a.Engine.getAi(),o,e,t,i,this.gameModes,s,n,this.iniLogger,this.speedCheat,this.debugBotIndex,this.actionLogger),theater:l}}async loadBotsLib(){let e;try{e=await SystemJS.import("@chronodivide/sp-bots")}catch(e){throw new s.DownloadError("Failed to download bot lib",{cause:e})}return e}async loadHudSideImages(e,t){if(!a.Engine.vfs)throw new Error("VFS is not initialized");if(a.Engine.vfs.removeArchive("sidec01.mix"),a.Engine.vfs.removeArchive("sidec02.mix"),a.Engine.vfs.removeArchive("sidec01cd.mix"),a.Engine.vfs.removeArchive("sidec02cd.mix"),a.Engine.unloadSideMixData(),e){var r=t===c.SideType.GDI?n.ResourceType.UiAlly:n.ResourceType.UiSov,s=this.cdnResourceLoader.getResourceFileName(r);if(!["sidec01.mix","sidec02.mix"].includes(s))throw new Error(`Side mix file name "${s}" mismatch`);a.Engine.vfs.addArchive(new E.MixFile(new i.DataStream(e.pop(r))),s)}else await a.Engine.vfs.addMixFile(t===c.SideType.GDI?"sidec01.mix":"sidec02.mix");await a.Engine.vfs.addMixFile(t===c.SideType.GDI?"sidec01cd.mix":"sidec02cd.mix")}async loadFestiveAssets(e){let t=new Date;var r=t.getMonth()+1,s=t.getDate();let o;if(10===r&&C.isBetween(s,24,31)||11===r&&C.isBetween(s,1,6)?o=n.ResourceType.HalloweenMix:12===r&&C.isBetween(s,16,31)&&(o=n.ResourceType.XmasMix),void 0!==o&&(r=this.appResourceLoader.getResourceFileName(o),!a.Engine.vfs.hasArchive(r))){s=(await this.appResourceLoader.loadResources([o],e)).pop(o),s=new E.MixFile(new i.DataStream(s)),a.Engine.vfs.addArchive(s,r)}}async prepareTextures(e,t,i,r,s,n){let a=new S.BuildingShpHelper(r),o=new b.ShpAggregator,c=new Set,h=performance.now(),u=new Set;for(var m of i.structures)u.add(m.name);let f=[];for(var[y,T]of e.buildingRules)!u.has(y)&&-1===T.techLevel||f.push(y);let v=0;var C,E,x=f.length+e.animationNames.size;for(C of f){s?.throwIfCancelled();var O=performance.now();if(1e3<O-h&&(h=O,n(v/x*100),await l.sleep(0)),v++,!this.buildingImageDataCache.has(C)&&t.hasObject(C,d.ObjectType.Building)&&!(O=t.getObject(C,d.ObjectType.Building)).demandLoad){let i=new w.BuildingAnimArtProps;for(var A of(i.read(O.art,t),i.getAll().values()))for(var M of A)c.add(M.name);try{var R=r.findByObjectArt(O),P=O.bibShape?r.find(O.bibShape,O.useTheaterExtension):void 0,I=a.collectAnimShpFiles(i,O);let e=a.getShpFrameInfos(O,R,P,I);var k=o.aggregate(e.values(),`agg_${C}.shp`);this.buildingImageDataCache.set(C,k),p.ShpBuilder.prepareTexture(k.file)}catch(e){if(e instanceof g.ImageFinder.MissingImageError)continue;throw e}}}for(E of e.animationNames){s?.throwIfCancelled();var B=performance.now();if(1e3<B-h&&(h=B,n(v/x*100),await l.sleep(0)),v++,!c.has(E)&&t.hasObject(E,d.ObjectType.Animation)){B=t.getAnimation(E);try{var j=r.findByObjectArt(B);p.ShpBuilder.prepareTexture(j)}catch(e){if(e instanceof g.ImageFinder.MissingImageError)continue;throw e}}}}async prepareVxlGeometries(e,t,i,s,n,a){let o=new Set([...e.vehicleRules.values(),...e.aircraftRules.values(),...e.buildingRules.values()].filter((e=>(-1!==e.techLevel||e.spawned)&&t.hasObject(e.name,e.type))));for(var l of e.buildingRules.values()){if(l.freeUnit){let t;e.hasObject(l.freeUnit,d.ObjectType.Vehicle)&&(t=e.getObject(l.freeUnit,d.ObjectType.Vehicle)),t&&o.add(t)}l.undeploysInto&&o.add(e.getObject(l.undeploysInto,d.ObjectType.Vehicle))}for(var c of i.getInitialMapObjects().technos)(c.isVehicle()||c.isAircraft())&&e.hasObject(c.name,c.type)&&o.add(e.getObject(c.name,c.type));let h=new Map;for(var u of o){let i=t.getObject(u.name,u.type);if(i.isVoxel||u.type===d.ObjectType.Building&&u.turretAnimIsVoxel){var g,p=i.imageName.toLowerCase();let t=[];if(u.type!==d.ObjectType.Building){if(t.push(p+".vxl"),u.spawns&&u.noSpawnAlt&&t.push(p+"wo.vxl"),u.harvester&&u.unloadingClass&&t.push(e.getObject(u.unloadingClass,d.ObjectType.Vehicle).imageName.toLowerCase()+".vxl"),u.turret){for(let e=0;e<u.turretCount;++e)t.push(p+`tur${e||""}.vxl`);var m=p+"barl.vxl";s.has(m)&&t.push(m)}}else if(u.turretAnimIsVoxel){let e=u.turretAnim.toLowerCase()+".vxl";t.push(e),m=e.replace("tur","barl"),s.has(m)&&t.push(m)}for(g of t){var f=s.get(g);f&&h.set(g,f)}}}let y=0,T=[];for(var[v,b]of h)n?.throwIfCancelled(),await this.vxlGeometryPool.loadFromStorage(b,v)?(y++,a(y/h.size*100)):T.push([v,b]);if(T.length){T.sort(((e,t)=>t[1].voxelCount-e[1].voxelCount));var S=this.workerHostApi.concurrency;let e=this.vxlGeometryPool.getModelQuality(),t=[()=>this.vxlGeometryPool.clearOtherModStorage()];try{for(let i=0;i<S;i++)this.workerHostApi.queueTask((async i=>{for(;T.length&&!n?.isCancelled();){let[r,s]=T.pop(),n=await i.generateVxlGeometry(s,e);t.push((()=>this.vxlGeometryPool.persistToStorage(s,r,n))),y++,a(y/h.size*100)}}));await this.workerHostApi.waitForTasks(),n?.throwIfCancelled()}catch(i){if(i instanceof r.OperationCanceledError)throw i;console.error(i),console.warn("Failed to pre-load VXL geometries. Skipping.")}await Promise.all(t.map((e=>e()))).catch((e=>console.warn("Failed to persist VXL geometry cache",[e])))}}clearStaticCaches(){m.PipOverlay.clearCaches(),p.ShpBuilder.clearCaches(),A.DebugRenderable.clearCaches(),f.CanvasSpriteBuilder.clearCaches(),v.TrailerSmokeFx.clearTextureCache()}})}}})),System.register("gui/screen/game/HudFactory",["gui/screen/game/component/Hud","engine/Engine"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("HudFactory",class{constructor(e,t,i,r,s,n,a,o,l,c,h,u,d,g,p){this.sideType=e,this.uiScene=t,this.sidebarModel=i,this.messageList=r,this.chatHistory=s,this.debugText=n,this.debugTextEnabled=a,this.localPlayer=o,this.players=l,this.stalemateDetectTrait=c,this.countdownTimer=h,this.cameoFilenames=u,this.jsxRenderer=d,this.strings=g,this.commandBarButtons=p}create(){return new i.Hud(this.sideType,this.uiScene.viewport,r.Engine.getImages(),r.Engine.getPalettes(),this.cameoFilenames,this.sidebarModel,this.messageList,this.chatHistory,this.debugText,this.debugTextEnabled,this.localPlayer,this.players,this.stalemateDetectTrait,this.countdownTimer,this.jsxRenderer,this.strings,this.commandBarButtons)}})}}})),System.register("gui/replay/ReplayExistsError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("ReplayExistsError",i)}}})),System.register("gui/ReplayManager",["network/gamestate/Replay","gui/replay/ReplayExistsError"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ReplayManager",class{constructor(e){this.storage=e}async loadList(e=!1){return await this.storage.getManifest(e)}async loadSerializedReplay(e){return await this.storage.getReplayData(e)}async loadReplay(e){let t=await this.loadSerializedReplay(e),r=new i.Replay;return r.unserialize("string"==typeof t?t:await t.text(),e),r}async saveReplay(e,t=!1){var i=e.name;if(!i)throw new Error("Replay is not initialized");var r=THREE.Math.generateUUID(),s=e.serialize();let n={id:r,name:i,keep:t,timestamp:e.timestamp},a=1;for(;await this.storage.hasReplayData(n);)1<a&&(n.name=n.name.replace(/ \(\d+\)$/,"")),n.name+=` (${++a})`;let o=await this.loadList(),l=o.filter((e=>!e.keep));if(50<l.length)for(var c of l.slice(50))await this.storage.deleteReplayData(c),o.splice(o.indexOf(c),1);return o.unshift(n),await this.storage.saveReplayData(n,s),await this.storage.saveManifest(o),r}async keepReplay(e,t){let s=await this.loadList();var n=s.find((t=>t.id===e));if(n){var a={...n,name:i.Replay.sanitizeFileName(t),keep:!0};if(await this.storage.hasReplayData(a))throw new r.ReplayExistsError(`A replay with name "${a.name}" already exists`);let e=await this.storage.getReplayData(n);var o="string"==typeof e?e:await e.text();await this.storage.deleteReplayData(n),await this.storage.saveReplayData(a,o),Object.assign(n,a),await this.storage.saveManifest(s)}}async deleteReplay(e){await this.storage.deleteReplayData(e);let t=await this.loadList();var i=t.findIndex((t=>t.id===e.id));-1!==i&&(t.splice(i,1),await this.storage.saveManifest(t))}async importReplay(e){return new Promise(((t,r)=>{let s=new FileReader;s.onload=async s=>{try{var n=e.name.replace(i.Replay.extension,"");let r=new i.Replay;r.unserialize(s.target.result,{name:n,timestamp:e.lastModified}),await this.saveReplay(r,!0),t(r)}catch(s){r(s)}},s.onerror=()=>{r(s.error)},s.readAsText(e,"utf-8")}))}})}}})),System.register("gui/screen/game/component/hud/commandBar/CommandBarButtonList",["gui/screen/game/component/hud/commandBar/CommandBarButtonType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("CommandBarButtonList",class{constructor(){this.buttons=[]}fromIni(e){var t,r=e.get("ButtonList")?.split(",")??[];let s=[],n=new Set(Object.keys(i.CommandBarButtonType).filter((e=>"string"==typeof e)));for(t of r)"x"===t?s.push(i.CommandBarButtonType.Separator):n.has(t)?s.push(i.CommandBarButtonType[t]):console.warn(`Unknown command bar button type "${t}"`);return this.buttons=s,this}})}}})),System.register("gui/component/Toasts",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Toasts",(({messages:e,viewport:t,zIndex:r})=>i.default.createElement("div",{style:{position:"absolute",top:t.x,left:t.y,width:t.width,zIndex:r}},i.default.createElement("div",{className:"toasts"},e.map(((e,t)=>i.default.createElement("div",{key:t,className:"toast"},e)))))))}}})),System.register("gui/component/ToastApi",["gui/jsx/jsx","gui/jsx/HtmlView","util/disposable/CompositeDisposable","gui/component/Toasts"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ToastApi",class{constructor(e,t,i){this.viewport=e,this.uiScene=t,this.jsxRenderer=i,this.messages=[],this.disposables=new s.CompositeDisposable,this.handleViewportChange=e=>{this.innerComponent&&this.innerComponent.applyOptions((t=>t.viewport=e))}}push(e){var t=Date.now();this.messages.push({text:e,timestamp:t}),this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.update()}update(){if(this.messages=this.messages.filter((e=>e.timestamp>Date.now()-5e3)),this.messages=this.messages.slice(-5),this.messages.length){let e=this.messages.map((e=>e.text));if(this.uiToasts)this.innerComponent?.applyOptions((t=>t.messages=e));else{let[t]=this.jsxRenderer.render(i.jsx(r.HtmlView,{innerRef:e=>this.innerComponent=e,component:n.Toasts,props:{messages:e,viewport:this.viewport.value,zIndex:101}}));this.uiToasts=t,this.uiScene.add(t),this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add(t,(()=>this.uiScene.remove(t)),(()=>this.viewport.onChange.unsubscribe(this.handleViewportChange)),(()=>this.innerComponent=void 0),(()=>this.uiToasts=void 0))}this.updateTimeoutId=setTimeout((()=>this.update()),5e3)}else this.destroy()}destroy(){this.updateTimeoutId&&(clearTimeout(this.updateTimeoutId),this.updateTimeoutId=void 0),this.disposables.dispose()}})}}})),System.register("gui/screen/RootScreen",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RootScreen",class{constructor(){this.preventUnload=!1}setController(e){this.controller=e}})}}})),System.register("gui/screen/game/loadingScreen/LoadingScreen",["react","network/gamestate/PlayerConnectionStatus","gui/component/CountryIcon","game/gameopts/constants"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=(new Map).set("Americans","Name:Para").set("French","Name:GTGCAN").set("Germans","Name:TNKD").set("British","Name:SNIPE").set("Russians","Name:TTNK").set("Confederation","Name:TERROR").set("Africans","Name:DTRUCK").set("Arabs","Name:DESO").set("Alliance","Name:BEAGLE"),o=(new Map).set("Americans","LoadBrief:USA").set("French","LoadBrief:French").set("Germans","LoadBrief:Germans").set("British","LoadBrief:British").set("Russians","LoadBrief:Russia").set("Confederation","LoadBrief:Cuba").set("Africans","LoadBrief:Lybia").set("Arabs","LoadBrief:Iraq").set("Alliance","LoadBrief:Korea"),l=class extends i.default.Component{render(){let e=this.props.playerInfos;var t=this.props.countryName,r=this.props.color,s=o.get(t),n=a.get(t);let l=this.props.strings;return i.default.createElement("div",{className:"loading-screen",style:this.getStyle(this.props.bgImageSrc)},n?i.default.createElement("div",{className:"special-unit-name"},l.get(n)):null,s?i.default.createElement("div",{className:"briefing-text",style:{color:r}},l.get(s)):null,i.default.createElement("div",{className:"loading-text",style:{color:r}},l.get("GUI:LoadingEx")),i.default.createElement("div",{className:"player-status-container"},e?e.map((e=>this.renderStatus(e))):null),i.default.createElement("div",{style:{color:r},className:"country-name"},this.props.strings.get(this.props.countryUiNames.get(t)||t)),i.default.createElement("div",{style:{color:r},className:"map-name"},this.props.mapName))}renderStatus(e){var t=e.status===r.PlayerConnectionStatus.Connected?1:.5;return i.default.createElement("div",{key:e.name,className:"player-status",style:{opacity:t,color:e.color}},i.default.createElement("progress",{value:""+e.loadPercent,max:100}),i.default.createElement(s.CountryIcon,{country:e.country?e.country.name:n.OBS_COUNTRY_NAME}),i.default.createElement("span",{className:"player-name"},e.name))}getStyle(e){var t=this.props.viewport;return{backgroundImage:e?`url(${e})`:void 0,backgroundSize:"cover",width:t.width+"px",height:t.height+"px",position:"absolute",left:t.x,top:t.y}}},e("LoadingScreen",l)}}})),System.register("gui/screen/game/loadingScreen/LoadingScreenWrapper",["gui/jsx/jsx","gui/HtmlContainer","gui/jsx/UiComponent","gui/UiObject","gui/jsx/HtmlView","gui/screen/game/loadingScreen/LoadingScreen","game/gameopts/constants","game/SideType"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){h=(new Map).set("Americans","ls800ustates.png").set("French","ls800france.png").set("Germans","ls800germany.png").set("British","ls800ukingdom.png").set("Russians","ls800russia.png").set("Confederation","ls800cuba.png").set("Africans","ls800libya.png").set("Arabs","ls800iraq.png").set("Alliance","ls800korea.png").set(l.OBS_COUNTRY_NAME,"ls800obs.png"),u=class extends s.UiComponent{createUiObject({playerName:e,gameResConfig:t}){var i,s=new n.UiObject(new THREE.Object3D,new r.HtmlContainer),a=e?this.props.playerInfos.find((t=>t.name===e)):void 0,o=a?.country?a.country.name:l.OBS_COUNTRY_NAME;this.countryName=o;let u=a?.color??"#fff";a?.country&&(i=a.country.side===c.SideType.GDI?"AlliedLoad":"SovietLoad",u=this.props.rules.colors.get(i)?.asHexString()??"#fff"),this.color=u;let d=h.get(o);return d?t.isCdn()?this.bgHtmlImg=t.getCdnBaseUrl()+"ls/"+d:(this.bgSpriteImg=d?.replace("png","shp"),this.bgSpritePal=a?.country?"mpls.pal":"mplsobs.pal"):console.warn("Missing loading image for country "+o),s}defineChildren(){let e=this.props.rules.getMultiplayerCountries();var t=this.props.viewport;return i.jsx("fragment",null,this.props.gameResConfig.isCdn()?[]:i.jsx("sprite",{image:this.bgSpriteImg,palette:this.bgSpritePal,x:t.x,y:t.y,ref:e=>this.sprite=e}),i.jsx(a.HtmlView,{innerRef:e=>this.htmlEl=e,component:o.LoadingScreen,props:{viewport:this.props.viewport,countryUiNames:new Map([[l.OBS_COUNTRY_NAME,l.OBS_COUNTRY_UI_NAME]].concat(e.map((e=>[e.name,e.uiName])))),strings:this.props.strings,countryName:this.countryName,mapName:this.props.mapName,color:this.color,playerInfos:this.props.playerInfos,bgImageSrc:this.bgHtmlImg}}))}updateViewport(e){this.htmlEl?.applyOptions((t=>t.viewport=e)),this.sprite?.setPosition(e.x,e.y)}applyOptions(e){this.htmlEl?.applyOptions(e)}},e("LoadingScreenWrapper",u)}}})),System.register("gui/screen/game/loadingScreen/MpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","gui/screen/game/loadingScreen/LoadingScreenWrapper"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("MpLoadingScreenApi",class{constructor(e,t,i,r,n,a,o){this.gservCon=e,this.loadInfoParser=t,this.rules=i,this.strings=r,this.uiScene=n,this.jsxRenderer=a,this.gameResConfig=o,this.lastLoadPercent=0,this.disposables=new s.CompositeDisposable,this.handleLoadInfoUpdate=e=>{let t=this.loadInfoParser.parse(e);this.loadingScreen?this.loadingScreen.applyOptions((e=>{e.playerInfos=this.createExtendedLoadingInfos(t)})):this.createLoadingScreen(t)}}async start(e,t,i){if(this.gservCon.isOpen()){this.players=e,this.localPlayerName=i,this.mapName=t,this.gservCon.onLoadInfo.subscribe(this.handleLoadInfoUpdate),this.disposables.add((()=>this.gservCon.onLoadInfo.unsubscribe(this.handleLoadInfoUpdate))),this.gservCon.requestLoadInfo();let r=setInterval((()=>{this.gservCon.isOpen()?this.gservCon.requestLoadInfo():this.disposables.dispose()}),1e4);this.disposables.add((()=>clearInterval(r)))}}onLoadProgress(e){(e=Math.floor(e))>this.lastLoadPercent&&(this.lastLoadPercent=e,this.gservCon.isOpen()&&this.gservCon.sendLoadedPercent(e))}createExtendedLoadingInfos(e){let t=[...this.rules.getMultiplayerColors().values()],i=this.rules.getMultiplayerCountries();return e.map((e=>{var s=this.players.find((t=>t.name===e.name));return{name:e.name,status:e.status,loadPercent:e.loadPercent,country:i[s.countryId],color:s.countryId===r.OBS_COUNTRY_ID?"#fff":t[s.colorId].asHexString()}}))}createLoadingScreen(e){let[t]=this.jsxRenderer.render(i.jsx(n.LoadingScreenWrapper,{ref:e=>this.loadingScreen=e,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(e),gameResConfig:this.gameResConfig}));this.uiScene.add(t),this.disposables.add(t,(()=>this.uiScene.remove(t)),(()=>this.loadingScreen=void 0))}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}})),System.register("gui/screen/game/loadingScreen/ReplayLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("ReplayLoadingScreenApi",class{constructor(e,t,i,r,n){this.rules=e,this.strings=t,this.uiScene=i,this.jsxRenderer=r,this.gameResConfig=n,this.lastLoadPercent=0,this.disposables=new s.CompositeDisposable,this.handleLoadInfoUpdate=e=>{var t;this.loadingScreen?(t=performance.now(),(!this.lastRenderTime||t-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=t,this.loadingScreen.applyOptions((t=>{t.playerInfos=this.createExtendedLoadingInfos(e)})))):this.createLoadingScreen(e)}}async start(e,t){this.players=e,this.mapName=t,this.handleLoadInfoUpdate(0)}onLoadProgress(e){(e=Math.floor(e))>this.lastLoadPercent&&(this.lastLoadPercent=e,this.handleLoadInfoUpdate(e))}createExtendedLoadingInfos(e){let t=[...this.rules.getMultiplayerColors().values()],i=this.rules.getMultiplayerCountries();return this.players.filter((e=>e.countryId!==r.OBS_COUNTRY_ID)).map((r=>({name:r.name,status:n.PlayerConnectionStatus.Connected,loadPercent:e,country:i[r.countryId],color:t[r.colorId].asHexString()})))}createLoadingScreen(e){let[t]=this.jsxRenderer.render(i.jsx(a.LoadingScreenWrapper,{ref:e=>this.loadingScreen=e,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:void 0,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(e),gameResConfig:this.gameResConfig}));this.uiScene.add(t),this.disposables.add(t,(()=>this.uiScene.remove(t)),(()=>this.loadingScreen=void 0))}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}})),System.register("gui/screen/game/loadingScreen/SpLoadingScreenApi",["gui/jsx/jsx","game/gameopts/constants","util/disposable/CompositeDisposable","network/gamestate/PlayerConnectionStatus","gui/screen/game/loadingScreen/LoadingScreenWrapper"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("SpLoadingScreenApi",class{constructor(e,t,i,r,n){this.rules=e,this.strings=t,this.uiScene=i,this.jsxRenderer=r,this.gameResConfig=n,this.lastLoadPercent=0,this.disposables=new s.CompositeDisposable,this.handleLoadInfoUpdate=e=>{var t;this.loadingScreen?(t=performance.now(),(!this.lastRenderTime||t-this.lastRenderTime>1e3/15)&&(this.lastRenderTime=t,this.loadingScreen.applyOptions((t=>{t.playerInfos=this.createExtendedLoadingInfos(e)})))):this.createLoadingScreen()}}async start(e,t,i){this.players=e,this.localPlayerName=i,this.mapName=t,this.handleLoadInfoUpdate(0)}onLoadProgress(e){(e=Math.floor(e))>this.lastLoadPercent&&(this.lastLoadPercent=e,this.handleLoadInfoUpdate(e))}createExtendedLoadingInfos(e){let t=[...this.rules.getMultiplayerColors().values()];var i=this.rules.getMultiplayerCountries(),s=this.players.find((e=>e.name===this.localPlayerName));return[{name:this.localPlayerName,status:n.PlayerConnectionStatus.Connected,loadPercent:e,country:i[s.countryId],color:s.countryId===r.OBS_COUNTRY_ID?"#fff":t[s.colorId].asHexString()}]}createLoadingScreen(){let[e]=this.jsxRenderer.render(i.jsx(a.LoadingScreenWrapper,{ref:e=>this.loadingScreen=e,strings:this.strings,rules:this.rules,viewport:this.uiScene.menuViewport,playerName:this.localPlayerName,mapName:this.mapName,playerInfos:this.createExtendedLoadingInfos(0),gameResConfig:this.gameResConfig}));this.uiScene.add(e),this.disposables.add(e,(()=>this.uiScene.remove(e)))}dispose(){this.disposables.dispose()}updateViewport(){this.loadingScreen?.updateViewport(this.uiScene.menuViewport)}})}}})),System.register("gui/screen/game/loadingScreen/LoadingScreenApiFactory",["network/gameopt/LoadInfoParser","gui/screen/game/loadingScreen/MpLoadingScreenApi","gui/screen/game/loadingScreen/ReplayLoadingScreenApi","gui/screen/game/loadingScreen/SpLoadingScreenApi"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){var t;(t=a=a||{})[t.SinglePlayer=0]="SinglePlayer",t[t.MultiPlayer=1]="MultiPlayer",t[t.Replay=2]="Replay",e("LoadingScreenType",a),e("LoadingScreenApiFactory",class{constructor(e,t,i,r,s,n){this.rules=e,this.strings=t,this.uiScene=i,this.jsxRenderer=r,this.gameResConfig=s,this.gservCon=n}create(e){var{rules:t,strings:o,uiScene:l,jsxRenderer:c,gameResConfig:h,gservCon:u}=this;switch(e){case a.SinglePlayer:return new n.SpLoadingScreenApi(t,o,l,c,h);case a.MultiPlayer:var d=new i.LoadInfoParser;return new r.MpLoadingScreenApi(u,d,t,o,l,c,h);case a.Replay:return new s.ReplayLoadingScreenApi(t,o,l,c,h);default:throw new Error(`Unsupported loading screen type "${e}"`)}}})}}})),System.register("engine/MapSupport",["game/rules/Rules","engine/Engine","game/theater/TileSets","engine/TheaterType"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("MapSupport",class{static check(e,t){if(e.iniFormat<4)return t.get("TS:MapUnsupportedGame");if(!r.Engine.supportsTheater(e.theaterType))return t.get("TS:MapUnsupportedTheater",n.TheaterType[e.theaterType]);var a=r.Engine.getTheaterIni(r.Engine.getActiveEngine(),e.theaterType);let o=new s.TileSets(a);return e.maxTileNum>o.readMaxTileNum()?t.get("TS:MapUnsupportedTileSet"):new i.Rules(r.Engine.getRules().clone().mergeWith(e)).hasOverlayId(e.maxOverlayId)?void 0:t.get("TS:MapUnsupportedOverlay",e.maxOverlayId)}})}}})),System.register("network/gameres/GameResClientInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gameres/GameResGameInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/gameres/GameResType",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){var t;(t=i=i||{})[t.ConnectionLost=2]="ConnectionLost",t[t.Playing=8]="Playing",t[t.Draw=64]="Draw",t[t.Win=256]="Win",t[t.Loss=512]="Loss",t[t.Resign=528]="Resign",t[t.Disconnect=768]="Disconnect",e("GameResType",i)}}})),System.register("network/gameres/GameResPlayerInfo",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("GameResPlayerInfo",class{})}}})),System.register("network/gameres/GameRes",["data/DataStream","engine/type/ObjectType","game/gameopts/constants","util/typeGuard","network/gameres/GameResType"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){var t;(t=o=o||{})[t.Byte=1]="Byte",t[t.Boolean=2]="Boolean",t[t.Time=5]="Time",t[t.Int=6]="Int",t[t.String=7]="String",e("GameRes",class{fromGame(e,t,i){let a=e.gameOpts,o=e.gameOpts.humanPlayers.filter((e=>e.countryId!==s.OBS_COUNTRY_ID)).map((t=>e.getPlayerByName(t.name)));this.game={id:Number(String(e.id).slice(0,-3)),startTime:e.startTimestamp,duration:Math.floor(e.currentTime/1e3),speed:6-a.gameSpeed,players:o.length,mapName:a.mapName,mapDigest:a.mapDigest,unitCount:a.unitCount,cratesAppear:a.cratesAppear,credits:a.credits,tournament:t,shortGame:a.shortGame,superWeapons:a.superWeapons,aiPlayers:a.aiPlayers.filter(n.isNotNullOrUndefined).length,gameMode:a.gameMode,buildOffAlly:a.buildOffAlly,mcvRepacks:a.mcvRepacks},this.client={...i,senderId:o.findIndex((e=>e.name===i.accountName))};let l=this.computePlayerTeams(e,o);return this.players=o.map((t=>({buildingsBuilt:t.getUnitsBuilt(r.ObjectType.Building),buildingsCaptured:t.buildingsCaptured,buildingsKilled:t.getUnitsKilled(r.ObjectType.Building),buildingsLeft:t.buildings.size,color:2*[...e.rules.colors.values()].findIndex((e=>e.asHex()===t.color.asHex()))+1,cratesFound:t.cratesPickedUp,endCredits:t.credits,infantryBuilt:t.getUnitsBuilt(r.ObjectType.Infantry),infantryKilled:t.getUnitsKilled(r.ObjectType.Infantry),infantryLeft:t.getOwnedObjectsByType(r.ObjectType.Infantry).length,lostConnection:t.name===i.accountName&&i.suddenDisconnect,name:t.name,planesBuilt:t.getUnitsBuilt(r.ObjectType.Aircraft),planesKilled:t.getUnitsKilled(r.ObjectType.Aircraft),planesLeft:t.getOwnedObjectsByType(r.ObjectType.Aircraft).length,unitsBuilt:t.getUnitsBuilt(r.ObjectType.Vehicle),unitsKilled:t.getUnitsKilled(r.ObjectType.Vehicle),unitsLeft:t.getOwnedObjectsByType(r.ObjectType.Vehicle).length,completionStatus:this.getCompletionStatus(t,e,this.client,o.length),country:t.country.id,side:t.country.side,team:l.get(t)}))),this}computePlayerTeams(e,t){let i=new Map,r=0;for(var s of t)if(!i.has(s)){var n;for(n of(i.set(s,r),e.alliances.getAllies(s)))i.has(n)||i.set(n,r);r++}return i}getCompletionStatus(e,t,i,r){return i.finished?t.stalemateDetectTrait?.isStale()?a.GameResType.Draw:e.defeated?e.resigned?a.GameResType.Resign:e.dropped?a.GameResType.Disconnect:a.GameResType.Loss:a.GameResType.Win:i.outOfSync?a.GameResType.Disconnect:2<r?a.GameResType.Playing:i.accountName!==e.name?a.GameResType.Win:i.quit?a.GameResType.Resign:e.defeated?a.GameResType.Loss:a.GameResType.Disconnect}toFlat(){return{AFPS:[o.Int,this.client.avgFps],AIPL:[o.Int,this.game.aiPlayers],CRAT:[o.Boolean,this.game.cratesAppear],DURA:[o.Int,this.game.duration],FINI:[o.Boolean,this.client.finished],GSKU:[o.Int,this.client.gameSku],CRED:[o.Int,this.game.credits],IDNO:[o.Int,this.game.id],OOSY:[o.Boolean,this.client.outOfSync],PLRS:[o.Int,this.game.players],PNGR:[o.Int,this.client.pingsRecv],PNGS:[o.Int,this.client.pingsSent],SCEN:[o.String,this.game.mapName],SHRT:[o.Boolean,this.game.shortGame],SPID:[o.Int,this.client.senderId],SPED:[o.Int,this.game.speed],SUPR:[o.Boolean,this.game.superWeapons],TIME:[o.Time,this.game.startTime],TRNY:[o.Boolean,this.game.tournament],UNIT:[o.Int,this.game.unitCount],VERS:[o.String,this.client.clientVers],MODE:[o.Int,this.game.gameMode],BAMR:[o.Int,Number(this.game.mcvRepacks)+2*Number(this.game.buildOffAlly)],MAPC:[o.String,this.game.mapDigest],...this.players.map(((e,t)=>({["BLB"+t]:[o.Time,e.buildingsBuilt],["BLC"+t]:[o.Int,e.buildingsCaptured],["BLK"+t]:[o.Time,e.buildingsKilled],["BLL"+t]:[o.Time,e.buildingsLeft],["COL"+t]:[o.Int,e.color],["CRA"+t]:[o.Int,e.cratesFound],["CRD"+t]:[o.Time,e.endCredits],["INB"+t]:[o.Time,e.infantryBuilt],["INK"+t]:[o.Time,e.infantryKilled],["INL"+t]:[o.Time,e.infantryLeft],["LCN"+t]:[o.Boolean,e.lostConnection],["NAM"+t]:[o.String,e.name],["PLB"+t]:[o.Time,e.planesBuilt],["PLK"+t]:[o.Time,e.planesKilled],["PLL"+t]:[o.Time,e.planesLeft],["UNB"+t]:[o.Time,e.unitsBuilt],["UNK"+t]:[o.Time,e.unitsKilled],["UNL"+t]:[o.Time,e.unitsLeft],["CMP"+t]:[o.Int,e.completionStatus],["CTY"+t]:[o.Int,e.country],["SID"+t]:[o.Int,e.side],["TID"+t]:[o.Int,e.team]}))).reduce(((e,t)=>({...e,...t})),{})}}toBinary(){var e,t=new i.DataStream,r=this.toFlat();for(e of Object.keys(r)){var[s,n]=r[e];this.writeType(s,e,n,t)}let a=new i.DataStream;return a.writeUint16(t.byteLength+4,i.DataStream.BIG_ENDIAN),a.writeUint16(0),a.writeUint8Array(new Uint8Array(t.buffer,t.byteOffset,t.byteLength)),new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}writeType(e,t,r,s){if(4<t.length)throw new Error(`Field "${t}" must not exceed 4 characters`);switch(s.writeString(t,"ASCII",4),s.writeUint16(e,i.DataStream.BIG_ENDIAN),e){case o.Byte:return s.writeUint16(1,i.DataStream.BIG_ENDIAN),s.writeUint32(r,i.DataStream.BIG_ENDIAN);case o.Boolean:return s.writeUint16(1,i.DataStream.BIG_ENDIAN),s.writeUint8Array([r?1:0,0,0,0]);case o.Time:case o.Int:return s.writeUint16(4,i.DataStream.BIG_ENDIAN),s.writeUint32(r,i.DataStream.BIG_ENDIAN);case o.String:var n=r.length+1;return s.writeUint16(n,i.DataStream.BIG_ENDIAN),s.writeCString(r,4*Math.ceil(n/4));default:throw new Error(`Unhandled type "${e}"`)}}})}}})),System.register("network/WGameResConnection",["network/IrcConnection"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WGameResConnection",class{constructor(e){this.con=e}get onError(){return this.con.onError}get onClose(){return this.con.onClose}static factory(e){return new this(new i.IrcConnection({mode:"binary"},e))}async connect(e){return await this.con.connect(e)}close(){this.con.close()}isOpen(){return this.con.isOpen()}sendGameResPacket(e){this.con.sendMessage(e)}})}}})),System.register("gui/screen/game/GameScreen",["data/DataStream","network/GservError","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","@puzzl/core/lib/async/sleep","game/Game","engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","network/gamestate/LockstepManager","network/gamestate/ActionSerializer","game/action/ActionFactory","game/action/ActionQueue","tools/DevToolsApi","engine/GameAnimationLoop","gui/screen/game/component/GameResultPopup","gui/jsx/jsx","util/disposable/CompositeDisposable","network/gamestate/SoloPlayTurnManager","gui/screen/game/SoundHandler","LocalPrefs","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/CombatantUi","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/NetStats","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/Replay","network/gamestate/ReplayRecorder","gui/screen/game/component/hud/viewmodel/CombatantSidebarModel","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/game/ChatNetHandler","gui/screen/game/ChatTypingHandler","@puzzl/core/lib/async/Task","network/IrcConnection","@puzzl/core/lib/async/cancellation","network/gservConfig","engine/sound/Music","gui/screen/game/TauntHandler","gui/screen/game/TauntPlayback","game/action/ActionType","game/event/EventType","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/component/hud/commandBar/CommandBarButtonList","gui/screen/game/component/hud/commandBar/CommandBarButtonType","engine/ResourceLoader","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","util/userAgent","data/vfs/IOError","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/replay/ReplayStorageError","data/MapFile","data/vfs/VirtualFile","util/string","engine/MapDigest","engine/MapSupport","network/gameres/GameRes","game/gameopts/constants","gui/screen/mainMenu/MainMenuRoute","gui/screen/RootRoute","gui/chat/ChatHistory","gui/chat/ChatMessageFormat"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e},function(e){ee=e},function(e){te=e},function(e){ie=e},function(e){re=e},function(e){se=e},function(e){ne=e},function(e){ae=e},function(e){oe=e},function(e){le=e},function(e){ce=e},function(e){he=e},function(e){ue=e},function(e){de=e},function(e){ge=e},function(e){pe=e},function(e){me=e},function(e){fe=e},function(e){ye=e},function(e){Te=e}],execute:function(){ve=class extends ne.RootScreen{constructor(e,t,i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U){super(),this.workerHostApi=e,this.gservCon=t,this.wGameResCon=i,this.wolService=r,this.engineVersion=s,this.engineModHash=n,this.errorHandler=a,this.gameMenuSubScreens=o,this.loadingScreenApiFactory=l,this.gameOptsParser=c,this.gameOptsSerializer=h,this.config=u,this.strings=d,this.renderer=g,this.uiScene=p,this.runtimeVars=m,this.messageBoxApi=f,this.toastApi=y,this.uiAnimationLoop=v,this.viewport=b,this.jsxRenderer=S,this.pointer=w,this.sound=C,this.music=E,this.keyBinds=x,this.generalOptions=O,this.localPrefs=A,this.actionLogger=M,this.replayManager=R,this.fullScreen=P,this.mapFileLoader=I,this.mapDir=k,this.mapList=B,this.gameLoader=j,this.vxlGeometryPool=N,this.buildingImageDataCache=L,this.mutedPlayers=D,this.tauntsEnabled=F,this.speedCheat=_,this.sentry=U,this.preventUnload=!0,this.disposables=new T.CompositeDisposable,this.onGservClose=e=>{this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.handleError(e,this.strings.get("TXT_YOURE_DISCON")),this.game&&this.sendGameRes(this.game,{disconnect:!0,desync:!1,quit:!1,finished:!1})}}async onEnter(e){this.pointer.lock(),this.pointer.setVisible(!1),await(this.music?.play(K.MusicType.Loading));let t=new W.CancellationTokenSource;this.disposables.add((()=>t.cancel()));let i,r=t.token;this.returnTo=e.returnTo,this.wgameresUrl=e.wgameresUrl,this.isTournament=e.tournament;var a=this.playerName=e.playerName,c=this.isSinglePlayer=e.create&&e.singlePlayer;if(c)i=e.gameOpts;else{var h=this.wolService.getCredentials();if(!h||h.user!==a)return this.localPrefs.removeItem(S.StorageKey.LastConnection),void this.controller?.goToScreen(s.ScreenType.MainMenuRoot,{route:new me.MainMenuRoute(n.ScreenType.Login,{forceUser:a,afterLogin:t=>new fe.RootRoute(s.ScreenType.Game,e)})});this.wolService.shouldKeepAliveInGame()?this.wolService.setAutoReconnect(!0):this.wolService.closeWolConnection(),this.gservCon.onClose.subscribe(this.onGservClose);try{i=await this.connectToServerInstance(e,h,r)}catch(t){return void this.handleGservConError(t)}this.localPrefs.setItem(S.StorageKey.LastConnection,JSON.stringify(e))}let m;this.config.devMode?this.runtimeVars.cheatsEnabled.value=this.isSinglePlayer:this.isSinglePlayer||(this.runtimeVars.cheatsEnabled.value=!1);try{var f=await this.transferAndLoadMapFile(e,i.mapName,i.mapDigest,r);i.mapOfficial||(this.debugMapFile=f,this.disposables.add((()=>this.debugMapFile=void 0))),m=new le.MapFile(f);var y=de.MapSupport.check(m,this.strings);if(y)throw new Error(y)}catch(t){return void this.handleMapLoadError(t,i.mapName)}if(y=this.loadingScreenApiFactory.create(c?ae.LoadingScreenType.SinglePlayer:ae.LoadingScreenType.MultiPlayer),this.loadingScreenApi=y,this.disposables.add(y,(()=>this.loadingScreenApi=void 0)),this.disposables.add((()=>this.gameLoader.clearStaticCaches())),!r.isCancelled()){let s;try{s=await this.gameLoader.load(e.gameId,e.timestamp,i,m,a,this.isSinglePlayer,y,r)}catch(t){return void this.handleGameLoadError(t,e,i)}if(!r.isCancelled()){let{game:r,theater:n,hudSide:h,cameoFilenames:m}=s;this.game=r,this.disposables.add(r,(()=>this.game=void 0),(()=>l.Engine.unloadTheater(n.type)));let f,T=r.getPlayerByName(a);try{f=this.loadUi(r,n,T,h,m)}catch(t){return y=t.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(r.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),void this.handleGameError(t,y,r)}let b=new d.ActionFactory;(new L.ActionFactoryReg).register(b,r,a);let S=new g.ActionQueue,w=this.replay=new B.Replay;this.disposables.add((()=>this.replay=void 0)),w.init(r.id,r.startTimestamp,i,this.engineVersion,this.engineModHash);let C=new j.ReplayRecorder(w,r.getPlayerNumber(T),r.gameOpts.humanPlayers,new u.ActionSerializer);if(this.isSinglePlayer)this.gameTurnMgr=new v.SoloPlayTurnManager(r,T,S,this.actionLogger,C);else{this.lagState=!1;let e=this.initLockstep(r,T,b,S,C);if(T.isObserver)try{e.setPassiveMode(!0)}catch(t){if(t instanceof V.IrcConnection.SocketError)return;throw t}this.gameTurnMgr=e}this.gameTurnMgr.init();let E=()=>{if(r.status!==o.GameStatus.Started)try{this.onGameStart(T,r,f,S,b,w,C)}catch(t){var e=t.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError")+(r.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash"));this.handleGameError(t,e,r)}};if(c)E(),p.DevToolsApi.registerCommand("reset",(async()=>{await this.onLeave(),await this.onEnter(e)})),p.DevToolsApi.registerVar("speed",r.desiredSpeed),this.disposables.add((()=>p.DevToolsApi.unregisterCommand("reset")),(()=>p.DevToolsApi.unregisterVar("speed"))),p.DevToolsApi.registerVar("cheats",this.runtimeVars.cheatsEnabled),this.disposables.add((()=>p.DevToolsApi.unregisterVar("cheats")));else if(this.gservCon.isOpen()){let e=e=>this.gameTurnMgr.setRate(e);this.gservCon.onRateChange.subscribe(e),this.disposables.add((()=>this.gservCon.onRateChange.unsubscribe(e))),this.gservCon.onGameStart.subscribe(E),this.disposables.add((()=>this.gservCon.onGameStart.unsubscribe(E))),this.gservCon.sendLoadedPercent(100)}}}}async connectToServerInstance(e,t,i){let r=!1,s=new G.Task((async e=>{await a.sleep(1e3),e.isCancelled()||(this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),r=!0)}));s.start();try{var n,o,l;await this.gservCon.connect(e.gservUrl),await this.gservCon.cvers(this.engineVersion),await this.gservCon.login(t.user,t.pass),i.throwIfCancelled(),e.create?(n=this.gameOptsSerializer.serializeOptions(e.gameOpts),({gameId:o,timestamp:l}=e),await this.gservCon.createGame(o,l,n,this.engineVersion,this.engineModHash),console.log(`Created game instance with id ${e.gameId}.`),this.localPrefs.removeItem(S.StorageKey.LastConnection)):(await this.joinGame(e.gameId,5,i),console.log("Joined game instance with id "+e.gameId));var c=await this.gservCon.gameOpts();return this.gameOptsParser.parseOptions(c)}catch(e){throw this.gservCon.isOpen()||(r=!1),e}finally{s.cancel(),r&&this.messageBoxApi.destroy()}}async joinGame(e,t,i){if(t){let s;for(;t--;)try{return console.log(`Attempting to join game with id ${e}...`,t+" retries left"),i.throwIfCancelled(),void await this.gservCon.joinGame(e,this.engineVersion,this.engineModHash)}catch(e){if(!(e instanceof r.GservError&&e.code===r.GservError.Code.InstanceNonExistent))throw e;s=e,await a.sleep(3e3)}throw this.localPrefs.removeItem(S.StorageKey.LastConnection),s}await this.gservCon.joinGame(e,this.engineVersion,this.engineModHash)}async transferAndLoadMapFile(e,t,i,r){let s;if(e.create&&e.singlePlayer||!e.mapTransfer)s=await this.mapFileLoader.load(t,r);else{if(this.messageBoxApi.show(this.strings.get("GUI:MapTransfer")),e.create)s=await this.mapFileLoader.load(t,r),this.gservCon.sendMap(s.readAsString());else{var n=await this.gservCon.getMap();if(s=ce.VirtualFile.fromBytes(he.binaryStringToUint8Array(n),t),ue.MapDigest.compute(s)!==i)throw new Error("Transferred map is corrupt");if(this.mapDir&&!await this.mapDir.containsEntry(t))try{await this.mapDir.writeFile(s),this.mapList.addFromMapFile(s)}catch(e){console.error("Map couldn't be saved",[e])}}this.messageBoxApi.destroy()}return s}loadUi(e,t,i,r,s){var n=i.isObserver?new c.SidebarModel(e):new N.CombatantSidebarModel(i,e),a=new D.MessageList(e.rules.audioVisual.messageDuration,6,i),o=new ye.ChatHistory;let h=l.Engine.getUiIni(),u=new X.CommandBarButtonList;i.isObserver||u.fromIni(h.getOrCreateSection(this.isSinglePlayer?"AdvancedCommandBar":"MultiplayerAdvancedCommandBar")),this.config.discordUrl&&u.buttons.push(J.CommandBarButtonType.BugReport),this.hudFactory=new P.HudFactory(r,this.uiScene,n,a,o,e.debugText,this.runtimeVars.debugText,i,e.getCombatants(),e.stalemateDetectTrait,e.countdownTimer,s,this.jsxRenderer,this.strings,u.buttons),this.disposables.add((()=>this.hudFactory=void 0));let d=this.hudFactory.create();this.hud=d;let g=this.minimap=new I.Minimap(e,i,d.getTextColor(),e.rules.general.radar);d.setMinimap(g),this.disposables.add(g,(()=>this.minimap=void 0)),g.setPointerEvents(this.pointer.pointerEvents);var p={width:d.sidebarWidth,height:d.actionBarHeight};let m=new O.WorldView(p,e,this.sound,this.renderer,this.runtimeVars,g,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),f=m.init(i,this.viewport.value,t);return this.worldView=m,this.disposables.add(m,(()=>this.worldView=void 0)),f.worldScene.create3DObject(),{worldViewInitResult:f,sidebarModel:n,messageList:a,chatHistory:o,minimap:g}}initLockstep(e,t,r,s,n){const o=this.config.debugGameState;let l,c=new i.DataStream;o&&(l=e=>{c.byteLength<10485760&&c.writeString(e+"\n")});let d,g=new h.LockstepManager(e,this.gservCon,this.gameOptsParser,this.gameOptsSerializer,new u.ActionSerializer,r,s,(()=>{this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.handleGameError("desync_error",this.strings.get("TS:DesyncDetected"),e,o?async()=>{let e,t;try{let i=JSON.stringify(g.debugGameStateHistory,void 0,2);this.workerHostApi.queueTask((async t=>{e=await t.compressFile(i,"statedump.json")})),this.workerHostApi.queueTask((async e=>{t=await e.compressFile(new Uint8Array(c.buffer,0,c.byteLength),"lockstep.log")})),await this.workerHostApi.waitForTasks()}catch(e){console.error("Failed to export debug data",e)}finally{this.workerHostApi.dispose()}return{stateDump:e,debugLog:t}}:void 0)}),this.actionLogger,l,n,o);return g.onLagStateChange.subscribe((t=>{this.lagState=t,d?.cancel(),d=void 0,t?(d=new G.Task((async t=>{await a.sleep(z.CON_INFO_THRESH_MILLIS,t),t.isCancelled()||this.menu?.openConnectionInfo(e.getCombatants(),this.gservCon,this.chatNetHandler)})),d.start().catch((e=>{if(!(e instanceof W.OperationCanceledError))throw e})),this.disposables.add((()=>d?.cancel()))):this.menu?.getCurrentScreen()instanceof Y.ConnectionInfoScreen&&this.menu.close()})),g}onViewportChange(){if(this.loadingScreenApi?.updateViewport(),this.hud){this.uiScene.remove(this.hud),this.hud.destroy();let e=this.hudFactory.create();this.hud=e,e.setMinimap(this.minimap),this.playerUi&&(this.uiScene.add(e),this.menu?.handleHudChange(e),this.worldView.handleViewportChange(this.viewport.value),this.playerUi.handleHudChange(e),this.chatTypingHandler&&this.initHudChatTypingEvents(this.chatTypingHandler,this.chatNetHandler,e))}}onGameStart(e,t,i,r,s,n,a){this.localPrefs.removeItem(S.StorageKey.LastConnection),this.loadingScreenApi?.dispose(),this.music?.play(K.MusicType.Normal);var o=new M.EvaSpecs(e.country?.side??k.SideType.GDI).readIni(l.Engine.getIni("eva.ini"));let c=new A.Eva(o,this.sound,this.renderer);c.init(),this.disposables.add(c),this.initUi(e,t,a,r,s,this.hud,c,i),this.renderer.removeScene(this.uiScene),this.renderer.addScene(i.worldViewInitResult.worldScene),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),t.onEnd.subscribe((()=>this.onGameEnd(t,e,c,n))),t.start(),this.isSinglePlayer||this.initNetStats(e),this.gameAnimationLoop=new m.GameAnimationLoop(e,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!this.isSinglePlayer,onError:this.config.devMode?void 0:e=>{var i;e instanceof V.IrcConnection.SocketError||(i=e.message?.match(/memory|allocation/i)?this.strings.get("TS:GameCrashOom"):this.strings.get("TS:GameCrashed")+(t.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")),this.handleGameError(e,i,t))}}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initNetStats(e){let t,i=i=>{t?.dispose(),i&&(t=new R.NetStats(this.gameTurnMgr,e,this.renderer,this.gservCon),t.init(),this.disposables.add(t))};i(this.runtimeVars.fps.value),this.runtimeVars.fps.onChange.subscribe(i),this.disposables.add((()=>{this.runtimeVars.fps.onChange.unsubscribe(i)}))}initUi(e,t,i,r,s,n,a,o){let{worldViewInitResult:c,sidebarModel:h,messageList:u,chatHistory:d,minimap:g}=o;var{worldScene:p,worldSound:m,superWeaponFxHandler:f,beaconFxHandler:y,renderableManager:T}=c;let v=new b.SoundHandler(t,m,a,this.sound,t.events,u,this.strings,e);if(v.init(),this.disposables.add(v),u.onNewMessage.subscribe((e=>{e.animate&&this.sound.play(F.SoundKey.IncomingMessage,_.ChannelType.Ui)})),re.isIpad()){let e=e=>{h.topTextLeftAlign=e};this.fullScreen.onChange.subscribe(e),this.disposables.add((()=>this.fullScreen.onChange.unsubscribe(e)))}this.uiScene.add(n);let S=this.menu=new x.GameMenu(this.gameMenuSubScreens,t,e,d,this.isSinglePlayer?void 0:this.gservCon,this.isSinglePlayer,this.isTournament);S.init(n),this.initGameMenuEvents(S,a,t,e,r,s),this.disposables.add(S,(()=>this.menu=void 0));var O=t.getUnitSelection(),A=this.runtimeVars.freeCamera,M=this.runtimeVars.debugPaths,m=(m=this.config.devMode,new w.WorldInteractionFactory(e,t,O,T,this.uiScene,p,this.pointer,this.renderer,this.keyBinds,this.generalOptions,A,M,m,document,g,this.strings,n.getTextColor()));let R;this.isSinglePlayer||(P=new $.TauntPlayback(this.sound.audioSystem,l.Engine.getTaunts()),R=new q.TauntHandler(this.gservCon,e,t,i,this.tauntsEnabled,P,this.mutedPlayers),R.init(),this.disposables.add(R));var P=this.config.discordUrl;if(e.isObserver?this.playerUi=new E.ObserverUi(t,m,p.cameraPan,T,p,this.runtimeVars,S,this.sound,this.strings,this.messageBoxApi,P):this.playerUi=new C.CombatantUi(t,e,this.isSinglePlayer,r,s,h,this.renderer,p,v,u,this.sound,a,m,S,this.pointer,this.runtimeVars,this.speedCheat,this.strings,R,T,f,y,this.messageBoxApi,P),this.playerUi.init(n),this.disposables.add(this.playerUi,(()=>this.playerUi=void 0)),!this.isSinglePlayer){y=this.wolService.getConnection(),P=new Map(t.getNonNeutralPlayers().map((e=>[e.name,e.color.asHexString()]))),P=new Te.ChatMessageFormat(this.strings,e.name,P);let r=new U.ChatNetHandler(this.gservCon,y,u,d,P,e,t,i,this.mutedPlayers);r.init(),this.disposables.add(r);let s=this.playerUi.worldInteraction;P=new H.ChatTypingHandler(s.keyboardHandler,s.arrowScrollHandler,u,d),s.chatTypingHandler=P,this.chatTypingHandler=P,this.chatNetHandler=r,this.disposables.add((()=>this.chatTypingHandler=this.chatNetHandler=void 0)),this.initHudChatTypingEvents(P,r,n),S.onSendMessage.subscribe((e=>{e.value.length&&r.submitMessage(e.value,e.recipient)}));const a=e=>{t.getPlayerByName(e).isObserver&&u.addSystemMessage(this.strings.get("TXT_LEFT_GAME",e),"grey")};this.gservCon.onPlayerDisconnect.subscribe(a),this.disposables.add((()=>this.gservCon.onPlayerDisconnect.unsubscribe(a)))}}initHudChatTypingEvents(e,t,i){i.onMessageCancel.subscribe((()=>{e.endTyping()})),i.onMessageSubmit.subscribe((i=>{e.endTyping(),i.value.length&&t.submitMessage(i.value,i.recipient)}))}initGameMenuEvents(e,t,i,r,n,o){e.onOpen.subscribe((()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1)})),e.onQuit.subscribe((async()=>{this.controller&&(r.isObserver||t.play("EVA_BattleControlTerminated"),this.pointer.lock(),this.pointer.setVisible(!1),this.playerUi.dispose(),r.isObserver||this.isSinglePlayer||this.lagState||(n.push(o.create(Q.ActionType.ResignGame)),await new Promise((e=>{this.gameTurnMgr.onActionsSent.subscribeOnce((()=>e()))}))),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.gameTurnMgr.dispose(),this.replay&&(this.replay.finish(this.game.currentTick),this.saveReplay(this.replay)),this.isSinglePlayer||this.sendGameRes(i,{disconnect:!1,desync:!1,quit:!0,finished:!1}),r.isObserver||this.logGame(i,!1),await a.sleep(2e3),this.controller.goToScreen(s.ScreenType.MainMenuRoot,{route:this.returnTo}))})),e.onObserve.subscribe((()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0),n.push(o.create(Q.ActionType.ObserveGame)),this.disposables.add(i?.events.subscribe(Z.EventType.PlayerResigned,(e=>{e.target===r&&this.gameTurnMgr.setPassiveMode?.(!0)}))),this.logGame(i,!1)})),e.onCancel.subscribe((()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0)}))}async onGameEnd(e,t,i,r){var o=!t.defeated;let[l]=this.jsxRenderer.render(y.jsx(f.GameResultPopup,{type:o&&!t.isObserver?f.GameResultType.MpVictory:f.GameResultType.MpDefeat,viewport:this.viewport.value}));this.pointer.setVisible(!1),this.playerUi.dispose(),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close(),this.uiScene.add(l),t.isObserver||i.play(o?"EVA_YouAreVictorious":"EVA_YouHaveLost",!0),r.finish(e.currentTick),this.saveReplay(r),this.isSinglePlayer||this.sendGameRes(e,{disconnect:!1,desync:!1,quit:!1,finished:!e.alliances.getHostilePlayers().length}),t.isObserver||this.logGame(e,o),await a.sleep(5e3),this.uiScene.remove(l),l.destroy(),this.controller?.goToScreen(s.ScreenType.MainMenuRoot,{route:new me.MainMenuRoute(n.ScreenType.Score,{game:e,localPlayer:t,singlePlayer:this.isSinglePlayer,returnTo:this.returnTo??new me.MainMenuRoute(n.ScreenType.Home)})})}logGame(e,t){window.gtag?.("event","game_finish",{singlePlayer:Number(this.isSinglePlayer),numPlayers:e.gameOpts.humanPlayers.filter((e=>e.countryId!==pe.OBS_COUNTRY_ID)).length+e.gameOpts.aiPlayers.filter((e=>!!e)).length,won:Number(t),tournament:Number(this.isTournament),duration:e.currentTime})}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose(),this.isSinglePlayer||(this.wolService.setAutoReconnect(!1),this.gservCon.onClose.unsubscribe(this.onGservClose),this.gservCon.close())}handleGservConError(e){if(!(e instanceof W.OperationCanceledError)){let t;if(e instanceof r.GservError&&e.code===r.GservError.Code.InstanceNonExistent)t=this.strings.get("WOL:InstanceNotFound");else if(e instanceof r.GservError&&e.code===r.GservError.Code.BadLogin)t=this.strings.get("TXT_BADPASS");else if(e instanceof r.GservError&&e.code===r.GservError.Code.AlreadyLoggedIn)t=this.strings.get("WOL:AlreadyLoggedIn");else if(e instanceof r.GservError&&e.code===r.GservError.Code.OutdatedClient)t=this.strings.get("TXT_YOURGAME_OUTDATED");else if(e instanceof r.GservError&&e.code===r.GservError.Code.TooManyLoginAttempts)t=this.strings.get("WOL:TooManyLoginAttempts");else if(e instanceof r.GservError&&e.code===r.GservError.Code.CreatedTooManyInstances)t=this.strings.get("WOL:CreatedTooManyInstances");else if(e instanceof r.GservError&&e.code===r.GservError.Code.InstanceNotAllowed)t=this.strings.get("WOL:InstanceNotAllowed");else if(e instanceof r.GservError&&e.code===r.GservError.Code.InstanceAlreadyStarted)t=this.strings.get("WOL:GameAlreadyStarted");else if(e instanceof r.GservError&&e.code===r.GservError.Code.InstanceVersMismatch)t=this.strings.get("TXT_MISMATCH");else{if(e instanceof V.IrcConnection.SocketError)return;e instanceof V.IrcConnection.ConnectError?t=this.strings.get("TS:ConnectFailed"):(t=this.strings.get("WOL:MatchBadParameters"),e instanceof r.GservError?this.sendDebugInfo(new Error("Gserv error "+e.code,{cause:e})):e instanceof V.IrcConnection.NoReplyError||this.sendDebugInfo(new Error(`Failed to connect to game instance (${e.message??e.name})`,{cause:e})))}this.handleError(e,t)}}handleMapLoadError(e,t){if(!(e instanceof W.OperationCanceledError||e instanceof V.IrcConnection.SocketError)){let i;i=e instanceof ee.DownloadError?this.strings.get("TS:MapNotFound",t):("string"==typeof e?e:e.message)?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):e instanceof V.IrcConnection.NoReplyError?this.strings.get("WOL:MatchBadParameters"):this.strings.get("TXT_MAP_ERROR"),this.handleError(e,i)}}handleGameLoadError(e,t,i){if(!(e instanceof W.OperationCanceledError||e instanceof V.IrcConnection.SocketError)){let r;if(e instanceof ee.DownloadError)r=this.strings.get("TS:AssetLoadError");else if(e instanceof se.IOError)r=this.strings.get("ts:storage_io_error");else{let s="string"==typeof e?e:e.message;if(s?.match(/memory|allocation/i))r=this.strings.get("TS:GameInitOom");else{r=this.strings.get("TS:GameInitError"),i.mapOfficial||(r+="\n\n"+this.strings.get("TS:CustomMapCrash"));let s=new B.Replay;s.init(t.gameId,t.timestamp,i,this.engineVersion,this.engineModHash),s.debugInfo=e instanceof Error?e.stack:e,s.finish(0),this.sendDebugInfo(new Error(`Game init failed (${"string"==typeof e?e:e.message??e.name})`,{cause:e}),{gameId:t.gameId,replay:s,map:this.debugMapFile,official:i.mapOfficial})}}this.handleError(e,r)}}handleGameError(e,t,i,r){const s=this.replay;s&&(s.name+=" (crashdump)",s.debugInfo=e instanceof Error?e.stack:e,"desync_error"===e&&(s.debugInfo+="\nConstants: "+[Math.E,Math.LN10,Math.LN2,Math.LOG10E,Math.LOG2E,Math.PI,Math.SQRT1_2,Math.SQRT2].join(",")),s.finish(i.currentTick),this.saveReplay(s)),this.handleError(e,t),this.sendDebugInfo(e,{gameId:i.id,replay:s,map:this.debugMapFile,official:i.gameOpts.mapOfficial},r),"desync_error"===e&&this.sendGameRes(i,{disconnect:!1,desync:!0,quit:!1,finished:!1})}sendDebugInfo(e,{gameId:t,replay:i,map:r,official:s}={},n){this.sentry&&!e.message?.match(/out of memory|buffer allocation/i)&&(async()=>{let a=n?await n():void 0;this.sentry.captureException(e,(e=>{if(t&&e.setTag("gameId",t),e.setTag("nick",this.playerName),e.setTag("tournament",this.isTournament),a?.stateDump&&e.addAttachment({filename:"statedump.7z",data:a.stateDump}),a?.debugLog&&e.addAttachment({filename:"lockstep_log.7z",data:a.debugLog}),i)try{e.addAttachment({filename:i.name+B.Replay.extension,data:i.serialize()})}catch(t){e.setExtra("replayError",t)}return r&&(e.addAttachment({filename:r.filename,data:r.getBytes()}),e.setTag("mapName",r.filename)),void 0!==s&&e.setTag("officialMap",s),e}))})().catch((e=>console.error("Failed sending error to sentry",e)))}handleError(e,t){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock(),this.errorHandler.handle(e,t,(()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(s.ScreenType.MainMenuRoot)}))}saveReplay(e){(async()=>{try{await this.replayManager.saveReplay(e)}catch(t){t instanceof te.StorageQuotaError||t instanceof se.IOError||t instanceof ie.FileNotFoundError||t instanceof oe.ReplayStorageError||this.sendDebugInfo(t,{replay:e,gameId:this.game?.id}),console.error(t),this.toastApi.push(this.strings.get("GUI:SaveReplayError"))}})()}sendGameRes(e,t){(async()=>{if(this.wgameresUrl&&e.gameOpts.humanPlayers.find((e=>e.name===this.playerName))?.countryId!==pe.OBS_COUNTRY_ID)try{var i=(new ge.GameRes).fromGame(e,this.isTournament,this.getGameResClientInfo(t)).toBinary();this.wGameResCon.isOpen()||await this.wGameResCon.connect(this.wgameresUrl),this.wGameResCon.sendGameResPacket(i)}catch(e){console.error(e)}finally{this.wGameResCon.isOpen()&&this.wGameResCon.close()}})()}getGameResClientInfo(e){return{clientVers:this.engineVersion,avgFps:0,outOfSync:e.desync,gameSku:this.wolService.getConfig().getClientSku(),accountName:this.playerName,suddenDisconnect:e.disconnect,quit:e.quit,finished:e.finished,pingsRecv:0,pingsSent:0}}},e("GameScreen",ve)}}})),System.register("gui/screen/mainMenu/component/PrefetchProgress",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("PrefetchProgress",(({progress:e,statusText:t})=>i.default.createElement("div",{className:"prefetch-progress"},i.default.createElement("div",null,i.default.createElement("label",null,t),i.default.createElement("progress",{value:e,max:100})))))}}})),System.register("gui/screen/mainMenu/MainMenuRootScreen",["gui/jsx/jsx","gui/screen/mainMenu/component/MainMenu","gui/screen/mainMenu/MainMenuController","gui/screen/mainMenu/ScreenType","engine/resourceConfigs","util/disposable/CompositeDisposable","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/jsx/HtmlView","gui/screen/mainMenu/component/PrefetchProgress","@puzzl/core/lib/async/sleep","gui/screen/RootScreen"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=class extends g.RootScreen{constructor(e,t,i,r,s,n,a,l,c,h,u){super(),this.subScreens=e,this.uiScene=t,this.gameResConfig=i,this.strings=r,this.images=s,this.jsxRenderer=n,this.videoSrc=a,this.cdnResourceLoader=l,this.sound=c,this.music=h,this.sentry=u,this.prefetched=!1,this.disposables=new o.CompositeDisposable}createView(){var e;this.mainMenu=new r.MainMenu(this.uiScene.menuViewport,this.images,this.jsxRenderer,this.videoSrc),!this.prefetched&&this.gameResConfig.isCdn()&&([e]=this.jsxRenderer.render(i.jsx(h.HtmlView,{component:u.PrefetchProgress,ref:e=>this.prefetchProgressView=e,props:{progress:0,statusText:this.strings.get("TS:Preloading")}})),this.prefetchProgressEl=e,this.prefetched=!0,this.updatePrefetchProgressViewport())}createViewAndController(){return this.createView(),this.mainMenuCtrl=new s.MainMenuController(this.mainMenu,this.sound,this.music),this.mainMenuCtrl.onScreenChange.subscribe((e=>this.sentry?.addBreadcrumb({category:"ui",message:void 0!==e?"Navigated to screen "+n.ScreenType[e]:"Navigated to previous screen",level:"info"}))),this.mainMenuCtrl}onViewportChange(){this.mainMenu.setViewport(this.uiScene.menuViewport),this.mainMenuCtrl?.rerenderCurrentScreen(),this.updatePrefetchProgressViewport()}onEnter(e){let t=this.createViewAndController();for(var[i,r]of this.subScreens)t.addScreen(i,r);if(this.uiScene.add(this.mainMenu),setTimeout((()=>{e?.route?t.goToScreen(e.route.screenType,e.route.params):t.goToScreen(n.ScreenType.Home)})),this.prefetchProgressEl){let e=!1,t=new l.Task((async t=>{await d.sleep(5e3,t),d.sleep(15e3,t).then((()=>{e||this.uiScene.add(this.prefetchProgressEl)})).catch((e=>{if(!(e instanceof c.OperationCanceledError))throw e})),await this.cdnResourceLoader.loadResources(a.resourcesForPrefetch,t,(e=>{this.prefetchProgressView.getElement().applyOptions((t=>t.progress=e))})),e=!0,this.uiScene.remove(this.prefetchProgressEl)}));t.start().catch((t=>{this.prefetchProgressEl&&this.uiScene.remove(this.prefetchProgressEl),e=!0,t instanceof c.OperationCanceledError||console.error(t)})).then((()=>t=void 0)),this.disposables.add((()=>{t?.cancel(),this.prefetchProgressEl.destroy(),this.prefetchProgressEl=void 0,this.prefetchProgressView=void 0}))}}updatePrefetchProgressViewport(){this.prefetchProgressEl?.getHtmlContainer()?.setSize(this.uiScene.viewport.width,0)}async onLeave(){this.mainMenuCtrl&&(this.mainMenuCtrl.toggleMainVideo(!1),await this.mainMenuCtrl.leaveCurrentScreen(),this.mainMenuCtrl.destroy(),this.mainMenuCtrl=void 0),this.uiScene.remove(this.mainMenu),this.mainMenu.destroy(),this.mainMenu=void 0,this.disposables.dispose()}},e("MainMenuRootScreen",p)}}})),System.register("network/gamestate/ReplayTurnManager",["game/Game","game/GameSpeed","network/gamestate/replay/TurnActionsReplayEvent","util/event"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ReplayTurnManager",class{constructor(e,t,i,r){this.game=e,this.replay=t,this.actionFactory=i,this.actionLogger=r,this.errorState=!1,this.gameSpeedChanged=!1,this._onReplayEvent=new n.EventDispatcher,this.onGameSpeedChanged=()=>{this.gameSpeedChanged=!0}}get onReplayEvent(){return this._onReplayEvent.asEvent()}init(){this.game.desiredSpeed.onChange.subscribe(this.onGameSpeedChanged),this.computeGameTurn(this.game.speed.value),this.replayIterator=this.replay.getEvents().values(),this.nextReplayEvent=this.replayIterator.next().value}computeGameTurn(e){this.gameTurnMillis=1e3/(e*r.GameSpeed.BASE_TICKS_PER_SECOND)}setErrorState(){this.errorState=!0}getErrorState(){return this.errorState}getTurnMillis(){return this.gameTurnMillis}doGameTurn(e){if(!this.errorState)if(this.game.status!==i.GameStatus.Ended){for(;this.nextReplayEvent&&this.nextReplayEvent.tickNo===this.game.currentTick;)this.nextReplayEvent instanceof s.TurnActionsReplayEvent&&this.processActions(this.nextReplayEvent.payload),this._onReplayEvent.dispatch(this,this.nextReplayEvent),this.nextReplayEvent=this.replayIterator.next().value;if(this.nextReplayEvent&&this.nextReplayEvent.tickNo<this.game.currentTick)throw new Error("Replay event desync");this.replay.endTick+1<=this.game.currentTick?this.game.status=i.GameStatus.Ended:(this.game.update(),this.gameSpeedChanged&&(this.game.speed.value=this.game.desiredSpeed.value,this.computeGameTurn(this.game.speed.value),this.gameSpeedChanged=!1))}else this.game.speed.value=0}processActions(e){e.forEach((([e,t])=>t.forEach((t=>{let i=this.actionFactory.create(t.id);i.player=this.game.getPlayer(e),i.unserialize(t.params),i.process();var r=i.print();r&&this.actionLogger?.debug(`(${i.player.name})@${this.game.currentTick}: `+r)}))))}dispose(){this.game.desiredSpeed.onChange.unsubscribe(this.onGameSpeedChanged)}})}}})),System.register("gui/screen/replay/ReplayScreen",["engine/Engine","gui/screen/game/component/hud/viewmodel/SidebarModel","tools/DevToolsApi","engine/GameAnimationLoop","util/disposable/CompositeDisposable","gui/screen/game/SoundHandler","gui/screen/game/worldInteraction/WorldInteractionFactory","gui/screen/game/ObserverUi","gui/screen/game/GameMenu","gui/screen/game/WorldView","engine/sound/Eva","engine/sound/EvaSpecs","gui/screen/game/HudFactory","gui/screen/game/component/Minimap","game/SideType","network/gamestate/ReplayTurnManager","game/action/ActionFactory","game/action/ActionFactoryReg","gui/screen/game/component/hud/viewmodel/MessageList","engine/sound/Music","network/gamestate/replay/ChatMessageReplayEvent","engine/sound/SoundKey","engine/sound/ChannelType","network/gamestate/replay/TauntReplayEvent","gui/screen/game/TauntPlayback","gui/screen/game/component/hud/commandBar/CommandBarButtonType","util/userAgent","gui/screen/RootScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","data/MapFile","engine/ResourceLoader","engine/MapDigest","gui/chat/ChatHistory"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e}],execute:function(){N=class extends R.RootScreen{constructor(e,t,i,r,s,n,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O){super(),this.engineVersion=e,this.engineModHash=t,this.errorHandler=i,this.gameMenuSubScreens=r,this.loadingScreenApiFactory=s,this.config=n,this.strings=o,this.renderer=l,this.uiScene=c,this.runtimeVars=h,this.messageBoxApi=u,this.uiAnimationLoop=d,this.viewport=g,this.jsxRenderer=p,this.pointer=m,this.sound=f,this.music=y,this.keyBinds=T,this.generalOptions=v,this.actionLogger=b,this.fullScreen=S,this.mapFileLoader=w,this.gameLoader=C,this.vxlGeometryPool=E,this.buildingImageDataCache=x,this.leaveAction=O,this.preventUnload=!0,this.disposables=new a.CompositeDisposable}async onEnter(e){this.params=e,this.disposables.add((()=>this.params=void 0)),this.pointer.lock(),this.pointer.setVisible(!1),await(this.music?.play(S.MusicType.Loading));var{gameId:t,gameTimestamp:n,gameOpts:a,engineVersion:o,modHash:l}=e.replay;let c;if(o!==this.engineVersion?c=this.strings.get("GUI:ReplayVersionMismatch",o):l!==this.engineModHash&&(c=this.strings.get("GUI:ReplayModMismatch")),c)this.messageBoxApi.show(c,this.strings.get("GUI:Ok"),(()=>{this.leaveAction()}));else{let g;o=this.loadingScreenApiFactory.create(P.LoadingScreenType.Replay),this.loadingScreenApi=o,this.disposables.add(o,(()=>this.loadingScreenApi=void 0)),l=a.mapName;try{var h=await this.mapFileLoader.load(l);if(B.MapDigest.compute(h)!==a.mapDigest)return void this.handleError("Map digest mismatch",this.strings.get("TS:MapMismatch",l));var d=new I.MapFile(h);g=await this.gameLoader.load(t,n,a,d,void 0,1===a.humanPlayers.length,o)}catch(c){let e;return c.message?.match(/memory|allocation/i)?e=this.strings.get("TS:GameInitOom"):c instanceof k.DownloadError?e=this.strings.get("TS:MapNotFound",l):(e=this.strings.get("TS:GameInitError"),a.mapOfficial||(e+="\n\n"+this.strings.get("TS:CustomMapCrash"))),void this.handleError(c,e)}let{game:f,theater:S,hudSide:C,cameoFilenames:E}=g;this.game=f,this.baseSpeed=this.game.speed.value,this.disposables.add((()=>this.game=void 0)),this.disposables.add((()=>{i.Engine.unloadTheater(S.type),this.gameLoader.clearStaticCaches()})),this.disposables.add(f),o=new r.SidebarModel(f,e.replay);let M=new b.MessageList(f.rules.audioVisual.messageDuration,6,void 0);l=new j.ChatHistory,this.messageList=M,this.disposables.add((()=>this.messageList=void 0)),a=[A.CommandBarButtonType.ReplayRewind,A.CommandBarButtonType.ReplayPlay,A.CommandBarButtonType.ReplayPause,A.CommandBarButtonType.ReplaySpeed],this.hudFactory=new p.HudFactory(C,this.uiScene,o,M,l,f.debugText,this.runtimeVars.debugText,void 0,f.getCombatants(),f.stalemateDetectTrait,f.countdownTimer,E,this.jsxRenderer,this.strings,a),this.disposables.add((()=>this.hudFactory=void 0));let R=this.hudFactory.create();this.hud=R;let N=this.minimap=new m.Minimap(f,void 0,R.getTextColor(),f.rules.general.radar);R.setMinimap(N),this.disposables.add(N,(()=>this.minimap=void 0)),N.setPointerEvents(this.pointer.pointerEvents),a={width:R.sidebarWidth,height:R.actionBarHeight};let L=new u.WorldView(a,f,this.sound,this.renderer,this.runtimeVars,N,this.strings,this.generalOptions,this.vxlGeometryPool,this.buildingImageDataCache),{worldScene:D,worldSound:F,renderableManager:_}=L.init(void 0,this.viewport.value,S);this.worldView=L,this.disposables.add(L,(()=>this.worldView=void 0)),D.create3DObject(),a=new T.ActionFactory,(new v.ActionFactoryReg).register(a,f,void 0);let U=this.gameTurnMgr=new y.ReplayTurnManager(f,e.replay,a,this.actionLogger);this.gameTurnMgr.init();let H=new O.TauntPlayback(this.sound.audioSystem,i.Engine.getTaunts());const G=e=>{if(e instanceof w.ChatMessageReplayEvent){var t=e.payload;let r=f.getPlayer(t.playerId);var i=this.strings.get("TS:ReplayChatFrom",r.name)+" "+t.message;t=r.color.asHexString();M.addChatMessage(i,t)}else e instanceof x.TauntReplayEvent&&(i=e.payload,t=f.getPlayer(i.playerId),i=i.tauntNo,H.playTaunt(t,i).catch((e=>console.error(e))))};U.onReplayEvent.subscribe(G),this.disposables.add((()=>U.onReplayEvent.unsubscribe(G))),this.onGameStart(f,R,o,N,M,D,F,_),s.DevToolsApi.registerCommand("reset",(async()=>{await this.onLeave(),await this.onEnter(e)})),s.DevToolsApi.registerVar("speed",f.desiredSpeed),this.disposables.add((()=>s.DevToolsApi.unregisterCommand("reset")),(()=>s.DevToolsApi.unregisterVar("speed")))}}onViewportChange(){if(this.loadingScreenApi?.updateViewport(),this.hud){this.uiScene.remove(this.hud),this.hud.destroy();let e=this.hudFactory.create();this.hud=e,e.setMinimap(this.minimap),this.worldView&&(this.uiScene.add(e),this.menu?.handleHudChange(e),this.worldView.handleViewportChange(this.viewport.value),this.playerUi?.handleHudChange(e),this.initHudEvents(e,this.messageList))}}onGameStart(e,t,r,s,a,o,l,c){this.loadingScreenApi?.dispose(),this.music?.play(S.MusicType.Normal);var h=new g.EvaSpecs(f.SideType.GDI).readIni(i.Engine.getIni("eva.ini"));let u=new d.Eva(h,this.sound,this.renderer);u.init(),this.disposables.add(u);try{this.initUi(e,t,r,o,l,u,c,s,a)}catch(t){return h=t.message?.match(/memory|allocation/i)?this.strings.get("TS:GameInitOom"):this.strings.get("TS:GameInitError"),void this.handleError(t,h)}this.renderer.removeScene(this.uiScene),this.renderer.addScene(o),this.renderer.addScene(this.uiScene),this.pointer.setVisible(!0),e.start(),this.gameAnimationLoop=new n.GameAnimationLoop(void 0,this.renderer,this.sound,this.gameTurnMgr,{skipFrames:!0,skipBudgetMillis:8,onError:this.config.devMode?void 0:t=>this.handleError(t,this.strings.get("TS:GameCrashed")+(e.gameOpts.mapOfficial?"":"\n\n"+this.strings.get("TS:CustomMapCrash")))}),this.uiAnimationLoop.stop(),this.gameAnimationLoop.start()}initUi(e,t,i,r,s,n,a,u,d){let g=new o.SoundHandler(e,s,n,this.sound,e.events,d,this.strings,void 0);if(g.init(),this.disposables.add(g),d.onNewMessage.subscribe((e=>{e.animate&&this.sound.play(C.SoundKey.IncomingMessage,E.ChannelType.Ui)})),M.isIpad()){let e=e=>{i.topTextLeftAlign=e};this.fullScreen.onChange.subscribe(e),this.disposables.add((()=>this.fullScreen.onChange.unsubscribe(e)))}this.uiScene.add(t),this.initHudEvents(t,d);let p=this.menu=new h.GameMenu(this.gameMenuSubScreens,e,void 0,void 0,void 0,!0);p.init(t),this.initGameMenuEvents(p),this.disposables.add(p,(()=>this.menu=void 0));var m=e.getUnitSelection(),f=this.runtimeVars.freeCamera,y=this.runtimeVars.debugPaths,T=this.config.devMode;y=new l.WorldInteractionFactory(void 0,e,m,a,this.uiScene,r,this.pointer,this.renderer,this.keyBinds,this.generalOptions,f,y,T,document,u,this.strings,t.getTextColor()),T=this.config.discordUrl;this.playerUi=new c.ObserverUi(e,y,r.cameraPan,a,r,this.runtimeVars,p,this.sound,this.strings,this.messageBoxApi,T),this.playerUi.init(t),this.disposables.add(this.playerUi,(()=>this.playerUi=void 0))}initGameMenuEvents(e){e.onOpen.subscribe((()=>{this.pointer.unlock(),this.playerUi.worldInteraction.setEnabled(!1)})),e.onQuit.subscribe((async()=>{this.playerUi.dispose(),this.gameTurnMgr.dispose(),this.leaveAction()})),e.onCancel.subscribe((()=>{this.pointer.lock(),this.playerUi.worldInteraction.setEnabled(!0)}))}initHudEvents(e,t){e.onCommandBarButtonClick.subscribe((e=>{switch(this.sound.play(C.SoundKey.GenericClick,E.ChannelType.Ui),e){case A.CommandBarButtonType.ReplayRewind:(async()=>{var e=this.params;await this.onLeave(),await this.onEnter(e)})().catch((e=>console.error(e)));break;case A.CommandBarButtonType.ReplayPlay:this.game.desiredSpeed.value=this.baseSpeed,this.game.speed.value===Number.EPSILON?this.gameTurnMgr.doGameTurn(performance.now()):this.game.speed.value!==this.baseSpeed&&t.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm","1x"),"grey");break;case A.CommandBarButtonType.ReplayPause:this.game.desiredSpeed.value=Number.EPSILON;break;case A.CommandBarButtonType.ReplaySpeed:this.game.speed.value===Number.EPSILON&&(this.game.desiredSpeed.value=this.baseSpeed,this.gameTurnMgr.doGameTurn(performance.now()));let i=Math.floor(this.game.desiredSpeed.value/this.baseSpeed);i=16===i?1:2*i,this.game.desiredSpeed.value=i*this.baseSpeed,t.addSystemMessage(this.strings.get("TS:ReplaySpeedConfirm",i+"x"),"grey");break;default:console.warn("Unhandled command type "+e)}}))}async onLeave(){this.pointer.unlock(),this.gameAnimationLoop&&(this.gameAnimationLoop.destroy(),this.gameAnimationLoop=void 0,this.uiAnimationLoop.start()),this.hud&&(this.uiScene.remove(this.hud),this.hud.destroy(),this.hud=void 0),this.gameTurnMgr?.dispose(),this.gameTurnMgr=void 0,this.disposables.dispose()}handleError(e,t){this.gameTurnMgr&&this.gameTurnMgr.setErrorState(),this.pointer.unlock(),this.errorHandler.handle(e,t,(()=>{this.leaveAction()}))}},e("ReplayScreen",N)}}})),System.register("gui/screen/ScreenParamsMap",["gui/screen/ScreenType"],(function(e,t){"use strict";return t&&t.id,{setters:[function(e){}],execute:function(){}}})),System.register("gui/screen/RootRoute",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("RootRoute",class{constructor(...e){var[t,i]=e;this.screenType=t,this.params=i}})}}})),System.register("gui/screen/mainMenu/login/LoginScreen",["gui/jsx/jsx","network/WolError","gui/screen/mainMenu/login/LoginBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/sleep","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/login/ServerPings","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuRoute"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e}],execute:function(){p=void 0,m=class extends h.MainMenuScreen{constructor(e,t,i,r,s,n,a,o,l,c,h,u){super(),this.wolService=e,this.wladderService=t,this.strings=i,this.jsxRenderer=r,this.messageBoxApi=s,this.serverRegions=n,this.serversUrl=a,this.breakingNewsUrl=o,this.netLogger=l,this.errorHandler=c,this.localPrefs=h,this.rootController=u,this.title=this.strings.get("GUI:Login"),this.needsServerListRefresh=!1,this.handleLoginSubmit=async()=>{var e,t,i;!this.isBusy&&this.loginBoxApi&&this.controller&&(this.isBusy=!0,(e=this.selectedRegion)&&(({user:t,pass:i}=this.loginBoxApi.getValues()),await this.controller.hideSidebarButtons(),await this.login(t,i,e.id)))}}async onEnter(e){this.params=e,this.formRendered=!1,this.controller.toggleMainVideo(!1),e.clearCredentials&&(p=void 0);try{await this.loadServerList()}catch(e){return void this.handleWolError(e,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0})}this.needsServerListRefresh=!1,this.serverPings=new u.ServerPings(this.serverRegions,this.wolService.getConfig(),this.netLogger),p&&this.serverRegions.isAvailable(p.regionId)?(this.isBusy=!0,this.login(p.user,p.pass,p.regionId)):(this.isBusy=!1,this.initView(!0))}async loadServerList(e){let t=!1;var i=setTimeout((async()=>{this.messageBoxApi.show(this.strings.get("TXT_CONNECTING")),t=!0}),1e3);try{var r=await this.wolService.loadServerList(this.serversUrl,e);if(e?.isCancelled())return;this.serverRegions.load(r),this.selectedRegion&&(this.selectedRegion=this.serverRegions.getAll().find((e=>e.id===this.selectedRegion.id)))}finally{clearTimeout(i),t&&this.messageBoxApi.destroy()}}initView(e=!1){if(this.controller){if(this.updateSidebarButtons(),this.isBusy||this.controller.showSidebarButtons(),!this.selectedRegion){var t=(t=this.localPrefs.getItem(c.StorageKey.PreferredServerRegion))&&this.serverRegions.isAvailable(t)?this.serverRegions.get(t):this.serverRegions.getFirstAvailable();let e=this.serverPings.pings;!t||e.has(t)&&void 0===e.get(t)?this.selectedRegion=void 0:this.selectedRegion=t}e&&!this.params.forceUser&&this.selectedRegion&&this.updateServers();var[t]=this.jsxRenderer.render(i.jsx(a.HtmlView,{width:"100%",height:"100%",component:s.LoginBox,props:{ref:e=>this.loginBoxApi=e,regions:this.serverRegions.getAll(),selectedRegion:this.selectedRegion,selectedUser:this.params.forceUser,pings:this.serverPings.pings,breakingNewsUrl:this.breakingNewsUrl,strings:this.strings,onRegionChange:e=>{this.selectedRegion=this.serverRegions.get(e),this.loginBox?.applyOptions((e=>e.selectedRegion=this.selectedRegion)),this.updateSidebarButtons()},onRequestRegionRefresh:()=>{this.needsServerListRefresh=!0,this.updateServers()},onSubmit:this.handleLoginSubmit},innerRef:e=>this.loginBox=e}));this.controller.setMainComponent(t),this.updateSidebarButtons(),this.formRendered=!0}}updateSidebarButtons(){this.controller&&this.controller.setSidebarButtons([{label:this.strings.get("GUI:Login"),disabled:!this.selectedRegion,onClick:this.handleLoginSubmit},{label:this.strings.get("GUI:NewAccount"),disabled:!!this.params.forceUser,onClick:()=>{this.controller?.goToScreen(n.ScreenType.NewAccount,{afterLogin:this.params.afterLogin})}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(n.ScreenType.Home)}}])}updateServers(){this.isBusy||this.serversUpdateTask||(this.serverPings.pings.clear(),this.handleServerPingsUpdate(),this.serversUpdateTask=new o.Task((async e=>{if(this.formRendered||await l.sleep(500,e),this.needsServerListRefresh){this.needsServerListRefresh=!1;try{await this.loadServerList(e)}catch(e){return this.handleWolError(e,this.strings.get("TXT_NO_SERV_LIST"),{fatal:!0}),void(this.serversUpdateTask=void 0)}}this.loginBox?.applyOptions((e=>{e.selectedRegion=this.selectedRegion,e.regions=this.serverRegions.getAll()})),this.updateSidebarButtons();try{await this.serverPings.update((()=>this.handleServerPingsUpdate()),e)}finally{this.serversUpdateTask=void 0}this.handleServerPingsUpdate()})),this.serversUpdateTask.start().catch((e=>{e instanceof d.OperationCanceledError||console.error(e)})))}handleServerPingsUpdate(){if(this.loginBoxApi){var e=this.selectedRegion;let t=this.serverPings.pings;e&&t.has(e)&&void 0===t.get(e)&&(this.selectedRegion=void 0,this.loginBox?.applyOptions((e=>e.selectedRegion=void 0)),this.updateSidebarButtons()),this.loginBox?.refresh()}}async login(e,t,i){if(e.match(/^[A-Za-z0-9-_]+$/)){this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0;let a=new o.Task((async e=>{await l.sleep(1e3,e),e.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))}));a.start().catch((e=>{e instanceof d.OperationCanceledError||console.error(e)}));var s=this.serverRegions.get(i);this.serverRegions.setSelectedRegion(i);try{await this.wolService.validateGameVersion(s)}catch(e){let t;return a.cancel(),this.messageBoxApi.destroy(),t=e instanceof r.WolError&&e.code===r.WolError.Code.OutdatedClient?this.strings.get("TS:OutdatedClient"):this.strings.get("TXT_NO_SERV_LIST"),void this.handleWolError(e,t,{fatal:!1})}try{let r=[];this.wolService.isConnected()&&this.wolService.getConnection().getCurrentUser()||(r=await this.wolService.connectAndLogin({url:s.wolUrl,wolv2Ascii:s.wolv2Ascii,keepAliveInGame:s.wolKeepAliveInGame,user:e,pass:t}),this.wladderService.setUrl(s.wladderUrl),p={user:e,pass:t,regionId:i}),a.cancel(),this.messageBoxApi.destroy(),this.localPrefs.setItem(c.StorageKey.PreferredServerRegion,i);var n=this.params.afterLogin(r);n instanceof g.MainMenuRoute?this.controller?.goToScreen(n.screenType,n.params):this.rootController.goToScreen(n.screenType,n.params)}catch(e){a.cancel(),this.messageBoxApi.destroy(),e instanceof r.WolError&&e.code===r.WolError.Code.BadLogin?(this.wolService.closeWolConnection(),this.handleBadPass()):this.handleWolError(e,this.strings.get("TS:ConnectFailed"),{fatal:!1,netError:!0})}}else this.handleBadPass()}handleBadPass(){this.messageBoxApi.show(this.strings.get("TXT_BADPASS"),this.strings.get("GUI:Ok"),(()=>{this.isBusy=!1,this.formRendered?(this.updateSidebarButtons(),this.controller.showSidebarButtons()):this.initView()}))}handleWolError(e,t,{fatal:i,netError:r}){this.errorHandler.handle(e,t,(()=>{this.isBusy=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.wolService.closeWolConnection(),i?this.controller?.goToScreen(n.ScreenType.Home):this.formRendered?(this.updateSidebarButtons(),this.controller?.showSidebarButtons()):(r&&(this.needsServerListRefresh=!0),this.initView(r))}))}async onLeave(){this.loginBoxApi=null,this.loginBox=void 0,this.formRendered=!1,this.serversUpdateTask?.cancel(),this.serversUpdateTask=void 0,this.isBusy||await this.controller.hideSidebarButtons(),this.isBusy=!1}},e("LoginScreen",m)}}})),System.register("gui/screen/mainMenu/mapSel/component/MapSel",["react","gui/component/List","gui/component/Select","gui/component/Option"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){var t;(t=a=a||{}).None="",t.NameAsc="nameAsc",t.NameDesc="nameDesc",t.MaxSlotsAsc="maxSlotsAsc",t.MaxSlotsDesc="maxSlotsDesc",e("SortType",a),o=(e,t)=>{switch(t){case a.None:return e;case a.NameAsc:return e.sort(((e,t)=>e.mapTitle.localeCompare(t.mapTitle)));case a.NameDesc:return e.sort(((e,t)=>t.mapTitle.localeCompare(e.mapTitle)));case a.MaxSlotsAsc:return e.sort(((e,t)=>e.maxSlots-t.maxSlots));case a.MaxSlotsDesc:return e.sort(((e,t)=>t.maxSlots-e.maxSlots));default:throw new Error(`Unsupported sort type "${t}"`)}},e("MapSel",(({strings:e,gameModes:t,maps:l,selectedGameMode:c,selectedMapName:h,initialSortType:u,onSelectGameMode:d,onSelectMap:g,onSelectSort:p})=>{const m=i.useRef(null),[f,y]=i.useState(l),[T,v]=i.useState(""),[b,S]=i.useState(u);i.useEffect((()=>{w()}),[l,T,b]),i.useEffect((()=>{let e=setTimeout((()=>m.current?.scrollIntoView()),50);return()=>clearTimeout(e)}),[l]);const w=()=>{y(o(l.filter((e=>e.mapTitle.toLowerCase().includes(T.toLowerCase()))),b))};return i.default.createElement("div",{className:"map-sel-form"},i.default.createElement("div",{className:"map-sel-title"},e.get("GUI:SelectEngagement")),i.default.createElement("div",{className:"map-sel-body"},i.default.createElement("div",{className:"map-sel-game-mode"},i.default.createElement(r.List,{title:e.get("GUI:GameType"),className:"game-mode-list",tooltip:e.get("STT:ScenarioListGameType")},t.map((t=>i.default.createElement(r.ListItem,{key:t.id,selected:c===t,onClick:()=>d(t),"data-r-tooltip":e.get(t.description)},e.get(t.label)))))),i.default.createElement("div",{className:"map-sel-map"},i.default.createElement(r.List,{title:i.default.createElement("div",{className:"map-list-title"},i.default.createElement("div",null,e.get("GUI:GameMap")),i.default.createElement("div",{className:"map-list-sort","data-r-tooltip":e.get("STT:SortBy")},i.default.createElement("label",null,"⇵"),i.default.createElement(s.Select,{initialValue:b,onSelect:e=>(e=>{S(e),p(e)})(e),className:"map-list-sort-select"},i.default.createElement(n.Option,{value:a.None,label:e.get("TS:SortNone")}),i.default.createElement(n.Option,{value:a.NameAsc,label:e.get("TS:SortName")+" ↓"}),i.default.createElement(n.Option,{value:a.NameDesc,label:e.get("TS:SortName")+" ↑"}),i.default.createElement(n.Option,{value:a.MaxSlotsAsc,label:e.get("TS:SortMaxSlots")+" ↓"}),i.default.createElement(n.Option,{value:a.MaxSlotsDesc,label:e.get("TS:SortMaxSlots")+" ↑"})))),className:"map-list",tooltip:e.get("STT:ScenarioListMaps")},f.map((e=>{var t=e.mapName===h;return i.default.createElement(r.ListItem,{key:e.mapName,selected:t,innerRef:t?m:null,onClick:()=>g(e.mapName,!1),onDoubleClick:()=>g(e.mapName,!0)},e.mapTitle)}))),i.default.createElement("div",{className:"map-sel-search"},i.default.createElement("label",null,i.default.createElement("span",null,e.get("GUI:Search")),i.default.createElement("input",{type:"text",className:"new-message",value:T,onChange:e=>{var t=e.target.value;v(t)}}))))))}))}}})),System.register("gui/screen/mainMenu/mapSel/MapSelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/mapSel/component/MapSel","gui/screen/mainMenu/lobby/MapPreviewRenderer","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/MainMenuScreen","game/ini/GameModeType","LocalPrefs","data/MapFile","data/vfs/VirtualFile","engine/MapSupport","data/vfs/IOError","data/vfs/StorageQuotaError","data/vfs/FileNotFoundError","engine/Engine","util/disposable/CompositeDisposable","engine/ResourceLoader","engine/MapManifest","data/vfs/NameNotAllowedError"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e}],execute:function(){w=class extends l.MainMenuScreen{constructor(e,t,i,r,s,n,a,o,l,c,u){super(),this.strings=e,this.jsxRenderer=t,this.mapFileLoader=i,this.errorHandler=r,this.messageBoxApi=s,this.localPrefs=n,this.mapList=a,this.gameModes=o,this.mapDir=l,this.fsAccessLib=c,this.sentry=u,this.title=this.strings.get("GUI:ChooseMap"),this.disposables=new T.CompositeDisposable,this.handleSelectMap=(e,t)=>{var i=this.selectedMapName!==e;this.selectedMapName=e,this.refreshMapInfo(),i&&(this.updateMapDeferred({updatePreview:!t}),this.initSidebar()),this.form.applyOptions((t=>t.selectedMapName=e)),t&&this.handleSubmit()},this.handleSelectGameMode=e=>{this.selectedGameMode=e;let t=this.computeAvailableMaps();t.find((e=>e.mapName===this.selectedMapName))||this.handleSelectMap(t[0].mapName,!1),this.refreshMapInfo(),this.form.applyOptions((i=>{i.selectedGameMode=e,i.maps=t}))},this.handleSelectSort=e=>{this.localPrefs.setItem(h.StorageKey.LastSortMap,e)}}onEnter({gameOpts:e,usedSlots:t,lobbyType:i}){this.updateMapsAndModes(),this.selectedGameMode=this.availableGameModes.find((t=>t.id===e.gameMode)),this.selectedMapName=e.mapName,this.lobbyType=i,this.computeUsedSlots=t,this.initSidebar(),this.initForm()}updateMapsAndModes(){let e=this.gameModes.getAll().filter((e=>this.mapList.getAll().find((t=>t.gameModes.some((t=>t.id===e.id))))));var t=this.mapList.getAll().map((e=>({mapName:e.fileName,mapTitle:e.getFullMapTitle(this.strings),maxSlots:e.maxSlots,gameModes:e.gameModes})));this.availableGameModes=e.filter((e=>e.type!==c.GameModeType.Cooperative)).sort(((e,t)=>e.id-t.id)),this.allMaps=t}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(i.jsx(r.HtmlView,{innerRef:e=>this.form=e,component:s.MapSel,props:{strings:this.strings,maps:this.computeAvailableMaps(),gameModes:this.availableGameModes,selectedMapName:this.selectedMapName,selectedGameMode:this.selectedGameMode,initialSortType:this.readInitialSort(),onSelectMap:this.handleSelectMap,onSelectGameMode:this.handleSelectGameMode,onSelectSort:this.handleSelectSort}}))[0])}readInitialSort(){let e=this.localPrefs.getItem(h.StorageKey.LastSortMap);return e&&Object.values(s.SortType).includes(e)||(e=s.SortType.None),e}initSidebar(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:UseMap"),tooltip:this.strings.get("STT:ScenarioButtonUseMap"),onClick:()=>{this.handleSubmit()}},...this.mapDir?[{label:this.strings.get("TS:ImportMap"),tooltip:this.strings.get("STT:ImportMap"),onClick:async()=>{let e=new o.CancellationTokenSource;var t=()=>e.cancel();this.disposables.add(t);try{await this.importMap(e.token)}catch(e){return void(e instanceof o.OperationCanceledError||this.handleMapImportError(e))}finally{this.disposables.remove(t)}}}]:[],{label:this.strings.get("GUI:Cancel"),tooltip:this.strings.get("STT:ScenarioButtonCancel"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}],!0),this.refreshMapInfo(),this.controller.showSidebarButtons()}async importMap(e){let t;try{var i=await this.fsAccessLib.showOpenFilePicker({types:[{description:"RA2 Map",accept:{"text/plain":y.Engine.supportedMapTypes.map((e=>"."+e))}}],excludeAcceptAllOption:!0});let e=Array.isArray(i)?i[0]:i;t=await e.getFile()}catch(e){if("AbortError"===e.name)return;if(e instanceof DOMException)throw new p.IOError(`File could not be read (${e.name})`,{cause:e});throw e}if(y.Engine.supportedMapTypes.some((e=>t.name.toLowerCase().endsWith("."+e))))if(this.mapList.getByName(t.name))await this.messageBoxApi.alert(this.strings.get("TS:ImportMapDuplicateError",t.name),this.strings.get("GUI:Ok"));else{let s,n;i=await d.VirtualFile.fromRealFile(t);try{s=new u.MapFile(i);var r=g.MapSupport.check(s,this.strings);if(r)return void await this.messageBoxApi.alert(r,this.strings.get("GUI:Ok"));n=(new b.MapManifest).fromMapFile(i,this.gameModes.getAll())}catch(e){return console.error(e),void await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok"))}if((s.unknownActionTypes.size||s.unknownEventTypes.size)&&!await this.messageBoxApi.confirm(this.strings.get("TS:MapUnsupportedTriggers"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;let a=n.gameModes;a.length?(await this.mapDir.writeFile(i),this.mapList.add(n),e.throwIfCancelled(),this.updateMapsAndModes(),this.form.applyOptions((e=>{e.gameModes=this.availableGameModes,e.maps=this.computeAvailableMaps()})),a.some((e=>this.selectedGameMode.id===e.id))||this.handleSelectGameMode(a[0]),this.handleSelectMap(i.filename,!1)):await this.messageBoxApi.alert(this.strings.get("TS:MapUnsupportedGameMode"),this.strings.get("GUI:Ok"))}else await this.messageBoxApi.alert(this.strings.get("TS:ImportMapUnsupportedType",y.Engine.supportedMapTypes.map((e=>"*."+e)).join(", ")),this.strings.get("GUI:Ok"))}handleMapImportError(e){let t=this.strings,i=t.get("TS:ImportMapError");"QuotaExceededError"===e.name||e instanceof m.StorageQuotaError?i+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof S.NameNotAllowedError?i+="\n\n"+t.get("TS:FileNameError"):e instanceof p.IOError||e instanceof f.FileNotFoundError||this.sentry?.captureException(new Error("Map import failed "+(e.message??e.name),{cause:e})),this.errorHandler.handle(e,i,(()=>{}))}async handleSubmit(){let e=new o.CancellationTokenSource;var t=()=>e.cancel();this.disposables.add(t);try{await this.submitMap(e.token)}catch(e){if(!(e instanceof o.OperationCanceledError))throw e}finally{this.disposables.remove(t)}}async submitMap(e){let t,i=!1;if(this.mapFileUpdateTask){this.form.hide(),this.controller?.hideSidebarButtons(),i=!0;try{await this.mapFileUpdateTask.wait()}catch(e){return}}if(e.throwIfCancelled(),this.changedMapFile)try{var r=new u.MapFile(this.changedMapFile),s=g.MapSupport.check(r,this.strings);if(s)return void await this.messageBoxApi.alert(s,this.strings.get("GUI:Ok"))}catch(e){return console.error(e),void await this.messageBoxApi.alert(this.strings.get("TXT_MAP_ERROR"),this.strings.get("GUI:Ok"))}t=!(this.computeUsedSlots()>this.allMaps.find((e=>e.mapName===this.selectedMapName)).maxSlots)||await this.messageBoxApi.confirm(this.strings.get("GUI:EjectPlayers"),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel")),e.throwIfCancelled(),t?await(this.controller?.popScreen({gameMode:this.selectedGameMode,mapName:this.selectedMapName,changedMapFile:this.changedMapFile})):i&&(this.form.show(),this.controller?.showSidebarButtons())}computeAvailableMaps(){return this.allMaps.filter((e=>e.gameModes.some((e=>e.id===this.selectedGameMode.id))))}refreshMapInfo(){this.controller?.setSidebarMpText(this.strings.get(this.selectedGameMode.label)+"\n\n"+this.allMaps.find((e=>e.mapName===this.selectedMapName))?.mapTitle)}async onLeave(){this.computeUsedSlots=void 0,this.availableGameModes=void 0,this.allMaps=void 0,this.messageBoxApi.destroy(),this.form=void 0,this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=void 0,this.controller.setMainComponent(),this.disposables.dispose(),await this.controller.hideSidebarButtons()}updateMapDeferred({updatePreview:e}){this.mapFileUpdateTask?.cancel(),this.mapFileUpdateTask=new a.Task((async t=>{if(this.controller){let r;e&&this.controller.setSidebarPreview(),this.changedMapFile=void 0;try{r=this.changedMapFile=await this.mapFileLoader.load(this.selectedMapName,t)}catch(e){if(e instanceof v.DownloadError)return void this.errorHandler.handle(e,this.strings.get("TXT_DOWNLOAD_FAILED"),(()=>{this.controller?.popScreen()}));throw e}var i;e&&!t.isCancelled()&&(i=new n.MapPreviewRenderer(this.strings).render(new u.MapFile(r),this.lobbyType,this.controller.getSidebarPreviewSize()),this.controller.setSidebarPreview(i)),this.mapFileUpdateTask=void 0}})),this.mapFileUpdateTask.start().catch((e=>{e instanceof o.OperationCanceledError||(console.error("Failed to render map preview"),console.error(e))}))}},e("MapSelScreen",w)}}})),System.register("gui/screen/mainMenu/newAccount/NewAccountBox",["react"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=({regions:e,initialRegion:t,strings:r,onRegionChange:s,onSubmit:n},a)=>{let[o,l]=i.useState(t.id),c=i.useRef(null),h=i.useRef(null),u=i.useRef(null);return i.useEffect((()=>{setTimeout((()=>c.current?.focus()),50)}),[]),i.useImperativeHandle(a,(()=>({getValues:()=>({user:c.current.value,pass:h.current.value,passMatch:h.current.value===u.current.value,regionId:o})}))),i.default.createElement("div",{className:"login-wrapper new-account-box"},i.default.createElement("div",{className:"title"},r.get("GUI:NewAccount")),i.default.createElement("form",{onSubmit:e=>{e.preventDefault(),n()},className:"login-form login-box"},1<e.length?i.default.createElement("div",{className:"field"},i.default.createElement("label",null,r.get("TS:ServerLabel")),i.default.createElement("select",{name:"server",value:o,onChange:e=>{var t=e.target.value;l(t),s(t)}},e.map((e=>i.default.createElement("option",{value:e.id,key:e.id,disabled:!e.available},e.label))))):i.default.createElement("input",{type:"hidden",name:"server",value:o}),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,r.get("GUI:Nickname")),i.default.createElement("input",{name:"user",type:"text",maxLength:15,ref:c,autoComplete:"off"})),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,r.get("GUI:MinPasswordLen"))),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,r.get("GUI:Password")),i.default.createElement("input",{name:"pass",type:"password",maxLength:8,ref:h,autoComplete:"off"})),i.default.createElement("div",{className:"field"},i.default.createElement("label",null,r.get("GUI:Re-enterPassword")),i.default.createElement("input",{name:"confirmPass",type:"password",maxLength:8,ref:u,autoComplete:"off"})),i.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))},e("NewAccountBox",i.forwardRef(r))}}})),System.register("gui/screen/mainMenu/newAccount/NewAccountScreen",["gui/jsx/jsx","network/WolError","gui/screen/mainMenu/newAccount/NewAccountBox","gui/screen/mainMenu/ScreenType","gui/jsx/HtmlView","@puzzl/core/lib/async/Task","util/time","LocalPrefs","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/MainMenuRoute"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=class extends h.MainMenuScreen{constructor(e,t,i,r,s,n,a,o,l){super(),this.wolService=e,this.wladderService=t,this.strings=i,this.jsxRenderer=r,this.messageBoxApi=s,this.serverRegions=n,this.errorHandler=a,this.localPrefs=o,this.rootController=l,this.title=this.strings.get("GUI:NewAccount"),this.handleSubmit=async e=>{if(!this.isBusy&&this.controller){this.isBusy=!0,await this.controller.hideSidebarButtons();let{user:t,pass:i,passMatch:r,regionId:s}=this.newAccountBox.getValues();r?8===i.length?t.match(/^[A-Za-z0-9-_]+$/)?await this.createAccount(t,i,s,e):this.handleValidationError(this.strings.get("TS:BadNickname")):this.handleValidationError(this.strings.get("TXT_PASSWORD_TOO_SHORT")):this.handleValidationError(this.strings.get("TXT_PASSWORD_VERIFY"))}}}async onEnter(e){var t;this.controller.toggleMainVideo(!1),this.isBusy=!1,(t=(t=this.localPrefs.getItem(c.StorageKey.PreferredServerRegion))&&this.serverRegions.isAvailable(t)?this.serverRegions.get(t):this.serverRegions.getFirstAvailable())?(this.controller.setSidebarButtons([{label:this.strings.get("GUI:Ok"),onClick:()=>this.handleSubmit(e.afterLogin)},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(n.ScreenType.Login,{afterLogin:e.afterLogin})}}]),this.controller.showSidebarButtons(),[t]=this.jsxRenderer.render(i.jsx(a.HtmlView,{width:"100%",height:"100%",component:s.NewAccountBox,props:{ref:e=>this.newAccountBox=e,strings:this.strings,regions:this.serverRegions.getAll(),initialRegion:t,onRegionChange:e=>{this.localPrefs.setItem(c.StorageKey.PreferredServerRegion,e)},onSubmit:()=>this.handleSubmit(e.afterLogin)}})),this.controller.setMainComponent(t)):this.handleWolError("No servers available",this.strings.get("gui:noserversavailable"),{fatal:!0})}async createAccount(e,t,i,s){var n=this.serverRegions.get(i);this.serverRegions.setSelectedRegion(i);let a=new o.Task((async e=>{await l.sleep(1e3),e.isCancelled()||this.messageBoxApi.show(this.strings.get("TXT_CONNECTING"))}));a.start();try{await this.wolService.validateGameVersion(n)}catch(e){let t;return a.cancel(),this.messageBoxApi.destroy(),t=e instanceof r.WolError&&e.code===r.WolError.Code.OutdatedClient?this.strings.get("TS:OutdatedClient"):this.strings.get("TXT_NO_SERV_LIST"),void this.handleWolError(e,t,{fatal:!1})}try{var c=await this.wolService.connectAndLogin({url:n.wolUrl,wolv2Ascii:n.wolv2Ascii,keepAliveInGame:n.wolKeepAliveInGame,user:e,pass:t});this.wladderService.setUrl(n.wladderUrl),a.cancel(),this.messageBoxApi.destroy();var h=s(c);h instanceof u.MainMenuRoute?this.controller?.goToScreen(h.screenType,h.params):this.rootController.goToScreen(h.screenType,h.params)}catch(e){a.cancel(),this.messageBoxApi.destroy(),e instanceof r.WolError&&e.code===r.WolError.Code.BadLogin?(this.wolService.closeWolConnection(),this.handleValidationError(this.strings.get("TXT_LOGIN_USED"))):this.handleWolError(e,this.strings.get("TS:ConnectFailed"),{fatal:!1})}}handleValidationError(e){this.messageBoxApi.show(e,this.strings.get("GUI:Ok"),(()=>{this.isBusy=!1,this.controller?.showSidebarButtons()}))}handleWolError(e,t,{fatal:i}){this.errorHandler.handle(e,t,(()=>{this.isBusy=!1,this.controller&&(this.wolService.closeWolConnection(),i?this.controller.goToScreen(n.ScreenType.Home):this.controller.showSidebarButtons())}))}async onLeave(){this.newAccountBox=void 0,!this.isBusy&&this.controller&&await this.controller.hideSidebarButtons(),this.isBusy=!1}},e("NewAccountScreen",d)}}})),System.register("gui/component/ButtonSelect",["react","classnames"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ButtonSelect",(({initialValue:e,disabled:t,tooltip:s,className:n,onSelect:a,labelStyle:o,children:l})=>{let[c,h]=i.useState((()=>e)),[u,d]=i.useState((()=>e));var g=i.useRef(null);return i.useEffect((()=>{c!==e&&(h(e),d(c))}),[e]),i.useEffect((()=>{d(c)}),[]),i.default.createElement("div",{className:r.default("button-select",{disabled:t},n),"data-r-tooltip":s,ref:g},i.default.Children.map(l,(e=>{if(!e)return null;const t=e.props.value,r=e.props.value;return i.default.createElement("div",{onMouseEnter:()=>!r&&d(t),onMouseLeave:()=>u===t&&d(void 0)},i.default.cloneElement(e,{selected:t===c||t===u,labelStyle:o?.(t),onClick:()=>{var e;h(e=t),d(e),a(e)}}))})))}))}}})),System.register("gui/screen/mainMenu/quickGame/component/QuickGameForm",["gui/component/ButtonSelect","gui/component/ColorSelect","gui/component/CountrySelect","gui/component/Option","react","gui/screen/mainMenu/lobby/component/RankIndicator"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("QuickGameForm",(e=>{let{strings:t,playerProfile:l,unrankedEnabled:c,ranked:h,onRankedChange:u}=e;return a.createElement("div",{className:"qm-form opts"},a.createElement("div",{className:"item"},a.createElement("label",null,a.createElement("span",{className:"label"},t.get("GUI:QuickMatchGameMode")),a.createElement("div",{className:"qm-game-type"},a.createElement(i.ButtonSelect,{initialValue:String(Number(h)),onSelect:e=>{u(Boolean(Number(e)))}},a.createElement(n.Option,{value:"1",label:t.get("GUI:Ranked")}),a.createElement(n.Option,{value:"0",disabled:!c,label:t.get("GUI:Unranked")})),a.createElement(i.ButtonSelect,{initialValue:"0",onSelect:()=>{}},a.createElement(n.Option,{value:"0",label:"1v1"}),a.createElement(n.Option,{value:"1",disabled:!0,label:"2v2"}),a.createElement(n.Option,{value:"2",disabled:!0,label:"3v3"}),a.createElement(n.Option,{value:"3",disabled:!0,label:"4v4"}),a.createElement(n.Option,{value:"4",disabled:!0,label:"FFA"}))))),a.createElement("div",{className:"item"},a.createElement("label",null,a.createElement("span",{className:"label"},t.get("GUI:PreferredCountry")),a.createElement(s.CountrySelect,{countryUiNames:e.countryUiNames,countryUiTooltips:e.countryUiTooltips,country:e.country,availableCountries:e.availableCountries,disabled:!1,strings:e.strings,onSelect:t=>e.onCountrySelect(t)}))),a.createElement("div",{className:"item"},a.createElement("label",null,a.createElement("span",{className:"label"},t.get("GUI:PreferredColor")),a.createElement(r.ColorSelect,{color:e.color,availableColors:e.availableColors,disabled:!1,strings:e.strings,onSelect:t=>e.onColorSelect(t)}))),a.createElement("fieldset",{className:"qm-profile"},a.createElement("legend",null,t.get("GUI:UserProfileLabel",l.name)),a.createElement("div",{className:"item"},a.createElement("span",{className:"label"},t.get("GUI:LadderWins")),a.createElement("span",{className:"value"},l.wins??t.get("GUI:UnknownStats"))),a.createElement("div",{className:"item"},a.createElement("span",{className:"label"},t.get("GUI:LadderLosses")),a.createElement("span",{className:"value"},l.losses??t.get("GUI:UnknownStats"))),a.createElement("div",{className:"item"},a.createElement("span",{className:"label"},t.get("GUI:Disconnects")),a.createElement("span",{className:"value"},l.disconnects??t.get("GUI:UnknownStats"))),a.createElement("div",{className:"item"},a.createElement("span",{className:"label"},t.get("GUI:LadderRank")),a.createElement("span",{className:"value"},l.rank??t.get("GUI:UnknownStats"),l?a.createElement(o.RankIndicator,{playerProfile:l,strings:t}):void 0)),a.createElement("div",{className:"item"},a.createElement("span",{className:"label"},t.get("GUI:LadderPoints")),a.createElement("span",{className:"value"},l.points??t.get("GUI:UnknownStats")))))}))}}})),System.register("gui/screen/mainMenu/quickGame/QuickGameScreen",["@puzzl/core/lib/async/Task","gui/jsx/jsx","gui/jsx/HtmlView","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","engine/MapDigest","util/time","network/gameopt/Parser","game/gameopts/constants","engine/sound/SoundKey","engine/sound/ChannelType","gui/screen/mainMenu/MainMenuRoute","util/math","network/gameopt/Serializer","gui/screen/mainMenu/quickGame/component/QuickGameForm","LocalPrefs"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e}],execute:function(){var t;(t=b=b||{})[t.None=0]="None",t[t.Initializing=1]="Initializing",t[t.WaitingForMatch=2]="WaitingForMatch",t[t.MatchFound=3]="MatchFound",t[t.WaitingForPlayers=4]="WaitingForPlayers",t[t.WaitingForAllReady=5]="WaitingForAllReady",t[t.WaitingForStartTimer=6]="WaitingForStartTimer",t[t.WaitingForGameStart=7]="WaitingForGameStart",S=class extends a.MainMenuScreen{constructor(e,t,i,r,s,a,c,d,g,p,y,T,v,S,w,C){super(),this.unrankedEnabled=e,this.engineModHash=t,this.rules=i,this.wolService=r,this.wolCon=s,this.wladderService=a,this.serverRegions=c,this.mapFileLoader=d,this.mapList=g,this.rootController=p,this.messageBoxApi=y,this.jsxRenderer=T,this.strings=v,this.localPrefs=S,this.sound=w,this.errorHandler=C,this.title=this.strings.get("GUI:WolMatch"),this.musicType=n.MusicType.NormalShuffle,this.disposables=new l.CompositeDisposable,this.handleChatMessage=e=>{if(this.queueState!==b.None&&e.from===this.wolConfig.getQuickMatchBotName())if("Working"===e.text)this.queueState===b.Initializing?this.updateQueueState(b.WaitingForMatch):console.warn(`Unexpected reply "${e.text}" from match bot (qs: ${b[this.queueState]})`);else if(e.text.startsWith("Start"))this.queueState===b.WaitingForMatch?(this.updateQueueState(b.MatchFound),i=e.text.replace(/^Start /,""),this.handleBotStartMsg(i).catch((e=>this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!0})))):console.warn(`Unexpected reply "${e.text}" from match bot (qs: ${b[this.queueState]})`);else if(e.text.startsWith("Stats")&&this.queueState===b.WaitingForMatch){let r=e.text.replace(/^Stats /,"");var[t,i]=r.split(","),t=Number(t),i="-1"!==i?Number(i):void 0;this.messageBoxApi.updateText(this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type)+"\n\n\n"+this.strings.get("WOL:MatchPlayersInQueue",t)+"\n"+this.strings.get("WOL:MatchAvgWaitTime")+(void 0!==i&&i<3600?this.strings.get("WOL:MatchAvgWaitTimeMinutes",i<60?"<1":"~"+Math.ceil(i/60)):this.strings.get("WOL:MatchAvgWaitTimeUnavail")))}},this.handleJoinChannel=e=>{if(this.isHost&&e.user.name!==this.wolCon.getCurrentUser()){if([b.WaitingForPlayers,b.WaitingForAllReady,b.WaitingForStartTimer,b.WaitingForGameStart].includes(this.queueState)){if(e.channel!==this.gameChannelName)return;if(!this.gameOpts)throw new Error("Game opts should be set by now");if(!this.gameOpts.humanPlayers.find((t=>t.name===e.user.name)))return void this.wolCon.kick([e.user.name],this.gameChannelName,"User does not belong to this game")}this.queueState===b.WaitingForPlayers&&(this.sendGameOpts(),this.updateQueueState(b.WaitingForAllReady))}},this.handleLeaveChannel=async e=>{if(e.user.name===this.wolCon.getCurrentUser())return e.channel!==this.gameChannelName&&e.channel!==this.quickMatchChannelName?void 0:void(this.queueState!==b.MatchFound&&(this.updateQueueState(b.None),[b.Initializing,b.WaitingForMatch].includes(this.queueState)&&this.wolCon.close()));switch(this.queueState){case b.Initializing:case b.WaitingForMatch:break;case b.WaitingForAllReady:case b.WaitingForStartTimer:case b.WaitingForGameStart:if(e.channel!==this.gameChannelName)return;if(!this.gameOpts)throw new Error("Game opts should be set by now");if(!this.gameOpts.humanPlayers.find((t=>t.name===e.user.name)))return;console.log("A player left. Requeuing..."),await this.leaveQueue(),this.wolCon.isOpen()&&await this.joinQueue()}},this.handleGameOpt=async e=>{let t=e.opt[0];if(this.isHost)"A"===t&&"1"===e.opt[1]&&this.queueState===b.WaitingForAllReady&&this.updateQueueState(b.WaitingForStartTimer);else if(this.queueState===b.MatchFound){for(;!this.wolCon.isInChannel(this.gameChannelName);)if(await h.sleep(100),this.queueState!==b.MatchFound||!this.wolCon.isOpen())return;if(t.match(/^-|\d+/)){var i=e.opt;i=(new u.Parser).parseOptions(i);if(!this.gameOpts)throw new Error("Game opts should be set by now");if(i.mapDigest!==this.gameOpts.mapDigest)return this.wolService.closeWolConnection(),this.updateQueueState(b.None),void this.messageBoxApi.show(this.strings.get("GUI:JoinerNoMap",i.mapName),[{label:this.strings.get("GUI:OK"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(o.ScreenType.Home)}}]);this.wolCon.sendPlayerReady(!0),this.updateQueueState(b.WaitingForStartTimer)}}},this.handleGameStart=async e=>{if(this.queueState===b.WaitingForGameStart||this.queueState===b.WaitingForStartTimer)try{var t=this.wolCon.getCurrentUser();if(void 0===t)throw new Error("User should be logged in");var i=this.isTournament;if(void 0===i)throw new Error("Tournament flag should be set by now");var r=this.isHost;if(void 0===r)throw new Error("Host flag should be set by now");this.updateQueueState(b.None),this.wolCon.isOpen()&&this.gameChannelName&&this.wolCon.leaveChannel(this.gameChannelName);var s=new m.MainMenuRoute(o.ScreenType.Login,{afterLogin:e=>new m.MainMenuRoute(o.ScreenType.QuickGame,{forceWolReconnect:!0})});if(r){let r=this.gameOpts;if(!r)throw new Error("Game opts should be set by now");let n=this.rules.getMultiplayerCountries().reduce(((e,t)=>Math.max(t.id,e)),0);r.humanPlayers=r.humanPlayers.map((e=>({...e,countryId:e.countryId>n?f.getRandomInt(0,n-1):e.countryId}))),this.rootController.createGame(e.gameId,e.timestamp,t,r,!1,i,!1,s)}else this.rootController.joinGame(e.gameId,e.timestamp,t,i,!1,s)}catch(r){if(await this.leaveQueue(),!this.wolCon.isOpen())return;this.handleError(r,this.strings.get("WOL:MatchTimeout"),{fatal:!1})}},this.onWolClose=()=>{this.updateQueueState(b.None)},this.onWolConLost=e=>{this.handleError(e,this.strings.get("TXT_YOURE_DISCON"),{fatal:!0})}}async onEnter(e){this.updateQueueState(b.None);var t=this.localPrefs.getItem(v.StorageKey.LastPlayerCountry),r=this.localPrefs.getItem(v.StorageKey.LastPlayerColor);t=void 0!==t&&Number(t)<this.getAvailablePlayerCountries().length?Number(t):d.RANDOM_COUNTRY_ID,r=void 0!==r&&Number(r)<this.getAvailablePlayerColors().length?Number(r):d.RANDOM_COLOR_ID;if(this.queueOpts={type:"1v1",ranked:!0,countryId:t,colorId:r},this.playerProfile={name:this.wolCon.getCurrentUser()??""},this.prevWolV2Ascii=this.wolCon.getWolV2Ascii(),this.wolCon.setWolV2Ascii(!0),this.controller.toggleMainVideo(!1),this.wolService.isConnected()&&this.wolCon.getCurrentUser()){if(!e?.forceWolReconnect||(await this.tryWolReconnect(),this.wolCon.isOpen())){this.wolConfig=this.wolService.getConfig(),this.wolCon.onClose.subscribe(this.onWolClose),this.disposables.add((()=>this.wolCon.onClose.unsubscribe(this.onWolClose))),this.wolService.onWolConnectionLost.subscribe(this.onWolConLost),this.disposables.add((()=>this.wolService.onWolConnectionLost.unsubscribe(this.onWolConLost))),this.wolCon.onChatMessage.subscribe(this.handleChatMessage),this.disposables.add((()=>this.wolCon.onChatMessage.unsubscribe(this.handleChatMessage))),this.wolCon.onLeaveChannel.subscribe(this.handleLeaveChannel),this.disposables.add((()=>this.wolCon.onLeaveChannel.unsubscribe(this.handleLeaveChannel))),this.wolCon.onGameStart.subscribe(this.handleGameStart),this.disposables.add((()=>this.wolCon.onGameStart.unsubscribe(this.handleGameStart))),this.wolCon.onJoinChannel.subscribe(this.handleJoinChannel),this.disposables.add((()=>this.wolCon.onJoinChannel.unsubscribe(this.handleJoinChannel))),this.wolCon.onGameOpt.subscribe(this.handleGameOpt),this.disposables.add((()=>this.wolCon.onGameOpt.unsubscribe(this.handleGameOpt))),this.showDefaultSidebarButtons(),this.initView();let e=new i.Task((e=>this.refreshPlayerProfile(e)));e.start(),this.disposables.add((()=>e.cancel()))}}else this.controller.goToScreen(o.ScreenType.Login,{afterLogin:e=>new m.MainMenuRoute(o.ScreenType.QuickGame,{})})}showDefaultSidebarButtons(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:QuickMatchPlay"),tooltip:this.strings.get("GUI:FindAGame"),onClick:()=>{this.joinQueue()}},...this.wladderService.getUrl()?[{label:this.strings.get("GUI:ViewLadder"),tooltip:this.strings.get("GUI:ViewTourLadder"),onClick:()=>{this.controller?.pushScreen(o.ScreenType.Ladder,{ladderType:this.queueOpts.type,highlightPlayer:this.playerProfile})}}]:[],...this.controller?.hasScreen(o.ScreenType.LadderRules)?[{label:this.strings.get("GUI:ViewRules"),onClick:()=>{this.controller?.pushScreen(o.ScreenType.LadderRules)}}]:[],...1<this.serverRegions.getSize()?[{label:this.strings.get("GUI:ChangeServer"),tooltip:this.strings.get("STT:ChangeServer"),onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(o.ScreenType.Login,{clearCredentials:!0,afterLogin:e=>new m.MainMenuRoute(o.ScreenType.QuickGame,{})})}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.wolService.closeWolConnection(),this.controller?.goToScreen(o.ScreenType.Home)}}]),this.controller.showSidebarButtons()}initView(){var[e]=this.jsxRenderer.render(r.jsx(s.HtmlView,{component:T.QuickGameForm,innerRef:e=>this.form=e,props:{strings:this.strings,countryUiNames:new Map([[d.RANDOM_COUNTRY_NAME,d.RANDOM_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map((e=>[e.name,e.uiName])))),countryUiTooltips:new Map([[d.RANDOM_COUNTRY_NAME,d.RANDOM_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter((e=>e.uiTooltip)).map((e=>[e.name,e.uiTooltip])))),availableColors:[d.RANDOM_COLOR_NAME].concat(this.getAvailablePlayerColors()),availableCountries:[d.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),color:this.getColorNameById(this.queueOpts.colorId),country:this.getCountryNameById(this.queueOpts.countryId),ranked:this.queueOpts.ranked,unrankedEnabled:this.unrankedEnabled&&this.wolConfig.hasUnrankedQuickMatch(),playerProfile:this.playerProfile,onCountrySelect:e=>{var t=this.getCountryIdByName(e);this.queueOpts.countryId=t,this.form?.applyOptions((t=>{t.country=e})),t!==d.RANDOM_COUNTRY_ID?this.localPrefs.setItem(v.StorageKey.LastPlayerCountry,String(t)):this.localPrefs.removeItem(v.StorageKey.LastPlayerCountry)},onColorSelect:e=>{var t=this.getColorIdByName(e);this.queueOpts.colorId=t,this.form?.applyOptions((t=>{t.color=e})),t!==d.RANDOM_COLOR_ID?this.localPrefs.setItem(v.StorageKey.LastPlayerColor,String(t)):this.localPrefs.removeItem(v.StorageKey.LastPlayerColor)},onRankedChange:e=>{this.queueOpts.ranked=e,this.form?.applyOptions((t=>t.ranked=e))}}}));this.controller.setMainComponent(e)}async refreshPlayerProfile(e){if(this.wladderService.getUrl()){var t=this.wolCon.getCurrentUser();if(t)try{var[i]=await this.wladderService.listSearch([t],e);if(e.isCancelled())return;this.playerProfile=i,this.form?.applyOptions((e=>e.playerProfile=this.playerProfile))}catch(e){console.error(e)}}}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map((e=>e.name))}getCountryNameById(e){let t;return t=e===d.RANDOM_COUNTRY_ID?d.RANDOM_COUNTRY_NAME:this.getAvailablePlayerCountries()[e],t}getCountryIdByName(e){let t;if(e===d.RANDOM_COUNTRY_NAME)t=d.RANDOM_COUNTRY_ID;else{t=this.getAvailablePlayerCountries().indexOf(e)}return t}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map((e=>e.asHexString()))}getColorNameById(e){let t;return t=e===d.RANDOM_COLOR_ID?d.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[e],t}getColorIdByName(e){let t;if(e===d.RANDOM_COLOR_NAME)t=d.RANDOM_COLOR_ID;else{if(t=this.getAvailablePlayerColors().indexOf(e),-1===t)throw new Error(`Color ${e} not found in available player colors`)}return t}async joinQueue(){this.isHost=void 0,this.isTournament=void 0,this.gameOpts=void 0,this.quickMatchChannelName=void 0,this.gameChannelName=void 0,this.messageBoxApi.show(this.strings.get("WOL:RequestingMatch")+"...",[{label:this.strings.get("GUI:Cancel"),onClick:()=>{this.leaveQueue()}}]),this.updateQueueState(b.Initializing);try{var e=`#Lob ${this.wolConfig.getQuickMatchChannelId(this.queueOpts.ranked)} 0`;if(await this.wolCon.joinChannel(e,this.wolConfig.getGlobalChannelPass()),this.queueState!==b.Initializing)return;this.quickMatchChannelName=e;var{countryId:t,colorId:i}=this.queueOpts,r=`Match COU=${t}, COL=`+i;this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],r)}catch(e){return void this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!0})}}async leaveQueue(){this.queueState!==b.None&&(this.updateQueueState(b.None),this.messageBoxApi.destroy(),this.wolCon.isOpen()&&await this.tryWolReconnect())}async tryWolReconnect(){try{await this.wolService.forceReconnect(),this.wolCon.setWolV2Ascii(!0)}catch(e){this.wolService.closeWolConnection(),this.handleError(e,this.strings.get("TXT_YOURE_DISCON"),{fatal:!0})}}updateQueueState(e){if(this.queueState=e,this.gameStartTimeoutId&&(clearTimeout(this.gameStartTimeoutId),this.gameStartTimeoutId=void 0),this.countdownIntervalId&&(clearInterval(this.countdownIntervalId),this.countdownIntervalId=void 0),this.updateStatsIntervalId&&(clearInterval(this.updateStatsIntervalId),this.updateStatsIntervalId=void 0),e!==b.None){let t;switch([b.WaitingForAllReady,b.WaitingForGameStart,b.WaitingForPlayers].includes(e)&&(this.gameStartTimeoutId=setTimeout((async()=>{console.log("Timed out. Rejoining queue..."),await this.leaveQueue(),this.wolCon.isOpen()&&this.joinQueue()}),1e4)),e===b.WaitingForStartTimer&&(this.countdownSeconds=10,this.countdownIntervalId=setInterval((()=>this.tickStartTimer()),1e3)),e!==b.WaitingForMatch||this.wolConfig.getWolV2Compat()||(this.updateStatsIntervalId=setInterval((()=>this.requestStats()),5e3)),e){case b.WaitingForMatch:t=this.strings.get("TXT_SEARCHING_FOR",this.queueOpts.type);break;case b.MatchFound:t=this.strings.get("GUI:MatchFound");break;case b.WaitingForPlayers:t=this.strings.get("WOL:MatchWaitingForPlayers")+"...";break;case b.WaitingForStartTimer:t=this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds);break;case b.WaitingForGameStart:t=this.strings.get("WOL:MatchGameStarting");case b.WaitingForAllReady:}void 0!==t&&(this.messageBoxApi.updateText(t),console.log(t))}}async tickStartTimer(){if(void 0===this.countdownSeconds)throw new Error("Game start countdown should be set by now");if(0<this.countdownSeconds)this.countdownSeconds--,this.messageBoxApi.updateText(this.strings.get("WOL:MatchStartSeconds",this.countdownSeconds)),this.sound.play(g.SoundKey.QuickMatchTimer,p.ChannelType.Ui);else{if(this.updateQueueState(b.WaitingForGameStart),void 0===this.isHost)throw new Error("Host should be set by now");if(this.isHost)try{let e=this.gameOpts;if(!e)throw new Error("Game opts should be set by now");this.wolCon.startGame(e.humanPlayers.map((e=>e.name)))}catch(e){return await this.leaveQueue(),this.wolCon.isOpen()?void this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!1}):void 0}}}requestStats(){this.queueState===b.WaitingForMatch&&this.wolCon.privmsg([this.wolConfig.getQuickMatchBotName()],"Stats")}async handleBotStartMsg(e){if(this.queueState===b.MatchFound){if(!this.quickMatchChannelName)throw new Error("Quick match channel name should be set by now");this.wolCon.leaveChannel(this.quickMatchChannelName);let a=(new u.Parser).parseOptions(e);var t=a.mapName;let o=a.humanPlayers[0].name;a.aiPlayers.length||(a.aiPlayers=new Array(7).fill(void 0));var i=this.wolCon.getCurrentUser()===o,r=this.queueOpts.ranked;const l=this.mapList.getByName(t);let d;try{if(!l)throw new Error(`Map "${t}" not found`);d=await this.mapFileLoader.load(l.fileName)}catch(e){return void this.handleError(e,this.strings.get("TS:MapNotFound",t),{fatal:!0})}if(this.queueState===b.MatchFound){this.isTournament=r,this.isHost=i,this.gameOpts={...a,gameMode:l.gameModes.some((e=>e.id===a.gameMode))?a.gameMode:l.gameModes[0].id,mapName:l.fileName,mapDigest:c.MapDigest.compute(d),mapSizeBytes:d.getSize(),mapTitle:l.getFullMapTitle(this.strings),maxSlots:l.maxSlots,mapOfficial:l.official},this.sound.play(g.SoundKey.PlayerJoined,p.ChannelType.Ui);var s=this.wolConfig.getQuickMatchChannelId(r);if(console.log("Matched with: "+(i?a.humanPlayers.slice(1).map((e=>e.name)).join(", "):o)),i){console.log("Creating WOL game..."),this.messageBoxApi.updateText(this.strings.get("WOL:MatchCreatingGame"));try{this.gameChannelName=await this.wolCon.createGame(1,2,s,r)}catch(e){return await this.leaveQueue(),this.wolCon.isOpen()?void this.handleError(e,this.strings.get("WOL:MatchBadParameters"),{fatal:!1}):void 0}this.queueState===b.MatchFound&&(this.wolCon.sendGameTopic(1,2,0,0,!1,t,this.engineModHash,""),this.updateQueueState(b.WaitingForPlayers))}else{console.log(`Looking for game hosted by "${o}"...`),this.messageBoxApi.updateText(this.strings.get("WOL:MatchJoiningGame"));try{let e=3;for(;0<e--;){let t=await this.wolCon.listGames(this.wolConfig.getClientChannelType(),s);if(this.queueState!==b.MatchFound)return;var n=t.find((e=>e.hostName===o));if(n){if(this.engineModHash!==n.modHash)return this.leaveQueue(),void this.messageBoxApi.show(this.strings.get("TXT_MISMATCH"),[{label:this.strings.get("GUI:OK"),onClick:()=>{this.wolCon.isOpen()&&this.joinQueue()}}]);if(console.log(`Joining game channel "${n.name}"...`),await this.wolCon.joinGame(n.name),this.gameChannelName=n.name,this.queueState!==b.MatchFound)return;break}if(console.log("Game not found. Retries left = "+e),await h.sleep(3e3),this.queueState!==b.MatchFound)return}if(-1===e)return await this.leaveQueue(),this.wolCon.isOpen()?void await this.joinQueue():void 0}catch(e){return await this.leaveQueue(),this.wolCon.isOpen()?void this.handleError(e,this.strings.get("WOL:MatchErrorJoiningGame"),{fatal:!1}):void 0}}}}}sendGameOpts(){if(!this.isHost)throw new Error("Only host can send game opts");if(!this.gameOpts)throw new Error("Game opts should be set by now");var e=(new y.Serializer).serializeOptions(this.gameOpts);this.wolCon.sendGameOpts(e)}async onUnstack(){this.showDefaultSidebarButtons(),this.initView()}async onStack(){await this.unrender()}async onLeave(){this.updateQueueState(b.None),this.messageBoxApi.destroy(),this.gameOpts=void 0,this.wolCon.setWolV2Ascii(this.prevWolV2Ascii),this.disposables.dispose(),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.form=void 0}handleError(e,t,{fatal:i}){this.updateQueueState(b.None),this.errorHandler.handle(e,t,(()=>{i&&(this.wolService.closeWolConnection(),this.controller?.goToScreen(o.ScreenType.Home))}))}},e("QuickGameScreen",S)}}})),System.register("gui/screen/mainMenu/score/ScoreTable",["game/gameopts/constants","gui/component/CountryIcon","react","util/format","gui/screen/mainMenu/lobby/component/RankIndicator"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){e("ScoreTable",(({game:e,playerProfiles:t,strings:o})=>{const l=e.getNonNeutralPlayers().filter((e=>!e.isObserver||e.defeated)).sort(((e,t)=>t.score-e.score));return s.default.createElement("div",{className:"score-wrapper"},s.default.createElement("div",{className:"score-header"},s.default.createElement("div",{"data-r-tooltip":o.get("STT:MPScoreLabelGame")},o.get("TXT_GAME",e.id)),s.default.createElement("div",{"data-r-tooltip":o.get("STT:MPScoreLabelMapName")},o.get("TXT_MAP",e.gameOpts.mapTitle)),s.default.createElement("div",{"data-r-tooltip":o.get("STT:MPScoreLabelTime")},o.get("GUI:Time"),": ",n.formatTimeDuration(Math.floor(e.currentTime/1e3)))),s.default.createElement("table",null,s.default.createElement("thead",null,s.default.createElement("tr",null,s.default.createElement("th",null),s.default.createElement("th",{className:"player-rank"}),s.default.createElement("th",{className:"player-name","data-r-tooltip":o.get("STT:MPScoreLabelPlayer")},o.get("GUI:Player")),s.default.createElement("th",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelKills")},o.get("GUI:Kills")),s.default.createElement("th",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelLosses")},o.get("GUI:Losses")),s.default.createElement("th",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelBuilt")},o.get("GUI:Built")),s.default.createElement("th",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelScore")},o.get("GUI:Score")))),s.default.createElement("tbody",null,l.map(((e,n)=>s.default.createElement("tr",{key:n,style:{color:e.color.asHexString()}},s.default.createElement("td",null,s.default.createElement(r.CountryIcon,{country:e.country.name})),s.default.createElement("td",{className:"player-rank"},(()=>{var i=t?.find((t=>t.name===e.name));return i&&s.default.createElement(a.RankIndicator,{playerProfile:i,strings:o})})()),s.default.createElement("td",{className:"player-name","data-r-tooltip":o.get("STT:MPScoreLabelPlayer")},e.isAi?o.get(i.aiUiNames.get(e.aiDifficulty)):e.name),s.default.createElement("td",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelKills")},e.getUnitsKilled()),s.default.createElement("td",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelLosses")},e.getUnitsLost()),s.default.createElement("td",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelBuilt")},e.getUnitsBuilt()),s.default.createElement("td",{className:"number","data-r-tooltip":o.get("STT:MPScoreLabelScore")},e.score)))))))}))}}})),System.register("gui/screen/mainMenu/score/ScoreScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/score/ScoreTable","game/SideType","engine/sound/Music","gui/screen/mainMenu/MainMenuScreen","LocalPrefs","@puzzl/core/lib/async/Task","@puzzl/core/lib/async/cancellation/OperationCanceledError"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){u=new Map([[n.SideType.GDI,{img:"mpascrnl.shp",pal:"mpascrn.pal"}],[n.SideType.Nod,{img:"mpsscrnl.shp",pal:"mpsscrn.pal"}]]),d=class extends o.MainMenuScreen{constructor(e,t,i,r,s,n){super(),this.strings=e,this.jsxRenderer=t,this.messageBoxApi=i,this.localPrefs=r,this.config=s,this.wladderService=n,this.musicType=a.MusicType.Score}async onEnter(e){this.title=e.singlePlayer?this.strings.get("GUI:SkirmishScore"):this.strings.get("GUI:MultiplayerScore"),this.controller.toggleMainVideo(!1),this.initView(e.game,e.localPlayer,e.returnTo),e.singlePlayer||this.refreshPlayerRanks(e.game)}initView(e,t,a){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Continue"),tooltip:this.strings.get("STT:MPScoreButtonContinue"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(a.screenType,a.params)}}]),this.controller.showSidebarButtons();var o,l=t.country?.side??n.SideType.GDI;if(!(o=u.get(l)))throw new Error("Unsupported sideType "+l);var[o]=this.jsxRenderer.render(i.jsx("container",{width:"100%",height:"100%"},i.jsx("sprite",{image:o.img,palette:o.pal}),i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.ScoreTable,innerRef:e=>this.scoreTable=e,props:{game:e,strings:this.strings}})));this.controller.setMainComponent(o)}refreshPlayerRanks(e){if(this.wladderService.getUrl()){this.ranksUpdateTask?.cancel();let t=this.ranksUpdateTask=new c.Task((async t=>{var i=e.getNonNeutralPlayers().filter((e=>(!e.isObserver||e.defeated)&&!e.isAi)).map((e=>e.name));if(i.length){let e=await this.wladderService.listSearch(i,t);t.isCancelled()||this.scoreTable.applyOptions((t=>t.playerProfiles=e))}}));t.start().catch((e=>{e instanceof h.OperationCanceledError||console.error(e)}))}}async onLeave(){this.ranksUpdateTask&&(this.ranksUpdateTask.cancel(),this.ranksUpdateTask=void 0),await this.controller.hideSidebarButtons();var e,t,i=this.config.donateUrl;i&&(2<=(t=Number(this.localPrefs.getItem(l.StorageKey.DonateBoxState)??"0"))?((e=await this.messageBoxApi.confirm(this.strings.get("TS:DonatePrompt"),this.strings.get("TS:DonateNow"),this.strings.get("TS:DonateLater")))&&window.open(i,"_blank"),this.localPrefs.setItem(l.StorageKey.DonateBoxState,"-"+Date.now()),window.gtag?.("event","donate_dismiss",{donate:e})):0<=t?this.localPrefs.setItem(l.StorageKey.DonateBoxState,String(t+1)):(t=-t,2592e6<Date.now()-t&&this.localPrefs.setItem(l.StorageKey.DonateBoxState,"0")))}},e("ScoreScreen",d)}}})),System.register("gui/screen/mainMenu/ScreenParamsMap",["gui/screen/mainMenu/ScreenType"],(function(e,t){"use strict";return t&&t.id,{setters:[function(e){}],execute:function(){}}})),System.register("gui/screen/mainMenu/MainMenuRoute",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("MainMenuRoute",class{constructor(...e){var[t,i]=e;this.screenType=t,this.params=i}})}}})),System.register("gui/screen/RootController",["gui/screen/Controller","gui/screen/ScreenType"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=class extends i.Controller{constructor(e){super(),this.serverRegions=e}async goToScreenBlocking(...e){var[t,i]=e;return super.goToScreenBlocking(t,i)}goToScreen(...e){var[t,i]=e;return super.goToScreen(t,i)}async pushScreen(...e){var[t,i]=e;return super.pushScreen(t,i)}createGame(e,t,i,s,n,a,o=!1,l){if(!this.serverRegions)throw new Error("Server regions must be loaded first");this.goToScreen(r.ScreenType.Game,{create:!0,gameId:Number(e+""+String(t).substr(-3)),timestamp:t,playerName:i,gameOpts:s,singlePlayer:n,tournament:a,mapTransfer:o,gservUrl:n?"":this.serverRegions.getSelectedRegion().gservUrl,wgameresUrl:n?"":this.serverRegions.getSelectedRegion().wgameresUrl,returnTo:l})}joinGame(e,t,i,s,n=!1,a){if(!this.serverRegions)throw new Error("Server regions must be loaded first");this.goToScreen(r.ScreenType.Game,{create:!1,gameId:Number(e+""+String(t).substr(-3)),timestamp:t,playerName:i,tournament:s,mapTransfer:n,gservUrl:this.serverRegions.getSelectedRegion().gservUrl,wgameresUrl:this.serverRegions.getSelectedRegion().wgameresUrl,returnTo:a})}},e("RootController",s)}}})),System.register("gui/replay/ReplayStorageMemStorage",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){e("ReplayStorageMemStorage",class{constructor(){this.replays=new Map}async getManifest(){return this.manifest?JSON.parse(this.manifest):[]}async saveManifest(e){this.manifest=JSON.stringify(e)}async getReplayData(e){var t=this.replays.get(e.id);if(!t)throw new Error(`Replay "${e.id}" not found in memory`);return t}async hasReplayData(e){return this.replays.has(e.id)}async saveReplayData(e,t){this.replays.set(e.id,t)}async deleteReplayData(e){this.replays.delete(e.id)}})}}})),System.register("gui/screen/mainMenu/main/HomeScreen",["gui/screen/mainMenu/ScreenType","gui/FullScreen","engine/sound/Music","gui/screen/options/component/getHumanReadableKey","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/MainMenuRoute"],(function(e,t){"use strict";var i,r,s,n,a,o,l;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){l=class extends a.MainMenuScreen{constructor(e,t,i,r,n){super(),this.strings=e,this.fullScreen=t,this.appVersion=i,this.storageEnabled=r,this.quickMatchEnabled=n,this.title=this.strings.get("GUI:MainMenu"),this.musicType=s.MusicType.Intro}onEnter(){let e=this.strings;this.controller.setSidebarButtons([{label:e.get("GUI:QuickMatch"),tooltip:e.get("STT:WOLWelcomeQuickMatch"),disabled:!this.quickMatchEnabled,onClick:()=>{this.controller?.goToScreen(i.ScreenType.Login,{afterLogin:e=>new o.MainMenuRoute(i.ScreenType.QuickGame,{})})}},{label:e.get("GUI:CustomMatch"),tooltip:e.get("STT:WOLWelcomeCustomMatch"),onClick:()=>{this.controller?.goToScreen(i.ScreenType.Login,{afterLogin:e=>new o.MainMenuRoute(i.ScreenType.CustomGame,{messages:e})})}},{label:e.get("GUI:Demo"),tooltip:e.get("STT:Demo"),onClick:()=>{this.controller?.goToScreen(i.ScreenType.Skirmish)}},{label:e.get("GUI:Replays"),tooltip:e.get("STT:Replays"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.ReplaySelection)}},...this.storageEnabled?[{label:e.get("GUI:Mods"),tooltip:e.get("STT:Mods"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.ModSelection)}}]:[],{label:e.get("TS:InfoAndCredits"),tooltip:e.get("STT:InfoAndCredits"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.InfoAndCredits)}},{label:e.get("GUI:Options"),tooltip:e.get("STT:MainButtonOptions"),onClick:()=>{this.controller?.pushScreen(i.ScreenType.Options)}},{label:e.get("GUI:Fullscreen",n.getHumanReadableKey(r.FullScreen.hotKey)),tooltip:e.get("STT:Fullscreen"),isBottom:!0,onClick:()=>this.fullScreen.toggle()}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.showVersion(this.appVersion)}async onLeave(){this.controller.hideVersion(),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("HomeScreen",l)}}})),System.register("gui/screen/mainMenu/lobby/SkirmishScreen",["@puzzl/core/lib/async/Task","network/gameopt/SlotInfo","game/gameopts/GameOpts","game/gameopts/constants","gui/screen/mainMenu/lobby/component/LobbyForm","gui/screen/mainMenu/lobby/component/viewmodel/lobby","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","gui/jsx/jsx","gui/jsx/HtmlView","engine/ResourceLoader","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/lobby/MapPreviewRenderer","util/array","LocalPrefs","util/typeGuard","gui/screen/mainMenu/lobby/PreferredHostOpts","gui/screen/mainMenu/MainMenuScreen","data/MapFile","engine/MapDigest","gui/screen/mainMenu/MainMenuRoute","engine/sound/Music"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){E=class extends v.MainMenuScreen{constructor(e,t,i,r,s,n,a,o,l,h,u){super(),this.botsEnabled=e,this.rootController=t,this.errorHandler=i,this.messageBoxApi=r,this.strings=s,this.rules=n,this.jsxRenderer=a,this.mapFileLoader=o,this.mapList=l,this.gameModes=h,this.localPrefs=u,this.title=this.strings.get("GUI:SkirmishGame"),this.musicType=C.MusicType.Intro,this.playerName="Player 1",this.disposables=new c.CompositeDisposable}onEnter(){this.controller.toggleMainVideo(!1),this.lobbyForm=void 0,this.initFormModel(),this.createGame()}async createGame(){try{await this.initOptions()}catch(e){return void this.handleError(e,e instanceof d.DownloadError?this.strings.get("TXT_DOWNLOAD_FAILED"):this.strings.get("WOL:MatchErrorCreatingGame"))}this.updateMapPreview(),this.updateFormModel(),this.controller.toggleSidebarPreview(!0),this.initView()}onViewportChange(){}onUnstack(e){if(e){let s=e.gameMode.id!==this.gameOpts.gameMode;this.gameOpts.gameMode=e.gameMode.id;let a=this.mapList.getByName(e.mapName),o=e.changedMapFile??this.currentMapFile;this.currentMapFile=o;var t=m.findIndexReverse(this.slotsInfo,(e=>e.type===r.SlotType.Ai||e.type===r.SlotType.Player||e.type===r.SlotType.Open)),i=Math.max(0,t+1-a.maxSlots);for(let e=0;e<i;e++)this.slotsInfo[t-e].type=r.SlotType.Closed,this.gameOpts.aiPlayers[t-e]=void 0;let l=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].forEach((e=>{e&&(e.startPos>a.maxSlots-1&&(e.startPos=n.RANDOM_START_POS),s&&(e.teamId=l.alliesAllowed&&l.mustAlly?0:n.NO_TEAM_ID))})),this.applyGameOption((e=>{e.mapName=a.fileName,e.mapDigest=S.MapDigest.compute(o),e.mapSizeBytes=o.getSize(),e.mapTitle=a.getFullMapTitle(this.strings),e.maxSlots=a.maxSlots,e.mapOfficial=a.official})),this.localPrefs.setItem(f.StorageKey.LastMap,a.fileName),this.localPrefs.setItem(f.StorageKey.LastMode,String(e.gameMode.id))}this.updateMapPreview(),this.initView()}async onStack(){await this.unrender()}initView(){this.initLobbyForm(),this.refreshSidebarButtons(),this.refreshSidebarMpText(),this.controller.showSidebarButtons()}async initOptions(){var e=this.localPrefs.getItem(f.StorageKey.PreferredGameOpts),t=this.localPrefs.getItem(f.StorageKey.LastPlayerCountry),i=this.localPrefs.getItem(f.StorageKey.LastPlayerColor),a=this.localPrefs.getItem(f.StorageKey.LastMap),o=this.localPrefs.getItem(f.StorageKey.LastMode);let l,c=a?this.mapList.getByName(a):void 0,h=c&&o&&this.gameModes.hasId(Number(o))?Number(o):1,u=this.gameModes.getById(h);l=c?.gameModes.find((e=>e.mapFilter===u.mapFilter))?c:(h=1,u=this.gameModes.getById(h),this.mapList.getAll().find((e=>e.gameModes.find((e=>u.mapFilter===e.mapFilter)))));let d=this.currentMapFile=await this.mapFileLoader.load(l.fileName),g=new T.PreferredHostOpts;e?g.unserialize(e):g.applyMpDialogSettings(this.rules.mpDialogSettings),o=u.mpDialogSettings,e=this.botsEnabled?s.AiDifficulty.Medium:s.AiDifficulty.Easy,this.gameOpts={gameMode:h,shortGame:g.shortGame,mcvRepacks:g.mcvRepacks,cratesAppear:g.cratesAppear,superWeapons:g.superWeapons,gameSpeed:g.gameSpeed,credits:g.credits,unitCount:g.unitCount,buildOffAlly:g.buildOffAlly,humanPlayers:[{name:this.playerName,countryId:void 0!==t&&Number(t)<this.getAvailablePlayerCountries().length?Number(t):n.RANDOM_COUNTRY_ID,colorId:void 0!==i&&Number(i)<this.getAvailablePlayerColors().length?Number(i):n.RANDOM_COLOR_ID,startPos:n.RANDOM_START_POS,teamId:o.mustAlly?0:n.NO_TEAM_ID}],aiPlayers:[void 0,{countryId:n.RANDOM_COUNTRY_ID,colorId:n.RANDOM_COLOR_ID,startPos:n.RANDOM_START_POS,teamId:o.mustAlly?3:n.NO_TEAM_ID,difficulty:e},...new Array(7).fill(void 0)],mapName:l.fileName,mapDigest:S.MapDigest.compute(d),mapSizeBytes:d.getSize(),mapTitle:l.getFullMapTitle(this.strings),maxSlots:l.maxSlots,mapOfficial:l.official},this.slotsInfo=[{type:r.SlotType.Player,name:this.playerName},{type:r.SlotType.Ai,difficulty:e}];for(let e=1;e<7;++e)this.slotsInfo.push({type:r.SlotType.Closed})}handleError(e,t){this.errorHandler.handle(e,t,(()=>{this.controller?.goToScreen(l.ScreenType.Home)}))}getAvailablePlayerCountryRules(){return this.rules.getMultiplayerCountries()}getAvailablePlayerCountries(){return this.getAvailablePlayerCountryRules().map((e=>e.name))}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map((e=>e.asHexString()))}getAvailableStartPositions(){return new Array(this.gameOpts?.maxSlots??8).fill(0).map(((e,t)=>t))}getSelectablePlayerColors(){let e=[];this.formModel&&this.formModel.playerSlots.forEach((t=>{t&&e.push(t.color)}));let t=this.getAvailablePlayerColors();return[n.RANDOM_COLOR_NAME].concat(t.filter((t=>t&&-1===e.indexOf(t))))}getSelectableStartPositions(){let e=[];this.formModel&&this.formModel.playerSlots.forEach((t=>{t&&e.push(t.startPos)}));let t=this.getAvailableStartPositions();return[n.RANDOM_START_POS].concat(t.filter((t=>!e.includes(t))))}initFormModel(){var e=this.rules.mpDialogSettings;this.formModel={strings:this.strings,countryUiNames:new Map([[n.RANDOM_COUNTRY_NAME,n.RANDOM_COUNTRY_UI_NAME],[n.OBS_COUNTRY_NAME,n.OBS_COUNTRY_UI_NAME]].concat(this.getAvailablePlayerCountryRules().map((e=>[e.name,e.uiName])))),countryUiTooltips:new Map([[n.RANDOM_COUNTRY_NAME,n.RANDOM_COUNTRY_UI_TOOLTIP],[n.OBS_COUNTRY_NAME,n.OBS_COUNTRY_UI_TOOLTIP]].concat(this.getAvailablePlayerCountryRules().filter((e=>e.uiTooltip)).map((e=>[e.name,e.uiTooltip])))),availablePlayerCountries:[n.RANDOM_COUNTRY_NAME].concat(this.getAvailablePlayerCountries()),availablePlayerColors:this.getSelectablePlayerColors(),availableStartPositions:this.getSelectableStartPositions(),availableAiNames:this.botsEnabled?n.aiUiNames:new Map([...n.aiUiNames.entries()].filter((([e])=>e!==s.AiDifficulty.Medium))),lobbyType:o.LobbyType.Singleplayer,mpDialogSettings:e,onCountrySelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(e),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel()},onColorSelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(e),this.formModel.playerSlots[t].startPos,this.formModel.playerSlots[t].team,t),this.updateFormModel()},onStartPosSelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),e,this.formModel.playerSlots[t].team,t)},onTeamSelect:(e,t)=>{this.updatePlayerInfo(this.getCountryIdByName(this.formModel.playerSlots[t].country),this.getColorIdByName(this.formModel.playerSlots[t].color),this.formModel.playerSlots[t].startPos,e,t)},onSlotChange:(e,t,i)=>{this.changeSlotType(e,t,i)},onToggleShortGame:e=>this.applyGameOption((t=>t.shortGame=e)),onToggleMcvRepacks:e=>this.applyGameOption((t=>t.mcvRepacks=e)),onToggleCratesAppear:e=>this.applyGameOption((t=>t.cratesAppear=e)),onToggleSuperWeapons:e=>this.applyGameOption((t=>t.superWeapons=e)),onToggleBuildOffAlly:e=>this.applyGameOption((t=>t.buildOffAlly=e)),onChangeGameSpeed:e=>this.applyGameOption((t=>t.gameSpeed=e)),onChangeCredits:e=>this.applyGameOption((t=>t.credits=e)),onChangeUnitCount:e=>this.applyGameOption((t=>t.unitCount=e)),activeSlotIndex:0,teamsAllowed:!0,teamsRequired:!1,playerSlots:[],shortGame:!0,mcvRepacks:!0,cratesAppear:!0,superWeapons:!0,buildOffAlly:!0,gameSpeed:6,credits:e.money,unitCount:e.unitCount}}applyGameOption(e){e(this.gameOpts),this.updateFormModel(),this.localPrefs.setItem(f.StorageKey.PreferredGameOpts,(new T.PreferredHostOpts).applyGameOpts(this.gameOpts).serialize())}changeSlotType(e,t,i){if(0===t)throw new Error("Change slot type of host");if(e===o.SlotOccupation.Occupied&&void 0!==i){var s=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;let e=this.slotsInfo[t];e.type=r.SlotType.Ai,e.difficulty=i,this.gameOpts.aiPlayers[t]={difficulty:i,countryId:n.RANDOM_COUNTRY_ID,colorId:n.RANDOM_COLOR_ID,startPos:n.RANDOM_START_POS,teamId:s.mustAlly?3:n.NO_TEAM_ID}}e===o.SlotOccupation.Closed&&(this.slotsInfo[t].type=r.SlotType.Closed,this.gameOpts.aiPlayers[t]=void 0),this.updateFormModel()}getCountryNameById(e){let t;return t=e===n.RANDOM_COUNTRY_ID?n.RANDOM_COUNTRY_NAME:e===n.OBS_COUNTRY_ID?n.OBS_COUNTRY_NAME:this.getAvailablePlayerCountries()[e],t}getCountryIdByName(e){let t;if(e===n.RANDOM_COUNTRY_NAME)t=n.RANDOM_COUNTRY_ID;else if(e===n.OBS_COUNTRY_NAME)t=n.OBS_COUNTRY_ID;else{t=this.getAvailablePlayerCountries().indexOf(e)}return t}getColorNameById(e){let t;return t=e===n.RANDOM_COLOR_ID?n.RANDOM_COLOR_NAME:this.getAvailablePlayerColors()[e],t}getColorIdByName(e){let t;if(e===n.RANDOM_COLOR_NAME)t=n.RANDOM_COLOR_ID;else{if(t=this.getAvailablePlayerColors().indexOf(e),-1===t)throw new Error(`Color ${e} not found in available player colors`)}return t}updatePlayerInfo(e,t,i,s,a){const o=this.slotsInfo[a];if(o.type===r.SlotType.Ai){let r=this.gameOpts.aiPlayers[a];if(!r)throw new Error("No AI found on slot "+a);r.countryId=e,r.colorId=t,r.startPos=i,r.teamId=s}else{if(o.type!==r.SlotType.Player)throw new Error("Unexpected slot type "+o.type);{let r=this.gameOpts.humanPlayers.find((e=>e.name===o.name));if(!r)throw new Error("No player found on slot "+a);r.countryId=e,r.colorId=t,r.startPos=i,r.teamId=s,e!==n.RANDOM_COUNTRY_ID?this.localPrefs.setItem(f.StorageKey.LastPlayerCountry,String(e)):this.localPrefs.removeItem(f.StorageKey.LastPlayerCountry),t!==n.RANDOM_COLOR_ID?this.localPrefs.setItem(f.StorageKey.LastPlayerColor,String(t)):this.localPrefs.removeItem(f.StorageKey.LastPlayerColor)}}this.updateFormModel()}updateFormModel(){var e=this.gameOpts;if(e&&(this.formModel.gameSpeed=e.gameSpeed,this.formModel.credits=e.credits,this.formModel.unitCount=e.unitCount,this.formModel.shortGame=e.shortGame,this.formModel.superWeapons=e.superWeapons,this.formModel.buildOffAlly=e.buildOffAlly,this.formModel.mcvRepacks=e.mcvRepacks,this.formModel.cratesAppear=e.cratesAppear),this.gameOpts&&this.slotsInfo){let t=e.maxSlots;this.slotsInfo.forEach(((e,i)=>{t?(t--,this.formModel.playerSlots[i]={country:n.RANDOM_COUNTRY_NAME,color:n.RANDOM_COLOR_NAME,startPos:n.RANDOM_START_POS,team:n.NO_TEAM_ID}):this.formModel.playerSlots[i]=void 0})),this.slotsInfo.forEach(((e,t)=>{if(this.formModel.playerSlots[t]){let i=this.formModel.playerSlots[t];e.type===r.SlotType.Closed?i.occupation=o.SlotOccupation.Closed:e.type===r.SlotType.Open||e.type===r.SlotType.OpenObserver?i.occupation=o.SlotOccupation.Open:i.occupation=o.SlotOccupation.Occupied,e.type===r.SlotType.Ai?(i.aiDifficulty=e.difficulty,i.type=o.SlotType.Ai):e.type===r.SlotType.Player&&(i.name=e.name,i.type=o.SlotType.Player),i.status=o.PlayerStatus.NotReady}}))}let t=this.gameOpts?this.gameOpts.humanPlayers:[],i=this.gameOpts?this.gameOpts.aiPlayers:[],s=this.gameModes.getById(this.gameOpts.gameMode).mpDialogSettings;this.formModel.playerSlots.forEach(((e,r)=>{var a;e&&t.length&&(e.occupation===o.SlotOccupation.Occupied?((a=t.find((t=>t.name===e.name)))||(a=i[r]))&&(e.country=this.getCountryNameById(a.countryId),e.color=this.getColorNameById(a.colorId),e.startPos=a.startPos,e.team=a.teamId):(e.country=n.RANDOM_COUNTRY_NAME,e.team=s.mustAlly?3:n.NO_TEAM_ID))})),this.formModel.availablePlayerColors=this.getSelectablePlayerColors(),this.formModel.availableStartPositions=this.getSelectableStartPositions(),this.gameOpts&&(this.formModel.teamsAllowed=this.gameModes.getById(e.gameMode).mpDialogSettings.alliesAllowed,this.formModel.teamsRequired=this.gameModes.getById(e.gameMode).mpDialogSettings.mustAlly),this.lobbyForm&&t.length&&this.lobbyForm.refresh()}updateMapPreview(){this.mapTask?.cancel(),this.mapTask=new i.Task((async e=>{if(this.controller){let i;this.controller.setSidebarPreview();try{i=new b.MapFile(await this.mapFileLoader.load(this.gameOpts.mapName,e))}catch(e){if(e instanceof d.DownloadError)return void this.handleError(e,this.strings.get("TXT_DOWNLOAD_FAILED"));throw e}var t=new p.MapPreviewRenderer(this.strings).render(i,o.LobbyType.Singleplayer,this.controller.getSidebarPreviewSize());this.controller.setSidebarPreview(t)}})),this.mapTask.start().catch((e=>{e instanceof g.OperationCanceledError||(console.error("Failed to render map preview"),console.error(e))})),this.disposables.add((()=>this.mapTask?.cancel()),(()=>this.mapTask=void 0))}initLobbyForm(){var[e]=this.jsxRenderer.render(h.jsx(u.HtmlView,{innerRef:e=>this.lobbyForm=e,component:a.LobbyForm,props:this.formModel}));this.controller.setMainComponent(e)}refreshSidebarButtons(){let e=this.strings;var t=[{label:e.get("GUI:StartGame"),tooltip:e.get("STT:SkirmishButtonStartGame"),disabled:!1,onClick:()=>{this.gameOpts.aiPlayers.filter(y.isNotNullOrUndefined).length<1?this.messageBoxApi.show(this.strings.get("TXT_NEED_AT_LEAST_TWO_PLAYERS"),this.strings.get("GUI:Ok")):this.meetsMinimumTeams()?this.rootController.createGame(0,Date.now(),this.playerName,this.gameOpts,!0,!1,!1,new w.MainMenuRoute(l.ScreenType.Skirmish)):this.messageBoxApi.show(this.strings.get("TXT_CANNOT_ALLY"),this.strings.get("GUI:Ok"))}},{label:e.get("GUI:ChooseMap"),tooltip:e.get("STT:SkirmishButtonChooseMap"),onClick:()=>{this.controller?.pushScreen(l.ScreenType.MapSelection,{lobbyType:o.LobbyType.Singleplayer,gameOpts:this.gameOpts,usedSlots:()=>1+m.findIndexReverse(this.slotsInfo,(e=>e.type===r.SlotType.Ai||e.type===r.SlotType.Player))})}},{label:e.get("GUI:Back"),tooltip:e.get("STT:SkirmishButtonBack"),isBottom:!0,onClick:()=>{this.controller?.goToScreen(l.ScreenType.Home)}}];this.controller.setSidebarButtons(t,!0),this.refreshSidebarMpText()}meetsMinimumTeams(){let e=[...this.gameOpts.humanPlayers,...this.gameOpts.aiPlayers].filter(y.isNotNullOrUndefined).filter((e=>e.countryId!==n.OBS_COUNTRY_ID)),t=e[0].teamId;return t===n.NO_TEAM_ID||e.some((e=>e.teamId!==t))}refreshSidebarMpText(){this.controller?.setSidebarMpText(this.gameOpts?this.strings.get(this.gameModes.getById(this.gameOpts.gameMode).label)+"\n\n"+this.gameOpts.mapTitle:"")}async onLeave(){this.disposables.dispose(),this.gameOpts=void 0,this.slotsInfo=void 0,this.currentMapFile=void 0,this.controller.toggleSidebarPreview(!1),await this.unrender()}async unrender(){await this.controller.hideSidebarButtons(),this.lobbyForm&&(this.lobbyForm=void 0)}},e("SkirmishScreen",E)}}})),System.register("gui/screen/replay/StorageWarning",["react"],(function(e,t){"use strict";var i;function r(e){return Math.ceil(e/1024/1024)}return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("StorageWarning",(({strings:e})=>{const[t,s]=i.useState();return i.useEffect((()=>{navigator.storage?.estimate&&navigator.storage.estimate().then((e=>s(e))).catch((e=>console.warn("Couldn't get storage estimate",[e])))}),[]),t?.quota&&t.usage&&t.quota-t.usage<1048576?i.default.createElement("div",{className:"storage-warning"},e.get("ts:storage_quota_warning",r(t.usage),r(t.quota))):null}))}}})),System.register("gui/screen/replay/ReplayDetailsPane",["react","util/format"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){e("ReplayDetailsPane",(({replayDetails:{engineVersion:e,durationSeconds:t,gameTimestamp:s,mapName:n,players:a},strings:o})=>i.createElement("div",{className:"replay-details"},i.createElement("table",null,i.createElement("tbody",null,s?i.createElement("tr",null,i.createElement("td",null,o.get("GUI:ReplayTime"),":"),i.createElement("td",{dir:"auto"},new Date(s*(String(s).length<13?1e3:1)).toLocaleString())):null,i.createElement("tr",null,i.createElement("td",null,o.get("GUI:GameVersion"),":"),i.createElement("td",null,e)),void 0!==n&&i.createElement("tr",null,i.createElement("td",null,o.get("GUI:Map"),":"),i.createElement("td",null,n)),a&&i.createElement("tr",null,i.createElement("td",null,o.get("GUI:Players"),":"),i.createElement("td",null,a.map(((e,t)=>i.createElement(i.Fragment,{key:e.name},t?", ":"",i.createElement("span",{style:{color:e.color}},e.name)))))),void 0!==t&&i.createElement("tr",null,i.createElement("td",null,o.get("GUI:Duration"),":"),i.createElement("td",null,r.formatTimeDuration(t))))))))}}})),System.register("gui/screen/replay/ReplaySel",["react","gui/component/List","gui/screen/replay/StorageWarning","gui/screen/replay/ReplayDetailsPane"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("ReplaySel",(({strings:e,replays:t,selectedReplay:a,selectedReplayDetails:o,onSelectReplay:l})=>{const c=i.useRef(null);return i.useEffect((()=>{c.current?.scrollIntoView()}),[]),i.default.createElement("div",{className:"replay-sel-form"},i.default.createElement(r.List,{title:e.get("GUI:SelectReplay"),className:"replay-list"},t?t.map((e=>{var t=e.id===a?.id;return i.default.createElement(r.ListItem,{key:e.id,selected:t,innerRef:t?c:null,onClick:()=>l(e),onDoubleClick:()=>l(e,!0),style:{display:"flex"}},i.default.createElement("div",{className:"replay-name"},e.keep?"":"* ",e.name),i.default.createElement("div",{className:"replay-time",dir:"auto"},new Date(e.timestamp).toLocaleString()))})):i.default.createElement(r.ListItem,{style:{textAlign:"center"}},e.get("GUI:LoadingEx"))),o&&i.default.createElement(n.ReplayDetailsPane,{replayDetails:o,strings:e}),i.default.createElement(s.StorageWarning,{strings:e}))}))}}})),System.register("gui/screen/replay/KeepReplayBox",["react","gui/component/Dialog","network/gamestate/Replay"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("KeepReplayBox",(({defaultName:e,strings:t,viewport:n,onSubmit:a,onDismiss:o})=>{let l=i.useRef(null),[c,h]=i.useState(!1);i.useEffect((()=>{setTimeout((()=>{l.current?.focus(),l.current?.setSelectionRange(0,l.current.value.length)}),50)}),[]);var u=e=>{e&&e.preventDefault();var t=l.current.value;t&&(h(!0),a(t))};return i.default.createElement(r.Dialog,{className:"keep-replay-box",hidden:c,viewport:n,zIndex:100,buttons:[{label:t.get("GUI:Ok"),onClick:u},{label:t.get("GUI:Cancel"),onClick:()=>{h(!0),o?.()}}]},i.default.createElement("form",{onSubmit:u},i.default.createElement("div",{className:"field"},i.default.createElement("label",null,t.get("GUI:ReplayNamePrompt")),i.default.createElement("input",{type:"text",name:"replayname",autoComplete:"off",ref:l,defaultValue:e,maxLength:s.Replay.maxNameLength})),i.default.createElement("button",{type:"submit",style:{visibility:"hidden"}})))}))}}})),System.register("gui/screen/replay/ReplaySelScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/replay/ReplaySel","network/gamestate/Replay","gui/screen/ScreenType","gui/screen/replay/KeepReplayBox","util/disposable/CompositeDisposable","gui/replay/ReplayStorageError","engine/ResourceLoader","data/vfs/StorageQuotaError","@puzzl/core/lib/async/Task","network/gameopt/Parser","game/GameSpeed","gui/replay/ReplayExistsError","gui/screen/mainMenu/MainMenuScreen","@puzzl/core/lib/async/cancellation","data/vfs/IOError","data/vfs/FileNotFoundError","RouteHelper","game/gameopts/GameOptRandomGen","game/gameopts/constants"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e}],execute:function(){C=class extends f.MainMenuScreen{constructor(e,t,i,r,s,n,a,o,c,h,u,d,g){super(),this.engineVersion=e,this.engineModHash=t,this.activeMod=i,this.oldClientsBaseUrl=r,this.rootController=s,this.strings=n,this.jsxRenderer=a,this.errorHandler=o,this.messageBoxApi=c,this.replayManager=h,this.uiScene=u,this.rules=d,this.sentry=g,this.title=this.strings.get("GUI:Replays"),this.disposables=new l.CompositeDisposable,this.handleSelectReplay=(e,t)=>{var i=this.selectedReplay?.id!==e.id;this.selectedReplay=e,i&&this.updateSidebarButtons(),this.form.applyOptions((t=>{t.selectedReplay=e,t.selectedReplayDetails=void 0})),t?this.loadSelectedReplay():this.loadReplayDetails(e)}}async onEnter(){this.availableReplays=[],this.controller.toggleMainVideo(!1),this.initForm();try{this.availableReplays=await this.replayManager.loadList(!0)}catch(e){return e instanceof T.IOError||e instanceof v.FileNotFoundError||e instanceof u.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load replay list (${e.name??e.message})`,{cause:e})),void this.handleError(e,this.strings.get("GUI:ReplayListError"))}this.selectedReplay=this.availableReplays[0],this.form.applyOptions((e=>{e.replays=this.availableReplays,e.selectedReplay=this.selectedReplay})),void 0!==this.selectedReplay&&this.loadReplayDetails(this.selectedReplay),this.initSidebar(),this.initFileInput()}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(i.jsx(r.HtmlView,{innerRef:e=>this.form=e,component:s.ReplaySel,props:{strings:this.strings,replays:void 0,selectedReplay:void 0,selectedReplayDetails:void 0,onSelectReplay:this.handleSelectReplay}}))[0])}initFileInput(){let e=this.fileInput=document.createElement("input");e.setAttribute("type","file"),e.setAttribute("accept",n.Replay.extension),e.setAttribute("style","display: none"),document.body.appendChild(e);const t=async()=>{var e=this.fileInput.files?.[0];if(e)try{await this.replayManager.importReplay(e),this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions((e=>e.replays=this.availableReplays))}catch(e){let t;t=e instanceof u.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):e instanceof c.ReplayStorageError?this.strings.get("GUI:SaveReplayError"):this.strings.get("GUI:ImportReplayError"),this.errorHandler.handle(e,t,(()=>{}))}};e.addEventListener("change",t),this.disposables.add((()=>{document.body.removeChild(this.fileInput),this.fileInput.removeEventListener("change",t),this.fileInput=void 0}))}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){let e=this.getSelectedReplayMeta();this.controller?.setSidebarButtons([{label:this.strings.get("GUI:LoadReplay"),disabled:!this.selectedReplay,onClick:()=>{this.loadSelectedReplay()}},{label:this.strings.get(e?.keep?"GUI:RenameReplay":"GUI:KeepReplay"),tooltip:e?.keep?void 0:this.strings.get("STT:KeepReplay"),disabled:!this.selectedReplay,onClick:()=>{this.showKeepReplayBox(e.name,(t=>{this.replayManager.keepReplay(e.id,t).then((async()=>{this.availableReplays=await this.replayManager.loadList(),this.selectedReplay=this.getSelectedReplayMeta(),this.form.applyOptions((e=>e.replays=this.availableReplays)),this.updateSidebarButtons()})).catch((e=>{let t;t=e instanceof m.ReplayExistsError?this.strings.get("GUI:ReplayExistsError"):this.strings.get("GUI:SaveReplayError"),this.errorHandler.handle(e,t,(()=>{}))}))}))}},{label:this.strings.get("GUI:ImportReplay"),tooltip:this.strings.get("STT:ImportReplay"),onClick:()=>{if(void 0!==this.fileInput.click)this.fileInput.click();else{let e=document.createEvent("Event");e.initEvent("click",!0,!0),this.fileInput.dispatchEvent(e)}}},{label:this.strings.get("GUI:ExportReplay"),tooltip:this.strings.get("STT:ExportReplay"),disabled:!this.selectedReplay,onClick:()=>{this.exportCurrentReplay().catch((e=>this.errorHandler.handle(e,this.strings.get("GUI:ReplayError"),(()=>{}))))}},{label:this.strings.get("GUI:DeleteReplay"),disabled:!this.selectedReplay,onClick:async()=>{var e=this.getSelectedReplayMeta();if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmDeleteReplay",e.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){try{await this.replayManager.deleteReplay(e)}catch(t){return e=t instanceof u.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:DeleteReplayError"),void this.errorHandler.handle(t,e,(()=>{}))}this.selectedReplay=void 0,this.availableReplays=await this.replayManager.loadList(),this.form.applyOptions((e=>{e.replays=this.availableReplays,e.selectedReplay=void 0,e.selectedReplayDetails=void 0})),this.updateSidebarButtons()}}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadSelectedReplay(){var e=this.selectedReplay;let t;try{var i=await this.replayManager.loadSerializedReplay(e);t=await(new n.Replay).parseHeader(i)}catch(e){return void this.errorHandler.handle(e,this.strings.get("GUI:ReplayError"),(()=>{}))}if(t.engineVersion!==this.engineVersion){if(!this.clientVersions&&this.oldClientsBaseUrl){this.messageBoxApi.show(this.strings.get("GUI:LoadingEx"));try{let e=new h.ResourceLoader(this.oldClientsBaseUrl);this.clientVersions=await e.loadJson("versions.json")}catch(e){console.warn("Couldn't download client version list",e)}finally{this.messageBoxApi.destroy()}}let r;return this.clientVersions&&(r=this.clientVersions[t.engineVersion]),void(r?await this.messageBoxApi.confirm(this.strings.get("GUI:ReplayOpenOldClient",t.engineVersion),this.strings.get("TXT_CONTINUE"),this.strings.get("GUI:Close"))&&(i=this.activeMod?`?${b.RouteHelper.modQueryStringName}=`+this.activeMod:"",window.open(`${this.oldClientsBaseUrl}v${r}/${i}#/replay/`+e.id,"_blank")):this.messageBoxApi.show(this.strings.get("GUI:ReplayVersionMismatch",t.engineVersion),this.strings.get("GUI:Ok")))}if(t.modHash===this.engineModHash){let t;try{t=await this.replayManager.loadReplay(e)}catch(e){return void this.errorHandler.handle(e,this.strings.get("GUI:ReplayError"),(()=>{}))}this.rootController.goToScreen(a.ScreenType.Replay,{replay:t})}else this.messageBoxApi.show(this.strings.get("GUI:ReplayModMismatch"),this.strings.get("GUI:Ok"))}showKeepReplayBox(e,t){let[s]=this.jsxRenderer.render(i.jsx(r.HtmlView,{component:o.KeepReplayBox,props:{defaultName:e,strings:this.strings,onSubmit:e=>{t(e),s.destroy()},onDismiss:()=>{s.destroy()},viewport:this.uiScene.viewport}}));this.uiScene.add(s),this.disposables.add(s,(()=>this.uiScene.remove(s)))}async exportCurrentReplay(){var e=this.getSelectedReplayMeta();if(!e)throw new Error("No replay selected");var t=await this.replayManager.loadSerializedReplay(e);this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),t=URL.createObjectURL(new Blob([t],{type:"application/octet-stream"})),this.currentReplayUrl=t;let i=document.createElement("a");i.setAttribute("href",t),i.setAttribute("download",e.name+n.Replay.extension),document.body.appendChild(i),i.click(),document.body.removeChild(i)}getSelectedReplayMeta(){if(this.selectedReplay)return this.availableReplays.find((e=>e.id===this.selectedReplay.id))}async onLeave(){this.currentReplayUrl&&URL.revokeObjectURL(this.currentReplayUrl),this.clientVersions=void 0,this.availableReplays.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.replayDetailsTask?.cancel(),this.replayDetailsTask=void 0,this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}loadReplayDetails(e){this.replayDetailsTask?.cancel(),this.replayDetailsTask=new d.Task((async t=>{let i=await this.replayManager.loadSerializedReplay(e);var r=await(new n.Replay).parseHeader(i);let s,a,o;if(t.throwIfCancelled(),r.engineVersion===this.engineVersion){let r=new n.Replay;r.unserialize("string"==typeof i?i:await i.text(),e),t.throwIfCancelled(),s=r.gameOpts,a=Math.floor(r.endTick/p.GameSpeed.BASE_TICKS_PER_SECOND)}else try{s=(new g.Parser).parseOptions(r.gameOptsSerialized)}catch(e){console.warn("Replay couldn't be parsed",e)}if(s){let e=S.GameOptRandomGen.factory(r.gameId,r.gameTimestamp).generateColors(s),t=this.getAvailablePlayerColors();o=s.humanPlayers.filter((e=>e.countryId!==w.OBS_COUNTRY_ID)).map((i=>({name:i.name,color:t[e.get(i)??i.colorId]})))}let l={gameTimestamp:r.gameTimestamp||void 0,engineVersion:r.engineVersion,durationSeconds:a,mapName:s?.mapTitle,players:o};this.form.applyOptions((e=>{e.selectedReplayDetails=l}))})),this.replayDetailsTask.start().catch((e=>{e instanceof y.OperationCanceledError||console.error(e)}))}getAvailablePlayerColors(){return[...this.rules.getMultiplayerColors().values()].map((e=>e.asHexString()))}handleError(e,t){this.errorHandler.handle(e,t,(()=>{this.rootController.goToScreen(a.ScreenType.MainMenuRoot)}))}},e("ReplaySelScreen",C)}}})),System.register("gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen",["react","gui/screen/mainMenu/main/ReportBug","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/ScreenType"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends s.MainMenuScreen{constructor(e,t,i){super(),this.strings=e,this.config=t,this.messageBoxApi=i,this.title=this.strings.get("TS:InfoAndCredits")}onEnter(){let e=this.strings;const t=this.config.discordUrl,s=this.config.donateUrl;this.controller.setSidebarButtons([...this.controller.hasScreen(n.ScreenType.PatchNotes)?[{label:e.get("TS:PatchNotes"),tooltip:e.get("STT:PatchNotes"),onClick:()=>{this.controller?.pushScreen(n.ScreenType.PatchNotes)}}]:[],...t?[{label:e.get("TS:ReportBug"),tooltip:e.get("TS:ReportBugTT"),onClick:()=>{this.messageBoxApi.show(i.createElement(r.ReportBug,{discordUrl:t,strings:this.strings}),this.strings.get("GUI:OK"))}}]:[],...s?[{label:e.get("TS:Donate"),onClick:()=>{window.open(s,"_blank"),window.gtag?.("event","donate_click")}}]:[],{label:e.get("GUI:ViewCredits"),onClick:()=>{this.controller?.pushScreen(n.ScreenType.Credits)}},{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!0),this.controller.setMainComponent()}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("InfoAndCreditsScreen",a)}}})),System.register("gui/screen/mainMenu/credits/Credits",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Credits",(({contentTpl:e,strings:t})=>{var r=e.replace(/\{([^}]+)\}/g,((e,i)=>t.get(i))).replace(/<([^>]+)>/g,((e,t)=>t.match(/^(https?|mailto):(\/\/)?/)?`<a href='${encodeURI(t)}' target='_blank' rel='noopener'>${encodeURI(t)}</a>`:"")).replace(/\t*\r?\n/g,"<br />").replace(/([^>]+)\t+([^<]+)<br \/>/g,"<div class='def'>\n                <span class='title'>$1</span>\n                <span class='filler'></span>\n                <span class='name'>$2</span>\n            </div>");return i.createElement("div",{className:"credits-container"},i.createElement("div",{className:"credits",dangerouslySetInnerHTML:{__html:r}}))}))}}})),System.register("gui/screen/mainMenu/credits/CreditsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/credits/Credits","engine/Engine","gui/screen/mainMenu/MainMenuScreen"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e}],execute:function(){o=class extends a.MainMenuScreen{constructor(e,t){super(),this.strings=e,this.jsxRenderer=t,this.title=this.strings.get("GUI:Credits")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var e=n.Engine.vfs?.openFile("creditscd.txt").readAsString("utf-8");let t=n.Engine.vfs?.openFile("credits.txt").readAsString();e=t.replace(/\s+\{CRD:CREDITS\}\s+/,e);var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.Credits,props:{contentTpl:e,strings:this.strings}}));this.controller.setMainComponent(e)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("CreditsScreen",o)}}})),System.register("gui/screen/options/component/Resolution",["gui/component/Select","gui/component/Option","react"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=[{width:1920,height:1080},{width:1600,height:900},{width:1280,height:1024},{width:1366,height:768},{width:1024,height:768},{width:800,height:600}],e("ResolutionSelect",(({resolution:e,fullScreen:t,strings:a})=>{const o=e=>e.width+" x "+e.height,l=()=>({width:Math.max(n[n.length-1].width,window.innerWidth),height:Math.max(n[n.length-1].height,window.innerHeight)}),c=e=>n.filter(((t,i)=>t.height<=e.height&&t.width<=e.width||i===n.length-1)),[h,u]=s.useState((()=>l())),[d,g]=s.useState(e.value),[p,m]=s.useState((()=>c(h)));var f=t.isFullScreen(),y=d&&!p.find((e=>e.height===d.height&&e.width===d.width));return s.useEffect((()=>{const t=()=>{var e=l();u(e),m(c(e))};return window.addEventListener("resize",t),e.onChange.subscribe(g),()=>{window.removeEventListener("resize",t),e.onChange.unsubscribe(g)}}),[]),f?s.createElement(i.Select,{className:"resolution-select",initialValue:"",disabled:!0,onSelect:()=>{}},s.createElement(r.Option,{value:"",label:a.get("TS:ResolutionFullScreen",o(h))})):s.createElement(i.Select,{className:"resolution-select",initialValue:d?o(d):"",onSelect:t=>{var i=(i=""!==t?t.split(" x ").map((e=>Number(e))):void 0)?{width:i[0],height:i[1]}:void 0;e.value=i}},y&&s.createElement(r.Option,{value:o(d),label:`${o(d)} (${o({width:Math.min(d.width,h.width),height:Math.min(d.height,h.height)})})`}),s.createElement(r.Option,{value:"",label:a.get("TS:ResolutionFit",o(h))}),p.map((e=>{var t=o(e);return s.createElement(r.Option,{key:t,value:t,label:t})})))}))}}})),System.register("gui/screen/options/component/GeneralOpts",["react","gui/component/Slider","gui/screen/options/GeneralOptions","gui/component/Select","gui/component/Option","engine/renderable/entity/unit/FlyerHelperMode","engine/renderable/entity/unit/ModelQuality","engine/renderable/entity/unit/ShadowQuality","gui/component/Image","gui/screen/options/component/Resolution"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e}],execute:function(){d=new Map([[1,"TXT_SLOWEST"],[2,"TXT_SLOWER"],[3,"TXT_SLOW"],[4,"TXT_MEDIUM"],[5,"TXT_FAST"],[6,"TXT_FASTER"],[7,"TXT_FASTEST"]]),e("GeneralOpts",(({strings:e,options:t,fullScreen:g,inGame:p})=>i.createElement("div",{className:"opts general-opts"},i.createElement("fieldset",null,i.createElement("legend",null,e.get("TS:GameplayOpts")),i.createElement("div",{className:"slider-item"},i.createElement("span",{className:"label"},e.get("GUI:ScrollRate")),i.createElement(r.Slider,{min:1,max:7,value:""+Math.floor(t.scrollRate.value/s.SCROLL_BASE_FACTOR),getLabel:t=>e.get(d.get(Number(t))),onChange:e=>t.scrollRate.value=Number(e.target.value)*s.SCROLL_BASE_FACTOR})),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:MouseAccel")},i.createElement("label",null,i.createElement("span",{className:"label"},e.get("TS:MouseAccel")),i.createElement(n.Select,{initialValue:""+Number(t.mouseAcceleration.value),onSelect:e=>t.mouseAcceleration.value=Boolean(Number(e))},i.createElement(a.Option,{value:"1",label:e.get("TXT_ON")}),i.createElement(a.Option,{value:"0",label:e.get("TXT_OFF")})),i.createElement("span",{className:"info",title:e.get("TS:MouseAccelHint")},i.createElement(h.Image,{src:"info.png"})))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:AttackMoveButton")},i.createElement("label",null,i.createElement("span",{className:"label"},e.get("TS:AttackMoveButton")),i.createElement(n.Select,{initialValue:""+Number(t.rightClickMove.value),onSelect:e=>t.rightClickMove.value=Boolean(Number(e))},i.createElement(a.Option,{value:"0",label:e.get("TS:AttackMoveButtonLeft")}),i.createElement(a.Option,{value:"1",label:e.get("TS:AttackMoveButtonRight")})))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:RightClickScroll")},i.createElement("label",null,i.createElement("span",{className:"label"},e.get("TS:RightClickScroll")),i.createElement(n.Select,{initialValue:""+Number(t.rightClickScroll.value),onSelect:e=>t.rightClickScroll.value=Boolean(Number(e))},i.createElement(a.Option,{value:"1",label:e.get("TXT_ON")}),i.createElement(a.Option,{value:"0",label:e.get("TXT_OFF")})))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:FlyerLabel")},i.createElement("span",{className:"label"},e.get("TS:FlyerLabel")),i.createElement(n.Select,{initialValue:""+t.flyerHelper.value,onSelect:e=>t.flyerHelper.value=Number(e)},i.createElement(a.Option,{value:""+o.FlyerHelperMode.Always,label:e.get("TS:FlyerAlways")}),i.createElement(a.Option,{value:""+o.FlyerHelperMode.Selected,label:e.get("TS:FlyerSelected")}),i.createElement(a.Option,{value:""+o.FlyerHelperMode.Never,label:e.get("TS:FlyerNever")}))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:IGGameOptCBoxHidden")},i.createElement("label",null,i.createElement("span",{className:"label"},e.get("GUI:ShowHidden")),i.createElement("input",{type:"checkbox",defaultChecked:t.hiddenObjects.value,onChange:e=>t.hiddenObjects.value=e.target.checked}))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:IGGameOptCBoxTargetLines")},i.createElement("label",null,i.createElement("span",{className:"label"},e.get("GUI:TargetLines")),i.createElement("input",{type:"checkbox",defaultChecked:t.targetLines.value,onChange:e=>t.targetLines.value=e.target.checked})))),i.createElement("fieldset",null,i.createElement("legend",null,e.get("TS:GfxOpts")),i.createElement("div",{className:"item"},i.createElement("span",{className:"label"},e.get("TS:Resolution")),i.createElement(u.ResolutionSelect,{resolution:t.graphics.resolution,fullScreen:g,strings:e}),i.createElement("span",{className:"info",title:e.get("TS:ResolutionHint")},i.createElement(h.Image,{src:"info.png"}))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:GfxModels")},i.createElement("span",{className:"label"},e.get("TS:GfxModels")),i.createElement(n.Select,{disabled:p,initialValue:""+t.graphics.models.value,onSelect:e=>t.graphics.models.value=Number(e)},i.createElement(a.Option,{value:""+l.ModelQuality.High,label:e.get("TS:GfxQualityHigh")}),i.createElement(a.Option,{value:""+l.ModelQuality.Low,label:e.get("TS:GfxQualityLow")}))),i.createElement("div",{className:"item","data-r-tooltip":e.get("STT:GfxShadows")},i.createElement("span",{className:"label"},e.get("TS:GfxShadows")),i.createElement(n.Select,{initialValue:""+t.graphics.shadows.value,onSelect:e=>t.graphics.shadows.value=Number(e)},i.createElement(a.Option,{value:""+c.ShadowQuality.High,label:e.get("TS:GfxQualityHigh")}),i.createElement(a.Option,{value:""+c.ShadowQuality.Medium,label:e.get("TS:GfxQualityMed")}),i.createElement(a.Option,{value:""+c.ShadowQuality.Low,label:e.get("TS:GfxQualityLow")}),i.createElement(a.Option,{value:""+c.ShadowQuality.Off,label:e.get("TS:GfxQualityOff")})))))))}}})),System.register("gui/screen/options/OptionsScreen",["gui/jsx/jsx","gui/screen/mainMenu/MainMenuController","gui/screen/game/gameMenu/GameMenuController","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","LocalPrefs","gui/jsx/HtmlView","gui/screen/options/component/GeneralOpts"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e}],execute:function(){e("OptionsScreen",class{constructor(e,t,i,r,s,n,a){this.strings=e,this.jsxRenderer=t,this.options=i,this.localPrefs=r,this.fullScreen=s,this.inGame=n,this.storageOptsEnabled=a,this.title=this.strings.get("GUI:Options")}setController(e){this.controller=e}onEnter(){this.initialOptionsStr=this.options.serialize(),this.controller instanceof r.MainMenuController&&this.controller.toggleMainVideo(!1),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Sound"),onClick:()=>{this.controller instanceof s.GameMenuController?this.controller.pushScreen(n.ScreenType.OptionsSound):this.controller?.pushScreen(a.ScreenType.OptionsSound)}},{label:this.strings.get("GUI:Keyboard"),onClick:()=>{this.controller instanceof s.GameMenuController?this.controller.pushScreen(n.ScreenType.OptionsKeyboard):this.controller?.pushScreen(a.ScreenType.OptionsKeyboard)}},...this.controller instanceof r.MainMenuController&&this.storageOptsEnabled?[{label:this.strings.get("GUI:Storage"),onClick:()=>{this.controller.pushScreen(a.ScreenType.OptionsStorage,{})}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[e]=this.jsxRenderer.render(i.jsx(l.HtmlView,{width:"100%",height:"100%",component:c.GeneralOpts,props:{options:this.options,fullScreen:this.fullScreen,strings:this.strings,inGame:this.inGame}}));this.controller.setMainComponent(e)}async onLeave(){var e=this.options.serialize();e!==this.initialOptionsStr&&this.localPrefs.setItem(o.StorageKey.Options,e),await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}})}}})),System.register("gui/screen/options/component/MusicJukebox",["gui/component/List","react","util/string"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("MusicJukebox",(({music:e,strings:t})=>{const[n,a]=r.useState((()=>e.getCurrentPlaylistItem()));return r.default.createElement("div",{className:"music-jukebox"},r.default.createElement("div",{className:"jukebox-content"},r.default.createElement("div",{className:"controls"},r.default.createElement("div",null,r.default.createElement("label",null,r.default.createElement("input",{type:"checkbox",defaultChecked:e.getShuffleMode(),onChange:t=>e.setShuffleMode(t.target.checked)}),t.get("GUI:Shuffle"))),r.default.createElement("div",null,r.default.createElement("label",null,r.default.createElement("input",{type:"checkbox",defaultChecked:e.getRepeatMode(),onChange:t=>e.setRepeatMode(t.target.checked)}),t.get("GUI:Repeat")))),r.default.createElement(i.List,{className:"playlist"},e.getPlaylist().map(((e,o)=>r.default.createElement(i.ListItem,{key:e.name,selected:e===n,onClick:()=>a(e)},s.pad(o+1,"00")," - ",t.get(e.name)))))),r.default.createElement("div",{className:"jukebox-footer"},r.default.createElement("button",{className:"dialog-button",onClick:()=>n&&e.selectPlaylistItem(n)},t.get("GUI:Play")),r.default.createElement("button",{className:"dialog-button",onClick:()=>e.stopPlaying()},t.get("GUI:Stop"))))}))}}})),System.register("gui/screen/options/component/SoundOpts",["react","gui/component/Slider","engine/sound/ChannelType","gui/screen/options/component/MusicJukebox"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=new Map([[s.ChannelType.Master,"GUI:MasterVolume"],[s.ChannelType.Music,"GUI:MusicVolume"],[s.ChannelType.Effect,"GUI:SFXVolume"],[s.ChannelType.Voice,"GUI:VoiceVolume"],[s.ChannelType.Ambient,"GUI:AmbientVolume"],[s.ChannelType.Ui,"GUI:UIVolume"],[s.ChannelType.CreditTicks,"GUI:CreditsVolume"]]),e("SoundOpts",(({strings:e,music:t,mixer:s})=>i.createElement("div",{className:"opts sound-opts"},i.createElement("div",{className:"sound-sliders"},[...a].map((([t,n])=>i.createElement("div",{className:"slider-item",key:t},i.createElement("span",{className:"label"},e.get(n)),i.createElement(r.Slider,{min:0,max:10,value:""+10*s.getVolume(t),onChange:e=>s.setVolume(t,Number(e.target.value)/10)}))))),t&&i.createElement(n.MusicJukebox,{music:t,strings:e}))))}}})),System.register("gui/screen/options/SoundOptsScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/SoundOpts","LocalPrefs"],(function(e,t){"use strict";var i,r,s,n;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){e("SoundOptsScreen",class{constructor(e,t,i,r,s){this.strings=e,this.jsxRenderer=t,this.mixer=i,this.music=r,this.localPrefs=s,this.title=this.strings.get("GUI:Sound")}setController(e){this.controller=e}onEnter(){this.initialSettings=this.mixer.serialize(),this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.SoundOpts,props:{mixer:this.mixer,music:this.music,strings:this.strings}}));this.controller.setMainComponent(e)}async onLeave(){var e=this.mixer.serialize();e!==this.initialSettings&&this.localPrefs.setItem(n.StorageKey.Mixer,e),this.music&&(e=this.music.serializeOptions(),this.localPrefs.setItem(n.StorageKey.MusicOpts,e)),await this.controller.hideSidebarButtons()}})}}})),System.register("gui/screen/options/component/configurableCmds",["gui/screen/game/worldInteraction/keyboard/KeyCommandType"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("configurableCmds",new Map([[i.KeyCommandType.Options,{label:"txt_options",desc:"txt_options_desc"}],[i.KeyCommandType.ToggleAlliance,{label:"txt_alliance",desc:"txt_alliance_desc"}],[i.KeyCommandType.PlaceBeacon,{label:"txt_place_beacon",desc:"txt_place_beacon_desc"}],[i.KeyCommandType.AllToCheer,{label:"cmnd:allcheer",desc:"cmnd:allcheerdesc"}],[i.KeyCommandType.DeployObject,{label:"txt_deploy_object",desc:"txt_deploy_object_desc"}],[i.KeyCommandType.Follow,{label:"txt_follow",desc:"txt_follow_desc"}],[i.KeyCommandType.GuardObject,{label:"txt_guard",desc:"txt_guard_desc"}],[i.KeyCommandType.StopObject,{label:"txt_stop_object",desc:"txt_stop_object_desc"}],[i.KeyCommandType.ScatterObject,{label:"txt_scatter",desc:"txt_scatter_desc"}],[i.KeyCommandType.CenterBase,{label:"txt_center_base",desc:"txt_center_base_desc"}],[i.KeyCommandType.ToggleRepair,{label:"txt_repair_mode",desc:"txt_repair_mode_desc"}],[i.KeyCommandType.ToggleSell,{label:"txt_sell_mode",desc:"txt_sell_mode_desc"}],[i.KeyCommandType.PreviousObject,{label:"txt_prev_object",desc:"txt_prev_object_desc"}],[i.KeyCommandType.NextObject,{label:"txt_next_object",desc:"txt_next_object_desc"}],[i.KeyCommandType.TypeSelect,{label:"cmnd:typeselect",desc:"cmnd:typeselectdesc"}],[i.KeyCommandType.CombatantSelect,{label:"cmnd:combatantselect",desc:"cmnd:combatantselectdesc"}],[i.KeyCommandType.StructureTab,{label:"txt_structure_tab",desc:"txt_structure_tab_desc"}],[i.KeyCommandType.DefenseTab,{label:"txt_defense_tab",desc:"txt_defense_tab_desc"}],[i.KeyCommandType.InfantryTab,{label:"txt_infantry_tab",desc:"txt_infantry_tab_desc"}],[i.KeyCommandType.UnitTab,{label:"txt_unit_tab",desc:"txt_unit_tab_desc"}],[i.KeyCommandType.PlanningMode,{label:"cmnd:planningmode",desc:"cmnd:planningmodedesc"}],[i.KeyCommandType.CenterOnRadarEvent,{label:"txt_radar_event",desc:"txt_radar_event_desc"}],[i.KeyCommandType.HealthNav,{label:"cmnd:healthnavigation",desc:"cmnd:healthnavigationdesc"}],[i.KeyCommandType.VeterancyNav,{label:"cmnd:vetnavigation",desc:"cmnd:vetnavigationdesc"}],[i.KeyCommandType.TeamSelect_1,{label:e=>e.get("txt_select_team",1),desc:e=>e.get("txt_select_team_desc",1)}],[i.KeyCommandType.TeamSelect_2,{label:e=>e.get("txt_select_team",2),desc:e=>e.get("txt_select_team_desc",2)}],[i.KeyCommandType.TeamSelect_3,{label:e=>e.get("txt_select_team",3),desc:e=>e.get("txt_select_team_desc",3)}],[i.KeyCommandType.TeamSelect_4,{label:e=>e.get("txt_select_team",4),desc:e=>e.get("txt_select_team_desc",4)}],[i.KeyCommandType.TeamSelect_5,{label:e=>e.get("txt_select_team",5),desc:e=>e.get("txt_select_team_desc",5)}],[i.KeyCommandType.TeamSelect_6,{label:e=>e.get("txt_select_team",6),desc:e=>e.get("txt_select_team_desc",6)}],[i.KeyCommandType.TeamSelect_7,{label:e=>e.get("txt_select_team",7),desc:e=>e.get("txt_select_team_desc",7)}],[i.KeyCommandType.TeamSelect_8,{label:e=>e.get("txt_select_team",8),desc:e=>e.get("txt_select_team_desc",8)}],[i.KeyCommandType.TeamSelect_9,{label:e=>e.get("txt_select_team",9),desc:e=>e.get("txt_select_team_desc",9)}],[i.KeyCommandType.TeamSelect_10,{label:e=>e.get("txt_select_team",10),desc:e=>e.get("txt_select_team_desc",10)}],[i.KeyCommandType.TeamCreate_1,{label:e=>e.get("txt_create_team",1),desc:e=>e.get("txt_create_team_desc",1)}],[i.KeyCommandType.TeamCreate_2,{label:e=>e.get("txt_create_team",2),desc:e=>e.get("txt_create_team_desc",2)}],[i.KeyCommandType.TeamCreate_3,{label:e=>e.get("txt_create_team",3),desc:e=>e.get("txt_create_team_desc",3)}],[i.KeyCommandType.TeamCreate_4,{label:e=>e.get("txt_create_team",4),desc:e=>e.get("txt_create_team_desc",4)}],[i.KeyCommandType.TeamCreate_5,{label:e=>e.get("txt_create_team",5),desc:e=>e.get("txt_create_team_desc",5)}],[i.KeyCommandType.TeamCreate_6,{label:e=>e.get("txt_create_team",6),desc:e=>e.get("txt_create_team_desc",6)}],[i.KeyCommandType.TeamCreate_7,{label:e=>e.get("txt_create_team",7),desc:e=>e.get("txt_create_team_desc",7)}],[i.KeyCommandType.TeamCreate_8,{label:e=>e.get("txt_create_team",8),desc:e=>e.get("txt_create_team_desc",8)}],[i.KeyCommandType.TeamCreate_9,{label:e=>e.get("txt_create_team",9),desc:e=>e.get("txt_create_team_desc",9)}],[i.KeyCommandType.TeamCreate_10,{label:e=>e.get("txt_create_team",10),desc:e=>e.get("txt_create_team_desc",10)}],[i.KeyCommandType.TeamAddSelect_1,{label:e=>e.get("txt_add_select_team",1),desc:e=>e.get("txt_add_select_team_desc",1)}],[i.KeyCommandType.TeamAddSelect_2,{label:e=>e.get("txt_add_select_team",2),desc:e=>e.get("txt_add_select_team_desc",2)}],[i.KeyCommandType.TeamAddSelect_3,{label:e=>e.get("txt_add_select_team",3),desc:e=>e.get("txt_add_select_team_desc",3)}],[i.KeyCommandType.TeamAddSelect_4,{label:e=>e.get("txt_add_select_team",4),desc:e=>e.get("txt_add_select_team_desc",4)}],[i.KeyCommandType.TeamAddSelect_5,{label:e=>e.get("txt_add_select_team",5),desc:e=>e.get("txt_add_select_team_desc",5)}],[i.KeyCommandType.TeamAddSelect_6,{label:e=>e.get("txt_add_select_team",6),desc:e=>e.get("txt_add_select_team_desc",6)}],[i.KeyCommandType.TeamAddSelect_7,{label:e=>e.get("txt_add_select_team",7),desc:e=>e.get("txt_add_select_team_desc",7)}],[i.KeyCommandType.TeamAddSelect_8,{label:e=>e.get("txt_add_select_team",8),desc:e=>e.get("txt_add_select_team_desc",8)}],[i.KeyCommandType.TeamAddSelect_9,{label:e=>e.get("txt_add_select_team",9),desc:e=>e.get("txt_add_select_team_desc",9)}],[i.KeyCommandType.TeamAddSelect_10,{label:e=>e.get("txt_add_select_team",10),desc:e=>e.get("txt_add_select_team_desc",10)}],[i.KeyCommandType.TeamCenter_1,{label:e=>e.get("txt_center_team",1),desc:e=>e.get("txt_center_team_desc",1)}],[i.KeyCommandType.TeamCenter_2,{label:e=>e.get("txt_center_team",2),desc:e=>e.get("txt_center_team_desc",2)}],[i.KeyCommandType.TeamCenter_3,{label:e=>e.get("txt_center_team",3),desc:e=>e.get("txt_center_team_desc",3)}],[i.KeyCommandType.TeamCenter_4,{label:e=>e.get("txt_center_team",4),desc:e=>e.get("txt_center_team_desc",4)}],[i.KeyCommandType.TeamCenter_5,{label:e=>e.get("txt_center_team",5),desc:e=>e.get("txt_center_team_desc",5)}],[i.KeyCommandType.TeamCenter_6,{label:e=>e.get("txt_center_team",6),desc:e=>e.get("txt_center_team_desc",6)}],[i.KeyCommandType.TeamCenter_7,{label:e=>e.get("txt_center_team",7),desc:e=>e.get("txt_center_team_desc",7)}],[i.KeyCommandType.TeamCenter_8,{label:e=>e.get("txt_center_team",8),desc:e=>e.get("txt_center_team_desc",8)}],[i.KeyCommandType.TeamCenter_9,{label:e=>e.get("txt_center_team",9),desc:e=>e.get("txt_center_team_desc",9)}],[i.KeyCommandType.TeamCenter_10,{label:e=>e.get("txt_center_team",10),desc:e=>e.get("txt_center_team_desc",10)}],[i.KeyCommandType.CenterView,{label:"txt_center_view",desc:"txt_center_view_desc"}],[i.KeyCommandType.View1,{label:"txt_view_bookmark1",desc:"txt_view_bookmark1_desc"}],[i.KeyCommandType.View2,{label:"txt_view_bookmark2",desc:"txt_view_bookmark2_desc"}],[i.KeyCommandType.View3,{label:"txt_view_bookmark3",desc:"txt_view_bookmark3_desc"}],[i.KeyCommandType.View4,{label:"txt_view_bookmark4",desc:"txt_view_bookmark4_desc"}],[i.KeyCommandType.SetView1,{label:"txt_set_bookmark1",desc:"txt_set_bookmark1_desc"}],[i.KeyCommandType.SetView2,{label:"txt_set_bookmark2",desc:"txt_set_bookmark2_desc"}],[i.KeyCommandType.SetView3,{label:"txt_set_bookmark3",desc:"txt_set_bookmark3_desc"}],[i.KeyCommandType.SetView4,{label:"txt_set_bookmark4",desc:"txt_set_bookmark4_desc"}],[i.KeyCommandType.Taunt_1,{label:e=>e.get("txt_taunt_number",1),desc:e=>e.get("txt_taunt_desc",1)}],[i.KeyCommandType.Taunt_2,{label:e=>e.get("txt_taunt_number",2),desc:e=>e.get("txt_taunt_desc",2)}],[i.KeyCommandType.Taunt_3,{label:e=>e.get("txt_taunt_number",3),desc:e=>e.get("txt_taunt_desc",3)}],[i.KeyCommandType.Taunt_4,{label:e=>e.get("txt_taunt_number",4),desc:e=>e.get("txt_taunt_desc",4)}],[i.KeyCommandType.Taunt_5,{label:e=>e.get("txt_taunt_number",5),desc:e=>e.get("txt_taunt_desc",5)}],[i.KeyCommandType.Taunt_6,{label:e=>e.get("txt_taunt_number",6),desc:e=>e.get("txt_taunt_desc",6)}],[i.KeyCommandType.Taunt_7,{label:e=>e.get("txt_taunt_number",7),desc:e=>e.get("txt_taunt_desc",7)}],[i.KeyCommandType.Taunt_8,{label:e=>e.get("txt_taunt_number",8),desc:e=>e.get("txt_taunt_desc",8)}],[i.KeyCommandType.Delete,{label:"cmnd:delete",desc:"cmnd:deletedesc"}],[i.KeyCommandType.PageUser,{label:"txt_pageuser",desc:"txt_pageuser_desc"}],[i.KeyCommandType.SidebarPageUp,{label:"txt_sidebar_pgup",desc:"txt_sidebar_pgup_desc"}],[i.KeyCommandType.SidebarUp,{label:"txt_sidebar_up",desc:"txt_sidebar_up_desc"}],[i.KeyCommandType.SidebarPageDown,{label:"txt_sidebar_pgdn",desc:"txt_sidebar_pgdn_desc"}],[i.KeyCommandType.SidebarDown,{label:"txt_sidebar_down",desc:"txt_sidebar_down_desc"}],[i.KeyCommandType.ToggleFps,{label:"cmnd:togglefps",desc:"cmnd:togglefpsdesc"}]]))}}})),System.register("gui/screen/options/component/PressKeyInput",["gui/FullScreen","react","gui/screen/options/component/getHumanReadableKey"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){n=e=>e.shiftKey||e.ctrlKey||e.altKey||e.metaKey,a=e=>["Alt","Control","Shift","Meta"].includes(e.key),o=["Escape","Backspace","Enter","Tab","ArrowLeft","ArrowRight","ArrowUp","ArrowDown"," "],e("PressKeyInput",(({tooltip:e,onChange:t})=>{const[l,c]=r.useState(),h=e=>{c(e),e&&void 0===e.keyCode||t(e)};var u=l?s.getHumanReadableKey(l):"";return r.default.createElement("input",{type:"text",value:u,"data-r-tooltip":e,onChange:()=>{},onKeyDown:e=>{e.preventDefault(),e.stopPropagation(),e.repeat||255<e.keyCode||(o.includes(e.key)||i.FullScreen.isFullScreenHotKey(e)?h(void 0):h({shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,keyCode:a(e)?void 0:e.keyCode}))},onKeyUp:e=>{e.preventDefault(),e.stopPropagation(),e.repeat||255<e.keyCode||void 0===l?.keyCode&&a(e)&&h(n(e)?{shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,keyCode:void 0}:void 0)},onBlur:()=>{l&&void 0===l?.keyCode&&h(void 0)}})}))}}})),System.register("gui/screen/options/component/KeyOpts",["react","gui/screen/options/component/configurableCmds","gui/component/List","gui/screen/options/component/PressKeyInput","gui/screen/options/component/getHumanReadableKey","gui/screen/game/worldInteraction/keyboard/KeyboardHandler"],(function(e,t){"use strict";var i,r,s,n,a,o;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e}],execute:function(){e("KeyOpts",(({strings:e,keyBinds:t,onResetAll:l,onHotKeyChange:c})=>{let[h,u]=i.useState(),[d,g]=i.useState(),[p,m]=i.useState(),[f,y]=i.useState(0),[T,v]=i.useState();const b=t=>"function"==typeof t?t(e):e.get(t);let S=h&&r.configurableCmds.has(h)?r.configurableCmds.get(h).desc:void 0;var w=S?"function"==typeof S?S(e):e.get(S):void 0,C=h?t.getHotKey(h):void 0;return i.default.createElement("div",{className:"opts key-opts"},i.default.createElement("div",{className:"key-opts-list"},i.default.createElement("div",{className:"key-opts-left"},i.default.createElement(s.List,{title:e.get("GUI:Commands"),className:"key-list"},[...r.configurableCmds].map((([e,{label:t}])=>i.default.createElement(s.ListItem,{key:e,selected:h===e,onClick:()=>(e=>{u(e),g(void 0),y(f+1),v(void 0)})(e)},b(t)))))),i.default.createElement("div",{className:"key-opts-right"},i.default.createElement("fieldset",{className:"key-opts-desc-container"},i.default.createElement("legend",null,e.get("GUI:Description")),i.default.createElement("div",{className:"key-opts-desc"},w)))),i.default.createElement("div",{className:"key-opts-assigns"},i.default.createElement("div",{className:"key-opts-cur-assign"},i.default.createElement("div",{className:"key-opts-left","data-r-tooltip":e.get("STT:KeyboardLabelAssigned")},i.default.createElement("div",{className:"key-opts-cur-assign-label"},e.get("GUI:CurrentShortcut")),i.default.createElement("div",{className:"key-opts-cur-assign-value"},C&&a.getHumanReadableKey(C))),i.default.createElement("div",{className:"key-opts-right"},T)),i.default.createElement("div",{className:"key-opts-ch-assign"},i.default.createElement("div",{className:"key-opts-left"},i.default.createElement("div",{className:"key-opts-ch-assign-label"},e.get("GUI:PressShortcut")),i.default.createElement(n.PressKeyInput,{key:f,onChange:e=>{g(e?t.getCommandType(e):void 0),m(e),v(void 0)},tooltip:e.get("STT:KeyboardEditEntry")}),i.default.createElement("div",{className:"key-opts-ch-assign-current"},i.default.createElement("div",null,e.get("GUI:CurAssignedTo")),i.default.createElement("div",null,d&&r.configurableCmds.has(d)?b(r.configurableCmds.get(d).label):""))),i.default.createElement("div",{className:"key-opts-right"},i.default.createElement("button",{className:"dialog-button",disabled:!h,onClick:()=>{if(h){if(p&&(p.shiftKey||p.ctrlKey||p.altKey||p.metaKey)){if(o.KeyboardHandler.anyModifierCommands.includes(h))return void v(e.get("Error:CannotMap"));var i=t.getCommandType({keyCode:p.keyCode,altKey:!1,ctrlKey:!1,shiftKey:!1,metaKey:!1});if(void 0!==i&&o.KeyboardHandler.anyModifierCommands.includes(i))return void v(e.get("Error:CannotRemap"))}c?.(h,p),g(void 0),m(void 0),y(f+1),v(void 0)}},"data-r-tooltip":e.get("STT:KeyboardButtonAssign")},e.get("GUI:Assign")),i.default.createElement("button",{className:"dialog-button",onClick:async()=>{u(void 0),g(void 0),m(void 0),v(void 0),await(l?.()),y(f+1)},"data-r-tooltip":e.get("STT:KeyboardButtonResetAll")},e.get("GUI:ResetAll")))),i.default.createElement("fieldset",{className:"key-opts-ch-assign-warn"},i.default.createElement("legend",null,e.get("TS:Warning").toLocaleUpperCase()),e.get("TS:HotKeyFSWarning"))))}))}}})),System.register("gui/screen/options/KeyboardScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/options/component/KeyOpts"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("KeyboardScreen",class{constructor(e,t,i){this.strings=e,this.jsxRenderer=t,this.keyBinds=i,this.title=this.strings.get("GUI:KeyboardOptions")}setController(e){this.controller=e}onEnter(){this.isDirty=!1,this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons();var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.KeyOpts,props:{keyBinds:this.keyBinds,strings:this.strings,onHotKeyChange:(e,t)=>{this.keyBinds.changeHotKey(e,t),this.isDirty=!0},onResetAll:async()=>{try{await this.keyBinds.resetAndReload()}catch(e){console.error(e)}}}}));this.controller.setMainComponent(e)}async onLeave(){if(await this.controller.hideSidebarButtons(),this.isDirty){this.isDirty=!1;try{await this.keyBinds.save()}catch(e){console.error(e)}}}})}}})),System.register("gui/screen/mainMenu/component/Iframe",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("Iframe",(({src:e,className:t})=>i.createElement("iframe",{src:e,className:t})))}}})),System.register("gui/screen/mainMenu/patchNotes/PatchNotesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/component/Iframe","gui/screen/mainMenu/MainMenuScreen"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends n.MainMenuScreen{constructor(e,t,i){super(),this.strings=e,this.jsxRenderer=t,this.patchNotesUrl=i,this.title=this.strings.get("TS:PatchNotes")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:s.Iframe,props:{src:this.patchNotesUrl,className:"patch-notes"}}));this.controller.setMainComponent(e)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("PatchNotesScreen",a)}}})),System.register("gui/screen/mainMenu/modSel/ModDetailsPane",["react","gui/screen/mainMenu/modSel/ModStatus"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e}],execute:function(){s=new Map([[r.ModStatus.Installed,"GUI:ModStatusInstalled"],[r.ModStatus.UpdateAvailable,"GUI:ModStatusUpdateAvail"],[r.ModStatus.NotInstalled,"GUI:ModStatusNotInstalled"]]),e("ModDetailsPane",(({modDetails:{supported:e,name:t,description:r,authors:n,version:a,website:o},modLoaded:l,modStatus:c,strings:h})=>i.createElement("div",{className:"mod-details"},i.createElement("table",null,i.createElement("tbody",null,i.createElement("tr",null,i.createElement("td",null,h.get("GUI:ModName"),":"),i.createElement("td",null,t)),i.createElement("tr",null,i.createElement("td",null,h.get("GUI:ModStatus"),":"),i.createElement("td",null,h.get(s.get(c)??"GUI:Unknown"),l?", "+h.get("GUI:ModLoaded"):"",e?"":", "+h.get("GUI:ModUnsupported"))),a&&i.createElement("tr",null,i.createElement("td",null,h.get("GUI:ModVersion"),":"),i.createElement("td",null,a)),r&&i.createElement("tr",null,i.createElement("td",null,h.get("GUI:ModDescription"),":"),i.createElement("td",{className:"mod-desc"},r)),n&&i.createElement("tr",null,i.createElement("td",null,h.get("GUI:ModAuthor"),":"),i.createElement("td",null,n.join(", "))),o&&i.createElement("tr",null,i.createElement("td",null,h.get("GUI:ModWebsite"),":"),i.createElement("td",null,i.createElement("a",{href:o,rel:"nofollow noopener",target:"_blank"},o))))))))}}})),System.register("gui/screen/mainMenu/modSel/ModSel",["react","gui/component/List","gui/screen/mainMenu/modSel/ModDetailsPane"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e}],execute:function(){e("ModSel",(({strings:e,mods:t,activeMod:n,selectedMod:a,onSelectMod:o})=>{const l=i.useRef(null);return i.useEffect((()=>{l.current?.scrollIntoView()}),[]),i.default.createElement("div",{className:"mod-sel-form"},i.default.createElement(r.List,{title:e.get("GUI:SelectMod"),className:"mod-list"},t?t.map((t=>{var s=t.id===a?.id;return i.default.createElement(r.ListItem,{key:t.id,selected:s,innerRef:s?l:null,onClick:()=>o(t),onDoubleClick:()=>o(t,!0),style:{display:"flex"}},i.default.createElement("div",{className:"mod-name"},(t===n?"✔ ":"")+t.name+(t.supported?"":` (${e.get("GUI:ModUnsupported").toUpperCase()})`)))})):i.default.createElement(r.ListItem,{style:{textAlign:"center"}},e.get("GUI:LoadingEx"))),a&&i.default.createElement(s.ModDetailsPane,{modLoaded:n===a,modStatus:a.status,modDetails:a.meta,strings:e}))}))}}})),System.register("gui/screen/mainMenu/modSel/BadModArchiveError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("BadModArchiveError",i)}}})),System.register("gui/screen/mainMenu/modSel/DuplicateModError",[],(function(e,t){"use strict";var i;return t&&t.id,{setters:[],execute:function(){i=class extends Error{},e("DuplicateModError",i)}}})),System.register("gui/screen/mainMenu/modSel/ModImporter",["util/time","data/vfs/IOError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/InvalidArchiveError","gui/screen/mainMenu/modSel/ModManager","gui/screen/mainMenu/modSel/ModMeta","gui/screen/mainMenu/modSel/BadModArchiveError","data/IniFile","gui/screen/mainMenu/modSel/DuplicateModError"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e}],execute:function(){e("ModImporter",u=class e{constructor(e,t,i){this.strings=e,this.messageBoxApi=t,this.storage=i}async import(t,u,d,g){let p,m,f=this.strings,y=await SystemJS.import("7z-wasm"),T=await y({quit:(e,t)=>{p=e,m=t}});g(f.get("ts:import_loading_archive")),T.FS.chdir("/tmp");var v=t.name;try{var b=await t.arrayBuffer(),S=T.FS.open(v,"w+");T.FS.write(S,new Uint8Array(b),0,b.byteLength,0,!0),T.FS.close(S)}catch(t){if(t instanceof DOMException)throw new r.IOError(`File "${v}" could not be read (${t.name})`,{cause:t});throw t}if(g(f.get("ts:import_extracting_archive")),await i.sleep(100),T.callMain(["x","-ssc-","-x!*/",v,"*.*"]),p)throw 1===p?new s.ArchiveExtractionError("Archive extraction failed with code "+p,{cause:m}):new n.InvalidArchiveError("7-Zip exited with code "+p,{cause:m});T.FS.unlink(v);let w=T.FS.lookupPath(T.FS.cwd()).node,C=Object.keys(w.contents),E=new o.ModMeta;var x;S=()=>{for(var e of(({node:w}=T.FS.lookupPath(T.FS.cwd())),C=Object.keys(w.contents),C))T.FS.unlink(e)};let O=0;for(x of C)O+=T.FS.stat(x).size;if(this.storage?.estimate&&(v=await this.storage.estimate().catch((e=>{console.warn("Couldn't get storage estimate",[e])})),v?.quota&&v.usage&&(v=v.quota-v.usage)<O+1048576))return await this.messageBoxApi.alert(f.get("GUI:InstallModStorageFull",v/1024/1024,O/1024/1024),f.get("GUI:OK")),void S();try{let i,r=await u.listEntries();if(C.includes(a.ModManager.modMetaFileName)){let e=this.readFileFromEmFs(T.FS,a.ModManager.modMetaFileName);try{E.fromIniFile(new c.IniFile(await e.text()))}catch(t){throw new l.BadModArchiveError("Mod meta file is invalid")}if(i=E.id,!d&&r.find((e=>e.toLowerCase()===i)))throw new h.DuplicateModError(`A mod with the id "${E.id}" already exists`)}else{if(!C.some((t=>e.modFileExtensions.includes(w.contents[t].name.toLowerCase().split(".").pop()))))throw new l.BadModArchiveError("Archive doesn't contain a valid mod");if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ImportModUnsupportedWarn"),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return void S();if(i=await this.promptFolderName(r),!i)return void S();E.id=i,E.name=i}let s=await u.getOrCreateDirectory(i);for await(var A of s.getFileHandles())await s.deleteFile(A.name);for(var M of C){g(f.get("ts:import_importing",M));try{var R=this.readFileFromEmFs(T.FS,M);await s.writeFile(R)}catch(t){throw await u.deleteDirectory(s.name,!0),t}finally{T.FS.unlink(M)}}}finally{S()}return E}async promptFolderName(e){let t,i=this.strings;for(;;){if(t=await this.messageBoxApi.prompt(i.get("GUI:ImportModFolderPrompt"),i.get("GUI:Ok"),i.get("GUI:Cancel")),!t)return;if(t.match(a.ModManager.modIdRegex)){if(!e.some((e=>e.toLowerCase()===t)))break;await this.messageBoxApi.alert(i.get("GUI:ImportModFolderExists"),i.get("GUI:Ok"))}else await this.messageBoxApi.alert(i.get("GUI:ImportModFolderBadName"),i.get("GUI:Ok"))}return t}readFileFromEmFs(e,t){try{e.chmod(t,448)}catch(e){if(44!==e.errno)throw e}var i=e.readFile(t);let r=e.stat(t);return i=new Blob([i],{type:"application/octet-stream"}),new File([i],t.slice(t.lastIndexOf("/")+1),{lastModified:r.mtime.getTime()})}}),u.modFileExtensions=["ini","mix"]}}})),System.register("gui/screen/mainMenu/modSel/ModDownloadPrompt",["react"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("ModDownloadPrompt",(({url:e,sizeMb:t,isUpdate:r,strings:s,onClick:n})=>i.createElement("div",null,r&&i.createElement("p",{style:{marginTop:0}},s.get("GUI:ModUpdateAvail")),i.createElement("p",null,s.get("GUI:ManualDownloadModPrompt")),i.createElement("a",{href:e,rel:"nofollow noopener",target:"_blank",onClick:n},e),i.createElement("br",null),i.createElement("br",null),i.createElement("em",null,s.get("ts:gameres_download_size",t)))))}}})),System.register("gui/screen/mainMenu/modSel/ModSelScreen",["react","gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/ScreenType","gui/screen/mainMenu/ScreenType","util/disposable/CompositeDisposable","data/vfs/StorageQuotaError","gui/screen/mainMenu/MainMenuScreen","data/vfs/IOError","data/vfs/FileNotFoundError","gui/screen/mainMenu/modSel/ModSel","engine/Engine","engine/gameRes/FileSystemUtil","gui/screen/mainMenu/modSel/ModImporter","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","gui/screen/mainMenu/modSel/BadModArchiveError","gui/screen/mainMenu/modSel/DuplicateModError","gui/screen/mainMenu/modSel/Mod","gui/screen/mainMenu/modSel/ModStatus","@puzzl/core/lib/async/cancellation","gui/screen/mainMenu/modSel/ModDownloadPrompt"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e}],execute:function(){E=class extends c.MainMenuScreen{constructor(e,t,i,r,s,n,a,l,c,h,u){super(),this.rootController=e,this.strings=t,this.jsxRenderer=i,this.errorHandler=r,this.messageBoxApi=s,this.modManager=n,this.activeModId=a,this.modSdkUrl=l,this.modResourceLoader=c,this.fsAccessLib=h,this.sentry=u,this.title=this.strings.get("GUI:Mods"),this.disposables=new o.CompositeDisposable,this.handleSelectMod=async(e,t)=>{var i=this.selectedMod?.id!==e.id;this.selectedMod=e,i&&this.updateSidebarButtons(),this.form?.applyOptions((t=>{t.selectedMod=e})),t&&e!==this.activeMod&&e.status===S.ModStatus.Installed&&await this.loadOrUnloadMod(e)}}async onEnter(){this.availableMods=[],this.controller.toggleMainVideo(!1),this.initForm();var e=await this.loadAvailableMods();e&&(this.availableMods=e,this.activeMod=this.availableMods.find((e=>e.id===this.activeModId)),this.selectedMod=this.activeMod,this.form.applyOptions((e=>{e.mods=this.availableMods,e.activeMod=this.activeMod,e.selectedMod=this.selectedMod})),this.initSidebar())}async loadAvailableMods(){try{var[e,t]=await Promise.all([this.modManager.listLocal(),this.modManager.listRemote().catch((e=>{console.warn("Failed to fetch remote mods",[e])}))]);return await this.modManager.buildModList(e,t)}catch(e){return e instanceof h.IOError||e instanceof u.FileNotFoundError||e instanceof l.StorageQuotaError||this.sentry?.captureException(new Error(`Failed to load mod list (${e.name??e.message})`,{cause:e})),void this.handleError(e,this.strings.get("GUI:ModListError"))}}initForm(){this.controller.setMainComponent(this.jsxRenderer.render(r.jsx(s.HtmlView,{innerRef:e=>this.form=e,component:d.ModSel,props:{strings:this.strings,mods:void 0,activeMod:void 0,selectedMod:void 0,onSelectMod:this.handleSelectMod}}))[0])}initSidebar(){this.updateSidebarButtons(),this.controller.showSidebarButtons()}updateSidebarButtons(){this.controller?.setSidebarButtons([{label:this.selectedMod&&this.selectedMod===this.activeMod?this.strings.get("GUI:UnloadMod"):this.selectedMod?.isInstalled()?this.strings.get("GUI:LoadMod"):this.strings.get("GUI:ModActionInstall"),disabled:!this.selectedMod,onClick:async()=>{var e=this.selectedMod;if(e.status===S.ModStatus.Installed||e===this.activeMod)await this.loadOrUnloadMod(e);else{var t=(e.meta.downloadSize||0)/1024/1024;if(e.meta.manualDownload){var r=e.status===S.ModStatus.UpdateAvailable,s=i.createElement(C.ModDownloadPrompt,{url:e.meta.download,sizeMb:t,isUpdate:r,strings:this.strings,onClick:()=>this.messageBoxApi.destroy()});r?await this.messageBoxApi.confirm(s,this.strings.get("GUI:Close"),this.strings.get("GUI:ModActionLoadAnyway"))||await this.loadOrUnloadMod(e):this.messageBoxApi.show(s,this.strings.get("GUI:Close"),(()=>{}))}else{let i,s=!1;if(e.status===S.ModStatus.UpdateAvailable){if(!await this.messageBoxApi.confirm(this.strings.get("GUI:ModUpdateAvail")+"\n\n"+this.strings.get("GUI:UpdateModPrompt",e.latestVersion,t),this.strings.get("GUI:ModActionUpdate"),this.strings.get("GUI:ModActionLoadAnyway")))return void await this.loadOrUnloadMod(e);s=!0}else if(10<t&&!await this.messageBoxApi.confirm(this.strings.get("GUI:InstallModDownloadPrompt",t),this.strings.get("GUI:Continue"),this.strings.get("GUI:Cancel")))return;try{i=await this.downloadMod(e)}catch(r){return r instanceof w.OperationCanceledError?void 0:void this.errorHandler.handle(r,this.strings.get("GUI:DownloadFailed"),(()=>{}))}this.messageBoxApi.destroy();try{await this.importModFromFile(i,e.status===S.ModStatus.UpdateAvailable)}catch(r){return void this.handleModImportError(r)}s&&await this.loadOrUnloadMod(e)}}}},{label:this.strings.get("GUI:ImportMod"),tooltip:this.strings.get("STT:ImportMod"),onClick:async()=>{try{let e;try{let t=await p.FileSystemUtil.showArchivePicker(this.fsAccessLib);e=await t.getFile()}catch(e){if("AbortError"===e.name)return;if(e instanceof DOMException)throw new h.IOError(`File could not be read (${e.name})`,{cause:e});throw e}await this.importModFromFile(e,!1)}catch(e){return void this.handleModImportError(e)}}},{label:this.strings.get("GUI:UninstallMod"),tooltip:this.strings.get("STT:UninstallMod"),disabled:!(this.selectedMod?.isInstalled()&&this.activeMod!==this.selectedMod),onClick:async()=>{var e=this.selectedMod;if(await this.messageBoxApi.confirm(this.strings.get("GUI:ConfirmUninstallMod",e.name),this.strings.get("GUI:Ok"),this.strings.get("GUI:Cancel"))){this.messageBoxApi.show(this.strings.get("GUI:WorkingPleaseWait"));try{await this.modManager.deleteModFiles(e.id)}catch(e){var t=e instanceof l.StorageQuotaError?this.strings.get("ts:storage_quota_exceeded"):this.strings.get("GUI:UninstallModError");return void this.errorHandler.handle(e,t,(()=>{}))}finally{this.messageBoxApi.destroy()}(t=await this.loadAvailableMods())&&(this.availableMods=t,this.selectedMod=void 0,this.form?.applyOptions((e=>{e.mods=this.availableMods,e.selectedMod=void 0})),this.updateSidebarButtons())}}},{label:this.strings.get("GUI:BrowseMod"),tooltip:this.strings.get("STT:BrowseMod"),onClick:()=>{this.controller?.pushScreen(a.ScreenType.OptionsStorage,{startIn:g.Engine.rfsSettings.modDir+(this.selectedMod?.isInstalled()?"/"+this.selectedMod.id:"")})}},...this.modSdkUrl?[{label:this.strings.get("GUI:ModSDK"),tooltip:this.strings.get("STT:ModSDK"),onClick:()=>{window.open(this.modSdkUrl,"_blank")}}]:[],{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.popScreen()}}])}async loadOrUnloadMod(e){await(this.controller?.hideSidebarButtons()),this.modManager.loadMod(e!==this.activeMod?e.id:void 0)}async downloadMod(e){var t=e.meta.download;if(!t)throw new Error("Mod meta is missing download");let i=new w.CancellationTokenSource;this.messageBoxApi.show(this.strings.get("TS:Downloading"),this.strings.get("GUI:Cancel"),(()=>i.cancel()));var r={id:"archive",src:t,type:"binary",sizeHint:e.meta.downloadSize};let s=await this.modResourceLoader.loadResources([r],i.token,(e=>{this.messageBoxApi.updateText(this.strings.get("TS:DownloadingPg",e))}));return t=s.pop("archive"),new File([t],this.modResourceLoader.getResourceFileName(r))}async importModFromFile(e,t){this.messageBoxApi.show(this.strings.get("ts:import_preparing_for_import"));var i=e=>{this.messageBoxApi.updateText(e)};let r;try{r=await new m.ModImporter(this.strings,this.messageBoxApi,navigator.storage).import(e,this.modManager.getModDir(),t,i)}finally{this.messageBoxApi.destroy()}if(r){let e=new b.Mod(r,void 0);e&&(-1!==(i=this.availableMods.findIndex((t=>t.id===e.id)))?this.availableMods.splice(i,1,e):this.availableMods.unshift(e),this.selectedMod=e,this.form?.applyOptions((t=>{t.mods=this.availableMods,t.selectedMod=e})),this.updateSidebarButtons())}}handleModImportError(e){let t=this.strings,i=t.get("GUI:ImportModError");e instanceof T.BadModArchiveError?i+="\n\n"+t.get("GUI:ImportModBadArchive"):e instanceof v.DuplicateModError?i+="\n\n"+t.get("GUI:ImportDuplicateModError"):e instanceof f.InvalidArchiveError?i+="\n\n"+t.get("ts:import_invalid_archive"):e instanceof y.ArchiveExtractionError?e.cause?.message?.match(/out of memory|allocation/i)?i+="\n\n"+t.get("ts:import_out_of_memory"):i+="\n\n"+t.get("ts:import_archive_extract_failed"):e.message?.match(/out of memory|allocation/i)?i+="\n\n"+t.get("ts:import_out_of_memory"):"QuotaExceededError"===e.name||e instanceof l.StorageQuotaError?i+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof h.IOError||e instanceof u.FileNotFoundError||this.sentry?.captureException(new Error("Mod import failed "+(e.message??e.name),{cause:e})),this.errorHandler.handle(e,i,(()=>{}))}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}async onLeave(){this.availableMods.length=0,this.form=void 0,this.messageBoxApi.destroy(),this.disposables.dispose(),this.controller.setMainComponent(),await this.controller.hideSidebarButtons()}handleError(e,t){this.errorHandler.handle(e,t,(()=>{this.rootController.goToScreen(n.ScreenType.MainMenuRoot)}))}},e("ModSelScreen",E)}}})),System.register("gui/screen/mainMenu/ladderRules/LadderRulesScreen",["gui/jsx/jsx","gui/jsx/HtmlView","gui/screen/mainMenu/MainMenuScreen","gui/screen/mainMenu/component/Iframe"],(function(e,t){"use strict";var i,r,s,n,a;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e}],execute:function(){a=class extends s.MainMenuScreen{constructor(e,t,i){super(),this.strings=e,this.jsxRenderer=t,this.rulesUrl=i,this.title=this.strings.get("GUI:Rules")}onEnter(){this.controller.setSidebarButtons([{label:this.strings.get("GUI:Back"),isBottom:!0,onClick:()=>{this.controller?.leaveCurrentScreen()}}]),this.controller.showSidebarButtons(),this.controller.toggleMainVideo(!1);var[e]=this.jsxRenderer.render(i.jsx(r.HtmlView,{width:"100%",height:"100%",component:n.Iframe,props:{src:this.rulesUrl,className:"ladder-rules"}}));this.controller.setMainComponent(e)}async onLeave(){await this.controller.hideSidebarButtons()}async onStack(){await this.onLeave()}onUnstack(){this.onEnter()}},e("LadderRulesScreen",a)}}})),System.register("Gui",["react","engine/Engine","gui/UiScene","engine/gfx/Renderer","game/rules/Rules","gui/screen/RootController","gui/screen/mainMenu/MainMenuRootScreen","gui/screen/game/GameScreen","gui/screen/game/gameMenu/ScreenType","gui/screen/mainMenu/ScreenType","gui/screen/ScreenType","gui/component/MessageBoxApi","network/WolConnection","network/GservConnection","network/gameopt/Parser","network/gameopt/Serializer","engine/ResourceLoader","ErrorHandler","engine/UiAnimationLoop","util/Logger","tools/DevToolsApi","gui/jsx/JsxRenderer","gui/Pointer","engine/sound/Sound","engine/sound/AudioSystem","engine/sound/Mixer","engine/sound/SoundSpecs","engine/sound/ChannelType","LocalPrefs","gui/screen/game/worldInteraction/keyboard/KeyBinds","gui/ReplayManager","gui/screen/replay/ReplayScreen","data/vfs/FileNotFoundError","engine/sound/Music","engine/sound/MusicSpecs","gui/screen/game/GameLoader","util/BoxedVar","engine/renderable/builder/vxlGeometry/VxlGeometryPool","engine/gfx/geometry/VxlGeometryCache","engine/gfx/RendererError","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMemStorage","data/vfs/StorageQuotaError","gui/CanvasMetrics","data/vfs/IOError","util/disposable/CompositeDisposable","gui/component/ToastApi","network/WolService","gui/screen/mainMenu/main/HomeScreen","gui/screen/mainMenu/lobby/SkirmishScreen","gui/screen/mainMenu/login/LoginScreen","gui/screen/mainMenu/newAccount/NewAccountScreen","gui/screen/mainMenu/customGame/CustomGameScreen","gui/screen/mainMenu/lobby/LobbyScreen","gui/screen/mainMenu/mapSel/MapSelScreen","gui/screen/replay/ReplaySelScreen","gui/screen/mainMenu/score/ScoreScreen","gui/screen/mainMenu/infoAndCredits/InfoAndCreditsScreen","gui/screen/mainMenu/credits/CreditsScreen","gui/screen/options/OptionsScreen","gui/screen/options/SoundOptsScreen","gui/screen/options/KeyboardScreen","gui/screen/options/StorageScreen","gui/screen/mainMenu/patchNotes/PatchNotesScreen","gui/screen/game/gameMenu/GameMenuHomeScreen","gui/screen/game/gameMenu/DiploScreen","gui/screen/game/gameMenu/ConnectionInfoScreen","gui/screen/game/gameMenu/QuitConfirmScreen","gui/screen/game/loadingScreen/LoadingScreenApiFactory","gui/screen/game/MapFileLoader","gui/screen/mainMenu/modSel/ModSelScreen","gui/screen/mainMenu/modSel/ModManager","network/WGameResConnection","gui/screen/mainMenu/quickGame/QuickGameScreen","network/WLadderService","gui/screen/mainMenu/ladder/LadderScreen","network/WolConfig","gui/screen/mainMenu/ladderRules/LadderRulesScreen"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee,te,ie,re,se,ne,ae,oe,le,ce,he,ue,de,ge,pe,me,fe,ye,Te,ve,be,Se,we,Ce,Ee,xe;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e},function(e){ee=e},function(e){te=e},function(e){ie=e},function(e){re=e},function(e){se=e},function(e){ne=e},function(e){ae=e},function(e){oe=e},function(e){le=e},function(e){ce=e},function(e){he=e},function(e){ue=e},function(e){de=e},function(e){ge=e},function(e){pe=e},function(e){me=e},function(e){fe=e},function(e){ye=e},function(e){Te=e},function(e){ve=e},function(e){be=e},function(e){Se=e},function(e){we=e},function(e){Ce=e},function(e){Ee=e},function(e){xe=e}],execute:function(){e("Gui",class{constructor(e,t,i,r,n,a,o,l,c,h,u,d,g,p,m,f,y,T){this.appVersion=e,this.engineVersion=t,this.engineModHash=i,this.gpuTier=r,this.config=n,this.gameResConfig=a,this.appResPath=o,this.localPrefs=l,this.generalOptions=c,this.rootEl=h,this.viewport=u,this.fullScreen=d,this.strings=g,this.cdnResourceLoader=p,this.fsAccessLib=m,this.serverRegions=f,this.runtimeVars=y,this.sentry=T,this.disposables=new q.CompositeDisposable,this.handleFullScreenChange=e=>{e&&this.pointer?.getUserLockMode()&&this.pointer.lock()},this.handleViewportChange=e=>{var t;this.renderer?.setViewportSize(e.width,e.height),this.uiScene&&(t=s.UiScene.createCamera(this.viewport.value),this.uiScene.setCamera(t),this.uiScene.setViewport(this.viewport.value),this.jsxRenderer?.setCamera(t),this.messageBoxApi?.updateViewport(this.viewport.value),this.rootController?.rerenderCurrentScreen(),this.canvasMetrics?.notifyViewportChange())}}getRootController(){if(!this.rootController)throw new Error("Root controller is not initialized");return this.rootController}async init(e){let t,i,n=this.strings;try{({renderer:t,uiAnimationLoop:i}=this.initRenderer(this.rootEl,this.viewport.value,this.config.devMode))}catch(e){if(e instanceof H.RendererError)return console.error(e.cause),void alert(n.get("TS:RendererInitError"));throw e}this.renderer=t,this.viewport.onChange.subscribe(this.handleViewportChange),this.disposables.add((()=>this.viewport.onChange.unsubscribe(this.handleViewportChange))),this.fullScreen.onChange.subscribe(this.handleFullScreenChange),this.disposables.add((()=>this.fullScreen.onChange.unsubscribe(this.handleFullScreenChange)));var b=this.gameResConfig;let w=s.UiScene.factory(this.viewport.value),x=this.canvasMetrics=new z.CanvasMetrics(t.getCanvas(),window);x.init(),this.disposables.add(x);let O=this.pointer=E.Pointer.factory(r.Engine.getImages().get("mouse.shp"),r.Engine.getPalettes().get("mousepal.pal"),t,document,x,this.generalOptions.mouseAcceleration);O.init(),this.disposables.add(O),w.add(O.getSprite());var A=this.jsxRenderer=new C.JsxRenderer(r.Engine.getImages(),r.Engine.getPalettes(),w.camera,O.pointerEvents);this.toastApi=new $.ToastApi(this.viewport,w,A),this.disposables.add(this.toastApi),this.messageBoxApi=new g.MessageBoxApi(this.viewport.value,w,A);var M=new v.ErrorHandler(this.messageBoxApi,n),R=new f.Parser,N=new y.Serializer;let L=this.rootController=new o.RootController(this.serverRegions);var q=r.Engine.getMpModes(),Oe=r.Engine.getFileNameVariant("keyboard.ini");let Ae=new I.KeyBinds(r.Engine.rfs?.getRootDirectory(),Oe,r.Engine.getIni(Oe));await Ae.load();var Me=await r.Engine.getReplayDir().catch((e=>{console.error("Couldn't get replay directory",[e]),e instanceof W.StorageQuotaError||e instanceof K.IOError||e instanceof j.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get replay directory (${e.name})`,{cause:e}))})),Re=Me?new G.ReplayStorageFileSystem(Me,this.sentry):new V.ReplayStorageMemStorage,Pe=new k.ReplayManager(Re);let Ie=this.generalOptions;var ke=new T.ResourceLoader(this.config.mapsBaseUrl),Be=new T.ResourceLoader(this.appResPath),je=new T.ResourceLoader(this.config.modsBaseUrl),Ne=new ye.MapFileLoader(ke,r.Engine.vfs),Le=S.AppLogger.get("net"),De=Ee.WolConfig.factory(this.config.wolv2Compat?Ee.ClientType.Yuri:Ee.ClientType.Cdral2),Fe=p.WolConnection.factory(Le);let _e=new Q.WolService(De,Fe,this.appVersion);_e.init(),this.disposables.add(_e);var Ue=new we.WLadderService(De,Le),He=r.Engine.getMapList(),Ge=await r.Engine.getModDir().catch((e=>{console.error("Couldn't get mods directory",[e]),e instanceof W.StorageQuotaError||e instanceof K.IOError||e instanceof j.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get mods directory (${e.name})`,{cause:e}))}));let Ve=Ge?new ve.ModManager(window.location,Ge,Be):void 0;var We=r.Engine.getActiveMod(),ze=We?await(Ve?.loadModMeta(We)):void 0;Oe=await r.Engine.getMapDir().catch((e=>{console.error("Couldn't get map dir",[e])})),Me=S.AppLogger.get("ini");let Ke;try{Ke=new a.Rules(r.Engine.getRules(),Me)}catch(e){if(We&&Ve)return console.error(e),t.addScene(w),this.uiScene=w,this.rootEl.appendChild(w.getHtmlContainer().getElement()),await this.messageBoxApi.alert(n.get("TS:ModLoadError"),n.get("GUI:Ok")),void Ve.loadMod(void 0);throw e}var{mixer:Re,sound:ke,music:De}=await this.initSound(Ke,b);let qe=(new Map).set(u.ScreenType.Home,new Z.HomeScreen(n,this.fullScreen,this.appVersion,!(!r.Engine.rfs||!Ge),!r.Engine.getActiveMod()&&this.config.quickMatchEnabled)).set(u.ScreenType.Skirmish,new Y.SkirmishScreen(this.config.botsEnabled,L,M,this.messageBoxApi,n,Ke,A,Ne,He,q,this.localPrefs)).set(u.ScreenType.Login,new X.LoginScreen(_e,Ue,n,A,this.messageBoxApi,this.serverRegions,this.config.serversUrl,this.config.breakingNewsUrl,Le,M,this.localPrefs,L)).set(u.ScreenType.NewAccount,new J.NewAccountScreen(_e,Ue,n,A,this.messageBoxApi,this.serverRegions,M,this.localPrefs,L)).set(u.ScreenType.QuickGame,new Se.QuickGameScreen(this.config.unrankedQueueEnabled,this.engineModHash,Ke,_e,Fe,Ue,this.serverRegions,Ne,He,L,this.messageBoxApi,A,n,this.localPrefs,ke,M)).set(u.ScreenType.Ladder,new Ce.LadderScreen(Ue,A,M,n)).set(u.ScreenType.CustomGame,new ee.CustomGameScreen(this.engineModHash,n,Fe,_e,Ue,A,ke,this.serverRegions,He,M)).set(u.ScreenType.Lobby,new te.LobbyScreen(this.engineModHash,ze,L,M,this.messageBoxApi,n,w,Fe,_e,Ue,Ke,R,N,A,Ne,He,q,ke,this.localPrefs)).set(u.ScreenType.MapSelection,new ie.MapSelScreen(n,A,Ne,M,this.messageBoxApi,this.localPrefs,He,q,Oe,this.fsAccessLib,this.sentry)).set(u.ScreenType.ReplaySelection,new re.ReplaySelScreen(this.engineVersion,this.engineModHash,We,this.config.oldClientsBaseUrl,L,n,A,M,this.messageBoxApi,Pe,w,Ke,this.sentry)).set(u.ScreenType.Score,new se.ScoreScreen(n,A,this.messageBoxApi,this.localPrefs,this.config,Ue)).set(u.ScreenType.InfoAndCredits,new ne.InfoAndCreditsScreen(n,this.config,this.messageBoxApi)).set(u.ScreenType.Credits,new ae.CreditsScreen(n,A)).set(u.ScreenType.Options,new oe.OptionsScreen(n,A,Ie,this.localPrefs,this.fullScreen,!1,!!r.Engine.rfs)).set(u.ScreenType.OptionsSound,new le.SoundOptsScreen(n,A,Re,void 0,this.localPrefs)).set(u.ScreenType.OptionsKeyboard,new ce.KeyboardScreen(n,A,Ae)).set(u.ScreenType.OptionsStorage,new he.StorageScreen(n,A,this.messageBoxApi,r.Engine.rfs));Ve&&qe.set(u.ScreenType.ModSelection,new Te.ModSelScreen(L,n,A,M,this.messageBoxApi,Ve,r.Engine.getActiveMod(),this.config.modSdkUrl,je,this.fsAccessLib,this.sentry)),this.config.patchNotesUrl&&qe.set(u.ScreenType.PatchNotes,new ue.PatchNotesScreen(n,A,this.config.patchNotesUrl)),this.config.ladderRulesUrl&&qe.set(u.ScreenType.LadderRules,new xe.LadderRulesScreen(n,A,this.config.ladderRulesUrl)),Fe=await this.getMainMenuVideoUrl(b,Ge),We=new l.MainMenuRootScreen(qe,w,b,n,r.Engine.getImages(),A,Fe,this.cdnResourceLoader,ke,De,this.sentry),Ue=new U.VxlGeometryCache(await r.Engine.getCacheDir(),r.Engine.getActiveMod());let $e=new _.VxlGeometryPool(Ue,Ie.graphics.models.value);Ie.graphics.models.onChange.subscribe((e=>{$e.setModelQuality(e),$e.clear(),$e.clearStorage().catch((e=>console.warn("Couldn't clear VXL geocache",[e])))})),je=window.CDWorkerHostLib,Ge=new F.BoxedVar(!1),Fe=new Map,Ue=S.AppLogger.get("action"),Be=new D.GameLoader(je,this.cdnResourceLoader,Be,Ke,q,ke,Me,Ue,Ge,b,$e,Fe,this.config.botsEnabled,this.runtimeVars.debugBotIndex),Me=new Set;let Qe=new F.BoxedVar(Boolean(Number(this.localPrefs.getItem(P.StorageKey.TauntsEnabled)??"1")));const Ze=e=>{this.localPrefs.setItem(P.StorageKey.TauntsEnabled,String(Number(e)))};Qe.onChange.subscribe(Ze),this.disposables.add((()=>Qe.onChange.unsubscribe(Ze))),q=(new Map).set(h.ScreenType.Home,new de.GameMenuHomeScreen(n,this.fullScreen)).set(h.ScreenType.Diplo,new ge.DiploScreen(n,A,t,q,Qe,Me)).set(h.ScreenType.ConnectionInfo,new pe.ConnectionInfoScreen(n,A)).set(h.ScreenType.QuitConfirm,new me.QuitConfirmScreen(n)).set(h.ScreenType.Options,new oe.OptionsScreen(n,A,Ie,this.localPrefs,this.fullScreen,!0,!1)).set(h.ScreenType.OptionsSound,new le.SoundOptsScreen(n,A,Re,De,this.localPrefs)).set(h.ScreenType.OptionsKeyboard,new ce.KeyboardScreen(n,A,Ae)),Re=m.GservConnection.factory(Le),Le=be.WGameResConnection.factory(Le),b=new fe.LoadingScreenApiFactory(Ke,n,w,A,b,Re),Ge=new c.GameScreen(je,Re,Le,_e,this.engineVersion,this.engineModHash,M,q,b,R,N,this.config,n,t,w,this.runtimeVars,this.messageBoxApi,this.toastApi,i,this.viewport,A,O,ke,De,Ae,Ie,this.localPrefs,Ue,Pe,this.fullScreen,Ne,Oe,He,Be,$e,Fe,Me,Qe,Ge,this.sentry),Fe=new B.ReplayScreen(this.engineVersion,this.engineModHash,M,q,b,this.config,n,t,w,this.runtimeVars,this.messageBoxApi,i,this.viewport,A,O,ke,De,Ae,Ie,Ue,this.fullScreen,Ne,Be,$e,Fe,(()=>{void 0!==e?(window.close(),(async()=>{await this.destroy(),document.body.appendChild(document.createTextNode(n.get("GUI:ReplayWindowClose")))})()):L.goToScreen(d.ScreenType.MainMenuRoot)})),L.addScreen(d.ScreenType.MainMenuRoot,We),L.addScreen(d.ScreenType.Game,Ge),L.addScreen(d.ScreenType.Replay,Fe),t.addScene(w),this.uiScene=w,this.rootEl.appendChild(w.getHtmlContainer().getElement()),await this.routeToInitialScreen(L,Ie,De,ke,e,Pe)}async getMainMenuVideoUrl(e,t){let i,s=r.Engine.rfsSettings.menuVideoFileName;if(e.isCdn())i=e.getCdnBaseUrl()+s.replace(".webm",".mp4");else try{let e;t&&await t.containsEntry(s)&&(e=await t.getRawFile(s)),!e&&await(r.Engine.rfs?.containsEntry(s))&&(e=await r.Engine.rfs.getRawFile(s)),!e&&r.Engine.vfs?.fileExists(s)&&(e=r.Engine.vfs.openFile(s).asFile()),i=e?new File([e],e.name,{type:"video/webm"}):(console.warn("Main menu video file not found in browser FS"),"")}catch(e){console.error("Failed to read video file from browser FS"),i=""}return i}async routeToInitialScreen(e,t,i,r,s,n){let a=!1;var o=this.localPrefs.getItem(P.StorageKey.LastConnection);let l,c;if(o)try{l=JSON.parse(o)}catch(e){console.error(`Unable to decode game params string "${o}"`)}if(l){var h=await this.messageBoxApi.confirm(this.strings.get("TS:ReconnectPrompt"),this.strings.get("TS:Reconnect"),this.strings.get("GUI:Quit"));if(a=!0,h)return l.create=!1,void e.goToScreen(d.ScreenType.Game,l);this.localPrefs.removeItem(P.StorageKey.LastConnection)}if(void 0!==(o=this.gpuTier)&&(h=this.localPrefs.getItem(P.StorageKey.LastGpuTier),2<=o?void 0!==h&&Number(h)!==o&&(await this.confirmHighGfxSettings()&&(t.graphics.applyHighPreset(),this.localPrefs.setItem(P.StorageKey.Options,t.serialize())),a=!0):(void 0===h||2<=Number(h))&&(await this.confirmLowGfxSettings()&&(t.graphics.applyLowPreset(),this.localPrefs.setItem(P.StorageKey.Options,t.serialize())),a=!0),this.localPrefs.setItem(P.StorageKey.LastGpuTier,""+o)),i&&!a&&(!r.audioSystem.isSuspended()&&await r.audioSystem.canAutoPlay()||await this.messageBoxApi.alert(this.strings.get("GUI:RequestAudioPermission"),this.strings.get("GUI:OK"))),void 0!==s)try{var u=(await n.loadList()).find((e=>e.id===s));if(!u)throw new Error(`Replay ID "${s}" not found`);c=await n.loadReplay(u)}catch(e){await this.messageBoxApi.alert(this.strings.get("GUI:ReplayError"),this.strings.get("GUI:Ok"))}c?e.goToScreen(d.ScreenType.Replay,{replay:c}):e.goToScreen(d.ScreenType.MainMenuRoot)}async confirmLowGfxSettings(){return await this.messageBoxApi.confirm(i.default.createElement("div",{dangerouslySetInnerHTML:{__html:this.strings.get("TS:RendererWarning").replace(/\n/g,"<br />").replace("{link}",'<a href="https://www.windowsdigitals.com/force-chrome-firefox-game-to-use-nvidia-gpu-integrated-graphics/" target="_blank" rel="noreferrer noopener">').replace("{/link}","</a>")}}),this.strings.get("TS:RendererUseLow"),this.strings.get("TS:RendererIgnore"))}async confirmHighGfxSettings(){return await this.messageBoxApi.confirm(this.strings.get("TS:RendererChangeDesc"),this.strings.get("GUI:Yes"),this.strings.get("GUI:No"))}initRenderer(e,t,i){var{width:r,height:s}=t;let a=new n.Renderer(r,s);a.init(e),this.disposables.add(a),w.DevToolsApi.registerVar("fps",this.runtimeVars.fps),this.disposables.add((()=>w.DevToolsApi.unregisterVar("fps"))),this.runtimeVars.fps.onChange.subscribe((t=>{t?a.initStats(e):a.destroyStats()})),i&&(this.runtimeVars.fps.value=!0),this.runtimeVars.fps.value&&a.initStats(e);let o=new b.UiAnimationLoop(a);return o.start(),this.disposables.add(o),e.addEventListener("contextmenu",(e=>{"A"===e.target.nodeName&&e.target.href.length||e.preventDefault()})),i||window.addEventListener("beforeunload",(e=>{this.rootController?.getCurrentScreen()?.preventUnload&&(e.preventDefault(),e.returnValue="")})),a.getCanvas().addEventListener("mousedown",(e=>{e.preventDefault()})),{renderer:a,uiAnimationLoop:o}}async initSound(e,t){let i;var s=this.localPrefs.getItem(P.StorageKey.Mixer);if(s)try{i=(new A.Mixer).unserialize(s)}catch(e){console.warn("Failed to read mixer values from local storage",[e])}i||(i=new A.Mixer,i.setVolume(R.ChannelType.Master,.4),i.setVolume(R.ChannelType.CreditTicks,.2),i.setVolume(R.ChannelType.Music,.3),i.setVolume(R.ChannelType.Ambient,.3));let n,a,o=new x.Sound(new O.AudioSystem(i),r.Engine.getSounds(),new M.SoundSpecs(r.Engine.getIni("sound.ini")),e.audioVisual,document);o.initialize(),this.disposables.add(o);try{n=!!await(r.Engine.rfs?.containsEntry(r.Engine.rfsSettings.musicDir))}catch(e){console.error("Couldn't get music directory",[e]),e instanceof W.StorageQuotaError||e instanceof K.IOError||e instanceof j.FileNotFoundError||this.sentry?.captureException(new Error(`Couldn't get music directory (${e.name})`,{cause:e})),n=!1}if(n&&(a=new N.Music(o.audioSystem,r.Engine.getThemes(),new L.MusicSpecs(r.Engine.getIni(r.Engine.getFileNameVariant("theme.ini")))),this.disposables.add(a),s=this.localPrefs.getItem(P.StorageKey.MusicOpts)))try{a.unserializeOptions(s)}catch(e){console.warn("Failed to read music options from local storage",[e])}return{mixer:i,sound:o,music:a}}async destroy(){this.messageBoxApi&&(this.messageBoxApi.destroy(),this.messageBoxApi=void 0),this.rootController&&(await this.rootController.leaveCurrentScreen(),this.rootController.destroy()),this.uiScene&&(this.rootEl.removeChild(this.uiScene.getHtmlContainer().getElement()),this.uiScene.destroy()),this.disposables.dispose()}})}}})),System.register("Application",["fontfaceobserver","detect-gpu","@puzzl/core/lib/async/cancellation","engine/Engine","gui/component/SplashScreen","network/WolConnection","network/gameopt/Parser","Config","util/Routing","tools/LobbyFormTester","tools/VxlTester","tools/ShpTester","tools/BuildingTester","data/IniFile","util/time","engine/ResourceLoader","ConsoleVars","util/Logger","tools/DevToolsApi","tools/VehicleTester","tools/InfantryTester","tools/AircraftTester","tools/SoundTester","LocalPrefs","gui/FullScreen","version","data/Strings","network/ServerRegions","gui/screen/options/GeneralOptions","engine/gameRes/GameResConfig","gui/component/BasicErrorBoxApi","engine/gameRes/GameRes","engine/gameRes/importError/FileNotFoundError","engine/gameRes/importError/InvalidArchiveError","engine/gameRes/importError/ArchiveExtractionError","engine/gameRes/importError/ChecksumError","engine/gameRes/importError/NoStorageError","data/MapFile","gui/component/ImageContext","util/BoxedVar","gui/replay/ReplayStorageFileSystem","gui/replay/ReplayStorageMigration","data/vfs/StorageQuotaError","Gui","data/vfs/IOError","network/WolService","data/vfs/FileNotFoundError","RouteHelper","data/CsfFile","util/Sentry","engine/gameRes/importError/NoWebAssemblyError","network/WolConfig"],(function(e,t){"use strict";var i,r,s,n,a,o,l,c,h,u,d,g,p,m,f,y,T,v,b,S,w,C,E,x,O,A,M,R,P,I,k,B,j,N,L,D,F,_,U,H,G,V,W,z,K,q,$,Q,Z,Y,X,J,ee;return t&&t.id,{setters:[function(e){i=e},function(e){r=e},function(e){s=e},function(e){n=e},function(e){a=e},function(e){o=e},function(e){l=e},function(e){c=e},function(e){h=e},function(e){u=e},function(e){d=e},function(e){g=e},function(e){p=e},function(e){m=e},function(e){f=e},function(e){y=e},function(e){T=e},function(e){v=e},function(e){b=e},function(e){S=e},function(e){w=e},function(e){C=e},function(e){E=e},function(e){x=e},function(e){O=e},function(e){A=e},function(e){M=e},function(e){R=e},function(e){P=e},function(e){I=e},function(e){k=e},function(e){B=e},function(e){j=e},function(e){N=e},function(e){L=e},function(e){D=e},function(e){F=e},function(e){_=e},function(e){U=e},function(e){H=e},function(e){G=e},function(e){V=e},function(e){W=e},function(e){z=e},function(e){K=e},function(e){q=e},function(e){$=e},function(e){Q=e},function(e){Z=e},function(e){Y=e},function(e){X=e},function(e){J=e}],execute:function(){e("Application",ee=class e{constructor(){this.viewport=new H.BoxedVar({x:0,y:0,width:0,height:0})}getVersion(){return A.version}getEngineVersion(){return n.Engine.getVersion()}getEngineModHash(){return n.Engine.getModHash()}async main(){try{await this.loadConfig()}catch(c){return void console.error("Missing config.ini. Please see README.md")}var t=this.config.defaultLanguage;let r;try{r=await this.loadTranslations(t)}catch(c){return void console.error(`Missing translation ${t}.`,c)}let s=new M.Strings(r);try{this.checkGlobalLibs()}catch(c){return console.error(c),void alert(s.get("TS:DownloadFailed"))}this.localPrefs=new x.LocalPrefs(localStorage);var o=document.getElementById("ra2web-root");if(!o)throw new Error("Missing root element");this.rootEl=o,this.runtimeVars=new T.ConsoleVars,b.DevToolsApi.registerCommand("help",(()=>{console.info("Available commands: "),[...b.DevToolsApi.listCommands()].forEach((e=>console.info("> "+e))),console.info("Available variables: "),[...b.DevToolsApi.listVars()].forEach((e=>console.info("> "+e)))})),b.DevToolsApi.registerVar("freecamera",this.runtimeVars.freeCamera),this.runtimeVars.forceResolution.onChange.subscribe((e=>{var t,i;e?.match(/^\d+x\d+$/)&&([t,i]=e?.split("x").map(Number),this.setPreferredViewportSize({width:t,height:i}))})),b.DevToolsApi.registerVar("forcesize",this.runtimeVars.forceResolution),b.DevToolsApi.registerVar("debug_wireframes",this.runtimeVars.debugWireframes),b.DevToolsApi.registerVar("debug_paths",this.runtimeVars.debugPaths),b.DevToolsApi.registerVar("debug_text",this.runtimeVars.debugText),b.DevToolsApi.registerVar("debug_bot",this.runtimeVars.debugBotIndex),await this.initLogging(),this.fullScreen=new O.FullScreen(document),this.fullScreen.init(),this.fullScreen.onChange.subscribe((e=>{this.onFullScreenChange(e),this.updateViewportSize(e)})),window.addEventListener("resize",(()=>this.updateViewportSize(this.fullScreen.isFullScreen()))),this.updateViewportSize(this.fullScreen.isFullScreen());let l=new a.SplashScreen(this.viewport.value.width,this.viewport.value.height);this.splashScreen=l,l.render(this.rootEl),l.setLoadingText(s.get("GUI:LoadingEx")),l.setCopyrightText(s.get("TXT_COPYRIGHT")+"\n"+s.get("GUI:WWBrand")),l.setDisclaimerText(s.get("TS:Disclaimer"));var c=f.sleep(this.config.devMode?0:5e3);let h;this.loadGpuBenchmarkData().then((e=>this.gpuTier=e)).catch((e=>this.sentry?.captureException(e)));try{h=this.fsAccessLib=await SystemJS.import("file-system-access")}catch(c){return console.error(c),l.setLoadingText(""),l.setBackgroundImage(""),void this.handleGameResLoadError(new y.DownloadError("Failed to download fsa lib",{cause:c}),s,!0)}var u=new URLSearchParams(location.search).get(Q.RouteHelper.modQueryStringName)||void 0;let d=this.loadGameResConfig(this.localPrefs);try{let{configToPersist:t,cdnResLoader:i}=await new B.GameRes(this.getVersion(),u,h,this.localPrefs,s,o,l,this.viewport,this.config,e.resPath,this.sentry).init(d,((e,t)=>this.handleGameResLoadError(e,t)),((e,t)=>this.handleGameResImportError(e,t)));t&&(t.isCdn()?this.localPrefs.removeItem(x.StorageKey.GameRes):this.localPrefs.setItem(x.StorageKey.GameRes,t.serialize()),d=t),this.cdnResourceLoader=i}catch(c){return console.error(c),l.setLoadingText(""),l.setBackgroundImage(""),void this.handleGameResLoadError(c,s,!0)}this.gameResConfig=d,window.gtag?.("event","app_init",{res:this.gameResConfig.source,modName:n.Engine.getActiveMod()||"<none>"}),U.ImageContext.cdnBaseUrl=this.gameResConfig.isCdn()?this.gameResConfig.getCdnBaseUrl():void 0,U.ImageContext.vfs=n.Engine.vfs;try{let e=new Z.CsfFile(n.Engine.vfs.openFile(n.Engine.getFileNameVariant("ra2.csf")));var g=e.getIsoLangCode();if(void 0!==g&&g!==t)try{r=await this.loadTranslations(g)}catch(c){console.warn(`Failed to load translation ${g}. Falling back to ${t}.`,c)}s=this.strings=new M.Strings(e),s.fromJson(r),n.Engine.loadRules(),this.sentry?.configureScope((e=>{e.setTag("mod",n.Engine.getActiveMod()),e.setExtra("mod",n.Engine.getActiveMod()||"<none>"),e.setExtra("modHash",n.Engine.getModHash())})),window.AudioContext||(window.AudioContext=(await SystemJS.import("web-audio-polyfill.js")).AudioContext)}catch(c){return console.error(c),l.setLoadingText(""),l.setBackgroundImage(""),void this.handleGameResLoadError(c,s,!0)}try{await new i.default("Fira Sans Condensed").load(),await new i.default("Fira Sans Condensed",{weight:"bold"}).load()}catch(c){console.error("Failed to load font",c)}try{await this.migrateReplayStorage(this.localPrefs,l,s)}catch(c){l.setLoadingText(""),c instanceof W.StorageQuotaError||c instanceof K.IOError||c instanceof $.FileNotFoundError||this.sentry?.captureException(new Error("Failed to migrate replays to new storage",{cause:c})),console.error("Failed to migrate replays to new storage",c)}await c,l.destroy(),this.splashScreen=void 0,this.initRouting()}async loadTranslations(t){return await new y.ResourceLoader(e.resPath).loadJson(`locale/${t}.json?v=`+this.getVersion())}checkGlobalLibs(){var e,t;for([e,t]of new Map([["CDWorkerHostLib",()=>window.CDWorkerHostLib],["THREE",()=>window.THREE],["Octree",()=>window.Octree],["SimplexNoise",()=>window.SimplexNoise],["LightningStrike",()=>window.THREE.LightningStrike],["TrailRenderer",()=>window.THREE.TrailRenderer],["SPE",()=>window.SPE],["GrowingPacker",()=>window.GrowingPacker],["lzo1x",()=>window.lzo1x]])){let i=!1;try{void 0!==t()&&(i=!0)}catch(e){}if(!i)throw new Error(`Library "${e}" was not found on window scope`)}}async loadConfig(){let e=await new y.ResourceLoader("").loadText("config.ini");if(e.startsWith("<"))throw new Error("Config download failed. Response looks like an HTML document.");var t=(new m.IniFile).fromString(e);this.config=new c.Config,this.config.load(t)}async initLogging(){v.AppLogger.useDefaults(),b.DevToolsApi.registerVar("debug_logging",this.runtimeVars.debugLogging);var e=e=>{var t;if("string"!=typeof e)v.AppLogger.setLevel(Boolean(e)?v.AppLogger.DEBUG:v.AppLogger.INFO);else for(t of e.split(","))v.AppLogger.get(t).setLevel(v.AppLogger.DEBUG)};if(e(this.runtimeVars.debugLogging.value),this.runtimeVars.debugLogging.onChange.subscribe(e),e=this.config.sentry)try{this.sentry=new Y.Sentry,await this.sentry.init(e,this.getVersion())}catch(e){console.error(e)}}loadGameResConfig(e){var t=e.getItem(x.StorageKey.GameRes);if(t){let e=new I.GameResConfig(this.config.gameresBaseUrl??"");return e.unserialize(t),e.isCdn()&&!e.getCdnBaseUrl()?void 0:e}}async handleGameResLoadError(e,t,i=!1){let r=new k.BasicErrorBoxApi(this.viewport,t,this.rootEl),s=t.get("ts:import_load_files_failed");e instanceof D.ChecksumError?s+="\n\n"+t.get("ts:import_checksum_mismatch",e.file):e instanceof j.FileNotFoundError?s+="\n\n"+t.get("ts:import_file_not_found",e.file):e instanceof y.DownloadError||e.message?.match(/XHR error|Failed to fetch/i)?s+="\n\n"+t.get("ts:downloadfailed"):e instanceof F.NoStorageError?s+="\n\n"+t.get("ts:import_no_storage"):e.message?.match(/out of memory|allocation/i)?s+="\n\n"+t.get("ts:gameinitoom"):"QuotaExceededError"===e.name||e instanceof W.StorageQuotaError?s+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof K.IOError?(s+="\n\n"+t.get("ts:storage_io_error"),i=!0):e instanceof $.FileNotFoundError||this.sentry?.captureException(new Error(`Game res load failed (${e.message??e.name})`,{cause:e})),await r.show(s,i)}async handleGameResImportError(e,t){let i=new k.BasicErrorBoxApi(this.viewport,t,this.rootEl),r=t.get("ts:import_failed");e instanceof j.FileNotFoundError?r+="\n\n"+t.get("ts:import_file_not_found",e.file):e instanceof N.InvalidArchiveError?r+="\n\n"+t.get("ts:import_invalid_archive"):e instanceof L.ArchiveExtractionError?e.cause?.message?.match(/out of memory|allocation/i)?r+="\n\n"+t.get("ts:import_out_of_memory"):(r+="\n\n"+t.get("ts:import_archive_extract_failed"),this.sentry?.captureException(new Error(`Game res import failed (${e.message??e.name})`,{cause:e}))):e instanceof X.NoWebAssemblyError?r+="\n\n"+t.get("ts:import_no_web_assembly"):e instanceof D.ChecksumError?r+="\n\n"+t.get("ts:import_checksum_mismatch",e.file):e instanceof y.DownloadError||e.message?.match(/XHR error|Failed to fetch|CompileError: WebAssembly|SystemJS/i)?r+="\n\n"+t.get("ts:downloadfailed"):e instanceof F.NoStorageError?r+="\n\n"+t.get("ts:import_no_storage"):e.message?.match(/out of memory|allocation/i)?r+="\n\n"+t.get("ts:import_out_of_memory"):"QuotaExceededError"===e.name||e instanceof W.StorageQuotaError?r+="\n\n"+t.get("ts:storage_quota_exceeded"):e instanceof K.IOError||e instanceof $.FileNotFoundError||this.sentry?.captureException(new Error("Game res import failed "+(e.message??e.name),{cause:e})),await i.show(r)}async loadGpuBenchmarkData(){let e=!1;var t=await r.getGPUTier({override:{loadBenchmarks:async t=>{let i=new s.CancellationTokenSource;var r=setTimeout((()=>i.cancel()),5e3);try{let e=await new y.ResourceLoader("").loadJson("https://unpkg.com/detect-gpu@3.0.0/dist/benchmarks/"+t,i.token);return e.shift(),e}catch(r){throw e=!0,r}finally{clearTimeout(r)}}}});return e?void 0:t.tier}async migrateReplayStorage(e,t,i){var r,s=await n.Engine.getReplayDir();s&&(r=new G.ReplayStorageFileSystem(s,this.sentry),await new V.ReplayStorageMigration(t,i,s,e,r).migrate())}initRouting(){let e,t=new h.Routing;t.addRoute("*",(async()=>{e&&await e.destroy()})),t.addRoute("/",(async()=>{var t=new R.ServerRegions;this.gui=await this.initGui(t,this.strings),e=this})),t.addRoute("/game",(async t=>{let i=new R.ServerRegions;if(this.gui=await this.initGui(i,this.strings),this.gui){let c=this.gui.getRootController();if(e=this,await f.sleep(1e3),t.length<2){var[r]=t;if(r){var s=decodeURIComponent(`0,0,0,10000,10,1,0,0,0,0,1,0,0,8,0,374465,${r},DFr2T1EU7PlayAbdzMaSX/f4j+E=:Player1,-2,-2,-2,-2,0,0,0,Player2,-2,-2,-2,-2,0,0,0:@:0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,0,-1,-1,-2,-2,`);let e=(new l.Parser).parseOptions(decodeURIComponent(s));e.gameSpeed=5,e.mcvRepacks=!0,e.gameMode=4,c.createGame(0,Date.now(),"Player1",e,!0,!1)}}else{var n=o.WolConnection.factory(v.AppLogger.get("net")),a=J.WolConfig.factory(this.config.wolv2Compat?J.ClientType.Yuri:J.ClientType.Cdral2);let e=new q.WolService(a,n,this.getVersion());i.load(await e.loadServerList(this.config.serversUrl)),s=(r=this.localPrefs.getItem(x.StorageKey.PreferredServerRegion))&&i.isAvailable(r)?i.get(r):i.getFirstAvailable(),i.setSelectedRegion(s.id);var[a,n,r,s]=t;a=Number(a),s=Boolean(Number(s||0));r?(r=(new l.Parser).parseOptions(decodeURIComponent(r)),c.createGame(a,0,n,r,!1,s)):c.joinGame(a,0,n,s)}}})),t.addRoute("/replay",(async t=>{e=this;var[i]=t,r=new R.ServerRegions;this.gui=await this.initGui(r,this.strings,void 0!==i?i:void 0)})),t.addRoute("/lobbytest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");u.LobbyFormTester.main(this.rootEl,this.strings),e=u.LobbyFormTester})),t.addRoute("/vxltest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");d.VxlTester.main(n.Engine.vfs,this.runtimeVars),e=d.VxlTester})),t.addRoute("/shptest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");var t=new _.MapFile(n.Engine.vfs.openFile("mp03t4.map"));g.ShpTester.main(n.Engine.vfs,t,this.rootEl,this.strings),e=g.ShpTester})),t.addRoute("/buildtest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");p.BuildingTester.main(this.runtimeVars),e=p.BuildingTester})),t.addRoute("/vehicletest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");S.VehicleTester.main(this.runtimeVars),e=S.VehicleTester})),t.addRoute("/airtest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");C.AircraftTester.main(this.runtimeVars),e=C.AircraftTester})),t.addRoute("/inftest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");w.InfantryTester.main(this.runtimeVars),e=w.InfantryTester})),t.addRoute("/soundtest",(async()=>{if(!n.Engine.vfs)throw new Error("Original game files must be provided.");E.SoundTester.main(n.Engine.vfs,this.runtimeVars),e=E.SoundTester})),t.init()}async initGui(t,i,r){var s=this.localPrefs.getItem(x.StorageKey.Options);let n;if(s)try{n=(new P.GeneralOptions).unserialize(s)}catch(t){console.warn("Couldn't read options from local storage",[t])}n||(n=new P.GeneralOptions,n.graphics.resolution.value={width:this.config.viewport.width,height:this.config.viewport.height}),this.setPreferredViewportSize(n.graphics.resolution.value),n.graphics.resolution.onChange.subscribe((e=>{this.setPreferredViewportSize(e)}));let a=new z.Gui(this.getVersion(),this.getEngineVersion(),this.getEngineModHash(),this.gpuTier,this.config,this.gameResConfig,e.resPath,this.localPrefs,n,this.rootEl,this.viewport,this.fullScreen,i,this.cdnResourceLoader,this.fsAccessLib,t,this.runtimeVars,this.sentry);try{await a.init(r)}catch(t){let e;return console.error("Failed to initialize GUI",[t]),t instanceof W.StorageQuotaError||t instanceof K.IOError||t instanceof $.FileNotFoundError?e=i.get("TS:GUIInitFSError"):(e=i.get("TS:GUIInitUnknownError"),this.sentry?.captureException(new Error(`Failed to initialize GUI (${t.name})`,{cause:t}))),void alert(e)}return a}setPreferredViewportSize(e){this.config.viewport.width=e?.width??Number.POSITIVE_INFINITY,this.config.viewport.height=e?.height??Number.POSITIVE_INFINITY,this.updateViewportSize(this.fullScreen.isFullScreen())}onFullScreenChange(e){navigator.keyboard&&(e?navigator.keyboard.lock(["Escape",...this.config.devMode?[]:["F5","F12"],"F11"])?.catch?.((e=>console.warn("Keyboard lock failed",e))):navigator.keyboard.unlock())}updateViewportSize(e){let t,i;i=e?(t=window.innerWidth,window.innerHeight):(t=Math.min(window.innerWidth,this.config.viewport.width),Math.min(window.innerHeight,this.config.viewport.height)),t=Math.max(800,t-t%2),i=Math.max(600,i-i%2),this.setViewportSize(t,i),this.splashScreen?.setSize(t,i)}setViewportSize(e,t){this.viewport.value={x:this.viewport.value.x,y:this.viewport.value.y,width:e,height:t}}async destroy(){await(this.gui?.destroy()),this.gui=void 0,this.splashScreen&&(this.splashScreen.destroy(),this.splashScreen=void 0)}}),ee.resPath="res/"}}})),System.register("main",["Application"],(function(e,t){"use strict";var i,r;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r=new i.Application,document.body?r.main():document.addEventListener("DOMContentLoaded",(()=>{r.main()}))}}})),System.register("engine/gfx/material/PaletteLambertMaterial",["engine/gfx/material/paletteShaderLib"],(function(e,t){"use strict";var i,r,s;return t&&t.id,{setters:[function(e){i=e}],execute:function(){r={uniforms:THREE.UniformsUtils.merge([THREE.ShaderLib.lambert.uniforms,i.paletteShaderLib.uniforms]),vertexShader:THREE.ShaderChunk.meshlambert_vert.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.instanceParsVertex).replace("void main() {","void main() {\n"+i.paletteShaderLib.instanceVertex),fragmentShader:THREE.ShaderChunk.meshlambert_frag.replace("#include <common>","#include <common>\n"+i.paletteShaderLib.paletteColorParsFrag).replace("#include <color_fragment>","#include <color_fragment>\n"+i.paletteShaderLib.paletteColorFrag).replace("#include <lights_fragment_end>","#include <lights_fragment_end>\n"+i.paletteShaderLib.paletteFullLightFragment)},s=class extends THREE.MeshLambertMaterial{constructor({palette:e,paletteCount:t,paletteOffset:i,extraLight:s,...n}={}){super(n),this.uniforms=THREE.UniformsUtils.clone(r.uniforms),e&&(this.palette=e),t&&(this.paletteCount=t),i&&(this.paletteOffset=i),s&&this.extraLight.copy(s),this.vertexShader=r.vertexShader,this.fragmentShader=r.fragmentShader,this.type="PaletteLambertMaterial"}get palette(){return this.uniforms.palette.value}set palette(e){this.uniforms.palette.value=e}get paletteOffset(){return this.uniforms.paletteOffsetCount.value[0]}set paletteOffset(e){this.uniforms.paletteOffsetCount.value[0]=e}get paletteCount(){return this.uniforms.paletteOffsetCount.value[1]}set paletteCount(e){this.uniforms.paletteOffsetCount.value[1]=e}get extraLight(){return this.uniforms?.extraLight.value}set extraLight(e){this.uniforms.extraLight.value=e}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.palette=e.palette,this}},e("PaletteLambertMaterial",s)}}})),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryCulledBuilder",["engine/gfx/BufferGeometryUtils"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("VxlGeometryCulledBuilder",class{build(e){let{voxels:t,voxelField:r}=e.getAllVoxels(),s=new THREE.BoxBufferGeometry(1,1,1);var n=s.getAttribute("position").array,a=n.length/3,o=s.getAttribute("normal").array,l=s.getIndex().array;let c=[],h=[],u=[],d=[];var g=e.minBounds,p=e.scale,m=e.getNormals();let f=0;for(let e=0,i=t.length;e<i;e++){var y=t[e],T=m[Math.min(t[e].normalIndex,m.length-1)];let i=new Array(a);for(let e=0,t=3*a;e<t;e+=3)r.get(y.x+o[e],y.y+o[e+1],y.z+o[e+2])||(i[e/3]=f,c.push(g.x+y.x*p.x+n[e],g.y+y.y*p.y+n[e+1],g.z+y.z*p.z+n[e+2]),h.push(T.x,T.y,T.z),u.push(y.colorIndex/255,0,0),f++);for(let e=0,t=l.length;e<t;e+=3){var v=i[l[e]],b=i[l[e+1]],S=i[l[e+2]];void 0!==v&&void 0!==b&&void 0!==S&&d.push(v,b,S)}}let w=new THREE.BufferGeometry;return w.setIndex(new THREE.BufferAttribute(new Uint32Array(d),1)),w.addAttribute("position",new THREE.BufferAttribute(new Float32Array(c),3)),w.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(h),3)),w.addAttribute("color",new THREE.BufferAttribute(new Float32Array(u),3)),w=i.BufferGeometryUtils.mergeVertices(w),w.computeBoundingBox(),w}})}}})),System.register("engine/renderable/builder/vxlGeometry/VxlGeometryNaiveBuilder",["engine/gfx/BufferGeometryUtils"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("VxlGeometryNaiveBuilder",class{build(e){var{voxels:t,voxelField:r}=e.getAllVoxels();let s=new THREE.BoxBufferGeometry(1,1,1);var n=s.getAttribute("position").array.length/3,a=s.getAttribute("normal").array;let o=new THREE.BufferGeometry;return o.setIndex(this.createIndexAttr(t,s,n)),o.addAttribute("position",this.createPositionAttr(e,t,s)),o.addAttribute("normal",this.createNormalAttr(e,t,n)),o.addAttribute("color",this.createColorAttr(t,n,a,r)),o=i.BufferGeometryUtils.mergeVertices(o),o.computeBoundingBox(),o}createPositionAttr(e,t,i){var r=i.getAttribute("position").array,s=r.length;let n=new Float32Array(r.length*t.length);var a=e.minBounds,o=e.scale;for(let e=0,i=t.length;e<i;e++){var l=e*s,c=t[e];for(let e=0,t=r.length;e<t;e+=3)n[l+e]=a.x+c.x*o.x+r[e],n[l+e+1]=a.y+c.y*o.y+r[e+1],n[l+e+2]=a.z+c.z*o.z+r[e+2]}return new THREE.BufferAttribute(n,3)}createNormalAttr(e,t,i){let r=new Float32Array(i*t.length*3);var s=e.getNormals();for(let e=0,o=t.length;e<o;e++){var n=e*i*3,a=s[Math.min(t[e].normalIndex,s.length-1)];for(let e=0,t=3*i;e<t;e+=3)r[n+e]=a.x,r[n+e+1]=a.y,r[n+e+2]=a.z}return new THREE.BufferAttribute(r,3)}createColorAttr(e,t,i,r){let s=new Float32Array(t*e.length*3);for(let l=0,c=e.length;l<c;l++){var n=l*t*3,a=e[l];for(let e=0,l=3*t;e<l;e+=3){var o=r.get(a.x+i[e],a.y+i[e+1],a.z+i[e+2]);s[n+e]=o?0:a.colorIndex/255,s[n+e+1]=0,s[n+e+2]=0}}return new THREE.BufferAttribute(s,3)}createIndexAttr(e,t,i){var r=t.getIndex().array;let s=new Uint32Array(e.length*r.length);for(let t=0,n=e.length;t<n;t++)for(let e=0,n=r.length;e<n;e++)s[t*n+e]=t*i+r[e];return new THREE.BufferAttribute(s,1)}})}}})),System.register("network/Logger",[],(function(e,t){"use strict";return t&&t.id,{setters:[],execute:function(){}}})),System.register("network/WLadderTransportTcpSocket",["net"],(function(e,t){"use strict";var i;return t&&t.id,{setters:[function(e){i=e}],execute:function(){e("WLadderTransportTcpSocket",class{constructor(e,t,i){this.host=e,this.port=t,this.logger=i}async sendCommand(e){return new Promise(((t,r)=>{this.logger.debug("Connecting to WLadder server...");let s=i.connect({host:this.host,port:this.port,timeout:5e3},(()=>{s.write(e+"\r\n"),this.logger.debug("Sent request: "+e)}));s.on("data",(e=>{this.logger.debug("Got response: "+e.toString());var i=e.toString().split(/\r?\n/g).map((e=>e.trim())).filter((e=>0<e.length));t(i)})),s.on("error",(e=>r(e))),s.on("timeout",(()=>{s.destroy(),r(new Error("Request timed out"))}))}))}})}}}));